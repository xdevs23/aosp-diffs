```diff
diff --git a/Android.bp b/Android.bp
index 5ca551216..1f81464c9 100644
--- a/Android.bp
+++ b/Android.bp
@@ -57,6 +57,7 @@ java_defaults {
         "androidx.legacy_legacy-support-core-ui",
         "androidx.legacy_legacy-support-v13",
         "androidx.legacy_legacy-support-v4",
+        "androidx.lifecycle_lifecycle-viewmodel-ktx",
         "androidx.recyclerview_recyclerview",
         "androidx.recyclerview_recyclerview-selection",
         "androidx.transition_transition",
@@ -65,6 +66,12 @@ java_defaults {
         "docsui-change-ids",
         "guava",
         "modules-utils-build_system",
+        // Glide and dependencies. Optimized out when use_peek_preview_ro flag enabled.
+        // See b/421076517 for more details.
+        "androidx.exifinterface_exifinterface",
+        "glide-disklrucache-prebuilt",
+        "glide-gifdecoder-prebuilt",
+        "glide-prebuilt",
     ],
 
     privileged: true,
@@ -102,7 +109,7 @@ genrule {
     name: "statslog-docsui-java-gen",
     tools: ["stats-log-api-gen"],
     cmd: "$(location stats-log-api-gen) --java $(out) --module docsui" +
-        " --javaPackage com.android.documentsui --javaClass DocumentsStatsLog --minApiLevel 29",
+        " --javaPackage com.android.documentsui --javaClass DocumentsStatsLog --minApiLevel 30",
     out: ["com/android/documentsui/DocumentsStatsLog.java"],
 }
 
@@ -169,6 +176,7 @@ android_app {
     licenses: [
         "Android-Apache-2.0",
         "packages_apps_DocumentsUI_res_drawable_pd_license",
+        "opensourcerequest",
     ],
 
     required: ["privapp_whitelist_com.android.documentsui"],
diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 944b27471..65340aff5 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -65,28 +65,12 @@
             android:theme="@android:style/Theme.NoDisplay"
             android:featureFlag="com.android.documentsui.flags.redirect_get_content_ro"
             android:visibleToInstantApps="true">
-            <intent-filter android:priority="120">
-                <action android:name="android.intent.action.OPEN_DOCUMENT" />
-                <category android:name="android.intent.category.DEFAULT" />
-                <category android:name="android.intent.category.OPENABLE" />
-                <data android:mimeType="*/*" />
-            </intent-filter>
-            <intent-filter android:priority="120">
-                <action android:name="android.intent.action.CREATE_DOCUMENT" />
-                <category android:name="android.intent.category.DEFAULT" />
-                <category android:name="android.intent.category.OPENABLE" />
-                <data android:mimeType="*/*" />
-            </intent-filter>
             <intent-filter android:priority="120">
                 <action android:name="android.intent.action.GET_CONTENT" />
                 <category android:name="android.intent.category.DEFAULT" />
                 <category android:name="android.intent.category.OPENABLE" />
                 <data android:mimeType="*/*" />
             </intent-filter>
-            <intent-filter android:priority="120">
-                <action android:name="android.intent.action.OPEN_DOCUMENT_TREE" />
-                <category android:name="android.intent.category.DEFAULT" />
-            </intent-filter>
         </activity>
 
         <activity
@@ -94,33 +78,25 @@
             android:exported="true"
             android:theme="@style/LauncherTheme"
             android:visibleToInstantApps="true">
-            <intent-filter
-                android:featureFlag="!com.android.documentsui.flags.redirect_get_content_ro"
-                android:priority="100">
+            <intent-filter android:priority="100">
                 <action android:name="android.intent.action.OPEN_DOCUMENT" />
                 <category android:name="android.intent.category.DEFAULT" />
                 <category android:name="android.intent.category.OPENABLE" />
                 <data android:mimeType="*/*" />
             </intent-filter>
-            <intent-filter
-                android:featureFlag="!com.android.documentsui.flags.redirect_get_content_ro"
-                android:priority="100">
+            <intent-filter android:priority="100">
                 <action android:name="android.intent.action.CREATE_DOCUMENT" />
                 <category android:name="android.intent.category.DEFAULT" />
                 <category android:name="android.intent.category.OPENABLE" />
                 <data android:mimeType="*/*" />
             </intent-filter>
-            <intent-filter
-                android:featureFlag="!com.android.documentsui.flags.redirect_get_content_ro"
-                android:priority="100">
+            <intent-filter android:priority="100">
                 <action android:name="android.intent.action.GET_CONTENT" />
                 <category android:name="android.intent.category.DEFAULT" />
                 <category android:name="android.intent.category.OPENABLE" />
                 <data android:mimeType="*/*" />
             </intent-filter>
-            <intent-filter
-                android:featureFlag="!com.android.documentsui.flags.redirect_get_content_ro"
-                android:priority="100">
+            <intent-filter android:priority="100">
                 <action android:name="android.intent.action.OPEN_DOCUMENT_TREE" />
                 <category android:name="android.intent.category.DEFAULT" />
             </intent-filter>
@@ -152,7 +128,6 @@
                 <category android:name="android.intent.category.LAUNCHER" />
                 <category android:name="android.intent.category.APP_FILES" />
             </intent-filter>
-            <meta-data android:name="android.app.shortcuts" android:resource="@xml/shortcuts" />
         </activity-alias>
 
         <activity
diff --git a/OWNERS b/OWNERS
index 70a483639..e5ce1c621 100644
--- a/OWNERS
+++ b/OWNERS
@@ -2,5 +2,9 @@
 
 include platform/frameworks/base:/core/java/android/os/storage/OWNERS
 
-benreich@google.com
+# For one of the below, please use android-files+reviews@google.com as the
+# reviewer.
 alexbn@google.com
+benreich@google.com
+lucmult@google.com
+wenbojie@google.com
diff --git a/PREUPLOAD.cfg b/PREUPLOAD.cfg
index edf1ee5a3..4b8624297 100644
--- a/PREUPLOAD.cfg
+++ b/PREUPLOAD.cfg
@@ -2,3 +2,6 @@
 checkstyle_hook = ${REPO_ROOT}/prebuilts/checkstyle/checkstyle.py --sha ${PREUPLOAD_COMMIT}
 ktlint_hook = ${REPO_ROOT}/prebuilts/ktlint/ktlint.py -f ${PREUPLOAD_FILES}
 
+# go/alint for details
+alint_hook = ${REPO_ROOT}/vendor/google/tools/alint
+
diff --git a/TEST_MAPPING b/TEST_MAPPING
index 6de67146a..ff188f4d1 100644
--- a/TEST_MAPPING
+++ b/TEST_MAPPING
@@ -9,8 +9,7 @@
     }
   ],
   "desktop-postsubmit": [    {
-      "name": "DocumentsUIGoogleTests",
-      "keywords": ["primary-device"]
+      "name": "DocumentsUIGoogleTests"
     },
     {
       "name": "DocumentsUIUnitTests"
diff --git a/flags.aconfig b/flags.aconfig
index 1e31323a5..dcc7f1749 100644
--- a/flags.aconfig
+++ b/flags.aconfig
@@ -5,7 +5,7 @@ flag {
     name: "use_material3"
     namespace: "documentsui"
     description: "Use Material 3 theme and styles."
-    bug: "373720657"
+    bug: "401974530"
     is_fixed_read_only: true
 }
 
@@ -13,7 +13,7 @@ flag {
     name: "use_search_v2_read_only"
     namespace: "documentsui"
     description: "Enables the next generation search functionality."
-    bug: "383412640"
+    bug: "408892602"
     is_fixed_read_only: true
 }
 
@@ -21,7 +21,7 @@ flag {
     name: "zip_ng_ro"
     namespace: "documentsui"
     description: "Enables the next generation ZIP functionality."
-    bug: "382550591"
+    bug: "411269957"
     is_fixed_read_only: true
 }
 
@@ -29,7 +29,7 @@ flag {
     name: "desktop_file_handling_ro"
     namespace: "documentsui"
     description: "Enables desktop file handling."
-    bug: "381778967"
+    bug: "406599215"
     is_fixed_read_only: true
 }
 
@@ -37,15 +37,7 @@ flag {
     name: "visual_signals_ro"
     namespace: "documentsui"
     description: "Enables in-app progress display of file operations"
-    bug: "378011512"
-    is_fixed_read_only: true
-}
-
-flag {
-    name: "hide_roots_on_desktop_ro"
-    namespace: "documentsui"
-    description: "Enables the hiding of the Images/Videos/Audio/Documents roots on desktop."
-    bug: "381959330"
+    bug: "401974530"
     is_fixed_read_only: true
 }
 
@@ -61,6 +53,14 @@ flag {
     name: "use_peek_preview_ro"
     namespace: "documentsui"
     description: "Enables the Peek previewing capability as a substitute for the Inspector."
-    bug: "373242058"
+    bug: "411269618"
+    is_fixed_read_only: true
+}
+
+flag {
+    name: "enable_trash_flow_ro"
+    namespace: "documentsui"
+    description: "Enables the documents trash flow"
+    bug: "409265240"
     is_fixed_read_only: true
 }
diff --git a/perf-tests/src/com/android/documentsui/FilesJankPerfTest.java b/perf-tests/src/com/android/documentsui/FilesJankPerfTest.java
index 8054c3814..11abe8039 100644
--- a/perf-tests/src/com/android/documentsui/FilesJankPerfTest.java
+++ b/perf-tests/src/com/android/documentsui/FilesJankPerfTest.java
@@ -49,7 +49,7 @@ public class FilesJankPerfTest extends JankTestBase {
         final UiDevice device = UiDevice.getInstance(getInstrumentation());
         final Context context = getInstrumentation().getTargetContext();
         final UiAutomation automation = getInstrumentation().getUiAutomation();
-        mRootsListBot = new SidebarBot(device, context, BOT_TIMEOUT);
+        mRootsListBot = new SidebarBot(device, automation, context, BOT_TIMEOUT);
         mDirListBot = new DirectoryListBot(device, automation, context, BOT_TIMEOUT);
 
         final Intent intent = new Intent(context, FilesActivity.class);
diff --git a/proguard.flags b/proguard.flags
index 34071fa6d..fa346f3a7 100644
--- a/proguard.flags
+++ b/proguard.flags
@@ -46,7 +46,9 @@
   int feature_notification_channel;
   int full_bar_search_view;
   int is_launcher_enabled;
+  int show_media_roots;
   int show_search_bar;
+  int show_apps_row;
 }
 -keep class com.android.documentsui.R$color {
   int app_background_color;
@@ -118,6 +120,8 @@
   int option_menu_settings;
   int option_menu_show_hidden_files;
   int option_menu_sort;
+  int peek_container;
+  int peek_preview_container;
   int root_menu_eject_root;
   int root_menu_open_in_new_window;
   int root_menu_paste_into_folder;
@@ -148,6 +152,7 @@
 -keep class com.android.documentsui.R$string {
   int cant_select_work_files_error_message;
   int cant_select_work_files_error_title;
+  int clear_selection;
   int copy_notification_title;
   int copy_preparing;
   int copy_remaining;
@@ -191,6 +196,8 @@
   int rename_error;
   int search_bar_hint;
   int share_via;
+  int search_last_modified_30_days;
+  int search_location_everywhere;
   int sort_dimension_date;
   int sort_dimension_file_type;
   int sort_dimension_name;
@@ -211,4 +218,15 @@
 # This is used in the unit test
 -keep class com.google.android.material.chip.Chip {
   public android.graphics.drawable.Drawable getChipIcon();
-}
\ No newline at end of file
+}
+
+-keep class com.android.documentsui.util.Material3Config {
+  static int getRes(int);
+  static void overrideMappingForTest(java.util.Map);
+  static void setEnabledForTest(boolean);
+}
+
+# The SideSheetBehavior state is not directly accessed from DocumentsUI, but is used in tests
+-keep class com.google.android.material.sidesheet.SideSheetBehavior {
+  public int getState();
+}
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/doc_list_item_subtitle_color.xml b/res/color/doc_list_item_subtitle_color.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/doc_list_item_subtitle_color.xml
rename to res/color/doc_list_item_subtitle_color.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/fragment_pick_button_background_color.xml b/res/color/fragment_pick_button_background_color.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/fragment_pick_button_background_color.xml
rename to res/color/fragment_pick_button_background_color.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/fragment_pick_button_text_color.xml b/res/color/fragment_pick_button_text_color.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/fragment_pick_button_text_color.xml
rename to res/color/fragment_pick_button_text_color.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/horizontal_breadcrumb_color.xml b/res/color/horizontal_breadcrumb_color.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/horizontal_breadcrumb_color.xml
rename to res/color/horizontal_breadcrumb_color.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/item_action_icon.xml b/res/color/item_action_icon.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/item_action_icon.xml
rename to res/color/item_action_icon.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/item_details.xml b/res/color/item_details.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/item_details.xml
rename to res/color/item_details.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/item_doc_grid_border.xml b/res/color/item_doc_grid_border.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/item_doc_grid_border.xml
rename to res/color/item_doc_grid_border.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/item_doc_grid_tint.xml b/res/color/item_doc_grid_tint.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/item_doc_grid_tint.xml
rename to res/color/item_doc_grid_tint.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/item_root_icon.xml b/res/color/item_root_icon.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/item_root_icon.xml
rename to res/color/item_root_icon.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/item_root_primary_text.xml b/res/color/item_root_primary_text.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/item_root_primary_text.xml
rename to res/color/item_root_primary_text.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/item_root_secondary_text.xml b/res/color/item_root_secondary_text.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/item_root_secondary_text.xml
rename to res/color/item_root_secondary_text.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/profile_tab_selector.xml b/res/color/profile_tab_selector.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/profile_tab_selector.xml
rename to res/color/profile_tab_selector.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/search_chip_background_color.xml b/res/color/search_chip_background_color.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/search_chip_background_color.xml
rename to res/color/search_chip_background_color.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/search_chip_ripple_color.xml b/res/color/search_chip_ripple_color.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/search_chip_ripple_color.xml
rename to res/color/search_chip_ripple_color.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/search_chip_stroke_color.xml b/res/color/search_chip_stroke_color.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/search_chip_stroke_color.xml
rename to res/color/search_chip_stroke_color.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/search_chip_text_color.xml b/res/color/search_chip_text_color.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/search_chip_text_color.xml
rename to res/color/search_chip_text_color.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/color/sort_list_text.xml b/res/color/sort_list_text.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/color/sort_list_text.xml
rename to res/color/sort_list_text.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable-ldrtl/roots_list_border.xml b/res/drawable-ldrtl/roots_list_border.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable-ldrtl/roots_list_border.xml
rename to res/drawable-ldrtl/roots_list_border.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/band_select_overlay.xml b/res/drawable/band_select_overlay.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/band_select_overlay.xml
rename to res/drawable/band_select_overlay.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background.xml b/res/drawable/bottom_sheet_dialog_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background.xml
rename to res/drawable/bottom_sheet_dialog_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background.xml b/res/drawable/breadcrumb_item_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background.xml
rename to res/drawable/breadcrumb_item_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/circle_button_background.xml b/res/drawable/circle_button_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/circle_button_background.xml
rename to res/drawable/circle_button_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/debug_msg_1.png b/res/drawable/debug_msg_1.png
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/debug_msg_1.png
rename to res/drawable/debug_msg_1.png
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/debug_msg_2.png b/res/drawable/debug_msg_2.png
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/debug_msg_2.png
rename to res/drawable/debug_msg_2.png
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background.xml b/res/drawable/drag_shadow_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background.xml
rename to res/drawable/drag_shadow_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/drop_badge_states.xml b/res/drawable/drop_badge_states.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/drop_badge_states.xml
rename to res/drawable/drop_badge_states.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/dropdown_sort_widget_background.xml b/res/drawable/dropdown_sort_widget_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/dropdown_sort_widget_background.xml
rename to res/drawable/dropdown_sort_widget_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/empty.xml b/res/drawable/empty.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/empty.xml
rename to res/drawable/empty.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/fast_scroll_thumb_drawable.xml b/res/drawable/fast_scroll_thumb_drawable.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/fast_scroll_thumb_drawable.xml
rename to res/drawable/fast_scroll_thumb_drawable.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/fast_scroll_track_drawable.xml b/res/drawable/fast_scroll_track_drawable.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/fast_scroll_track_drawable.xml
rename to res/drawable/fast_scroll_track_drawable.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/generic_ripple_background.xml b/res/drawable/generic_ripple_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/generic_ripple_background.xml
rename to res/drawable/generic_ripple_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/gradient_actionbar_background.xml b/res/drawable/gradient_actionbar_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/gradient_actionbar_background.xml
rename to res/drawable/gradient_actionbar_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/grid_item_background.xml b/res/drawable/grid_item_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/grid_item_background.xml
rename to res/drawable/grid_item_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/hourglass.xml b/res/drawable/hourglass.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/hourglass.xml
rename to res/drawable/hourglass.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_action_clear.xml b/res/drawable/ic_action_clear.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_action_clear.xml
rename to res/drawable/ic_action_clear.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_action_open.xml b/res/drawable/ic_action_open.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_action_open.xml
rename to res/drawable/ic_action_open.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_advanced_shortcut.xml b/res/drawable/ic_advanced_shortcut.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_advanced_shortcut.xml
rename to res/drawable/ic_advanced_shortcut.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_arrow_back.xml b/res/drawable/ic_arrow_back.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_arrow_back.xml
rename to res/drawable/ic_arrow_back.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward.xml b/res/drawable/ic_arrow_upward.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward.xml
rename to res/drawable/ic_arrow_upward.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_breadcrumb_arrow.xml b/res/drawable/ic_breadcrumb_arrow.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_breadcrumb_arrow.xml
rename to res/drawable/ic_breadcrumb_arrow.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_briefcase.xml b/res/drawable/ic_briefcase.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_briefcase.xml
rename to res/drawable/ic_briefcase.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_briefcase_white.xml b/res/drawable/ic_briefcase_white.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_briefcase_white.xml
rename to res/drawable/ic_briefcase_white.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_cab_cancel.xml b/res/drawable/ic_cab_cancel.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_cab_cancel.xml
rename to res/drawable/ic_cab_cancel.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_check.xml b/res/drawable/ic_check.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_check.xml
rename to res/drawable/ic_check.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_check_circle.xml b/res/drawable/ic_check_circle.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_check_circle.xml
rename to res/drawable/ic_check_circle.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_chip_from_this_week.xml b/res/drawable/ic_chip_from_this_week.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_chip_from_this_week.xml
rename to res/drawable/ic_chip_from_this_week.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_chip_large_files.xml b/res/drawable/ic_chip_large_files.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_chip_large_files.xml
rename to res/drawable/ic_chip_large_files.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_create_new_folder.xml b/res/drawable/ic_create_new_folder.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_create_new_folder.xml
rename to res/drawable/ic_create_new_folder.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_debug_menu.xml b/res/drawable/ic_debug_menu.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_debug_menu.xml
rename to res/drawable/ic_debug_menu.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_dialog_alert.xml b/res/drawable/ic_dialog_alert.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_dialog_alert.xml
rename to res/drawable/ic_dialog_alert.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_dialog_info.xml b/res/drawable/ic_dialog_info.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_dialog_info.xml
rename to res/drawable/ic_dialog_info.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_done.xml b/res/drawable/ic_done.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_done.xml
rename to res/drawable/ic_done.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge.xml b/res/drawable/ic_drop_copy_badge.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge.xml
rename to res/drawable/ic_drop_copy_badge.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_eject.xml b/res/drawable/ic_eject.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_eject.xml
rename to res/drawable/ic_eject.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_exit_to_app.xml b/res/drawable/ic_exit_to_app.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_exit_to_app.xml
rename to res/drawable/ic_exit_to_app.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_folder_shortcut.xml b/res/drawable/ic_folder_shortcut.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_folder_shortcut.xml
rename to res/drawable/ic_folder_shortcut.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_hamburger.xml b/res/drawable/ic_hamburger.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_hamburger.xml
rename to res/drawable/ic_hamburger.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_history.xml b/res/drawable/ic_history.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_history.xml
rename to res/drawable/ic_history.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_compress.xml b/res/drawable/ic_menu_compress.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_compress.xml
rename to res/drawable/ic_menu_compress.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_copy.xml b/res/drawable/ic_menu_copy.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_copy.xml
rename to res/drawable/ic_menu_copy.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_delete.xml b/res/drawable/ic_menu_delete.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_delete.xml
rename to res/drawable/ic_menu_delete.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_extract.xml b/res/drawable/ic_menu_extract.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_extract.xml
rename to res/drawable/ic_menu_extract.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_search.xml b/res/drawable/ic_menu_search.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_search.xml
rename to res/drawable/ic_menu_search.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_share.xml b/res/drawable/ic_menu_share.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_share.xml
rename to res/drawable/ic_menu_share.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_grid.xml b/res/drawable/ic_menu_view_grid.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_grid.xml
rename to res/drawable/ic_menu_view_grid.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_list.xml b/res/drawable/ic_menu_view_list.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_list.xml
rename to res/drawable/ic_menu_view_list.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge.xml b/res/drawable/ic_reject_drop_badge.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge.xml
rename to res/drawable/ic_reject_drop_badge.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_root_bugreport.xml b/res/drawable/ic_root_bugreport.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_root_bugreport.xml
rename to res/drawable/ic_root_bugreport.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_root_download.xml b/res/drawable/ic_root_download.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_root_download.xml
rename to res/drawable/ic_root_download.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_root_recent.xml b/res/drawable/ic_root_recent.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_root_recent.xml
rename to res/drawable/ic_root_recent.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_root_smartphone.xml b/res/drawable/ic_root_smartphone.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_root_smartphone.xml
rename to res/drawable/ic_root_smartphone.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_sd_storage.xml b/res/drawable/ic_sd_storage.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_sd_storage.xml
rename to res/drawable/ic_sd_storage.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_sort.xml b/res/drawable/ic_sort.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_sort.xml
rename to res/drawable/ic_sort.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow.xml b/res/drawable/ic_sort_arrow.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow.xml
rename to res/drawable/ic_sort_arrow.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_subdirectory_arrow.xml b/res/drawable/ic_subdirectory_arrow.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_subdirectory_arrow.xml
rename to res/drawable/ic_subdirectory_arrow.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_usb_shortcut.xml b/res/drawable/ic_usb_shortcut.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_usb_shortcut.xml
rename to res/drawable/ic_usb_shortcut.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_usb_storage.xml b/res/drawable/ic_usb_storage.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_usb_storage.xml
rename to res/drawable/ic_usb_storage.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_user_profile.xml b/res/drawable/ic_user_profile.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_user_profile.xml
rename to res/drawable/ic_user_profile.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out.xml b/res/drawable/ic_zoom_out.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out.xml
rename to res/drawable/ic_zoom_out.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/inspector_separator.xml b/res/drawable/inspector_separator.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/inspector_separator.xml
rename to res/drawable/inspector_separator.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border.xml b/res/drawable/item_doc_grid_border.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border.xml
rename to res/drawable/item_doc_grid_border.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border_rounded.xml b/res/drawable/item_doc_grid_border_rounded.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border_rounded.xml
rename to res/drawable/item_doc_grid_border_rounded.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/launcher_screen.xml b/res/drawable/launcher_screen.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/launcher_screen.xml
rename to res/drawable/launcher_screen.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/launcher_screen_night.xml b/res/drawable/launcher_screen_night.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/launcher_screen_night.xml
rename to res/drawable/launcher_screen_night.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/list_checker.xml b/res/drawable/list_checker.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/list_checker.xml
rename to res/drawable/list_checker.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/list_divider.xml b/res/drawable/list_divider.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/list_divider.xml
rename to res/drawable/list_divider.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/list_item_background.xml b/res/drawable/list_item_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/list_item_background.xml
rename to res/drawable/list_item_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel.xml b/res/drawable/menu_dropdown_panel.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel.xml
rename to res/drawable/menu_dropdown_panel.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed.xml b/res/drawable/progress_indeterminate_horizontal_material_trimmed.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed.xml
rename to res/drawable/progress_indeterminate_horizontal_material_trimmed.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/root_item_background.xml b/res/drawable/root_item_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/root_item_background.xml
rename to res/drawable/root_item_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/root_list_selector.xml b/res/drawable/root_list_selector.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/root_list_selector.xml
rename to res/drawable/root_list_selector.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/search_bar_background.xml b/res/drawable/search_bar_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/search_bar_background.xml
rename to res/drawable/search_bar_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/share_off.xml b/res/drawable/share_off.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/share_off.xml
rename to res/drawable/share_off.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/sort_widget_background.xml b/res/drawable/sort_widget_background.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/sort_widget_background.xml
rename to res/drawable/sort_widget_background.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/splash_screen.xml b/res/drawable/splash_screen.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/splash_screen.xml
rename to res/drawable/splash_screen.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/tab_border_rounded.xml b/res/drawable/tab_border_rounded.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/tab_border_rounded.xml
rename to res/drawable/tab_border_rounded.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/vector_drawable_progress_indeterminate_horizontal_trimmed.xml b/res/drawable/vector_drawable_progress_indeterminate_horizontal_trimmed.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/vector_drawable_progress_indeterminate_horizontal_trimmed.xml
rename to res/drawable/vector_drawable_progress_indeterminate_horizontal_trimmed.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/work_off.xml b/res/drawable/work_off.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/drawable/work_off.xml
rename to res/drawable/work_off.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_images_shortcut.xml b/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_images_shortcut.xml
deleted file mode 100644
index 5e84369ea..000000000
--- a/res/flag(!com.android.documentsui.flags.use_material3)/drawable/ic_images_shortcut.xml
+++ /dev/null
@@ -1,33 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!--
-  ~ Copyright (C) 2017 The Android Open Source Project
-  ~
-  ~ Licensed under the Apache License, Version 2.0 (the "License");
-  ~ you may not use this file except in compliance with the License.
-  ~ You may obtain a copy of the License at
-  ~
-  ~      http://www.apache.org/licenses/LICENSE-2.0
-  ~
-  ~ Unless required by applicable law or agreed to in writing, software
-  ~ distributed under the License is distributed on an "AS IS" BASIS,
-  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-  ~ See the License for the specific language governing permissions and
-  ~ limitations under the License.
-  -->
-
-<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
-    <background android:drawable="@color/shortcut_background" />
-    <foreground>
-      <inset android:inset="33%">
-        <vector xmlns:android="http://schemas.android.com/apk/res/android"
-          android:width="24dp"
-          android:height="24dp"
-          android:viewportHeight="24"
-          android:viewportWidth="24">
-        <path
-          android:fillColor="@color/shortcut_foreground"
-          android:pathData="M21 19V5c0,-1.1,-.9,-2,-2,-2H5c-1.1 0,-2 .9,-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2,-.9 2,-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5,-4.5z" />
-        </vector>
-      </inset>
-    </foreground>
-</adaptive-icon>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/briefcase_icon_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/briefcase_icon_color.xml
new file mode 100644
index 000000000..66bb23b66
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/briefcase_icon_color.xml
@@ -0,0 +1,23 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  ~ Copyright (C) 2025 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License.
+  -->
+
+<!-- Though there's only one state here but we can't declare this as a normal color variable in
+     colors.xml, it will trigger an attribute resolve error.
+-->
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:color="?attr/colorSecondary" />
+</selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_badge_icon_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_badge_icon_color.xml
index de2849840..e82c6dcca 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_badge_icon_color.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_badge_icon_color.xml
@@ -16,6 +16,6 @@
   -->
 
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
-    <item android:state_selected="true" android:color="?attr/colorOnPrimary" />
-    <item android:color="?attr/colorSecondary" />
+    <item android:state_selected="true" android:color="?attr/colorOnPrimaryContainer" />
+    <item android:color="?attr/colorOnSurface" />
 </selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_subtitle_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_subtitle_color_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_subtitle_color.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_subtitle_color_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/horizontal_breadcrumb_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/horizontal_breadcrumb_color_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/horizontal_breadcrumb_color.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/horizontal_breadcrumb_color_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_action_icon.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_action_icon_m3.xml
similarity index 94%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/item_action_icon.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/item_action_icon_m3.xml
index 0ef672d95..b1109a634 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/item_action_icon.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/item_action_icon_m3.xml
@@ -17,7 +17,7 @@
 <!-- TODO(b/379776735): remove this file after use_material3 flag is launched. -->
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
     <item android:state_enabled="false"
-        android:alpha="@dimen/root_icon_disabled_alpha"
+        android:alpha="@dimen/root_icon_disabled_alpha_m3"
         android:color="?android:colorControlNormal" />
     <item android:color="?android:colorControlNormal" />
 </selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_details.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_details_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/item_details.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/item_details_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_doc_grid_border.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_doc_grid_border_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/item_doc_grid_border.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/item_doc_grid_border_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_doc_grid_tint.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_doc_grid_tint_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/item_doc_grid_tint.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/item_doc_grid_tint_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_icon.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_icon_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/item_root_icon.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/item_root_icon_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_primary_text.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_primary_text_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/item_root_primary_text.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/item_root_primary_text_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_secondary_text.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_secondary_text_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/item_root_secondary_text.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/item_root_secondary_text_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_background_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_background_color_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_background_color.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_background_color_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_ripple_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_ripple_color_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_ripple_color.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_ripple_color_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_stroke_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_stroke_color_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_stroke_color.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_stroke_color_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_text_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_text_color_m3.xml
similarity index 96%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_text_color.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_text_color_m3.xml
index 6935cef57..6e5382710 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_text_color.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_text_color_m3.xml
@@ -17,7 +17,7 @@
 
 <!-- TODO(b/379776735): remove this file after use_material3 flag is launched. -->
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
-    <item android:state_selected="true" android:color="@color/search_chip_text_selected_color"/>
+    <item android:state_selected="true" android:color="@color/search_chip_text_selected_color_m3"/>
     <item android:state_enabled="true" android:color="?android:textColorSecondary"/>
     <item android:state_enabled="false" android:color="?android:textColorSecondary" android:alpha="0.3"/>
 </selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_eject.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/sort_icon_ripple_color.xml
similarity index 53%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_eject.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/sort_icon_ripple_color.xml
index 11c8af06f..30d7ef146 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_eject.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/sort_icon_ripple_color.xml
@@ -1,7 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
 <!--
-Copyright (C) 2024 The Android Open Source Project
+    Copyright (C) 2025 The Android Open Source Project
 
-   Licensed under the Apache License, Version 2.0 (the "License");
+    Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at
 
@@ -12,13 +13,8 @@ Copyright (C) 2024 The Android Open Source Project
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
--->
-<vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="24dp"
-        android:height="24dp"
-        android:viewportWidth="24.0"
-        android:viewportHeight="24.0">
-    <path
-        android:fillColor="#5F6368"
-        android:pathData="M5 17h14v2H5zm7-12L5.33 15h13.34z"/>
-</vector>
\ No newline at end of file
+  -->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:alpha="@dimen/ripple_overlay_alpha" android:color="?attr/colorOnSurface"/>
+</selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/sort_list_text.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/sort_list_text_m3.xml
similarity index 91%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/sort_list_text.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/sort_list_text_m3.xml
index a1e93630b..cd5b899a2 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/sort_list_text.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/sort_list_text_m3.xml
@@ -13,6 +13,7 @@
      See the License for the specific language governing permissions and
      limitations under the License.
 -->
+<!-- TODO(b/379776735): remove this file after use_material3 flag is launched. -->
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
     <item
         android:state_checked="true"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable-ldrtl/roots_list_border.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable-ldrtl/roots_list_border_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable-ldrtl/roots_list_border.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable-ldrtl/roots_list_border_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/apps_row_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/apps_row_background.xml
new file mode 100644
index 000000000..ec35bebbf
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/apps_row_background.xml
@@ -0,0 +1,20 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<shape xmlns:android="http://schemas.android.com/apk/res/android"
+    android:shape="rectangle">
+    <solid android:color="?attr/colorSurfaceContainerLow" />
+    <corners android:radius="16dp" />
+</shape>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/band_select_overlay.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/band_select_overlay_m3.xml
similarity index 96%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/band_select_overlay.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/band_select_overlay_m3.xml
index c75b36f21..522aebce9 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/band_select_overlay.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/band_select_overlay_m3.xml
@@ -16,7 +16,7 @@
   -->
 
 <shape xmlns:android="http://schemas.android.com/apk/res/android"
-        android:shape="rectangle" android:tint="@color/band_select_background">
+        android:shape="rectangle" android:tint="@color/band_select_background_m3">
     <solid android:color="#52000000" /> <!-- 32% alpha -->
-    <stroke android:width="1dp" android:color="@color/band_select_border" />
+    <stroke android:width="1dp" android:color="@color/band_select_border_m3" />
 </shape>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background_m3.xml
similarity index 94%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background_m3.xml
index 4574b96f4..bc15ede73 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background_m3.xml
@@ -15,7 +15,7 @@
 -->
 <shape xmlns:android="http://schemas.android.com/apk/res/android">
 
-    <solid android:color="?android:attr/colorBackground" />
+    <solid android:color="?attr/colorSurfaceContainerLow" />
 
     <corners
         android:topLeftRadius="@dimen/bottom_sheet_dialog_radius"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background_m3.xml
similarity index 91%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background_m3.xml
index 3ca0191cd..074e752f5 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background_m3.xml
@@ -16,7 +16,6 @@
 
 <ripple
     xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:app="http://schemas.android.com/apk/res-auto"
     android:color="@color/breadcrumb_item_ripple_color">
     <item
         android:id="@android:id/mask"
@@ -24,15 +23,18 @@
 
     <item>
         <selector>
+            <item android:state_enabled="false">
+                <color android:color="@android:color/transparent"/>
+            </item>
             <item android:state_pressed="true">
                 <shape android:tint="?attr/colorOnSurfaceVariant">
-                    <corners android:radius="@dimen/breadcrumb_item_height" />
+                    <corners android:radius="@dimen/breadcrumb_item_height_m3" />
                     <solid android:color="@color/overlay_hover_color_percentage" />
                 </shape>
             </item>
             <item android:state_focused="true">
                 <shape>
-                    <corners android:radius="@dimen/breadcrumb_item_height" />
+                    <corners android:radius="@dimen/breadcrumb_item_height_m3" />
                     <stroke
                         android:width="@dimen/focus_ring_width"
                         android:color="?attr/colorSecondary" />
@@ -40,7 +42,7 @@
             </item>
             <item android:state_hovered="true">
                 <shape android:tint="?attr/colorOnSurfaceVariant">
-                    <corners android:radius="@dimen/breadcrumb_item_height" />
+                    <corners android:radius="@dimen/breadcrumb_item_height_m3" />
                     <solid android:color="@color/overlay_hover_color_percentage" />
                 </shape>
             </item>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_mask.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_mask.xml
index c64be0765..d3bc3b284 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_mask.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_mask.xml
@@ -15,7 +15,7 @@
 -->
 
 <shape xmlns:android="http://schemas.android.com/apk/res/android">
-    <corners android:radius="@dimen/breadcrumb_item_height" />
+    <corners android:radius="@dimen/breadcrumb_item_height_m3" />
     <!-- The color here doesn't matter, it's just being used as a mask. -->
     <solid android:color="@android:color/white" />
 </shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/circle_button_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/circle_button_background_m3.xml
similarity index 90%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/circle_button_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/circle_button_background_m3.xml
index be2874119..0cc7ceddb 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/circle_button_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/circle_button_background_m3.xml
@@ -15,7 +15,6 @@
 -->
 
 <shape xmlns:android="http://schemas.android.com/apk/res/android"
-       android:shape="oval">
-    <solid
-        android:color="#66000000"/>
+    android:shape="oval">
+    <solid android:color="@color/peek_circle_black" />
 </shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/docked_search_bar_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/docked_search_bar_background.xml
new file mode 100644
index 000000000..2c9386390
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/docked_search_bar_background.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<shape xmlns:android="http://schemas.android.com/apk/res/android" android:shape="rectangle">
+    <solid android:color="?attr/colorSurfaceContainerHigh" />
+    <!-- The docked searchbar is a pill shape so we set the corner radius to a very high number. -->
+    <corners android:radius="999dp" />
+</shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background_m3.xml
similarity index 92%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background_m3.xml
index 0052f4609..d610e8b50 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background_m3.xml
@@ -16,6 +16,6 @@
 
 <shape xmlns:android="http://schemas.android.com/apk/res/android"
        android:shape="rectangle">
-  <solid android:color="@color/item_drag_shadow_background" />
+  <solid android:color="@color/item_drag_shadow_background_m3" />
   <corners android:radius="@dimen/drag_content_radius" />
 </shape>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/drop_badge_states.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/drop_badge_states_m3.xml
similarity index 91%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/drop_badge_states.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/drop_badge_states_m3.xml
index 7b78a7b69..36cf276b5 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/drop_badge_states.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/drop_badge_states_m3.xml
@@ -20,13 +20,13 @@
     <!-- state when we can't drop -->
     <item
         app:state_reject_drop="true"
-        android:drawable="@drawable/ic_reject_drop_badge"/>
+        android:drawable="@drawable/ic_reject_drop_badge_m3"/>
 
     <!-- state when we can drop, and it will be a copy -->
     <item
         app:state_reject_drop="false"
         app:state_copy="true"
-        android:drawable="@drawable/ic_drop_copy_badge"/>
+        android:drawable="@drawable/ic_drop_copy_badge_m3"/>
 
     <!-- default state. Also used to show state when we can drop, and it will be a move -->
     <item
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/dropdown_sort_widget_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/dropdown_sort_widget_background_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/dropdown_sort_widget_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/dropdown_sort_widget_background_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/empty.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/empty.xml
deleted file mode 100644
index cddd96821..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/empty.xml
+++ /dev/null
@@ -1,51 +0,0 @@
-<!--
-Copyright (C) 2024 The Android Open Source Project
-
-   Licensed under the Apache License, Version 2.0 (the "License");
-    you may not use this file except in compliance with the License.
-    You may obtain a copy of the License at
-
-         http://www.apache.org/licenses/LICENSE-2.0
-
-    Unless required by applicable law or agreed to in writing, software
-    distributed under the License is distributed on an "AS IS" BASIS,
-    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-    See the License for the specific language governing permissions and
-    limitations under the License.
--->
-<vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="210dp"
-        android:height="210dp"
-        android:viewportWidth="210"
-        android:viewportHeight="210">
-
-    <path
-        android:fillColor="#DADCE0"
-        android:pathData="M115,109.44H95c-1.1,0-2-0.9-2-2s0.9-2,2-2h20c1.1,0,2,0.9,2,2S116.1,109.44,115,109.44z" />
-    <path
-        android:fillColor="#DADCE0"
-        android:pathData="M62.67,85.14l3-0.11L62.67,85.14c-0.04-0.74-0.06-1.48-0.06-2.22c0-0.69,0.02-1.37,0.05-2.05l5.99,0.29 c-0.03,0.58-0.04,1.17-0.04,1.76c0,0.64,0.02,1.28,0.05,1.92l-2.99,0.2L62.67,85.14z" />
-    <path
-        android:fillColor="#DADCE0"
-        android:pathData="M147.35,84.94l-5.99-0.28c0.03-0.56,0.04-1.12,0.04-1.69c0-0.64-0.02-1.28-0.05-1.92l-0.01-0.13l5.99-0.3 l0,0.08c0.04,0.77,0.06,1.52,0.06,2.26C147.39,83.64,147.38,84.29,147.35,84.94z" />
-    <path
-        android:fillColor="#EA4335"
-        android:pathData="M72.56,66.45l-5.35-2.72c0.65-1.28,1.38-2.54,2.16-3.75l5.04,3.25C73.74,64.27,73.12,65.35,72.56,66.45z" />
-    <path
-        android:fillColor="#EA4335"
-        android:pathData="M137.35,66.27c-0.56-1.09-1.19-2.17-1.87-3.21l5.02-3.28c0.79,1.21,1.52,2.46,2.18,3.74L137.35,66.27z" />
-    <path
-        android:fillColor="#DADCE0"
-        android:pathData="M85.15,52.44l-3.28-5.03c1.2-0.79,2.46-1.52,3.74-2.18l2.75,5.33C87.26,51.14,86.18,51.77,85.15,52.44z" />
-    <path
-        android:fillColor="#DADCE0"
-        android:pathData="M124.69,52.34c-1.04-0.67-2.12-1.29-3.22-1.85l2.72-5.35c1.28,0.65,2.54,1.38,3.75,2.15L124.69,52.34z" />
-    <path
-        android:fillColor="#EA4335"
-        android:pathData="M103.12,46.61l-0.4-5.99l0.08,0c1.45-0.07,2.85-0.08,4.25-0.01l-0.28,5.99 C105.56,46.54,104.34,46.54,103.12,46.61z" />
-    <path
-        android:fillColor="#DADCE0"
-        android:pathData="M154,95.44v70H56v-70H154 M154,91.44H56c-2.21,0-4,1.79-4,4v70c0,2.21,1.79,4,4,4h98c2.21,0,4-1.79,4-4 v-70C158,93.24,156.21,91.44,154,91.44L154,91.44z" />
-    <path
-        android:pathData="M 0 0 H 210 V 210 H 0 V 0 Z" />
-</vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/empty_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/empty_m3.xml
new file mode 100644
index 000000000..49157b387
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/empty_m3.xml
@@ -0,0 +1,45 @@
+<!--
+Copyright (C) 2024 The Android Open Source Project
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="200dp"
+    android:height="200dp"
+    android:viewportWidth="200"
+    android:viewportHeight="200">
+    <path
+        android:pathData="M53.82,139.86C51.9,139.86 50.22,139.14 48.78,137.7C47.34,136.18 46.62,134.5 46.62,132.65V70.21C46.62,68.36 47.34,66.72 48.78,65.28C50.22,63.76 51.9,63 53.82,63H84.57C85.53,63 86.45,63.2 87.33,63.6C88.29,64 89.09,64.52 89.73,65.16L94.78,70.21H135.49C137.33,70.21 138.97,70.97 140.41,72.49C141.93,73.93 142.69,75.57 142.69,77.41V132.65C142.69,134.5 141.93,136.18 140.41,137.7C138.97,139.14 137.33,139.86 135.49,139.86H53.82Z"
+        android:fillColor="?attr/colorPrimaryInverse"/>
+    <path
+        android:pathData="M156.01,85C161.8,85 165.67,90.95 163.33,96.24L146.81,133.56C145.08,137.47 141.2,140 136.92,140H53.01L53.01,139.99C51.42,139.94 49.97,138.97 49,138C50.91,138.48 53.75,138.05 54.87,135.79L74.44,91.45C76.17,87.53 80.05,85 84.33,85H156.01Z"
+        android:fillColor="?attr/colorPrimaryContainer"/>
+    <path
+        android:pathData="M161.61,61.13L154.55,68.24"
+        android:strokeWidth="4"
+        android:fillColor="#00000000"
+        android:strokeColor="?attr/colorPrimary"
+        android:strokeLineCap="round"/>
+    <path
+        android:pathData="M145.96,51.01L145.99,61.03"
+        android:strokeWidth="4"
+        android:fillColor="#00000000"
+        android:strokeColor="?attr/colorPrimary"
+        android:strokeLineCap="round"/>
+    <path
+        android:pathData="M170.04,76.33L160.02,76.36"
+        android:strokeWidth="4"
+        android:fillColor="#00000000"
+        android:strokeColor="?attr/colorPrimary"
+        android:strokeLineCap="round"/>
+</vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/empty_search.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/empty_search.xml
new file mode 100644
index 000000000..063004791
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/empty_search.xml
@@ -0,0 +1,70 @@
+<!--
+Copyright (C) 2025 The Android Open Source Project
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="200dp"
+    android:height="200dp"
+    android:viewportWidth="200"
+    android:viewportHeight="200">
+    <path
+        android:pathData="M92.07,53.07C70.14,55.59 54.4,75.35 56.93,97.21C59.46,119.07 79.29,134.75 101.22,132.23C123.16,129.71 138.89,109.94 136.36,88.08C133.83,66.22 114,50.55 92.07,53.07ZM53.15,97.65C50.38,73.7 67.61,52.05 91.63,49.29C115.66,46.53 137.38,63.7 140.15,87.65C142.92,111.6 125.69,133.24 101.66,136C77.64,138.76 55.92,121.59 53.15,97.65Z"
+        android:strokeWidth="4"
+        android:fillColor="?attr/colorOutline"
+        android:fillType="evenOdd"
+        android:strokeColor="?attr/colorOutline"/>
+    <path
+        android:pathData="M128.57,119.57L165.03,153.91L166.49,155.29L165.11,156.74L162.49,159.51L161.12,160.95L159.67,159.58L123.21,125.25L121.75,123.87L123.13,122.42L125.74,119.65L127.11,118.21L128.57,119.57Z"
+        android:fillColor="?attr/colorOutline"/>
+    <path
+        android:pathData="M91.4,47.31C116.52,44.42 139.24,62.37 142.13,87.42C143.65,100.54 139.43,112.99 131.46,122.29L165.03,153.91L166.49,155.29L165.11,156.74L162.49,159.5L161.12,160.95L159.67,159.58L125.89,127.77C119.28,133.25 111.06,136.94 101.89,137.99C76.77,140.88 54.06,122.92 51.16,97.88C48.26,72.83 66.29,50.19 91.4,47.31ZM134.37,88.31C131.97,67.56 113.14,52.66 92.3,55.05C71.46,57.45 56.52,76.22 58.92,96.98L59.04,97.95C61.91,118.2 80.48,132.6 101,130.24C121.51,127.89 136.31,109.65 134.47,89.29L134.37,88.31Z"
+        android:fillColor="?attr/colorOutline"/>
+    <path
+        android:pathData="M168.48,161.91C164.48,166.21 157.65,166.14 153.74,161.75L132.39,137.76L141.61,127.77L167.21,147.18C171.91,150.74 172.51,157.59 168.48,161.91V161.91Z"
+        android:fillColor="?attr/colorOnSurfaceVariant"
+        android:fillType="evenOdd"/>
+    <path
+        android:pathData="M97.91,101.39C96.7,101.68 95.6,101.56 94.62,101.04C93.64,100.52 93.03,99.81 92.81,98.89L92.72,98.51C92.34,96.92 92.37,95.45 92.82,94.1C93.28,92.73 94.31,91.03 95.9,89.01C97.27,87.2 98.16,85.8 98.56,84.8C98.99,83.79 99.08,82.77 98.83,81.74C98.47,80.25 97.74,79.21 96.63,78.61C95.52,78.02 94.12,77.93 92.41,78.34C91.48,78.56 90.68,78.91 89.99,79.39C89.31,79.87 88.76,80.49 88.33,81.24C87.9,81.98 87.57,82.67 87.32,83.32C87.1,83.94 86.62,84.49 85.9,84.95C85.18,85.4 84.31,85.57 83.28,85.46C82.25,85.35 81.39,84.89 80.71,84.06C80.03,83.24 79.73,82.26 79.81,81.12C79.91,79.97 80.43,78.64 81.37,77.15C82.33,75.66 83.62,74.36 85.24,73.26C86.88,72.15 88.84,71.32 91.12,70.77C95.2,69.78 98.75,70.03 101.77,71.51C104.81,72.96 106.74,75.4 107.56,78.81C108.02,80.72 107.95,82.65 107.35,84.6C106.75,86.53 105.56,88.61 103.79,90.82C102.74,92.13 102.03,93.23 101.67,94.14C101.29,95.03 101.2,96.04 101.39,97.17L101.43,97.32C101.5,98.12 101.23,98.93 100.63,99.75C100.04,100.54 99.14,101.09 97.91,101.39ZM101.34,115.09C99.74,115.48 98.25,115.28 96.89,114.5C95.55,113.71 94.69,112.55 94.32,111.02C93.96,109.51 94.2,108.1 95.04,106.81C95.89,105.49 97.12,104.63 98.73,104.25C100.33,103.86 101.82,104.06 103.18,104.84C104.54,105.61 105.4,106.75 105.76,108.26C106.13,109.79 105.89,111.21 105.03,112.53C104.18,113.85 102.95,114.71 101.34,115.09Z"
+        android:fillColor="?attr/colorPrimary"/>
+    <path
+        android:pathData="M34.2,20.71C35.18,20.08 36.36,19.85 37.5,20.07C38.64,20.3 39.65,20.96 40.31,21.92L40.45,22.14L41.28,23.55C41.65,24.2 42.18,24.74 42.82,25.12C43.46,25.5 44.19,25.71 44.94,25.72L46.53,25.77C47.7,25.81 48.8,26.32 49.6,27.17C50.4,28.02 50.83,29.15 50.79,30.32C50.77,30.4 50.77,30.49 50.8,30.57L50.62,32.19C50.54,32.93 50.65,33.67 50.94,34.35C51.23,35.03 51.69,35.62 52.28,36.07L53.52,37.11C54.43,37.83 55.02,38.89 55.16,40.04C55.3,41.19 54.98,42.35 54.27,43.27C54.19,43.32 54.17,43.44 54.09,43.49L53.06,44.66C52.55,45.2 52.2,45.87 52.03,46.59C51.87,47.31 51.89,48.07 52.11,48.78L52.51,50.33C52.82,51.46 52.67,52.66 52.1,53.67C51.52,54.69 50.57,55.44 49.44,55.76C49.37,55.8 49.25,55.77 49.17,55.82L47.61,56.17C46.89,56.32 46.21,56.65 45.66,57.14C45.1,57.63 44.67,58.25 44.42,58.94L43.88,60.48C43.46,61.57 42.64,62.45 41.58,62.93C40.52,63.42 39.31,63.47 38.22,63.08C38.13,63.07 38.05,63.03 37.99,62.96L36.58,62.32C35.9,62.04 35.16,61.92 34.42,61.99C33.68,62.05 32.97,62.29 32.34,62.69L31.01,63.55C30.04,64.18 28.85,64.41 27.71,64.19C26.57,63.96 25.56,63.3 24.91,62.34L24.77,62.12L23.93,60.72C23.56,60.07 23.02,59.53 22.37,59.16C21.72,58.78 20.98,58.58 20.23,58.58L18.64,58.54C17.47,58.49 16.37,57.99 15.57,57.14C14.77,56.28 14.34,55.15 14.37,53.99C14.4,53.9 14.4,53.81 14.37,53.73L14.55,52.11C14.63,51.37 14.52,50.63 14.23,49.95C13.94,49.27 13.48,48.68 12.89,48.22L11.64,47.24C11.18,46.88 10.8,46.43 10.51,45.92C10.22,45.41 10.04,44.85 9.97,44.27C9.91,43.69 9.95,43.1 10.11,42.54C10.27,41.98 10.54,41.45 10.91,41C10.98,40.95 11.01,40.83 11.09,40.78L12.13,39.56C12.64,39.01 12.99,38.35 13.15,37.62C13.32,36.9 13.29,36.15 13.08,35.44L12.68,33.88C12.37,32.75 12.52,31.55 13.1,30.54C13.67,29.53 14.62,28.78 15.75,28.46C15.82,28.41 15.94,28.44 16.02,28.4L17.58,28.04C18.3,27.89 18.98,27.56 19.54,27.07C20.1,26.58 20.52,25.96 20.77,25.26L21.31,23.74C21.73,22.65 22.55,21.77 23.61,21.28C24.67,20.8 25.88,20.75 26.97,21.14C27.06,21.15 27.14,21.19 27.2,21.26L28.65,21.9C29.33,22.19 30.08,22.3 30.81,22.24C31.55,22.17 32.26,21.93 32.89,21.54L34.2,20.71Z"
+        android:fillColor="?attr/colorPrimaryContainer"/>
+    <path
+        android:pathData="M167.88,41.39L171.27,43.3C172.89,44.21 174.75,44.64 176.61,44.54L180.49,44.33C188.2,43.9 193.32,52.14 189.53,58.83L187.61,62.2C186.69,63.82 186.26,65.67 186.36,67.53L186.58,71.4C187,79.07 178.74,84.18 172.03,80.4L168.64,78.49C167.02,77.58 165.16,77.14 163.3,77.25L159.42,77.46C151.71,77.88 146.59,69.65 150.38,62.96L152.3,59.58C153.22,57.97 153.65,56.12 153.55,54.26L153.34,50.39C152.91,42.71 161.17,37.6 167.88,41.39Z"
+        android:fillColor="?attr/colorPrimaryContainer"/>
+    <path
+        android:pathData="M50.37,136.4L37.97,141.2C36.7,141.69 35.59,142.51 34.74,143.57C33.89,144.62 33.33,145.88 33.12,147.22L31.07,160.31C30.86,161.65 31.01,163.02 31.5,164.28C31.99,165.54 32.8,166.65 33.86,167.5L44.22,175.79C45.27,176.64 46.53,177.2 47.87,177.41C49.21,177.61 50.59,177.46 51.85,176.97L64.26,172.16C65.52,171.67 66.64,170.86 67.49,169.8C68.34,168.75 68.9,167.49 69.11,166.15L71.15,153.05C71.36,151.71 71.21,150.35 70.72,149.08C70.23,147.82 69.42,146.71 68.36,145.87L58.01,137.57C56.95,136.72 55.69,136.17 54.35,135.96C53.01,135.76 51.64,135.9 50.37,136.4Z"
+        android:fillColor="?attr/colorPrimaryContainer"/>
+    <group>
+        <clip-path
+            android:pathData="M16.33,33.08l25.37,-6.71l6.71,25.37l-25.37,6.71z"/>
+        <path
+            android:pathData="M27.37,53.66C26.8,53.81 26.27,53.73 25.75,53.43C25.24,53.14 24.91,52.71 24.76,52.14L20.82,37.24C20.67,36.67 20.75,36.14 21.04,35.62C21.34,35.11 21.77,34.78 22.34,34.63L37.24,30.69C37.8,30.54 38.34,30.62 38.85,30.91C39.37,31.21 39.7,31.64 39.85,32.21L43.79,47.11C43.94,47.67 43.86,48.21 43.56,48.72C43.27,49.24 42.83,49.57 42.27,49.72L27.37,53.66ZM28.39,48.86L39.01,46.05C39.22,46 39.36,45.87 39.42,45.66C39.47,45.44 39.41,45.26 39.22,45.12L35.25,41.99C35.11,41.88 34.95,41.84 34.77,41.89C34.61,41.93 34.5,42.04 34.43,42.21L32.64,46.66L29.96,44.55C29.82,44.43 29.66,44.4 29.48,44.45C29.32,44.49 29.21,44.59 29.14,44.76L27.75,48.16C27.66,48.37 27.69,48.56 27.84,48.73C28,48.87 28.18,48.92 28.39,48.86Z"
+            android:fillColor="?attr/colorOnPrimaryContainer"/>
+    </group>
+    <group>
+        <clip-path
+            android:pathData="M34.54,148.28l24.82,-8.51l8.51,24.82l-24.82,8.51z"/>
+        <path
+            android:pathData="M52.25,166.49C51.08,166.89 49.93,166.82 48.8,166.28C47.68,165.72 46.92,164.85 46.52,163.68C46.13,162.53 46.2,161.39 46.74,160.28C47.3,159.15 48.16,158.38 49.34,157.98C49.71,157.85 50.07,157.77 50.41,157.75C50.75,157.73 51.1,157.76 51.45,157.83L48.05,147.9C47.94,147.57 47.95,147.26 48.1,146.96C48.25,146.66 48.49,146.45 48.81,146.34L53.11,144.87C53.43,144.76 53.75,144.77 54.05,144.92C54.35,145.07 54.56,145.31 54.67,145.63L55.37,147.68C55.48,148 55.46,148.32 55.32,148.62C55.17,148.92 54.93,149.13 54.6,149.24L51.45,150.32L55.03,160.77C55.43,161.94 55.36,163.09 54.82,164.22C54.28,165.33 53.42,166.08 52.25,166.49Z"
+            android:fillColor="?attr/colorOnPrimaryContainer"/>
+    </group>
+    <group>
+        <clip-path
+            android:pathData="M160.51,44.97l25.4,6.57l-6.57,25.4l-25.4,-6.57z"/>
+        <path
+            android:pathData="M166.52,60.9L172.93,62.56C173.23,62.64 173.5,62.6 173.74,62.46C173.99,62.32 174.15,62.1 174.23,61.8C174.3,61.5 174.27,61.22 174.13,60.98C173.98,60.74 173.76,60.57 173.46,60.5L167.06,58.84C166.76,58.76 166.49,58.79 166.24,58.94C166,59.08 165.84,59.3 165.76,59.6C165.68,59.9 165.71,60.18 165.86,60.42C166,60.66 166.22,60.83 166.52,60.9ZM165.7,64.08L172.1,65.74C172.4,65.81 172.68,65.78 172.92,65.64C173.16,65.49 173.33,65.27 173.4,64.97C173.48,64.67 173.45,64.4 173.3,64.15C173.16,63.91 172.94,63.75 172.64,63.67L166.24,62.01C165.93,61.94 165.66,61.97 165.42,62.11C165.18,62.26 165.01,62.48 164.94,62.78C164.86,63.08 164.89,63.35 165.04,63.6C165.18,63.84 165.4,64 165.7,64.08ZM164.88,67.25L168.11,68.09C168.41,68.17 168.68,68.13 168.92,67.99C169.17,67.85 169.33,67.62 169.41,67.32C169.48,67.02 169.45,66.75 169.31,66.51C169.16,66.26 168.94,66.1 168.64,66.03L165.41,65.19C165.11,65.11 164.84,65.15 164.6,65.29C164.35,65.43 164.19,65.66 164.12,65.96C164.04,66.25 164.07,66.53 164.21,66.77C164.36,67.02 164.58,67.18 164.88,67.25ZM160.84,69.65C160.28,69.51 159.85,69.18 159.54,68.67C159.24,68.16 159.17,67.62 159.31,67.06L163.72,50.01C163.87,49.45 164.2,49.02 164.71,48.72C165.22,48.42 165.76,48.34 166.32,48.48L174.05,50.48C174.31,50.55 174.55,50.67 174.77,50.84C175.01,51.02 175.19,51.22 175.32,51.46L179.1,57.89C179.25,58.12 179.35,58.38 179.38,58.67C179.43,58.94 179.41,59.21 179.34,59.48L176.25,71.44C176.1,72 175.77,72.44 175.26,72.74C174.75,73.04 174.21,73.11 173.65,72.97L160.84,69.65ZM172.23,56.73C172.16,57.02 172.19,57.29 172.33,57.55C172.48,57.79 172.7,57.96 173,58.03L177.23,59.13L173.33,52.5L172.23,56.73Z"
+            android:fillColor="?attr/colorOnPrimaryContainer"/>
+    </group>
+</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/fast_scroll_thumb_drawable.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/fast_scroll_thumb_drawable_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/fast_scroll_thumb_drawable.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/fast_scroll_thumb_drawable_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/fast_scroll_track_drawable.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/fast_scroll_track_drawable_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/fast_scroll_track_drawable.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/fast_scroll_track_drawable_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/generic_ripple_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/generic_ripple_background_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/generic_ripple_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/generic_ripple_background_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_item_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_item_background_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_item_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_item_background_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_nameplate_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_nameplate_background.xml
index 087fc1c15..2ca2f7b19 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_nameplate_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_nameplate_background.xml
@@ -81,6 +81,24 @@
                     </item>
                 </layer-list>
             </item>
+            <item
+                android:state_drag_hovered="true"
+                android:state_selected="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/grid_item_nameplate_radius" />
+                            <solid android:color="?attr/colorPrimaryContainer" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="?attr/colorOnPrimaryContainer">
+                            <corners android:radius="@dimen/grid_item_nameplate_radius" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
             <item
                 android:state_hovered="true"
                 android:state_selected="true">
@@ -139,6 +157,12 @@
                         android:color="?attr/colorSecondary" />
                 </shape>
             </item>
+            <item android:state_drag_hovered="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/grid_item_nameplate_radius" />
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
             <item android:state_hovered="true">
                 <shape android:tint="?attr/colorOnSurface">
                     <corners android:radius="@dimen/grid_item_nameplate_radius" />
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_thumbnail_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_thumbnail_background.xml
index aad18471b..cbfbbd446 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_thumbnail_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_thumbnail_background.xml
@@ -15,10 +15,39 @@
 
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
     <!-- selected -->
+    <item
+        android:state_focused="true"
+        android:state_hovered="true"
+        android:state_selected="true">
+        <layer-list>
+            <item>
+                <shape>
+                    <corners android:radius="@dimen/grid_item_thumbnail_radius" />
+                    <solid android:color="?attr/colorPrimaryContainer" />
+                </shape>
+            </item>
+            <item>
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/grid_item_thumbnail_radius" />
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+        </layer-list>
+    </item>
     <item android:state_selected="true">
         <shape>
             <corners android:radius="@dimen/grid_item_thumbnail_radius" />
             <solid android:color="?attr/colorPrimaryContainer" />
         </shape>
     </item>
+
+    <!-- unselected -->
+    <item
+        android:state_focused="true"
+        android:state_hovered="true">
+        <shape android:tint="?attr/colorOnSurface">
+            <corners android:radius="@dimen/grid_item_thumbnail_radius" />
+            <solid android:color="@color/overlay_hover_color_percentage" />
+        </shape>
+    </item>
 </selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/hourglass.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/hourglass.xml
deleted file mode 100644
index e4c803da9..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/hourglass.xml
+++ /dev/null
@@ -1,168 +0,0 @@
-<!--
-Copyright (C) 2024 The Android Open Source Project
-
-   Licensed under the Apache License, Version 2.0 (the "License");
-    you may not use this file except in compliance with the License.
-    You may obtain a copy of the License at
-
-         http://www.apache.org/licenses/LICENSE-2.0
-
-    Unless required by applicable law or agreed to in writing, software
-    distributed under the License is distributed on an "AS IS" BASIS,
-    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-    See the License for the specific language governing permissions and
-    limitations under the License.
--->
-<vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="421dp"
-        android:height="909dp"
-        android:viewportWidth="421.0"
-        android:viewportHeight="909.0">
-    <path
-        android:pathData="M36,122.9c-2.8,-2.6,-5.7,-5.1,-8.3,-7.8c-5.6,-6,-9.2,-12.9,-8.8,-21.5c0.3,-7.5,0.6,-15,-0.1,-22.5   c-1.2,-14.1,5.5,-23.9,16,-31.9c16.7,-12.8,36.1,-19.6,56.1,-25.1c23.8,-6.5,48,-10.2,72.5,-12.3C168.6,1.3,174,2.2,179,0   c19.3,0,38.7,0,58,0c6,2.1,12.4,1.3,18.6,1.8c30.2,2.7,59.9,7.6,88.5,17.5c16.5,5.7,32.6,12.6,45.2,25.4c6.5,6.6,10.3,14,9.8,23.6   c-0.4,7.8,-0.5,15.7,0,23.4c0.6,10.3,-3.4,18.4,-10.6,25.2c-2.2,2,-4.4,4,-6.6,6c-3,2,-6.1,4,-9.1,5.9c-9.2,4.5,-18.5,9,-28.2,12.3   c-42.4,14.5,-86.3,18.8,-130.8,19.6c-10.9,0.2,-21.9,-0.4,-32.9,-0.7c-4.6,-0.4,-9.2,-0.8,-13.9,-1.1c-18.9,-1.1,-37.5,-3.9,-56,-7.6   c-15.3,-3.1,-30.2,-7.6,-44.9,-12.6c-7.6,-3.7,-15.3,-7.4,-22.9,-11.1C41.1,125.8,38.6,124.3,36,122.9z M41,72c2.9,6.9,7.1,12.6,13.1,17.2   c13,10,27.9,15.8,43.4,20.6c28.2,8.8,57.2,12.8,86.5,14c31.8,1.2,63.7,0.8,95.3,-4.6c25.3,-4.4,50.1,-10,72.9,-22.2   c10.8,-5.8,20,-13.1,24.7,-24.9c2.3,-11,-2.3,-19.5,-10.2,-26.4c-10.5,-9.2,-23.1,-14.9,-36.2,-19.6C295.2,13.4,258.4,9.7,221.2,8.1   c-11.1,-0.5,-22.2,0,-33.4,0.6c-21.4,1,-42.6,3.1,-63.6,7.3c-22.2,4.5,-44.1,10.3,-63.4,22.6C48.9,46.3,38.4,55.4,41,72z"
-        android:fillColor="#9F9F9F"/>
-    <path
-        android:pathData="M0,829c3.7,-2.8,4.7,-7.6,7.8,-10.9c2.6,-2.8,4.9,-5.7,9.2,-7.6c0,3.4,-0.1,6.5,0,9.5c0,1.5,-0.7,3.5,1.7,4   c0.4,3.3,1.4,6.4,2.9,9.4c3.8,7.7,10,13,16.8,17.9c9.2,6.7,19.7,10.8,29.8,15.5c-0.7,2.4,1.3,0.7,1.8,1.1l0,0c1.5,2.1,3.7,2.2,6,2   l0,0c0.8,0.6,1.5,1.4,2.4,1.7c9.5,2.7,18.9,5.8,28.7,7.4c3.6,0.6,7,3.5,10.9,1.1c2.4,0.4,4.8,0.8,7.1,1.2c0.2,1.5,1.3,1.6,2.5,1.8   c6.6,0.9,13.3,2.4,19.9,2.8c5.1,0.3,10.3,2.9,15.4,0.3c0.4,0,0.8,0.1,1.1,0.1c0.3,2.2,2.1,1.8,3.5,1.8c3.8,0,7.6,0,11.5,0   c1.1,1.4,2.7,1,4.1,1c17.2,0,34.5,0,51.7,0c1.4,0,3,0.4,4.1,-1c3.8,0,7.6,0,11.5,0c1.4,0,3.2,0.4,3.5,-1.8c9.4,-1,18.7,-2.1,28.1,-3.1   c6,1.3,11.6,0.4,16.9,-2.8c21.2,-4.2,42.1,-9.3,61.8,-18.4c15.8,-7.3,30.8,-15.8,38,-33.1c2.4,-2,1.9,-4.8,2.2,-7.4c0.3,-3,0,-6,0.1,-9   c0,-1,-0.3,-2.1,0.7,-2.7c1.1,-0.7,1.7,0.5,2.5,1c7.2,5,12.1,11.7,14.8,20c0.4,1.2,0.6,2.2,2.1,2.3c0,3.3,0,6.7,0,10   c-1.5,0,-1.8,1.1,-2.2,2.2c-3.8,10.2,-11.2,17.5,-20.1,23.3c-20.8,13.6,-44.1,21.2,-68.1,26.7c-29.2,6.7,-58.7,11,-88.7,11.7   c-1.6,0,-3.5,-0.5,-3.9,2c-18.7,0,-37.3,0,-56,0c-0.3,-2.5,-2.3,-1.9,-3.9,-2c-5.6,-0.1,-11.2,-0.5,-16.9,-0.8c-18.5,-1.2,-36.8,-3.8,-55,-7.3   C79.9,893.9,54,887,30.2,874C19,867.9,8.5,860.9,2.5,849C2,848,1.4,847,0,847C0,841,0,835,0,829z"
-        android:fillColor="#E6E4E4"/>
-    <path
-        android:pathData="M372.9,128.9c3,-2,6.1,-4,9.1,-5.9c-0.2,2.7,0.2,5.4,1,8c-1.5,1.6,-0.3,1.8,1,2c0.3,1,0.7,2,1,3   c-1.5,1.6,-0.3,1.8,1,2c0.7,2,1.3,4,2,6c-1.5,1.6,-0.3,1.8,1,2c0.3,1.7,0.7,3.3,1,5c-1,2.3,-0.6,4.1,2,5c4.9,23.8,9,47.6,8,72   c-3.5,1.5,-2.1,3.8,-1,6c-1,6,-2,12,-3,18c-1.3,1,-1.3,2,0,3c0,0.7,0,1.3,0,2c-2.1,0.4,-2.6,1.3,-1,3c0,0.3,0,0.7,0,1   c-1.3,0.2,-2.5,0.4,-1,2c0.4,2.1,-0.7,4,-1,6c-1.3,0.2,-2.5,0.4,-1,2c-3.7,9.3,-7.3,18.7,-11,28c-2.7,1.2,-4.2,2.9,-3,6   c-3.4,6.9,-7.8,13.3,-12.2,19.5c-6.1,8.6,-12.4,17.3,-19.4,25.2c-7.3,8.3,-15.5,15.8,-23.9,23c-11.9,10.3,-24.9,19.3,-38.1,27.7   c-12.2,7.8,-25.4,14.1,-38.4,20.5c-12.1,6,-18.5,15.8,-21,28.6c-1.5,7.8,-0.5,15.4,2,22.8c1.2,3.5,3.7,6.1,5.6,9.2   c5.4,8.6,14.8,10.5,22.6,15c15.3,9,30.8,17.7,45.3,28.1c14.4,10.4,28.2,21.5,40.5,34.1c10.1,10.4,18.5,22.2,26.8,34.3   c6.5,9.5,11.3,19.6,16.1,29.8c-1.5,1.6,-0.3,1.8,1,2c0.7,2,1.3,4,2,6c-1,2.3,-0.6,4.1,2,5c0.7,1.2,1.2,2.5,1,4c-1,2.3,-0.6,4.1,2,5   c1.2,12.3,4.6,24.1,5.7,36.5c0.8,8.4,1.4,16.8,1,25.1c-0.3,5.9,-1.1,12,-1.9,18c-1.2,8.7,-2.3,17.4,-4.2,25.9   c-1.5,6.6,-3.7,13.1,-5.6,19.6c-1.8,3.1,-2.9,6.5,-3.9,9.9c-3.4,6.4,-5.6,13.6,-11.9,18.2c-0.1,-3.8,1.6,-7.1,3,-10.4   c8.7,-20.9,13,-42.8,14.7,-65.1c1,-12.9,0.2,-25.8,-1.7,-38.7c-2.7,-18.5,-7.8,-36.2,-15.8,-53.1c-7.3,-15.4,-16.8,-29.3,-27.7,-42.4   c-2.7,-3.2,-6.3,-5.7,-9.6,-8.6c0.4,0.8,0.7,1.4,1,1.9c0.7,1.1,1.5,2.2,2.3,3.3c16.5,21.5,28.5,45.2,34.2,71.7c0.7,3.3,3.1,6.9,0.3,10.4   c-1,-1.9,-2.1,-3.7,-3.1,-5.6c-3.3,-6.3,-6.1,-12.9,-11.7,-17.6c-0.4,-0.9,-0.8,-1.8,-1.3,-2.6c-4,-6.3,-10.4,-10.4,-14.8,-16.2c0,-5.4,-2.7,-9.9,-4.8,-14.5   c-8.4,-18.6,-20.4,-34.9,-32.9,-50.8c-8.4,-10.8,-15.5,-22.8,-28.7,-28.8c-5.3,-2.4,-10,-6,-15.1,-8.6c-5.1,-2.6,-9.9,-6.4,-16.3,-5.2   c-5.2,1,-10.4,2.1,-15.3,4.1c-29.3,11.9,-48.4,34.1,-61.8,61.9c-0.3,0.3,-0.7,0.6,-1,1c-7.1,0.8,-13.9,2.9,-20.7,5.1   c-32.6,10.6,-61,27.4,-82.3,54.9c-9.2,11.6,-15.4,24.7,-18.9,39c-1.5,-1.1,-1.1,-2.7,-1.1,-4.1c-0.1,-9.6,0.3,-19.2,1.8,-28.7   c3.7,-22.6,11.8,-43.5,24,-62.8c12.6,-20,28.6,-36.9,47,-51.7c21.3,-17.3,44.6,-31.3,69.3,-42.9c14.5,-6.8,20,-18.8,21.8,-33.1   c1.8,-13.3,-4.9,-24.1,-12.2,-34.4c-3.6,-5,-7.4,-9.8,-13.2,-12.5c-5.8,-2.8,-11.6,-5.7,-17.4,-8.7c-22,-11.6,-42.6,-25.1,-61.1,-41.7   c-20.7,-18.6,-37.9,-40,-48.8,-65.9c-6.7,-15.7,-10.9,-32.1,-12,-49c-1.8,-27.1,2.1,-53.6,11.7,-79.1c3.8,-10.1,7.1,-20.4,13.3,-29.4   c14.7,5,29.6,9.5,44.9,12.6c18.5,3.7,37.2,6.5,56,7.6c4.6,0.3,9.3,0.7,13.9,1.1c0.2,3.6,-1.5,6.8,-2.6,10   c-11.9,33.6,-17.8,68.2,-17.2,103.8c0.2,9.7,1.3,19.4,2.7,29.1c3.8,24.6,11.4,47.7,26,68.1c12.2,17.1,28.4,28.6,49,33.4   c4.7,1.1,9.5,2.2,14.5,-0.5c18.7,-10.2,36.8,-21.2,53.7,-34.2c15.4,-11.9,29.4,-25.3,41.5,-40.5c12.9,-16.2,23.4,-33.8,30.4,-53.4   c6.4,-17.6,10.3,-35.6,10.9,-54.3c0.5,-15.9,0.2,-31.9,-3,-47.6C383.8,158.7,380.1,143.3,372.9,128.9z"
-        android:fillColor="#EDECEC"/>
-    <path
-        android:pathData="M383,780c1.1,-3.4,2.1,-6.8,3.9,-9.9c7.8,7.1,12.8,15.2,12.2,26.4c-0.6,10.7,-0.3,21.5,-0.5,32.3   c-7.2,17.3,-22.2,25.8,-38,33.1c-19.7,9.1,-40.6,14.1,-61.8,18.4c-5.6,0.9,-11.3,1.9,-16.9,2.8c-9.4,1,-18.7,2.1,-28.1,3.1   c-5,0.3,-9.9,0.7,-14.9,1c-20,1.2,-40,0.9,-60,0c-5,-0.3,-9.9,-0.7,-14.9,-1c-0.4,0,-0.8,-0.1,-1.1,-0.1c-12.6,-1.6,-25.2,-3.2,-37.9,-4.8   c-2.4,-0.4,-4.8,-0.8,-7.1,-1.2c-2.6,-0.6,-5.1,-1.3,-7.7,-1.8c-11.6,-2,-22.6,-6.3,-34.2,-8.4c0,0,0,0,0,0c-1.7,-1.6,-3.7,-2.2,-6,-2c0,0,0,0,0,0   c-0.2,-1,-1.1,-0.9,-1.8,-1.1c-10.2,-4.7,-20.6,-8.8,-29.8,-15.5c-6.8,-4.9,-13,-10.2,-16.8,-17.9c-1.5,-3,-2.4,-6.1,-2.9,-9.4   c0.1,-10.3,0,-20.6,0.2,-30.9c0.1,-8.3,3.5,-15,10,-20.2c2,3.5,3.4,7.1,4.1,11c-1.1,0.8,-1,2,-1.1,3.1c-0.6,8.2,2.9,14.9,8.3,20.6   c8.9,9.6,20.4,15.4,32.3,20.2c17.9,7.2,36.5,11.9,55.4,15.4c20.1,3.7,40.3,5.7,60.6,6.5c21.4,0.8,42.8,0.4,64.2,-1.6   c19.8,-1.9,39.4,-4.6,58.7,-9.3c19.9,-4.8,39.3,-11.2,56.4,-22.9c7.8,-5.3,15.2,-11.3,17.4,-21C386.4,790.1,388.3,784.3,383,780z"
-        android:fillColor="#9F9F9F"/>
-    <path
-        android:pathData="M378,305c-1.2,-3.1,0.3,-4.8,3,-6C380.6,301.3,379.7,303.3,378,305z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M399,234c-1.1,-2.2,-2.5,-4.5,1,-6C399.7,230,400.8,232.2,399,234z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M392,156c-2.6,-0.9,-3,-2.7,-2,-5C391.4,152.4,391.6,154.2,392,156z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M389,636c-2.6,-0.9,-3,-2.7,-2,-5C388.4,632.4,388.6,634.2,389,636z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M392,645c-2.6,-0.9,-3,-2.7,-2,-5C391.4,641.4,391.6,643.2,392,645z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M396,255c-1.3,-1,-1.3,-2,0,-3C397.3,253,397.3,254,396,255z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M395,260c-1.6,-1.7,-1.1,-2.6,1,-3C395.7,258,395.3,259,395,260z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M384,133c-1.3,-0.2,-2.5,-0.4,-1,-2C383.8,131.4,384,132.2,384,133z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M385,625c-1.3,-0.2,-2.5,-0.4,-1,-2C384.8,623.4,385,624.2,385,625z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M392,271c-1.5,-1.6,-0.3,-1.8,1,-2C393,269.8,392.8,270.6,392,271z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M394,263c-1.5,-1.6,-0.3,-1.8,1,-2C395,261.8,394.8,262.6,394,263z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M386,138c-1.3,-0.2,-2.5,-0.4,-1,-2C385.8,136.4,386,137.2,386,138z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M389,146c-1.3,-0.2,-2.5,-0.4,-1,-2C388.8,144.4,389,145.2,389,146z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M33.1,783.9c-0.8,-3.9,-2.2,-7.6,-4.1,-11c-3.7,-11.7,-7.2,-23.5,-9.2,-35.5c-1.3,-7.6,-1.9,-15.4,-2.7,-23.2   c-0.6,-6.2,-0.9,-12.4,-1,-18.5c-0.2,-7.9,1.9,-15.7,2.3,-23.4c0.5,-10.1,2.9,-19.5,5.5,-29c6.3,-23.1,17.3,-43.9,31.5,-62.8   c23.4,-31.1,53.3,-54.7,86.9,-74.1c10.1,-5.8,20.3,-11.6,30.9,-16.2c11.7,-5.2,16.3,-14.9,18.8,-26.3c3.2,-14.9,-2.8,-26.6,-12.7,-37.1   c-1.8,-1.9,-3.9,-3.1,-6.2,-4.2c-23.7,-11.4,-46.4,-24.4,-67.2,-40.7c-16.2,-12.6,-31.3,-26.5,-44.2,-42.6c-16.2,-20.3,-28.8,-42.5,-36.2,-67.5   c-3.1,-10.6,-5.4,-21.3,-6.2,-32.4c-0.7,-9.6,-3.2,-19.3,-2,-28.8c0.8,-6.6,1.5,-13.4,1.9,-20c1,-15.2,4.9,-29.6,9.2,-44c1.7,-5.7,4,-11.3,6.4,-16.8   c0.9,-2.2,1.3,-4.4,1.3,-6.8c2.6,1.4,5.1,2.9,7.2,4.9c-0.6,0.8,-1.4,1.4,-1.8,2.3c-11.2,26.2,-16.2,53.8,-17.4,82.2   c-0.4,8.8,1,17.5,1.9,26.2c2,19.7,7.4,38.4,15.6,56.3c17.9,39.2,46.6,69.1,81.3,93.6c18.5,13.1,38.1,24.3,58.5,34.1   c3.3,1.6,6,3.7,8.1,6.5c8,10.6,12.6,22.1,9.6,35.7c-2.1,9.4,-6.5,17.9,-14.8,22.7c-8.2,4.7,-16.9,8.5,-25.3,12.9   c-22.5,12,-43.8,25.8,-62.6,43c-21.9,19.9,-40.8,42.1,-53.7,69.2C26.3,646.5,20.6,682,24.1,719c1.8,18.7,7,36.7,12.7,54.6   c5.9,18.7,18.2,30.9,35.3,38.9c15.4,7.2,31.5,12.2,48.1,15.8c1.6,0.4,4.3,-0.3,4.8,2.6c-18,-2.8,-35.4,-7.5,-52.3,-14.5   c-12.2,-5.1,-23.4,-11.4,-32.4,-21.4C37.2,791.7,36.5,787,33.1,783.9z"
-        android:fillColor="#EDECEC"/>
-    <path
-        android:pathData="M372.9,128.9c7.2,14.3,10.9,29.8,14.1,45.4c3.2,15.7,3.5,31.6,3,47.6c-0.6,18.7,-4.6,36.7,-10.9,54.3   c-7.1,19.6,-17.6,37.2,-30.4,53.4c-12.1,15.2,-26.1,28.6,-41.5,40.5c-16.9,13,-35,24,-53.7,34.2c-5,2.7,-9.8,1.6,-14.5,0.5   c-20.6,-4.8,-36.8,-16.3,-49,-33.4c-14.6,-20.4,-22.3,-43.5,-26,-68.1c-1.5,-9.7,-2.6,-19.4,-2.7,-29.1c-0.6,-35.6,5.4,-70.2,17.2,-103.8   c1.2,-3.3,2.8,-6.4,2.6,-10c11,0.2,21.9,0.9,32.9,0.7c44.4,-0.8,88.4,-5.2,130.8,-19.6C354.4,137.9,363.7,133.5,372.9,128.9z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M377,72c-4.6,11.9,-13.9,19.1,-24.7,24.9c-22.9,12.2,-47.6,17.9,-72.9,22.2c-31.6,5.4,-63.5,5.9,-95.3,4.6   c-29.3,-1.1,-58.3,-5.1,-86.5,-14C82.1,105,67.2,99.1,54.2,89.2C48.2,84.6,43.9,78.8,41,72c3.9,-1.8,4.6,-6.2,7.3,-9   c10.3,-10.5,22.9,-16.9,36.5,-21.8c19.7,-7.1,40,-11.5,60.7,-14.5c19.4,-2.8,38.9,-3.9,58.4,-4.5c17.9,-0.6,35.8,0.8,53.6,2.8   c15,1.6,29.9,3.5,44.5,7.1c20,4.9,39.7,10.7,57.2,22.1C366.5,58.8,371.5,65.5,377,72z"
-        android:fillColor="#8D8E8E"/>
-    <path
-        android:pathData="M125,831c-0.4,-2.9,-3.2,-2.3,-4.8,-2.6c-16.6,-3.7,-32.7,-8.7,-48.1,-15.8c-17.1,-8,-29.4,-20.2,-35.3,-38.9   c-5.7,-17.9,-10.9,-35.9,-12.7,-54.6c-3.6,-37.1,2.1,-72.5,18.4,-106.4c13,-27.1,31.9,-49.3,53.7,-69.2c18.8,-17.1,40.2,-30.9,62.6,-43   c8.4,-4.5,17.1,-8.2,25.3,-12.9c8.4,-4.8,12.7,-13.3,14.8,-22.7c3.1,-13.6,-1.6,-25.1,-9.6,-35.7c-2.1,-2.8,-4.8,-4.9,-8.1,-6.5   c-20.4,-9.9,-40,-21.1,-58.5,-34.1c-34.7,-24.6,-63.4,-54.5,-81.3,-93.6c-8.2,-17.9,-13.6,-36.6,-15.6,-56.3c-0.9,-8.7,-2.3,-17.5,-1.9,-26.2   c1.2,-28.3,6.2,-55.9,17.4,-82.2c0.4,-0.9,1.2,-1.5,1.8,-2.3c7.6,3.7,15.3,7.4,22.9,11.1c-6.2,9,-9.5,19.3,-13.3,29.4   c-9.6,25.5,-13.5,52,-11.7,79.1c1.1,16.9,5.4,33.3,12,49c11,25.9,28.1,47.4,48.8,65.9c18.5,16.6,39.1,30.2,61.1,41.7   c5.7,3,11.5,5.9,17.4,8.7c5.8,2.8,9.7,7.6,13.2,12.5c7.3,10.3,14,21.1,12.2,34.4c-1.9,14.3,-7.4,26.3,-21.8,33.1   c-24.7,11.6,-48,25.7,-69.3,42.9c-18.3,14.9,-34.3,31.7,-47,51.7c-12.2,19.3,-20.3,40.2,-24,62.8c-1.6,9.6,-2,19.1,-1.8,28.7   c0,1.4,-0.4,3.1,1.1,4.1c-0.6,14.9,0.1,29.8,3,44.5c4.2,21.4,9.1,42.6,26,58.4c-0.2,2.3,0.9,4.1,2.2,5.9c8.8,12.3,22,18.6,35.3,24.1   c26.4,10.9,54.2,16.1,82.4,19.1c1.7,0.2,3,0.4,3,2.4c-4.5,0.7,-9,0.9,-13.4,0.5c-13.2,-1,-26.5,-1.9,-39.6,-4.1c-0.6,-2.4,-1.7,-2.3,-3.1,-0.6   c-1.3,-0.1,-2.6,-0.3,-3.9,-0.4c-0.6,-2.3,-1.6,-2.4,-3.1,-0.7c-0.6,-0.1,-1.3,-0.2,-1.9,-0.3c-0.6,-2.4,-1.7,-2.4,-3.1,-0.6   C126.2,831.2,125.6,831.1,125,831z"
-        android:fillColor="#E8E8E7"/>
-    <path
-        android:pathData="M377,72c-5.4,-6.4,-10.5,-13.2,-17.7,-17.9C341.7,42.7,322.1,36.9,302,32c-14.6,-3.6,-29.5,-5.5,-44.5,-7.1   c-17.8,-1.9,-35.7,-3.3,-53.6,-2.8c-19.5,0.6,-39,1.7,-58.4,4.5c-20.7,3,-41,7.4,-60.7,14.5C71.3,46.1,58.7,52.4,48.4,63   c-2.7,2.8,-3.5,7.2,-7.3,9c-2.6,-16.6,7.9,-25.6,19.8,-33.3c19.3,-12.3,41.2,-18.2,63.4,-22.6c21,-4.2,42.2,-6.3,63.6,-7.3   c11.1,-0.5,22.3,-1,33.4,-0.6c37.2,1.5,74,5.3,109.4,17.9c13.1,4.6,25.6,10.4,36.2,19.6C374.7,52.5,379.3,61,377,72z"
-        android:fillColor="#808080"/>
-    <path
-        android:pathData="M179,887.2c20,0.9,40,1.2,60,0c0,0.3,0,0.5,0,0.8c-1.1,1.4,-2.7,1,-4.1,1c-17.2,0,-34.5,0,-51.7,0   c-1.4,0,-3,0.4,-4.1,-1C179,887.7,179,887.5,179,887.2z"
-        android:fillColor="#F4F3F2"/>
-    <path
-        android:pathData="M76,869.9c11.6,2.2,22.6,6.5,34.2,8.4c2.6,0.4,5.2,1.2,7.7,1.8c-3.9,2.3,-7.3,-0.6,-10.9,-1.1   c-9.8,-1.6,-19.2,-4.7,-28.7,-7.4C77.5,871.3,76.8,870.5,76,869.9z"
-        android:fillColor="#F4F3F2"/>
-    <path
-        android:pathData="M125.1,881.3c12.6,1.6,25.2,3.2,37.9,4.8c-5.2,2.6,-10.3,0,-15.4,-0.3c-6.7,-0.4,-13.3,-1.9,-19.9,-2.8   C126.3,882.9,125.2,882.8,125.1,881.3z"
-        android:fillColor="#F4F3F2"/>
-    <path
-        android:pathData="M282,883.1c5.6,-0.9,11.3,-1.9,16.9,-2.8C293.7,883.4,288.1,884.4,282,883.1z"
-        android:fillColor="#F4F3F2"/>
-    <path
-        android:pathData="M179,887.2c0,0.3,0,0.5,0,0.8c-3.8,0,-7.6,0,-11.5,0c-1.4,0,-3.2,0.4,-3.5,-1.8C169,886.5,174,886.9,179,887.2z"
-        android:fillColor="#FFFFFF"/>
-    <path
-        android:pathData="M239,888c0,-0.3,0,-0.5,0,-0.8c5,-0.3,9.9,-0.7,14.9,-1c-0.3,2.2,-2.1,1.8,-3.5,1.8C246.6,888,242.8,888,239,888z"
-        android:fillColor="#FFFFFF"/>
-    <path
-        android:pathData="M70,867.9c2.3,-0.2,4.3,0.4,6,2C73.8,870.1,71.6,870,70,867.9z"
-        android:fillColor="#F4F3F2"/>
-    <path
-        android:pathData="M68.2,866.8c0.7,0.2,1.6,0.2,1.8,1.1C69.5,867.4,67.6,869.2,68.2,866.8z"
-        android:fillColor="#F4F3F2"/>
-    <path
-        android:pathData="M165,584c0.3,-0.3,0.7,-0.6,1,-1c10.5,-1.3,21,-3.3,31.5,-3.8c20.8,-1.1,41.4,0.7,61.7,5.4   c30.5,7,57.8,20.3,81.8,40.5c4.4,5.9,10.8,10,14.8,16.2c0.5,0.8,0.9,1.7,1.3,2.6c-2.4,4.1,-4.7,8.1,-7.1,12.2c-4,3.7,-6.3,8.9,-11,12   c-1.6,-0.1,-2.8,0.5,-4.1,1.5c-12.6,9.3,-26.7,15.6,-41.5,20.1c-31,9.4,-62.6,13.3,-95.1,11.6c-12.3,-0.6,-24.5,-1.5,-36.5,-3.4   c-4.5,-0.7,-5.3,0.5,-4.8,4.2c-0.5,0,-1,0.1,-1.5,0c-17.8,-3.9,-34.7,-10.3,-50.9,-18.7c-1,-0.5,-1.6,-1.1,-1.6,-2.3c2.3,-0.3,4.1,1.1,6.1,2   c14.2,6.2,28.9,10.6,44.1,13.3c2.5,0.4,3,0.2,2.4,-2.3c-2.5,-9.3,-3.7,-18.7,-4.8,-28.3c-1.5,-13.7,-0.3,-27.1,1.7,-40.5   C154.6,610.8,159.7,597.4,165,584z"
-        android:fillColor="#E57474"/>
-    <path
-        android:pathData="M103,681c0.1,1.1,0.7,1.8,1.6,2.3c16.2,8.4,33.1,14.8,50.9,18.7c0.5,0.1,1,0,1.5,0c0.6,0.4,1.3,0.7,1.9,1.1   c-0.1,2.7,1,5.2,1.9,7.6c6.5,17.8,16.5,33.6,27.5,48.8c12.5,17.1,27.1,32.1,45.1,43.6c6.6,4.2,13.7,7.3,20.5,11   c-15.6,2.8,-31.4,2.5,-47.1,2.4c-9.9,0,-19.9,-0.2,-29.8,-1.1c-18.2,-1.6,-36.2,-3.9,-54,-8.3c-18.1,-4.4,-35.9,-9.5,-51,-21.1   c-16.9,-15.8,-21.8,-37,-26,-58.4c-2.9,-14.7,-3.6,-29.6,-3,-44.5c3.5,-14.4,9.7,-27.4,18.9,-39c3.4,4.8,6.2,10.1,10.3,14.2   c6,6.1,11.6,13,19.7,16.8c0.5,0.8,1.2,1,2.1,1c0,0,0,0,0,0c0.3,0.3,0.7,0.7,1,1c0,0,0,0,0,0c0.3,0.3,0.7,0.7,1,1l0,0   c1,1.3,2.4,1.8,4,2l0,0C100.7,681.2,101.9,681,103,681L103,681z"
-        android:fillColor="#E6A3A3"/>
-    <path
-        android:pathData="M341,625c-24,-20.1,-51.3,-33.5,-81.8,-40.5c-20.3,-4.7,-41,-6.5,-61.7,-5.4c-10.5,0.6,-21,2.5,-31.5,3.8   c13.4,-27.8,32.5,-49.9,61.8,-61.9c4.9,-2,10.1,-3.1,15.3,-4.1c6.3,-1.2,11.2,2.6,16.3,5.2c5.2,2.6,9.9,6.2,15.1,8.6   c13.3,6,20.3,18,28.7,28.8c12.5,16,24.6,32.2,32.9,50.8C338.3,615.2,341,619.7,341,625z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M91.9,675c-8,-3.8,-13.6,-10.7,-19.7,-16.8c-4.1,-4.1,-6.9,-9.4,-10.3,-14.2c21.3,-27.5,49.8,-44.3,82.3,-54.9   c6.8,-2.2,13.6,-4.3,20.7,-5.1c-5.3,13.4,-10.4,26.9,-12.5,41.2c-2,13.4,-3.2,26.8,-1.7,40.5c1.1,9.6,2.3,19,4.8,28.3   c0.7,2.5,0.1,2.7,-2.4,2.3c-15.2,-2.6,-29.9,-7.1,-44.1,-13.3c-2,-0.9,-3.7,-2.3,-6.1,-2c0,0,0,0,0,0c-0.7,-1.2,-1.9,-1,-3,-1c0,0,0,0,0,0   c-0.3,-2.7,-2.4,-1.8,-4,-2c0,0,0,0,0,0c-0.3,-0.3,-0.7,-0.7,-1,-1c0,0,0,0,0,0c-0.3,-0.3,-0.7,-0.7,-1,-1c0,0,0,0,0,0   C93.6,675.2,92.8,675,91.9,675z"
-        android:fillColor="#D86868"/>
-    <path
-        android:pathData="M135,832.8c1.3,0.1,2.6,0.3,3.9,0.4c0.9,0.8,2,0.7,3.1,0.6c13.1,2.2,26.4,3,39.6,4.1   c4.5,0.3,9,0.2,13.4,-0.5c3.1,0.3,6.3,0.7,9.4,0.8c22.6,0.4,45.2,-0.9,67.6,-4.1c23.9,-3.3,47.4,-8.2,69.8,-17.6   c10.7,-4.5,21.4,-9.3,29.3,-18.3l0,0.1c6.2,-4.6,8.5,-11.8,11.9,-18.2c5.2,4.3,3.3,10.1,2.2,15c-2.2,9.7,-9.6,15.7,-17.4,21   c-17.1,11.7,-36.5,18.1,-56.4,22.9c-19.3,4.7,-38.9,7.4,-58.7,9.3c-21.4,2,-42.8,2.5,-64.2,1.6c-20.3,-0.8,-40.5,-2.8,-60.6,-6.5   c-19,-3.5,-37.6,-8.2,-55.4,-15.4c-11.9,-4.8,-23.4,-10.6,-32.3,-20.2c-5.3,-5.8,-8.9,-12.4,-8.3,-20.6c0.1,-1.2,0,-2.4,1.1,-3.1   c3.3,3.1,4.1,7.8,7.2,11.1c9,9.9,20.2,16.3,32.4,21.4c16.8,7,34.3,11.7,52.3,14.5c0.6,0.1,1.2,0.2,1.9,0.3c0.9,0.8,2,0.7,3.1,0.6   c0.6,0.1,1.3,0.2,1.9,0.3C132.8,833,133.9,833,135,832.8z"
-        android:fillColor="#999899"/>
-    <path
-        android:pathData="M371.9,667c2.8,-3.5,0.4,-7.1,-0.3,-10.4c-5.7,-26.6,-17.7,-50.3,-34.2,-71.7c-0.8,-1,-1.5,-2.2,-2.3,-3.3   c-0.3,-0.5,-0.6,-1.1,-1,-1.9c3.4,3,6.9,5.4,9.6,8.6c10.8,13.1,20.4,27,27.7,42.4c8,16.9,13.1,34.6,15.8,53.1   c1.9,12.9,2.6,25.8,1.7,38.7c-1.7,22.4,-6,44.3,-14.7,65.1c-1.4,3.3,-3.1,6.6,-3,10.4c0,0,0,-0.1,0,-0.1c-1.8,-0.3,-3.3,0.4,-4.7,1.2   c-6.3,3.7,-12.6,7.3,-19.4,10.2c-24,10.3,-48.8,14.5,-74.7,9.2c-4.2,-0.9,-9.4,-0.2,-12.4,-4.8c13.8,-2,27.6,-4.4,41.1,-8   c10,-2.7,20,-5.4,29,-10.8c1.5,-0.5,3.2,-0.9,4.6,-1.6c10.6,-5.1,19.5,-12.1,25.3,-22.6c4.7,-3.1,8.2,-10.7,6.9,-15c0.3,-1.4,0.6,-2.9,1,-4.3   c5.4,-16.2,7.5,-33.1,9,-50C378,689.7,375.5,678.3,371.9,667z"
-        android:fillColor="#F1F0F0"/>
-    <path
-        android:pathData="M371.9,667c3.6,11.3,6.1,22.7,5.1,34.6c-1.5,16.9,-3.6,33.8,-9,50c-0.5,1.4,-0.7,2.9,-1,4.3   c-2.3,5,-4.6,10,-6.9,15c-5.8,10.5,-14.7,17.5,-25.3,22.6c-1.5,0.7,-3.1,1.1,-4.6,1.6c-0.3,-2.1,0.3,-3.9,1.1,-5.7   c3.4,-7.4,6.4,-14.9,8.9,-22.6c6,-18.1,10,-36.5,12,-55.6c1.2,-11.6,0.9,-23.2,0.6,-34.8c-0.2,-6.8,-0.7,-13.8,-2.8,-20.5   c2.4,-4.1,4.7,-8.1,7.1,-12.2c5.6,4.7,8.4,11.3,11.7,17.6C369.8,663.3,370.8,665.2,371.9,667z"
-        android:fillColor="#E6A3A3"/>
-    <path
-        android:pathData="M260,814c2.9,4.6,8.1,3.9,12.4,4.8c25.9,5.3,50.7,1.1,74.7,-9.2c6.7,-2.9,13.1,-6.4,19.4,-10.2   c1.4,-0.9,2.9,-1.6,4.7,-1.2c-7.9,9.1,-18.6,13.8,-29.3,18.3c-22.3,9.4,-45.9,14.3,-69.8,17.6c-22.4,3.1,-45,4.4,-67.6,4.1   c-3.1,-0.1,-6.3,-0.5,-9.4,-0.8c-0.1,-2,-1.4,-2.2,-3,-2.4c-28.3,-3,-56,-8.2,-82.4,-19.1c-13.4,-5.5,-26.5,-11.8,-35.3,-24.1c-1.3,-1.8,-2.4,-3.6,-2.2,-5.9   c15.1,11.6,32.9,16.7,51,21.1c17.7,4.4,35.8,6.6,54,8.3c10,0.9,20,1.1,29.8,1.1c15.7,0.1,31.5,0.4,47.1,-2.4   C256,814,258,814,260,814z"
-        android:fillColor="#EDECEC"/>
-    <path
-        android:pathData="M130,831.9c-1.1,0.1,-2.2,0.2,-3.1,-0.6C128.3,829.5,129.4,829.5,130,831.9z"
-        android:fillColor="#EDECEC"/>
-    <path
-        android:pathData="M135,832.8c-1.1,0.1,-2.2,0.2,-3.1,-0.7C133.4,830.5,134.4,830.6,135,832.8z"
-        android:fillColor="#EDECEC"/>
-    <path
-        android:pathData="M142,833.8c-1.1,0.1,-2.2,0.2,-3.1,-0.6C140.3,831.5,141.4,831.5,142,833.8z"
-        android:fillColor="#EDECEC"/>
-    <path
-        android:pathData="M260,814c-2,0,-4,0,-6,0c-6.8,-3.7,-13.9,-6.8,-20.5,-11c-18,-11.5,-32.7,-26.4,-45.1,-43.6c-11,-15.2,-21,-31,-27.5,-48.8   c-0.9,-2.5,-2,-4.9,-1.9,-7.7c0.7,0,1.4,-0.1,2,0.1c16.2,4.6,33.1,5.3,49.6,5.3c10,0,20.1,-0.2,30.2,-1.3c19.5,-2,38.7,-5.3,57,-12.4   c15.6,-6,30.1,-13.9,41.3,-26.9c4.7,-3.1,7,-8.3,11,-12c2.1,6.7,2.6,13.7,2.8,20.5c0.3,11.6,0.6,23.1,-0.6,34.8c-2,19,-6,37.5,-12,55.6   c-2.6,7.7,-5.5,15.3,-8.9,22.6c-0.9,1.9,-1.5,3.7,-1.1,5.7c-9,5.4,-19,8.1,-29,10.8C287.6,809.6,273.8,811.9,260,814z"
-        android:fillColor="#E6A3A3"/>
-    <path
-        android:pathData="M339,668c-11.1,13,-25.7,20.8,-41.3,26.9c-18.3,7.1,-37.5,10.4,-57,12.4c-10.1,1,-20.3,1.3,-30.2,1.3   c-16.6,0,-33.4,-0.7,-49.6,-5.3c-0.6,-0.2,-1.3,-0.1,-2,-0.1c-0.6,-0.4,-1.3,-0.7,-1.9,-1.1c-0.4,-3.8,0.3,-5,4.8,-4.2c12.1,2,24.3,2.8,36.5,3.4   c32.4,1.7,64.1,-2.3,95.1,-11.6c14.8,-4.5,29,-10.8,41.5,-20.1C336.3,668.5,337.5,667.9,339,668z"
-        android:fillColor="#FFFFFF"/>
-    <path
-        android:pathData="M96,678c1.6,0.2,3.7,-0.7,4,2C98.4,679.8,97,679.3,96,678z"
-        android:fillColor="#FFFFFF"/>
-    <path
-        android:pathData="M100,680c1.1,0,2.3,-0.2,3,1C101.9,681,100.7,681.2,100,680z"
-        android:fillColor="#FFFFFF"/>
-    <path
-        android:pathData="M91.9,675c0.8,0,1.6,0.2,2.1,1C93.2,676,92.4,675.8,91.9,675z"
-        android:fillColor="#FFFFFF"/>
-    <path
-        android:pathData="M94,676c0.3,0.3,0.7,0.7,1,1C94.7,676.7,94.3,676.3,94,676z"
-        android:fillColor="#FFFFFF"/>
-    <path
-        android:pathData="M95,677c0.3,0.3,0.7,0.7,1,1C95.7,677.7,95.3,677.3,95,677z"
-        android:fillColor="#C5C5C5"/>
-    <path
-        android:pathData="M360,771c2.3,-5,4.6,-10,6.9,-15C368.2,760.3,364.7,767.8,360,771z"
-        android:fillColor="#EDECEC"/>
-</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/hourglass_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/hourglass_m3.xml
new file mode 100644
index 000000000..81b51b3d3
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/hourglass_m3.xml
@@ -0,0 +1,93 @@
+<!--
+Copyright (C) 2024 The Android Open Source Project
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="200dp"
+    android:height="200dp"
+    android:viewportWidth="200"
+    android:viewportHeight="200">
+    <path
+        android:pathData="M105.65,165.8C106.75,165.71 107.71,166.54 107.79,167.64C107.88,168.74 107.06,169.7 105.96,169.79C104.15,169.93 102.34,170 100.5,170C98.66,170 96.84,169.93 95.04,169.79C93.94,169.7 93.12,168.74 93.21,167.64C93.29,166.54 94.25,165.71 95.35,165.8C97.05,165.93 98.77,166 100.5,166C102.23,166 103.95,165.93 105.65,165.8Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M72.81,162.11C73.24,161.09 74.41,160.61 75.43,161.03C78.57,162.33 81.83,163.4 85.2,164.2C86.28,164.46 86.94,165.54 86.68,166.61C86.42,167.69 85.34,168.35 84.27,168.1C80.7,167.24 77.23,166.11 73.9,164.73C72.88,164.3 72.39,163.13 72.81,162.11Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M125.57,161.03C126.59,160.61 127.76,161.09 128.19,162.11C128.61,163.13 128.13,164.3 127.1,164.73C123.77,166.11 120.3,167.24 116.73,168.1C115.65,168.35 114.58,167.69 114.32,166.61C114.06,165.54 114.72,164.46 115.8,164.2C119.17,163.4 122.43,162.33 125.57,161.03Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M55.14,150.53C55.86,149.69 57.12,149.59 57.96,150.31C60.24,152.26 62.65,154.05 65.18,155.67L66.27,156.36L66.44,156.47C67.25,157.09 67.47,158.23 66.93,159.11C66.39,159.99 65.27,160.3 64.36,159.86L64.18,159.77L63.02,159.04C60.34,157.32 57.78,155.41 55.36,153.35C54.52,152.63 54.42,151.37 55.14,150.53Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M143.04,150.31C143.88,149.59 145.14,149.69 145.86,150.53C146.58,151.37 146.48,152.63 145.64,153.35C142.88,155.71 139.93,157.86 136.82,159.77L136.64,159.86C135.73,160.3 134.61,159.99 134.07,159.11C133.49,158.17 133.79,156.93 134.73,156.36L135.82,155.67C138.35,154.05 140.76,152.26 143.04,150.31Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M41.89,134.07C42.77,133.53 43.91,133.75 44.53,134.56L44.64,134.73L45.33,135.82C46.95,138.35 48.74,140.76 50.69,143.04C51.41,143.88 51.31,145.14 50.47,145.86C49.63,146.58 48.37,146.48 47.65,145.64C45.59,143.22 43.68,140.66 41.96,137.98L41.23,136.82L41.14,136.64C40.7,135.73 41.01,134.61 41.89,134.07Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M156.47,134.56C157.09,133.75 158.23,133.53 159.11,134.07C160.05,134.65 160.34,135.88 159.77,136.82L159.04,137.98C157.32,140.66 155.41,143.22 153.35,145.64C152.63,146.48 151.37,146.58 150.53,145.86C149.69,145.14 149.59,143.88 150.31,143.04C152.53,140.44 154.56,137.66 156.36,134.73L156.47,134.56Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M34.39,114.32C35.46,114.06 36.54,114.72 36.8,115.8C37.6,119.17 38.67,122.43 39.97,125.57C40.39,126.59 39.91,127.76 38.89,128.19C37.87,128.61 36.7,128.13 36.27,127.1C34.89,123.77 33.76,120.3 32.91,116.73C32.65,115.65 33.31,114.58 34.39,114.32Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M164.2,115.8C164.46,114.72 165.54,114.06 166.61,114.32C167.69,114.58 168.35,115.65 168.1,116.73C167.24,120.3 166.11,123.77 164.73,127.1C164.3,128.13 163.13,128.61 162.11,128.19C161.09,127.76 160.61,126.59 161.03,125.57C162.33,122.43 163.4,119.17 164.2,115.8Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M33.36,93.21C34.46,93.29 35.28,94.25 35.2,95.35C35.07,97.05 35,98.77 35,100.5C35,102.23 35.07,103.95 35.2,105.65C35.28,106.75 34.46,107.71 33.36,107.79C32.26,107.88 31.3,107.06 31.21,105.96C31.07,104.15 31,102.34 31,100.5C31,98.66 31.07,96.84 31.21,95.04C31.3,93.94 32.26,93.12 33.36,93.21Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M167.64,93.21C168.74,93.12 169.7,93.94 169.79,95.04C169.93,96.84 170,98.66 170,100.5C170,102.34 169.93,104.15 169.79,105.96C169.7,107.06 168.74,107.88 167.64,107.79C166.54,107.71 165.71,106.75 165.8,105.65C165.93,103.95 166,102.23 166,100.5C166,98.77 165.93,97.05 165.8,95.35C165.71,94.25 166.54,93.29 167.64,93.21Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M36.27,73.9C36.7,72.88 37.87,72.39 38.89,72.81C39.91,73.24 40.39,74.41 39.97,75.43C38.67,78.57 37.6,81.83 36.8,85.2C36.54,86.28 35.46,86.94 34.39,86.68C33.31,86.42 32.65,85.34 32.91,84.27C33.76,80.7 34.89,77.23 36.27,73.9Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M162.11,72.81C163.13,72.39 164.3,72.88 164.73,73.9C166.11,77.23 167.24,80.7 168.1,84.27C168.35,85.34 167.69,86.42 166.61,86.68C165.54,86.94 164.46,86.28 164.2,85.2C163.4,81.83 162.33,78.57 161.03,75.43C160.61,74.41 161.09,73.24 162.11,72.81Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M47.65,55.36C48.37,54.52 49.63,54.42 50.47,55.14C51.31,55.86 51.41,57.12 50.69,57.96C48.47,60.56 46.44,63.34 44.64,66.27L44.53,66.44C43.91,67.25 42.77,67.47 41.89,66.93C40.95,66.35 40.66,65.12 41.23,64.18L41.96,63.02C43.68,60.34 45.59,57.78 47.65,55.36Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M150.53,55.14C151.37,54.42 152.63,54.52 153.35,55.36C155.41,57.78 157.32,60.34 159.04,63.02L159.77,64.18L159.86,64.36C160.3,65.27 159.99,66.39 159.11,66.93C158.23,67.47 157.09,67.25 156.47,66.44L156.36,66.27L155.67,65.18C154.05,62.65 152.26,60.24 150.31,57.96C149.59,57.12 149.69,55.86 150.53,55.14Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M64.36,41.14C65.27,40.7 66.39,41.01 66.93,41.89C67.51,42.83 67.21,44.06 66.27,44.64L65.18,45.33C62.65,46.95 60.24,48.74 57.96,50.69C57.12,51.41 55.86,51.31 55.14,50.47C54.42,49.63 54.52,48.37 55.36,47.65C58.12,45.29 61.07,43.14 64.18,41.23L64.36,41.14Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M134.07,41.89C134.61,41.01 135.73,40.7 136.64,41.14L136.82,41.23L137.98,41.96C140.66,43.68 143.22,45.59 145.64,47.65C146.48,48.37 146.58,49.63 145.86,50.47C145.14,51.31 143.88,51.41 143.04,50.69C140.76,48.74 138.35,46.95 135.82,45.33L134.73,44.64L134.56,44.53C133.75,43.91 133.53,42.77 134.07,41.89Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M84.27,32.91C85.34,32.65 86.42,33.31 86.68,34.39C86.94,35.46 86.28,36.54 85.2,36.8C81.83,37.6 78.57,38.67 75.43,39.97C74.41,40.39 73.24,39.91 72.81,38.89C72.39,37.87 72.88,36.7 73.9,36.27C77.23,34.89 80.7,33.76 84.27,32.91Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M114.32,34.39C114.58,33.31 115.65,32.65 116.73,32.91C120.3,33.76 123.77,34.89 127.1,36.27L127.29,36.36C128.18,36.84 128.58,37.93 128.19,38.89C127.76,39.91 126.59,40.39 125.57,39.97C122.43,38.67 119.17,37.6 115.8,36.8C114.72,36.54 114.06,35.46 114.32,34.39Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M100.5,31C102.34,31 104.15,31.07 105.96,31.21L106.16,31.24C107.16,31.42 107.88,32.33 107.79,33.36C107.71,34.46 106.75,35.28 105.65,35.2L104.37,35.11C103.09,35.04 101.8,35 100.5,35C98.77,35 97.05,35.07 95.35,35.2C94.25,35.28 93.29,34.46 93.21,33.36C93.12,32.26 93.94,31.3 95.04,31.21C96.84,31.07 98.66,31 100.5,31Z"
+        android:fillColor="?attr/colorOutlineVariant"/>
+    <path
+        android:pathData="M67.67,128.9C66.25,128.9 65,128.36 63.94,127.3C62.87,126.17 62.34,124.93 62.34,123.56V77.33C62.34,75.97 62.87,74.76 63.94,73.69C65,72.56 66.25,72 67.67,72H90.43C91.14,72 91.82,72.15 92.48,72.44C93.19,72.74 93.78,73.13 94.25,73.6L97.99,77.33H128.13C129.49,77.33 130.7,77.9 131.77,79.02C132.9,80.09 133.46,81.31 133.46,82.67V123.56C133.46,124.93 132.9,126.17 131.77,127.3C130.7,128.36 129.49,128.9 128.13,128.9H67.67Z"
+        android:fillColor="?attr/colorPrimaryInverse"/>
+    <path
+        android:pathData="M143.32,88.29C147.6,88.29 150.47,92.69 148.74,96.6L136.51,124.23C135.23,127.13 132.36,129 129.19,129H67.07L67.07,129C65.89,128.96 64.82,128.24 64.1,127.52C65.52,127.88 67.63,127.56 68.45,125.87L82.93,93.06C84.21,90.16 87.09,88.29 90.26,88.29H143.32Z"
+        android:fillColor="?attr/colorPrimaryContainer"/>
+    <path
+        android:pathData="M142.88,128.29C145.03,124.54 146.11,122.66 147.42,121.86C149.31,120.71 151.69,120.71 153.58,121.86C154.89,122.66 155.97,124.54 158.12,128.29L169.77,148.59C171.9,152.31 172.97,154.17 173,155.69C173.04,157.89 171.85,159.94 169.92,161C168.59,161.73 166.44,161.73 162.14,161.73H138.86C134.56,161.73 132.41,161.73 131.08,161C129.15,159.94 127.96,157.89 128,155.69C128.03,154.17 129.1,152.31 131.23,148.59L142.88,128.29Z"
+        android:fillColor="#F55E57"/>
+    <path
+        android:pathData="M150.66,147.94C150.26,147.94 149.91,147.79 149.61,147.51C149.32,147.22 149.16,146.88 149.13,146.48L148.81,136.91C148.78,136.37 148.95,135.91 149.32,135.52C149.68,135.13 150.13,134.93 150.66,134.93C151.2,134.93 151.65,135.13 152.02,135.52C152.38,135.91 152.55,136.37 152.52,136.91L152.18,146.48C152.16,146.89 151.99,147.23 151.69,147.51C151.4,147.79 151.06,147.94 150.66,147.94ZM150.66,153.84C150.01,153.84 149.46,153.63 149.02,153.21C148.58,152.78 148.36,152.26 148.36,151.64C148.36,151.02 148.58,150.5 149.02,150.08C149.46,149.66 150.01,149.45 150.66,149.45C151.31,149.45 151.85,149.66 152.3,150.08C152.74,150.5 152.97,151.02 152.97,151.64C152.97,152.26 152.74,152.78 152.3,153.21C151.86,153.63 151.32,153.84 150.66,153.84Z"
+        android:fillColor="?attr/colorSurface"/>
+</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_action_clear.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_action_clear_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_action_clear.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_action_clear_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_action_open.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_action_open_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_action_open.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_action_open_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_advanced_shortcut.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_advanced_shortcut_m3.xml
similarity index 54%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_advanced_shortcut.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_advanced_shortcut_m3.xml
index 23b1be846..69e924c47 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_advanced_shortcut.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_advanced_shortcut_m3.xml
@@ -16,17 +16,18 @@
   -->
 
 <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
-    <background android:drawable="@color/shortcut_background" />
+    <background android:drawable="@color/shortcut_background_m3" />
     <foreground>
         <inset android:inset="33%">
+            <!-- from ic_root_smartphone.xml -->
             <vector
                 android:width="24dp"
                 android:height="24dp"
-                android:viewportWidth="24.0"
-                android:viewportHeight="24.0">
+                android:viewportWidth="960"
+                android:viewportHeight="960">
                 <path
-                    android:fillColor="@color/shortcut_foreground"
-                    android:pathData="M17 1.01L7 1c-1.1 0,-2 .9,-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2,-.9 2,-2V3c0,-1.1,-.9,-1.99,-2,-1.99zM17 19H7V5h10v14z"/>
+                    android:fillColor="@color/shortcut_foreground_m3"
+                    android:pathData="M280,920Q247,920 223.5,896.5Q200,873 200,840L200,120Q200,87 223.5,63.5Q247,40 280,40L680,40Q713,40 736.5,63.5Q760,87 760,120L760,840Q760,873 736.5,896.5Q713,920 680,920L280,920ZM280,800L280,840Q280,840 280,840Q280,840 280,840L680,840Q680,840 680,840Q680,840 680,840L680,800L280,800ZM280,720L680,720L680,240L280,240L280,720ZM280,160L680,160L680,120Q680,120 680,120Q680,120 680,120L280,120Q280,120 280,120Q280,120 280,120L280,160ZM280,160L280,120Q280,120 280,120Q280,120 280,120L280,120Q280,120 280,120Q280,120 280,120L280,160ZM280,800L280,800L280,840Q280,840 280,840Q280,840 280,840L280,840Q280,840 280,840Q280,840 280,840L280,800Z"/>
             </vector>
         </inset>
     </foreground>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_back.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_back_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_back.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_back_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_done.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_drop_down.xml
similarity index 63%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_done.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_drop_down.xml
index 8439cb2a5..178a8c569 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_done.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_drop_down.xml
@@ -1,11 +1,11 @@
 <?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
+<!-- Copyright 2025, The Android Open Source Project
 
      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at
 
-          http://www.apache.org/licenses/LICENSE-2.0
+      http://www.apache.org/licenses/LICENSE-2.0
 
      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
@@ -14,11 +14,11 @@
      limitations under the License.
 -->
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="24dp"
-        android:height="24dp"
-        android:viewportWidth="24.0"
-        android:viewportHeight="24.0">
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
     <path
-        android:fillColor="?android:colorAccent"
-        android:pathData="M9,16.2L4.8,12l-1.4,1.4L9,19 21,7l-1.4,-1.4L9,16.2z"/>
+        android:fillColor="?attr/colorPrimary"
+        android:pathData="M480,600L280,400L680,400L480,600Z"/>
 </vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward_m3.xml
similarity index 53%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward_m3.xml
index dbee1c363..c06db0198 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward_m3.xml
@@ -15,12 +15,12 @@
     limitations under the License.
   -->
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
-    android:width="28dp"
-    android:height="32dp"
-    android:viewportHeight="32"
-    android:viewportWidth="28">
-
+    android:width="20dp"
+    android:height="20dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960"
+    android:tint="?attr/colorOnSurface">
     <path
-        android:fillColor="?attr/colorOnSecondaryContainer"
-        android:pathData="M13.25 19.125V10.75c0-.208.07-.382.208-.52A.74.74 0 0 1 14 10c.208 0 .382.076.52.23.154.138.23.312.23.52v8.375l3.667-3.667a.718.718 0 0 1 .52-.229c.209 0 .39.077.542.23.153.152.23.333.23.541a.718.718 0 0 1-.23.52l-4.958 4.96a.786.786 0 0 1-.25.166.85.85 0 0 1-.271.041c-.097 0-.194-.013-.292-.041a.878.878 0 0 1-.229-.167l-4.958-4.958A.718.718 0 0 1 8.29 16a.822.822 0 0 1 .25-.542.718.718 0 0 1 .521-.229.74.74 0 0 1 .542.23l3.646 3.666Z" />
-</vector>
\ No newline at end of file
+        android:fillColor="@android:color/white"
+        android:pathData="M444,330L267.79,506.21Q257,517 242.5,517Q228,517 216.52,506Q206,495 206,480.5Q206,466 216.82,455.19L454.91,217.4Q460.32,212 466.63,209.5Q472.94,207 480.16,207Q487.37,207 493.69,209.5Q500,212 505,217L743,455Q754,466 754,480Q754,494 743.48,505Q732,516 717.33,516Q702.67,516 692,505L516,330L516,732.02Q516,747.31 505.71,757.66Q495.42,768 480.21,768Q465,768 454.5,757.66Q444,747.31 444,732.02L444,330Z"/>
+</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_breadcrumb_arrow.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_breadcrumb_arrow_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_breadcrumb_arrow.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_breadcrumb_arrow_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_briefcase_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_briefcase_m3.xml
new file mode 100644
index 000000000..a8054e72b
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_briefcase_m3.xml
@@ -0,0 +1,32 @@
+<!--
+  ~ Copyright (C) 2024 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License.
+  -->
+
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
+  <!--
+        ic_briefcase is just a fallback drawable, the code logic loads the icon from the system
+        first and if it fails, this drawable will be used. So we always need an android:tint
+        attribute specified on the layout file (which overshadows the "white" color below),
+        otherwise the icon loaded from the system won't have the correct icon color. That's why we
+        just put "white" here, it will never be used.
+   -->
+  <path
+      android:fillColor="@android:color/white"
+      android:pathData="M160,840Q127,840 103.5,816.5Q80,793 80,760L80,320Q80,287 103.5,263.5Q127,240 160,240L320,240L320,160Q320,127 343.5,103.5Q367,80 400,80L560,80Q593,80 616.5,103.5Q640,127 640,160L640,240L800,240Q833,240 856.5,263.5Q880,287 880,320L880,760Q880,793 856.5,816.5Q833,840 800,840L160,840ZM400,240L560,240L560,160Q560,160 560,160Q560,160 560,160L400,160Q400,160 400,160Q400,160 400,160L400,240Z"/>
+</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_briefcase_white.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_briefcase_white_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_briefcase_white.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_briefcase_white_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_cab_cancel.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_cab_cancel_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_cab_cancel.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_cab_cancel_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_cancel.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_cancel.xml
index f47cd4f6b..6de3ce03d 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_cancel.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_cancel.xml
@@ -17,8 +17,9 @@
     android:width="24dp"
     android:height="24dp"
     android:viewportHeight="960"
-    android:viewportWidth="960">
+    android:viewportWidth="960"
+    android:tint="?attr/colorOnSurface">
     <path
-        android:fillColor="?attr/colorOnSurface"
+        android:fillColor="@android:color/white"
         android:pathData="M256,760L200,704L424,480L200,256L256,200L480,424L704,200L760,256L536,480L760,704L704,760L480,536L256,760Z" />
 </vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_circle.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_circle_m3.xml
similarity index 90%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_circle.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_circle_m3.xml
index 71ad135b1..6d745d1ec 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_circle.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_circle_m3.xml
@@ -14,12 +14,12 @@ Copyright (C) 2024 The Android Open Source Project
     limitations under the License.
 -->
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
-    android:width="20dp"
-    android:height="20dp"
+    android:width="@dimen/icon_check_circle_size"
+    android:height="@dimen/icon_check_circle_size"
     android:viewportWidth="960"
     android:viewportHeight="960">
     <path
-        android:fillColor="?attr/colorOnPrimaryContainer"
+        android:fillColor="?attr/colorPrimary"
         android:pathData="M428.28,628.78L669.87,388.2L612.41,330.5L428.28,513.63L346.15,432.5L288.7,490.2L428.28,628.78ZM480,872.13Q399.09,872.13 327.66,841.51Q256.22,810.89 202.66,757.34Q149.11,703.78 118.49,632.34Q87.87,560.91 87.87,480Q87.87,398.09 118.49,327.16Q149.11,256.22 202.66,202.66Q256.22,149.11 327.66,118.49Q399.09,87.87 480,87.87Q561.91,87.87 632.84,118.49Q703.78,149.11 757.34,202.66Q810.89,256.22 841.51,327.16Q872.13,398.09 872.13,480Q872.13,560.91 841.51,632.34Q810.89,703.78 757.34,757.34Q703.78,810.89 632.84,841.51Q561.91,872.13 480,872.13Z"/>
 </vector>
 
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_m3.xml
similarity index 93%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_m3.xml
index 445d9969d..44615c3ec 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_m3.xml
@@ -18,7 +18,7 @@ Copyright (C) 2024 The Android Open Source Project
         android:height="24dp"
         android:viewportWidth="24.0"
         android:viewportHeight="24.0"
-        android:tint="@color/search_chip_text_selected_color">
+        android:tint="@color/search_chip_text_selected_color_m3">
     <path
         android:fillColor="@android:color/white"
         android:pathData="vM9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_from_this_week.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_from_this_week_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_from_this_week.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_from_this_week_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_large_files.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_large_files_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_large_files.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_large_files_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_create_new_folder.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_create_new_folder_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_create_new_folder.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_create_new_folder_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_debug_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_debug_menu_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_debug_menu.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_debug_menu_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_dialog_alert.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_dialog_alert_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_dialog_alert.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_dialog_alert_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_dialog_info.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_dialog_info_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_dialog_info.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_dialog_info_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_download.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_done_m3.xml
similarity index 74%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_download.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_done_m3.xml
index caea0922f..67e49561d 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_download.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_done_m3.xml
@@ -13,13 +13,12 @@
      See the License for the specific language governing permissions and
      limitations under the License.
 -->
-
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="24dp"
-        android:height="24dp"
-        android:viewportHeight="24"
-        android:viewportWidth="24">
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
     <path
-        android:fillColor="#5F6368"
-        android:pathData="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
+        android:fillColor="?attr/colorOnSurfaceVariant"
+        android:pathData="M382,720L154,492L211,435L382,606L749,239L806,296L382,720Z"/>
 </vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_draft.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_draft.xml
new file mode 100644
index 000000000..4956c0205
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_draft.xml
@@ -0,0 +1,23 @@
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="48dp"
+    android:height="48dp"
+    android:viewportHeight="960"
+    android:viewportWidth="960">
+    <path
+        android:fillColor="?attr/colorOnSurfaceVariant"
+        android:pathData="M240,880q-33,0 -56.5,-23.5T160,800v-640q0,-33 23.5,-56.5T240,80h320l240,240v480q0,33 -23.5,56.5T720,880L240,880ZM520,360v-200L240,160v640h480v-440L520,360ZM240,160v200,-200 640,-640Z" />
+</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge_m3.xml
similarity index 89%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge_m3.xml
index c929806fe..55019e51b 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge_m3.xml
@@ -20,13 +20,13 @@ Copyright (C) 2024 The Android Open Source Project
     android:viewportHeight="14">
     <path
         android:pathData="M7,0L7,0A7,7 0,0 1,14 7L14,7A7,7 0,0 1,7 14L7,14A7,7 0,0 1,0 7L0,7A7,7 0,0 1,7 0z"
-        android:fillColor="@color/drop_icon_copy_container_background"/>
+        android:fillColor="@color/success"/>
     <group>
         <clip-path
             android:pathData="M1,1h12v12h-12z"/>
         <path
             android:pathData="M6.387,11.438V7.613H2.563V6.387H6.387V2.563H7.613V6.387H11.438V7.613H7.613V11.438H6.387Z"
-            android:fillColor="@color/drop_icon_symbol_color"/>
+            android:fillColor="@color/on_success"/>
     </group>
 </vector>
 
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sd_storage.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_eject_m3.xml
similarity index 64%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sd_storage.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_eject_m3.xml
index bd54eb31b..161bb2948 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sd_storage.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_eject_m3.xml
@@ -14,11 +14,12 @@ Copyright (C) 2024 The Android Open Source Project
     limitations under the License.
 -->
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="24dp"
-        android:height="24dp"
-        android:viewportWidth="24.0"
-        android:viewportHeight="24.0">
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
+    <!-- fillColor will be set by tint color in the code. -->
     <path
-        android:fillColor="#5F6368"
-        android:pathData="M18 2h-8L4.02 8 4 20c0 1.1.9 2 2 2h12c1.1 0 2,-.9 2,-2V4c0,-1.1,-.9,-2,-2,-2zm-6 6h-2V4h2v4zm3 0h-2V4h2v4zm3 0h-2V4h2v4z"/>
+        android:fillColor="@android:color/white"
+        android:pathData="M200,760L200,680L760,680L760,760L200,760ZM214,600L480,200L746,600L214,600ZM480,520L480,520L480,520ZM362,520L598,520L480,344L362,520Z"/>
 </vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_exit_to_app.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_exit_to_app_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_exit_to_app.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_exit_to_app_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_folder_shortcut.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_folder_shortcut_m3.xml
similarity index 94%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_folder_shortcut.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_folder_shortcut_m3.xml
index fb2427a38..c57be442c 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_folder_shortcut.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_folder_shortcut_m3.xml
@@ -16,7 +16,7 @@
   -->
 
 <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
-    <background android:drawable="@color/shortcut_background" />
+    <background android:drawable="@color/shortcut_background_m3" />
     <foreground>
         <inset android:inset="33%">
             <vector
@@ -25,7 +25,7 @@
                 android:viewportWidth="24.0"
                 android:viewportHeight="24.0">
                 <path
-                    android:fillColor="@color/shortcut_foreground"
+                    android:fillColor="@color/shortcut_foreground_m3"
                     android:pathData="M10 4H4c-1.1 0,-1.99.9,-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2,-.9 2,-2V8c0,-1.1,-.9,-2,-2,-2h-8l-2,-2z"/>
             </vector>
         </inset>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_hamburger.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_hamburger_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_hamburger.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_hamburger_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_history.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_history_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_history.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_history_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_images_shortcut.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_images_shortcut.xml
deleted file mode 100644
index 66de1938c..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_images_shortcut.xml
+++ /dev/null
@@ -1,33 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!--
-  ~ Copyright (C) 2024 The Android Open Source Project
-  ~
-  ~ Licensed under the Apache License, Version 2.0 (the "License");
-  ~ you may not use this file except in compliance with the License.
-  ~ You may obtain a copy of the License at
-  ~
-  ~      http://www.apache.org/licenses/LICENSE-2.0
-  ~
-  ~ Unless required by applicable law or agreed to in writing, software
-  ~ distributed under the License is distributed on an "AS IS" BASIS,
-  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-  ~ See the License for the specific language governing permissions and
-  ~ limitations under the License.
-  -->
-
-<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
-    <background android:drawable="@color/shortcut_background" />
-    <foreground>
-      <inset android:inset="33%">
-        <vector xmlns:android="http://schemas.android.com/apk/res/android"
-          android:width="24dp"
-          android:height="24dp"
-          android:viewportHeight="24"
-          android:viewportWidth="24">
-        <path
-          android:fillColor="@color/shortcut_foreground"
-          android:pathData="M21 19V5c0,-1.1,-.9,-2,-2,-2H5c-1.1 0,-2 .9,-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2,-.9 2,-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5,-4.5z" />
-        </vector>
-      </inset>
-    </foreground>
-</adaptive-icon>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_smartphone.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_job_progress_collapse.xml
similarity index 57%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_smartphone.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_job_progress_collapse.xml
index 01af619a0..f02d03825 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_smartphone.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_job_progress_collapse.xml
@@ -1,7 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
 <!--
-Copyright (C) 2024 The Android Open Source Project
+    Copyright (C) 2025 The Android Open Source Project
 
-   Licensed under the Apache License, Version 2.0 (the "License");
+    Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at
 
@@ -12,13 +13,13 @@ Copyright (C) 2024 The Android Open Source Project
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
--->
+  -->
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="24dp"
-        android:height="24dp"
-        android:viewportWidth="24.0"
-        android:viewportHeight="24.0">
+    android:width="20dp"
+    android:height="20dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
     <path
-        android:fillColor="#5F6368"
-        android:pathData="M17 1.01L7 1c-1.1 0,-2 .9,-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2,-.9 2,-2V3c0,-1.1,-.9,-1.99,-2,-1.99zM17 19H7V5h10v14z"/>
+        android:fillColor="@android:color/white"
+        android:pathData="M480,453.09L291,642.09L221.91,573L480,314.91L738.09,573L669,642.09L480,453.09Z"/>
 </vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_job_progress_expand.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_job_progress_expand.xml
new file mode 100644
index 000000000..1f69e1843
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_job_progress_expand.xml
@@ -0,0 +1,25 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2025 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+  -->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="20dp"
+    android:height="20dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
+    <path
+        android:fillColor="@android:color/white"
+        android:pathData="M480,645.09L221.91,387L291,317.91L480,506.91L669,317.91L738.09,387L480,645.09Z"/>
+</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_compress.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_compress_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_compress.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_compress_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_copy.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_copy_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_copy.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_copy_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_delete.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_delete_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_delete.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_delete_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_extract.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_extract_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_extract.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_extract_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_search.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_search_m3.xml
similarity index 89%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_search.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_search_m3.xml
index 6d896b75d..04e52070e 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_search.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_search_m3.xml
@@ -18,8 +18,9 @@
         android:width="24dp"
         android:height="24dp"
         android:viewportWidth="24"
-        android:viewportHeight="24">
+        android:viewportHeight="24"
+        android:tint="?attr/colorControlNormal">
     <path
-        android:fillColor="?android:attr/colorControlNormal"
+        android:fillColor="@android:color/white"
         android:pathData="M15.5,14h-0.79l-0.28,-0.27C15.41,12.59 16,11.11 16,9.5 16,5.91 13.09,3 9.5,3S3,5.91 3,9.5 5.91,16 9.5,16c1.61,0 3.09,-0.59 4.23,-1.57l0.27,0.28v0.79l5,4.99L20.49,19l-4.99,-5zM9.5,14C7.01,14 5,11.99 5,9.5S7.01,5 9.5,5 14,7.01 14,9.5 11.99,14 9.5,14z"/>
 </vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_share.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_share_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_share.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_share_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_grid.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_grid_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_grid.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_grid_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_list.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_list_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_list.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_menu_view_list_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge_m3.xml
similarity index 96%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge_m3.xml
index ea2c3950c..6ffaab669 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge_m3.xml
@@ -27,6 +27,6 @@ Copyright (C) 2024 The Android Open Source Project
             android:pathData="M1,1h12v12h-12z"/>
         <path
             android:pathData="M7,12.038C6.308,12.038 5.654,11.908 5.037,11.65C4.429,11.383 3.896,11.021 3.438,10.563C2.979,10.096 2.617,9.558 2.35,8.95C2.092,8.333 1.962,7.679 1.962,6.988C1.962,6.287 2.092,5.637 2.35,5.037C2.617,4.429 2.979,3.896 3.438,3.438C3.896,2.979 4.429,2.621 5.037,2.362C5.654,2.096 6.308,1.962 7,1.962C7.7,1.962 8.354,2.096 8.962,2.362C9.571,2.621 10.104,2.979 10.563,3.438C11.021,3.896 11.379,4.429 11.637,5.037C11.904,5.637 12.038,6.287 12.038,6.988C12.038,7.679 11.904,8.333 11.637,8.95C11.379,9.558 11.021,10.096 10.563,10.563C10.104,11.021 9.571,11.383 8.962,11.65C8.354,11.908 7.7,12.038 7,12.038ZM7,10.813C7.417,10.813 7.817,10.75 8.2,10.625C8.583,10.5 8.925,10.317 9.225,10.075L3.912,4.762C3.679,5.079 3.5,5.425 3.375,5.8C3.25,6.175 3.188,6.571 3.188,6.988C3.188,8.046 3.558,8.95 4.3,9.7C5.042,10.442 5.942,10.813 7,10.813ZM10.087,9.212C10.321,8.896 10.5,8.55 10.625,8.175C10.75,7.8 10.813,7.404 10.813,6.988C10.813,5.929 10.442,5.033 9.7,4.3C8.958,3.558 8.058,3.188 7,3.188C6.583,3.188 6.188,3.25 5.813,3.375C5.446,3.492 5.104,3.662 4.787,3.888L10.087,9.212Z"
-            android:fillColor="@color/drop_icon_symbol_color"/>
+            android:fillColor="@color/drop_icon_reject_symbol_color"/>
     </group>
 </vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_bugreport.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_bugreport_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_bugreport.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_bugreport_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_download_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_download_m3.xml
new file mode 100644
index 000000000..25f074949
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_download_m3.xml
@@ -0,0 +1,27 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
+    <!-- fillColor will be set by tint color in the code. -->
+    <path
+        android:fillColor="@android:color/white"
+        android:pathData="M480,640L280,440L336,382L440,486L440,160L520,160L520,486L624,382L680,440L480,640ZM240,800Q207,800 183.5,776.5Q160,753 160,720L160,600L240,600L240,720Q240,720 240,720Q240,720 240,720L720,720Q720,720 720,720Q720,720 720,720L720,600L800,600L800,720Q800,753 776.5,776.5Q753,800 720,800L240,800Z"/>
+</vector>
+
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_recent.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_recent_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_recent.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_recent_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_smartphone_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_smartphone_m3.xml
new file mode 100644
index 000000000..11a664cbd
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_root_smartphone_m3.xml
@@ -0,0 +1,26 @@
+<!--
+Copyright (C) 2024 The Android Open Source Project
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
+    <!-- fillColor will be set by tint color in the code. -->
+    <path
+        android:fillColor="@android:color/white"
+        android:pathData="M280,920Q247,920 223.5,896.5Q200,873 200,840L200,120Q200,87 223.5,63.5Q247,40 280,40L680,40Q713,40 736.5,63.5Q760,87 760,120L760,840Q760,873 736.5,896.5Q713,920 680,920L280,920ZM280,800L280,840Q280,840 280,840Q280,840 280,840L680,840Q680,840 680,840Q680,840 680,840L680,800L280,800ZM280,720L680,720L680,240L280,240L280,720ZM280,160L680,160L680,120Q680,120 680,120Q680,120 680,120L280,120Q280,120 280,120Q280,120 280,120L280,160ZM280,160L280,120Q280,120 280,120Q280,120 280,120L280,120Q280,120 280,120Q280,120 280,120L280,160ZM280,800L280,800L280,840Q280,840 280,840Q280,840 280,840L280,840Q280,840 280,840Q280,840 280,840L280,800Z"/>
+</vector>
+
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sd_storage_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sd_storage_m3.xml
new file mode 100644
index 000000000..65a1b9e5d
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sd_storage_m3.xml
@@ -0,0 +1,26 @@
+<!--
+Copyright (C) 2024 The Android Open Source Project
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
+    <!-- fillColor will be set by tint color in the code. -->
+    <path
+        android:fillColor="@android:color/white"
+        android:pathData="M360,440L440,440L440,280L360,280L360,440ZM480,440L560,440L560,280L480,280L480,440ZM600,440L680,440L680,280L600,280L600,440ZM240,880Q207,880 183.5,856.5Q160,833 160,800L160,320L400,80L720,80Q753,80 776.5,103.5Q800,127 800,160L800,800Q800,833 776.5,856.5Q753,880 720,880L240,880ZM240,800L720,800Q720,800 720,800Q720,800 720,800L720,160Q720,160 720,160Q720,160 720,160L434,160L240,354L240,800Q240,800 240,800Q240,800 240,800ZM240,800Q240,800 240,800Q240,800 240,800L240,800L434,800L720,800Q720,800 720,800Q720,800 720,800L720,800Q720,800 720,800Q720,800 720,800L240,800Z"/>
+</vector>
+
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_search_file_type.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_search_file_type.xml
new file mode 100644
index 000000000..896c66e6f
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_search_file_type.xml
@@ -0,0 +1,29 @@
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<!--
+ The icon used for selecting file type in search options.
+ Source: fonts.google.com "draft" icon.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:autoMirrored="true"
+    android:viewportHeight="960"
+    android:viewportWidth="960">
+    <path
+        android:fillColor="?attr/colorPrimary"
+        android:pathData="M240,880Q207,880 183.5,856.5Q160,833 160,800L160,160Q160,127 183.5,103.5Q207,80 240,80L560,80L800,320L800,800Q800,833 776.5,856.5Q753,880 720,880L240,880ZM520,360L520,160L240,160Q240,160 240,160Q240,160 240,160L240,800Q240,800 240,800Q240,800 240,800L720,800Q720,800 720,800Q720,800 720,800L720,360L520,360ZM240,160L240,160L240,360L240,360L240,160L240,360L240,360L240,800Q240,800 240,800Q240,800 240,800L240,800Q240,800 240,800Q240,800 240,800L240,160Q240,160 240,160Q240,160 240,160Z" />
+</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_search_last_modified.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_search_last_modified.xml
new file mode 100644
index 000000000..3f743dbab
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_search_last_modified.xml
@@ -0,0 +1,28 @@
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<!--
+ The icon used for selecting last modified time in search options.
+ Source: fonts.google.com "calendar today" icon.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportHeight="960"
+    android:viewportWidth="960">
+    <path
+        android:fillColor="?attr/colorPrimary"
+        android:pathData="M200,880Q167,880 143.5,856.5Q120,833 120,800L120,240Q120,207 143.5,183.5Q167,160 200,160L240,160L240,80L320,80L320,160L640,160L640,80L720,80L720,160L760,160Q793,160 816.5,183.5Q840,207 840,240L840,800Q840,833 816.5,856.5Q793,880 760,880L200,880ZM200,800L760,800Q760,800 760,800Q760,800 760,800L760,400L200,400L200,800Q200,800 200,800Q200,800 200,800ZM200,320L760,320L760,240Q760,240 760,240Q760,240 760,240L200,240Q200,240 200,240Q200,240 200,240L200,320ZM200,320L200,240Q200,240 200,240Q200,240 200,240L200,240Q200,240 200,240Q200,240 200,240L200,320Z" />
+</vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_search_location.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_search_location.xml
new file mode 100644
index 000000000..caa9e5d0f
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_search_location.xml
@@ -0,0 +1,28 @@
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<!--
+ The icon used for selecting search location in search options.
+ Source: fonts.google.com "explore" icon.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportHeight="960"
+    android:viewportWidth="960">
+    <path
+        android:fillColor="?attr/colorPrimary"
+        android:pathData="M300,660L580,580L660,300L380,380L300,660ZM480,540Q455,540 437.5,522.5Q420,505 420,480Q420,455 437.5,437.5Q455,420 480,420Q505,420 522.5,437.5Q540,455 540,480Q540,505 522.5,522.5Q505,540 480,540ZM480,880Q397,880 324,848.5Q251,817 197,763Q143,709 111.5,636Q80,563 80,480Q80,397 111.5,324Q143,251 197,197Q251,143 324,111.5Q397,80 480,80Q563,80 636,111.5Q709,143 763,197Q817,251 848.5,324Q880,397 880,480Q880,563 848.5,636Q817,709 763,763Q709,817 636,848.5Q563,880 480,880ZM480,800Q613,800 706.5,706.5Q800,613 800,480Q800,347 706.5,253.5Q613,160 480,160Q347,160 253.5,253.5Q160,347 160,480Q160,613 253.5,706.5Q347,800 480,800ZM480,480Q480,480 480,480Q480,480 480,480Q480,480 480,480Q480,480 480,480Q480,480 480,480Q480,480 480,480Q480,480 480,480Q480,480 480,480Z" />
+</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow_m3.xml
similarity index 94%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow_m3.xml
index ec23152ab..fdaf29032 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow_m3.xml
@@ -16,7 +16,7 @@
   -->
 
 <rotate xmlns:android="http://schemas.android.com/apk/res/android"
-        android:drawable="@drawable/ic_sort_icon"
+    android:drawable="@drawable/ic_arrow_upward_m3"
         android:fromDegrees="0"
         android:toDegrees="180"
         android:pivotX="50%"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_icon.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_icon.xml
deleted file mode 100644
index 52a265729..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_icon.xml
+++ /dev/null
@@ -1,98 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!--
-    Copyright (C) 2024 The Android Open Source Project
-
-    Licensed under the Apache License, Version 2.0 (the "License");
-    you may not use this file except in compliance with the License.
-    You may obtain a copy of the License at
-
-         http://www.apache.org/licenses/LICENSE-2.0
-
-    Unless required by applicable law or agreed to in writing, software
-    distributed under the License is distributed on an "AS IS" BASIS,
-    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-    See the License for the specific language governing permissions and
-    limitations under the License.
-  -->
-<selector xmlns:android="http://schemas.android.com/apk/res/android">
-    <item
-        android:state_focused="true"
-        android:state_hovered="true">
-        <layer-list>
-            <item>
-                <shape
-                    android:background="?attr/colorSurfaceBright"
-                    android:shape="rectangle"
-                    android:tint="?attr/colorSecondaryContainer"
-                    android:tintMode="multiply">
-                    <corners android:radius="14dp" />
-                    <size
-                        android:width="28dp"
-                        android:height="32dp" />
-                    <solid android:color="?attr/colorSecondaryContainer" />
-                    <stroke
-                        android:width="@dimen/focus_ring_width"
-                        android:color="?attr/colorSecondary" />
-                </shape>
-            </item>
-            <item android:drawable="@drawable/ic_arrow_upward" />
-        </layer-list>
-    </item>
-    <item
-        android:state_focused="false"
-        android:state_hovered="true">
-        <layer-list>
-            <item>
-                <shape
-                    android:background="?attr/colorSurfaceBright"
-                    android:shape="rectangle"
-                    android:tint="?attr/colorSecondaryContainer"
-                    android:tintMode="multiply">
-                    <corners android:radius="14dp" />
-                    <size
-                        android:width="28dp"
-                        android:height="32dp" />
-                    <solid android:color="?attr/colorSecondaryContainer" />
-                </shape>
-            </item>
-            <item android:drawable="@drawable/ic_arrow_upward" />
-        </layer-list>
-    </item>
-    <item
-        android:state_focused="true"
-        android:state_hovered="false">
-        <layer-list>
-            <item>
-                <shape
-                    android:background="?attr/colorSurfaceBright"
-                    android:shape="rectangle">
-                    <corners android:radius="14dp" />
-                    <size
-                        android:width="28dp"
-                        android:height="32dp" />
-                    <solid android:color="?attr/colorSecondaryContainer" />
-                    <stroke
-                        android:width="@dimen/focus_ring_width"
-                        android:color="?attr/colorSecondary" />
-                </shape>
-            </item>
-            <item android:drawable="@drawable/ic_arrow_upward" />
-        </layer-list>
-    </item>
-    <item>
-        <layer-list>
-            <item>
-                <shape
-                    android:background="?attr/colorSurfaceBright"
-                    android:shape="rectangle">
-                    <corners android:radius="14dp" />
-                    <size
-                        android:width="28dp"
-                        android:height="32dp" />
-                    <solid android:color="?attr/colorSecondaryContainer" />
-                </shape>
-            </item>
-            <item android:drawable="@drawable/ic_arrow_upward" />
-        </layer-list>
-    </item>
-</selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_subdirectory_arrow.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_subdirectory_arrow_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_subdirectory_arrow.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_subdirectory_arrow_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_shortcut.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_shortcut_m3.xml
similarity index 95%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_shortcut.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_shortcut_m3.xml
index 6e53700f9..c16316665 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_shortcut.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_shortcut_m3.xml
@@ -16,7 +16,7 @@
   -->
 
 <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
-    <background android:drawable="@color/shortcut_background" />
+    <background android:drawable="@color/shortcut_background_m3" />
     <foreground>
         <inset android:inset="33%">
             <vector xmlns:android="http://schemas.android.com/apk/res/android"
@@ -25,7 +25,7 @@
                 android:viewportHeight="24"
                 android:viewportWidth="24">
                 <path
-                    android:fillColor="@color/shortcut_foreground"
+                    android:fillColor="@color/shortcut_foreground_m3"
                     android:pathData="M15 7v4h1v2h-3V5h2l-3,-4,-3 4h2v8H8v-2.07c.7,-.37 1.2,-1.08 1.2,-1.93 0,-1.21,-.99,-2.2,-2.2,-2.2,-1.21 0,-2.2.99,-2.2 2.2 0 .85.5 1.56 1.2 1.93V13c0 1.11.89 2 2 2h3v3.05c-.71.37,-1.2 1.1,-1.2 1.95 0 1.22.99 2.2 2.2 2.2 1.21 0 2.2,-.98 2.2,-2.2 0,-.85,-.49,-1.58,-1.2,-1.95V15h3c1.11 0 2,-.89 2,-2v-2h1V7h-4z"/>
             </vector>
         </inset>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_storage.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_storage.xml
deleted file mode 100644
index 6dde75108..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_storage.xml
+++ /dev/null
@@ -1,24 +0,0 @@
-<!--
-Copyright (C) 2024 The Android Open Source Project
-
-   Licensed under the Apache License, Version 2.0 (the "License");
-    you may not use this file except in compliance with the License.
-    You may obtain a copy of the License at
-
-         http://www.apache.org/licenses/LICENSE-2.0
-
-    Unless required by applicable law or agreed to in writing, software
-    distributed under the License is distributed on an "AS IS" BASIS,
-    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-    See the License for the specific language governing permissions and
-    limitations under the License.
--->
-<vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="24dp"
-        android:height="24dp"
-        android:viewportWidth="24.0"
-        android:viewportHeight="24.0">
-    <path
-        android:fillColor="?android:textColorSecondary"
-        android:pathData="M15 7v4h1v2h-3V5h2l-3,-4,-3 4h2v8H8v-2.07c.7,-.37 1.2,-1.08 1.2,-1.93 0,-1.21,-.99,-2.2,-2.2,-2.2,-1.21 0,-2.2.99,-2.2 2.2 0 .85.5 1.56 1.2 1.93V13c0 1.11.89 2 2 2h3v3.05c-.71.37,-1.2 1.1,-1.2 1.95 0 1.22.99 2.2 2.2 2.2 1.21 0 2.2,-.98 2.2,-2.2 0,-.85,-.49,-1.58,-1.2,-1.95V15h3c1.11 0 2,-.89 2,-2v-2h1V7h-4z"/>
-</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_storage_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_storage_m3.xml
new file mode 100644
index 000000000..5b4616ffc
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_usb_storage_m3.xml
@@ -0,0 +1,26 @@
+<!--
+Copyright (C) 2024 The Android Open Source Project
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
+    <!-- fillColor will be set by tint color in the code. -->
+    <path
+        android:fillColor="@android:color/white"
+        android:pathData="M480,880Q447,880 423.5,856.5Q400,833 400,800Q400,779 411,761Q422,743 440,732L440,640L320,640Q287,640 263.5,616.5Q240,593 240,560L240,468Q222,459 211,441Q200,423 200,400Q200,367 223.5,343.5Q247,320 280,320Q313,320 336.5,343.5Q360,367 360,400Q360,423 349,440Q338,457 320,468L320,560Q320,560 320,560Q320,560 320,560L440,560L440,240L360,240L480,80L600,240L520,240L520,560L640,560Q640,560 640,560Q640,560 640,560L640,480L600,480L600,320L760,320L760,480L720,480L720,560Q720,593 696.5,616.5Q673,640 640,640L520,640L520,732Q539,742 549.5,760Q560,778 560,800Q560,833 536.5,856.5Q513,880 480,880Z"/>
+</vector>
+
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_user_profile.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_user_profile_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_user_profile.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_user_profile_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out_m3.xml
similarity index 89%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out_m3.xml
index 9affe2bb9..a18d7a671 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out_m3.xml
@@ -18,8 +18,12 @@
         android:height="24dp"
         android:viewportWidth="960"
         android:viewportHeight="960">
+     <!--
+          White is unused here, the actual color is supplied in
+          doc_list_item_badge_icon_color as android:tint.
+     -->
     <path
-        android:fillColor="?attr/colorOnSurface"
+        android:fillColor="@android:color/white"
         android:pathData="M480,640Q555,640 607.5,587.5Q660,535 660,460Q660,385 607.5,332.5Q555,280 480,280Q405,280 352.5,332.5Q300,385 300,460Q300,535 352.5,587.5Q405,640 480,640ZM480,568Q435,568 403.5,536.5Q372,505 372,460Q372,415 403.5,383.5Q435,352 480,352Q525,352 556.5,383.5Q588,415 588,460Q588,505 556.5,536.5Q525,568 480,568ZM480,760Q334,760 214,678.5Q94,597 40,460Q94,323 214,241.5Q334,160 480,160Q626,160 746,241.5Q866,323 920,460Q866,597 746,678.5Q626,760 480,760ZM480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460ZM480,680Q593,680 687.5,620.5Q782,561 832,460Q782,359 687.5,299.5Q593,240 480,240Q367,240 272.5,299.5Q178,359 128,460Q178,561 272.5,620.5Q367,680 480,680Z" />
 </vector>
 
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/icon_check_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/icon_check_background.xml
new file mode 100644
index 000000000..36de8aa38
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/icon_check_background.xml
@@ -0,0 +1,27 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<!-- Draw a colorPrimary circle with a stroke that matches the width and colour of the thumbnail
+border (grid_item_thumbnail_width - grid_item_icon_width). The colorPrimary circle is necessary as
+the check icon has a checked-size hole which needs to appear colorPrimary. Since this icon is only
+shown on a selected state on non-PC devices, we do not need to handle non-selected states and we
+don't need to handle more complex PC states such as focused+hovered+selected.-->
+<shape xmlns:android="http://schemas.android.com/apk/res/android"
+    android:shape="oval">
+    <solid android:color="?attr/colorOnPrimary" />
+    <stroke
+        android:width="@dimen/icon_check_stroke_size"
+        android:color="?attr/colorPrimaryContainer" />
+</shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/inspector_separator.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/inspector_separator_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/inspector_separator.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/inspector_separator_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border_m3.xml
similarity index 93%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border_m3.xml
index 411085500..582acc852 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border_m3.xml
@@ -18,5 +18,5 @@
        android:shape="rectangle">
     <stroke
         android:width="2dp"
-        android:color="@color/item_doc_grid_border"/>
+        android:color="@color/item_doc_grid_border_m3"/>
 </shape>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border_rounded.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border_rounded_m3.xml
similarity index 87%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border_rounded.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border_rounded_m3.xml
index 249bda702..58c0d1651 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border_rounded.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/item_doc_grid_border_rounded_m3.xml
@@ -18,6 +18,6 @@
        android:shape="rectangle">
     <stroke
         android:width="2dp"
-        android:color="@color/item_doc_grid_border"/>
-    <corners android:radius="@dimen/grid_item_radius"/>
+        android:color="@color/item_doc_grid_border_m3"/>
+    <corners android:radius="?attr/shapeCornerSizeMedium"/>
 </shape>
diff --git a/res/xml/shortcuts.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/job_progress_badge.xml
similarity index 52%
rename from res/xml/shortcuts.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/job_progress_badge.xml
index 97180f555..f25608723 100644
--- a/res/xml/shortcuts.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/job_progress_badge.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="utf-8"?>
 <!--
-    Copyright (C) 2016 The Android Open Source Project
+    Copyright (C) 2025 The Android Open Source Project
 
     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
@@ -13,15 +13,12 @@
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-  -->
+-->
 
-<shortcuts xmlns:android="http://schemas.android.com/apk/res/android">
-    <shortcut
-        android:shortcutId="content://com.android.providers.media.documents/root/images_root"
-        android:icon="@drawable/ic_images_shortcut"
-        android:shortcutShortLabel="@string/images_shortcut_label" >
-        <intent
-            android:action="android.intent.action.VIEW"
-            android:data="content://com.android.providers.media.documents/root/images_root" />
-    </shortcut>
-</shortcuts>
\ No newline at end of file
+<shape xmlns:android="http://schemas.android.com/apk/res/android"
+    android:shape="oval">
+    <solid android:color="?attr/colorError" />
+    <stroke
+        android:color="?attr/colorSurfaceBright"
+        android:width="@dimen/job_progress_toolbar_badge_outline_width" />
+</shape>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/launcher_screen.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/launcher_screen_m3.xml
similarity index 66%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/launcher_screen.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/launcher_screen_m3.xml
index c0d814632..cad6f333d 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/launcher_screen.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/launcher_screen_m3.xml
@@ -1,9 +1,9 @@
 <?xml version="1.0" encoding="utf-8"?>
 <layer-list xmlns:android="http://schemas.android.com/apk/res/android" >
-  <item android:drawable="@android:color/white"/>
+  <item android:drawable="@color/app_background_color_m3"/>
 
   <item
-      android:drawable="@drawable/splash_screen"
+      android:drawable="@drawable/splash_screen_m3"
       android:height="150dp"
       android:width="150dp"
       android:gravity="center"/>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/launcher_screen_night.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/launcher_screen_night.xml
deleted file mode 100644
index 983c4977d..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/launcher_screen_night.xml
+++ /dev/null
@@ -1,11 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<layer-list xmlns:android="http://schemas.android.com/apk/res/android" >
-  <item android:drawable="@color/app_background_color"/>
-
-  <item
-      android:drawable="@drawable/splash_screen"
-      android:height="150dp"
-      android:width="150dp"
-      android:gravity="center"/>
-
-</layer-list>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_checker.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_checker_m3.xml
similarity index 86%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/list_checker.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/list_checker_m3.xml
index c3371b71a..9c76411d9 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_checker.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_checker_m3.xml
@@ -13,10 +13,11 @@
      See the License for the specific language governing permissions and
      limitations under the License.
 -->
+<!-- TODO(b/379776735): remove this file after use_material3 flag is launched. -->
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
     <item
         android:state_checked="true"
-        android:drawable="@drawable/ic_done"/>
+        android:drawable="@drawable/ic_done_m3"/>
     <item
         android:drawable="@android:color/transparent"/>
 </selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_divider.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_divider_m3.xml
similarity index 86%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/list_divider.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/list_divider_m3.xml
index ea48565c1..fa5caa7ef 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_divider.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_divider_m3.xml
@@ -14,9 +14,10 @@
      limitations under the License.
 -->
 
+<!-- TODO(b/379776735): remove this file use_material3 flag is launched. -->
 <shape xmlns:android="http://schemas.android.com/apk/res/android"
        android:tint="?android:attr/colorForeground">
-    <solid android:color="@color/list_divider_color" />
+    <solid android:color="@color/list_divider_color_m3" />
     <size
         android:height="1dp"
         android:width="1dp" />
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_background_m3.xml
similarity index 89%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_background_m3.xml
index 79c2eb1b7..22e2504dc 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_background_m3.xml
@@ -14,8 +14,6 @@
      limitations under the License.
 -->
 
-<!-- Use @color/list_item_selected_background_color instead of the "?attr/colorPrimaryContainer"
-     because the variable is exposed in overlayable.xml. -->
 <ripple xmlns:android="http://schemas.android.com/apk/res/android"
     android:color="@color/list_item_ripple_color">
 
@@ -37,8 +35,8 @@
                         android:right="@dimen/focus_ring_gap"
                         android:top="@dimen/focus_ring_gap">
                         <shape>
-                            <corners android:radius="@dimen/list_item_height" />
-                            <solid android:color="@color/list_item_selected_background_color" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
+                            <solid android:color="?attr/colorPrimaryContainer" />
                         </shape>
                     </item>
                     <item
@@ -47,13 +45,13 @@
                         android:right="@dimen/focus_ring_gap"
                         android:top="@dimen/focus_ring_gap">
                         <shape android:tint="?attr/colorOnPrimaryContainer">
-                            <corners android:radius="@dimen/list_item_height" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
                             <solid android:color="@color/overlay_hover_color_percentage" />
                         </shape>
                     </item>
                     <item>
                         <shape>
-                            <corners android:radius="@dimen/list_item_height" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
                             <stroke
                                 android:width="@dimen/focus_ring_width"
                                 android:color="?attr/colorSecondary" />
@@ -65,13 +63,13 @@
                 <layer-list>
                     <item>
                         <shape>
-                            <corners android:radius="@dimen/list_item_height" />
-                            <solid android:color="@color/list_item_selected_background_color" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
+                            <solid android:color="?attr/colorPrimaryContainer" />
                         </shape>
                     </item>
                     <item>
                         <shape android:tint="?attr/colorOnPrimaryContainer">
-                            <corners android:radius="@dimen/list_item_height" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
                             <solid android:color="@color/overlay_hover_color_percentage" />
                         </shape>
                     </item>
@@ -81,13 +79,13 @@
                 <layer-list>
                     <item>
                         <shape>
-                            <corners android:radius="@dimen/list_item_height" />
-                            <solid android:color="@color/list_item_selected_background_color" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
+                            <solid android:color="?attr/colorPrimaryContainer" />
                         </shape>
                     </item>
                     <item>
                         <shape android:tint="?attr/colorOnPrimaryContainer">
-                            <corners android:radius="@dimen/list_item_height" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
                             <solid android:color="@color/overlay_hover_color_percentage" />
                         </shape>
                     </item>
@@ -101,13 +99,13 @@
                         android:right="@dimen/focus_ring_gap"
                         android:top="@dimen/focus_ring_gap">
                         <shape>
-                            <corners android:radius="@dimen/list_item_height" />
-                            <solid android:color="@color/list_item_selected_background_color" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
+                            <solid android:color="?attr/colorPrimaryContainer" />
                         </shape>
                     </item>
                     <item>
                         <shape>
-                            <corners android:radius="@dimen/list_item_height" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
                             <stroke
                                 android:width="@dimen/focus_ring_width"
                                 android:color="?attr/colorSecondary" />
@@ -119,13 +117,13 @@
                 <layer-list>
                     <item>
                         <shape>
-                            <corners android:radius="@dimen/list_item_height" />
-                            <solid android:color="@color/list_item_selected_background_color" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
+                            <solid android:color="?attr/colorPrimaryContainer" />
                         </shape>
                     </item>
                     <item>
                         <shape android:tint="?attr/colorOnPrimaryContainer">
-                            <corners android:radius="@dimen/list_item_height" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
                             <solid android:color="@color/overlay_hover_color_percentage" />
                         </shape>
                     </item>
@@ -133,8 +131,8 @@
             </item>
             <item android:state_selected="true">
                 <shape>
-                    <corners android:radius="@dimen/list_item_height" />
-                    <solid android:color="@color/list_item_selected_background_color" />
+                    <corners android:radius="@dimen/list_item_height_m3" />
+                    <solid android:color="?attr/colorPrimaryContainer" />
                 </shape>
             </item>
 
@@ -147,13 +145,13 @@
                         android:right="@dimen/focus_ring_gap"
                         android:top="@dimen/focus_ring_gap">
                         <shape android:tint="?attr/colorOnSurface">
-                            <corners android:radius="@dimen/list_item_height" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
                             <solid android:color="@color/overlay_hover_color_percentage" />
                         </shape>
                     </item>
                     <item>
                         <shape>
-                            <corners android:radius="@dimen/list_item_height" />
+                            <corners android:radius="@dimen/list_item_height_m3" />
                             <stroke
                                 android:width="@dimen/focus_ring_width"
                                 android:color="?attr/colorSecondary" />
@@ -163,19 +161,19 @@
             </item>
             <item android:state_drag_hovered="true">
                 <shape android:tint="?attr/colorOnSurface">
-                    <corners android:radius="@dimen/list_item_height" />
+                    <corners android:radius="@dimen/list_item_height_m3" />
                     <solid android:color="@color/overlay_hover_color_percentage" />
                 </shape>
             </item>
             <item android:state_pressed="true">
                 <shape android:tint="?attr/colorOnSurface">
-                    <corners android:radius="@dimen/list_item_height" />
+                    <corners android:radius="@dimen/list_item_height_m3" />
                     <solid android:color="@color/overlay_hover_color_percentage" />
                 </shape>
             </item>
             <item android:state_focused="true">
                 <shape>
-                    <corners android:radius="@dimen/list_item_height" />
+                    <corners android:radius="@dimen/list_item_height_m3" />
                     <stroke
                         android:width="@dimen/focus_ring_width"
                         android:color="?attr/colorSecondary" />
@@ -183,7 +181,7 @@
             </item>
             <item android:state_hovered="true">
                 <shape android:tint="?attr/colorOnSurface">
-                    <corners android:radius="@dimen/list_item_height" />
+                    <corners android:radius="@dimen/list_item_height_m3" />
                     <solid android:color="@color/overlay_hover_color_percentage" />
                 </shape>
             </item>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_mask.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_mask.xml
index d1b7a3a94..59ded3e3d 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_mask.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_mask.xml
@@ -15,7 +15,7 @@
 -->
 
 <shape xmlns:android="http://schemas.android.com/apk/res/android">
-    <corners android:radius="@dimen/list_item_height" />
+    <corners android:radius="@dimen/list_item_height_m3" />
     <!-- The color here doesn't matter, it's just being used as a mask. -->
     <solid android:color="@android:color/white" />
 </shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel_m3.xml
similarity index 96%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel_m3.xml
index f1a72ad6e..7330fa46c 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel_m3.xml
@@ -25,10 +25,10 @@
             <stroke android:width="2dp" android:color="#3C4043" />
             <solid android:color="#5F6368" />
             <corners
-                android:topRightRadius="@dimen/material_round_radius"
-                android:topLeftRadius="@dimen/material_round_radius"
-                android:bottomRightRadius="@dimen/material_round_radius"
-                android:bottomLeftRadius="@dimen/material_round_radius"/>
+                android:topRightRadius="@dimen/material_round_radius_m3"
+                android:topLeftRadius="@dimen/material_round_radius_m3"
+                android:bottomRightRadius="@dimen/material_round_radius_m3"
+                android:bottomLeftRadius="@dimen/material_round_radius_m3"/>
         </shape>
     </item>
     <!-- Panel surface -->
@@ -38,10 +38,10 @@
             android:shape="rectangle"
             android:tint="?android:attr/colorBackgroundFloating">
             <corners
-                android:topRightRadius="@dimen/material_round_radius"
-                android:topLeftRadius="@dimen/material_round_radius"
-                android:bottomRightRadius="@dimen/material_round_radius"
-                android:bottomLeftRadius="@dimen/material_round_radius"/>
+                android:topRightRadius="@dimen/material_round_radius_m3"
+                android:topLeftRadius="@dimen/material_round_radius_m3"
+                android:bottomRightRadius="@dimen/material_round_radius_m3"
+                android:bottomLeftRadius="@dimen/material_round_radius_m3"/>
         </shape>
     </item>
 </layer-list>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_background.xml
deleted file mode 100644
index 7809766cd..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_background.xml
+++ /dev/null
@@ -1,23 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-
-<selector xmlns:android="http://schemas.android.com/apk/res/android">
-    <!-- By default the nav rail item has a grey background when it's focused, but we need the
-     background to be put on the icon inside, so we override the focus background color to be
-     transparent here.
-     -->
-    <item android:state_focused="true" android:drawable="@android:color/transparent" />
-</selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/peek_metadata_sheet_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/peek_metadata_sheet_background.xml
new file mode 100644
index 000000000..ef2e646bd
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/peek_metadata_sheet_background.xml
@@ -0,0 +1,19 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<shape xmlns:android="http://schemas.android.com/apk/res/android"
+    android:shape="rectangle">
+    <corners android:radius="@dimen/peek_metadata_sheet_corner_radius" />
+</shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/peek_no_preview_shape.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/peek_no_preview_shape.xml
new file mode 100644
index 000000000..d890a20cf
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/peek_no_preview_shape.xml
@@ -0,0 +1,23 @@
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="240dp"
+    android:height="240dp"
+    android:viewportHeight="240"
+    android:viewportWidth="240">
+    <path
+        android:fillColor="?attr/colorSurfaceDim"
+        android:pathData="M97.79,27.33C98.89,26.43 99.44,25.98 99.94,25.6C111.81,16.65 128.19,16.65 140.05,25.6C140.56,25.98 141.11,26.43 142.21,27.33C142.71,27.73 142.95,27.94 143.2,28.13C148.78,32.51 155.62,35 162.73,35.22C163.04,35.23 163.35,35.23 163.99,35.24C165.42,35.26 166.13,35.27 166.76,35.3C181.62,36.05 194.17,46.55 197.49,61.02C197.63,61.64 197.76,62.34 198.02,63.73C198.14,64.36 198.2,64.67 198.27,64.97C199.72,71.91 203.36,78.21 208.66,82.93C208.89,83.14 209.13,83.35 209.61,83.76C210.69,84.69 211.23,85.15 211.7,85.58C222.6,95.68 225.44,111.78 218.66,124.99C218.37,125.55 218.02,126.17 217.33,127.41C217.02,127.97 216.86,128.24 216.71,128.52C213.35,134.76 212.09,141.92 213.1,148.94C213.15,149.24 213.2,149.56 213.3,150.18C213.53,151.59 213.65,152.29 213.73,152.91C215.57,167.65 207.38,181.8 193.67,187.57C193.09,187.82 192.42,188.07 191.09,188.57C190.49,188.8 190.2,188.91 189.91,189.02C183.31,191.66 177.73,196.33 173.99,202.35C173.82,202.62 173.66,202.89 173.34,203.44C172.61,204.66 172.24,205.27 171.9,205.8C163.82,218.26 148.43,223.85 134.21,219.49C133.6,219.3 132.93,219.07 131.59,218.6C130.99,218.39 130.69,218.28 130.39,218.19C123.64,215.97 116.36,215.97 109.61,218.19C109.31,218.28 109.01,218.39 108.41,218.6C107.07,219.07 106.39,219.3 105.79,219.49C91.57,223.85 76.18,218.26 68.1,205.8C67.75,205.27 67.39,204.66 66.66,203.44C66.34,202.89 66.18,202.62 66.01,202.35C62.27,196.33 56.69,191.66 50.09,189.02C49.8,188.91 49.5,188.8 48.91,188.57C47.58,188.07 46.91,187.82 46.33,187.57C32.62,181.8 24.43,167.65 26.27,152.91C26.35,152.29 26.47,151.59 26.7,150.18C26.8,149.56 26.85,149.24 26.89,148.94C27.91,141.92 26.64,134.76 23.28,128.52C23.14,128.24 22.98,127.97 22.67,127.41C21.97,126.17 21.62,125.55 21.34,124.99C14.56,111.78 17.4,95.68 28.3,85.58C28.76,85.15 29.31,84.69 30.39,83.76C30.87,83.35 31.11,83.14 31.34,82.93C36.64,78.21 40.28,71.91 41.73,64.97C41.8,64.67 41.86,64.36 41.97,63.73C42.24,62.34 42.37,61.64 42.51,61.02C45.83,46.55 58.38,36.05 73.24,35.3C73.87,35.27 74.58,35.26 76.01,35.24C76.64,35.23 76.96,35.23 77.27,35.22C84.37,35 91.22,32.51 96.8,28.13C97.05,27.94 97.29,27.73 97.79,27.33Z" />
+</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed_m3.xml
similarity index 97%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed_m3.xml
index 7a0a5e555..3b96d9776 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed_m3.xml
@@ -19,7 +19,7 @@
      draws the whole height of the progress bar instead having blank space above and below the
      bar. -->
 <animated-vector xmlns:android="http://schemas.android.com/apk/res/android"
-    android:drawable="@drawable/vector_drawable_progress_indeterminate_horizontal_trimmed" >
+    android:drawable="@drawable/vector_drawable_progress_indeterminate_horizontal_trimmed_m3" >
     <target
         android:name="rect2_grp"
         android:animation="@anim/progress_indeterminate_horizontal_rect2" />
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_background_m3.xml
similarity index 98%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_background_m3.xml
index 236b92179..783fac597 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_background_m3.xml
@@ -23,7 +23,7 @@
          need to explicitly apply the drawable if the other items also need this mask. -->
     <item
         android:id="@android:id/mask"
-        android:drawable="@drawable/root_list_selector"/>
+        android:drawable="@drawable/root_item_selector"/>
 
     <item>
         <selector>
@@ -93,7 +93,7 @@
                     </item>
                 </layer-list>
             </item>
-            <item android:state_activated="true" android:drawable="@drawable/root_list_selector"/>
+            <item android:state_activated="true" android:drawable="@drawable/root_item_selector"/>
 
             <!-- Unselected. -->
             <item app:state_highlighted="true">
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_list_selector.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_selector.xml
similarity index 99%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/root_list_selector.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_selector.xml
index 5bb3d6afe..42ccfcbe4 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_list_selector.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_selector.xml
@@ -18,4 +18,4 @@
     <corners android:radius="@dimen/drawer_item_height"/>
     <!-- The color here is used as activated color in root_item_background.xml. -->
     <solid android:color="?attr/colorSecondaryContainer"/>
-</shape>
\ No newline at end of file
+</shape>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/gradient_actionbar_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_list_selector_m3.xml
similarity index 72%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/gradient_actionbar_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/root_list_selector_m3.xml
index e3ace24a6..e1e9f489d 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/gradient_actionbar_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_list_selector_m3.xml
@@ -13,11 +13,9 @@
      See the License for the specific language governing permissions and
      limitations under the License.
 -->
+<!-- TODO(b/379776735): Remove this after use_material3 flag is launched. -->
 <shape xmlns:android="http://schemas.android.com/apk/res/android">
-    <gradient
-        android:startColor="@color/tool_bar_gradient_max"
-        android:endColor="@android:color/transparent"
-        android:angle="270"
-        android:type="linear" >
-    </gradient>
+    <corners android:radius="@dimen/drawer_item_height"/>
+    <!-- The color here is used as activated color in root_item_background.xml. -->
+    <solid android:color="?attr/colorSecondaryContainer"/>
 </shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/search_bar_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/search_bar_background_m3.xml
similarity index 88%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/search_bar_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/search_bar_background_m3.xml
index 8ad306c06..11f6aa755 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/search_bar_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/search_bar_background_m3.xml
@@ -20,11 +20,11 @@
         </shape>
     </item>
     <item
-        android:start="@dimen/search_bar_background_margin_start"
-        android:end="@dimen/search_bar_background_margin_end">
+        android:start="@dimen/search_bar_background_margin_start_m3"
+        android:end="@dimen/search_bar_background_margin_end_m3">
         <shape android:shape="rectangle">
             <solid android:color="?android:attr/colorBackgroundFloating"/>
-            <corners android:radius="@dimen/search_bar_radius"/>
+            <corners android:radius="@dimen/search_bar_radius_m3"/>
         </shape>
     </item>
 </layer-list>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/selection_circle.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/selection_circle.xml
new file mode 100644
index 000000000..b591ab00e
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/selection_circle.xml
@@ -0,0 +1,44 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<!-- Draw a 5% black circle with a white stroke. Simulate a shadow by drawing 20% black ring at a
+     1dp offset from the circle. -->
+<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
+    <!-- The 20% black ring acting as a shadow. -->
+    <item android:bottom="@dimen/selection_circle_shadow_bottom_offset"
+        android:left="@dimen/selection_circle_shadow_left_offset"
+        android:right="@dimen/selection_circle_shadow_right_offset"
+        android:top="@dimen/selection_circle_shadow_top_offset">
+        <shape android:shape="oval">
+            <solid android:color="@android:color/transparent" />
+            <stroke
+                android:width="@dimen/selection_stroke_size"
+                android:color="@color/selection_shadow_black" />
+        </shape>
+    </item>
+    <!-- The 5% black circle with a 2 dp white stroke. -->
+    <item
+        android:bottom="@dimen/selection_circle_offset"
+        android:left="@dimen/selection_circle_offset"
+        android:right="@dimen/selection_circle_offset"
+        android:top="@dimen/selection_circle_offset">
+        <shape android:shape="oval">
+            <solid android:color="@color/selection_circle_black"/>
+            <stroke
+                android:width="@dimen/selection_stroke_size"
+                android:color="@android:color/white" />
+        </shape>
+    </item>
+</layer-list>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/share_off.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/share_off_m3.xml
similarity index 97%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/share_off.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/share_off_m3.xml
index e5c0f95ae..aa618d0a6 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/share_off.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/share_off_m3.xml
@@ -22,5 +22,5 @@
     <path
         android:pathData="M19.7225,20.9245L21.2011,22.4031L22.4032,21.201L2.8022,1.6L1.6001,2.8021L8.1265,9.3284L7.64,9.612C7.1,9.112 6.39,8.802 5.6,8.802C3.94,8.802 2.6,10.142 2.6,11.802C2.6,13.462 3.94,14.802 5.6,14.802C6.39,14.802 7.1,14.492 7.64,13.992L14.69,18.112C14.64,18.332 14.6,18.562 14.6,18.802C14.6,20.462 15.94,21.802 17.6,21.802C18.43,21.802 19.18,21.467 19.7225,20.9245ZM16.8938,18.0958L18.3063,19.5083C18.125,19.6895 17.875,19.802 17.6,19.802C17.05,19.802 16.6,19.352 16.6,18.802C16.6,18.527 16.7125,18.277 16.8938,18.0958ZM15.1871,16.3891L9.3881,10.5901L8.51,11.102C8.56,11.332 8.6,11.562 8.6,11.802C8.6,12.042 8.56,12.272 8.51,12.502L15.1871,16.3891ZM15.56,6.992L12.4382,8.8119L11.1766,7.5503L14.69,5.502C14.64,5.282 14.6,5.042 14.6,4.802C14.6,3.142 15.94,1.802 17.6,1.802C19.26,1.802 20.6,3.142 20.6,4.802C20.6,6.462 19.26,7.802 17.6,7.802C16.81,7.802 16.09,7.492 15.56,6.992ZM18.6,4.802C18.6,4.252 18.15,3.802 17.6,3.802C17.05,3.802 16.6,4.252 16.6,4.802C16.6,5.352 17.05,5.802 17.6,5.802C18.15,5.802 18.6,5.352 18.6,4.802ZM5.6,12.802C5.05,12.802 4.6,12.352 4.6,11.802C4.6,11.252 5.05,10.802 5.6,10.802C6.15,10.802 6.6,11.252 6.6,11.802C6.6,12.352 6.15,12.802 5.6,12.802Z"
         android:fillType="evenOdd"
-        android:fillColor="@color/error_image_color"/>
+        android:fillColor="@color/error_image_color_m3"/>
 </vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_icon_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_icon_background.xml
new file mode 100644
index 000000000..1caf932ca
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_icon_background.xml
@@ -0,0 +1,73 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2025 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+  -->
+
+<ripple xmlns:android="http://schemas.android.com/apk/res/android"
+    android:color="@color/sort_icon_ripple_color">
+
+    <item android:id="@android:id/mask">
+        <shape>
+            <corners android:radius="@dimen/doc_header_sort_icon_radius" />
+            <!-- The color here doesn't matter, it's just being used as a mask. -->
+            <solid android:color="@android:color/white" />
+        </shape>
+    </item>
+
+    <item>
+        <selector>
+            <item android:state_focused="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/doc_header_sort_icon_radius" />
+                            <solid android:color="?attr/colorSurfaceDim" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/doc_header_sort_icon_radius" />
+                            <stroke
+                                android:width="@dimen/focus_ring_width"
+                                android:color="?attr/colorSecondary" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_hovered="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/doc_header_sort_icon_radius" />
+                            <solid android:color="?attr/colorSurfaceDim" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="@color/overlay_hover_color_percentage">
+                            <corners android:radius="@dimen/doc_header_sort_icon_radius" />
+                            <solid android:color="?attr/colorSurfaceDim" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item>
+                <shape>
+                    <corners android:radius="@dimen/doc_header_sort_icon_radius" />
+                    <solid android:color="?attr/colorSurfaceDim" />
+                </shape>
+            </item>
+        </selector>
+    </item>
+</ripple>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_list_item_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_list_item_background.xml
new file mode 100644
index 000000000..ed68010c8
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_list_item_background.xml
@@ -0,0 +1,47 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<ripple
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:color="@color/menu_item_ripple_color">
+
+    <item>
+        <selector>
+            <item android:state_pressed="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+            <item android:state_selected="true">
+                <shape>
+                    <stroke
+                        android:width="@dimen/focus_ring_width"
+                        android:color="?attr/colorSecondary" />
+                </shape>
+            </item>
+            <item android:state_hovered="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+
+            <!-- Default: use the container background. -->
+            <item>
+                <color android:color="@android:color/transparent"/>
+            </item>
+        </selector>
+    </item>
+</ripple>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_widget_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_widget_background_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_widget_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_widget_background_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/splash_screen.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/splash_screen_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/splash_screen.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/splash_screen_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/tab_border_rounded.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/tab_border_rounded_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/tab_border_rounded.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/tab_border_rounded_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/vector_drawable_progress_indeterminate_horizontal_trimmed.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/vector_drawable_progress_indeterminate_horizontal_trimmed_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/vector_drawable_progress_indeterminate_horizontal_trimmed.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/vector_drawable_progress_indeterminate_horizontal_trimmed_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/work_off.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/work_off_m3.xml
similarity index 95%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/work_off.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/work_off_m3.xml
index 500a62fbd..7cb2d9ad6 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/work_off.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/work_off_m3.xml
@@ -20,7 +20,7 @@
         android:viewportWidth="24"
         android:viewportHeight="24">
     <path
-        android:fillColor="@color/error_image_color"
+        android:fillColor="@color/error_image_color_m3"
         android:pathData="M20,6h-4L16,4c0,-1.11 -0.89,-2 -2,-2h-4c-1.11,0 -2,0.89 -2,2v1.17L10.83,8L20,8v9.17l1.98,1.98c0,-0.05 0.02,-0.1 0.02,-0.16L22,8c0,-1.11 -0.89,-2 -2,-2zM14,6h-4L10,4h4v2zM19,19L8,8 6,6 2.81,2.81 1.39,4.22 3.3,6.13C2.54,6.41 2.01,7.14 2.01,8L2,19c0,1.11 0.89,2 2,2h14.17l1.61,1.61 1.41,-1.41 -0.37,-0.37L19,19zM4,19L4,8h1.17l11,11L4,19z"/>
 </vector>
 
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp-h600dp/dialog_sorting_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp-h600dp/dialog_sorting_m3.xml
new file mode 100644
index 000000000..a5fcd7e41
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp-h600dp/dialog_sorting_m3.xml
@@ -0,0 +1,23 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<!-- We want a fixed width for medium/expanded screen. -->
+<ListView xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/sorting_dialog_list"
+    android:layout_width="@dimen/bottom_sheet_dialog_width"
+    android:layout_height="wrap_content"
+    android:paddingTop="@dimen/bottom_sheet_dialog_padding_top"
+    android:paddingBottom="@dimen/bottom_sheet_dialog_padding_bottom"/>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp/fragment_save_cancel_button.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp-h600dp/fragment_save_cancel_button.xml
similarity index 86%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp/fragment_save_cancel_button.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp-h600dp/fragment_save_cancel_button.xml
index 93245946c..49175ba27 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp/fragment_save_cancel_button.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp-h600dp/fragment_save_cancel_button.xml
@@ -18,9 +18,11 @@
     xmlns:app="http://schemas.android.com/apk/res-auto"
     android:id="@android:id/button2"
     style="@style/MaterialTonalButton"
-    app:cornerRadius="@dimen/button_corner_radius"
+    app:cornerRadius="@dimen/button_corner_radius_m3"
     android:layout_width="wrap_content"
     android:layout_height="wrap_content"
+    android:layout_marginBottom="@dimen/picker_saver_button_gap"
     android:layout_marginStart="@dimen/picker_saver_button_gap"
+    android:layout_marginTop="@dimen/picker_saver_button_gap"
     android:layout_marginEnd="@dimen/picker_saver_button_gap"
     android:text="@android:string/cancel"/>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp-h600dp/column_headers_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp-h600dp/column_headers_m3.xml
new file mode 100644
index 000000000..9592ba9d2
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp-h600dp/column_headers_m3.xml
@@ -0,0 +1,117 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2024 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+
+<!-- The 2 placeholder views here are for vertical alignment purpose, in the file row it uses
+     ratio-based layout for Name/Type/Size/Date columns but excluding the thumbnail icon and
+     the preview icon. In order to make the header and row are vertically aligned, we need to
+     use placeholder for thumbnail icon and preview icon and then do the ratio-based layout
+     for table headers.
+ -->
+<LinearLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/table_header"
+    android:orientation="horizontal"
+    android:layout_width="match_parent"
+    android:layout_height="@dimen/doc_header_height_m3"
+    android:baselineAligned="false"
+    android:gravity="center_vertical"
+    android:paddingStart="@dimen/main_container_padding_start"
+    android:paddingEnd="@dimen/main_container_padding_end"
+    android:visibility="gone">
+
+    <!-- Column headers -->
+    <com.android.documentsui.sorting.HeaderCell
+        android:id="@android:id/title"
+        android:layout_width="0dp"
+        android:layout_height="match_parent"
+        android:layout_weight="0.4"
+        android:layout_marginEnd="12dp"
+        android:clickable="true"
+        android:focusable="false"
+        android:gravity="center_vertical"
+        android:orientation="horizontal"
+        android:animateLayoutChanges="true">
+
+        <include layout="@layout/shared_cell_content_m3" />
+    </com.android.documentsui.sorting.HeaderCell>
+
+    <com.android.documentsui.sorting.HeaderCell
+        android:id="@android:id/summary"
+        android:layout_width="0dp"
+        android:layout_height="match_parent"
+        android:layout_weight="0"
+        android:layout_marginEnd="0dp"
+        android:clickable="true"
+        android:focusable="false"
+        android:gravity="center_vertical"
+        android:orientation="horizontal"
+        android:animateLayoutChanges="true">
+
+        <include layout="@layout/shared_cell_content_m3" />
+    </com.android.documentsui.sorting.HeaderCell>
+
+    <com.android.documentsui.sorting.HeaderCell
+        android:id="@+id/file_type"
+        android:layout_width="0dp"
+        android:layout_height="match_parent"
+        android:layout_weight="0.2"
+        android:clickable="true"
+        android:focusable="false"
+        android:gravity="center_vertical"
+        android:orientation="horizontal"
+        android:animateLayoutChanges="true">
+
+        <include layout="@layout/shared_cell_content_m3" />
+    </com.android.documentsui.sorting.HeaderCell>
+
+    <com.android.documentsui.sorting.HeaderCell
+        android:id="@+id/size"
+        android:layout_width="0dp"
+        android:layout_height="match_parent"
+        android:layout_weight="0.2"
+        android:clickable="true"
+        android:focusable="false"
+        android:gravity="center_vertical"
+        android:orientation="horizontal"
+        android:animateLayoutChanges="true">
+
+        <include layout="@layout/shared_cell_content_m3" />
+    </com.android.documentsui.sorting.HeaderCell>
+
+    <com.android.documentsui.sorting.HeaderCell
+        android:id="@+id/date"
+        android:layout_width="0dp"
+        android:layout_height="match_parent"
+        android:layout_weight="0.2"
+        android:clickable="true"
+        android:focusable="false"
+        android:gravity="center_vertical"
+        android:orientation="horizontal"
+        android:animateLayoutChanges="true">
+
+        <include layout="@layout/shared_cell_content_m3" />
+    </com.android.documentsui.sorting.HeaderCell>
+
+    <!-- Placeholder for preview icon in picker mode, have the same size as @id/preview_icon in
+         item_doc_list.xml, aim to align the file row columns with the able header columns.
+     -->
+    <View
+        android:id="@+id/preview_icon_placeholder"
+        android:layout_width="@dimen/list_item_icon_size"
+        android:layout_height="@dimen/list_item_icon_size"
+        android:layout_marginEnd="@dimen/list_item_icon_margin_end" />
+</LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp-h600dp/item_doc_list_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp-h600dp/item_doc_list_m3.xml
new file mode 100644
index 000000000..056c107f5
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp-h600dp/item_doc_list_m3.xml
@@ -0,0 +1,146 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content"
+    android:background="@drawable/list_item_background_m3"
+    android:clickable="true"
+    android:focusable="true"
+    android:orientation="horizontal"
+    android:baselineAligned="false"
+    android:gravity="center_vertical"
+    android:minHeight="@dimen/list_item_height_m3"
+    android:paddingStart="@dimen/list_item_padding_start"
+    android:paddingEnd="@dimen/list_item_padding_end"
+    android:paddingVertical="@dimen/list_item_padding_vertical">
+
+    <LinearLayout
+        android:layout_width="0dp"
+        android:layout_height="wrap_content"
+        android:layout_weight="0.4"
+        android:layout_marginEnd="12dp"
+        android:orientation="horizontal">
+
+        <FrameLayout
+            android:id="@+id/icon"
+            android:pointerIcon="hand"
+            android:layout_width="@dimen/list_item_icon_size"
+            android:layout_height="@dimen/list_item_icon_size"
+            android:layout_marginEnd="@dimen/list_item_icon_margin_end">
+
+            <com.google.android.material.card.MaterialCardView
+                android:layout_width="match_parent"
+                android:layout_height="match_parent"
+                style="@style/ListThumbnailCardViewStyle">
+
+                <ImageView
+                    android:id="@+id/icon_mime"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:contentDescription="@null"
+                    android:scaleType="centerInside" />
+
+                <com.google.android.material.imageview.ShapeableImageView
+                    android:id="@+id/icon_thumb"
+                    android:layout_width="match_parent"
+                    android:layout_height="match_parent"
+                    android:layout_gravity="center"
+                    android:contentDescription="@null"
+                    android:scaleType="centerCrop"
+                    style="@style/ListThumbnailImageViewStyle"/>
+
+                <ImageView
+                    android:id="@+id/icon_check"
+                    android:layout_width="@dimen/check_icon_size_m3"
+                    android:layout_height="@dimen/check_icon_size_m3"
+                    android:layout_gravity="center"
+                    android:alpha="0"
+                    android:contentDescription="@null"
+                    android:scaleType="fitCenter"
+                    android:src="@drawable/ic_check_circle_m3" />
+
+            </com.google.android.material.card.MaterialCardView>
+
+        </FrameLayout>
+
+        <ImageView
+            android:id="@+id/icon_profile_badge"
+            android:layout_height="@dimen/briefcase_icon_size_m3"
+            android:layout_width="@dimen/briefcase_icon_size_m3"
+            android:layout_marginEnd="@dimen/briefcase_icon_margin_m3"
+            android:layout_gravity="center_vertical"
+            android:src="@drawable/ic_briefcase_m3"
+            android:tint="@color/briefcase_icon_color"
+            android:contentDescription="@string/a11y_work"/>
+
+        <com.google.android.material.textview.MaterialTextView
+            android:id="@android:id/title"
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            android:layout_gravity="center_vertical"
+            android:ellipsize="middle"
+            android:singleLine="true"
+            android:textAlignment="viewStart"
+            android:textAppearance="@style/FileItemLabelText"/>
+
+    </LinearLayout>
+
+    <com.google.android.material.textview.MaterialTextView
+        android:id="@+id/file_type"
+        android:layout_width="0dp"
+        android:layout_height="wrap_content"
+        android:layout_weight="0.2"
+        android:textAlignment="viewStart"
+        style="@style/FileItemLabelStyle"/>
+
+    <com.google.android.material.textview.MaterialTextView
+        android:id="@+id/size"
+        android:layout_width="0dp"
+        android:layout_height="wrap_content"
+        android:layout_weight="0.2"
+        android:textAlignment="viewStart"
+        style="@style/FileItemLabelStyle"/>
+
+    <com.google.android.material.textview.MaterialTextView
+        android:id="@+id/date"
+        android:layout_width="0dp"
+        android:layout_height="wrap_content"
+        android:layout_weight="0.2"
+        android:textAlignment="viewStart"
+        style="@style/FileItemLabelStyle"/>
+
+    <FrameLayout
+        android:id="@+id/preview_icon"
+        android:layout_width="@dimen/list_item_icon_size"
+        android:layout_height="@dimen/list_item_icon_size"
+        android:layout_gravity="center"
+        android:layout_marginEnd="@dimen/list_item_icon_margin_end"
+        android:focusable="true">
+
+        <ImageView
+            android:layout_width="@dimen/check_icon_size_m3"
+            android:layout_height="@dimen/check_icon_size_m3"
+            android:layout_gravity="center"
+            android:scaleType="fitCenter"
+            android:tint="@color/doc_list_item_badge_icon_color"
+            android:src="@drawable/ic_zoom_out_m3"/>
+
+    </FrameLayout>
+
+</LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/column_headers.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/column_headers.xml
deleted file mode 100644
index dcd3283b4..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/column_headers.xml
+++ /dev/null
@@ -1,129 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!--
-    Copyright (C) 2024 The Android Open Source Project
-
-    Licensed under the Apache License, Version 2.0 (the "License");
-    you may not use this file except in compliance with the License.
-    You may obtain a copy of the License at
-
-         http://www.apache.org/licenses/LICENSE-2.0
-
-    Unless required by applicable law or agreed to in writing, software
-    distributed under the License is distributed on an "AS IS" BASIS,
-    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-    See the License for the specific language governing permissions and
-    limitations under the License.
--->
-
-<!-- The 2 placeholder views here are for vertical alignment purpose, in the file row it uses
-     ratio-based layout for Name/Type/Size/Date columns but excluding the thumbnail icon and
-     the preview icon. In order to make the header and row are vertically aligned, we need to
-     use placeholder for thumbnail icon and preview icon and then do the ratio-based layout
-     for table headers.
- -->
-<LinearLayout
-    xmlns:android="http://schemas.android.com/apk/res/android"
-    android:id="@+id/table_header"
-    android:orientation="horizontal"
-    android:layout_width="match_parent"
-    android:layout_height="@dimen/doc_header_height"
-    android:baselineAligned="false"
-    android:gravity="center_vertical"
-    android:paddingStart="@dimen/table_header_padding_start"
-    android:paddingEnd="@dimen/table_header_padding_end"
-    android:visibility="gone">
-    <!-- Placeholder for MIME/thumbnail icon -->
-    <View
-        android:layout_width="@dimen/list_item_icon_size"
-        android:layout_height="@dimen/list_item_icon_size"
-        android:layout_gravity="center_vertical"
-        android:layout_marginEnd="@dimen/list_item_icon_margin_end"
-        android:layout_marginStart="0dp"/>
-
-    <!-- Column headers -->
-    <LinearLayout
-        android:layout_width="0dp"
-        android:layout_height="match_parent"
-        android:layout_weight="1"
-        android:orientation="horizontal">
-
-        <com.android.documentsui.sorting.HeaderCell
-            android:id="@android:id/title"
-            android:layout_width="0dp"
-            android:layout_height="match_parent"
-            android:layout_weight="0.4"
-            android:layout_marginEnd="12dp"
-            android:clickable="true"
-            android:focusable="false"
-            android:gravity="center_vertical"
-            android:orientation="horizontal"
-            android:animateLayoutChanges="true">
-
-            <include layout="@layout/shared_cell_content" />
-        </com.android.documentsui.sorting.HeaderCell>
-
-        <com.android.documentsui.sorting.HeaderCell
-            android:id="@android:id/summary"
-            android:layout_width="0dp"
-            android:layout_height="match_parent"
-            android:layout_weight="0"
-            android:layout_marginEnd="0dp"
-            android:clickable="true"
-            android:focusable="false"
-            android:gravity="center_vertical"
-            android:orientation="horizontal"
-            android:animateLayoutChanges="true">
-
-            <include layout="@layout/shared_cell_content" />
-        </com.android.documentsui.sorting.HeaderCell>
-
-        <com.android.documentsui.sorting.HeaderCell
-            android:id="@+id/file_type"
-            android:layout_width="0dp"
-            android:layout_height="match_parent"
-            android:layout_weight="0.2"
-            android:clickable="true"
-            android:focusable="false"
-            android:gravity="center_vertical"
-            android:orientation="horizontal"
-            android:animateLayoutChanges="true">
-
-            <include layout="@layout/shared_cell_content" />
-        </com.android.documentsui.sorting.HeaderCell>
-
-        <com.android.documentsui.sorting.HeaderCell
-            android:id="@+id/size"
-            android:layout_width="0dp"
-            android:layout_height="match_parent"
-            android:layout_weight="0.2"
-            android:clickable="true"
-            android:focusable="false"
-            android:gravity="center_vertical"
-            android:orientation="horizontal"
-            android:animateLayoutChanges="true">
-
-            <include layout="@layout/shared_cell_content" />
-        </com.android.documentsui.sorting.HeaderCell>
-
-        <com.android.documentsui.sorting.HeaderCell
-            android:id="@+id/date"
-            android:layout_width="0dp"
-            android:layout_height="match_parent"
-            android:layout_weight="0.2"
-            android:clickable="true"
-            android:focusable="false"
-            android:gravity="center_vertical"
-            android:orientation="horizontal"
-            android:animateLayoutChanges="true">
-
-            <include layout="@layout/shared_cell_content" />
-        </com.android.documentsui.sorting.HeaderCell>
-    </LinearLayout>
-
-    <!-- Placeholder for preview icon in picker mode -->
-    <View
-        android:id="@+id/preview_icon_placeholder"
-        android:layout_width="@dimen/list_item_icon_size"
-        android:layout_height="@dimen/list_item_icon_size"
-        android:layout_marginEnd="@dimen/list_item_icon_margin_end" />
-</LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/item_doc_list.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/item_doc_list.xml
deleted file mode 100644
index 09657d01a..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/item_doc_list.xml
+++ /dev/null
@@ -1,164 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!--
-     Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-
-<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:app="http://schemas.android.com/apk/res-auto"
-    android:layout_width="match_parent"
-    android:layout_height="wrap_content"
-    android:background="@drawable/list_item_background"
-    android:clickable="true"
-    android:focusable="true"
-    android:orientation="horizontal" >
-
-    <LinearLayout
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:baselineAligned="false"
-        android:gravity="center_vertical"
-        android:minHeight="@dimen/list_item_height"
-        android:orientation="horizontal"
-        android:paddingStart="@dimen/list_item_padding_start"
-        android:paddingEnd="@dimen/list_item_padding_end"
-        android:paddingVertical="@dimen/list_item_padding_vertical">
-
-        <FrameLayout
-            android:id="@+id/icon"
-            android:pointerIcon="hand"
-            android:layout_width="@dimen/list_item_icon_size"
-            android:layout_height="@dimen/list_item_icon_size"
-            android:layout_marginEnd="@dimen/list_item_icon_margin_end">
-
-            <!-- stroke width will be controlled dynamically in the code. -->
-            <com.google.android.material.card.MaterialCardView
-                android:id="@+id/icon_wrapper"
-                app:cardElevation="0dp"
-                android:layout_width="match_parent"
-                android:layout_height="match_parent"
-                app:cardBackgroundColor="?attr/colorSurfaceContainerLowest"
-                app:strokeColor="?attr/colorSecondaryContainer"
-                app:strokeWidth="0dp">
-
-                <ImageView
-                    android:id="@+id/icon_mime"
-                    android:layout_width="wrap_content"
-                    android:layout_height="wrap_content"
-                    android:layout_gravity="center"
-                    android:contentDescription="@null"
-                    android:scaleType="centerInside" />
-
-                <ImageView
-                    android:id="@+id/icon_thumb"
-                    android:layout_width="match_parent"
-                    android:layout_height="match_parent"
-                    android:layout_gravity="center"
-                    android:contentDescription="@null"
-                    android:scaleType="centerCrop" />
-
-                <ImageView
-                    android:id="@+id/icon_check"
-                    android:layout_width="@dimen/check_icon_size"
-                    android:layout_height="@dimen/check_icon_size"
-                    android:layout_gravity="center"
-                    android:alpha="0"
-                    android:contentDescription="@null"
-                    android:scaleType="fitCenter"
-                    android:src="@drawable/ic_check_circle" />
-
-            </com.google.android.material.card.MaterialCardView>
-
-        </FrameLayout>
-
-        <!-- This is the one special case where we want baseline alignment! -->
-
-        <LinearLayout
-            android:layout_width="0dp"
-            android:layout_height="wrap_content"
-            android:layout_weight="1"
-            android:orientation="horizontal" >
-
-            <LinearLayout
-                android:layout_width="0dp"
-                android:layout_height="wrap_content"
-                android:layout_weight="0.4"
-                android:layout_marginEnd="12dp"
-                android:orientation="horizontal">
-
-                <ImageView
-                    android:id="@+id/icon_profile_badge"
-                    android:layout_height="@dimen/briefcase_icon_size"
-                    android:layout_width="@dimen/briefcase_icon_size"
-                    android:layout_marginEnd="@dimen/briefcase_icon_margin"
-                    android:layout_gravity="center_vertical"
-                    android:src="@drawable/ic_briefcase"
-                    android:tint="@color/doc_list_item_badge_icon_color"
-                    android:contentDescription="@string/a11y_work"/>
-
-                <TextView
-                    android:id="@android:id/title"
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:ellipsize="end"
-                    android:singleLine="true"
-                    android:textAlignment="viewStart"
-                    android:textAppearance="@style/FileItemLabelText"/>
-            </LinearLayout>
-
-            <TextView
-                android:id="@+id/file_type"
-                android:layout_width="0dp"
-                android:layout_height="wrap_content"
-                android:layout_weight="0.2"
-                android:textAlignment="viewStart"
-                style="@style/FileItemLabelStyle"/>
-
-            <TextView
-                android:id="@+id/size"
-                android:layout_width="0dp"
-                android:layout_height="wrap_content"
-                android:layout_weight="0.2"
-                android:textAlignment="viewStart"
-                style="@style/FileItemLabelStyle"/>
-
-            <TextView
-                android:id="@+id/date"
-                android:layout_width="0dp"
-                android:layout_height="wrap_content"
-                android:layout_weight="0.2"
-                android:textAlignment="viewStart"
-                style="@style/FileItemLabelStyle"/>
-        </LinearLayout>
-
-        <FrameLayout
-            android:id="@+id/preview_icon"
-            android:layout_width="@dimen/list_item_icon_size"
-            android:layout_height="@dimen/list_item_icon_size"
-            android:layout_marginEnd="@dimen/list_item_icon_margin_end"
-            android:focusable="true">
-
-            <ImageView
-                android:layout_width="@dimen/check_icon_size"
-                android:layout_height="@dimen/check_icon_size"
-                android:layout_gravity="center"
-                android:scaleType="fitCenter"
-                android:tint="@color/doc_list_item_badge_icon_color"
-                android:src="@drawable/ic_zoom_out"/>
-
-        </FrameLayout>
-
-    </LinearLayout>
-
-</LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/additional_drag_shadow.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/additional_drag_shadow.xml
index e829baefd..dabdbc67a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/additional_drag_shadow.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/additional_drag_shadow.xml
@@ -17,14 +17,14 @@
 <!-- Transparent container so shadow layer can be drawn -->
 <FrameLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
-    android:layout_width="@dimen/drag_shadow_width"
-    android:layout_height="@dimen/drag_shadow_height"
-    android:background="@color/item_drag_shadow_container_background">
+    android:layout_width="@dimen/drag_shadow_width_m3"
+    android:layout_height="@dimen/drag_shadow_height_m3"
+    android:background="@color/item_drag_shadow_container_background_m3">
 
     <View
         android:layout_width="@dimen/drag_content_width"
         android:layout_height="@dimen/drag_content_height"
         android:layout_marginTop="@dimen/drag_additional_layer_margin_top"
-        android:layout_marginStart="@dimen/drag_shadow_radius"
-        android:background="@drawable/drag_shadow_background" />
+        android:layout_marginStart="@dimen/drag_shadow_radius_m3"
+        android:background="@drawable/drag_shadow_background_m3" />
 </FrameLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_item.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_item_m3.xml
similarity index 65%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/apps_item.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/apps_item_m3.xml
index 6477adedd..2d2081b94 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_item.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_item_m3.xml
@@ -19,39 +19,35 @@
     android:layout_width="0dp"
     android:layout_height="wrap_content"
     android:layout_weight="1"
-    android:minWidth="@dimen/apps_row_item_width"
-    android:paddingBottom="@dimen/apps_row_exit_icon_margin_bottom"
+    android:minWidth="@dimen/apps_row_item_width_m3"
+    android:paddingBottom="@dimen/apps_row_exit_icon_margin_bottom_m3"
+    android:paddingStart="@dimen/apps_row_item_padding_horizontal"
+    android:paddingEnd="@dimen/apps_row_item_padding_horizontal"
     android:orientation="vertical"
-    android:background="@drawable/generic_ripple_background"
+    android:background="@drawable/nav_rail_item_icon_background"
     android:gravity="center_horizontal">
 
     <ImageView
         android:id="@+id/app_icon"
-        android:layout_width="@dimen/apps_row_app_icon_size"
-        android:layout_height="@dimen/apps_row_app_icon_size"
-        android:layout_marginTop="@dimen/apps_row_app_icon_margin_top"
-        android:layout_marginBottom="@dimen/apps_row_app_icon_margin_bottom"
-        android:layout_marginStart="@dimen/apps_row_app_icon_margin_horizontal"
-        android:layout_marginEnd="@dimen/apps_row_app_icon_margin_horizontal"/>
-
-    <TextView
+        android:layout_width="@dimen/apps_row_app_icon_size_m3"
+        android:layout_height="@dimen/apps_row_app_icon_size_m3"
+        android:layout_marginTop="@dimen/apps_row_app_icon_margin_vertical"
+        android:layout_marginBottom="@dimen/apps_row_app_icon_margin_vertical"/>
+
+    <com.google.android.material.textview.MaterialTextView
         android:id="@android:id/title"
         android:layout_width="wrap_content"
         android:layout_height="wrap_content"
-        android:layout_marginStart="@dimen/apps_row_item_text_margin_horizontal"
-        android:layout_marginEnd="@dimen/apps_row_item_text_margin_horizontal"
-        android:textAppearance="@style/AppsItemText"
+        android:textAppearance="@style/AppsRowTitle"
         android:maxLines="1"
         android:ellipsize="end"
         android:gravity="center"/>
 
-    <TextView
+    <com.google.android.material.textview.MaterialTextView
         android:id="@+id/summary"
         android:layout_width="wrap_content"
         android:layout_height="wrap_content"
-        android:layout_marginStart="@dimen/apps_row_item_text_margin_horizontal"
-        android:layout_marginEnd="@dimen/apps_row_item_text_margin_horizontal"
-        android:textAppearance="@style/AppsItemSubText"
+        android:textAppearance="@style/AppsItemSubTextM3"
         android:maxLines="1"
         android:ellipsize="end"
         android:gravity="center"/>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_row.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_row_m3.xml
similarity index 66%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/apps_row.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/apps_row_m3.xml
index 249a6d3f1..3a1e648e3 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_row.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_row_m3.xml
@@ -14,25 +14,27 @@
      limitations under the License.
 -->
 
-<!-- TODO(b/379776735): Remove this after use_material3 flag is launched.
-    Currently it's being referenced in AppsRowManager.
--->
 <LinearLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
     android:id="@+id/apps_row"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
+    android:background="@drawable/apps_row_background"
+    android:layout_marginTop="@dimen/apps_row_margin_vertical"
+    android:layout_marginBottom="@dimen/apps_row_margin_vertical"
+    android:layout_marginStart="@dimen/main_container_padding_start"
+    android:layout_marginEnd="@dimen/main_container_padding_end"
+    android:padding="@dimen/apps_row_padding"
     android:orientation="vertical">
 
-    <TextView
+    <com.google.android.material.textview.MaterialTextView
         android:layout_width="wrap_content"
         android:layout_height="wrap_content"
-        android:minHeight="@dimen/apps_row_title_height"
-        android:paddingStart="@dimen/apps_row_title_padding_start"
-        android:textAppearance="@style/SortTitle"
+        android:layout_gravity="center_horizontal"
+        android:layout_marginBottom="@dimen/apps_row_title_padding"
+        android:textAppearance="@style/AppsRowTitle"
         android:text="@string/apps_row_title"
-        android:textAllCaps="true"
-        android:gravity="center"/>
+        android:gravity="center" />
 
     <HorizontalScrollView
         android:layout_width="match_parent"
@@ -43,7 +45,7 @@
             android:id="@+id/apps_group"
             android:layout_width="match_parent"
             android:layout_height="wrap_content"
-            android:orientation="horizontal"/>
+            android:orientation="horizontal" />
     </HorizontalScrollView>
 
-</LinearLayout>
\ No newline at end of file
+</LinearLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/column_headers.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/column_headers_m3.xml
similarity index 73%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/column_headers.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/column_headers_m3.xml
index 18a8dc8f7..5ad37fc8f 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/column_headers.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/column_headers_m3.xml
@@ -20,22 +20,14 @@
     android:id="@+id/table_header"
     android:orientation="horizontal"
     android:layout_width="match_parent"
-    android:layout_height="@dimen/doc_header_height"
+    android:layout_height="@dimen/doc_header_height_m3"
     android:baselineAligned="false"
     android:gravity="center_vertical"
-    android:paddingStart="@dimen/table_header_padding_start"
-    android:paddingEnd="@dimen/table_header_padding_end"
+    android:paddingStart="@dimen/main_container_padding_start"
+    android:paddingEnd="@dimen/main_container_padding_end"
     android:background="?attr/colorSurfaceBright"
     android:visibility="gone">
 
-    <!-- Placeholder for MIME/thumbnail icon -->
-    <View
-        android:layout_width="@dimen/list_item_icon_size"
-        android:layout_height="@dimen/list_item_icon_size"
-        android:layout_gravity="center_vertical"
-        android:layout_marginEnd="@dimen/list_item_icon_margin_end"
-        android:layout_marginStart="0dp"/>
-
     <!-- Column headers: Name only for compact/medium size screen -->
     <com.android.documentsui.sorting.HeaderCell
         android:id="@android:id/title"
@@ -48,6 +40,6 @@
         android:orientation="horizontal"
         android:animateLayoutChanges="true">
 
-        <include layout="@layout/shared_cell_content" />
+        <include layout="@layout/shared_cell_content_m3" />
     </com.android.documentsui.sorting.HeaderCell>
 </LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_delete_confirmation.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_delete_confirmation_m3.xml
similarity index 75%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_delete_confirmation.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_delete_confirmation_m3.xml
index fb3ff29cf..ac570065a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_delete_confirmation.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_delete_confirmation_m3.xml
@@ -14,12 +14,10 @@
      limitations under the License.
 -->
 
-<TextView
+<com.google.android.material.textview.MaterialTextView
     xmlns:android="http://schemas.android.com/apk/res/android"
     android:layout_width="match_parent"
     android:layout_height="match_parent"
-    android:paddingTop="24dp"
-    android:paddingStart="24dp"
-    android:paddingEnd="24dp"
-    android:textAppearance="@style/Subhead">
-</TextView>
+    android:paddingTop="@dimen/dialog_content_padding_top_m3"
+    android:paddingBottom="@dimen/dialog_content_padding_bottom_m3"
+    android:paddingHorizontal="@dimen/dialog_content_padding_horizontal" />
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_file_name.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_file_name_m3.xml
similarity index 87%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_file_name.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_file_name_m3.xml
index 8cae6ac03..cbf613656 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_file_name.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_file_name_m3.xml
@@ -15,6 +15,7 @@
 -->
 
 <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
     android:fitsSystemWindows="true">
@@ -24,10 +25,10 @@
         android:orientation="vertical"
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
-        android:layout_marginStart="?android:attr/listPreferredItemPaddingStart"
-        android:layout_marginEnd="?android:attr/listPreferredItemPaddingEnd"
-        android:layout_marginTop="@dimen/dialog_content_padding_top"
-        android:layout_marginBottom="@dimen/dialog_content_padding_bottom">
+        android:layout_marginHorizontal="@dimen/dialog_content_padding_horizontal"
+        android:layout_marginTop="@dimen/dialog_content_padding_top_m3"
+        android:layout_marginBottom="@dimen/dialog_content_padding_bottom_m3"
+        app:boxBackgroundColor="?attr/colorSurfaceContainerHighest">
 
         <com.google.android.material.textfield.TextInputEditText
             android:id="@android:id/text1"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_sorting.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_sorting.xml
deleted file mode 100644
index 9ddbfaee4..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_sorting.xml
+++ /dev/null
@@ -1,38 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-
-<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    android:layout_width="match_parent"
-    android:layout_height="wrap_content"
-    android:orientation="vertical">
-
-    <TextView
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
-        android:paddingStart="?android:attr/listPreferredItemPaddingStart"
-        android:paddingEnd="?android:attr/listPreferredItemPaddingEnd"
-        android:paddingTop="?android:attr/listPreferredItemPaddingStart"
-        android:paddingBottom="?android:attr/listPreferredItemPaddingStart"
-        android:textAllCaps="true"
-        android:text="@string/sort_dimension_dialog_title"
-        android:textAppearance="@style/SortTitle"/>
-
-    <ListView
-        android:id="@+id/sorting_dialog_list"
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"/>
-
-</LinearLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_sorting_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_sorting_m3.xml
new file mode 100644
index 000000000..03b39564e
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/dialog_sorting_m3.xml
@@ -0,0 +1,22 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<ListView xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/sorting_dialog_list"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content"
+    android:paddingTop="@dimen/bottom_sheet_dialog_padding_top"
+    android:paddingBottom="@dimen/bottom_sheet_dialog_padding_bottom"/>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_app_bar.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_app_bar_m3.xml
similarity index 72%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/directory_app_bar.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/directory_app_bar_m3.xml
index 94e4b953d..13066bfa5 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_app_bar.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_app_bar_m3.xml
@@ -23,17 +23,13 @@
     android:layout_height="wrap_content"
     android:touchscreenBlocksFocus="false">
 
-    <!-- Technically we don't need this CollapsingToolbarLayout wrapper when use_material3 flag
-         is ON, because we don't want to hide anything in the app header area when scrolling, but
-         some files (e.g. NavigationViewManager and others) uses the existence of this element to
-         do some specific logic, hence leaving it here with "noScroll" behavior.
-     -->
     <com.google.android.material.appbar.CollapsingToolbarLayout
         android:id="@+id/collapsing_toolbar"
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
         app:titleEnabled="false"
-        app:layout_scrollFlags="noScroll">
+        app:contentScrim="@android:color/transparent"
+        app:layout_scrollFlags="scroll|enterAlways|enterAlwaysCollapsed">
 
         <LinearLayout
             android:layout_width="match_parent"
@@ -41,7 +37,7 @@
             android:orientation="vertical"
             android:background="?attr/colorSurfaceBright">
 
-            <include layout="@layout/directory_header" />
+            <include layout="@layout/directory_header_m3" />
 
             <com.google.android.material.divider.MaterialDivider
                 android:layout_width="match_parent"
@@ -49,7 +45,7 @@
                 app:dividerColor="?attr/colorSurfaceContainer"
                 app:dividerThickness="@dimen/main_container_section_gap" />
 
-            <include layout="@layout/column_headers"/>
+            <include layout="@layout/column_headers_m3"/>
 
         </LinearLayout>
 
@@ -57,18 +53,29 @@
             android:id="@+id/toolbar"
             android:layout_width="match_parent"
             android:layout_height="?attr/actionBarSize"
-            android:touchscreenBlocksFocus="false">
+            android:touchscreenBlocksFocus="false"
+            android:background="?attr/colorSurfaceBright"
+            app:layout_collapseMode="pin">
 
-            <TextView
+            <com.google.android.material.textview.MaterialTextView
                 android:id="@+id/searchbar_title"
                 android:layout_width="match_parent"
                 android:layout_height="?android:attr/actionBarSize"
                 android:gravity="center_vertical"
                 android:text="@string/search_bar_hint"
-                android:textAppearance="@style/SearchBarTitle" />
+                android:textAppearance="@style/SearchBarTitleM3" />
 
         </com.google.android.material.appbar.MaterialToolbar>
 
+        <com.google.android.material.appbar.MaterialToolbar
+            android:id="@+id/selection_bar"
+            android:layout_width="match_parent"
+            android:layout_height="?attr/actionBarSize"
+            android:touchscreenBlocksFocus="false"
+            android:background="?attr/colorSurfaceBright"
+            android:visibility="gone"
+            app:layout_collapseMode="pin"/>
+
     </com.google.android.material.appbar.CollapsingToolbarLayout>
 
 </com.google.android.material.appbar.AppBarLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_header.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_header_m3.xml
similarity index 90%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/directory_header.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/directory_header_m3.xml
index 171c5882a..f649d52a8 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_header.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_header_m3.xml
@@ -21,7 +21,9 @@
     android:orientation="vertical">
 
     <!-- used for search chip. -->
-    <include layout="@layout/search_chip_row"/>
+    <include layout="@layout/search_chip_row_m3"/>
+    <!-- search options dropdown shown while search view is active. -->
+    <include layout="@layout/search_options_row"/>
 
     <LinearLayout
         android:id="@+id/tabs_container"
@@ -50,6 +52,6 @@
     </LinearLayout>
 
     <!-- used for apps row. -->
-    <include layout="@layout/apps_row"/>
+    <include layout="@layout/apps_row_m3"/>
 
 </LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/docked_search_bar.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/docked_search_bar.xml
new file mode 100644
index 000000000..35678ec3f
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/docked_search_bar.xml
@@ -0,0 +1,58 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<com.google.android.material.appbar.MaterialToolbar
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/docked_search_toolbar"
+    android:layout_width="wrap_content"
+    android:layout_height="@dimen/docked_searchbar_height"
+    android:paddingStart="@dimen/docked_searchbar_padding"
+    android:paddingEnd="@dimen/docked_searchbar_padding"
+    android:background="@drawable/docked_search_bar_background">
+
+    <ImageView
+        android:layout_width="@dimen/docked_searchbar_height"
+        android:layout_height="@dimen/docked_searchbar_height"
+        android:src="@drawable/ic_menu_search_m3"
+        android:tint="?attr/colorOnSurfaceVariant"
+        android:padding="@dimen/docked_searchbar_icon_padding"
+        android:importantForAccessibility="no" />
+
+    <EditText
+        android:id="@+id/docked_search_text"
+        android:layout_width="@dimen/docked_searchbar_text_width"
+        android:layout_height="match_parent"
+        android:background="@null"
+        android:hint="@string/search_bar_hint"
+        android:singleLine="true"
+        android:textAppearance="@style/TextAppearance.DocumentsUI.SearchBar"
+        android:textColorHint="@null"
+        android:inputType="textFilter|textNoSuggestions"
+        android:importantForAutofill="no"
+        android:imeOptions="actionSearch">
+    </EditText>
+
+    <ImageView
+        android:id="@+id/docked_search_clear"
+        android:layout_width="@dimen/docked_searchbar_height"
+        android:layout_height="@dimen/docked_searchbar_height"
+        android:src="@drawable/ic_cancel"
+        android:tint="?attr/colorOnSurfaceVariant"
+        android:padding="@dimen/docked_searchbar_icon_padding"
+        android:visibility="invisible"
+        android:contentDescription="@string/search_bar_clear" />
+
+</com.google.android.material.appbar.MaterialToolbar>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout_m3.xml
similarity index 87%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout_m3.xml
index 8181cd403..dac1d1276 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout_m3.xml
@@ -17,9 +17,9 @@
 <!-- Transparent container so shadow layer can be drawn -->
 <FrameLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
-    android:layout_width="@dimen/drag_shadow_width"
-    android:layout_height="@dimen/drag_shadow_height"
-    android:background="@color/item_drag_shadow_container_background">
+    android:layout_width="@dimen/drag_shadow_width_m3"
+    android:layout_height="@dimen/drag_shadow_height_m3"
+    android:background="@color/item_drag_shadow_container_background_m3">
 
     <LinearLayout
         android:layout_width="@dimen/drag_content_width"
@@ -29,7 +29,7 @@
         android:paddingHorizontal="@dimen/space_extra_small_4"
         android:orientation="horizontal"
         android:gravity="center_vertical"
-        android:background="@drawable/drag_shadow_background">
+        android:background="@drawable/drag_shadow_background_m3">
 
         <LinearLayout
             android:layout_width="@dimen/drop_badge_container_size"
@@ -38,12 +38,12 @@
             android:gravity="center_horizontal"
             android:background="@drawable/drop_badge_container_background">
 
-            <include layout="@layout/drop_badge"/>
+            <include layout="@layout/drop_badge_m3"/>
 
         </LinearLayout>
 
 
-        <TextView
+        <com.google.android.material.textview.MaterialTextView
             android:id="@android:id/title"
             android:layout_width="wrap_content"
             android:layout_height="wrap_content"
@@ -55,7 +55,7 @@
 
     </LinearLayout>
 
-    <TextView
+    <com.google.android.material.textview.MaterialTextView
         android:id="@+id/drag_file_counter"
         android:layout_width="wrap_content"
         android:layout_height="@dimen/drag_file_counter_height"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/drawer_layout.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/drawer_layout_m3.xml
similarity index 96%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/drawer_layout.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/drawer_layout_m3.xml
index 0fe74fe64..d962b4fd4 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/drawer_layout.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/drawer_layout_m3.xml
@@ -21,6 +21,7 @@
     xmlns:app="http://schemas.android.com/apk/res-auto"
     android:layout_width="match_parent"
     android:layout_height="match_parent"
+    android:background="?attr/colorSurfaceContainer"
     android:id="@+id/coordinator_layout">
 
     <androidx.drawerlayout.widget.DrawerLayout
@@ -40,7 +41,7 @@
             <FrameLayout
                 android:layout_width="match_parent"
                 android:layout_height="match_parent"
-                app:layout_behavior="@string/scrolling_behavior">
+                app:layout_behavior="@string/scrolling_behavior_m3">
 
                 <FrameLayout
                     android:id="@+id/container_directory"
@@ -60,7 +61,7 @@
                 <View
                     android:id="@+id/drawer_edge"
                     android:background="@android:color/transparent"
-                    android:layout_width="@dimen/drawer_edge_width"
+                    android:layout_width="@dimen/drawer_edge_width_m3"
                     android:layout_height="match_parent"/>
             </FrameLayout>
 
@@ -95,7 +96,7 @@
             </LinearLayout>
 
             <!-- Top section: toolbar, search chips, profile tab -->
-            <include layout="@layout/directory_app_bar"/>
+            <include layout="@layout/directory_app_bar_m3"/>
 
         </androidx.coordinatorlayout.widget.CoordinatorLayout>
 
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/drop_badge.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/drop_badge_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/drop_badge.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/drop_badge_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fixed_layout.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fixed_layout_m3.xml
similarity index 75%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/fixed_layout.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/fixed_layout_m3.xml
index 4445dd1a6..021439783 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/fixed_layout.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fixed_layout_m3.xml
@@ -21,6 +21,7 @@
     android:layout_width="match_parent"
     android:layout_height="match_parent"
     android:id="@+id/coordinator_layout"
+    android:background="?attr/colorSurfaceContainer"
     android:focusable="true">
 
     <LinearLayout
@@ -53,24 +54,38 @@
                 android:paddingTop="@dimen/main_container_padding_top"
                 android:background="@drawable/main_container_top_section_background">
 
-                <com.google.android.material.appbar.MaterialToolbar
-                    android:id="@+id/toolbar"
-                    android:layout_width="match_parent"
-                    android:layout_height="?attr/actionBarSize"
-                    android:layout_marginTop="@dimen/action_bar_margin"
-                    android:touchscreenBlocksFocus="false">
+                <FrameLayout
+                    android:layout_height="match_parent"
+                    android:layout_width="match_parent">
 
-                    <TextView
-                        android:id="@+id/searchbar_title"
+                    <com.google.android.material.appbar.MaterialToolbar
+                        android:id="@+id/toolbar"
                         android:layout_width="match_parent"
-                        android:layout_height="?android:attr/actionBarSize"
-                        android:gravity="center_vertical"
-                        android:text="@string/search_bar_hint"
-                        android:textAppearance="@style/SearchBarTitle" />
+                        android:layout_height="?attr/actionBarSize"
+                        android:layout_marginTop="@dimen/action_bar_margin_m3"
+                        android:touchscreenBlocksFocus="false">
+
+                        <TextView
+                            android:id="@+id/searchbar_title"
+                            android:layout_width="match_parent"
+                            android:layout_height="?android:attr/actionBarSize"
+                            android:gravity="center_vertical"
+                            android:text="@string/search_bar_hint"
+                            android:textAppearance="@style/SearchBarTitle" />
+
+                    </com.google.android.material.appbar.MaterialToolbar>
+
+                    <com.google.android.material.appbar.MaterialToolbar
+                        android:id="@+id/selection_bar"
+                        android:layout_width="match_parent"
+                        android:layout_height="?attr/actionBarSize"
+                        android:touchscreenBlocksFocus="false"
+                        android:background="?attr/colorSurfaceBright"
+                        android:visibility="gone"/>
 
-                </com.google.android.material.appbar.MaterialToolbar>
+                </FrameLayout>
 
-                <include layout="@layout/directory_header" />
+                <include layout="@layout/directory_header_m3" />
 
             </LinearLayout>
 
@@ -83,7 +98,7 @@
                 android:layout_marginTop="@dimen/main_container_section_gap"
                 android:background="@drawable/main_container_middle_section_background">
 
-                <include layout="@layout/column_headers"/>
+                <include layout="@layout/column_headers_m3"/>
 
                 <FrameLayout
                     android:layout_width="match_parent"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_directory.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_directory_m3.xml
similarity index 88%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_directory.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_directory_m3.xml
index a7ee033f1..26ba5fe97 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_directory.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_directory_m3.xml
@@ -35,6 +35,9 @@
         android:layout_width="match_parent"
         android:layout_height="match_parent">
 
+        <!-- defaultFocusHighlightEnabled=false to prevent unexpected focus background when there
+             is not item, do not use focusable=false because we still want it to be focused in
+             TalkBack. -->
         <androidx.recyclerview.widget.RecyclerView
             android:id="@+id/dir_list"
             android:layout_width="match_parent"
@@ -46,6 +49,7 @@
             android:clipToPadding="false"
             android:scrollbars="none"
             android:drawSelectorOnTop="true"
+            android:defaultFocusHighlightEnabled="false"
             app:fastScrollEnabled="false"/>
 
     </com.android.documentsui.dirlist.DocumentsSwipeRefreshLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick_directory_m3.xml
similarity index 80%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick_directory_m3.xml
index 5923bf9eb..97ec6c5d3 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick_directory_m3.xml
@@ -17,9 +17,7 @@
     xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:app="http://schemas.android.com/apk/res-auto"
     android:layout_width="match_parent"
-    android:layout_height="wrap_content"
-    android:paddingTop="@dimen/picker_saver_container_padding_top"
-    android:paddingBottom="@dimen/picker_saver_container_padding_bottom">
+    android:layout_height="wrap_content">
 
     <LinearLayout
         android:layout_width="match_parent"
@@ -28,29 +26,31 @@
         android:baselineAligned="false"
         android:background="?attr/colorSurfaceContainer"
         android:gravity="center_vertical|end"
-        android:paddingStart="@dimen/bottom_bar_padding"
-        android:paddingEnd="@dimen/bottom_bar_padding"
+        android:paddingStart="@dimen/picker_saver_padding_start"
+        android:paddingEnd="@dimen/picker_saver_padding_end"
         android:paddingTop="@dimen/picker_saver_padding_top"
         android:paddingBottom="@dimen/picker_saver_padding_bottom">
 
         <com.google.android.material.button.MaterialButton
             android:id="@android:id/button2"
             style="@style/MaterialTonalButton"
-            app:cornerRadius="@dimen/button_corner_radius"
+            app:cornerRadius="@dimen/button_corner_radius_m3"
             android:layout_width="wrap_content"
             android:layout_height="wrap_content"
-            android:layout_marginStart="@dimen/picker_saver_button_gap"
+            android:layout_marginBottom="@dimen/picker_saver_button_gap"
+            android:layout_marginTop="@dimen/picker_saver_button_gap"
             android:layout_marginEnd="@dimen/picker_saver_button_gap"
             android:text="@android:string/cancel" />
 
         <com.google.android.material.button.MaterialButton
             android:id="@android:id/button1"
-            style="@style/MaterialButton"
-            app:cornerRadius="@dimen/button_corner_radius"
+            style="@style/MaterialButtonM3"
+            app:cornerRadius="@dimen/button_corner_radius_m3"
             android:layout_width="wrap_content"
             android:layout_height="wrap_content"
-            android:layout_marginStart="@dimen/picker_saver_button_gap"
-            android:layout_marginEnd="@dimen/picker_saver_button_gap" />
+            android:layout_marginBottom="@dimen/picker_saver_button_gap"
+            android:layout_marginTop="@dimen/picker_saver_button_gap"
+            android:layout_marginStart="@dimen/picker_saver_button_gap"/>
 
     </LinearLayout>
 
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick_files_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick_files_m3.xml
new file mode 100644
index 000000000..a9dec6013
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick_files_m3.xml
@@ -0,0 +1,52 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<LinearLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content"
+    android:paddingStart="@dimen/picker_saver_padding_start"
+    android:paddingEnd="@dimen/picker_saver_padding_end"
+    android:paddingBottom="@dimen/picker_saver_padding_bottom"
+    android:paddingTop="@dimen/picker_saver_padding_top"
+    android:background="?attr/colorSurfaceContainer"
+    android:baselineAligned="false"
+    android:gravity="center_vertical|end"
+    android:orientation="horizontal">
+
+        <com.google.android.material.button.MaterialButton
+            android:id="@+id/button_cancel"
+            style="@style/MaterialTonalButton"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:layout_marginEnd="@dimen/picker_saver_button_gap"
+            android:layout_marginTop="@dimen/picker_saver_button_gap"
+            android:layout_marginBottom="@dimen/picker_saver_button_gap"
+            android:text="@android:string/cancel"
+            app:cornerRadius="@dimen/button_corner_radius_m3" />
+
+        <com.google.android.material.button.MaterialButton
+            android:id="@+id/button_pick"
+            style="@style/MaterialButtonM3"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:layout_marginStart="@dimen/picker_saver_button_gap"
+            android:layout_marginTop="@dimen/picker_saver_button_gap"
+            android:layout_marginBottom="@dimen/picker_saver_button_gap"
+            android:text="@string/menu_select"
+            app:cornerRadius="@dimen/button_corner_radius_m3" />
+</LinearLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_roots.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_roots_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_roots.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_roots_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save.xml
deleted file mode 100644
index 3270b183c..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save.xml
+++ /dev/null
@@ -1,75 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-
-<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:app="http://schemas.android.com/apk/res-auto"
-    android:layout_width="match_parent"
-    android:layout_height="wrap_content"
-    android:paddingTop="@dimen/picker_saver_container_padding_top"
-    android:paddingBottom="@dimen/picker_saver_container_padding_bottom">
-
-    <LinearLayout
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:paddingTop="@dimen/picker_saver_padding_top"
-        android:paddingBottom="@dimen/picker_saver_padding_bottom"
-        android:paddingEnd="@dimen/bottom_bar_padding"
-        android:orientation="horizontal"
-        android:baselineAligned="false"
-        android:gravity="center_vertical|end"
-        android:paddingStart="@dimen/list_item_padding">
-
-        <com.google.android.material.textfield.TextInputLayout
-            android:id="@+id/title_wrapper"
-            style="?attr/textInputFilledStyle"
-            android:layout_width="0dp"
-            android:layout_height="wrap_content"
-            android:layout_weight="1"
-            android:layout_marginEnd="@dimen/picker_saver_button_gap"
-            android:hint="@string/file_name_hint">
-            <com.google.android.material.textfield.TextInputEditText
-                android:id="@android:id/title"
-                android:layout_width="match_parent"
-                android:layout_height="wrap_content"
-                android:singleLine="true"
-                android:selectAllOnFocus="true" />
-        </com.google.android.material.textfield.TextInputLayout>
-
-        <include layout="@layout/fragment_save_cancel_button" />
-
-        <com.google.android.material.button.MaterialButton
-            android:id="@android:id/button1"
-            style="@style/MaterialButton"
-            app:cornerRadius="@dimen/button_corner_radius"
-            android:layout_width="wrap_content"
-            android:layout_height="wrap_content"
-            android:layout_marginStart="@dimen/picker_saver_button_gap"
-            android:layout_marginEnd="@dimen/picker_saver_button_gap"
-            android:text="@string/menu_save"/>
-
-        <com.google.android.material.progressindicator.CircularProgressIndicator
-            android:id="@android:id/progress"
-            android:layout_width="wrap_content"
-            android:layout_height="wrap_content"
-            android:layout_gravity="center"
-            android:visibility="gone"
-            android:indeterminate="true"
-            android:padding="8dp"
-            app:trackColor="?attr/colorSecondaryContainer" />
-
-    </LinearLayout>
-
-</LinearLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save_cancel_button.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save_cancel_button.xml
index 5179630c9..d113f28cf 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save_cancel_button.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save_cancel_button.xml
@@ -20,10 +20,12 @@
     xmlns:app="http://schemas.android.com/apk/res-auto"
     android:id="@android:id/button2"
     style="@style/Widget.Material3.Button.TonalButton"
-    app:cornerRadius="@dimen/button_corner_radius"
+    app:cornerRadius="@dimen/button_corner_radius_m3"
     android:layout_width="wrap_content"
     android:layout_height="wrap_content"
+    android:layout_marginBottom="@dimen/picker_saver_button_gap"
     android:layout_marginStart="4dp"
+    android:layout_marginTop="@dimen/picker_saver_button_gap"
     android:layout_marginEnd="4dp"
     android:visibility="gone"
     android:text="@android:string/cancel"/>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save_m3.xml
new file mode 100644
index 000000000..2ddbed7f7
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save_m3.xml
@@ -0,0 +1,72 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<LinearLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content"
+    android:paddingStart="@dimen/picker_saver_padding_start"
+    android:paddingEnd="@dimen/picker_saver_padding_end"
+    android:paddingTop="@dimen/picker_saver_padding_top"
+    android:paddingBottom="@dimen/picker_saver_padding_bottom"
+    android:orientation="horizontal"
+    android:baselineAligned="false"
+    android:gravity="center_vertical|end">
+
+    <com.google.android.material.textfield.TextInputLayout
+        android:id="@+id/title_wrapper"
+        style="?attr/textInputFilledStyle"
+        android:layout_width="0dp"
+        android:layout_height="wrap_content"
+        android:layout_marginBottom="@dimen/picker_saver_button_gap"
+        android:layout_marginEnd="@dimen/picker_saver_button_gap"
+        android:layout_marginTop="@dimen/picker_saver_button_gap"
+        android:layout_weight="1"
+        android:hint="@string/file_name_hint">
+        <com.google.android.material.textfield.TextInputEditText
+            android:id="@android:id/title"
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            android:singleLine="true"
+            android:selectAllOnFocus="true" />
+    </com.google.android.material.textfield.TextInputLayout>
+
+    <include layout="@layout/fragment_save_cancel_button" />
+
+    <com.google.android.material.button.MaterialButton
+        android:id="@android:id/button1"
+        style="@style/MaterialButtonM3"
+        app:cornerRadius="@dimen/button_corner_radius_m3"
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:layout_marginBottom="@dimen/picker_saver_button_gap"
+        android:layout_marginStart="@dimen/picker_saver_button_gap"
+        android:layout_marginTop="@dimen/picker_saver_button_gap"
+        android:text="@string/menu_save" />
+
+    <com.google.android.material.progressindicator.CircularProgressIndicator
+        android:id="@android:id/progress"
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:layout_gravity="center"
+        android:layout_marginStart="@dimen/saver_progress_start_margin"
+        android:visibility="gone"
+        android:indeterminate="true"
+        android:padding="8dp"
+        app:trackColor="?attr/colorSecondaryContainer" />
+
+</LinearLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_search.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_search_m3.xml
similarity index 95%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_search.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_search_m3.xml
index 75608a888..45ae77276 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_search.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_search_m3.xml
@@ -23,7 +23,7 @@
     android:background="?android:attr/colorBackground">
 
     <!-- used for search chip. -->
-    <include layout="@layout/search_chip_row"/>
+    <include layout="@layout/search_chip_row_m3"/>
 
     <ListView
         android:id="@+id/history_list"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_action_view.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_action_view_m3.xml
similarity index 94%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_action_view.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_action_view_m3.xml
index c67233e1f..49f72880a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_action_view.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_action_view_m3.xml
@@ -18,7 +18,7 @@
     android:layout_height="match_parent">
 
     <include
-        layout="@layout/inspector_section_title"
+        layout="@layout/inspector_section_title_m3"
         android:id="@+id/action_header" />
 
     <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
@@ -36,7 +36,7 @@
             android:layout_width="50dp"
             android:layout_height="50dp" />
 
-        <TextView
+        <com.google.android.material.textview.MaterialTextView
             android:id="@+id/app_name"
             android:paddingLeft="16dp"
             android:paddingBottom="10dp"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_activity.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_activity_m3.xml
similarity index 98%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_activity.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_activity_m3.xml
index c7a34a1e6..f9ba85d16 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_activity.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_activity_m3.xml
@@ -47,7 +47,7 @@
                 <com.android.documentsui.inspector.HeaderView
                     android:id="@+id/inspector_header_view"
                     android:layout_width="match_parent"
-                    android:layout_height="@dimen/inspector_header_height"
+                    android:layout_height="@dimen/inspector_header_height_m3"
                     app:layout_collapseMode="parallax"/>
             </LinearLayout>
 
@@ -58,7 +58,7 @@
                 android:background="?android:attr/colorBackground"
                 android:theme="?actionBarTheme"
                 app:title="@string/inspector_title"
-                app:titleTextAppearance="@style/ToolbarTitle"
+                app:titleTextAppearance="@style/ToolbarTitleM3"
                 app:layout_collapseMode="pin">
             </androidx.appcompat.widget.Toolbar>
         </com.google.android.material.appbar.CollapsingToolbarLayout>
@@ -76,7 +76,7 @@
             android:orientation="vertical"
             android:layout_width="match_parent"
             android:layout_height="match_parent"
-            android:background="@drawable/bottom_sheet_dialog_background"
+            android:background="@drawable/bottom_sheet_dialog_background_m3"
             android:paddingBottom="5dp">
 
             <com.android.documentsui.inspector.DetailsView
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_header.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_header_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_header.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_header_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_section_title.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_section_title_m3.xml
similarity index 90%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_section_title.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_section_title_m3.xml
index d98fa143a..4c09619b3 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_section_title.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/inspector_section_title_m3.xml
@@ -18,7 +18,7 @@
     android:layout_height="wrap_content"
     android:layout_width="match_parent"
     android:orientation="vertical"
-    android:divider="@drawable/inspector_separator"
+    android:divider="@drawable/inspector_separator_m3"
     android:showDividers="beginning"
     android:paddingStart="10dp"
     android:paddingEnd="10dp">
@@ -29,7 +29,7 @@
         android:layout_width="wrap_content">
     </android.widget.Space >
 
-    <TextView
+    <com.google.android.material.textview.MaterialTextView
         android:layout_height="match_parent"
         android:layout_width="match_parent"
         android:id="@+id/inspector_header_title"
@@ -39,7 +39,7 @@
         android:paddingBottom="25dp"
         android:layout_gravity="center_vertical"
         android:clickable="false"
-        android:textAppearance="@style/ToolbarTitle"
+        android:textAppearance="@style/ToolbarTitleM3"
         android:textAlignment="viewStart"
         android:textIsSelectable="true"/>
 </LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_dir_grid.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_dir_grid_m3.xml
similarity index 92%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/item_dir_grid.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/item_dir_grid_m3.xml
index 44a53325d..95e32c699 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_dir_grid.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_dir_grid_m3.xml
@@ -43,7 +43,7 @@
         app:strokeColor="?android:strokeColor">
 
         <!-- The height is 48px.
-             paddingTop (9dp) + @dimen/check_icon_size (30dp) + paddingBottom (9dp) -->
+             paddingTop (9dp) + @dimen/check_icon_size_m3 (30dp) + paddingBottom (9dp) -->
         <LinearLayout
             android:layout_width="match_parent"
             android:layout_height="match_parent"
@@ -63,40 +63,40 @@
 
                 <ImageView
                     android:id="@+id/icon_mime_sm"
-                    android:layout_width="@dimen/grid_item_icon_size"
-                    android:layout_height="@dimen/grid_item_icon_size"
+                    android:layout_width="@dimen/grid_item_icon_size_m3"
+                    android:layout_height="@dimen/grid_item_icon_size_m3"
                     android:layout_gravity="center"
                     android:contentDescription="@null"
                     android:scaleType="centerInside"/>
 
                 <ImageView
                     android:id="@+id/icon_check"
-                    android:layout_width="@dimen/check_icon_size"
-                    android:layout_height="@dimen/check_icon_size"
+                    android:layout_width="@dimen/check_icon_size_m3"
+                    android:layout_height="@dimen/check_icon_size_m3"
                     android:alpha="0"
                     android:contentDescription="@null"
                     android:scaleType="fitCenter"
-                    android:src="@drawable/ic_check_circle"/>
+                    android:src="@drawable/ic_check_circle_m3"/>
 
             </FrameLayout>
 
             <ImageView
                 android:id="@+id/icon_profile_badge"
-                android:layout_height="@dimen/briefcase_icon_size"
-                android:layout_width="@dimen/briefcase_icon_size"
-                android:layout_marginEnd="@dimen/briefcase_icon_margin"
-                android:src="@drawable/ic_briefcase"
+                android:layout_height="@dimen/briefcase_icon_size_m3"
+                android:layout_width="@dimen/briefcase_icon_size_m3"
+                android:layout_marginEnd="@dimen/briefcase_icon_margin_m3"
+                android:src="@drawable/ic_briefcase_m3"
                 android:tint="?android:attr/colorAccent"
                 android:contentDescription="@string/a11y_work"/>
 
-            <TextView
+            <com.google.android.material.textview.MaterialTextView
                 android:id="@android:id/title"
                 android:layout_width="wrap_content"
                 android:layout_height="wrap_content"
                 android:ellipsize="end"
                 android:singleLine="true"
                 android:textAlignment="viewStart"
-                android:textAppearance="@style/CardPrimaryText"
+                android:textAppearance="@style/CardPrimaryTextM3"
                 android:layout_marginBottom="9dp"
                 android:layout_marginEnd="12dp"
                 android:layout_marginTop="9dp"/>
@@ -109,7 +109,7 @@
     <View
         android:layout_width="match_parent"
         android:layout_height="match_parent"
-        android:background="@drawable/item_doc_grid_border_rounded"
+        android:background="@drawable/item_doc_grid_border_rounded_m3"
         android:contentDescription="@null"
         android:duplicateParentState="true"/>
 
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_grid.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_grid.xml
deleted file mode 100644
index a8e3148b4..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_grid.xml
+++ /dev/null
@@ -1,182 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:app="http://schemas.android.com/apk/res-auto"
-    android:id="@+id/item_root"
-    android:layout_width="match_parent"
-    android:layout_height="wrap_content"
-    android:clickable="true"
-    android:defaultFocusHighlightEnabled="false"
-    android:focusable="true">
-
-    <RelativeLayout
-        android:layout_width="@dimen/grid_width"
-        android:layout_height="@dimen/grid_height"
-        android:layout_margin="@dimen/grid_item_margin"
-        android:layout_gravity="center_horizontal"
-        android:paddingEnd="@dimen/grid_item_padding_end"
-        android:paddingStart="@dimen/grid_item_padding_start"
-        android:paddingTop="@dimen/grid_item_padding_top"
-        android:duplicateParentState="true">
-
-    <!-- Main item thumbnail.  Comprised of two overlapping images, the
-             visibility of which is controlled by code in
-             DirectoryFragment.java. -->
-
-        <FrameLayout
-            android:id="@+id/thumbnail"
-            android:layout_width="@dimen/grid_item_thumbnail_width"
-            android:layout_height="@dimen/grid_item_thumbnail_height"
-            android:layout_centerHorizontal="true"
-            android:background="@drawable/grid_thumbnail_background">
-
-            <!-- stroke width will be controlled dynamically in the code. -->
-            <com.google.android.material.card.MaterialCardView
-                android:id="@+id/icon_wrapper"
-                android:layout_width="@dimen/grid_item_icon_width"
-                android:layout_height="@dimen/grid_item_icon_height"
-                android:layout_gravity="center"
-                app:cardBackgroundColor="?attr/colorSurfaceContainerLowest"
-                app:cardElevation="0dp"
-                app:strokeColor="?attr/colorSecondaryContainer"
-                app:strokeWidth="0dp">
-
-                <com.android.documentsui.GridItemThumbnail
-                    android:id="@+id/icon_thumb"
-                    android:layout_width="match_parent"
-                    android:layout_height="match_parent"
-                    android:contentDescription="@null"
-                    android:scaleType="centerCrop"
-                    android:tint="?attr/gridItemTint"
-                    android:tintMode="src_over" />
-
-                <com.android.documentsui.GridItemThumbnail
-                    android:id="@+id/icon_mime_lg"
-                    android:layout_width="@dimen/icon_size"
-                    android:layout_height="@dimen/icon_size"
-                    android:layout_gravity="center"
-                    android:contentDescription="@null"
-                    android:scaleType="fitCenter" />
-
-            </com.google.android.material.card.MaterialCardView>
-
-        </FrameLayout>
-
-        <FrameLayout
-            android:id="@+id/preview_icon"
-            android:layout_width="@dimen/button_touch_size"
-            android:layout_height="@dimen/button_touch_size"
-            android:layout_alignParentEnd="true"
-            android:layout_alignParentTop="true"
-            android:clickable="true"
-            android:focusable="true"
-            android:pointerIcon="hand">
-
-            <ImageView
-                android:layout_width="@dimen/zoom_icon_size"
-                android:layout_height="@dimen/zoom_icon_size"
-                android:layout_gravity="center"
-                android:background="@drawable/circle_button_background"
-                android:padding="2dp"
-                android:scaleType="fitCenter"
-                android:src="@drawable/ic_zoom_out" />
-
-        </FrameLayout>
-
-        <!-- Item nameplate. Has some text fields (title, size, mod-time, etc). -->
-
-        <LinearLayout
-            android:id="@+id/nameplate"
-            android:layout_width="@dimen/grid_item_nameplate_width"
-            android:layout_height="@dimen/grid_item_nameplate_height"
-            android:layout_below="@id/thumbnail"
-            android:layout_marginTop="@dimen/grid_item_nameplate_marginTop"
-            android:background="@drawable/grid_nameplate_background"
-            android:orientation="vertical"
-            android:duplicateParentState="true"
-            android:padding="@dimen/grid_item_nameplate_padding">
-
-            <!-- Top row. -->
-            <LinearLayout
-                android:layout_width="match_parent"
-                android:layout_height="wrap_content"
-                android:gravity="center"
-                android:orientation="horizontal">
-
-                <ImageView
-                    android:id="@+id/icon_profile_badge"
-                    android:layout_width="@dimen/briefcase_icon_size"
-                    android:layout_height="@dimen/briefcase_icon_size"
-                    android:layout_marginEnd="@dimen/briefcase_icon_margin"
-                    android:contentDescription="@string/a11y_work"
-                    android:gravity="center_vertical"
-                    android:src="@drawable/ic_briefcase"
-                    android:tint="?android:attr/colorAccent" />
-
-                <TextView
-                    android:id="@android:id/title"
-                    android:layout_width="wrap_content"
-                    android:layout_height="wrap_content"
-                    android:ellipsize="end"
-                    android:singleLine="true"
-                    android:textAlignment="center"
-                    android:textAppearance="@style/FileItemLabelText" />
-
-            </LinearLayout>
-
-            <!-- Bottom row. -->
-            <LinearLayout
-                android:layout_width="match_parent"
-                android:layout_height="wrap_content"
-                android:gravity="center"
-                android:orientation="horizontal">
-
-                <TextView
-                    android:id="@+id/details"
-                    android:layout_width="wrap_content"
-                    android:layout_height="wrap_content"
-                    android:layout_marginEnd="4dp"
-                    android:ellipsize="end"
-                    android:singleLine="true"
-                    android:textAlignment="viewStart"
-                    android:textAppearance="@style/ItemCaptionText" />
-
-                <TextView
-                    android:id="@+id/bullet"
-                    android:layout_width="wrap_content"
-                    android:layout_height="wrap_content"
-                    android:layout_marginEnd="4dp"
-                    android:singleLine="true"
-                    android:text="@string/bullet"
-                    android:textAlignment="viewStart"
-                    android:textAppearance="@style/ItemCaptionText" />
-
-                <TextView
-                    android:id="@+id/date"
-                    android:layout_width="wrap_content"
-                    android:layout_height="wrap_content"
-                    android:ellipsize="end"
-                    android:singleLine="true"
-                    android:textAlignment="viewStart"
-                    android:textAppearance="@style/ItemCaptionText" />
-
-            </LinearLayout>
-
-        </LinearLayout>
-
-    </RelativeLayout>
-
-</FrameLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_grid_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_grid_m3.xml
new file mode 100644
index 000000000..021a1c3ad
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_grid_m3.xml
@@ -0,0 +1,204 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    android:id="@+id/item_root"
+    android:layout_width="@dimen/grid_width_m3"
+    android:layout_height="wrap_content"
+    android:layout_margin="@dimen/grid_item_margin_m3"
+    android:clickable="true"
+    android:defaultFocusHighlightEnabled="false"
+    android:focusable="true">
+
+<!-- Main item thumbnail.  Comprised of two overlapping images, the
+         visibility of which is controlled by code in
+         DirectoryFragment.java. -->
+
+    <FrameLayout
+        android:id="@+id/thumbnail"
+        android:layout_width="@dimen/grid_item_thumbnail_width"
+        android:layout_height="@dimen/grid_item_thumbnail_height"
+        android:layout_centerHorizontal="true"
+        android:duplicateParentState="true"
+        android:background="@drawable/grid_thumbnail_background">
+
+        <com.google.android.material.card.MaterialCardView
+            android:id="@+id/icon_wrapper"
+            android:layout_width="@dimen/grid_item_icon_width"
+            android:layout_height="@dimen/grid_item_icon_height"
+            android:layout_gravity="center"
+            style="@style/GridThumbnailCardViewStyle">
+
+            <com.google.android.material.imageview.ShapeableImageView
+                android:id="@+id/icon_thumb"
+                android:layout_width="match_parent"
+                android:layout_height="match_parent"
+                android:contentDescription="@null"
+                android:scaleType="centerCrop"
+                style="@style/GridThumbnailImageViewStyle" />
+
+            <com.android.documentsui.GridItemThumbnail
+                android:id="@+id/icon_mime_lg"
+                android:layout_width="@dimen/icon_size_m3"
+                android:layout_height="@dimen/icon_size_m3"
+                android:layout_gravity="center"
+                android:contentDescription="@null"
+                android:scaleType="fitCenter" />
+
+        </com.google.android.material.card.MaterialCardView>
+
+        <ImageView
+            android:id="@+id/selection_circle"
+            android:layout_width="@dimen/button_container_size"
+            android:layout_height="@dimen/button_container_size"
+            android:layout_marginStart="@dimen/selection_circle_margin"
+            android:layout_marginTop="@dimen/selection_circle_margin"
+            android:layout_gravity="top|start"
+            android:background="@drawable/selection_circle"
+            android:contentDescription="@null"
+            android:elevation="0dp"
+            android:scaleType="center" />
+
+        <ImageView
+            android:id="@+id/icon_check"
+            android:layout_width="@dimen/button_container_size"
+            android:layout_height="@dimen/button_container_size"
+            android:layout_gravity="top|start"
+            android:alpha="0"
+            android:background="@drawable/icon_check_background"
+            android:contentDescription="@null"
+            android:duplicateParentState="true"
+            android:scaleType="center"
+            android:src="@drawable/ic_check_circle_m3" />
+
+        <com.google.android.material.imageview.ShapeableImageView
+            android:id="@+id/icon_profile_badge"
+            android:layout_width="@dimen/briefcase_icon_grid_size"
+            android:layout_height="@dimen/briefcase_icon_grid_size"
+            android:layout_marginBottom="@dimen/briefcase_icon_grid_margin"
+            android:layout_marginEnd="@dimen/briefcase_icon_grid_margin"
+            android:layout_gravity="bottom|end"
+            android:contentDescription="@string/a11y_work"
+            android:gravity="center_vertical"
+            android:background="?attr/colorSurfaceContainerLowest"
+            app:shapeAppearance="?attr/shapeAppearanceCornerExtraSmall"
+            app:contentPadding="@dimen/briefcase_icon_grid_padding"
+            android:src="@drawable/ic_briefcase_m3"
+            android:tint="@color/briefcase_icon_color" />
+
+        <FrameLayout
+            android:id="@+id/preview_icon"
+            android:layout_width="@dimen/button_container_size"
+            android:layout_height="@dimen/button_container_size"
+            android:layout_gravity="top|end"
+            android:layout_marginEnd="@dimen/preview_icon_margin"
+            android:layout_marginTop="@dimen/preview_icon_margin"
+            android:clickable="true"
+            android:focusable="true"
+            android:pointerIcon="hand">
+
+                <!-- Black circle background -->
+                <ImageView
+                    android:layout_width="@dimen/preview_icon_circle_size"
+                    android:layout_height="@dimen/preview_icon_circle_size"
+                    android:layout_gravity="center"
+                    android:background="@drawable/circle_button_background_m3" />
+
+                <!-- White eye icon -->
+                <ImageView
+                    android:layout_width="@dimen/preview_icon_eye_size"
+                    android:layout_height="@dimen/preview_icon_eye_size"
+                    android:layout_gravity="center"
+                    android:src="@drawable/ic_zoom_out_m3" />
+
+        </FrameLayout>
+
+    </FrameLayout>
+
+    <!-- Item nameplate. Has some text fields (title, size, mod-time, etc). -->
+
+    <LinearLayout
+        android:id="@+id/nameplate"
+        android:layout_width="@dimen/grid_item_nameplate_width"
+        android:layout_height="wrap_content"
+        android:layout_below="@id/thumbnail"
+        android:layout_marginTop="@dimen/grid_item_nameplate_marginTop"
+        android:background="@drawable/grid_nameplate_background"
+        android:orientation="vertical"
+        android:duplicateParentState="true"
+        android:padding="@dimen/grid_item_nameplate_padding">
+
+        <!-- Top row. -->
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            android:gravity="center"
+            android:orientation="horizontal">
+
+            <com.google.android.material.textview.MaterialTextView
+                android:id="@android:id/title"
+                android:layout_width="wrap_content"
+                android:layout_height="wrap_content"
+                android:ellipsize="middle"
+                android:singleLine="true"
+                android:textAlignment="center"
+                android:textAppearance="@style/FileItemLabelText" />
+
+        </LinearLayout>
+
+        <!-- Bottom row. -->
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            android:gravity="center"
+            android:orientation="horizontal">
+
+            <com.google.android.material.textview.MaterialTextView
+                android:id="@+id/details"
+                android:layout_width="wrap_content"
+                android:layout_height="wrap_content"
+                android:layout_marginEnd="4dp"
+                android:ellipsize="end"
+                android:singleLine="true"
+                android:textAlignment="viewStart"
+                android:textAppearance="@style/ItemCaptionTextM3" />
+
+            <com.google.android.material.textview.MaterialTextView
+                android:id="@+id/bullet"
+                android:layout_width="wrap_content"
+                android:layout_height="wrap_content"
+                android:layout_marginEnd="4dp"
+                android:singleLine="true"
+                android:text="@string/bullet"
+                android:textAlignment="viewStart"
+                android:textAppearance="@style/ItemCaptionTextM3"
+                android:importantForAccessibility="no" />
+
+            <com.google.android.material.textview.MaterialTextView
+                android:id="@+id/date"
+                android:layout_width="wrap_content"
+                android:layout_height="wrap_content"
+                android:ellipsize="end"
+                android:singleLine="true"
+                android:textAlignment="viewStart"
+                android:textAppearance="@style/ItemCaptionTextM3" />
+
+        </LinearLayout>
+
+    </LinearLayout>
+
+</RelativeLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_header_message.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_header_message_m3.xml
similarity index 74%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_header_message.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_header_message_m3.xml
index 86fa60ccc..bb29894bc 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_header_message.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_header_message_m3.xml
@@ -16,7 +16,6 @@
 
 <FrameLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:app="http://schemas.android.com/apk/res-auto"
     android:id="@+id/item_root"
     android:layout_width="match_parent"
     android:layout_height="wrap_content">
@@ -24,17 +23,15 @@
     <com.google.android.material.card.MaterialCardView
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
-        android:layout_margin="4dp"
-        android:elevation="0dp"
-        android:duplicateParentState="true"
-        app:cardElevation="0dp"
-        app:strokeWidth="1dp"
-        app:strokeColor="?android:strokeColor">
+        style="@style/BannerStyle"
+        android:duplicateParentState="true">
 
         <LinearLayout
             android:layout_height="wrap_content"
             android:layout_width="match_parent"
-            android:background="?android:attr/colorBackground"
+            android:paddingVertical="@dimen/banner_content_padding_vertical"
+            android:paddingStart="@dimen/banner_content_padding_start"
+            android:paddingEnd="@dimen/banner_content_padding_end"
             android:orientation="vertical">
 
             <LinearLayout
@@ -43,13 +40,14 @@
                 android:layout_height="wrap_content"
                 android:layout_width="match_parent"
                 android:minHeight="60dp"
+                android:gravity="center_vertical"
                 android:orientation="horizontal">
 
                 <ImageView
                     android:contentDescription="@null"
                     android:id="@+id/message_icon"
-                    android:layout_height="@dimen/icon_size"
-                    android:layout_width="@dimen/icon_size"
+                    android:layout_height="@dimen/icon_size_m3"
+                    android:layout_width="@dimen/icon_size_m3"
                     android:layout_margin="8dp"
                     android:layout_gravity="center"
                     android:scaleType="centerInside"/>
@@ -58,38 +56,36 @@
                     android:layout_height="wrap_content"
                     android:layout_width="match_parent"
                     android:minHeight="48dp"
-                    android:paddingTop="12dp"
-                    android:paddingEnd="12dp"
                     android:gravity="center_vertical"
                     android:orientation="vertical">
 
-                    <TextView
+                    <com.google.android.material.textview.MaterialTextView
                         android:id="@+id/message_title"
                         android:layout_height="wrap_content"
                         android:layout_width="wrap_content"
-                        android:textSize="16sp"
-                        android:textAppearance="@style/DrawerMenuPrimary"/>
+                        android:textAppearance="@style/BannerTitleText"/>
 
-                    <TextView
+                    <com.google.android.material.textview.MaterialTextView
                         android:id="@+id/message_subtitle"
                         android:layout_height="wrap_content"
                         android:layout_width="wrap_content"
                         android:selectAllOnFocus="true"
-                        android:textSize="12sp"/>
+                        android:textAppearance="@style/BannerSubtitleText"/>
 
-                    <TextView
+                    <com.google.android.material.textview.MaterialTextView
                         android:id="@+id/message_textview"
                         android:layout_height="wrap_content"
                         android:layout_width="wrap_content"
-                        android:selectAllOnFocus="true"/>
+                        android:selectAllOnFocus="true"
+                        android:textAppearance="@style/BannerMessageText"/>
 
-                    <Button
+                    <com.google.android.material.button.MaterialButton
                         android:id="@+id/dismiss_button"
                         android:layout_height="wrap_content"
                         android:layout_width="wrap_content"
                         android:layout_gravity="end"
                         android:text="@android:string/ok"
-                        style="@style/DialogTextButton"/>
+                        style="@style/DialogTextButtonM3"/>
 
                 </LinearLayout>
             </LinearLayout>
@@ -100,13 +96,13 @@
                 android:layout_width="match_parent"
                 android:orientation="vertical">
 
-                <Button
+                <com.google.android.material.button.MaterialButton
                     android:id="@+id/action_button"
                     android:layout_height="wrap_content"
                     android:layout_width="wrap_content"
                     android:layout_marginEnd="16dp"
                     android:layout_gravity="end"
-                    style="@style/DialogTextButton"/>
+                    style="@style/DialogTextButtonM3"/>
 
             </LinearLayout>
 
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_content.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_content_m3.xml
similarity index 80%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_content.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_content_m3.xml
index 7645b6cd5..a61ea2169 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_content.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_content_m3.xml
@@ -26,20 +26,20 @@
         android:id="@+id/artwork"
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
-        android:layout_marginTop="25dp"
-        android:layout_marginBottom="25dp"
+        android:layout_marginTop="@dimen/empty_state_artwork_margin_top"
+        android:layout_marginBottom="@dimen/empty_state_artwork_margin_bottom"
         android:scaleType="fitCenter"
         android:maxHeight="250dp"
         android:adjustViewBounds="true"
         android:gravity="bottom|center_horizontal"
         android:contentDescription="@null"/>
 
-    <TextView
+    <com.google.android.material.textview.MaterialTextView
         android:id="@+id/message"
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
-        android:layout_marginBottom="25dp"
+        android:layout_marginBottom="@dimen/empty_state_message_margin_bottom"
         android:gravity="center_horizontal"
-        style="?android:attr/textAppearanceListItem"/>
+        style="@style/EmptyStateTitleTextM3"/>
 
 </LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_cross_profile.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_cross_profile_m3.xml
similarity index 69%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_cross_profile.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_cross_profile_m3.xml
index 4a77c702e..7039c34ad 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_cross_profile.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_cross_profile_m3.xml
@@ -17,23 +17,19 @@
 
 <LinearLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:app="http://schemas.android.com/apk/res-auto"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
     android:orientation="vertical"
     android:gravity="center_horizontal"
-    android:paddingTop="@dimen/item_doc_inflated_message_padding_top"
-    android:paddingStart="72dp"
-    android:paddingEnd="72dp">
+    android:paddingVertical="@dimen/item_doc_inflated_message_padding_vertical">
 
-    <ProgressBar
+    <com.google.android.material.progressindicator.CircularProgressIndicator
         android:id="@+id/cross_profile_progress"
-        style="@android:style/Widget.Material.Light.ProgressBar"
         android:visibility="gone"
         android:layout_width="wrap_content"
         android:layout_height="wrap_content"
-        android:indeterminate="true"
-        android:indeterminateTint="?attr/colorAccent"/>
+        android:layout_marginBottom="@dimen/cross_profile_progress_margin_bottom"
+        android:indeterminate="true"/>
 
     <LinearLayout
         android:id="@+id/cross_profile_content"
@@ -46,28 +42,25 @@
             android:id="@+id/artwork"
             android:layout_width="24dp"
             android:layout_height="24dp"/>
-        <TextView
+        <com.google.android.material.textview.MaterialTextView
             android:id="@+id/title"
-            android:layout_marginTop="8dp"
+            android:layout_marginTop="@dimen/cross_profile_button_message_margin_top_m3"
             android:layout_width="wrap_content"
             android:layout_height="wrap_content"
             android:gravity="center_horizontal"
-            android:textAppearance="@style/EmptyStateTitleText"/>
-        <TextView
+            android:textAppearance="@style/CrossProfileTitleTextM3"/>
+        <com.google.android.material.textview.MaterialTextView
             android:id="@+id/message"
-            android:layout_marginTop="@dimen/cross_profile_button_message_margin_top"
+            android:layout_marginTop="@dimen/cross_profile_button_message_margin_top_m3"
             android:layout_width="wrap_content"
             android:layout_height="wrap_content"
             android:gravity="center_horizontal"
-            android:textAppearance="@style/EmptyStateMessageText"/>
-        <Button
+            android:textAppearance="@style/CrossProfileMessageTextM3"/>
+        <com.google.android.material.button.MaterialButton
             android:id="@+id/button"
-            android:layout_marginTop="16dp"
+            android:layout_marginTop="@dimen/cross_profile_button_margin_top"
             android:layout_width="wrap_content"
             android:layout_height="wrap_content"
-            app:cornerRadius="@dimen/cross_profile_button_corner_radius"
-            app:strokeWidth="@dimen/cross_profile_button_stroke_width"
-            app:strokeColor="@color/work_profile_button_stroke_color"
-            style="@style/EmptyStateButton"/>
+            style="@style/MaterialOutlinedButtonM3"/>
     </LinearLayout>
 </LinearLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_m3.xml
similarity index 90%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_m3.xml
index 9cf92940c..5a5ff6437 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_m3.xml
@@ -19,10 +19,9 @@
     android:id="@android:id/empty"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
-    android:background="?attr/colorSurfaceBright"
-    android:focusable="true">
+    android:background="?attr/colorSurfaceBright">
 
-    <include android:id="@+id/content" layout="@layout/item_doc_inflated_message_content"/>
+    <include android:id="@+id/content" layout="@layout/item_doc_inflated_message_content_m3"/>
     <include android:id="@+id/cross_profile"
-             layout="@layout/item_doc_inflated_message_cross_profile"/>
+             layout="@layout/item_doc_inflated_message_cross_profile_m3"/>
 </FrameLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_list.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_list.xml
deleted file mode 100644
index b3ab315c5..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_list.xml
+++ /dev/null
@@ -1,157 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?><!--
-     Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-
-<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:app="http://schemas.android.com/apk/res-auto"
-    android:id="@+id/item_root"
-    android:layout_width="match_parent"
-    android:layout_height="wrap_content"
-    android:background="@drawable/list_item_background"
-    android:clickable="true"
-    android:focusable="true"
-    android:orientation="vertical">
-
-    <LinearLayout
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:baselineAligned="false"
-        android:gravity="center_vertical"
-        android:minHeight="@dimen/list_item_height"
-        android:orientation="horizontal"
-        android:paddingStart="@dimen/list_item_padding_start"
-        android:paddingEnd="@dimen/list_item_padding_end"
-        android:paddingVertical="@dimen/list_item_padding_vertical">
-
-      <FrameLayout
-          android:id="@+id/icon"
-          android:pointerIcon="hand"
-          android:layout_width="@dimen/list_item_icon_size"
-          android:layout_height="@dimen/list_item_icon_size"
-          android:layout_marginEnd="@dimen/list_item_icon_margin_end">
-
-        <!-- stroke width will be controlled dynamically in the code. -->
-        <com.google.android.material.card.MaterialCardView
-            android:id="@+id/icon_wrapper"
-            android:layout_width="match_parent"
-            android:layout_height="match_parent"
-            app:cardElevation="0dp"
-            app:cardBackgroundColor="?attr/colorSurfaceContainerLowest"
-            app:strokeColor="?attr/colorSecondaryContainer"
-            app:strokeWidth="0dp">
-
-          <ImageView
-              android:id="@+id/icon_mime"
-              android:layout_width="wrap_content"
-              android:layout_height="wrap_content"
-              android:layout_gravity="center"
-              android:contentDescription="@null"
-              android:scaleType="centerInside" />
-
-          <ImageView
-              android:id="@+id/icon_thumb"
-              android:layout_width="match_parent"
-              android:layout_height="match_parent"
-              android:contentDescription="@null"
-              android:scaleType="centerCrop" />
-
-          <ImageView
-              android:id="@+id/icon_check"
-              android:layout_width="@dimen/check_icon_size"
-              android:layout_height="@dimen/check_icon_size"
-              android:layout_gravity="center"
-              android:alpha="0"
-              android:contentDescription="@null"
-              android:scaleType="fitCenter"
-              android:src="@drawable/ic_check_circle" />
-
-        </com.google.android.material.card.MaterialCardView>
-
-      </FrameLayout>
-
-      <LinearLayout
-          android:layout_width="0dp"
-          android:layout_height="wrap_content"
-          android:layout_weight="1"
-          android:orientation="vertical"
-          android:layout_gravity="center_vertical"
-          android:layout_marginEnd="@dimen/list_item_icon_size">
-
-        <LinearLayout
-            android:layout_width="wrap_content"
-            android:layout_height="0dp"
-            android:layout_weight="1">
-
-          <ImageView
-              android:id="@+id/icon_profile_badge"
-              android:layout_height="@dimen/briefcase_icon_size"
-              android:layout_width="@dimen/briefcase_icon_size"
-              android:layout_marginEnd="@dimen/briefcase_icon_margin"
-              android:layout_gravity="center_vertical"
-              android:src="@drawable/ic_briefcase"
-              android:tint="@color/doc_list_item_badge_icon_color"
-              android:contentDescription="@string/a11y_work" />
-
-          <TextView
-              android:id="@android:id/title"
-              android:layout_width="wrap_content"
-              android:layout_height="wrap_content"
-              android:ellipsize="end"
-              android:singleLine="true"
-              android:textAlignment="viewStart"
-              android:textAppearance="@style/FileItemLabelText" />
-
-        </LinearLayout>
-
-        <LinearLayout
-            android:id="@+id/line2"
-            android:layout_width="match_parent"
-            android:layout_height="wrap_content"
-            android:baselineAligned="false"
-            android:gravity="center_vertical"
-            android:orientation="horizontal">
-
-          <TextView
-              android:id="@+id/metadata"
-              android:layout_width="wrap_content"
-              android:layout_height="wrap_content"
-              android:ellipsize="end"
-              android:singleLine="true"
-              android:textAppearance="@style/ItemCaptionText" />
-
-        </LinearLayout>
-
-      </LinearLayout>
-
-      <FrameLayout
-          android:id="@+id/preview_icon"
-          android:layout_width="@dimen/list_item_icon_size"
-          android:layout_height="@dimen/list_item_icon_size"
-          android:focusable="true"
-          android:clickable="true">
-
-        <ImageView
-            android:layout_width="@dimen/check_icon_size"
-            android:layout_height="@dimen/check_icon_size"
-            android:layout_gravity="center"
-            android:scaleType="fitCenter"
-            android:tint="@color/doc_list_item_badge_icon_color"
-            android:src="@drawable/ic_zoom_out" />
-
-      </FrameLayout>
-
-    </LinearLayout>
-
-</LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_list_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_list_m3.xml
new file mode 100644
index 000000000..d1258b106
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_list_m3.xml
@@ -0,0 +1,137 @@
+<?xml version="1.0" encoding="utf-8"?><!--
+     Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/item_root"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content"
+    android:background="@drawable/list_item_background_m3"
+    android:clickable="true"
+    android:focusable="true"
+    android:baselineAligned="false"
+    android:gravity="center_vertical"
+    android:minHeight="@dimen/list_item_height_m3"
+    android:orientation="horizontal"
+    android:paddingStart="@dimen/list_item_padding_start"
+    android:paddingEnd="@dimen/list_item_padding_end"
+    android:paddingVertical="@dimen/list_item_padding_vertical">
+
+    <FrameLayout
+        android:id="@+id/icon"
+        android:pointerIcon="hand"
+        android:layout_width="@dimen/list_item_icon_size"
+        android:layout_height="@dimen/list_item_icon_size"
+        android:layout_marginEnd="@dimen/list_item_icon_margin_end">
+
+      <com.google.android.material.card.MaterialCardView
+          android:layout_width="match_parent"
+          android:layout_height="match_parent"
+          style="@style/ListThumbnailCardViewStyle">
+
+        <ImageView
+            android:id="@+id/icon_mime"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:layout_gravity="center"
+            android:contentDescription="@null"
+            android:scaleType="centerInside" />
+
+        <com.google.android.material.imageview.ShapeableImageView
+            android:id="@+id/icon_thumb"
+            android:layout_width="match_parent"
+            android:layout_height="match_parent"
+            android:contentDescription="@null"
+            android:scaleType="centerCrop"
+            style="@style/ListThumbnailImageViewStyle" />
+
+        <ImageView
+            android:id="@+id/icon_check"
+            android:layout_width="@dimen/check_icon_size_m3"
+            android:layout_height="@dimen/check_icon_size_m3"
+            android:layout_gravity="center"
+            android:alpha="0"
+            android:contentDescription="@null"
+            android:scaleType="fitCenter"
+            android:src="@drawable/ic_check_circle_m3" />
+
+      </com.google.android.material.card.MaterialCardView>
+
+    </FrameLayout>
+
+    <ImageView
+        android:id="@+id/icon_profile_badge"
+        android:layout_height="@dimen/briefcase_icon_size_m3"
+        android:layout_width="@dimen/briefcase_icon_size_m3"
+        android:layout_marginEnd="@dimen/briefcase_icon_margin_m3"
+        android:layout_gravity="center_vertical"
+        android:src="@drawable/ic_briefcase_m3"
+        android:tint="@color/briefcase_icon_color"
+        android:contentDescription="@string/a11y_work" />
+
+    <LinearLayout
+        android:layout_width="0dp"
+        android:layout_height="wrap_content"
+        android:layout_weight="1"
+        android:orientation="vertical">
+
+      <com.google.android.material.textview.MaterialTextView
+          android:id="@android:id/title"
+          android:layout_width="wrap_content"
+          android:layout_height="wrap_content"
+          android:ellipsize="middle"
+          android:singleLine="true"
+          android:textAlignment="viewStart"
+          android:textAppearance="@style/FileItemLabelText" />
+
+      <LinearLayout
+          android:id="@+id/line2"
+          android:layout_width="wrap_content"
+          android:layout_height="wrap_content"
+          android:baselineAligned="false"
+          android:gravity="center_vertical"
+          android:orientation="horizontal">
+
+        <com.google.android.material.textview.MaterialTextView
+            android:id="@+id/metadata"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:ellipsize="end"
+            android:singleLine="true"
+            android:textAppearance="@style/ItemCaptionTextM3" />
+
+      </LinearLayout>
+
+    </LinearLayout>
+
+    <FrameLayout
+        android:id="@+id/preview_icon"
+        android:layout_width="@dimen/list_item_icon_size"
+        android:layout_height="@dimen/list_item_icon_size"
+        android:layout_gravity="center"
+        android:focusable="true"
+        android:clickable="true">
+
+      <ImageView
+          android:layout_width="@dimen/check_icon_size_m3"
+          android:layout_height="@dimen/check_icon_size_m3"
+          android:layout_gravity="center"
+          android:scaleType="fitCenter"
+          android:tint="@color/doc_list_item_badge_icon_color"
+          android:src="@drawable/ic_zoom_out_m3" />
+
+    </FrameLayout>
+
+</LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_history.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_history_m3.xml
similarity index 78%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/item_history.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/item_history_m3.xml
index 2936741e5..b185edd78 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_history.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_history_m3.xml
@@ -23,12 +23,12 @@
     android:gravity="center_vertical">
 
     <ImageView
-        android:layout_width="@dimen/button_touch_size"
-        android:layout_height="@dimen/button_touch_size"
-        android:src="@drawable/ic_history"
+        android:layout_width="@dimen/button_touch_size_m3"
+        android:layout_height="@dimen/button_touch_size_m3"
+        android:src="@drawable/ic_history_m3"
         android:scaleType="centerInside"/>
 
-    <TextView
+    <com.google.android.material.textview.MaterialTextView
         android:id="@android:id/title"
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
@@ -41,10 +41,10 @@
 
     <ImageView
         android:id="@android:id/icon"
-        android:layout_width="@dimen/button_touch_size"
-        android:layout_height="@dimen/button_touch_size"
-        android:background="@drawable/generic_ripple_background"
-        android:src="@drawable/ic_action_clear"
+        android:layout_width="@dimen/button_touch_size_m3"
+        android:layout_height="@dimen/button_touch_size_m3"
+        android:background="@drawable/generic_ripple_background_m3"
+        android:src="@drawable/ic_action_clear_m3"
         android:scaleType="centerInside"/>
 
 </LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_photo_grid.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_photo_grid_m3.xml
similarity index 80%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/item_photo_grid.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/item_photo_grid_m3.xml
index cd7e8f945..aa544f229 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_photo_grid.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_photo_grid_m3.xml
@@ -26,8 +26,8 @@
     android:layout_height="wrap_content"
     android:orientation="vertical"
     android:layout_margin="4dp"
-    android:background="@drawable/grid_item_background"
-    android:elevation="@dimen/grid_item_elevation"
+    android:background="@drawable/grid_item_background_m3"
+    android:elevation="@dimen/grid_item_elevation_m3"
     android:focusable="true">
 
     <RelativeLayout
@@ -55,8 +55,8 @@
 
             <com.android.documentsui.GridItemThumbnail
                 android:id="@+id/icon_mime_lg"
-                android:layout_width="@dimen/icon_size"
-                android:layout_height="@dimen/icon_size"
+                android:layout_width="@dimen/icon_size_m3"
+                android:layout_height="@dimen/icon_size_m3"
                 android:layout_gravity="center"
                 android:scaleType="fitCenter"
                 android:contentDescription="@null"/>
@@ -64,18 +64,18 @@
         </FrameLayout>
 
         <FrameLayout
-            android:layout_width="@dimen/button_touch_size"
-            android:layout_height="@dimen/button_touch_size"
+            android:layout_width="@dimen/button_touch_size_m3"
+            android:layout_height="@dimen/button_touch_size_m3"
             android:layout_alignParentTop="true"
             android:layout_alignParentStart="true"
             android:pointerIcon="hand">
 
             <ImageView
                 android:id="@+id/icon_check"
-                android:src="@drawable/ic_check_circle"
+                android:src="@drawable/ic_check_circle_m3"
                 android:alpha="0"
-                android:layout_width="@dimen/check_icon_size"
-                android:layout_height="@dimen/check_icon_size"
+                android:layout_width="@dimen/check_icon_size_m3"
+                android:layout_height="@dimen/check_icon_size_m3"
                 android:layout_gravity="center"
                 android:scaleType="fitCenter"
                 android:contentDescription="@null"/>
@@ -84,8 +84,8 @@
 
         <FrameLayout
             android:id="@+id/preview_icon"
-            android:layout_width="@dimen/button_touch_size"
-            android:layout_height="@dimen/button_touch_size"
+            android:layout_width="@dimen/button_touch_size_m3"
+            android:layout_height="@dimen/button_touch_size_m3"
             android:layout_alignParentTop="true"
             android:layout_alignParentEnd="true"
             android:pointerIcon="hand"
@@ -93,32 +93,32 @@
             android:clickable="true">
 
             <ImageView
-                android:layout_width="@dimen/zoom_icon_size"
-                android:layout_height="@dimen/zoom_icon_size"
+                android:layout_width="@dimen/zoom_icon_size_m3"
+                android:layout_height="@dimen/zoom_icon_size_m3"
                 android:padding="2dp"
                 android:layout_gravity="center"
-                android:background="@drawable/circle_button_background"
+                android:background="@drawable/circle_button_background_m3"
                 android:scaleType="fitCenter"
-                android:src="@drawable/ic_zoom_out"/>
+                android:src="@drawable/ic_zoom_out_m3"/>
 
         </FrameLayout>
 
         <FrameLayout
             android:id="@+id/icon_profile_badge"
-            android:layout_width="@dimen/button_touch_size"
-            android:layout_height="@dimen/button_touch_size"
+            android:layout_width="@dimen/button_touch_size_m3"
+            android:layout_height="@dimen/button_touch_size_m3"
             android:layout_alignParentBottom="true"
             android:layout_alignParentEnd="true"
             android:pointerIcon="hand">
 
             <ImageView
                 android:id="@+id/icon_id"
-                android:layout_height="@dimen/briefcase_icon_size_photo"
-                android:layout_width="@dimen/briefcase_icon_size_photo"
-                android:src="@drawable/ic_briefcase_white"
+                android:layout_height="@dimen/briefcase_icon_size_photo_m3"
+                android:layout_width="@dimen/briefcase_icon_size_photo_m3"
+                android:src="@drawable/ic_briefcase_white_m3"
                 android:tint="?android:attr/colorAccent"
                 android:padding="5dp"
-                android:background="@drawable/circle_button_background"
+                android:background="@drawable/circle_button_background_m3"
                 android:layout_gravity="center"
                 android:scaleType="fitCenter"
                 android:contentDescription="@string/a11y_work"/>
@@ -133,7 +133,7 @@
             android:layout_alignLeft="@id/thumbnail"
             android:layout_alignRight="@id/thumbnail"
             android:contentDescription="@null"
-            android:background="@drawable/item_doc_grid_border"
+            android:background="@drawable/item_doc_grid_border_m3"
             android:duplicateParentState="true"/>
 
     </RelativeLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_header.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_header_m3.xml
similarity index 82%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_header.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_header_m3.xml
index 041164ae6..1a8c684ed 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_header.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_header_m3.xml
@@ -18,16 +18,15 @@
     xmlns:android="http://schemas.android.com/apk/res/android"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
-    android:paddingTop="8dp"
-    android:paddingBottom="8dp"
+    android:paddingHorizontal="16dp"
+    android:paddingVertical="18dp"
     android:gravity="center_vertical">
 
-    <TextView
+    <com.google.android.material.textview.MaterialTextView
         android:id="@android:id/title"
-        android:paddingStart="64dp"
         android:layout_width="wrap_content"
-        android:layout_height="44dp"
+        android:layout_height="wrap_content"
         android:gravity="center_vertical"
-        style="@style/DrawerMenuHeader"/>
+        style="@style/DrawerMenuHeaderM3"/>
 
 </LinearLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_m3.xml
similarity index 87%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/item_root.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_m3.xml
index 599fab108..f315f0421 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_m3.xml
@@ -29,12 +29,12 @@
 
     <FrameLayout
         android:layout_width="wrap_content"
-        android:layout_height="@dimen/icon_size"
+        android:layout_height="@dimen/icon_size_m3"
         android:duplicateParentState="true">
 
         <ImageView
             android:id="@android:id/icon"
-            android:layout_width="@dimen/root_icon_size"
+            android:layout_width="@dimen/root_icon_size_m3"
             android:layout_height="match_parent"
             android:scaleType="centerInside"
             android:contentDescription="@null"
@@ -49,23 +49,23 @@
         android:orientation="vertical"
         android:layout_weight="1">
 
-        <TextView
+        <com.google.android.material.textview.MaterialTextView
             android:id="@android:id/title"
             android:layout_width="match_parent"
             android:layout_height="wrap_content"
             android:singleLine="true"
             android:ellipsize="end"
             android:textAlignment="viewStart"
-            android:textAppearance="@style/DrawerMenuPrimary" />
+            android:textAppearance="@style/DrawerMenuPrimaryM3" />
 
-        <TextView
+        <com.google.android.material.textview.MaterialTextView
             android:id="@android:id/summary"
             android:layout_width="match_parent"
             android:layout_height="wrap_content"
             android:singleLine="true"
             android:ellipsize="end"
             android:textAlignment="viewStart"
-            android:textAppearance="@style/DrawerMenuSecondary" />
+            android:textAppearance="@style/DrawerMenuSecondaryM3" />
 
     </LinearLayout>
 
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_spacer.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_spacer_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_spacer.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_spacer_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_item.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_item.xml
new file mode 100644
index 000000000..b3e3eab05
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_item.xml
@@ -0,0 +1,128 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2025 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<com.google.android.material.card.MaterialCardView
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    style="@style/JobProgressItemCardStyle"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content"
+    android:layout_marginHorizontal="@dimen/job_progress_list_margin">
+    <androidx.constraintlayout.widget.ConstraintLayout
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content">
+        <com.google.android.material.textview.MaterialTextView
+            android:id="@+id/job_progress_item_title"
+            style="@style/JobProgressItemTitleStyle"
+            android:layout_width="0dp"
+            android:layout_height="wrap_content"
+            android:layout_marginTop="@dimen/job_progress_item_padding"
+            android:layout_marginStart="@dimen/job_progress_item_padding"
+            app:layout_constrainedHeight="true"
+            app:layout_constraintStart_toStartOf="parent"
+            app:layout_constraintEnd_toStartOf="@id/job_progress_item_expand"
+            app:layout_constraintTop_toTopOf="parent" />
+        <com.google.android.material.button.MaterialButton
+            android:id="@+id/job_progress_item_expand"
+            style="@style/JobProgressItemExpandButtonStyle"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:layout_marginStart="@dimen/job_progress_item_expand_margin_start"
+            android:layout_marginEnd="@dimen/job_progress_item_padding"
+            app:layout_constraintStart_toEndOf="@id/job_progress_item_title"
+            app:layout_constraintEnd_toEndOf="parent"
+            app:layout_constraintTop_toTopOf="@id/job_progress_item_title" />
+        <androidx.constraintlayout.widget.Barrier
+            android:id="@+id/job_progress_item_header_barrier"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            app:barrierDirection="bottom"
+            app:constraint_referenced_ids="job_progress_item_title,job_progress_item_expand" />
+
+        <com.google.android.material.progressindicator.LinearProgressIndicator
+            android:id="@+id/job_progress_item_progress"
+            style="@style/JobProgressItemProgressStyle"
+            android:layout_width="0dp"
+            android:layout_height="wrap_content"
+            android:layout_marginTop="@dimen/job_progress_item_progress_margin_top"
+            app:layout_constraintStart_toStartOf="@id/job_progress_item_title"
+            app:layout_constraintEnd_toEndOf="@id/job_progress_item_expand"
+            app:layout_constraintTop_toBottomOf="@id/job_progress_item_header_barrier"
+            app:layout_constraintHorizontal_bias="0" />
+        <com.google.android.material.textview.MaterialTextView
+            android:id="@+id/job_progress_item_primary_status"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:textAppearance="@style/JobProgressItemStatusText"
+            app:layout_constraintStart_toStartOf="@id/job_progress_item_progress"
+            app:layout_constraintTop_toBottomOf="@id/job_progress_item_progress" />
+        <com.google.android.material.textview.MaterialTextView
+            android:id="@+id/job_progress_item_status_separator"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:layout_marginStart="@dimen/job_progress_item_status_separator_margin"
+            android:text="@string/bullet"
+            android:textAppearance="?attr/textAppearanceBodySmall"
+            app:layout_constraintStart_toEndOf="@id/job_progress_item_primary_status"
+            app:layout_constraintTop_toBottomOf="@id/job_progress_item_progress" />
+        <com.google.android.material.textview.MaterialTextView
+            android:id="@+id/job_progress_item_secondary_status"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:layout_marginStart="@dimen/job_progress_item_status_separator_margin"
+            android:textAppearance="@style/JobProgressItemStatusText"
+            app:layout_constraintStart_toEndOf="@+id/job_progress_item_status_separator"
+            app:layout_constraintTop_toBottomOf="@+id/job_progress_item_progress" />
+
+        <!-- Used to provide a bottom margin when all buttons are hidden. -->
+        <Space
+            android:layout_width="wrap_content"
+            android:layout_height="@dimen/job_progress_item_padding"
+            app:layout_constraintStart_toStartOf="parent"
+            app:layout_constraintTop_toBottomOf="@id/job_progress_item_primary_status" />
+        <!-- Used to provide a consistent margin regardless of which button is displayed. -->
+        <Space
+            android:id="@+id/job_progress_item_button_margin"
+            android:layout_width="@dimen/job_progress_item_buttons_margin_start"
+            android:layout_height="@dimen/job_progress_item_buttons_margin_top"
+            app:layout_constraintStart_toStartOf="parent"
+            app:layout_constraintTop_toBottomOf="@id/job_progress_item_primary_status" />
+        <com.google.android.material.button.MaterialButton
+            android:id="@+id/job_progress_item_cancel"
+            style="@style/JobProgressItemActionButtonStyle"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:text="@android:string/cancel"
+            app:layout_constraintStart_toEndOf="@id/job_progress_item_button_margin"
+            app:layout_constraintTop_toBottomOf="@id/job_progress_item_button_margin" />
+        <com.google.android.material.button.MaterialButton
+            android:id="@+id/job_progress_item_show_in_folder"
+            style="@style/JobProgressItemActionButtonStyle"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:text="@string/button_show_in_folder"
+            app:layout_constraintStart_toEndOf="@id/job_progress_item_cancel"
+            app:layout_constraintTop_toTopOf="@id/job_progress_item_cancel" />
+        <com.google.android.material.button.MaterialButton
+            android:id="@+id/job_progress_item_dismiss"
+            style="@style/JobProgressItemActionButtonStyle"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:text="@string/button_dismiss"
+            app:layout_constraintStart_toEndOf="@id/job_progress_item_show_in_folder"
+            app:layout_constraintTop_toTopOf="@id/job_progress_item_show_in_folder" />
+    </androidx.constraintlayout.widget.ConstraintLayout>
+</com.google.android.material.card.MaterialCardView>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_panel.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_panel.xml
index 17f6aa6fc..a58232894 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_panel.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_panel.xml
@@ -17,27 +17,40 @@
 
 <FrameLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
     android:layout_width="match_parent"
     android:layout_height="wrap_content">
     <com.google.android.material.card.MaterialCardView
         style="@style/JobProgressPanelStyle"
         android:layout_width="match_parent"
-        android:layout_height="wrap_content">
-        <LinearLayout
+        android:layout_height="wrap_content"
+        android:layout_marginStart="@dimen/job_progress_panel_margin"
+        android:layout_marginBottom="@dimen/job_progress_panel_margin">
+        <androidx.constraintlayout.widget.ConstraintLayout
             android:layout_width="match_parent"
-            android:layout_height="wrap_content"
-            android:orientation="vertical">
+            android:layout_height="wrap_content">
             <TextView
+                android:id="@+id/job_progress_panel_title"
                 android:layout_width="wrap_content"
                 android:layout_height="wrap_content"
-                android:id="@+id/job_progress_panel_title"
+                android:layout_margin="@dimen/job_progress_panel_header_margin"
                 android:text="@string/job_progress_panel_title"
                 android:textAppearance="@style/JobProgressPanelHeaderText"
-                android:layout_margin="@dimen/job_progress_panel_header_margin" />
+                app:layout_constraintStart_toStartOf="parent"
+                app:layout_constraintTop_toTopOf="parent"
+                app:layout_constraintBottom_toTopOf="@id/job_progress_list" />
             <androidx.recyclerview.widget.RecyclerView
-                android:layout_width="match_parent"
+                android:id="@+id/job_progress_list"
+                android:layout_width="0dp"
                 android:layout_height="wrap_content"
-                android:id="@+id/job_progress_list" />
-        </LinearLayout>
+                android:paddingBottom="@dimen/job_progress_list_margin"
+                android:clipToPadding="false"
+                android:scrollbars="vertical"
+                app:layout_constraintHeight_max="@dimen/job_progress_list_max_height"
+                app:layout_constraintStart_toStartOf="parent"
+                app:layout_constraintEnd_toEndOf="parent"
+                app:layout_constraintTop_toBottomOf="@id/job_progress_panel_title"
+                app:layout_constraintBottom_toBottomOf="parent" />
+        </androidx.constraintlayout.widget.ConstraintLayout>
     </com.google.android.material.card.MaterialCardView>
 </FrameLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_toolbar_item.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_toolbar_item.xml
index 222c8d43e..e29b44d8b 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_toolbar_item.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_toolbar_item.xml
@@ -15,11 +15,28 @@
     limitations under the License.
 -->
 
-<com.google.android.material.progressindicator.CircularProgressIndicator
+<androidx.constraintlayout.widget.ConstraintLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:app="http://schemas.android.com/apk/res-auto"
-    style="@style/JobProgressToolbarIndicatorStyle"
-    android:layout_width="wrap_content"
-    android:layout_height="wrap_content"
-    android:clickable="true"
-    android:focusable="true" />
+    android:layout_width="48dp"
+    android:layout_height="48dp">
+    <com.google.android.material.progressindicator.CircularProgressIndicator
+        android:id="@+id/job_progress_toolbar_indicator"
+        style="@style/JobProgressToolbarIndicatorStyle"
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:clickable="true"
+        android:focusable="true"
+        app:layout_constraintStart_toStartOf="parent"
+        app:layout_constraintEnd_toEndOf="parent"
+        app:layout_constraintTop_toTopOf="parent"
+        app:layout_constraintBottom_toBottomOf="parent" />
+    <ImageView
+        android:id="@+id/job_progress_toolbar_badge"
+        android:layout_width="@dimen/job_progress_toolbar_badge_diameter"
+        android:layout_height="@dimen/job_progress_toolbar_badge_diameter"
+        android:src="@drawable/job_progress_badge"
+        android:visible="false"
+        app:layout_constraintEnd_toEndOf="@id/job_progress_toolbar_indicator"
+        app:layout_constraintTop_toTopOf="@id/job_progress_toolbar_indicator" />
+</androidx.constraintlayout.widget.ConstraintLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_item_root.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_item_root.xml
index 461027c73..4eece3150 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_item_root.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_item_root.xml
@@ -35,14 +35,14 @@
 
         <ImageView
             android:id="@android:id/icon"
-            android:layout_width="@dimen/root_icon_size"
-            android:layout_height="@dimen/root_icon_size"
+            android:layout_width="@dimen/root_icon_size_m3"
+            android:layout_height="@dimen/root_icon_size_m3"
             android:scaleType="centerInside"
             android:contentDescription="@null" />
 
     </LinearLayout>
 
-    <TextView
+    <com.google.android.material.textview.MaterialTextView
         android:id="@android:id/title"
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_layout.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_layout.xml
index 091444155..fdad5e4cc 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_layout.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_layout.xml
@@ -21,6 +21,7 @@
     xmlns:app="http://schemas.android.com/apk/res-auto"
     android:layout_width="match_parent"
     android:layout_height="match_parent"
+    android:background="?attr/colorSurfaceContainer"
     android:id="@+id/coordinator_layout">
 
     <androidx.drawerlayout.widget.DrawerLayout
@@ -52,7 +53,7 @@
                     android:id="@+id/nav_rail_burger_menu"
                     android:layout_width="@dimen/nav_rail_burger_icon_size"
                     android:layout_height="@dimen/nav_rail_burger_icon_size"
-                    android:layout_marginBottom="24dp"
+                    android:layout_marginBottom="@dimen/space_small_4"
                     app:iconPadding="0dp"
                     app:iconGravity="textStart"
                     app:iconTint="?attr/colorOnSurfaceVariant"
@@ -60,7 +61,7 @@
                     app:rippleColor="@color/nav_rail_burger_icon_ripple_color"
                     app:strokeColor="?attr/colorPrimary"
                     android:contentDescription="@string/drawer_open"
-                    app:icon="@drawable/ic_hamburger" />
+                    app:icon="@drawable/ic_hamburger_m3" />
 
                 <FrameLayout
                     android:id="@+id/nav_rail_container_roots"
@@ -84,24 +85,38 @@
                     android:paddingTop="@dimen/main_container_padding_top"
                     android:background="@drawable/main_container_top_section_background">
 
-                    <com.google.android.material.appbar.MaterialToolbar
-                        android:id="@+id/toolbar"
-                        android:layout_width="match_parent"
-                        android:layout_height="?attr/actionBarSize"
-                        android:layout_marginTop="@dimen/action_bar_margin"
-                        android:touchscreenBlocksFocus="false">
+                    <FrameLayout
+                        android:layout_height="match_parent"
+                        android:layout_width="match_parent">
 
-                        <TextView
-                            android:id="@+id/searchbar_title"
+                        <com.google.android.material.appbar.MaterialToolbar
+                            android:id="@+id/toolbar"
                             android:layout_width="match_parent"
-                            android:layout_height="?android:attr/actionBarSize"
-                            android:gravity="center_vertical"
-                            android:text="@string/search_bar_hint"
-                            android:textAppearance="@style/SearchBarTitle" />
+                            android:layout_height="?attr/actionBarSize"
+                            android:layout_marginTop="@dimen/action_bar_margin_m3"
+                            android:touchscreenBlocksFocus="false">
+
+                            <TextView
+                                android:id="@+id/searchbar_title"
+                                android:layout_width="match_parent"
+                                android:layout_height="?android:attr/actionBarSize"
+                                android:gravity="center_vertical"
+                                android:text="@string/search_bar_hint"
+                                android:textAppearance="@style/SearchBarTitle" />
+
+                        </com.google.android.material.appbar.MaterialToolbar>
+
+                        <com.google.android.material.appbar.MaterialToolbar
+                            android:id="@+id/selection_bar"
+                            android:layout_width="match_parent"
+                            android:layout_height="?attr/actionBarSize"
+                            android:touchscreenBlocksFocus="false"
+                            android:background="?attr/colorSurfaceBright"
+                            android:visibility="gone"/>
 
-                    </com.google.android.material.appbar.MaterialToolbar>
+                    </FrameLayout>
 
-                    <include layout="@layout/directory_header" />
+                    <include layout="@layout/directory_header_m3" />
 
                 </LinearLayout>
 
@@ -114,7 +129,7 @@
                     android:layout_marginTop="@dimen/main_container_section_gap"
                     android:background="@drawable/main_container_middle_section_background">
 
-                    <include layout="@layout/column_headers"/>
+                    <include layout="@layout/column_headers_m3"/>
 
                     <FrameLayout
                         android:layout_width="match_parent"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item_m3.xml
similarity index 59%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item_m3.xml
index ba99ac35d..898aff360 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item_m3.xml
@@ -21,25 +21,34 @@
     android:layout_height="wrap_content"
     android:minHeight="@dimen/breadcrumb_height"
     android:gravity="center_vertical"
+    android:focusable="true"
+    android:clickable="true"
+    android:defaultFocusHighlightEnabled="false"
     android:orientation="horizontal">
 
-    <TextView
+    <!-- We can't put clickable/focusable on the TextView below even though we only want the
+         highlight/focus ring on the TextView instead of the whole item, this is because there is a
+         specific logic in HorizontalBreadcrumb when binding click event, the event is bound
+         on the whole item directly and there are special a11y handling (check the
+         `setAccessibilityDelegateCompat` call). Given we don't want the focus background on
+         the item, we also need defaultFocusHighlightEnabled above and duplicateParentState
+         below.  -->
+    <com.google.android.material.textview.MaterialTextView
         android:id="@+id/breadcrumb_text"
         android:layout_width="wrap_content"
-        android:layout_height="@dimen/breadcrumb_item_height"
-        android:focusable="true"
-        android:clickable="true"
+        android:layout_height="wrap_content"
+        android:duplicateParentState="true"
         android:maxWidth="275dp"
         android:gravity="center_vertical"
         android:maxLines="1"
         android:ellipsize="end"
-        android:textAppearance="@style/BreadcrumbText"
-        android:background="@drawable/breadcrumb_item_background" />
+        android:textAppearance="@style/BreadcrumbTextM3"
+        android:background="@drawable/breadcrumb_item_background_m3" />
 
     <ImageView
         android:id="@+id/breadcrumb_arrow"
         android:layout_width="@dimen/breadcrumb_item_arrow_size"
         android:layout_height="@dimen/breadcrumb_item_arrow_size"
-        android:src="@drawable/ic_breadcrumb_arrow"/>
+        android:src="@drawable/ic_breadcrumb_arrow_m3"/>
 
-</LinearLayout>
\ No newline at end of file
+</LinearLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_layout.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_layout.xml
index 50102d622..3589f6ab6 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_layout.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_layout.xml
@@ -14,9 +14,46 @@
      limitations under the License.
 -->
 
-<androidx.coordinatorlayout.widget.CoordinatorLayout xmlns:android="http://schemas.android.com/apk/res/android"
+<androidx.coordinatorlayout.widget.CoordinatorLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
     android:id="@+id/peek_container"
     android:layout_width="match_parent"
     android:layout_height="match_parent"
-    android:background="@color/peek_overlay_background"
-    android:focusable="false" />
+    android:background="@color/peek_overlay_scrim"
+    android:clickable="true"
+    android:focusable="false">
+
+    <FrameLayout
+        android:id="@+id/peek_preview_container"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent">
+
+        <FrameLayout
+            android:id="@+id/peek_preview_frame"
+            android:layout_width="match_parent"
+            android:layout_height="match_parent" />
+        <!-- Text and icons using android:white because the underlying black scrim doesn't
+        dynamically change colour. -->
+        <com.google.android.material.appbar.MaterialToolbar
+            android:id="@+id/peek_toolbar"
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            android:background="@color/peek_topbar_scrim"
+            android:paddingEnd="@dimen/space_extra_small_4"
+            android:paddingStart="@dimen/space_extra_small_4"
+            app:navigationContentDescription="@string/a11y_peek_navigation_icon"
+            app:navigationIcon="@drawable/ic_arrow_back_m3"
+            app:navigationIconTint="@android:color/white"
+            app:titleMarginStart="@dimen/space_extra_small_2"
+            app:titleTextAppearance="@style/PeekTopBarTitleText" />
+    </FrameLayout>
+
+    <FrameLayout
+        android:id="@+id/peek_metadata_container"
+        android:layout_width="wrap_content"
+        android:layout_height="match_parent"
+        android:layout_gravity="end"
+        app:coplanarSiblingViewId="@id/peek_preview_container"
+        app:layout_behavior="com.google.android.material.sidesheet.SideSheetBehavior" />
+</androidx.coordinatorlayout.widget.CoordinatorLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_metadata_layout.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_metadata_layout.xml
new file mode 100644
index 000000000..afeb3ddd5
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_metadata_layout.xml
@@ -0,0 +1,22 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="@dimen/peek_metadata_sheet_width"
+    android:layout_height="match_parent"
+    android:layout_margin="@dimen/space_small_1"
+    android:background="@drawable/peek_metadata_sheet_background"
+    android:backgroundTint="?attr/colorSurfaceContainerHigh"
+    android:orientation="vertical"/>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_no_preview.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_no_preview.xml
new file mode 100644
index 000000000..705329237
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_no_preview.xml
@@ -0,0 +1,36 @@
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<FrameLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/peek_preview_container"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent">
+
+    <ImageView
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:layout_gravity="center"
+        android:contentDescription="@string/peek_no_preview"
+        android:src="@drawable/peek_no_preview_shape" />
+
+    <com.google.android.material.textview.MaterialTextView
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:layout_gravity="center"
+        android:drawablePadding="@dimen/space_small_1"
+        android:drawableTop="@drawable/ic_draft"
+        android:text="@string/peek_no_preview"
+        android:textAppearance="@style/PeekNoPreviewLabelText" />
+</FrameLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/root_vertical_divider.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/root_vertical_divider_m3.xml
similarity index 84%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/root_vertical_divider.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/root_vertical_divider_m3.xml
index 3197d9dce..dd6e3872c 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/root_vertical_divider.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/root_vertical_divider_m3.xml
@@ -23,10 +23,10 @@
     android:layout_height="match_parent"
     android:gravity="start|center_vertical"
     android:orientation="horizontal"
-    android:paddingTop="@dimen/drawer_edge_width"
-    android:paddingBottom="@dimen/drawer_edge_width"
-    android:paddingStart="@dimen/grid_padding_horiz"
-    android:paddingEnd="@dimen/grid_padding_horiz"
+    android:paddingTop="@dimen/drawer_edge_width_m3"
+    android:paddingBottom="@dimen/drawer_edge_width_m3"
+    android:paddingStart="@dimen/grid_padding_horiz_m3"
+    android:paddingEnd="@dimen/grid_padding_horiz_m3"
     android:visibility="gone">
     <View
         android:layout_width="1dp"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_item.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_item_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_item.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_item_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_row.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_row_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_row.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_row_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/search_options_row.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/search_options_row.xml
new file mode 100644
index 000000000..3e576bd32
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/search_options_row.xml
@@ -0,0 +1,57 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<HorizontalScrollView
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    android:id="@+id/search_options_row"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content"
+    android:visibility="gone"
+    android:scrollbars="none">
+
+    <com.google.android.material.chip.ChipGroup
+        android:id="@+id/search_options_container"
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:paddingHorizontal="@dimen/space_small_4"
+        android:paddingVertical="@dimen/space_extra_small_4">
+        <com.google.android.material.chip.Chip
+            android:id="@+id/search_location_trigger"
+            style="@style/SearchOptionsTriggerStyle"
+            app:chipIcon="@drawable/ic_search_location"
+            app:chipIconVisible="true"
+            app:closeIcon="@drawable/ic_arrow_drop_down"
+            app:closeIconVisible="true"
+            android:text="@string/search_location_this_folder" />
+        <com.google.android.material.chip.Chip
+            android:id="@+id/search_last_modified_trigger"
+            style="@style/SearchOptionsTriggerStyle"
+            app:chipIcon="@drawable/ic_search_last_modified"
+            app:chipIconVisible="true"
+            app:closeIcon="@drawable/ic_arrow_drop_down"
+            app:closeIconVisible="true"
+            android:text="@string/search_last_modified_any_time" />
+        <com.google.android.material.chip.Chip
+            android:id="@+id/search_file_type_trigger"
+            style="@style/SearchOptionsTriggerStyle"
+            app:chipIcon="@drawable/ic_search_file_type"
+            app:chipIconVisible="true"
+            app:closeIcon="@drawable/ic_arrow_drop_down"
+            app:closeIconVisible="true"
+            android:text="@string/search_file_type_all" />
+    </com.google.android.material.chip.ChipGroup>
+</HorizontalScrollView>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/shared_cell_content.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/shared_cell_content_m3.xml
similarity index 75%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/shared_cell_content.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/shared_cell_content_m3.xml
index f269afdbe..cdf7acdbd 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/shared_cell_content.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/shared_cell_content_m3.xml
@@ -16,7 +16,7 @@
   -->
 
 <merge xmlns:android="http://schemas.android.com/apk/res/android">
-    <TextView
+    <com.google.android.material.textview.MaterialTextView
         android:id="@+id/label"
         android:layout_height="wrap_content"
         android:layout_width="wrap_content"
@@ -28,13 +28,14 @@
 
     <ImageView
         android:id="@+id/sort_arrow"
-        android:layout_height="@dimen/doc_header_sort_icon_size"
-        android:layout_width="@dimen/doc_header_sort_icon_size"
-        android:layout_marginStart="3dp"
+        android:layout_height="@dimen/doc_header_sort_icon_height"
+        android:layout_width="@dimen/doc_header_sort_icon_width"
+        android:scaleType="center"
+        android:layout_marginStart="@dimen/doc_header_sort_icon_margin_start"
         android:visibility="gone"
         android:focusable="true"
         android:clickable="true"
-        android:background="?attr/colorSurfaceBright"
-        android:src="@drawable/ic_sort_arrow"
+        android:background="@drawable/sort_icon_background"
+        android:src="@drawable/ic_sort_arrow_m3"
         android:contentDescription="@null"/>
-</merge>
\ No newline at end of file
+</merge>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/sort_list_item.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/sort_list_item_m3.xml
similarity index 65%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/sort_list_item.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/sort_list_item_m3.xml
index ed25bf809..9dcd73f0b 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/sort_list_item.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/sort_list_item_m3.xml
@@ -17,9 +17,11 @@
 <CheckedTextView xmlns:android="http://schemas.android.com/apk/res/android"
                  android:id="@android:id/text1"
                  android:layout_width="match_parent"
-                 android:layout_height="?android:attr/listPreferredItemHeightSmall"
-                 android:textAppearance="@style/SortList"
+                 android:layout_height="@dimen/bottom_sheet_sort_item_height"
+                 android:textAppearance="@style/SortListM3"
+                 android:background="@drawable/sort_list_item_background"
                  android:gravity="center_vertical"
-                 android:checkMark="@drawable/list_checker"
-                 android:paddingStart="?android:attr/listPreferredItemPaddingStart"
-                 android:paddingEnd="?android:attr/listPreferredItemPaddingEnd" />
\ No newline at end of file
+                 android:focusable="true"
+                 android:clickable="true"
+                 android:paddingHorizontal="@dimen/bottom_sheet_sort_item_padding_horizontal"
+                 android:paddingVertical="@dimen/bottom_sheet_sort_item_padding_vertical" />
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/table_key_value_row.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/table_key_value_row_m3.xml
similarity index 86%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout/table_key_value_row.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/table_key_value_row_m3.xml
index 5214133dd..6e00790aa 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/table_key_value_row.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/table_key_value_row_m3.xml
@@ -22,7 +22,7 @@
     android:paddingStart="30dp"
     android:paddingEnd="30dp">
 
-    <TextView
+    <com.google.android.material.textview.MaterialTextView
         android:id="@+id/table_row_key"
         android:layout_height="wrap_content"
         android:layout_width="0dp"
@@ -31,10 +31,9 @@
         android:paddingBottom="13dp"
         android:paddingEnd="5dp"
         android:textAlignment="viewStart"
-        android:textAppearance="?attr/textAppearanceSubtitle1">
-    </TextView>
+        android:textAppearance="?attr/textAppearanceSubtitle1" />
 
-    <TextView
+    <com.google.android.material.textview.MaterialTextView
         android:id="@+id/table_row_value"
         android:layout_height="wrap_content"
         android:layout_width="0dp"
@@ -44,7 +43,6 @@
         android:clickable="false"
         android:textIsSelectable="true"
         android:textAlignment="viewStart"
-        android:textAppearance="@style/InspectorKeySubTitle">
-    </TextView>
+        android:textAppearance="@style/InspectorKeySubTitleM3" />
 
 </com.android.documentsui.inspector.KeyValueRow>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/action_mode_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/action_mode_menu_m3.xml
similarity index 81%
rename from res/flag(com.android.documentsui.flags.use_material3)/menu/action_mode_menu.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/menu/action_mode_menu_m3.xml
index c9c139cc9..765fd74f9 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/menu/action_mode_menu.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/action_mode_menu_m3.xml
@@ -14,6 +14,13 @@
      limitations under the License.
 -->
 
+<!--
+     All of the `item`'s below have both `android:showAsAction` and `app:showAsAction`
+     intentionally. This is because when the `use_material3` flag is disabled, the menu is inflated
+     into a menu via ActionMode and when the flag is enabled it is inflated into a MaterialToolbar.
+     The former requires `android:showAsAction` whilst the latter requires `app:showAsAction`. When
+     the `use_material3` flag has rolled out by default, the `android:showAsAction` can be removed.
+-->
 <menu
     xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:app="http://schemas.android.com/apk/res-auto">
@@ -24,19 +31,19 @@
         app:showAsAction="never" />
     <item
         android:id="@+id/action_menu_share"
-        android:icon="@drawable/ic_menu_share"
+        android:icon="@drawable/ic_menu_share_m3"
         android:title="@string/menu_share"
         android:showAsAction="always"
         app:showAsAction="always" />
     <item
         android:id="@+id/action_menu_delete"
-        android:icon="@drawable/ic_menu_delete"
+        android:icon="@drawable/ic_menu_delete_m3"
         android:title="@string/menu_delete"
         android:showAsAction="always"
         app:showAsAction="always" />
     <item
         android:id="@+id/action_menu_sort"
-        android:icon="@drawable/ic_sort"
+        android:icon="@drawable/ic_sort_m3"
         android:title="@string/menu_sort"
         android:showAsAction="never"
         app:showAsAction="never" />
@@ -64,10 +71,10 @@
     <item
         android:id="@+id/action_menu_extract_to"
         android:title="@string/menu_extract"
-        android:icon="@drawable/ic_menu_extract"
-        android:showAsAction="always"
+        android:icon="@drawable/ic_menu_extract_m3"
+        android:showAsAction="never"
         android:visible="false"
-        app:showAsAction="always" />
+        app:showAsAction="never" />
     <item
         android:id="@+id/action_menu_move_to"
         android:title="@string/menu_move"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/activity.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/activity_m3.xml
similarity index 85%
rename from res/flag(com.android.documentsui.flags.use_material3)/menu/activity.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/menu/activity_m3.xml
index 809a1386a..4b6283c24 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/menu/activity.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/activity_m3.xml
@@ -17,6 +17,15 @@
 <menu
     xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:app="http://schemas.android.com/apk/res-auto">
+<!-- The docked search bar is only visible on larger screens. -->
+    <item
+        android:id="@+id/option_menu_docked_search"
+        android:title="@string/menu_search"
+        android:icon="@drawable/ic_menu_search"
+        android:imeOptions="actionSearch"
+        android:visible="false"
+        app:showAsAction="always"
+        app:actionLayout="@layout/docked_search_bar" />
 <!-- showAsAction flag impacts the behavior of SearchView.
      When set to collapseActionView, collapsing SearchView to icon is the
      default behavior. It would fit UX, however after expanding SearchView is
@@ -28,7 +37,7 @@
     <item
         android:id="@+id/option_menu_search"
         android:title="@string/menu_search"
-        android:icon="@drawable/ic_menu_search"
+        android:icon="@drawable/ic_menu_search_m3"
         android:imeOptions="actionSearch"
         android:visible="false"
         app:showAsAction="always|collapseActionView"
@@ -42,19 +51,19 @@
     <item
         android:id="@+id/sub_menu_grid"
         android:title="@string/menu_grid"
-        android:icon="@drawable/ic_menu_view_grid"
+        android:icon="@drawable/ic_menu_view_grid_m3"
         app:showAsAction="always" />
     <item
         android:id="@+id/sub_menu_list"
         android:title="@string/menu_list"
-        android:icon="@drawable/ic_menu_view_list"
+        android:icon="@drawable/ic_menu_view_list_m3"
         app:showAsAction="always" />
 <!-- This group is being hidden when searching is in full bar mode-->
     <group android:id="@+id/group_hide_when_searching">
         <item
             android:id="@+id/option_menu_debug"
             android:title="Debug"
-            android:icon="@drawable/ic_debug_menu"
+            android:icon="@drawable/ic_debug_menu_m3"
             android:visible="false"
             app:showAsAction="always"/>
         <item
@@ -66,14 +75,14 @@
         <item
             android:id="@+id/option_menu_create_dir"
             android:title="@string/menu_create_dir"
-            android:icon="@drawable/ic_create_new_folder"
+            android:icon="@drawable/ic_create_new_folder_m3"
             android:alphabeticShortcut="e"
             android:visible="false"
             app:showAsAction="never"/>
         <item
             android:id="@+id/option_menu_sort"
             android:title="@string/menu_sort"
-            android:icon="@drawable/ic_sort"
+            android:icon="@drawable/ic_sort_m3"
             android:showAsAction="never"
             android:visible="false" />
         <item
@@ -85,7 +94,7 @@
         <item
             android:id="@+id/option_menu_extract_all"
             android:title="@string/menu_extract_all"
-            android:icon="@drawable/ic_menu_extract"
+            android:icon="@drawable/ic_menu_extract_m3"
             android:enabled="false"
             android:visible="false"
             app:showAsAction="always"/>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/container_context_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/container_context_menu_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/menu/container_context_menu.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/menu/container_context_menu_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/dir_context_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/dir_context_menu_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/menu/dir_context_menu.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/menu/dir_context_menu_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/file_context_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/file_context_menu_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/menu/file_context_menu.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/menu/file_context_menu_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/mixed_context_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/mixed_context_menu_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/menu/mixed_context_menu.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/menu/mixed_context_menu_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/root_context_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/root_context_menu_m3.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/menu/root_context_menu.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/menu/root_context_menu_m3.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/search_file_type_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/search_file_type_menu.xml
new file mode 100644
index 000000000..d04a88c13
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/search_file_type_menu.xml
@@ -0,0 +1,34 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+  -->
+
+<!-- Dropdown menu showing possible file type options (any type, documents, audio, etc.) -->
+<menu xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:id="@+id/file_type_all_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/search_file_type_all" />
+    <item android:id="@+id/file_type_audio_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/chip_title_audio" />
+    <item android:id="@+id/file_type_documents_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/chip_title_documents" />
+    <item android:id="@+id/file_type_images_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/chip_title_images" />
+    <item android:id="@+id/file_type_videos_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/chip_title_videos" />
+</menu>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/search_last_modified_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/search_last_modified_menu.xml
new file mode 100644
index 000000000..78851ae3f
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/search_last_modified_menu.xml
@@ -0,0 +1,37 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+  -->
+
+<!-- Dropdown menu showing possible limits on the last modified values. -->
+<menu xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:id="@+id/last_modified_any_time_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/search_last_modified_any_time" />
+    <item android:id="@+id/last_modified_1_day_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/search_last_modified_1_day" />
+    <item android:id="@+id/last_modified_2_days_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/search_last_modified_2_days" />
+    <item android:id="@+id/last_modified_7_days_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/search_last_modified_7_days" />
+    <item android:id="@+id/last_modified_30_days_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/search_last_modified_30_days" />
+    <item android:id="@+id/last_modified_365_days_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/search_last_modified_365_days" />
+</menu>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/search_location_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/search_location_menu.xml
new file mode 100644
index 000000000..02ff42680
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/search_location_menu.xml
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+  -->
+
+<!-- Dropdown menu showing possible search locations (this folder, root folder, everywhere). -->
+<menu xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:id="@+id/everywhere_options"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/search_location_everywhere" />
+    <item android:id="@+id/root_folder_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/search_location_root_folder" />
+    <item android:id="@+id/this_folder_option"
+        android:icon="@drawable/ic_done_m3"
+        android:title="@string/search_location_this_folder" />
+</menu>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/colors.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/colors_m3.xml
similarity index 59%
rename from res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/colors.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/colors_m3.xml
index 72dd819bb..7e5d87af8 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/colors.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/colors_m3.xml
@@ -14,31 +14,12 @@
 -->
 
 <resources>
+  <!-- ?attr/colorSurfaceContainer -->
+  <color name="app_background_color_m3">@color/m3_ref_palette_dynamic_neutral_variant12</color>
   <!-- ?attr/colorPrimary -->
-  <color name="primary">@android:color/system_accent1_200</color>
-  <color name="work_profile_button_stroke_color">
-    @*android:color/system_accent1_200
-  </color> <!-- accent 200 -->
-  <color name="empty_state_text_color">@*android:color/system_neutral1_100
-  </color>
-  <!-- neutral 100 -->
-  <color name="empty_state_message_text_color">
-    @*android:color/system_neutral2_200
-  </color>
-  <!-- neutral variant 100 -->
-  <color name="fragment_pick_inactive_button_color">
-    @*android:color/system_neutral1_800
-  </color>
-  <!-- neutral 100 -->
-  <color name="fragment_pick_inactive_text_color">
-    @*android:color/system_neutral1_600
-  </color>
-  <!-- neutral 600 -->
-  <color name="fragment_pick_active_button_color">
-    @*android:color/system_neutral2_100
-  </color>
-  <!-- neutral variant 100 -->
-  <color name="fragment_pick_active_text_color">@android:color/black</color>
+  <color name="primary_m3">@android:color/system_accent1_200</color>
+  <!-- ?attr/colorSurfaceContainerHigh -->
+  <color name="color_surface_header_m3">@color/m3_ref_palette_dynamic_neutral_variant17</color>
 
   <!-- All drag drop badge colors, we can only use system color tokens because there's no theme
        context inside the view.
@@ -48,7 +29,7 @@
   <!-- ?attr/colorOnTertiary -->
   <color name="drag_file_counter_text_color">@android:color/system_accent3_800</color>
   <!-- ?attr/colorSurfaceDim -->
-  <color name="item_drag_shadow_background">@color/m3_ref_palette_dynamic_neutral_variant6</color>
+  <color name="item_drag_shadow_background_m3">@color/m3_ref_palette_dynamic_neutral_variant6</color>
   <!-- ?attr/colorSurfaceContainerLowest -->
   <color name="drag_mime_icon_wrapper_background">
     @color/m3_ref_palette_dynamic_neutral_variant4
@@ -56,7 +37,7 @@
   <!-- ?attr/colorOnSurface -->
   <color name="drag_content_text_color">@android:color/system_neutral1_100</color>
   <!-- ?attr/colorOnError -->
-  <color name="drop_icon_symbol_color">@color/m3_ref_palette_error20</color>
+  <color name="drop_icon_reject_symbol_color">@color/m3_ref_palette_error20</color>
   <!-- ?attr/colorError -->
   <color name="drop_icon_reject_container_background">@color/m3_ref_palette_error80</color>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/styles.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/styles.xml
deleted file mode 100644
index 23fcdfaf0..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/styles.xml
+++ /dev/null
@@ -1,31 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!--
-  ~ Copyright (C) 2024 The Android Open Source Project
-  ~
-  ~ Licensed under the Apache License, Version 2.0 (the "License");
-  ~ you may not use this file except in compliance with the License.
-  ~ You may obtain a copy of the License at
-  ~
-  ~      http://www.apache.org/licenses/LICENSE-2.0
-  ~
-  ~ Unless required by applicable law or agreed to in writing, software
-  ~ distributed under the License is distributed on an "AS IS" BASIS,
-  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-  ~ See the License for the specific language governing permissions and
-  ~ limitations under the License.
-  -->
-
-<resources>
-    <style name="TabTextAppearance" parent="@style/TextAppearance.Material3.TitleMedium">
-        <item name="android:textSize">14sp</item>
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-        <item name="android:textColor">?android:attr/colorAccent</item>
-    </style>
-
-    <style name="EmptyStateButton" parent="@style/Widget.Material3.Button.OutlinedButton">
-        <item name="android:backgroundTint">@android:color/transparent</item>
-        <item name="android:textColor">@*android:color/system_neutral1_100</item>
-        <item name="android:textAllCaps">false</item>
-        <item name="android:textAppearance">@style/EmptyStateButtonTextAppearance</item>
-    </style>
-</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-night/colors.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-night/colors.xml
deleted file mode 100644
index b3cd1dae3..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-night/colors.xml
+++ /dev/null
@@ -1,39 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-<resources>
-    <color name="app_background_color">#202124</color>
-    <color name="background_floating">#3C4043</color>
-    <color name="nav_bar_translucent">#52000000</color>
-
-    <!-- ?attr/colorPrimary -->
-    <color name="primary">#D0BCFF</color>
-    <color name="secondary">#3D8AB4F8</color>
-    <color name="hairline">#5F6368</color>
-
-    <color name="empty_state_text_color">@android:color/white</color>
-    <color name="error_image_color">@android:color/white</color>
-
-    <color name="edge_effect">@android:color/white</color>
-
-    <color name="list_divider_color">#9aa0a6</color>
-
-    <color name="color_surface_header">@color/m3_ref_palette_dynamic_neutral_variant17</color>
-
-    <color name="fragment_pick_active_text_color">#202124</color> <!-- Grey 900 -->
-
-    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
-    <color name="search_chip_text_selected_color">@android:color/black</color>
-</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-night/colors_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-night/colors_m3.xml
new file mode 100644
index 000000000..b9c88aa1a
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-night/colors_m3.xml
@@ -0,0 +1,48 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<resources>
+    <!-- ?attr/colorSurfaceContainer -->
+    <color name="app_background_color_m3">#211F26</color>
+
+    <!-- ?attr/colorPrimary -->
+    <color name="primary_m3">#D0BCFF</color>
+
+    <color name="success">#3CBA5A</color>
+    <color name="on_success">#002110</color>
+
+    <!-- ?attr/colorTertiary -->
+    <color name="drag_file_counter_background">#EFB8C8</color>
+    <!-- ?attr/colorOnTertiary -->
+    <color name="drag_file_counter_text_color">#492532</color>
+    <!-- ?attr/colorSurfaceDim -->
+    <color name="item_drag_shadow_background_m3">#141218</color>
+    <!-- ?attr/colorSurfaceContainerLowest -->
+    <color name="drag_mime_icon_wrapper_background">#0F0D13</color>
+    <!-- ?attr/colorOnSurface -->
+    <color name="drag_content_text_color">#E6E0E9</color>
+    <!-- ?attr/colorOnError -->
+    <color name="drop_icon_reject_symbol_color">#601410</color>
+    <!-- ?attr/colorError -->
+    <color name="drop_icon_reject_container_background">#F2B8B5</color>
+
+    <color name="error_image_color_m3">@android:color/white</color>
+
+    <!-- ?attr/colorSurfaceContainerHigh -->
+    <color name="color_surface_header_m3">#2B2930</color>
+
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+    <color name="search_chip_text_selected_color_m3">@android:color/black</color>
+</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-night/themes.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-night/themes.xml
deleted file mode 100644
index e8e801793..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-night/themes.xml
+++ /dev/null
@@ -1,46 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-
-<resources xmlns:android="http://schemas.android.com/apk/res/android">
-    <style name="LauncherTheme" parent="DocumentsTheme">
-        <item name="android:windowBackground">@drawable/launcher_screen_night</item>
-    </style>
-    <style name="DocumentsTheme" parent="@android:style/Theme.DeviceDefault.DocumentsUI">
-
-        <!-- Toolbar -->
-        <item name="android:actionModeBackground">?android:attr/colorBackground</item>
-
-        <!-- Color section -->
-        <item name="android:colorAccent">@color/primary</item>
-        <item name="android:colorBackground">@color/app_background_color</item>
-        <item name="android:colorBackgroundFloating">@color/background_floating</item>
-        <item name="android:colorControlHighlight">@color/ripple_material_dark</item>
-        <item name="android:colorControlActivated">@color/primary</item>
-        <item name="android:colorPrimary">@color/primary</item>
-        <item name="android:colorSecondary">@color/secondary</item>
-        <item name="android:strokeColor">@color/hairline</item>
-
-        <!-- System | Widget section -->
-        <item name="android:listDivider">@drawable/list_divider</item>
-        <item name="android:statusBarColor">?android:attr/colorBackground</item>
-        <item name="android:windowBackground">?android:attr/colorBackground</item>
-        <item name="android:windowLightStatusBar">false</item>
-        <item name="android:windowLightNavigationBar">false</item>
-        <item name="android:windowNoTitle">true</item>
-        <item name="android:windowSoftInputMode">stateUnspecified|adjustUnspecified</item>
-
-    </style>
-</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-night/themes_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-night/themes_m3.xml
new file mode 100644
index 000000000..57baf9d56
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-night/themes_m3.xml
@@ -0,0 +1,30 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android">
+    <style name="DocumentsThemeM3" parent="@android:style/Theme.DeviceDefault.DocumentsUI">
+
+        <!-- these system bar colors are required for SDK 30 -->
+        <item name="android:statusBarColor">@color/app_background_color_m3</item>
+        <item name="android:navigationBarColor">@color/app_background_color_m3</item>
+
+        <item name="android:windowLightStatusBar">false</item>
+        <item name="android:windowLightNavigationBar">false</item>
+        <item name="android:windowNoTitle">true</item>
+        <item name="android:windowSoftInputMode">stateUnspecified|adjustUnspecified</item>
+
+    </style>
+</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/colors.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/colors_m3.xml
similarity index 59%
rename from res/flag(com.android.documentsui.flags.use_material3)/values-v31/colors.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-v31/colors_m3.xml
index 27b636fe1..649d1703c 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/colors.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/colors_m3.xml
@@ -14,31 +14,12 @@
 -->
 
 <resources>
+  <!-- ?attr/colorSurfaceContainer -->
+  <color name="app_background_color_m3">@color/m3_ref_palette_dynamic_neutral_variant94</color>
   <!-- ?attr/colorPrimary -->
-  <color name="primary">@android:color/system_accent1_600</color>
-  <!-- neutral variant 700-->
-  <color name="work_profile_button_stroke_color">
-    @*android:color/system_accent1_600
-  </color> <!-- primary 600 -->
-  <color name="empty_state_text_color">@*android:color/system_neutral1_900
-  </color>
-  <!-- neutral 900 -->
-  <color name="empty_state_message_text_color">
-    @*android:color/system_neutral2_700
-  </color>
-  <!-- neutral 10 -->
-  <color name="fragment_pick_inactive_button_color">
-    @*android:color/system_neutral1_100
-  </color>
-  <!-- neutral 100 -->
-  <color name="fragment_pick_inactive_text_color">
-    @*android:color/system_neutral1_400
-  </color>
-  <!-- neutral 400 -->
-  <color name="fragment_pick_active_button_color">@*android:color/system_accent1_600
-  </color>
-  <!-- accent 600 -->
-  <color name="fragment_pick_active_text_color">@android:color/white</color>
+  <color name="primary_m3">@android:color/system_accent1_600</color>
+  <!-- ?attr/colorSurfaceContainerHigh -->
+  <color name="color_surface_header_m3">@color/m3_ref_palette_dynamic_neutral_variant92</color>
 
   <!-- All drag drop badge colors, we can only use system color tokens because there's no theme
        context inside the view.
@@ -48,13 +29,13 @@
   <!-- ?attr/colorOnTertiary -->
   <color name="drag_file_counter_text_color">@android:color/system_accent3_0</color>
   <!-- ?attr/colorSurfaceDim -->
-  <color name="item_drag_shadow_background">@color/m3_ref_palette_dynamic_neutral_variant87</color>
+  <color name="item_drag_shadow_background_m3">@color/m3_ref_palette_dynamic_neutral_variant87</color>
   <!-- ?attr/colorSurfaceContainerLowest -->
   <color name="drag_mime_icon_wrapper_background">@android:color/system_neutral2_0</color>
   <!-- ?attr/colorOnSurface -->
   <color name="drag_content_text_color">@android:color/system_neutral1_900</color>
   <!-- ?attr/colorOnError -->
-  <color name="drop_icon_symbol_color">@android:color/white</color>
+  <color name="drop_icon_reject_symbol_color">@android:color/white</color>
   <!-- ?attr/colorError -->
   <color name="drop_icon_reject_container_background">@color/m3_ref_palette_error40</color>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/dimens.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/dimens.xml
deleted file mode 100644
index 07630714f..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/dimens.xml
+++ /dev/null
@@ -1,28 +0,0 @@
-<!--
-  ~ Copyright (C) 2024 The Android Open Source Project
-  ~
-  ~ Licensed under the Apache License, Version 2.0 (the "License");
-  ~ you may not use this file except in compliance with the License.
-  ~ You may obtain a copy of the License at
-  ~
-  ~      http://www.apache.org/licenses/LICENSE-2.0
-  ~
-  ~ Unless required by applicable law or agreed to in writing, software
-  ~ distributed under the License is distributed on an "AS IS" BASIS,
-  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-  ~ See the License for the specific language governing permissions and
-  ~ limitations under the License.
-  -->
-<resources>
-    <dimen name="action_bar_elevation">0dp</dimen>
-    <dimen name="action_bar_margin">0dp</dimen>
-    <dimen name="button_corner_radius">20dp</dimen>
-    <dimen name="tab_selector_indicator_height">0dp</dimen>
-    <dimen name="tab_height">36dp</dimen>
-    <dimen name="tab_container_height">48dp</dimen>
-    <dimen name="profile_tab_margin_top">0dp</dimen>
-    <dimen name="profile_tab_margin_side">@dimen/space_extra_small_4</dimen>
-    <dimen name="cross_profile_button_corner_radius">30dp</dimen>
-    <dimen name="cross_profile_button_stroke_width">1dp</dimen>
-    <dimen name="cross_profile_button_message_margin_top">16dp</dimen>
-</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_briefcase.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/dimens_m3.xml
similarity index 54%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_briefcase.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-v31/dimens_m3.xml
index 8fc7d4a44..b30badd9c 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_briefcase.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/dimens_m3.xml
@@ -13,13 +13,13 @@
   ~ See the License for the specific language governing permissions and
   ~ limitations under the License.
   -->
-
-<vector xmlns:android="http://schemas.android.com/apk/res/android"
-    android:width="24dp"
-    android:height="24dp"
-    android:viewportWidth="24"
-    android:viewportHeight="24">
-  <path
-      android:fillColor="?android:attr/colorAccent"
-      android:pathData="M20,6h-4L16,4c0,-1.11 -0.89,-2 -2,-2h-4c-1.11,0 -2,0.89 -2,2v2L4,6c-1.11,0 -1.99,0.89 -1.99,2L2,19c0,1.11 0.89,2 2,2h16c1.11,0 2,-0.89 2,-2L22,8c0,-1.11 -0.89,-2 -2,-2zM12,15c-1.1,0 -2,-0.9 -2,-2s0.9,-2 2,-2 2,0.9 2,2 -0.9,2 -2,2zM14,6h-4L10,4h4v2z"/>
-</vector>
+<resources>
+    <dimen name="action_bar_elevation_m3">0dp</dimen>
+    <dimen name="action_bar_margin_m3">0dp</dimen>
+    <dimen name="button_corner_radius_m3">20dp</dimen>
+    <dimen name="tab_selector_indicator_height_m3">0dp</dimen>
+    <dimen name="tab_height_m3">36dp</dimen>
+    <dimen name="tab_container_height_m3">48dp</dimen>
+    <dimen name="profile_tab_margin_top_m3">0dp</dimen>
+    <dimen name="profile_tab_margin_side_m3">@dimen/space_extra_small_4</dimen>
+</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/styles.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/styles.xml
deleted file mode 100644
index 4f459253a..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/styles.xml
+++ /dev/null
@@ -1,45 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?><!--
-  ~ Copyright (C) 2024 The Android Open Source Project
-  ~
-  ~ Licensed under the Apache License, Version 2.0 (the "License");
-  ~ you may not use this file except in compliance with the License.
-  ~ You may obtain a copy of the License at
-  ~
-  ~      http://www.apache.org/licenses/LICENSE-2.0
-  ~
-  ~ Unless required by applicable law or agreed to in writing, software
-  ~ distributed under the License is distributed on an "AS IS" BASIS,
-  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-  ~ See the License for the specific language governing permissions and
-  ~ limitations under the License.
-  -->
-
-<resources>
-
-  <style name="SectionHeader" parent="@style/TextAppearance.Material3.TitleMedium">
-    <item name="android:textColor">?android:attr/textColorPrimary</item>
-    <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    <item name="android:textSize">12sp</item>
-  </style>
-
-  <style name="MaterialButton" parent="@style/Widget.Material3.Button.UnelevatedButton">
-    <item name="android:textAppearance">@style/MaterialButtonTextAppearance
-    </item>
-    <item name="android:backgroundTint">?android:colorAccent</item>
-  </style>
-
-  <style name="MaterialOutlinedButton" parent="@style/Widget.Material3.Button.OutlinedButton">
-    <item name="android:textAppearance">@style/MaterialButtonTextAppearance
-    </item>
-    <item name="android:backgroundTint">@android:color/white</item>
-    <item name="android:textColor">?android:colorAccent</item>
-  </style>
-
-  <style name="EmptyStateButton" parent="@style/Widget.Material3.Button.OutlinedButton">
-    <item name="android:backgroundTint">@android:color/transparent</item>
-    <item name="android:textColor">@*android:color/system_neutral1_900</item>
-    <item name="android:textAllCaps">false</item>
-    <item name="android:textAppearance">@style/EmptyStateButtonTextAppearance
-    </item>
-  </style>
-</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/styles_text.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/styles_text.xml
deleted file mode 100644
index d69d83c93..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/styles_text.xml
+++ /dev/null
@@ -1,28 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-<resources>
-    <style name="EmptyStateTitleText">
-        <item name="android:textColor">@color/empty_state_text_color</item>
-        <item name="android:textSize">18sp</item>
-        <item name="fontFamily">@string/config_headerFontFamily</item>
-    </style>
-
-    <style name="EmptyStateMessageText">
-        <item name="android:textColor">@color/empty_state_message_text_color</item>
-        <item name="android:textSize">14sp</item>
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-</resources>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/dimens.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp-h600dp/dimens_m3.xml
similarity index 69%
rename from res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/dimens.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-w600dp-h600dp/dimens_m3.xml
index 00c9a662a..0b65809b5 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/dimens.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp-h600dp/dimens_m3.xml
@@ -21,17 +21,19 @@
     <!-- Main margin is set by main_container_padding_start for the menu button, here is for
     the space between the button the text/title, but since on this layout we don't have the button,
     we zero here, to avoid pushing the title further. -->
-    <dimen name="search_bar_text_margin_start">0dp</dimen>
+    <dimen name="search_bar_text_margin_start_m3">0dp</dimen>
 
     <dimen name="toolbar_padding_start">@dimen/main_container_padding_start</dimen>
 
-    <dimen name="list_container_padding">@dimen/space_extra_small_6</dimen>
+    <dimen name="grid_container_padding_left">@dimen/space_small_4</dimen>
+    <dimen name="grid_container_padding_top">@dimen/space_extra_small_4</dimen>
+    <dimen name="grid_container_padding_right">@dimen/space_small_4</dimen>
+    <dimen name="grid_container_padding_bottom">@dimen/space_extra_small_4</dimen>
 
-    <!-- list_container_padding + list_item_padding_start -->
-    <dimen name="table_header_padding_start">28dp</dimen>
-    <!-- list_container_padding + list_item_padding_end -->
-    <dimen name="table_header_padding_end">20dp</dimen>
+    <dimen name="list_container_padding_m3">@dimen/space_small_1</dimen>
 
-    <dimen name="picker_saver_container_padding_bottom">0dp</dimen>
+    <dimen name="breadcrumb_padding_horizontal">@dimen/space_small_3</dimen>
+
+    <dimen name="picker_saver_padding_bottom">0dp</dimen>
 </resources>
 
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/layouts.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp-h600dp/layouts_m3.xml
similarity index 80%
rename from res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/layouts.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-w600dp-h600dp/layouts_m3.xml
index 4b0634d54..ff80b82f6 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/layouts.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp-h600dp/layouts_m3.xml
@@ -15,6 +15,6 @@
 -->
 
 <resources>
-    <item name="documents_activity" type="layout">@layout/nav_rail_layout</item>
-    <item name="files_activity" type="layout">@layout/nav_rail_layout</item>
+    <item name="documents_activity_m3" type="layout">@layout/nav_rail_layout</item>
+    <item name="files_activity_m3" type="layout">@layout/nav_rail_layout</item>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/colors.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/colors_m3.xml
similarity index 91%
rename from res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/colors.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/colors_m3.xml
index ec2e1ff1c..c23d67a3a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/colors.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/colors_m3.xml
@@ -15,5 +15,5 @@
 -->
 
 <resources>
-    <color name="menu_search_background">#ff2852ab</color>
+    <color name="menu_search_background_m3">#ff2852ab</color>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/config_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/config_m3.xml
new file mode 100644
index 000000000..aa957eae1
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/config_m3.xml
@@ -0,0 +1,26 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<resources>
+    <!-- Indicates if search view is taking the whole toolbar space -->
+    <bool name="full_bar_search_view_m3">false</bool>
+
+    <string name="scrolling_behavior_m3" translatable="false">@string/appbar_scrolling_view_behavior</string>
+
+    <!-- Dictates whether we show a search icon or a docked search bar in the toolbar. It's false
+         on small screens to show the icon and true on larger screens to show the docked search. -->
+    <bool name="show_docked_search">true</bool>
+</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/dimens.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/dimens_m3.xml
similarity index 64%
rename from res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/dimens.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/dimens_m3.xml
index 24ff2b17b..49b35f341 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/dimens.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/dimens_m3.xml
@@ -15,20 +15,22 @@
 -->
 <!-- Dimensions/sizes for size Expanded (>=900dp). -->
 <resources>
-    <dimen name="grid_padding_horiz">16dp</dimen>
-    <dimen name="grid_padding_vert">16dp</dimen>
+    <dimen name="grid_padding_horiz_m3">16dp</dimen>
+    <dimen name="grid_padding_vert_m3">16dp</dimen>
 
-    <dimen name="list_item_height">48dp</dimen>
+    <dimen name="list_container_padding_m3">@dimen/space_extra_small_6</dimen>
+    <dimen name="list_item_height_m3">48dp</dimen>
     <dimen name="list_item_padding_start">20dp</dimen>
     <dimen name="list_item_padding_end">0dp</dimen>
     <dimen name="list_item_icon_margin_end">@dimen/space_extra_small_4</dimen>
+    <dimen name="briefcase_icon_margin_m3">@dimen/space_extra_small_4</dimen>
 
-    <dimen name="max_drawer_width">320dp</dimen>
+    <dimen name="max_drawer_width_m3">320dp</dimen>
 
-    <dimen name="search_bar_background_margin_start">120dp</dimen>
-    <dimen name="search_bar_background_margin_end">120dp</dimen>
-    <dimen name="search_bar_text_margin_end">24dp</dimen>
-    <dimen name="search_bar_icon_padding">16dp</dimen>
+    <dimen name="search_bar_background_margin_start_m3">120dp</dimen>
+    <dimen name="search_bar_background_margin_end_m3">120dp</dimen>
+    <dimen name="search_bar_text_margin_end_m3">24dp</dimen>
+    <dimen name="search_bar_icon_padding_m3">16dp</dimen>
 
     <dimen name="main_container_padding_top">@dimen/space_extra_small_6</dimen>
 
@@ -36,9 +38,4 @@
     <dimen name="toolbar_padding_end">@dimen/space_small_3</dimen>
 
     <dimen name="drawer_padding_top">@dimen/space_small_1</dimen>
-
-    <!-- list_container_padding + list_item_padding_start -->
-    <dimen name="table_header_padding_start">32dp</dimen>
-    <!-- list_container_padding + list_item_padding_end -->
-    <dimen name="table_header_padding_end">12dp</dimen>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/layouts.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/layouts_m3.xml
similarity index 80%
rename from res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/layouts.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/layouts_m3.xml
index 9e4109a45..c534282fe 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/layouts.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp-h600dp/layouts_m3.xml
@@ -15,6 +15,6 @@
 -->
 
 <resources>
-    <item name="documents_activity" type="layout">@layout/fixed_layout</item>
-    <item name="files_activity" type="layout">@layout/fixed_layout</item>
+    <item name="documents_activity_m3" type="layout">@layout/fixed_layout_m3</item>
+    <item name="files_activity_m3" type="layout">@layout/fixed_layout_m3</item>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/colors.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/colors.xml
deleted file mode 100644
index fed5a018a..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/values/colors.xml
+++ /dev/null
@@ -1,99 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-
-<resources>
-  <!-- This is the window background, but also the background for anything
-       else that needs to manually declare a background matching the "default"
-       app background (e.g. the drawer overlay). -->
-
-  <color name="app_background_color">@android:color/white</color>
-  <color name="background_floating">@android:color/white</color>
-  <color name="nav_bar_translucent">#99FFFFFF</color>
-
-  <!-- ?attr/colorPrimary -->
-  <color name="primary">#6750A4</color>
-  <color name="secondary">#E3F2FD</color> <!-- Blue 50 -->
-  <color name="hairline">#E0E0E0</color> <!-- Gray 300 -->
-
-  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
-  <color name="chip_background_disable_color">#fff1f3f4</color>
-  <color name="menu_search_background">@android:color/transparent</color>
-  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
-  <color name="item_breadcrumb_background_hovered">#1affffff</color>
-
-  <!-- All the colors used inside the drag drop badge don't support Material color attributes
-       because the drag view and shadow are isolated views rendered without theme context, so
-       we need to use static colors for SDK <= 30, and use system color tokens for SDK >= 31.
-       Check the variables with the same name defined in the v31 version of colors.xml.
-  -->
-  <color name="item_drag_shadow_background">#E3D7DD</color>
-  <color name="item_drag_shadow_container_background">
-    @android:color/transparent
-  </color>
-  <color name="drag_file_counter_background">#825344</color>
-  <color name="drag_file_counter_text_color">@android:color/white</color>
-  <color name="drag_mime_icon_wrapper_background">@android:color/white</color>
-  <color name="drag_content_text_color">#201A1E</color>
-  <color name="drop_icon_symbol_color">@android:color/white</color>
-  <color name="drop_icon_copy_container_background">#1EA446</color>
-  <color name="drop_icon_reject_container_background">#BA1A1A</color>
-
-  <color name="tool_bar_gradient_max">#7f000000</color>
-
-  <color name="band_select_background">?attr/colorPrimaryInverse</color>
-  <color name="band_select_border">?attr/colorPrimaryContainer</color>
-
-  <color name="downloads_icon_background">#ff4688f2</color>
-  <color name="app_icon_background">#ff4688f2</color>
-  <color name="shortcut_foreground">#ff3367d6</color>
-  <color name="shortcut_background">#fff5f5f5</color>
-
-  <color name="empty_state_text_color">#202124</color>
-  <color name="error_image_color">#757575</color>
-
-  <color name="edge_effect">@android:color/black</color>
-
-  <color name="list_divider_color">#1f000000</color>
-  <color name="list_item_selected_background_color">?attr/colorPrimaryContainer</color>
-  <!-- This is used when the app bar is in pinned mode inside the CollapsingToolbarLayout.
-       The code in NavigationViewManager assume the value should be a plain color value so we can't
-       use the theme attribute "?attr/colorSurfaceContainerHigh" (which is a reference) here, hence
-       using the mapped system color in both here and dark mode.
-  -->
-  <color name="color_surface_header">@color/m3_ref_palette_dynamic_neutral_variant92</color>
-
-  <color name="work_profile_button_stroke_color">@color/primary</color>
-
-  <color name="fragment_pick_inactive_button_color">#E0E0E0</color>
-  <color name="fragment_pick_inactive_text_color">#5F6368</color>
-  <color name="fragment_pick_active_button_color">@color/primary</color>
-  <color name="fragment_pick_active_text_color">@android:color/white</color>
-
-  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
-  <color name="search_chip_text_selected_color">@android:color/white</color>
-
-  <!-- Use this when we need to set alpha channel on top of a theme attribute color in the
-       color selector list, e.g. to set colorOnSecondaryContainer with a hover overlay alpha, use:
-
-       <shape android:tint="?attr/colorOnSecondaryContainer">
-          <solid android:color="@color/overlay_hover_color_percentage"/>
-       </shape>
-   -->
-  <color name="overlay_hover_color_percentage">#14000000</color> <!-- 8% -->
-
-  <!-- Peek overlay static color. Makes the background dimmer with an 80% opacity. This color is not
-  intended to be dynamic, and is defined specifically for Peek. -->
-  <color name="peek_overlay_background">#CC000000</color> <!-- 80% -->
-</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/colors_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/colors_m3.xml
new file mode 100644
index 000000000..620c75602
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/colors_m3.xml
@@ -0,0 +1,126 @@
+<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<resources>
+  <!-- This is the window background, but also the background for anything
+       else that needs to manually declare a background matching the "default"
+       app background (e.g. the drawer overlay). -->
+  <!-- ?attr/colorSurfaceContainer -->
+  <color name="app_background_color_m3">#F3EDF7</color>
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+  <color name="background_floating_m3">@android:color/white</color>
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+  <color name="nav_bar_translucent_m3">#99FFFFFF</color>
+
+  <!-- ?attr/colorPrimary -->
+  <color name="primary_m3">#6750A4</color>
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+  <color name="secondary_m3">#E3F2FD</color> <!-- Blue 50 -->
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+  <color name="hairline_m3">#E0E0E0</color> <!-- Gray 300 -->
+
+  <color name="success">#187231</color>
+  <color name="on_success">@android:color/white</color>
+
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+  <color name="chip_background_disable_color_m3">#fff1f3f4</color>
+  <color name="menu_search_background_m3">@android:color/transparent</color>
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+  <color name="item_breadcrumb_background_hovered_m3">#1affffff</color>
+
+  <!-- All the colors used inside the drag drop badge don't support Material color attributes
+       because the drag view and shadow are isolated views rendered without theme context, so
+       we need to use static colors for SDK <= 30, and use system color tokens for SDK >= 31.
+       Check the variables with the same name defined in the v31 version of colors.xml.
+  -->
+  <!-- static -->
+  <color name="item_drag_shadow_container_background_m3">@android:color/transparent</color>
+  <!-- ?attr/colorTertiary -->
+  <color name="drag_file_counter_background">#7D5260</color>
+  <!-- ?attr/colorOnTertiary -->
+  <color name="drag_file_counter_text_color">@android:color/white</color>
+  <!-- ?attr/colorSurfaceDim -->
+  <color name="item_drag_shadow_background_m3">#DED8E1</color>
+  <!-- ?attr/colorSurfaceContainerLowest -->
+  <color name="drag_mime_icon_wrapper_background">@android:color/white</color>
+  <!-- ?attr/colorOnSurface -->
+  <color name="drag_content_text_color">#1C1B1F</color>
+  <!-- ?attr/colorOnError -->
+  <color name="drop_icon_reject_symbol_color">@android:color/white</color>
+  <!-- ?attr/colorError -->
+  <color name="drop_icon_reject_container_background">#B3261E</color>
+
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+  <color name="tool_bar_gradient_max_m3">#7f000000</color>
+
+  <!-- drag selection box colors -->
+  <color name="band_select_background_m3">?attr/colorPrimaryInverse</color>
+  <color name="band_select_border_m3">?attr/colorPrimaryContainer</color>
+
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched.
+       This is currently used in ic_launcher_downloads.xml (inside non flagged resource folder),
+       the XML file is not used anymore.
+   -->
+  <color name="downloads_icon_background_m3">#ff4688f2</color>
+  <!-- static color, the app icon background color in the launcher, window bar -->
+  <color name="app_icon_background_m3">#ff4688f2</color>
+  <!-- static color, used in the shortcut icons (triggered by long pressing the launcher icon) -->
+  <color name="shortcut_foreground_m3">#ff3367d6</color>
+  <color name="shortcut_background_m3">#fff5f5f5</color>
+
+  <color name="error_image_color_m3">?attr/colorPrimary</color>
+
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+  <color name="list_divider_color_m3">#1f000000</color>
+
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+  <color name="list_item_selected_background_color_m3">?attr/colorPrimaryContainer</color>
+
+  <!-- This is used when the app bar is in pinned mode inside the CollapsingToolbarLayout.
+       The code in NavigationViewManager assume the value should be a plain color value so we can't
+       use the theme attribute (which is a reference) here, hence using the mapped system color in
+       both here and dark mode.
+  -->
+  <!-- ?attr/colorSurfaceContainerHigh -->
+  <color name="color_surface_header_m3">#ECE6F0</color>
+
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+  <color name="search_chip_text_selected_color_m3">@android:color/white</color>
+
+  <!-- Use this when we need to set alpha channel on top of a theme attribute color in the
+       color selector list, e.g. to set colorOnSecondaryContainer with a hover overlay alpha, use:
+
+       <shape android:tint="?attr/colorOnSecondaryContainer">
+          <solid android:color="@color/overlay_hover_color_percentage"/>
+       </shape>
+   -->
+  <color name="overlay_hover_color_percentage">#14000000</color> <!-- 8% -->
+
+  <!-- 20% black -->
+  <color name="selection_shadow_black">#33000000</color>
+
+  <!-- 5% black -->
+  <color name="selection_circle_black">#0D000000</color>
+
+  <!-- Peek -->
+  <!-- Scrim for the overlay. Static color, 80% opacity in black, defined specifically for Peek. -->
+  <color name="peek_overlay_scrim">#CC000000</color>
+  <!-- Scrim for the Top bar. Static color, 32% opacity in black. The same scrim is used in some
+  parts of Android SysUI, it can't be used directly here. -->
+  <color name="peek_topbar_scrim">#52000000</color>
+
+  <!-- 60% black -->
+  <color name="peek_circle_black">#99000000</color>
+</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/config.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/config_m3.xml
similarity index 74%
rename from res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/config.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values/config_m3.xml
index 21ce0acff..69e12c15e 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/config.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/config_m3.xml
@@ -1,5 +1,5 @@
 <?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
+<!-- Copyright (C) 2025 The Android Open Source Project
 
      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
@@ -16,7 +16,7 @@
 
 <resources>
     <!-- Indicates if search view is taking the whole toolbar space -->
-    <bool name="full_bar_search_view">false</bool>
+    <bool name="full_bar_search_view_m3">true</bool>
 
-    <string name="scrolling_behavior" translatable="false">@string/appbar_scrolling_view_behavior</string>
+    <string name="scrolling_behavior_m3" translatable="false">com.android.documentsui.ui.SearchBarScrollingViewBehavior</string>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/dimens.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/dimens.xml
deleted file mode 100644
index fa9e436ab..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/values/dimens.xml
+++ /dev/null
@@ -1,255 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-
-<!-- Dimensions/sizes for size Compact (<600dp). -->
-<resources>
-    <!-- Material design rounded radius -->
-    <dimen name="material_round_radius">2dp</dimen>
-
-    <dimen name="tab_selector_indicator_height">2dp</dimen>
-    <dimen name="profile_tab_padding">0dp</dimen>
-    <dimen name="grid_container_padding">20dp</dimen>
-    <dimen name="list_container_padding">@dimen/space_extra_small_4</dimen>
-    <dimen name="icon_size">40dp</dimen>
-    <dimen name="button_touch_size">48dp</dimen>
-    <dimen name="root_icon_size">24dp</dimen>
-    <dimen name="thumbnail_clip_corner_radius">6dp</dimen>
-    <dimen name="thumbnail_border_width">1dp</dimen>
-    <!-- TODO(b/379776735): remove this block after use_material3 flag is launched. -->
-    <dimen name="root_icon_margin">0dp</dimen>
-    <dimen name="root_spacer_padding">0dp</dimen>
-    <!-- block end -->
-    <dimen name="root_action_icon_size">24dp</dimen>
-    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
-    <dimen name="root_icon_disabled_alpha">?android:attr/disabledAlpha</dimen>
-    <dimen name="check_icon_size">20dp</dimen>
-    <dimen name="zoom_icon_size">24dp</dimen>
-    <dimen name="list_item_thumbnail_size">40dp</dimen>
-    <dimen name="grid_item_icon_size">30dp</dimen>
-    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
-    <dimen name="progress_bar_height">4dp</dimen>
-    <fraction name="grid_scale_min">85%</fraction>
-    <fraction name="grid_scale_max">200%</fraction>
-    <dimen name="grid_width">150dp</dimen>
-    <dimen name="grid_height">132dp</dimen>
-    <dimen name="grid_section_separator_height">0dp</dimen>
-    <dimen name="grid_item_margin">@dimen/space_small_1</dimen>
-    <dimen name="grid_padding_horiz">4dp</dimen>
-    <dimen name="grid_padding_vert">4dp</dimen>
-    <dimen name="list_item_height">56dp</dimen>
-    <dimen name="list_item_padding_start">16dp</dimen>
-    <dimen name="list_item_padding_end">8dp</dimen>
-    <dimen name="list_item_padding_vertical">4dp</dimen>
-    <dimen name="list_item_icon_margin_end">16dp</dimen>
-    <dimen name="list_item_icon_size">32dp</dimen>
-    <!-- TODO(b/379776735): remove this block after use_material3 flag is launched. -->
-    <dimen name="list_item_width">72dp</dimen>
-    <dimen name="list_item_padding">16dp</dimen>
-    <dimen name="list_item_icon_padding">16dp</dimen>
-    <dimen name="list_divider_inset">72dp</dimen>
-    <!-- block end -->
-    <dimen name="breadcrumb_padding_horizontal">@dimen/space_small_3</dimen>
-    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
-    <dimen name="breadcrumb_item_padding">8dp</dimen>
-    <dimen name="breadcrumb_item_padding_horizontal">12dp</dimen>
-    <dimen name="breadcrumb_item_padding_vertical">6dp</dimen>
-    <dimen name="breadcrumb_item_arrow_padding">@dimen/space_extra_small_2</dimen>
-    <dimen name="breadcrumb_item_height">32dp</dimen>
-    <dimen name="breadcrumb_height">48dp</dimen>
-    <dimen name="breadcrumb_item_arrow_size">16dp</dimen>
-    <dimen name="dir_elevation">8dp</dimen>
-    <dimen name="drag_shadow_size">120dp</dimen>
-    <dimen name="grid_item_padding_start">@dimen/space_extra_small_2</dimen>
-    <dimen name="grid_item_padding_end">@dimen/space_extra_small_2</dimen>
-    <dimen name="grid_item_padding_top">@dimen/space_extra_small_2</dimen>
-    <dimen name="grid_item_thumbnail_width">80dp</dimen>
-    <dimen name="grid_item_thumbnail_height">80dp</dimen>
-    <dimen name="grid_item_thumbnail_radius">12dp</dimen>
-    <dimen name="grid_item_icon_width">64dp</dimen>
-    <dimen name="grid_item_icon_height">64dp</dimen>
-    <dimen name="grid_item_nameplate_width">142dp</dimen>
-    <dimen name="grid_item_nameplate_height">44dp</dimen>
-    <dimen name="grid_item_nameplate_padding">4dp</dimen>
-    <dimen name="grid_item_nameplate_marginTop">@dimen/space_extra_small_2</dimen>
-    <dimen name="grid_item_nameplate_radius">8dp</dimen>
-    <dimen name="grid_item_nameplate_inner_radius">4dp</dimen>
-    <dimen name="grid_item_elevation">2dp</dimen>
-    <dimen name="grid_item_radius">12dp</dimen>
-    <dimen name="max_drawer_width">280dp</dimen>
-    <dimen name="briefcase_icon_margin">8dp</dimen>
-    <dimen name="briefcase_icon_size">14dp</dimen>
-    <dimen name="briefcase_icon_size_photo">24dp</dimen>
-    <dimen name="button_corner_radius">2dp</dimen>
-
-    <!-- list_container_padding + list_item_padding_start -->
-    <dimen name="table_header_padding_start">24dp</dimen>
-    <!-- list_container_padding + list_item_padding_end -->
-    <dimen name="table_header_padding_end">16dp</dimen>
-
-    <dimen name="bottom_sheet_dialog_radius">28dp</dimen>
-
-    <dimen name="drawer_edge_width">12dp</dimen>
-    <dimen name="drawer_padding_horizontal">@dimen/space_extra_small_6</dimen>
-    <dimen name="drawer_padding_top">@dimen/space_small_3</dimen>
-    <dimen name="drawer_padding_bottom">@dimen/space_small_1</dimen>
-    <dimen name="drawer_divider_padding_horizontal">16dp</dimen>
-    <dimen name="drawer_divider_padding_vertical">@dimen/space_extra_small_4</dimen>
-    <dimen name="drawer_item_height">56dp</dimen>
-    <dimen name="drawer_item_vertical_margin">10dp</dimen>
-    <dimen name="drawer_item_text_margin_start">12dp</dimen>
-    <dimen name="drawer_item_action_icon_margin_start">4dp</dimen>
-
-    <dimen name="nav_rail_item_height">64dp</dimen>
-    <dimen name="nav_rail_item_icon_bg_radius">16dp</dimen>
-    <dimen name="nav_rail_item_icon_bg_width">56dp</dimen>
-    <dimen name="nav_rail_item_icon_bg_height">32dp</dimen>
-    <dimen name="nav_rail_burger_icon_size">56dp</dimen>
-
-    <dimen name="drag_content_width">160dp</dimen>
-    <dimen name="drag_content_height">40dp</dimen>
-    <!-- drag_additional_layer_offset + drag_shadow_radius -->
-    <dimen name="drag_content_margin_start">7dp</dimen>
-    <dimen name="drag_content_radius">12dp</dimen>
-    <dimen name="drag_additional_layer_offset">4dp</dimen>
-    <!-- drag_additional_layer_offset + drag_file_counter_offset -->
-    <dimen name="drag_additional_layer_margin_top">12dp</dimen>
-    <dimen name="drag_file_counter_offset">8dp</dimen>
-    <dimen name="drag_file_counter_height">20dp</dimen>
-    <!-- drag shadow width/height need to cater all the elements drawing inside it, including
-         drag content, offset, shadow and drag file counter, so:
-         * width = drag_content_width + drag_file_counter_offset + drag_additional_layer_offset + drag_shadow_radius
-         * width = drag_content_height + drag_file_counter_offset + drag_additional_layer_offset + drag_shadow_radius
-     -->
-    <dimen name="drag_shadow_width">175dp</dimen>
-    <dimen name="drag_shadow_height">55dp</dimen>
-    <dimen name="drag_shadow_radius">3dp</dimen>
-    <dimen name="drag_shadow_2_radius">2dp</dimen>
-    <dimen name="drag_shadow_y_offset">1dp</dimen>
-    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
-    <dimen name="drag_shadow_padding">8dp</dimen>
-
-    <dimen name="drop_mime_icon_wrapper_size">24dp</dimen>
-    <dimen name="drop_mime_icon_wrapper_radius">4dp</dimen>
-    <dimen name="drop_icon_height">14dp</dimen>
-    <dimen name="drop_icon_width">14dp</dimen>
-    <dimen name="drop_icon_offset">3dp</dimen>
-    <!-- drag_mime_icon_wrapper_size + drop_icon_offset -->
-    <dimen name="drop_badge_container_size">27dp</dimen>
-
-    <dimen name="doc_header_sort_icon_size">32dp</dimen>
-    <dimen name="doc_header_height">48dp</dimen>
-
-    <dimen name="dropdown_sort_widget_margin">12dp</dimen>
-    <dimen name="dropdown_sort_widget_size">54dp</dimen>
-    <dimen name="dropdown_sort_text_size">18sp</dimen>
-
-    <dimen name="header_message_horizontal_padding">8dp</dimen>
-
-    <dimen name="fastscroll_default_thickness">8dp</dimen>
-    <dimen name="fastscroll_minimum_range">50dp</dimen>
-    <dimen name="fastscroll_margin">0dp</dimen>
-
-    <dimen name="bottom_bar_height">56dp</dimen>
-    <dimen name="bottom_bar_padding">10dp</dimen>
-    <dimen name="bottom_bar_button_height">36dip</dimen>
-    <dimen name="bottom_bar_button_horizontal_padding">24dp</dimen>
-    <dimen name="bottom_bar_button_corner_radius">4dp</dimen>
-
-    <dimen name="inspector_header_height">280dp</dimen>
-
-    <dimen name="root_info_header_height">60dp</dimen>
-    <dimen name="root_info_header_horizontal_padding">24dp</dimen>
-
-    <!-- TODO(b/379776735): remove this block after use_material3 flag is launched. -->
-    <dimen name="search_chip_group_margin">20dp</dimen>
-    <dimen name="search_chip_spacing">8dp</dimen>
-    <dimen name="search_chip_half_spacing">4dp</dimen>
-    <dimen name="search_chip_icon_padding">4dp</dimen>
-    <!-- block end -->
-
-    <dimen name="search_chip_radius">8dp</dimen>
-    <dimen name="search_chip_group_padding_vertical">@dimen/space_extra_small_4</dimen>
-    <dimen name="search_chip_inactive_stroke_width">1dp</dimen>
-    <dimen name="main_container_padding_start">@dimen/space_small_4</dimen>
-    <dimen name="main_container_padding_end">@dimen/space_small_4</dimen>
-    <dimen name="main_container_padding_top">0dp</dimen>
-    <dimen name="main_container_section_gap">2dp</dimen>
-    <dimen name="main_container_corner_radius_large">16dp</dimen>
-    <dimen name="main_container_corner_radius_small">4dp</dimen>
-    <dimen name="picker_saver_padding_top">@dimen/space_extra_small_1</dimen>
-    <dimen name="picker_saver_padding_bottom">@dimen/space_extra_small_1</dimen>
-    <dimen name="picker_saver_button_gap">@dimen/space_extra_small_2</dimen>
-    <dimen name="picker_saver_container_padding_top">@dimen/space_small_1</dimen>
-    <dimen name="picker_saver_container_padding_bottom">@dimen/space_small_1</dimen>
-    <dimen name="layout_padding_top">@dimen/space_small_1</dimen>
-    <dimen name="layout_padding_bottom">@dimen/space_small_1</dimen>
-    <dimen name="layout_padding_end">@dimen/space_small_1</dimen>
-
-    <dimen name="dialog_content_padding_top">18dp</dimen>
-    <dimen name="dialog_content_padding_bottom">24dp</dimen>
-
-    <dimen name="apps_row_title_height">48dp</dimen>
-    <dimen name="apps_row_title_padding_start">24dp</dimen>
-    <dimen name="apps_row_item_width">92dp</dimen>
-    <dimen name="apps_row_item_height">82dp</dimen>
-    <dimen name="apps_row_app_icon_size">32dp</dimen>
-    <dimen name="apps_row_app_icon_margin_horizontal">30dp</dimen>
-    <dimen name="apps_row_app_icon_margin_top">6dp</dimen>
-    <dimen name="apps_row_app_icon_margin_bottom">10dp</dimen>
-    <dimen name="apps_row_exit_icon_size">12dp</dimen>
-    <dimen name="apps_row_exit_icon_margin_top">2dp</dimen>
-    <dimen name="apps_row_exit_icon_margin_bottom">6dp</dimen>
-    <dimen name="apps_row_item_text_margin_horizontal">8dp</dimen>
-
-    <dimen name="profile_tab_radius">12dp</dimen>
-
-    <dimen name="search_bar_elevation">0dp</dimen>
-    <dimen name="search_bar_radius">8dp</dimen>
-    <dimen name="search_bar_background_margin_start">0dp</dimen>
-    <dimen name="search_bar_background_margin_end">0dp</dimen>
-    <dimen name="search_bar_margin">0dp</dimen>
-    <dimen name="search_bar_text_size">16dp</dimen>
-
-    <!-- Main margin is set by main_container_padding_start for the menu button, here is for
-    the space between the button the text/title. -->
-    <dimen name="search_bar_text_margin_start">@dimen/space_extra_small_6</dimen>
-    <dimen name="job_progress_toolbar_indicator_size">24dp</dimen>
-    <!-- The main margin is controlled above on paddingStart, zeroing toolbar_content_insets to
-         avoid pushing the title or button further. -->
-    <dimen name="toolbar_content_inset_start">0dp</dimen>
-    <dimen name="toolbar_padding_start">@dimen/space_extra_small_6</dimen>
-    <dimen name="toolbar_padding_end">@dimen/space_extra_small_6</dimen>
-    <dimen name="action_bar_elevation">0dp</dimen>
-    <dimen name="action_bar_margin">0dp</dimen>
-    <dimen name="action_mode_text_size">18sp</dimen>
-
-    <dimen name="refresh_icon_range">64dp</dimen>
-
-    <dimen name="item_doc_inflated_message_padding_top">0dp</dimen>
-    <dimen name="cross_profile_button_corner_radius">0dp</dimen>
-    <dimen name="cross_profile_button_stroke_width">0dp</dimen>
-    <dimen name="cross_profile_button_message_margin_top">4dp</dimen>
-
-    <dimen name="focus_ring_width">3dp</dimen>
-    <!-- 3dp focus ring width + 2dp gap between the ring and the content -->
-    <dimen name="focus_ring_gap">5dp</dimen>
-    <dimen name="hover_overlay_alpha">0.08</dimen>
-    <dimen name="ripple_overlay_alpha">0.10</dimen>
-
-    <dimen name="job_progress_panel_width">360dp</dimen>
-    <dimen name="job_progress_panel_margin">@dimen/space_small_1</dimen>
-    <dimen name="job_progress_panel_header_margin">@dimen/space_small_1</dimen>
-</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/dimens_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/dimens_m3.xml
new file mode 100644
index 000000000..4902ee5e9
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/dimens_m3.xml
@@ -0,0 +1,313 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<!-- Dimensions/sizes for size Compact (<600dp). -->
+<resources>
+    <!-- Material design rounded radius -->
+    <dimen name="material_round_radius_m3">2dp</dimen>
+
+    <dimen name="tab_selector_indicator_height_m3">2dp</dimen>
+    <dimen name="profile_tab_padding_m3">0dp</dimen>
+    <dimen name="grid_container_padding_m3">20dp</dimen>
+    <dimen name="list_container_padding_m3">@dimen/space_extra_small_4</dimen>
+    <dimen name="icon_size_m3">40dp</dimen>
+    <dimen name="button_touch_size_m3">48dp</dimen>
+    <dimen name="root_icon_size_m3">24dp</dimen>
+    <dimen name="thumbnail_border_width">1dp</dimen>
+    <!-- TODO(b/379776735): remove this block after use_material3 flag is launched. -->
+    <dimen name="root_icon_margin_m3">0dp</dimen>
+    <dimen name="root_spacer_padding_m3">0dp</dimen>
+    <!-- block end -->
+    <dimen name="root_action_icon_size_m3">24dp</dimen>
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+    <dimen name="root_icon_disabled_alpha_m3">?android:attr/disabledAlpha</dimen>
+    <dimen name="preview_icon_margin">4dp</dimen>
+    <dimen name="preview_icon_circle_size">20dp</dimen>
+    <dimen name="preview_icon_eye_size">14dp</dimen>
+    <dimen name="button_container_size">34dp</dimen>
+    <dimen name="icon_check_stroke_size">8dp</dimen>
+    <dimen name="icon_check_circle_size">24dp</dimen>
+    <dimen name="check_icon_size_m3">20dp</dimen>
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+    <dimen name="zoom_icon_size_m3">24dp</dimen>
+    <dimen name="selection_circle_margin">1dp</dimen>
+    <dimen name="selection_circle_shadow_bottom_offset">6dp</dimen>
+    <dimen name="selection_circle_shadow_right_offset">6dp</dimen>
+    <dimen name="selection_circle_shadow_top_offset">8dp</dimen>
+    <dimen name="selection_circle_shadow_left_offset">8dp</dimen>
+    <dimen name="selection_circle_offset">7dp</dimen>
+    <dimen name="selection_stroke_size">2dp</dimen>
+    <dimen name="list_item_thumbnail_size_m3">40dp</dimen>
+    <dimen name="list_item_thumbnail_corner_radius">8dp</dimen>
+    <dimen name="grid_item_icon_size_m3">30dp</dimen>
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+    <dimen name="progress_bar_height_m3">4dp</dimen>
+    <fraction name="grid_scale_min_m3">85%</fraction>
+    <fraction name="grid_scale_max_m3">200%</fraction>
+    <dimen name="grid_width_m3">144dp</dimen>
+    <dimen name="grid_height">128dp</dimen>
+    <dimen name="grid_section_separator_height_m3">0dp</dimen>
+    <dimen name="grid_item_margin_m3">@dimen/space_extra_small_4</dimen>
+    <dimen name="grid_container_padding_left">@dimen/space_small_1</dimen>
+    <dimen name="grid_container_padding_top">@dimen/space_extra_small_4</dimen>
+    <dimen name="grid_container_padding_right">@dimen/space_small_1</dimen>
+    <dimen name="grid_container_padding_bottom">@dimen/space_extra_small_4</dimen>
+    <dimen name="grid_padding_horiz_m3">4dp</dimen>
+    <dimen name="grid_padding_vert_m3">4dp</dimen>
+    <dimen name="list_item_height_m3">56dp</dimen>
+    <dimen name="list_item_padding_start">16dp</dimen>
+    <dimen name="list_item_padding_end">8dp</dimen>
+    <dimen name="list_item_padding_vertical">4dp</dimen>
+    <dimen name="list_item_icon_margin_end">12dp</dimen>
+    <dimen name="list_item_icon_size">32dp</dimen>
+    <!-- TODO(b/379776735): remove this block after use_material3 flag is launched. -->
+    <dimen name="list_item_width_m3">72dp</dimen>
+    <dimen name="list_item_padding_m3">16dp</dimen>
+    <dimen name="list_item_icon_padding_m3">16dp</dimen>
+    <dimen name="list_divider_inset_m3">72dp</dimen>
+    <!-- block end -->
+    <dimen name="breadcrumb_padding_horizontal">@dimen/space_extra_small_6</dimen>
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+    <dimen name="breadcrumb_item_padding_m3">8dp</dimen>
+    <dimen name="breadcrumb_item_padding_horizontal">12dp</dimen>
+    <dimen name="breadcrumb_item_padding_vertical">6dp</dimen>
+    <dimen name="breadcrumb_item_arrow_padding">@dimen/space_extra_small_2</dimen>
+    <dimen name="breadcrumb_item_height_m3">32dp</dimen>
+    <dimen name="breadcrumb_height">48dp</dimen>
+    <dimen name="breadcrumb_item_arrow_size">16dp</dimen>
+    <dimen name="dir_elevation_m3">8dp</dimen>
+    <dimen name="drag_shadow_size_m3">120dp</dimen>
+    <dimen name="grid_item_thumbnail_width">80dp</dimen>
+    <dimen name="grid_item_thumbnail_height">80dp</dimen>
+    <dimen name="grid_item_thumbnail_radius">20dp</dimen>
+    <dimen name="grid_item_icon_width">64dp</dimen>
+    <dimen name="grid_item_icon_height">64dp</dimen>
+    <dimen name="grid_item_nameplate_width">142dp</dimen>
+    <dimen name="grid_item_nameplate_height">44dp</dimen>
+    <dimen name="grid_item_nameplate_padding">4dp</dimen>
+    <dimen name="grid_item_nameplate_marginTop">@dimen/space_extra_small_2</dimen>
+    <dimen name="grid_item_nameplate_radius">8dp</dimen>
+    <dimen name="grid_item_nameplate_inner_radius">4dp</dimen>
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+    <dimen name="grid_item_elevation_m3">2dp</dimen>
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+    <dimen name="grid_item_radius_m3">12dp</dimen>
+    <dimen name="max_drawer_width_m3">280dp</dimen>
+    <dimen name="briefcase_icon_margin_m3">12dp</dimen>
+    <dimen name="briefcase_icon_grid_margin">8dp</dimen>
+    <dimen name="briefcase_icon_size_m3">14dp</dimen>
+    <dimen name="briefcase_icon_grid_size">16dp</dimen>
+    <dimen name="briefcase_icon_grid_padding">2dp</dimen>
+    <dimen name="briefcase_icon_size_photo_m3">24dp</dimen>
+    <dimen name="button_corner_radius_m3">2dp</dimen>
+
+    <dimen name="bottom_sheet_dialog_width">640dp</dimen>
+    <dimen name="bottom_sheet_dialog_radius">28dp</dimen>
+    <dimen name="bottom_sheet_dialog_padding_top">37dp</dimen>
+    <dimen name="bottom_sheet_dialog_padding_bottom">24dp</dimen>
+    <dimen name="bottom_sheet_sort_item_height">56dp</dimen>
+    <dimen name="bottom_sheet_sort_item_padding_horizontal">16dp</dimen>
+    <dimen name="bottom_sheet_sort_item_padding_vertical">8dp</dimen>
+
+    <dimen name="drawer_edge_width_m3">12dp</dimen>
+    <dimen name="drawer_padding_horizontal">@dimen/space_extra_small_6</dimen>
+    <dimen name="drawer_padding_top">@dimen/space_small_3</dimen>
+    <dimen name="drawer_padding_bottom">@dimen/space_small_1</dimen>
+    <dimen name="drawer_divider_padding_horizontal">16dp</dimen>
+    <dimen name="drawer_divider_padding_vertical">@dimen/space_extra_small_4</dimen>
+    <dimen name="drawer_item_height">56dp</dimen>
+    <dimen name="drawer_item_vertical_margin">10dp</dimen>
+    <dimen name="drawer_item_text_margin_start">12dp</dimen>
+    <dimen name="drawer_item_action_icon_margin_start">4dp</dimen>
+
+    <dimen name="nav_rail_item_height">64dp</dimen>
+    <dimen name="nav_rail_item_icon_bg_radius">16dp</dimen>
+    <dimen name="nav_rail_item_icon_bg_width">56dp</dimen>
+    <dimen name="nav_rail_item_icon_bg_height">32dp</dimen>
+    <dimen name="nav_rail_burger_icon_size">56dp</dimen>
+
+    <dimen name="drag_content_width">160dp</dimen>
+    <dimen name="drag_content_height">40dp</dimen>
+    <!-- drag_additional_layer_offset + drag_shadow_radius -->
+    <dimen name="drag_content_margin_start">7dp</dimen>
+    <dimen name="drag_content_radius">12dp</dimen>
+    <dimen name="drag_additional_layer_offset">4dp</dimen>
+    <!-- drag_additional_layer_offset + drag_file_counter_offset -->
+    <dimen name="drag_additional_layer_margin_top">12dp</dimen>
+    <dimen name="drag_file_counter_offset">8dp</dimen>
+    <dimen name="drag_file_counter_height">20dp</dimen>
+    <!-- drag shadow width/height need to cater all the elements drawing inside it, including
+         drag content, offset, shadow and drag file counter, so:
+         * width = drag_content_width + drag_file_counter_offset + drag_additional_layer_offset + drag_shadow_radius
+         * width = drag_content_height + drag_file_counter_offset + drag_additional_layer_offset + drag_shadow_radius
+     -->
+    <dimen name="drag_shadow_width_m3">175dp</dimen>
+    <dimen name="drag_shadow_height_m3">55dp</dimen>
+    <dimen name="drag_shadow_radius_m3">3dp</dimen>
+    <dimen name="drag_shadow_2_radius">2dp</dimen>
+    <dimen name="drag_shadow_y_offset">1dp</dimen>
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+    <dimen name="drag_shadow_padding_m3">8dp</dimen>
+
+    <dimen name="drop_mime_icon_wrapper_size">24dp</dimen>
+    <dimen name="drop_mime_icon_wrapper_radius">4dp</dimen>
+    <dimen name="drop_icon_height_m3">14dp</dimen>
+    <dimen name="drop_icon_width_m3">14dp</dimen>
+    <dimen name="drop_icon_offset">3dp</dimen>
+    <!-- drag_mime_icon_wrapper_size + drop_icon_offset -->
+    <dimen name="drop_badge_container_size">27dp</dimen>
+
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+    <dimen name="doc_header_sort_icon_size_m3">32dp</dimen>
+    <dimen name="doc_header_sort_icon_width">28dp</dimen>
+    <dimen name="doc_header_sort_icon_height">32dp</dimen>
+    <dimen name="doc_header_sort_icon_margin_start">10dp</dimen>
+    <dimen name="doc_header_sort_icon_radius">100dp</dimen>
+    <dimen name="doc_header_height_m3">48dp</dimen>
+
+    <dimen name="dropdown_sort_widget_margin_m3">12dp</dimen>
+    <dimen name="dropdown_sort_widget_size_m3">54dp</dimen>
+    <dimen name="dropdown_sort_text_size_m3">18sp</dimen>
+
+    <dimen name="header_message_horizontal_padding_m3">8dp</dimen>
+
+    <dimen name="fastscroll_default_thickness_m3">8dp</dimen>
+    <dimen name="fastscroll_minimum_range_m3">50dp</dimen>
+    <dimen name="fastscroll_margin_m3">0dp</dimen>
+
+    <dimen name="bottom_bar_height_m3">56dp</dimen>
+    <dimen name="bottom_bar_padding_m3">10dp</dimen>
+    <dimen name="bottom_bar_button_height_m3">36dip</dimen>
+    <dimen name="bottom_bar_button_horizontal_padding_m3">24dp</dimen>
+    <dimen name="bottom_bar_button_corner_radius_m3">4dp</dimen>
+
+    <dimen name="inspector_header_height_m3">280dp</dimen>
+
+    <dimen name="root_info_header_height_m3">60dp</dimen>
+    <dimen name="root_info_header_horizontal_padding_m3">24dp</dimen>
+
+    <!-- TODO(b/379776735): remove this block after use_material3 flag is launched. -->
+    <dimen name="search_chip_group_margin_m3">20dp</dimen>
+    <dimen name="search_chip_spacing_m3">8dp</dimen>
+    <dimen name="search_chip_half_spacing_m3">4dp</dimen>
+    <dimen name="search_chip_icon_padding_m3">4dp</dimen>
+    <dimen name="search_chip_radius_m3">8dp</dimen>
+    <!-- block end -->
+
+    <dimen name="search_chip_group_padding_vertical">@dimen/space_extra_small_4</dimen>
+    <dimen name="search_chip_inactive_stroke_width">1dp</dimen>
+    <dimen name="main_container_padding_start">@dimen/space_small_4</dimen>
+    <dimen name="main_container_padding_end">@dimen/space_small_4</dimen>
+    <dimen name="main_container_padding_top">0dp</dimen>
+    <dimen name="main_container_section_gap">2dp</dimen>
+    <dimen name="main_container_corner_radius_large">16dp</dimen>
+    <dimen name="main_container_corner_radius_small">4dp</dimen>
+    <dimen name="picker_saver_padding_top">@dimen/space_small_1</dimen>
+    <!-- TODO(b/402604097): The bottom padding should be 0dp if there is a gesture navigation bar. -->
+    <dimen name="picker_saver_padding_bottom">@dimen/space_small_1</dimen>
+    <dimen name="picker_saver_padding_start">@dimen/space_small_1</dimen>
+    <dimen name="picker_saver_padding_end">@dimen/space_small_1</dimen>
+    <dimen name="picker_saver_button_gap">@dimen/space_extra_small_2</dimen>
+    <dimen name="saver_progress_start_margin">@dimen/space_extra_small_4</dimen>
+    <dimen name="layout_padding_top">@dimen/space_small_1</dimen>
+    <dimen name="layout_padding_bottom">@dimen/space_small_1</dimen>
+    <dimen name="layout_padding_end">@dimen/space_small_1</dimen>
+
+    <dimen name="dialog_content_padding_horizontal">@dimen/space_small_4</dimen>
+    <dimen name="dialog_content_padding_top_m3">@dimen/space_small_1</dimen>
+    <dimen name="dialog_content_padding_bottom_m3">@dimen/space_small_4</dimen>
+
+    <dimen name="apps_row_item_width_m3">96dp</dimen>
+    <dimen name="apps_row_app_icon_size_m3">24dp</dimen>
+    <dimen name="apps_row_exit_icon_margin_top_m3">2dp</dimen>
+    <dimen name="apps_row_exit_icon_margin_bottom_m3">6dp</dimen>
+    <dimen name="apps_row_item_padding_horizontal">8dp</dimen>
+    <dimen name="apps_row_margin_vertical">@dimen/space_extra_small_4</dimen>
+    <dimen name="apps_row_padding">@dimen/space_extra_small_4</dimen>
+    <dimen name="apps_row_app_icon_margin_vertical">@dimen/space_extra_small_4</dimen>
+    <dimen name="apps_row_title_padding">@dimen/space_extra_small_4</dimen>
+
+    <dimen name="profile_tab_radius">12dp</dimen>
+
+    <dimen name="search_bar_elevation_m3">0dp</dimen>
+    <dimen name="search_bar_radius_m3">8dp</dimen>
+    <dimen name="search_bar_background_margin_start_m3">0dp</dimen>
+    <dimen name="search_bar_background_margin_end_m3">0dp</dimen>
+    <dimen name="search_bar_margin_m3">0dp</dimen>
+    <dimen name="search_bar_text_size_m3">16dp</dimen>
+
+    <dimen name="docked_searchbar_height">48dp</dimen>
+    <dimen name="docked_searchbar_padding">4dp</dimen>
+    <dimen name="docked_searchbar_icon_padding">12dp</dimen>
+    <dimen name="docked_searchbar_text_width">250dp</dimen>
+
+    <!-- Main margin is set by main_container_padding_start for the menu button, here is for
+    the space between the button the text/title. -->
+    <dimen name="search_bar_text_margin_start_m3">@dimen/space_extra_small_6</dimen>
+    <dimen name="job_progress_toolbar_indicator_size">24dp</dimen>
+    <dimen name="job_progress_toolbar_badge_outline_width">1dp</dimen>
+    <!-- Includes outline. -->
+    <dimen name="job_progress_toolbar_badge_diameter">10dp</dimen>
+    <!-- The main margin is controlled above on paddingStart, zeroing toolbar_content_insets to
+         avoid pushing the title or button further. -->
+    <dimen name="toolbar_content_inset_start">0dp</dimen>
+    <dimen name="toolbar_padding_start">@dimen/space_extra_small_6</dimen>
+    <dimen name="toolbar_padding_end">@dimen/space_extra_small_6</dimen>
+    <dimen name="action_bar_elevation_m3">0dp</dimen>
+    <dimen name="action_bar_margin_m3">0dp</dimen>
+    <dimen name="action_mode_text_size_m3">18sp</dimen>
+
+    <dimen name="refresh_icon_range_m3">64dp</dimen>
+
+    <dimen name="item_doc_inflated_message_padding_vertical">@dimen/space_medium_5</dimen>
+    <dimen name="cross_profile_progress_margin_bottom">@dimen/space_small_1</dimen>
+    <dimen name="cross_profile_button_message_margin_top_m3">@dimen/space_extra_small_2</dimen>
+    <dimen name="cross_profile_button_margin_top">@dimen/space_small_1</dimen>
+
+    <dimen name="empty_state_artwork_margin_top">@dimen/space_medium_5</dimen>
+    <dimen name="empty_state_artwork_margin_bottom">@dimen/space_small_1</dimen>
+    <dimen name="empty_state_message_margin_bottom">@dimen/space_medium_5</dimen>
+
+    <dimen name="banner_content_padding_vertical">16dp</dimen>
+    <dimen name="banner_content_padding_start">@dimen/space_medium_1</dimen>
+    <dimen name="banner_content_padding_end">8dp</dimen>
+
+    <dimen name="focus_ring_width">3dp</dimen>
+    <!-- 3dp focus ring width + 2dp gap between the ring and the content -->
+    <dimen name="focus_ring_gap">5dp</dimen>
+    <dimen name="hover_overlay_alpha">0.08</dimen>
+    <dimen name="ripple_overlay_alpha">0.10</dimen>
+
+    <dimen name="job_progress_panel_width">360dp</dimen>
+    <dimen name="job_progress_panel_margin">@dimen/space_small_1</dimen>
+    <dimen name="job_progress_panel_header_margin">@dimen/space_small_1</dimen>
+
+    <!-- 360dp - 2 * header margin (16dp) - header line height (24dp) -->
+    <dimen name="job_progress_list_max_height">304dp</dimen>
+    <dimen name="job_progress_list_margin">@dimen/space_extra_small_6</dimen>
+    <dimen name="job_progress_list_gap">@dimen/space_extra_small_1</dimen>
+    <dimen name="job_progress_list_corner_radius">@dimen/space_extra_small_6</dimen>
+
+    <dimen name="job_progress_item_padding">@dimen/space_small_1</dimen>
+    <dimen name="job_progress_item_expand_margin_start">@dimen/space_small_4</dimen>
+    <dimen name="job_progress_item_progress_margin_top">@dimen/space_extra_small_4</dimen>
+    <dimen name="job_progress_item_status_separator_margin">@dimen/space_extra_small_2</dimen>
+    <dimen name="job_progress_item_buttons_margin_start">@dimen/space_extra_small_2</dimen>
+    <dimen name="job_progress_item_buttons_margin_top">@dimen/space_extra_small_1</dimen>
+
+    <dimen name="peek_metadata_sheet_width">320dp</dimen>
+    <dimen name="peek_metadata_sheet_corner_radius">16dp</dimen>
+</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/layouts.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/layouts_m3.xml
similarity index 80%
rename from res/flag(com.android.documentsui.flags.use_material3)/values/layouts.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values/layouts_m3.xml
index d5b4f9da8..f72a1046a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values/layouts.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/layouts_m3.xml
@@ -15,6 +15,6 @@
 -->
 
 <resources>
-    <item name="documents_activity" type="layout">@layout/drawer_layout</item>
-    <item name="files_activity" type="layout">@layout/drawer_layout</item>
+    <item name="documents_activity_m3" type="layout">@layout/drawer_layout_m3</item>
+    <item name="files_activity_m3" type="layout">@layout/drawer_layout_m3</item>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/styles.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/styles.xml
deleted file mode 100644
index 481cd0be8..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/values/styles.xml
+++ /dev/null
@@ -1,200 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-
-<resources xmlns:android="http://schemas.android.com/apk/res/android">
-    <style name="ActionBarThemeCommon" parent="@style/ThemeOverlay.AppCompat.ActionBar">
-        <item name="colorControlNormal">?android:textColorSecondary</item>
-        <!-- Modern platform themes set actionMenuTextColor to textColorPrimary. For example,
-             see Theme.Material in frameworks/base/core/res/res/values/themes_material.xml.
-             However, if the platform theme does not set actionMenuTextColor we are going to
-             crash, so let's set it here. Additionally, most of our ActionBarTheme themes
-             override this -->
-        <item name="android:actionMenuTextColor">?android:textColorPrimary</item>
-        <item name="android:textAllCaps">false</item>
-    </style>
-
-    <!-- This gets overridden for specific platform versions and/or configs -->
-    <style name="ActionBarTheme" parent="@style/ActionBarThemeCommon"/>
-
-    <style name="HamburgerMenuButtonStyle" parent="@style/Widget.Material3.Search.Toolbar.Button.Navigation">
-        <item name="android:maxWidth">@dimen/icon_size_headline_large</item>
-        <item name="android:maxHeight">@dimen/icon_size_headline_large</item>
-    </style>
-
-    <style name="JobProgressToolbarIndicatorStyle" parent="@style/Widget.Material3.CircularProgressIndicator.ExtraSmall">
-        <item name="indicatorSize">@dimen/job_progress_toolbar_indicator_size</item>
-        <item name="indicatorInset">@dimen/space_extra_small_6</item>
-    </style>
-
-    <style name="ToolbarStyles" parent="@style/Widget.Material3.Toolbar">
-        <item name="android:paddingStart">@dimen/toolbar_padding_start</item>
-        <item name="android:paddingEnd">@dimen/toolbar_padding_end</item>
-        <item name="contentInsetStart">@dimen/toolbar_content_inset_start</item>
-        <item name="contentInsetStartWithNavigation">@dimen/toolbar_content_inset_start</item>
-        <item name="titleMarginStart">@dimen/search_bar_text_margin_start</item>
-        <item name="titleTextAppearance">@style/ToolbarTitle</item>
-    </style>
-
-    <style name="ActionModeStyle" parent="Widget.AppCompat.ActionMode">
-        <item name="titleTextStyle">@style/ActionModeTitle</item>
-        <item name="android:layout_margin">@dimen/search_bar_margin</item>
-    </style>
-
-    <style name="CardViewStyle" parent="@style/Widget.Material3.CardView.Outlined">
-        <item name="cardBackgroundColor">@color/app_background_color</item>
-        <item name="cardPreventCornerOverlap">false</item>
-        <item name="cardCornerRadius">@dimen/grid_item_radius</item>
-        <item name="cardElevation">@dimen/grid_item_elevation</item>
-    </style>
-
-    <style name="SnackbarButtonStyle" parent="@style/Widget.AppCompat.Button.Borderless">
-        <item name="android:textColor">?android:colorPrimary</item>
-    </style>
-
-    <style name="AutoCompleteTextViewStyle" parent="@style/Widget.AppCompat.AutoCompleteTextView">
-        <item name="android:textColorHint">?android:attr/textColorSecondary</item>
-        <item name="android:textAppearance">@style/AutoCompleteText</item>
-    </style>
-
-    <style name="BottomSheetDialogStyle" parent="@style/ThemeOverlay.Material3.BottomSheetDialog">
-        <item name="android:windowIsFloating">false</item>
-        <item name="bottomSheetStyle">@style/BottomSheet</item>
-        <item name="colorControlHighlight">@color/ripple_material_light</item>
-    </style>
-
-    <style name="BottomSheet" parent="@style/Widget.Design.BottomSheet.Modal">
-        <item name="android:background">@drawable/bottom_sheet_dialog_background</item>
-    </style>
-
-    <style name="OverflowButtonStyle" parent="@style/Widget.Material3.Search.ActionButton.Overflow">
-        <item name="android:minWidth">@dimen/button_touch_size</item>
-    </style>
-
-    <style name="OverflowMenuStyle" parent="@style/Widget.Material3.PopupMenu.Overflow">
-        <item name="android:overlapAnchor">false</item>
-    </style>
-
-    <style name="MaterialAlertDialogTitleStyle" parent="@style/MaterialAlertDialog.Material3.Title.Text.CenterStacked">
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-    <style name="MaterialButton" parent="@style/Widget.Material3.Button.UnelevatedButton">
-        <item name="android:textAppearance">@style/MaterialButtonTextAppearance</item>
-    </style>
-
-    <style name="MaterialTonalButton" parent="@style/Widget.Material3.Button.TonalButton">
-        <item name="android:textAppearance">@style/MaterialButtonTextAppearance</item>
-    </style>
-
-    <style name="MaterialOutlinedButton" parent="@style/Widget.Material3.Button.OutlinedButton">
-        <item name="android:textAppearance">@style/MaterialButtonTextAppearance</item>
-    </style>
-
-    <style name="DialogTextButton" parent="@style/Widget.Material3.Button.TextButton.Dialog">
-        <item name="android:textAppearance">@style/MaterialButtonTextAppearance</item>
-    </style>
-
-    <style name="EmptyStateButton" parent="@style/Widget.Material3.Button.TextButton">
-        <item name="android:textAppearance">@style/EmptyStateButtonTextAppearance</item>
-    </style>
-
-    <style name="AlertDialogTheme" parent="@style/ThemeOverlay.AppCompat.Dialog.Alert">
-        <item name="buttonBarPositiveButtonStyle">@style/DialogTextButton</item>
-        <item name="buttonBarNegativeButtonStyle">@style/DialogTextButton</item>
-    </style>
-
-    <style name="MaterialAlertDialogTheme" parent="@style/ThemeOverlay.Material3.MaterialAlertDialog.Centered">
-        <item name="buttonBarPositiveButtonStyle">@style/DialogTextButton</item>
-        <item name="buttonBarNegativeButtonStyle">@style/DialogTextButton</item>
-        <item name="materialAlertDialogTitleTextStyle">@style/MaterialAlertDialogTitleStyle</item>
-    </style>
-
-    <style name="SearchChipItemStyle" parent="@style/Widget.Material3.Chip.Filter">
-        <item name="android:textAppearance">@style/SearchChipText</item>
-        <item name="chipBackgroundColor">@color/search_chip_background_color</item>
-        <item name="chipStrokeColor">@color/search_chip_stroke_color</item>
-        <item name="chipCornerRadius">@dimen/search_chip_radius</item>
-    </style>
-
-    <style name="DrawerStyle" parent="">
-        <item name="android:background">?attr/colorSurfaceContainer</item>
-        <!-- Use padding together with the "outsideOverlay" scrollbar style to to make sure the
-            scrollbar appears on the edge of the container, and scrollbar trigger area doesn't
-            affect the hover effect of the views (e.g. action icon) on the edge.
-         -->
-        <item name="android:paddingHorizontal">@dimen/drawer_padding_horizontal</item>
-        <item name="android:paddingTop">@dimen/drawer_padding_top</item>
-        <item name="android:paddingBottom">@dimen/drawer_padding_bottom</item>
-        <item name="android:dividerHeight">@dimen/drawer_item_vertical_margin</item>
-        <item name="android:scrollbarStyle">outsideOverlay</item>
-        <item name="android:clipToPadding">false</item>
-    </style>
-
-    <style name="DrawerItemStyle" parent="">
-        <item name="android:paddingStart">16dp</item>
-        <item name="android:paddingEnd">4dp</item>
-        <item name="android:background">@drawable/root_item_background</item>
-    </style>
-
-    <style name="DrawerItemActionIconStyle" parent="@style/Widget.Material3.Button.IconButton">
-        <item name="android:layout_marginStart">@dimen/drawer_item_action_icon_margin_start</item>
-        <item name="strokeColor">?attr/colorSecondary</item>
-    </style>
-
-    <style name="ProfileTabStyle" parent="@style/Widget.Material3.TabLayout">
-        <!-- Use transparent bg color to hide the underline for tab layout. -->
-        <item name="android:background">@android:color/transparent</item>
-        <item name="tabIndicatorColor">?attr/colorPrimary</item>
-        <item name="tabIndicatorHeight">@dimen/tab_selector_indicator_height</item>
-        <item name="tabTextColor">?attr/colorOnSurfaceVariant</item>
-        <item name="tabSelectedTextColor">?attr/colorOnPrimaryContainer</item>
-        <item name="tabTextAppearance">@style/TabTextAppearance</item>
-    </style>
-
-    <style name="FileItemLabelStyle" parent="">
-        <item name="android:ellipsize">end</item>
-        <item name="android:minWidth">70dp</item>
-        <item name="android:singleLine">true</item>
-        <item name="android:textAppearance">@style/FileItemLabelText</item>
-    </style>
-
-    <style name="NavRailStyle" parent="">
-        <item name="android:background">?attr/colorSurfaceContainer</item>
-        <item name="android:paddingHorizontal">@dimen/space_small_3</item>
-        <item name="android:paddingTop">@dimen/space_extra_small_6</item>
-        <item name="android:paddingBottom">@dimen/space_small_1</item>
-        <item name="android:scrollbarStyle">outsideOverlay</item>
-        <item name="android:clipToPadding">false</item>
-    </style>
-
-    <style name="NavRailItemStyle" parent="">
-        <item name="android:background">@drawable/nav_rail_item_background</item>
-        <item name="android:paddingVertical">6dp</item>
-    </style>
-
-    <style name="NavRailItemTextStyle" parent="">
-        <item name="android:layout_marginTop">4dp</item>
-        <item name="android:textColor">@color/nav_rail_item_text_color</item>
-        <item name="android:textAppearance">@style/NavRailItemTextAppearance</item>
-    </style>
-
-    <style name="JobProgressPanelStyle" parent="@style/Widget.Material3.CardView.Elevated">
-        <item name="android:layout_marginStart">@dimen/job_progress_panel_margin</item>
-        <item name="android:layout_marginBottom">@dimen/job_progress_panel_margin</item>
-        <item name="cardElevation">1dp</item>
-        <item name="cardBackgroundColor">?attr/colorSurfaceDim</item>
-    </style>
-</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/styles_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/styles_m3.xml
new file mode 100644
index 000000000..fc7ffb0ab
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/styles_m3.xml
@@ -0,0 +1,269 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android">
+    <style name="ActionBarThemeCommonM3" parent="@style/ThemeOverlay.AppCompat.ActionBar">
+        <item name="colorControlNormal">?android:textColorSecondary</item>
+        <!-- Modern platform themes set actionMenuTextColor to textColorPrimary. For example,
+             see Theme.Material in frameworks/base/core/res/res/values/themes_material.xml.
+             However, if the platform theme does not set actionMenuTextColor we are going to
+             crash, so let's set it here. Additionally, most of our ActionBarTheme themes
+             override this -->
+        <item name="android:actionMenuTextColor">?android:textColorPrimary</item>
+        <item name="android:textAllCaps">false</item>
+    </style>
+
+    <!-- This gets overridden for specific platform versions and/or configs -->
+    <style name="ActionBarThemeM3" parent="@style/ActionBarThemeCommonM3"/>
+
+    <style name="HamburgerMenuButtonStyle" parent="@style/Widget.Material3.Search.Toolbar.Button.Navigation">
+        <item name="android:maxWidth">@dimen/icon_size_headline_large</item>
+        <item name="android:maxHeight">@dimen/icon_size_headline_large</item>
+    </style>
+
+    <style name="JobProgressToolbarIndicatorStyle" parent="@style/Widget.Material3.CircularProgressIndicator.ExtraSmall">
+        <item name="android:background">?attr/actionBarItemBackground</item>
+        <item name="indicatorSize">@dimen/job_progress_toolbar_indicator_size</item>
+        <item name="indicatorInset">0dp</item>
+    </style>
+
+    <style name="ToolbarStyles" parent="@style/Widget.Material3.Toolbar">
+        <item name="android:paddingStart">@dimen/toolbar_padding_start</item>
+        <item name="android:paddingEnd">@dimen/toolbar_padding_end</item>
+        <item name="contentInsetStart">@dimen/toolbar_content_inset_start</item>
+        <item name="contentInsetStartWithNavigation">@dimen/toolbar_content_inset_start</item>
+        <item name="titleMarginStart">@dimen/search_bar_text_margin_start_m3</item>
+        <item name="titleTextAppearance">@style/ToolbarTitleM3</item>
+    </style>
+
+    <style name="ThumbnailCardViewStyle" parent="@style/Widget.Material3.CardView.Outlined">
+        <item name="cardBackgroundColor">?attr/colorSurfaceContainerLowest</item>
+        <item name="cardPreventCornerOverlap">false</item>
+        <item name="cardElevation">0dp</item>
+        <item name="strokeWidth">0dp</item>
+        <!-- use CardView's default shape ?attr/shapeAppearanceCornerMedium -->
+    </style>
+
+    <style name="ListThumbnailCardViewStyle" parent="@style/ThumbnailCardViewStyle">
+        <item name="cardCornerRadius">@dimen/list_item_thumbnail_corner_radius</item>
+    </style>
+
+    <style name="GridThumbnailCardViewStyle" parent="@style/ThumbnailCardViewStyle" />
+
+    <style name="ThumbnailImageViewStyle" parent="">
+        <item name="strokeColor">?attr/colorSecondaryContainer</item>
+        <!-- stroke width will be controlled dynamically in the code. -->
+        <item name="strokeWidth">0dp</item>
+    </style>
+
+    <style name="ListThumbnailImageViewStyle" parent="@style/ThumbnailImageViewStyle">
+        <item name="shapeAppearance">@style/ListThumbnailImageViewShapeAppearance</item>
+    </style>
+
+    <style name="GridThumbnailImageViewStyle" parent="@style/ThumbnailImageViewStyle">
+        <item name="shapeAppearance">?attr/shapeAppearanceCornerMedium</item>
+    </style>
+
+    <style name="ListThumbnailImageViewShapeAppearance" parent="">
+        <item name="cornerFamily">rounded</item>
+        <item name="cornerSize">@dimen/list_item_thumbnail_corner_radius</item>
+    </style>
+
+    <style name="SnackbarButtonStyleM3" parent="@style/Widget.AppCompat.Button.Borderless">
+        <item name="android:textColor">?android:colorPrimary</item>
+    </style>
+
+    <style name="AutoCompleteTextViewStyleM3" parent="@style/Widget.AppCompat.AutoCompleteTextView">
+        <item name="android:textColorHint">?android:attr/textColorSecondary</item>
+        <item name="android:textAppearance">@style/AutoCompleteTextM3</item>
+    </style>
+
+    <style name="BottomSheetDialogStyleM3" parent="@style/ThemeOverlay.Material3.BottomSheetDialog">
+        <item name="android:windowIsFloating">false</item>
+        <item name="bottomSheetStyle">@style/BottomSheetM3</item>
+        <!-- This controls the focus background which we don't want.  -->
+        <item name="colorControlHighlight">@android:color/transparent</item>
+    </style>
+
+    <style name="BottomSheetM3" parent="@style/Widget.Material3.BottomSheet.Modal">
+        <item name="android:background">@drawable/bottom_sheet_dialog_background_m3</item>
+    </style>
+
+    <style name="OverflowButtonStyleM3" parent="@style/Widget.Material3.Search.ActionButton.Overflow">
+        <item name="android:minWidth">@dimen/button_touch_size_m3</item>
+    </style>
+
+    <style name="OverflowMenuStyleM3" parent="@style/Widget.Material3.PopupMenu.Overflow">
+        <item name="android:overlapAnchor">false</item>
+    </style>
+
+    <style name="MaterialButtonM3" parent="@style/Widget.Material3.Button.UnelevatedButton">
+        <item name="android:textAppearance">@style/MaterialButtonTextAppearanceM3</item>
+    </style>
+
+    <style name="MaterialTonalButton" parent="@style/Widget.Material3.Button.TonalButton">
+        <item name="android:textAppearance">@style/MaterialButtonTextAppearanceM3</item>
+    </style>
+
+    <style name="MaterialOutlinedButtonM3" parent="@style/Widget.Material3.Button.OutlinedButton">
+        <item name="android:textAppearance">@style/MaterialButtonTextAppearanceM3</item>
+    </style>
+
+    <style name="DialogFilledButton" parent="@style/MaterialButtonM3">
+        <item name="android:layout_marginStart">8dp</item>
+    </style>
+
+    <style name="DialogTextButtonM3" parent="@style/Widget.Material3.Button.TextButton.Dialog">
+        <item name="android:textAppearance">@style/MaterialButtonTextAppearanceM3</item>
+    </style>
+
+    <style name="MaterialAlertDialogThemeM3" parent="@style/ThemeOverlay.Material3.MaterialAlertDialog">
+        <item name="buttonBarPositiveButtonStyle">@style/DialogFilledButton</item>
+        <item name="buttonBarNegativeButtonStyle">@style/MaterialOutlinedButtonM3</item>
+        <item name="buttonBarNeutralButtonStyle">@style/DialogTextButtonM3</item>
+        <item name="materialAlertDialogTitleTextStyle">@style/MaterialAlertDialogTitleStyleM3</item>
+        <item name="materialAlertDialogBodyTextStyle">@style/MaterialAlertDialogBodyStyle</item>
+    </style>
+
+    <style name="SearchChipItemStyle" parent="@style/Widget.Material3.Chip.Filter">
+        <item name="android:textAppearance">@style/SearchChipTextM3</item>
+        <item name="chipBackgroundColor">@color/search_chip_background_color_m3</item>
+        <item name="chipStrokeColor">@color/search_chip_stroke_color_m3</item>
+        <!-- use Chip's default shape ?attr/shapeAppearanceCornerSmall -->
+    </style>
+
+    <style name="SearchOptionsTriggerStyle" parent="@style/SearchChipItemStyle">
+        <item name="android:layout_width">wrap_content</item>
+        <item name="android:layout_height">wrap_content</item>
+        <item name="android:layout_marginEnd">@dimen/space_extra_small_4</item>
+    </style>
+
+    <style name="DrawerStyle" parent="">
+        <item name="android:background">?attr/colorSurfaceContainer</item>
+        <!-- Use padding together with the "outsideOverlay" scrollbar style to to make sure the
+            scrollbar appears on the edge of the container, and scrollbar trigger area doesn't
+            affect the hover effect of the views (e.g. action icon) on the edge.
+         -->
+        <item name="android:paddingHorizontal">@dimen/drawer_padding_horizontal</item>
+        <item name="android:paddingTop">@dimen/drawer_padding_top</item>
+        <item name="android:paddingBottom">@dimen/drawer_padding_bottom</item>
+        <item name="android:dividerHeight">@dimen/drawer_item_vertical_margin</item>
+        <item name="android:scrollbarStyle">outsideOverlay</item>
+        <item name="android:clipToPadding">false</item>
+    </style>
+
+    <style name="DrawerItemStyle" parent="">
+        <item name="android:paddingStart">16dp</item>
+        <item name="android:paddingEnd">4dp</item>
+        <item name="android:background">@drawable/root_item_background_m3</item>
+    </style>
+
+    <style name="DrawerItemActionIconStyle" parent="@style/Widget.Material3.Button.IconButton">
+        <item name="android:layout_marginStart">@dimen/drawer_item_action_icon_margin_start</item>
+        <item name="strokeColor">?attr/colorSecondary</item>
+    </style>
+
+    <style name="ProfileTabStyle" parent="@style/Widget.Material3.TabLayout">
+        <!-- Use transparent bg color to hide the underline for tab layout. -->
+        <item name="android:background">@android:color/transparent</item>
+        <item name="tabIndicatorColor">?attr/colorPrimary</item>
+        <item name="tabIndicatorHeight">@dimen/tab_selector_indicator_height_m3</item>
+        <item name="tabTextColor">?attr/colorOnSurfaceVariant</item>
+        <item name="tabSelectedTextColor">?attr/colorOnPrimaryContainer</item>
+        <item name="tabTextAppearance">@style/TabTextAppearanceM3</item>
+    </style>
+
+    <style name="FileItemLabelStyle" parent="">
+        <item name="android:ellipsize">end</item>
+        <item name="android:minWidth">70dp</item>
+        <item name="android:singleLine">true</item>
+        <item name="android:textAppearance">@style/FileItemLabelText</item>
+    </style>
+
+    <style name="NavRailStyle" parent="">
+        <item name="android:background">?attr/colorSurfaceContainer</item>
+        <item name="android:paddingHorizontal">@dimen/space_small_3</item>
+        <item name="android:paddingTop">@dimen/space_extra_small_6</item>
+        <item name="android:paddingBottom">@dimen/space_small_1</item>
+        <item name="android:scrollbarStyle">outsideOverlay</item>
+        <item name="android:clipToPadding">false</item>
+    </style>
+
+    <style name="NavRailItemStyle" parent="">
+        <!-- By default the nav rail item has a grey background when it's focused, but we need the
+        background to be put on the icon inside, thus the defaultFocusHighlightEnabled=false here.
+        -->
+        <item name="android:defaultFocusHighlightEnabled">false</item>
+        <item name="android:paddingHorizontal">@dimen/space_extra_small_4</item>
+        <item name="android:paddingVertical">@dimen/space_extra_small_3</item>
+    </style>
+
+    <style name="NavRailItemTextStyle" parent="">
+        <item name="android:layout_marginTop">@dimen/space_extra_small_2</item>
+        <item name="android:textColor">@color/nav_rail_item_text_color</item>
+        <item name="android:textAppearance">@style/NavRailItemTextAppearance</item>
+    </style>
+
+    <style name="JobProgressPanelStyle" parent="@style/Widget.Material3.CardView.Elevated">
+        <item name="cardElevation">1dp</item>
+        <item name="cardBackgroundColor">?attr/colorSurfaceDim</item>
+    </style>
+
+    <style name="JobProgressItemCardStyle" parent="@style/Widget.Material3.CardView.Filled">
+        <item name="cardBackgroundColor">?attr/colorSurfaceContainer</item>
+        <item name="shapeAppearance">@style/JobProgressItemCardBaseShape</item>
+    </style>
+
+    <style name="JobProgressItemCardBaseShape" parent="@style/ShapeAppearance.Material3.Corner.ExtraSmall" />
+
+    <style name="JobProgressItemTitleStyle" parent="">
+        <item name="android:ellipsize">end</item>
+        <item name="android:textAppearance">@style/JobProgressItemTitleText</item>
+        <item name="android:textAlignment">viewStart</item>
+    </style>
+
+    <style name="JobProgressItemExpandButtonStyle" parent="@style/Widget.Material3.Button.IconButton.Filled">
+        <item name="android:insetBottom">0dp</item>
+        <item name="android:insetLeft">0dp</item>
+        <item name="android:insetRight">0dp</item>
+        <item name="android:insetTop">0dp</item>
+        <item name="android:minHeight">0dp</item>
+        <item name="android:paddingHorizontal">6dp</item>
+        <item name="android:paddingVertical">1dp</item>
+        <item name="backgroundTint">?attr/colorSurfaceBright</item>
+        <item name="icon">@drawable/ic_job_progress_expand</item>
+        <item name="iconSize">16dp</item>
+        <item name="iconTint">?attr/colorOnSurface</item>
+        <item name="shapeAppearance">@style/ShapeAppearance.Material3.Corner.Full</item>
+    </style>
+
+    <style name="JobProgressItemActionButtonStyle" parent="@style/Widget.Material3.Button.TextButton">
+        <item name="android:minWidth">0dp</item>
+        <item name="android:textAppearance">@style/JobProgressItemActionButtonText</item>
+    </style>
+
+    <style name="JobProgressItemProgressStyle" parent="@style/Widget.Material3.LinearProgressIndicator">
+        <item name="android:paddingTop">4dp</item>
+        <item name="android:paddingBottom">4dp</item>
+    </style>
+
+    <style name="BannerStyle" parent="@style/Widget.Material3.CardView.Filled">
+        <item name="android:layout_marginTop">16dp</item>
+        <item name="android:layout_marginBottom">4dp</item>
+        <item name="strokeWidth">0dp</item>
+        <item name="cardBackgroundColor">?attr/colorSurfaceContainerLow</item>
+    </style>
+</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/styles_text.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/styles_text.xml
deleted file mode 100644
index 57dbb1212..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/values/styles_text.xml
+++ /dev/null
@@ -1,166 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-<resources>
-    <style name="SortTitle" parent="@style/TextAppearance.Material3.TitleLarge">
-        <item name="android:textColor">?android:attr/textColorPrimary</item>
-        <item name="android:textSize">11sp</item>
-    </style>
-
-    <style name="SectionHeader" parent="@style/TextAppearance.Material3.TitleMedium">
-        <item name="android:textColor">?android:attr/textColorPrimary</item>
-        <item name="android:textAllCaps">true</item>
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-        <item name="android:textSize">12sp</item>
-    </style>
-
-    <style name="SortList" parent="@style/TextAppearance.AppCompat.Subhead">
-        <item name="android:textColor">@color/sort_list_text</item>
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-    <style name="SearchBarTitle" parent="@style/TextAppearance.Widget.AppCompat.Toolbar.Subtitle">
-        <item name="android:textColor">?android:attr/textColorSecondary</item>
-        <item name="android:textSize">@dimen/search_bar_text_size</item>
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="SearchChipText" parent="@style/TextAppearance.Material3.LabelLarge">
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-    <style name="AppsItemText">
-        <item name="android:textColor">?android:attr/textColorPrimary</item>
-        <item name="android:textSize">12sp</item>
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="AppsItemSubText">
-        <item name="android:textColor">?android:attr/textColorSecondary</item>
-        <item name="android:textSize">11sp</item>
-    </style>
-
-    <style name="AutoCompleteText" parent="@style/TextAppearance.AppCompat.Medium">
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="CardPrimaryText" parent="@style/TextAppearance.AppCompat.Subhead">
-        <item name="android:textColor">?android:attr/textColorPrimary</item>
-        <item name="android:textSize">14sp</item>
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="ActionModeTitle" parent="@style/ToolbarTitle">
-        <item name="android:textSize">@dimen/action_mode_text_size</item>
-    </style>
-
-    <style name="ToolbarTitle" parent="@style/TextAppearance.Material3.TitleLarge">
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-    <style name="DrawerMenuHeader" parent="@style/TextAppearance.Material3.BodyLarge">
-        <item name="android:textColor">?android:attr/textColorSecondary</item>
-        <item name="android:textAllCaps">true</item>
-        <item name="android:textSize">11sp</item>
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-    <style name="DrawerMenuPrimary" parent="@style/TextAppearance.Material3.LabelLarge">
-        <item name="android:textColor">@color/item_root_primary_text</item>
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-    <style name="DrawerMenuSecondary" parent="@style/TextAppearance.Material3.BodySmall">
-        <item name="android:textColor">@color/item_root_secondary_text</item>
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="InspectorKeySubTitle" parent="@style/TextAppearance.Material3.TitleMedium">
-        <item name="android:textColor">?android:attr/textColorSecondary</item>
-    </style>
-
-    <style name="MaterialButtonTextAppearance" parent="@style/TextAppearance.Material3.LabelLarge">
-        <item name="android:textAllCaps">@bool/config_button_all_caps</item>
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-    <style name="BreadcrumbText" parent="@style/TextAppearance.Material3.TitleSmall">
-        <item name="android:textColor">@color/horizontal_breadcrumb_color</item>
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-    <style name="EmptyStateTitleText">
-        <item name="android:textColor">@color/empty_state_text_color</item>
-        <item name="android:textSize">14sp</item>
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-    <style name="EmptyStateMessageText">
-        <item name="android:textColor">@color/empty_state_text_color</item>
-        <item name="android:textSize">12sp</item>
-    </style>
-
-    <style name="EmptyStateButtonTextAppearance">
-        <item name="android:textColor">?android:attr/colorAccent</item>
-        <item name="android:textSize">14sp</item>
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-    <style name="TabTextAppearance" parent="@style/TextAppearance.Material3.TitleSmall">
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-    <style name="FileItemLabelText" parent="@style/TextAppearance.Material3.TitleSmall">
-        <item name="android:textColor">@color/doc_list_item_label_color</item>
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="ItemCaptionText" parent="@style/TextAppearance.Material3.LabelSmall">
-        <item name="android:textColor">@color/doc_list_item_subtitle_color</item>
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="MenuItemTextAppearance" parent="@style/TextAppearance.Material3.LabelLarge">
-        <item name="android:textColor">?attr/colorOnSurface</item>
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="Subhead" parent="@style/TextAppearance.Material3.BodyLarge">
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="NavRailItemTextAppearance" parent="@style/TextAppearance.Material3.LabelMedium">
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="ListTableHeaderText" parent="@style/TextAppearance.Material3.TitleSmall.Emphasized">
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="DragBadgeText" parent="@style/TextAppearance.Material3.TitleSmall">
-        <item name="android:textColor">@color/drag_content_text_color</item>
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="DragCounterText" parent="@style/TextAppearance.Material3.LabelMedium">
-        <item name="android:textColor">@color/drag_file_counter_text_color</item>
-        <item name="fontFamily">@string/config_fontFamily</item>
-    </style>
-
-    <style name="JobProgressPanelHeaderText" parent="@style/TextAppearance.Material3.TitleMedium">
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
-</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/styles_text_m3.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/styles_text_m3.xml
new file mode 100644
index 000000000..341e0d0bb
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/styles_text_m3.xml
@@ -0,0 +1,224 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<resources>
+    <style name="TextAppearance.DocumentsUI.DisplayLarge" parent="TextAppearance.Material3.DisplayLarge">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.DisplayMedium" parent="TextAppearance.Material3.DisplayMedium">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.DisplaySmall" parent="TextAppearance.Material3.DisplaySmall">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.HeadlineLarge" parent="TextAppearance.Material3.HeadlineLarge">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.HeadlineMedium" parent="TextAppearance.Material3.HeadlineMedium">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.HeadlineSmall" parent="TextAppearance.Material3.HeadlineSmall">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.TitleLarge" parent="TextAppearance.Material3.TitleLarge">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.TitleMedium" parent="TextAppearance.Material3.TitleMedium">
+        <item name="fontFamily">@string/config_fontFamilyMedium</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.TitleSmall" parent="TextAppearance.Material3.TitleSmall">
+        <item name="fontFamily">@string/config_fontFamilyMedium</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.TitleSmall.Emphasized" parent="TextAppearance.Material3.TitleSmall.Emphasized">
+        <item name="fontFamily">@string/config_fontFamilyMedium</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.BodyLarge" parent="TextAppearance.Material3.BodyLarge">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.BodyMedium" parent="TextAppearance.Material3.BodyMedium">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.BodySmall" parent="TextAppearance.Material3.BodySmall">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.LabelLarge" parent="TextAppearance.Material3.LabelLarge">
+        <item name="fontFamily">@string/config_fontFamilyMedium</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.LabelLarge.Emphasized" parent="TextAppearance.Material3.LabelLarge.Emphasized">
+        <item name="fontFamily">@string/config_fontFamilyMedium</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.LabelMedium" parent="TextAppearance.Material3.LabelMedium">
+        <item name="fontFamily">@string/config_fontFamilyMedium</item>
+    </style>
+    <style name="TextAppearance.DocumentsUI.LabelSmall" parent="TextAppearance.Material3.LabelSmall">
+        <item name="fontFamily">@string/config_fontFamilyMedium</item>
+    </style>
+
+    <style name="TextAppearance.DocumentsUI.SearchBar" parent="TextAppearance.Material3.SearchBar">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+
+    <style name="SortListM3" parent="@style/TextAppearance.DocumentsUI.BodyLarge">
+        <item name="android:textColor">?attr/colorOnSurface</item>
+    </style>
+
+    <!-- TODO(b/377770698): search -->
+    <style name="SearchBarTitleM3" parent="@style/TextAppearance.Widget.AppCompat.Toolbar.Subtitle">
+        <item name="android:textColor">?android:attr/textColorSecondary</item>
+        <item name="android:textSize">@dimen/search_bar_text_size_m3</item>
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+
+    <style name="SearchChipTextM3" parent="@style/TextAppearance.DocumentsUI.LabelLarge" />
+
+    <style name="AppsRowTitle" parent="@style/TextAppearance.DocumentsUI.LabelMedium">
+        <item name="android:textColor">?attr/colorOnSurfaceVariant</item>
+    </style>
+
+    <style name="AppsItemSubTextM3" parent="@style/TextAppearance.DocumentsUI.LabelSmall">
+        <item name="android:textColor">?attr/colorOnSurfaceVariant</item>
+    </style>
+
+    <!-- TODO(b/377770698): search -->
+    <style name="AutoCompleteTextM3" parent="@style/TextAppearance.AppCompat.Medium">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched.
+        This is currently only used in item_dir_grid, which will be removed after use_material3.
+    -->
+    <style name="CardPrimaryTextM3" parent="@style/TextAppearance.AppCompat.Subhead">
+        <item name="android:textColor">?android:attr/textColorPrimary</item>
+        <item name="android:textSize">14sp</item>
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+
+    <style name="ToolbarTitleM3" parent="@style/TextAppearance.DocumentsUI.TitleMedium">
+        <item name="fontFamily">@string/config_fontFamilyMedium</item>
+    </style>
+
+    <style name="DrawerMenuHeaderM3" parent="@style/TextAppearance.DocumentsUI.TitleSmall.Emphasized">
+        <item name="android:textColor">?attr/colorOnSurfaceVariant</item>
+    </style>
+
+    <style name="DrawerMenuPrimaryM3" parent="@style/TextAppearance.DocumentsUI.LabelLarge">
+        <item name="android:textColor">@color/item_root_primary_text_m3</item>
+    </style>
+
+    <style name="DrawerMenuSecondaryM3" parent="@style/TextAppearance.DocumentsUI.BodySmall">
+        <item name="android:textColor">@color/item_root_secondary_text_m3</item>
+    </style>
+
+    <!-- TODO(b/377770698): peek -->
+    <style name="InspectorKeySubTitleM3" parent="@style/TextAppearance.Material3.TitleMedium">
+        <item name="android:textColor">?android:attr/textColorSecondary</item>
+    </style>
+
+    <style name="MaterialButtonTextAppearanceM3" parent="@style/TextAppearance.DocumentsUI.LabelLarge">
+        <item name="android:textAllCaps">@bool/config_button_all_caps</item>
+    </style>
+
+    <style name="BreadcrumbTextM3" parent="@style/TextAppearance.DocumentsUI.TitleSmall">
+        <item name="android:textColor">@color/horizontal_breadcrumb_color_m3</item>
+    </style>
+
+    <style name="CrossProfileTitleTextM3" parent="@style/TextAppearance.DocumentsUI.TitleMedium">
+        <item name="android:textColor">?attr/colorOnSurface</item>
+    </style>
+
+    <style name="CrossProfileMessageTextM3" parent="@style/TextAppearance.DocumentsUI.BodyMedium">
+        <item name="android:textColor">?attr/colorOnSurface</item>
+    </style>
+
+    <style name="EmptyStateTitleTextM3" parent="@style/TextAppearance.DocumentsUI.TitleMedium">
+        <item name="android:textColor">?attr/colorOnSurface</item>
+    </style>
+
+    <style name="TabTextAppearanceM3" parent="@style/TextAppearance.DocumentsUI.TitleSmall" />
+
+    <style name="FileItemLabelText" parent="@style/TextAppearance.DocumentsUI.TitleSmall">
+        <item name="android:textColor">@color/doc_list_item_label_color</item>
+    </style>
+
+    <style name="ItemCaptionTextM3" parent="@style/TextAppearance.DocumentsUI.LabelSmall">
+        <item name="android:textColor">@color/doc_list_item_subtitle_color_m3</item>
+    </style>
+
+    <style name="MenuItemTextAppearanceM3" parent="@style/TextAppearance.DocumentsUI.LabelLarge">
+        <item name="android:textColor">?attr/colorOnSurface</item>
+        <item name="fontFamily">@string/config_fontFamilyMedium</item>
+    </style>
+
+    <style name="SubheadM3" parent="@style/TextAppearance.DocumentsUI.BodyLarge" />
+
+    <style name="NavRailItemTextAppearance" parent="@style/TextAppearance.DocumentsUI.LabelMedium" />
+
+    <style name="ListTableHeaderText" parent="@style/TextAppearance.DocumentsUI.TitleSmall.Emphasized" />
+
+    <style name="DragBadgeText" parent="@style/TextAppearance.DocumentsUI.TitleSmall">
+        <item name="android:textColor">@color/drag_content_text_color</item>
+    </style>
+
+    <style name="DragCounterText" parent="@style/TextAppearance.DocumentsUI.LabelMedium">
+        <item name="android:textColor">@color/drag_file_counter_text_color</item>
+    </style>
+
+    <style name="JobProgressPanelHeaderText" parent="@style/TextAppearance.DocumentsUI.TitleMedium" />
+
+    <style name="JobProgressItemTitleText" parent="@style/TextAppearance.DocumentsUI.TitleSmall" />
+
+    <style name="JobProgressItemStatusText" parent="@style/TextAppearance.DocumentsUI.LabelMedium" />
+
+    <style name="JobProgressItemStatusText.Success">
+        <item name="android:textColor">@color/success</item>
+    </style>
+
+    <style name="JobProgressItemStatusText.Failure">
+        <item name="android:textColor">?attr/colorError</item>
+    </style>
+
+    <style name="JobProgressItemActionButtonText" parent="@style/TextAppearance.DocumentsUI.LabelLarge" />
+
+    <!-- Headline Small -->
+    <style name="MaterialAlertDialogTitleStyleM3" parent="@style/MaterialAlertDialog.Material3.Title.Text">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+
+    <!-- Body Medium -->
+    <style name="MaterialAlertDialogBodyStyle" parent="@style/MaterialAlertDialog.Material3.Body.Text">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+
+    <style name="BannerTitleText" parent="@style/TextAppearance.DocumentsUI.TitleMedium">
+        <item name="android:textColor">?attr/colorOnSurfaceVariant</item>
+    </style>
+
+    <style name="BannerSubtitleText" parent="@style/TextAppearance.DocumentsUI.BodyMedium">
+        <item name="android:textColor">?attr/colorOnSurfaceVariant</item>
+    </style>
+
+    <style name="BannerMessageText" parent="@style/TextAppearance.DocumentsUI.BodyMedium">
+        <item name="android:textColor">?attr/colorOnSurfaceVariant</item>
+    </style>
+
+    <style name="PeekTopBarTitleText" parent="@style/TextAppearance.DocumentsUI.TitleMedium">
+        <item name="android:textColor">@android:color/white</item>
+    </style>
+
+    <style name="PeekNoPreviewLabelText" parent="@style/TextAppearance.DocumentsUI.LabelLarge.Emphasized">
+        <item name="android:textColor">?attr/colorOnSurfaceVariant</item>
+    </style>
+
+</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/themes.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/themes_m3.xml
similarity index 57%
rename from res/flag(com.android.documentsui.flags.use_material3)/values/themes.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values/themes_m3.xml
index 114d14c88..74d14097e 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values/themes.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/themes_m3.xml
@@ -15,29 +15,16 @@
 -->
 
 <resources>
-    <style name="LauncherTheme" parent="DocumentsTheme">
-        <item name="android:windowBackground">@drawable/launcher_screen</item>
+    <style name="LauncherThemeM3" parent="DocumentsTheme">
+        <item name="android:windowBackground">@drawable/launcher_screen_m3</item>
     </style>
     <!-- DocumentsTheme is allow customize by run time overlay -->
-    <style name="DocumentsTheme" parent="@android:style/Theme.DeviceDefault.DocumentsUI">
-
-        <item name="android:actionModeBackground">?android:attr/colorBackground</item>
-
-        <!-- Color section -->
-        <item name="android:colorAccent">@color/primary</item>
-        <item name="android:colorBackground">@android:color/white</item>
-        <item name="android:colorBackgroundFloating">@color/background_floating</item>
-        <item name="android:colorControlHighlight">@color/ripple_material_light</item>
-        <item name="android:colorControlActivated">@color/primary</item>
-        <item name="android:colorPrimary">@color/primary</item>
-        <item name="android:colorSecondary">@color/secondary</item>
-        <item name="android:strokeColor">@color/hairline</item>
-
-        <!-- System | Widget section -->
-        <item name="android:listDivider">@drawable/list_divider</item>
-        <item name="android:statusBarColor">?android:colorBackground</item>
-        <item name="android:navigationBarColor">?android:colorBackground</item>
-        <item name="android:windowBackground">?android:colorBackground</item>
+    <style name="DocumentsThemeM3" parent="@android:style/Theme.DeviceDefault.DocumentsUI">
+
+        <!-- these system bar colors are required for SDK 30 -->
+        <item name="android:statusBarColor">@color/app_background_color_m3</item>
+        <item name="android:navigationBarColor">@color/app_background_color_m3</item>
+
         <item name="android:windowLightStatusBar">true</item>
         <item name="android:windowLightNavigationBar">true</item>
         <item name="android:windowSoftInputMode">stateUnspecified|adjustUnspecified</item>
@@ -47,38 +34,35 @@
 
     </style>
 
-    <style name="DocumentsDefaultTheme" parent="@style/Theme.Material3.DayNight.NoActionBar">
+    <style name="DocumentsDefaultThemeM3" parent="@style/Theme.Material3.DayNight.NoActionBar">
 
         <!-- This only used by support lib, not allow to overlay -->
         <item name="windowActionBar">false</item>
         <item name="windowActionModeOverlay">true</item>
 
         <!-- For material design widget, chips, buttons, not support attr-->
-        <item name="colorPrimary">@color/primary</item>
-        <item name="colorAccent">@color/primary</item>
+        <item name="colorPrimary">@color/primary_m3</item>
+        <item name="colorAccent">@color/primary_m3</item>
 
         <!-- TODO need to solve the error handle in GridItemThumbnail -->
-        <item name="gridItemTint">@color/item_doc_grid_tint</item>
+        <item name="gridItemTint">@color/item_doc_grid_tint_m3</item>
 
-        <item name="actionBarTheme">@style/ActionBarTheme</item>
+        <item name="actionBarTheme">@style/ActionBarThemeM3</item>
         <item name="toolbarStyle">@style/ToolbarStyles</item>
         <item name="toolbarNavigationButtonStyle">@style/HamburgerMenuButtonStyle</item>
-        <item name="actionModeStyle">@style/ActionModeStyle</item>
-        <item name="actionOverflowButtonStyle">@style/OverflowButtonStyle</item>
-        <item name="alertDialogTheme">@style/AlertDialogTheme</item>
-        <item name="autoCompleteTextViewStyle">@style/AutoCompleteTextViewStyle</item>
-        <item name="bottomSheetDialogTheme">@style/BottomSheetDialogStyle</item>
-        <item name="materialCardViewStyle">@style/CardViewStyle</item>
-        <item name="materialAlertDialogTheme">@style/MaterialAlertDialogTheme</item>
-        <item name="queryBackground">@color/menu_search_background</item>
-        <item name="snackbarButtonStyle">@style/SnackbarButtonStyle</item>
+        <item name="actionOverflowButtonStyle">@style/OverflowButtonStyleM3</item>
+        <item name="autoCompleteTextViewStyle">@style/AutoCompleteTextViewStyleM3</item>
+        <item name="bottomSheetDialogTheme">@style/BottomSheetDialogStyleM3</item>
+        <item name="materialAlertDialogTheme">@style/MaterialAlertDialogThemeM3</item>
+        <item name="queryBackground">@color/menu_search_background_m3</item>
+        <item name="snackbarButtonStyle">@style/SnackbarButtonStyleM3</item>
 
         <!-- Menus -->
-        <item name="actionOverflowMenuStyle">@style/OverflowMenuStyle</item>
+        <item name="actionOverflowMenuStyle">@style/OverflowMenuStyleM3</item>
         <item name="android:itemBackground">@drawable/menu_item_background</item>
 
         <!-- Menu text appearance -->
-        <item name="android:itemTextAppearance">@style/MenuItemTextAppearance</item>
+        <item name="android:itemTextAppearance">@style/MenuItemTextAppearanceM3</item>
 
         <!-- System bar colors. -->
         <item name="android:statusBarColor">?attr/colorSurfaceContainer</item>
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout-sw720dp/column_headers.xml b/res/layout-sw720dp/column_headers.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout-sw720dp/column_headers.xml
rename to res/layout-sw720dp/column_headers.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout-sw720dp/directory_app_bar.xml b/res/layout-sw720dp/directory_app_bar.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout-sw720dp/directory_app_bar.xml
rename to res/layout-sw720dp/directory_app_bar.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout-sw720dp/item_doc_list.xml b/res/layout-sw720dp/item_doc_list.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout-sw720dp/item_doc_list.xml
rename to res/layout-sw720dp/item_doc_list.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout-sw720dp/shared_cell_content.xml b/res/layout-sw720dp/shared_cell_content.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout-sw720dp/shared_cell_content.xml
rename to res/layout-sw720dp/shared_cell_content.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/apps_item.xml b/res/layout/apps_item.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/apps_item.xml
rename to res/layout/apps_item.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/apps_row.xml b/res/layout/apps_row.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/apps_row.xml
rename to res/layout/apps_row.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/column_headers.xml b/res/layout/column_headers.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/column_headers.xml
rename to res/layout/column_headers.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/dialog_delete_confirmation.xml b/res/layout/dialog_delete_confirmation.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/dialog_delete_confirmation.xml
rename to res/layout/dialog_delete_confirmation.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/dialog_file_name.xml b/res/layout/dialog_file_name.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/dialog_file_name.xml
rename to res/layout/dialog_file_name.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/dialog_sorting.xml b/res/layout/dialog_sorting.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/dialog_sorting.xml
rename to res/layout/dialog_sorting.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/directory_app_bar.xml b/res/layout/directory_app_bar.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/directory_app_bar.xml
rename to res/layout/directory_app_bar.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/directory_header.xml b/res/layout/directory_header.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/directory_header.xml
rename to res/layout/directory_header.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout.xml b/res/layout/drag_shadow_layout.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout.xml
rename to res/layout/drag_shadow_layout.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/drawer_layout.xml b/res/layout/drawer_layout.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/drawer_layout.xml
rename to res/layout/drawer_layout.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/drop_badge.xml b/res/layout/drop_badge.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/drop_badge.xml
rename to res/layout/drop_badge.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/fixed_layout.xml b/res/layout/fixed_layout.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/fixed_layout.xml
rename to res/layout/fixed_layout.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/fragment_directory.xml b/res/layout/fragment_directory.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/fragment_directory.xml
rename to res/layout/fragment_directory.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/fragment_pick.xml b/res/layout/fragment_pick_directory.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/fragment_pick.xml
rename to res/layout/fragment_pick_directory.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/fragment_roots.xml b/res/layout/fragment_roots.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/fragment_roots.xml
rename to res/layout/fragment_roots.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/fragment_save.xml b/res/layout/fragment_save.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/fragment_save.xml
rename to res/layout/fragment_save.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/fragment_search.xml b/res/layout/fragment_search.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/fragment_search.xml
rename to res/layout/fragment_search.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/inspector_action_view.xml b/res/layout/inspector_action_view.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/inspector_action_view.xml
rename to res/layout/inspector_action_view.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/inspector_activity.xml b/res/layout/inspector_activity.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/inspector_activity.xml
rename to res/layout/inspector_activity.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/inspector_header.xml b/res/layout/inspector_header.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/inspector_header.xml
rename to res/layout/inspector_header.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/inspector_section_title.xml b/res/layout/inspector_section_title.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/inspector_section_title.xml
rename to res/layout/inspector_section_title.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_dir_grid.xml b/res/layout/item_dir_grid.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_dir_grid.xml
rename to res/layout/item_dir_grid.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_grid.xml b/res/layout/item_doc_grid.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_grid.xml
rename to res/layout/item_doc_grid.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_header_message.xml b/res/layout/item_doc_header_message.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_header_message.xml
rename to res/layout/item_doc_header_message.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message.xml b/res/layout/item_doc_inflated_message.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message.xml
rename to res/layout/item_doc_inflated_message.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_content.xml b/res/layout/item_doc_inflated_message_content.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_content.xml
rename to res/layout/item_doc_inflated_message_content.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_cross_profile.xml b/res/layout/item_doc_inflated_message_cross_profile.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message_cross_profile.xml
rename to res/layout/item_doc_inflated_message_cross_profile.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_list.xml b/res/layout/item_doc_list.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_doc_list.xml
rename to res/layout/item_doc_list.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_history.xml b/res/layout/item_history.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_history.xml
rename to res/layout/item_history.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_photo_grid.xml b/res/layout/item_photo_grid.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_photo_grid.xml
rename to res/layout/item_photo_grid.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_root.xml b/res/layout/item_root.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_root.xml
rename to res/layout/item_root.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_root_header.xml b/res/layout/item_root_header.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_root_header.xml
rename to res/layout/item_root_header.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/item_root_spacer.xml b/res/layout/item_root_spacer.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/item_root_spacer.xml
rename to res/layout/item_root_spacer.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item.xml b/res/layout/navigation_breadcrumb_item.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item.xml
rename to res/layout/navigation_breadcrumb_item.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/root_vertical_divider.xml b/res/layout/root_vertical_divider.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/root_vertical_divider.xml
rename to res/layout/root_vertical_divider.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/search_chip_item.xml b/res/layout/search_chip_item.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/search_chip_item.xml
rename to res/layout/search_chip_item.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/search_chip_row.xml b/res/layout/search_chip_row.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/search_chip_row.xml
rename to res/layout/search_chip_row.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/sort_list_item.xml b/res/layout/sort_list_item.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/sort_list_item.xml
rename to res/layout/sort_list_item.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/layout/table_key_value_row.xml b/res/layout/table_key_value_row.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/layout/table_key_value_row.xml
rename to res/layout/table_key_value_row.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/menu/action_mode_menu.xml b/res/menu/action_mode_menu.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/menu/action_mode_menu.xml
rename to res/menu/action_mode_menu.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/menu/activity.xml b/res/menu/activity.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/menu/activity.xml
rename to res/menu/activity.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/menu/container_context_menu.xml b/res/menu/container_context_menu.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/menu/container_context_menu.xml
rename to res/menu/container_context_menu.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/menu/dir_context_menu.xml b/res/menu/dir_context_menu.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/menu/dir_context_menu.xml
rename to res/menu/dir_context_menu.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/menu/file_context_menu.xml b/res/menu/file_context_menu.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/menu/file_context_menu.xml
rename to res/menu/file_context_menu.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/menu/mixed_context_menu.xml b/res/menu/mixed_context_menu.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/menu/mixed_context_menu.xml
rename to res/menu/mixed_context_menu.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/menu/root_context_menu.xml b/res/menu/root_context_menu.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/menu/root_context_menu.xml
rename to res/menu/root_context_menu.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/menu/sub_menu.xml b/res/menu/sub_menu.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/menu/sub_menu.xml
rename to res/menu/sub_menu.xml
diff --git a/res/values-af/strings.xml b/res/values-af/strings.xml
index f3dc33788..92a49c94f 100644
--- a/res/values-af/strings.xml
+++ b/res/values-af/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Vee uit"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Wys in verskaffer"</string>
     <string name="button_back" msgid="1888621708934742182">"Terug"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Wys in vouer"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Nie gerangskik nie"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Naam"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Opsomming"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Kon nie dokument hernoem nie"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Maak los"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Sommige lers is omgeskakel"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Sien besonderhede"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Gekopieer"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Geskuif"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Uitgevee"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Saamgepers"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Onttrek"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Gee <xliff:g id="APPNAME"><b>^1</b></xliff:g> toegang tot <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>-gids op <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Gee <xliff:g id="APPNAME"><b>^1</b></xliff:g> toegang tot <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>-gids?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Gee <xliff:g id="APPNAME"><b>^1</b></xliff:g> toegang tot jou data, insluitend foto\'s en video\'s, op <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> gekies</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> gekies</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Vee keuse uit"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"maak oop"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"ontkies"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"kies"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"sleep"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"kies veelvuldige"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> items</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> item</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Kies \'n ander vouer om jou privaatheid te beskerm"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Skep nuwe vouer"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Deursoek hierdie toestel"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Vee teks uit"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Hierdie vouer"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Kernvouer"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Oral"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Enige tyd"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Vandag"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Gister"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Verlede week"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Verlede maand"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Verlede jaar"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Alle tipes"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Vee soekgeskiedenis uit: <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Persoonlik"</string>
     <string name="work_tab" msgid="7265359366883747413">"Werk"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Wys tans in lysmodus."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Lernaam"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Versteek lervoorskou"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Geen voorskou beskikbaar nie"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Prentvoorskou van <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-am/strings.xml b/res/values-am/strings.xml
index 4267bd1de..d6fcbf77e 100644
--- a/res/values-am/strings.xml
+++ b/res/values-am/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"  "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   <xliff:g id="APPNAME"><b>^1</b></xliff:g> ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="STORAGE"><i>^2</i></xliff:g>         <xliff:g id="APPNAME"><b>^1</b></xliff:g> ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">""</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">" "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"     "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"    "</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"   "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">" - "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>   "</string>
 </resources>
diff --git a/res/values-ar/strings.xml b/res/values-ar/strings.xml
index 6b193c223..458930317 100644
--- a/res/values-ar/strings.xml
+++ b/res/values-ar/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"   "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">" "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -113,7 +114,7 @@
     <string name="cant_save_to_cross_profile_error_message" msgid="5845240315510422749">"          <xliff:g id="PROFILE_0">%1$s</xliff:g>   <xliff:g id="PROFILE_1">%2$s</xliff:g>."</string>
     <string name="cross_profile_action_not_allowed_title" msgid="6611281348716476478">"    ."</string>
     <string name="cross_profile_action_not_allowed_message" msgid="7331275433061690947">"         ."</string>
-    <string name="root_recent" msgid="1080156975424341623">"    "</string>
+    <string name="root_recent" msgid="1080156975424341623">""</string>
     <string name="root_available_bytes" msgid="8269870862691408864">"<xliff:g id="SIZE">%1$s</xliff:g> "</string>
     <string name="root_type_service" msgid="6521366147466512289">" "</string>
     <string name="root_type_shortcut" msgid="6059343175525442279">""</string>
@@ -275,6 +276,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   ."</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"   "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">" "</string>
+    <string name="move_completed" msgid="3981250605092729273">" "</string>
+    <string name="delete_completed" msgid="4149401155614626199">" "</string>
+    <string name="compress_completed" msgid="8808356399995313077">"  "</string>
+    <string name="extract_completed" msgid="8824595789915249972">"  "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"    <xliff:g id="APPNAME"><b>^1</b></xliff:g>     <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"   <xliff:g id="APPNAME"><b>^1</b></xliff:g>     <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"   <xliff:g id="APPNAME"><b>^1</b></xliff:g>           <xliff:g id="STORAGE"><i>^2</i></xliff:g>"</string>
@@ -288,6 +295,12 @@
       <item quantity="other">  <xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one">    (<xliff:g id="COUNT_0">%1$d</xliff:g>)</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="zero"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="two"> (<xliff:g id="COUNT_1">%1$d</xliff:g>)</item>
@@ -373,6 +386,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"    "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"   "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"  "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -382,4 +406,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"    ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"  <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-as/strings.xml b/res/values-as/strings.xml
index 1d830ebad..95833e14e 100644
--- a/res/values-as/strings.xml
+++ b/res/values-as/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">" "</string>
     <string name="button_back" msgid="1888621708934742182">" "</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">"   "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"     \'"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">" "</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"    "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">"  "</string>
+    <string name="move_completed" msgid="3981250605092729273">"  "</string>
+    <string name="delete_completed" msgid="4149401155614626199">" "</string>
+    <string name="compress_completed" msgid="8808356399995313077">"  "</string>
+    <string name="extract_completed" msgid="8824595789915249972">"  "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="STORAGE"><i>^3</i></xliff:g> <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="STORAGE"><i>^2</i></xliff:g>  \'  \'      ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g>   </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>   </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"  "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">" "</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"  "</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"        "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">" \'  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"   "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"    "</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>  "</string>
 </resources>
diff --git a/res/values-az/strings.xml b/res/values-az/strings.xml
index 789d477c1..d6005946d 100644
--- a/res/values-az/strings.xml
+++ b/res/values-az/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Silin"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Provayderd gstrin"</string>
     <string name="button_back" msgid="1888621708934742182">"Geri"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Qovluqda gstrin"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Sralanmayb"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Ad"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Yekun"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Snd adn dyimk uursuz oldu"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"xarn"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Bzi fayllar konvertasiya edilib"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Detallara baxn"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopiyaland"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Krld"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Silindi"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Sxld"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"xarld"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="STORAGE"><i>^3</i></xliff:g> yaddanda <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> kataloquna <xliff:g id="APPNAME"><b>^1</b></xliff:g> girii tqdim edilsin?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g> kataloquna <xliff:g id="APPNAME"><b>^1</b></xliff:g> girii tqdim edilsin?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="STORAGE"><i>^2</i></xliff:g> yaddanda foto v videolar daxil olmaqla datanza <xliff:g id="APPNAME"><b>^1</b></xliff:g> girii tmin edilsin?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> seilib</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> seilib</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Seimi silin"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"an"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"seimi silin"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"sein"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"srdrn"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"bir nesini sein"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> element</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> element</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Mxfiliyinizi qorumaq n baqa qovluq sein"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Yeni qovluq yaradn"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Bu cihazda axtarn"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Mtni silin"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Bu qovluq"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Mnb qovluq"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Hr yerd"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"stniln vaxt"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Bu gn"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Dnn"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Ken hft"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Ken ay"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Ken il"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Btn nvlr"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"<xliff:g id="TEXT">%1$s</xliff:g> n axtar tarixsini silin"</string>
     <string name="personal_tab" msgid="3878576287868528503">"xsi"</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Siyah rejimind gstrilir."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Fayl ad"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Fayl nizlmsini gizldin"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"nbax latan deyil"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g> n kil nizlmsi"</string>
 </resources>
diff --git a/res/values-b+sr+Latn/strings.xml b/res/values-b+sr+Latn/strings.xml
index af9c3d506..673dce688 100644
--- a/res/values-b+sr+Latn/strings.xml
+++ b/res/values-b+sr+Latn/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Obrii"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Prikai u aplikaciji dobavljaa"</string>
     <string name="button_back" msgid="1888621708934742182">"Nazad"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Prikai u folderu"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Nisu sortirani"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Naziv"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Rezime"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Preimenovanje dokumenta nije uspelo"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Izbaci"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Neke datoteke su konvertovane"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Pogledajte detalje"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopirano"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Premeteno"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Izbrisano"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Komprimovano"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Izdvojeno"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"elite li da dozvolite aplikaciji <xliff:g id="APPNAME"><b>^1</b></xliff:g> da pristupa folderu <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> na memorijskom prostoru <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"elite li da dozvolite aplikaciji <xliff:g id="APPNAME"><b>^1</b></xliff:g> da pristupa folderu <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"elite li da dozvolite aplikaciji <xliff:g id="APPNAME"><b>^1</b></xliff:g> da pristupa podacima, ukljuujui slike i video, na memorijskom prostoru <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="few">Izabrane su <xliff:g id="COUNT_1">%1$d</xliff:g> stavke</item>
       <item quantity="other">Izabrano je <xliff:g id="COUNT_1">%1$d</xliff:g> stavki</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Obrii izbor"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"otvorite"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"ponitite izbor"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"izabrali"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"prevukli"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"izabrali vie stavki"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> stavka</item>
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> stavke</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Da biste zatitili privatnost, odaberite neki drugi folder"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Napravi novi folder"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Pretrai ovaj ureaj"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Obrii tekst"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Ovaj folder"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Osnovni folder"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Svuda"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Bilo kada"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Danas"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Jue"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Prole nedelje"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Prolog meseca"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Prole godine"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Svi tipovi"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Izbriite istoriju pretrage <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Lino"</string>
     <string name="work_tab" msgid="7265359366883747413">"Posao"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Prikazuje se u reimu liste."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Naziv fajla"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Sakrijte pregled fajla"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Pregled nije dostupan"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Pregled slike: <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-be/strings.xml b/res/values-be/strings.xml
index b20f4ec6b..6697ad89a 100644
--- a/res/values-be/strings.xml
+++ b/res/values-be/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">" "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">" "</string>
@@ -243,6 +244,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"   "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"  <xliff:g id="APPNAME"><b>^1</b></xliff:g>    <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"  <xliff:g id="APPNAME"><b>^1</b></xliff:g>    <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"  <xliff:g id="APPNAME"><b>^1</b></xliff:g>    ,      ,  <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -254,6 +261,12 @@
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -329,6 +342,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"      "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"   "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">""</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"  "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -338,4 +362,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">" "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"  <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-bg/strings.xml b/res/values-bg/strings.xml
index eb6c137dc..42a0caa70 100644
--- a/res/values-bg/strings.xml
+++ b/res/values-bg/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">" "</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"     "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"   "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"  "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"     <xliff:g id="APPNAME"><b>^1</b></xliff:g>    <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> / <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"     <xliff:g id="APPNAME"><b>^1</b></xliff:g>    <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"     <xliff:g id="APPNAME"><b>^1</b></xliff:g>       (<xliff:g id="STORAGE"><i>^2</i></xliff:g>),    ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one"> <xliff:g id="COUNT_0">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"  "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"  "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"  "</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"   "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"  ,     "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"   "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"   "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"  "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"  "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"  <xliff:g id="TEXT">%1$s</xliff:g>    "</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"    ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"  "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"    "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"  "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"  <xliff:g id="FILENAME">%s</xliff:g>  "</string>
 </resources>
diff --git a/res/values-bn/strings.xml b/res/values-bn/strings.xml
index 5815a476c..1645ac99d 100644
--- a/res/values-bn/strings.xml
+++ b/res/values-bn/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">" "</string>
     <string name="button_show_provider" msgid="6905880493806292753">" "</string>
     <string name="button_back" msgid="1888621708934742182">" "</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">" "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"    "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">" "</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"   "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">"  "</string>
+    <string name="move_completed" msgid="3981250605092729273">" "</string>
+    <string name="delete_completed" msgid="4149401155614626199">" "</string>
+    <string name="compress_completed" msgid="8808356399995313077">"  "</string>
+    <string name="extract_completed" msgid="8824595789915249972">"  "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>     ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>     ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="STORAGE"><i>^2</i></xliff:g>       <xliff:g id="APPNAME"><b>^1</b></xliff:g>       ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g>   </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>   </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"     "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">" "</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">" "</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"   ,    "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"   "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"   "</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"  "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>-  "</string>
 </resources>
diff --git a/res/values-bs/strings.xml b/res/values-bs/strings.xml
index 73a4b502a..a389deaee 100644
--- a/res/values-bs/strings.xml
+++ b/res/values-bs/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Obrii"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Prikai u pruaocu"</string>
     <string name="button_back" msgid="1888621708934742182">"Nazad"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Prikai u folderu"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Nije poredano"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Ime"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Saetak"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Promjena naziva dokumenta nije uspjela"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Izbaci"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Neki fajlovi su pretvoreni u drugi format"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Pogledajte detalje"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopirano"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Premjeteno"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Izbrisano"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Komprimirano"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Izdvojeno"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"elite li aplikaciji <xliff:g id="APPNAME"><b>^1</b></xliff:g> odobriti pristup direktoriju <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> na ureaju za pohranu <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"elite li aplikaciji <xliff:g id="APPNAME"><b>^1</b></xliff:g> odobriti pristup direktoriju <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"elite li aplikaciji <xliff:g id="APPNAME"><b>^1</b></xliff:g> odobriti pristup svojim podacima, ukljuujui fotografije i videozapise, na ureaju za pohranu <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> odabrana</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> odabranih</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Brisanje odabira"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"otvaranje"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"ponitavanje odabira"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"odabir"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"prevlaenje"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"odabir vie stavki"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> stavka</item>
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> stavke</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Da zatitite svoju privatnost, odaberite drugi folder"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Napravi novi folder"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Pretraite ureaj"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Brisanje teksta"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Ovaj folder"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Osnovni folder"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Svugdje"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Bilo kada"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Danas"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Juer"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Prola sedmica"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Proli mjesec"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Prola godina"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Sve vrste"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Izbrii historiju pretraivanja <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Lino"</string>
     <string name="work_tab" msgid="7265359366883747413">"Poslovno"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Prikazivanje u vidu liste."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Naziv fajla"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Sakrivanje pregleda fajla"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Pregled nije dostupan"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Pregled slike <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-ca/strings.xml b/res/values-ca/strings.xml
index f78ec3811..082576071 100644
--- a/res/values-ca/strings.xml
+++ b/res/values-ca/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Esborra"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Mostra al provedor"</string>
     <string name="button_back" msgid="1888621708934742182">"Enrere"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Mostra a la carpeta"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Sense ordenar"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nom"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Resum"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"No s\'ha pogut canviar el nom del document"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Expulsa"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"S\'han convertit alguns fitxers"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Mostra els detalls"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"S\'ha copiat"</string>
+    <string name="move_completed" msgid="3981250605092729273">"S\'ha mogut"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"S\'ha suprimit"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"S\'ha comprimit"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"S\'ha extret"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Vols que l\'aplicaci <xliff:g id="APPNAME"><b>^1</b></xliff:g> tingui accs al directori <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> de <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Vols que l\'aplicaci <xliff:g id="APPNAME"><b>^1</b></xliff:g> tingui accs al directori <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Vols que l\'aplicaci <xliff:g id="APPNAME"><b>^1</b></xliff:g> tingui accs a les dades de <xliff:g id="STORAGE"><i>^2</i></xliff:g>, incloses les fotos i els vdeos?"</string>
@@ -237,6 +244,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> elements seleccionats</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> element seleccionat</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Esborra la selecci"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"obrir"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"desseleccionar"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"seleccionar"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"arrossegar"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"per seleccionar diversos elements"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> elements</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> elements</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Per protegir la teva privadesa, tria una altra carpeta"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Crea una carpeta"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Cerca en aquest dispositiu"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Esborra el text"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Aquesta carpeta"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Carpeta arrel"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"A tot arreu"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Qualsevol data"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Avui"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Ahir"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"La setmana passada"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"El mes passat"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"L\'any passat"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Tots els tipus"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Suprimeix l\'historial de cerques <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Treball"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Es mostra en mode de llista."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nom del fitxer"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Amaga la previsualitzaci del fitxer"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"No hi ha cap previsualitzaci disponible"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Previsualitzaci de la imatge <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-cs/strings.xml b/res/values-cs/strings.xml
index 28b167244..2f7faf893 100644
--- a/res/values-cs/strings.xml
+++ b/res/values-cs/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Vymazat"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Zobrazit uposkytovatele"</string>
     <string name="button_back" msgid="1888621708934742182">"Zpt"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Zobrazit ve sloce"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Neazeno"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nzev"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Souhrn"</string>
@@ -243,6 +244,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Dokument se nepodailo pejmenovat."</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Odpojit"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Nkter soubory byly pevedeny"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Zobrazit podrobnosti"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Zkoprovno"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Pesunuto"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Smazno"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Zkomprimovno"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Rozbaleno"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Chcete aplikaci <xliff:g id="APPNAME"><b>^1</b></xliff:g> udlit pstup kadresi <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> vloiti <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Chcete aplikaci <xliff:g id="APPNAME"><b>^1</b></xliff:g> udlit pstup kadresi <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Chcete aplikaci <xliff:g id="APPNAME"><b>^1</b></xliff:g> udlit pstup ke svm datm vloiti <xliff:g id="STORAGE"><i>^2</i></xliff:g>, vetn fotek avide?"</string>
@@ -254,6 +261,12 @@
       <item quantity="other">Vybrno <xliff:g id="COUNT_1">%1$d</xliff:g> poloek</item>
       <item quantity="one">Vybrna <xliff:g id="COUNT_0">%1$d</xliff:g> poloka</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Zruit vbr"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"otevt"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"zruit vbr"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"vybrat"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"pethnout"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"vybrat vc monost"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> poloky</item>
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> poloky</item>
@@ -329,6 +342,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Zdvodu ochrany soukrom zvolte jinou sloku"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Vytvoit novou sloku"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Prohledat tohle zazen"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Vymazat text"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Tato sloka"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Koenov sloka"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Vude"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Kdykoli"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Dnes"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Vera"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Minul tden"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Minul msc"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Minul rok"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Vechny typy"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Vymazat historii vyhledvn <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Osobn"</string>
     <string name="work_tab" msgid="7265359366883747413">"Pracovn"</string>
@@ -338,4 +362,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Zobrazuje se seznam poloek."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nzev souboru"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Skrt nhled souboru"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Nen kdispozici dn nhled"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Nhled obrzku <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-da/strings.xml b/res/values-da/strings.xml
index bfc2386f2..f2ef13843 100644
--- a/res/values-da/strings.xml
+++ b/res/values-da/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Ryd"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Vis i udbyders tjeneste"</string>
     <string name="button_back" msgid="1888621708934742182">"Tilbage"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Vis i mappe"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Ikke sorteret"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Navn"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Oversigt"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Dokumentet kunne ikke omdbes"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Skub ud"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Nogle filer er konverteret"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"F flere oplysninger"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopieret"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Flyttet"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Slettet"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Komprimeret"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Udpakket"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Vil du give <xliff:g id="APPNAME"><b>^1</b></xliff:g> adgang til indekset <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> p <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Vil du give <xliff:g id="APPNAME"><b>^1</b></xliff:g> adgang til indekset <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Vil du give <xliff:g id="APPNAME"><b>^1</b></xliff:g> adgang til dine data, herunder billeder og videoer p <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> er markeret</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> er markeret</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Ryd valg"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"bne"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"fravlge"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"vlge"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"trkke"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"vlge flere"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> element</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> elementer</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"For at beskytte dit privatliv skal du vlge en anden mappe"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Opret ny mappe"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Sg p denne enhed"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Ryd tekst"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Denne mappe"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Rodmappe"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Overalt"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Nr som helst"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"I dag"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"I gr"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Seneste uge"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Seneste mned"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Seneste r"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Alle typer"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Slet sgehistorikken <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personlig"</string>
     <string name="work_tab" msgid="7265359366883747413">"Arbejde"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Vises i listevisning."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Filnavn"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Skjul forhndsvisning af fil"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Ingen tilgngelig forhndsvisning"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Forhndsvisning af billedet <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-de/inspector_strings.xml b/res/values-de/inspector_strings.xml
index d535efd8a..8c2261327 100644
--- a/res/values-de/inspector_strings.xml
+++ b/res/values-de/inspector_strings.xml
@@ -17,7 +17,7 @@
 <resources xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
     <string name="inspector_title" msgid="1924760928091740238">"Informationen"</string>
-    <string name="inspector_load_error" msgid="7522190243413249291">"Dateiinformationen konnten nicht geladen werden"</string>
+    <string name="inspector_load_error" msgid="7522190243413249291">"Datei-Informationen konnten nicht geladen werden"</string>
     <string name="inspector_debug_section" msgid="2576052661505700421">"Infos zur Fehlersuche (nur fr Entwickler)"</string>
     <string name="inspector_debug_metadata_section" msgid="5875140675600744846">"Unkomprimierte Metadaten: <xliff:g id="METADATATYPE">%1$s</xliff:g>"</string>
     <string name="inspector_metadata_section" msgid="6077622515328240575">"Mediendetails"</string>
diff --git a/res/values-de/strings.xml b/res/values-de/strings.xml
index ee5604973..315c568d7 100644
--- a/res/values-de/strings.xml
+++ b/res/values-de/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Lschen"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"In App des Anbieters anzeigen"</string>
     <string name="button_back" msgid="1888621708934742182">"Zurck"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"In Ordner zeigen"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Nicht sortiert"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Name"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Zusammenfassung"</string>
@@ -120,7 +121,7 @@
     <string name="root_type_device" msgid="1713604128005476585">"Gerte"</string>
     <string name="root_type_apps" msgid="8646073235029886342">"Weitere Apps"</string>
     <string name="empty" msgid="5300254272613103004">"Keine Elemente"</string>
-    <string name="no_results" msgid="2371026325236359209">"Keine bereinstimmungen in \"%1$s\""</string>
+    <string name="no_results" msgid="2371026325236359209">"Keine bereinstimmungen in %1$s"</string>
     <string name="toast_no_application" msgid="7555319548595113121">"Datei kann nicht geffnet werden"</string>
     <string name="toast_view_in_archives_unsupported" msgid="1923221390170964845">"Dateien in Archiven knnen nicht geffnet werden"</string>
     <string name="toast_failed_delete" msgid="3453846588205817591">"Einige Dokumente konnten nicht gelscht werden"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Dokument konnte nicht umbenannt werden"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Auswerfen"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Einige Dateien wurden konvertiert"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Details ansehen"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopiert"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Verschoben"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Gelscht"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Komprimiert"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extrahiert"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> Zugriff auf das Verzeichnis <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> auf <xliff:g id="STORAGE"><i>^3</i></xliff:g> geben?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> Zugriff auf das Verzeichnis <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> geben?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> Zugriff auf die Daten auf <xliff:g id="STORAGE"><i>^2</i></xliff:g> geben, einschlielich Fotos und Videos?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> ausgewhlt</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> ausgewhlt</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Auswahl aufheben"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"ffnen"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"Aufheben der Auswahl"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"Auswhlen"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"Ziehen"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"Auswhlen mehrerer Elemente"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> Elemente</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> Element</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Zum Schutz deiner Daten einen anderen Ordner auswhlen"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Neuen Ordner erstellen"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Auf diesem Gert suchen"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Text lschen"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Dieser Ordner"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Stammordner"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"berall"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Beliebiger Zeitpunkt"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Heute"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Gestern"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Letzte Woche"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Letzter Monat"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Letztes Jahr"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Alle Typen"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"<xliff:g id="TEXT">%1$s</xliff:g>-Suchverlauf lschen"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Privat"</string>
     <string name="work_tab" msgid="7265359366883747413">"Geschftlich"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Wird im Listenmodus angezeigt."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Dateiname"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Dateivorschau ausblenden"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Keine Vorschau verfgbar"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Bildvorschau von <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-el/strings.xml b/res/values-el/strings.xml
index 7b403cbe4..236be2cf7 100644
--- a/res/values-el/strings.xml
+++ b/res/values-el/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">" "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"  "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"  "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"    <xliff:g id="APPNAME"><b>^1</b></xliff:g>    <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    <xliff:g id="STORAGE"><i>^3</i></xliff:g>;"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"    <xliff:g id="APPNAME"><b>^1</b></xliff:g>    <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>;"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"    <xliff:g id="APPNAME"><b>^1</b></xliff:g>    ,      ,    <xliff:g id="STORAGE"><i>^2</i></xliff:g>;"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one"> <xliff:g id="COUNT_0">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">""</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">" "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"     ,   "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"    "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"  "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"  "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"  <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-en-rAU/strings.xml b/res/values-en-rAU/strings.xml
index f35f46c0c..0ac644499 100644
--- a/res/values-en-rAU/strings.xml
+++ b/res/values-en-rAU/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Clear"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Show in provider"</string>
     <string name="button_back" msgid="1888621708934742182">"Back"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Show in folder"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Not sorted"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Name"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Summary"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Failed to rename document"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Eject"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Some files were converted"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"See details"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copied"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Moved"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Deleted"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Compressed"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extracted"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> directory on <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> directory?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to your data, including photos and videos, on <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> selected</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> selected</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Clear selection"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"open"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"deselect"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"select"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"drag"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"select multiple"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> items</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> item</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"To protect your privacy, choose another folder"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Create new folder"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Search this device"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Clear text"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"This folder"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Root folder"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Everywhere"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Any time"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Today"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Yesterday"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Last week"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Last month"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Last year"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"All types"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Delete search history <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Work"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Showing in list mode."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"File name"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Hide file preview"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"No preview available"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Image preview of <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-en-rCA/strings.xml b/res/values-en-rCA/strings.xml
index adfdf6111..03b2770a1 100644
--- a/res/values-en-rCA/strings.xml
+++ b/res/values-en-rCA/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Clear"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Show in provider"</string>
     <string name="button_back" msgid="1888621708934742182">"Back"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Show in folder"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Not sorted"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Name"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Summary"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Failed to rename document"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Eject"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Some files were converted"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"See details"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copied"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Moved"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Deleted"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Compressed"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extracted"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> directory on <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> directory?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to your data, including photos and videos, on <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> selected</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> selected</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Clear selection"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"open"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"deselect"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"select"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"drag"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"select multiple"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> items</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> item</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"To protect your privacy, choose another folder"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Create new folder"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Search this device"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Clear text"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"This folder"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Root folder"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Everywhere"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Any time"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Today"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Yesterday"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Last week"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Last month"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Last year"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"All types"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Delete search history <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Work"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Showing in list mode."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"File name"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Hide file preview"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"No preview available"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Image preview of <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-en-rGB/strings.xml b/res/values-en-rGB/strings.xml
index f35f46c0c..0ac644499 100644
--- a/res/values-en-rGB/strings.xml
+++ b/res/values-en-rGB/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Clear"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Show in provider"</string>
     <string name="button_back" msgid="1888621708934742182">"Back"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Show in folder"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Not sorted"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Name"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Summary"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Failed to rename document"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Eject"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Some files were converted"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"See details"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copied"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Moved"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Deleted"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Compressed"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extracted"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> directory on <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> directory?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to your data, including photos and videos, on <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> selected</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> selected</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Clear selection"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"open"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"deselect"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"select"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"drag"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"select multiple"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> items</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> item</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"To protect your privacy, choose another folder"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Create new folder"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Search this device"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Clear text"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"This folder"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Root folder"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Everywhere"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Any time"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Today"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Yesterday"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Last week"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Last month"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Last year"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"All types"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Delete search history <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Work"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Showing in list mode."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"File name"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Hide file preview"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"No preview available"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Image preview of <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-en-rIN/strings.xml b/res/values-en-rIN/strings.xml
index f35f46c0c..0ac644499 100644
--- a/res/values-en-rIN/strings.xml
+++ b/res/values-en-rIN/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Clear"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Show in provider"</string>
     <string name="button_back" msgid="1888621708934742182">"Back"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Show in folder"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Not sorted"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Name"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Summary"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Failed to rename document"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Eject"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Some files were converted"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"See details"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copied"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Moved"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Deleted"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Compressed"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extracted"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> directory on <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> directory?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Grant <xliff:g id="APPNAME"><b>^1</b></xliff:g> access to your data, including photos and videos, on <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> selected</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> selected</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Clear selection"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"open"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"deselect"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"select"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"drag"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"select multiple"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> items</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> item</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"To protect your privacy, choose another folder"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Create new folder"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Search this device"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Clear text"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"This folder"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Root folder"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Everywhere"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Any time"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Today"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Yesterday"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Last week"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Last month"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Last year"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"All types"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Delete search history <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Work"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Showing in list mode."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"File name"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Hide file preview"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"No preview available"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Image preview of <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-es-rUS/strings.xml b/res/values-es-rUS/strings.xml
index 68a382f45..f7d0af857 100644
--- a/res/values-es-rUS/strings.xml
+++ b/res/values-es-rUS/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Borrar"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Mostrar en el proveedor"</string>
     <string name="button_back" msgid="1888621708934742182">"Atrs"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Mostrar en carpeta"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Sin ordenar"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nombre"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Resumen"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"No se pudo cambiar el nombre del documento"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Expulsar"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Se convirtieron algunos archivos"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Ver detalles"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Se copi"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Se movi"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Se borr"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Se comprimi"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Se extrajo"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Quieres otorgar a la app de <xliff:g id="APPNAME"><b>^1</b></xliff:g> acceso al directorio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> en <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Quieres otorgar acceso a la app de <xliff:g id="APPNAME"><b>^1</b></xliff:g> al directorio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Quieres otorgar acceso a la app de <xliff:g id="APPNAME"><b>^1</b></xliff:g> a tus datos, incluidas tus fotos y videos, en <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> elementos seleccionados</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> elemento seleccionado</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Borrar seleccin"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"abrir"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"anular seleccin"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"seleccionar"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"arrastrar"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"seleccionar varios"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> elementos</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> elementos</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Para proteger tu privacidad, elige otra carpeta."</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Crear carpeta"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Buscar este dispositivo"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Borrar texto"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Esta carpeta"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Carpeta raz"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"En todas partes"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"En cualquier momento"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Hoy"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Ayer"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"La semana pasada"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"El mes pasado"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"El ao pasado"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Todos los tipos"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Borrar historial de bsqueda de <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Trabajo"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Se muestra en modo de lista."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nombre del archivo"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Ocultar vista previa del archivo"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Sin vista previa disponible"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Vista previa de la imagen de <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-es/strings.xml b/res/values-es/strings.xml
index 737500313..edd1995e2 100644
--- a/res/values-es/strings.xml
+++ b/res/values-es/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Borrar"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Mostrar en el proveedor"</string>
     <string name="button_back" msgid="1888621708934742182">"Atrs"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Mostrar en carpeta"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Sin ordenar"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nombre"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Resumen"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"No se ha podido cambiar el nombre del documento"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Expulsar"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Se han convertido algunos archivos"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Ver detalles"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copiado"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Movido"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Eliminado"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Comprimido"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extrado"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Permitir que <xliff:g id="APPNAME"><b>^1</b></xliff:g> acceda al directorio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> (<xliff:g id="STORAGE"><i>^3</i></xliff:g>)?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Permitir que <xliff:g id="APPNAME"><b>^1</b></xliff:g> acceda al directorio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Permitir que <xliff:g id="APPNAME"><b>^1</b></xliff:g> acceda a tus datos de <xliff:g id="STORAGE"><i>^2</i></xliff:g>, incluidos los vdeos y las fotos?"</string>
@@ -237,6 +244,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> seleccionados</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> seleccionado</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Anular seleccin"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"abrir"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"desmarcar"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"seleccionar"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"arrastrar"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"seleccionar varios"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> elementos</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> elementos</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Para proteger tu privacidad, elige otra carpeta"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Crear carpeta nueva"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Buscar en este dispositivo"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Borrar texto"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Esta carpeta"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Carpeta raz"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"En todas partes"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Cualquier hora"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Hoy"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Ayer"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Semana pasada"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Mes pasado"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Ao pasado"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Todos los tipos"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Eliminar el historial de bsqueda de <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Trabajo"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Mostrando modo de lista."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nombre del archivo"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Ocultar vista previa del archivo"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"No hay ninguna vista previa disponible"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Vista previa de la imagen de <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-et/strings.xml b/res/values-et/strings.xml
index 15b81449a..5ef0911ef 100644
--- a/res/values-et/strings.xml
+++ b/res/values-et/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Kustuta"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Kuva teenuses"</string>
     <string name="button_back" msgid="1888621708934742182">"Tagasi"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Kuva kaustas"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Sortimata"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nimi"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Kokkuvte"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Dokumendi mbernimetamine ebannestus"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Eemalda"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Mned failid teisendati"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Kuva ksikasjad"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopeeritud"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Teisaldatud"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Kustutatud"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Tihendatud"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Ekstraktitud"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Kas anda rakendusele <xliff:g id="APPNAME"><b>^1</b></xliff:g> juurdeps kataloogile <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> salvestusruumis <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Kas anda rakendusele <xliff:g id="APPNAME"><b>^1</b></xliff:g> juurdeps kataloogile <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Kas anda rakendusele <xliff:g id="APPNAME"><b>^1</b></xliff:g> juurdeps teie andmetele (sh fotod ja videod) salvestusruumis <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> on valitud</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> on valitud</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Valiku kustutamine"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"avatud"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"thista valik"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"vali"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"lohista"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"vali mitu"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> ksust</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> ksus</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Oma privaatsuse kaitsmiseks kasutage teist kausta"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Loo uus kaust"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Otsige selles seadmes"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Teksti kustutamine"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"See kaust"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Juurkaust"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Kikjal"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Mis tahes ajal"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Tna"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Eile"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Eelmine ndal"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Eelmine kuu"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Eelmine aasta"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Kik tbid"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Otsinguajaloo kustutamine <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Isiklik"</string>
     <string name="work_tab" msgid="7265359366883747413">"T"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Kuvatud loendivaates."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Faili nimi"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Faili eelvaate peitmine"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Eelvaade pole saadaval"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Faili <xliff:g id="FILENAME">%s</xliff:g> pildi eelvaade"</string>
 </resources>
diff --git a/res/values-eu/strings.xml b/res/values-eu/strings.xml
index 94305a6d7..13b15f5e6 100644
--- a/res/values-eu/strings.xml
+++ b/res/values-eu/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Garbitu"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Erakutsi hornitzailean"</string>
     <string name="button_back" msgid="1888621708934742182">"Atzera"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Erakutsi karpetan"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Ordenatu gabe"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Izena"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Laburpena"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Ezin izan zaio aldatu izena dokumentuari"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Atera"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Artxibo batzuk bihurtu dira"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Ikusi xehetasunak"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopiatu da"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Tokiz aldatu da"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Ezabatu da"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Konprimatu da"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Atera da"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> aplikazioari <xliff:g id="STORAGE"><i>^3</i></xliff:g> unitateko <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> direktoriorako sarbidea eman nahi diozu?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> aplikazioari <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> direktoriorako sarbidea eman nahi diozu?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> aplikazioari zure datuak erabiltzeko baimena eman nahi diozu (besteak beste, <xliff:g id="STORAGE"><i>^2</i></xliff:g> biltegian dituzun argazkiak eta bideoak)?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> hautatuta</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> hautatuta</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Garbitu hautapena"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"ireki"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"desautatu"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"hautatu"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"arrastatu"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"hautatu bat baino gehiago"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> elementu</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> elementu</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Pribatutasuna babesteko, aukeratu beste karpeta bat"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Sortu karpeta bat"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Bilatu gailu honetan"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Garbitu testua"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Karpeta hau"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Erroko karpeta"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Edonon"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Edonoiz"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Gaur"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Atzo"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Joan den astekoak"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Joan den hilabetekoak"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Iaz"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Mota guztiak"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Ezabatu bilaketa-historia (<xliff:g id="TEXT">%1$s</xliff:g>)"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Pertsonala"</string>
     <string name="work_tab" msgid="7265359366883747413">"Lanekoa"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Zerrenda moduan ikusgai."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Fitxategiaren izena"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Ezkutatu fitxategiaren aurrebista"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Ez dago aurrebistarik erabilgarri"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g> fitxategiaren aurrebista-irudia"</string>
 </resources>
diff --git a/res/values-fa/strings.xml b/res/values-fa/strings.xml
index c108d9f07..05a17246d 100644
--- a/res/values-fa/strings.xml
+++ b/res/values-fa/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">" "</string>
     <string name="button_show_provider" msgid="6905880493806292753">"   "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">"  "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">" "</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"    "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">" "</string>
+    <string name="move_completed" msgid="3981250605092729273">" "</string>
+    <string name="delete_completed" msgid="4149401155614626199">" "</string>
+    <string name="compress_completed" msgid="8808356399995313077">" "</string>
+    <string name="extract_completed" msgid="8824595789915249972">" "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>       <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>   "</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>       <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   "</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>              <xliff:g id="STORAGE"><i>^2</i></xliff:g>"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g>   </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>   </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"  "</string>
+    <string name="document_click_action" msgid="8073338575301415356">" "</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"  "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">" "</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"   "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"        "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"  "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"   "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"  "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"  <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-fi/strings.xml b/res/values-fi/strings.xml
index 7b888bfd4..41617cda0 100644
--- a/res/values-fi/strings.xml
+++ b/res/values-fi/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Tyhjenn"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Nyt palveluntarjoajan sovelluksessa"</string>
     <string name="button_back" msgid="1888621708934742182">"Takaisin"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Nyt kansiossa"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Ei lajittelua"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nimi"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Yhteenveto"</string>
@@ -120,7 +121,7 @@
     <string name="root_type_device" msgid="1713604128005476585">"Laitteet"</string>
     <string name="root_type_apps" msgid="8646073235029886342">"Lis sovelluksia"</string>
     <string name="empty" msgid="5300254272613103004">"Ei kohteita"</string>
-    <string name="no_results" msgid="2371026325236359209">"Ei osumia kohteessa %1$s."</string>
+    <string name="no_results" msgid="2371026325236359209">"%1$s ei sisltnyt vastaavuuksia"</string>
     <string name="toast_no_application" msgid="7555319548595113121">"Tiedoston avaaminen eponnistui."</string>
     <string name="toast_view_in_archives_unsupported" msgid="1923221390170964845">"Arkistoissa olevia tiedostoja ei voi avata."</string>
     <string name="toast_failed_delete" msgid="3453846588205817591">"Joidenkin dokumenttien poistaminen eponnistui."</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Dokumentin nimen muuttaminen eponnistui."</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Poista"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Joitakin tiedostoja muunnettiin."</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Katso tiedot"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopioitu"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Siirretty"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Poistettu"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Pakattu"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Poimittu"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Mynnetnk sovellukselle <xliff:g id="APPNAME"><b>^1</b></xliff:g> sijainnissa <xliff:g id="STORAGE"><i>^3</i></xliff:g> olevan hakemiston <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> kyttoikeus?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Saako <xliff:g id="APPNAME"><b>^1</b></xliff:g> kytt hakemistoa <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Mynnetnk sovellukselle <xliff:g id="APPNAME"><b>^1</b></xliff:g> sijainnissa <xliff:g id="STORAGE"><i>^2</i></xliff:g> olevien tietojesi (mukaan lukien valokuvien ja videoiden) kyttoikeus?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> valittua kohdetta</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> valittu kohde</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Tyhjenn valinta"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"auki"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"poista valinta"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"valitse"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"ved"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"valitse useita"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> kohdetta</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> kohde</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Valitse toinen kansio tietosuojasi turvaamiseksi"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Luo uusi kansio"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Hae tlt laitteelta"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Tyhjenn teksti"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Tm kansio"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Juurikansio"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Kaikkialla"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Kaikki"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Tm piv"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Eilinen"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Viime viikko"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Viime kuukausi"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Viime vuosi"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Kaikki tyypit"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Poista hakuhistoria <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Henkilkohtainen"</string>
     <string name="work_tab" msgid="7265359366883747413">"Ty"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Nytetn luettelotilassa."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Tiedostonimi"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Piilota tiedoston esikatselu"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Esikatselu ei saatavilla"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Kuvan esikatselu: <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-fr-rCA/strings.xml b/res/values-fr-rCA/strings.xml
index 62d18393d..daff7bb37 100644
--- a/res/values-fr-rCA/strings.xml
+++ b/res/values-fr-rCA/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Effacer"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Afficher dans l\'appli du fournisseur"</string>
     <string name="button_back" msgid="1888621708934742182">"Retour"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Afficher dans le dossier"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Non tris"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nom"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Rsum"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Impossible de renommer le document"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"jecter"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Certains fichiers ont t convertis"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Affichez les dtails"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copi"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Dplac"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Supprim"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Compress"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extrait"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Accorder  <xliff:g id="APPNAME"><b>^1</b></xliff:g> l\'accs au rpertoire <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> sur <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Accorder  <xliff:g id="APPNAME"><b>^1</b></xliff:g> l\'accs au rpertoire <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Voulez-vous accorder l\'accs  vos donnes  <xliff:g id="APPNAME"><b>^1</b></xliff:g>, y compris vos photos et vos vidos, sur <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g>lments slectionns</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>lments slectionns</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Effacer la slection"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"ouvrir"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"dslectionner"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"slectionner"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"glisser"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"slectionner plusieurs lments"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> article</item>
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> articles</item>
@@ -307,13 +320,27 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Pour protger votre confidentialit, choisissez un autre dossier"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Crer un dossier"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Faire une recherche dans cet appareil"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Effacer le texte"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Ce dossier"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Dossier racine"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Partout"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" tout moment"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Aujourd\'hui"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Hier"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"La semaine dernire"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Le mois dernier"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"L\'anne dernire"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Tous les types"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Supprimer l\'historique de recherche <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personnel"</string>
     <string name="work_tab" msgid="7265359366883747413">"Professionnel"</string>
-    <string name="a11y_work" msgid="7504431382825242153">"Travail"</string>
+    <string name="a11y_work" msgid="7504431382825242153">"Professionnel"</string>
     <string name="drag_from_another_app" msgid="8310249276199969905">"Vous ne pouvez pas dplacer de fichiers d\'une autre appli."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Affichage en mode grille."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Affichage en mode liste."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nom de fichier"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Masquer l\'aperu du fichier"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Aucun aperu n\'est accessible"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Aperu de l\'image de <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-fr/strings.xml b/res/values-fr/strings.xml
index 3c1475290..e71d0d18f 100644
--- a/res/values-fr/strings.xml
+++ b/res/values-fr/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Effacer"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Afficher dans le fournisseur"</string>
     <string name="button_back" msgid="1888621708934742182">"Retour"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Afficher dans le dossier"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Non tris"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nom"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Rsum"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"chec du changement de nom du document"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"jecter"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Certains fichiers ont t convertis"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Voir les dtails"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copi"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Dplac"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Supprim"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Compress"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extrait"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Autoriser <xliff:g id="APPNAME"><b>^1</b></xliff:g>  accder  l\'annuaire \"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>\" sur <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Autoriser <xliff:g id="APPNAME"><b>^1</b></xliff:g>  accder  l\'annuaire \"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>\"?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Autoriser <xliff:g id="APPNAME"><b>^1</b></xliff:g>  accder  vos donnes, y compris les photos et les vidos, sur <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g>lments slectionns</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>lments slectionns</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Annuler la slection"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"dvelopper"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"dslectionner"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"slectionner"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"faire glisser"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"slectionner plusieurs lments"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g>lment</item>
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g>lments</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Pour protger votre vie prive, choisissez un autre dossier"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Crer un dossier"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Rechercher sur cet appareil"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Effacer le texte"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Ce dossier"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Dossier racine"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Partout"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Date indiffrente"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Aujourd\'hui"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Hier"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"La semaine dernire"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Le mois dernier"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"L\'anne dernire"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Tous les types"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Supprimer l\'historique des recherches <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personnel"</string>
     <string name="work_tab" msgid="7265359366883747413">"Professionnel"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Affichage en mode liste."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nom du fichier"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Masquer l\'aperu du fichier"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Aucun aperu disponible"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Aperu de l\'image <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-gl/strings.xml b/res/values-gl/strings.xml
index d45dbc211..26fd25183 100644
--- a/res/values-gl/strings.xml
+++ b/res/values-gl/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Borrar"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Mostrar no provedor"</string>
     <string name="button_back" msgid="1888621708934742182">"Volver"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Mostrar no cartafol"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Sen ordenar"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nome"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Resumo"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Non se puido cambiar o nome do documento"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Expulsar"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Convertronse algns ficheiros"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Ver detalles"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copia completada"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Traslado completado"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Eliminacin completada"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Compresin completada"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extraccin completada"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Queres outorgar acceso a <xliff:g id="APPNAME"><b>^1</b></xliff:g> ao directorio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> no almacenamento de <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Queres outorgar acceso a <xliff:g id="APPNAME"><b>^1</b></xliff:g> ao directorio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Queres outorgar acceso a <xliff:g id="APPNAME"><b>^1</b></xliff:g> aos teus datos almacenados en <xliff:g id="STORAGE"><i>^2</i></xliff:g>, includos vdeos e fotos?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other">Seleccionronse <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one">Seleccionouse <xliff:g id="COUNT_0">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Borrar a seleccin"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"abrir"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"anular a seleccin"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"seleccionar"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"arrastrar"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"seleccionar mltiples"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> elementos</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> elemento</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Para protexer a ta privacidade, escolle outro cartafol"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Crear novo cartafol"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Busca contido neste dispositivo"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Borrar o texto"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Este cartafol"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Cartafol raz"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"En calquera lugar"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"En calquera momento"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Hoxe"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Onte"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"A semana pasada"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"O mes pasado"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"O ano pasado"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Todo os tipos"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Elimina o historial de busca <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Persoal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Traballo"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Mostrando modo de lista."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nome do ficheiro"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Ocultar a vista previa do ficheiro"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Non hai ningunha vista previa dispoible"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Imaxe de vista previa de <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-gu/inspector_strings.xml b/res/values-gu/inspector_strings.xml
index 2184995bb..840090480 100644
--- a/res/values-gu/inspector_strings.xml
+++ b/res/values-gu/inspector_strings.xml
@@ -43,5 +43,5 @@
     <string name="metadata_artist" msgid="8972421485694988540">""</string>
     <string name="metadata_composer" msgid="4696926808308256056">""</string>
     <string name="metadata_album" msgid="1661699531214720236">""</string>
-    <string name="metadata_address" msgid="1849921023707744640">""</string>
+    <string name="metadata_address" msgid="1849921023707744640">""</string>
 </resources>
diff --git a/res/values-gu/strings.xml b/res/values-gu/strings.xml
index 7f5ffa3e0..af40cc1da 100644
--- a/res/values-gu/strings.xml
+++ b/res/values-gu/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">" "</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">"  "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -153,7 +154,7 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g>     .</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>     .</item>
     </plurals>
-    <string name="undo" msgid="2902438994196400565">" "</string>
+    <string name="undo" msgid="2902438994196400565">"   "</string>
     <string name="copy_preparing" msgid="4759516490222449324">"   "</string>
     <string name="compress_preparing" msgid="7401605598969019696">"   "</string>
     <string name="extract_preparing" msgid="4796626960061745796">"   "</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"    "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">" "</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"    "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">"  "</string>
+    <string name="move_completed" msgid="3981250605092729273">" "</string>
+    <string name="delete_completed" msgid="4149401155614626199">" "</string>
+    <string name="compress_completed" msgid="8808356399995313077">" "</string>
+    <string name="extract_completed" msgid="8824595789915249972">" "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^2</i></xliff:g>         ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g>  </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>  </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"  "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">" "</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"   "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"    ,    "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"  "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">" "</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"  <xliff:g id="TEXT">%1$s</xliff:g>  "</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"    ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>  "</string>
 </resources>
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-h600dp-v31/dimens.xml b/res/values-h600dp-v31/dimens.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-h600dp-v31/dimens.xml
rename to res/values-h600dp-v31/dimens.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-h600dp/dimens.xml b/res/values-h600dp/dimens.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-h600dp/dimens.xml
rename to res/values-h600dp/dimens.xml
diff --git a/res/values-hi/strings.xml b/res/values-hi/strings.xml
index 7fc004024..91b5f3d79 100644
--- a/res/values-hi/strings.xml
+++ b/res/values-hi/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">" "</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">" "</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">"  "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"     "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"     "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">"  "</string>
+    <string name="move_completed" msgid="3981250605092729273">"  "</string>
+    <string name="delete_completed" msgid="4149401155614626199">" "</string>
+    <string name="compress_completed" msgid="8808356399995313077">"   "</string>
+    <string name="extract_completed" msgid="8824595789915249972">"   "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>      ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>      ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^2</i></xliff:g>       ,       ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"   "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"    "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"  "</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"    "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -284,7 +297,18 @@
     <string name="directory_blocked_header_title" msgid="1164584889578740066">"       "</string>
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"      ,    "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
-    <string name="search_bar_hint" msgid="146031513183888721">"     "</string>
+    <string name="search_bar_hint" msgid="146031513183888721">"   "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"  "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"  "</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"    <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">"  "</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"      ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"  "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"   "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>    "</string>
 </resources>
diff --git a/res/values-hr/strings.xml b/res/values-hr/strings.xml
index e12bc50f0..1ffa20ae0 100644
--- a/res/values-hr/strings.xml
+++ b/res/values-hr/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Izbrii"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Prikai na davatelju usluga"</string>
     <string name="button_back" msgid="1888621708934742182">"Natrag"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Prikai u mapi"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Nije poredano"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Naziv"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Saetak"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Naziv dokumenta nije promijenjen"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Izbaci"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Neke su datoteke konvertirane"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Pregled pojedinosti"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopirano"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Preseljeno"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Izbrisano"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Komprimirano"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Izdvojeno"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"elite li aplikaciji <xliff:g id="APPNAME"><b>^1</b></xliff:g> odobriti pristup direktoriju <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> na vanjskoj pohrani (<xliff:g id="STORAGE"><i>^3</i></xliff:g>)?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"elite li aplikaciji <xliff:g id="APPNAME"><b>^1</b></xliff:g> odobriti pristup direktoriju <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"elite li aplikaciji <xliff:g id="APPNAME"><b>^1</b></xliff:g> dopustiti pristup podacima, ukljuujui fotografije i videozapise na vanjskoj pohrani (<xliff:g id="STORAGE"><i>^2</i></xliff:g>)?"</string>
@@ -237,6 +244,12 @@
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> odabrane</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> odabranih</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Poniti odabir"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"otvaranje"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"ponitavanje odabira"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"odabir"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"povlaenje"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"viestruki odabir"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> stavka</item>
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> stavke</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Radi zatite vlastite sigurnosti odaberite neku drugu mapu"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Izradi novu mapu"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Pretrai ovaj ureaj"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Izbrii tekst"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Ova mapa"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Korijenska mapa"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Svugdje"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Bilo kad"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Danas"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Juer"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Proli tjedan"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Proli mjesec"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Prola godina"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Sve vrste"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Brisanje povijesti pretraivanja <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Osobno"</string>
     <string name="work_tab" msgid="7265359366883747413">"Posao"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Prikazivanje u nainu popisa."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Naziv datoteke"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Sakrij pregled datoteke"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Pregled nije dostupan"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Pregled slike <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-hu/strings.xml b/res/values-hu/strings.xml
index 7119be420..50e459e22 100644
--- a/res/values-hu/strings.xml
+++ b/res/values-hu/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Trls"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Megjelents a szolgltatnl"</string>
     <string name="button_back" msgid="1888621708934742182">"Vissza"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Megjelents mappban"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Nincs rendezve"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nv"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"sszefoglals"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Nem sikerlt tnevezni a dokumentumot"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Kiads"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Egyes fjlokat sikerlt talaktani"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Rszletek megtekintse"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Msolva"</string>
+    <string name="move_completed" msgid="3981250605092729273">"thelyezve"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Trlve"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Tmrtve"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Kibontva"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Hozzfrst biztost a(z) <xliff:g id="APPNAME"><b>^1</b></xliff:g> szmra a(z) <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> knyvtrhoz itt: <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Hozzfrst biztost a(z) <xliff:g id="APPNAME"><b>^1</b></xliff:g> alkalmazsnak a(z) <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> knyvtrhoz?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Hozzfrst biztost a(z) <xliff:g id="STORAGE"><i>^2</i></xliff:g> trhelyen tallhat adataihoz a(z) <xliff:g id="APPNAME"><b>^1</b></xliff:g> szmra, belertve a kpeket s videkat is?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> kivlasztva</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> kivlasztva</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Kijells trlse"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"megnyits"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"kivlaszts megszntetse"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"kivlaszts"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"hzs"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"tbb kivlasztsa"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> elem</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> elem</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Adatainak vdelme rdekben vlasszon msik mappt"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"j mappa ltrehozsa"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Keress az eszkzn"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Szveg trlse"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Ez a mappa"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Gykrmappa"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Mindenhol"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Brmikor"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Ma"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Tegnap"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Elz hten"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Elz hnapban"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Elz vben"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Az sszes tpus"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Keressi elzmnyek trlse  <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Szemlyes"</string>
     <string name="work_tab" msgid="7265359366883747413">"Munkahelyi"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Megjelents listanzetben."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Fjlnv"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Fjl elnzetnek elrejtse"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Nincs megtekinthet elnzet"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"A(z) <xliff:g id="FILENAME">%s</xliff:g> kp elnzete"</string>
 </resources>
diff --git a/res/values-hy/strings.xml b/res/values-hy/strings.xml
index bf75c96c1..d9cbbb229 100644
--- a/res/values-hy/strings.xml
+++ b/res/values-hy/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">" "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">" "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"  "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"   "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>   <xliff:g id="STORAGE"><i>^3</i></xliff:g>- <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   :"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>   <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   :"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>   <xliff:g id="STORAGE"><i>^2</i></xliff:g>-   ,      ,  :"</string>
@@ -220,6 +227,12 @@
       <item quantity="one">  <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="other">  <xliff:g id="COUNT_1">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">" "</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"  "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">" "</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">" "</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"    "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"         "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"   "</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"  "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>  "</string>
 </resources>
diff --git a/res/values-in/strings.xml b/res/values-in/strings.xml
index 5ac5aa336..c761dc400 100644
--- a/res/values-in/strings.xml
+++ b/res/values-in/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Hapus"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Tampilkan di provider"</string>
     <string name="button_back" msgid="1888621708934742182">"Kembali"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Tampilkan dalam folder"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Tidak diurutkan"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nama"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Ringkasan"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Gagal mengganti nama dokumen"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Keluarkan"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Beberapa file dikonversi"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Lihat detail"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Disalin"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Dipindahkan"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Dihapus"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Dikompresi"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Diekstrak"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Beri <xliff:g id="APPNAME"><b>^1</b></xliff:g> akses ke direktori <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> di <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Beri <xliff:g id="APPNAME"><b>^1</b></xliff:g> akses ke direktori <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Beri <xliff:g id="APPNAME"><b>^1</b></xliff:g> akses ke data Anda, termasuk foto dan video, di <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> dipilih</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> dipilih</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Hapus pilihan"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"buka"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"batalkan pilihan"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"pilih"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"tarik"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"pilih beberapa"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> item</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> item</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Untuk melindungi privasi, pilih folder lain"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Buat folder baru"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Telusuri perangkat ini"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Hapus teks"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Folder ini"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Folder root"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Di mana saja"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Kapan saja"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Hari ini"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Kemarin"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Minggu lalu"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Bulan lalu"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Tahun lalu"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Semua jenis"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Menghapus histori penelusuran <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Pribadi"</string>
     <string name="work_tab" msgid="7265359366883747413">"Kerja"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Menampilkan dalam mode daftar."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nama file"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Sembunyikan pratinjau file"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Pratinjau tidak tersedia"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Pratinjau gambar <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-is/strings.xml b/res/values-is/strings.xml
index f78a5fc63..84b250322 100644
--- a/res/values-is/strings.xml
+++ b/res/values-is/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Hreinsa"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Sna  jnustu"</string>
     <string name="button_back" msgid="1888621708934742182">"Til baka"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Sna  mppu"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Ekki flokku"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Heiti"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Samantekt"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Ekki tkst a endurnefna skjali"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Fjarlgja"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Sumum skrm var umbreytt"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Sj nnar"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Afrita"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Flutt"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Eytt"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"jappa"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Dregin t"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Viltu veita <xliff:g id="APPNAME"><b>^1</b></xliff:g> agang a skrasafninu <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Viltu veita <xliff:g id="APPNAME"><b>^1</b></xliff:g> agang a skrasafninu <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Viltu veita <xliff:g id="APPNAME"><b>^1</b></xliff:g> agang a ggnunum num, ar  meal myndum og myndskeium,  <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> vali</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> valin</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Hreinsa val"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"opna"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"afvelja"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"velja"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"draga"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"velja margt"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> atrii</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> atrii</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Veldu ara mppu til a tryggja persnuvernd na"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Ba til nja mppu"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Leita  essu tki"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Hreinsa texta"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"essi mappa"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Rtarmappa"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Alls staar"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Hvenr sem er"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">" dag"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">" gr"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" sustu viku"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" sasta mnui"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" fyrra"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Allar gerir"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Eya leitarferli <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Einkasni"</string>
     <string name="work_tab" msgid="7265359366883747413">"Vinna"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Snir listayfirlit."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Skrarheiti"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Fela forskoun skrar"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Engin forskoun  boi"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Forskounarmynd af <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-it/inspector_strings.xml b/res/values-it/inspector_strings.xml
index d86da2ecd..93dc9251f 100644
--- a/res/values-it/inspector_strings.xml
+++ b/res/values-it/inspector_strings.xml
@@ -35,7 +35,7 @@
     <string name="metadata_aperture" msgid="6538741952698935357">"Apertura"</string>
     <string name="metadata_shutter_speed" msgid="8204739885103326131">"Tempo di esposizione"</string>
     <string name="metadata_duration" msgid="3115494422055472715">"Durata"</string>
-    <string name="metadata_date_time" msgid="1090351199248114406">"Data/ora"</string>
+    <string name="metadata_date_time" msgid="1090351199248114406">"Scattata su"</string>
     <string name="metadata_focal_length" msgid="3440735161407699893">"Lunghezza focale"</string>
     <string name="metadata_focal_format" msgid="8542211707962355623">"<xliff:g id="LENGTH">%1$.2f </xliff:g> mm"</string>
     <string name="metadata_iso_speed_ratings" msgid="1699781252899759058">"ISO equivalenti"</string>
diff --git a/res/values-it/strings.xml b/res/values-it/strings.xml
index a289cd8b2..7b444fa08 100644
--- a/res/values-it/strings.xml
+++ b/res/values-it/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Cancella"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Mostra in provider"</string>
     <string name="button_back" msgid="1888621708934742182">"Indietro"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Mostra nella cartella"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Nessun ordine"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nome"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Riepilogo"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Ridenominazione documento non riuscita"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Espelli"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Alcuni file sono stati convertiti"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Visualizza dettagli"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copia completata"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Spostamento completato"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Eliminazione completata"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Compressione completata"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Estrazione completata"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Concedere all\'app <xliff:g id="APPNAME"><b>^1</b></xliff:g> l\'accesso alla directory <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> su <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Concedere all\'app <xliff:g id="APPNAME"><b>^1</b></xliff:g> l\'accesso alla directory <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Concedere all\'app <xliff:g id="APPNAME"><b>^1</b></xliff:g> l\'accesso ai tuoi dati, inclusi video e foto, sull\'unit <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> selezionati</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> selezionato</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Cancella selezione"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"aprire"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"deselezionare"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"selezionare"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"trascinare"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"selezionare pi elementi"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> di elementi</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> elementi</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Per tutelare la tua privacy, scegli un\'altra cartella"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Crea nuova cartella"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Cerca su questo dispositivo"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Cancella testo"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Questa cartella"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Cartella principale"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Ovunque"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"In qualsiasi momento"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Oggi"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Ieri"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Ultima settimana"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Mese scorso"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Ultimo anno"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Tutti i tipi"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Elimina la cronologia delle ricerche <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personale"</string>
     <string name="work_tab" msgid="7265359366883747413">"Lavoro"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Visualizzazione in modalit elenco."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nome file"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Nascondi anteprima del file"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Nessuna anteprima disponibile"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Anteprima dell\'immagine <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-iw/strings.xml b/res/values-iw/strings.xml
index e4beae2ac..4f3bec654 100644
--- a/res/values-iw/strings.xml
+++ b/res/values-iw/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"   "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">" "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"      "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"  "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">""</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">" "</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">" "</string>
+    <string name="extract_completed" msgid="8824595789915249972">" "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"  <xliff:g id="APPNAME"><b>^1</b></xliff:g>   <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"  <xliff:g id="APPNAME"><b>^1</b></xliff:g>   <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"  <xliff:g id="APPNAME"><b>^1</b></xliff:g>    (  )  -<xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="two"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"  "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="two"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -306,7 +319,18 @@
     <string name="directory_blocked_header_title" msgid="1164584889578740066">"    "</string>
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"    ,    "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
-    <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"    "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"  "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"   <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-ja/strings.xml b/res/values-ja/strings.xml
index 2f3c14114..b98a23c45 100644
--- a/res/values-ja/strings.xml
+++ b/res/values-ja/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">""</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">""</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">""</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">""</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">""</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="STORAGE"><i>^3</i></xliff:g> <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> "</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> "</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="STORAGE"><i>^2</i></xliff:g><xliff:g id="APPNAME"><b>^1</b></xliff:g>"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">""</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">""</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">""</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">""</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">""</string>
     <string name="search_bar_hint" msgid="146031513183888721">""</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">""</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">""</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">""</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">""</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">""</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">""</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">""</string>
     <string name="delete_search_history" msgid="2202015025607694515">"<xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">""</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">""</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">""</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g> "</string>
 </resources>
diff --git a/res/values-ka/strings.xml b/res/values-ka/strings.xml
index ddf8bfcd4..4e4a55049 100644
--- a/res/values-ka/strings.xml
+++ b/res/values-ka/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">" "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"  "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">", <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>-  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">", <xliff:g id="APPNAME"><b>^1</b></xliff:g>   <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">", <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^2</i></xliff:g>-  ,  ,   ,  ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one"> <xliff:g id="COUNT_0">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">" "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"     "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"   "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">" "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>-  "</string>
 </resources>
diff --git a/res/values-kk/strings.xml b/res/values-kk/strings.xml
index 2d6645340..7fe1d85c8 100644
--- a/res/values-kk/strings.xml
+++ b/res/values-kk/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">" "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">" "</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"  "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"  "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">"."</string>
+    <string name="move_completed" msgid="3981250605092729273">"."</string>
+    <string name="delete_completed" msgid="4149401155614626199">"."</string>
+    <string name="compress_completed" msgid="8808356399995313077">"."</string>
+    <string name="extract_completed" msgid="8824595789915249972">"."</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>     ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>     ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^2</i></xliff:g>  ,         ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">" "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"     "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"  "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"  <xliff:g id="TEXT">%1$s</xliff:g> "</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"   "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"    "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>    "</string>
 </resources>
diff --git a/res/values-km/strings.xml b/res/values-km/strings.xml
index dbe6f87e1..dd02cd302 100644
--- a/res/values-km/strings.xml
+++ b/res/values-km/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">""</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">""</string>
     <string name="not_sorted" msgid="7813496644889115530">"Not sorted"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">""</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">""</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">""</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g> ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>     <xliff:g id="STORAGE"><i>^2</i></xliff:g> ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one"> <xliff:g id="COUNT_0">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">""</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">""</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">""</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">" "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">""</string>
     <string name="search_bar_hint" msgid="146031513183888721">""</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">""</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">""</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">""</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">""</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">""</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">""</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">""</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">""</string>
     <string name="delete_search_history" msgid="2202015025607694515">" <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">""</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">""</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">""</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">" <xliff:g id="FILENAME">%s</xliff:g> "</string>
 </resources>
diff --git a/res/values-kn/strings.xml b/res/values-kn/strings.xml
index ab92d4130..209addbf3 100644
--- a/res/values-kn/strings.xml
+++ b/res/values-kn/strings.xml
@@ -41,7 +41,7 @@
     <string name="menu_deselect_all" msgid="7729916068862742979">"  "</string>
     <string name="menu_select" msgid="1366061076507142387">""</string>
     <string name="menu_sort" msgid="3362419226163725275">" ..."</string>
-    <string name="menu_copy" msgid="7404820171352314754">" "</string>
+    <string name="menu_copy" msgid="7404820171352314754">"  "</string>
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
@@ -55,21 +55,22 @@
     <string name="menu_view_in_owner" msgid="7228948660557554770">"<xliff:g id="SOURCE">%1$s</xliff:g>  "</string>
     <string name="menu_new_window" msgid="2947837751796109126">" "</string>
     <string name="menu_cut_to_clipboard" msgid="2878752142015026229">""</string>
-    <string name="menu_copy_to_clipboard" msgid="5064081159073330776">""</string>
+    <string name="menu_copy_to_clipboard" msgid="5064081159073330776">" "</string>
     <string name="menu_paste_from_clipboard" msgid="360947260414135827">""</string>
-    <string name="menu_paste_into_folder" msgid="8000644546983240101">" "</string>
+    <string name="menu_paste_into_folder" msgid="8000644546983240101">"  "</string>
     <string name="menu_advanced_show" msgid="7558626506462906726">"  "</string>
     <string name="menu_advanced_hide" msgid="6488381508009246334">"  "</string>
     <string name="button_select" msgid="240863497069321364">""</string>
-    <string name="button_copy" msgid="8219059853840996027">""</string>
+    <string name="button_copy" msgid="8219059853840996027">" "</string>
     <string name="button_compress" msgid="8951561310857223966">""</string>
     <string name="button_extract" msgid="1038674453689912247">""</string>
-    <string name="button_move" msgid="8596460499325291272">""</string>
+    <string name="button_move" msgid="8596460499325291272">""</string>
     <string name="button_dismiss" msgid="7235249361023803349">""</string>
     <string name="button_retry" msgid="4011461781916631389">" "</string>
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">" "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"  "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"  "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">" "</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">" "</string>
+    <string name="extract_completed" msgid="8824595789915249972">" "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="APPNAME"><b>^1</b></xliff:g>  ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="APPNAME"><b>^1</b></xliff:g>   ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="STORAGE"><i>^2</i></xliff:g>         <xliff:g id="APPNAME"><b>^1</b></xliff:g>  ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">" "</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">" "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"  ,    "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"  "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>  "</string>
 </resources>
diff --git a/res/values-ko/strings.xml b/res/values-ko/strings.xml
index a852f9df8..cb8a1ec59 100644
--- a/res/values-ko/strings.xml
+++ b/res/values-ko/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">" "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -102,7 +103,7 @@
     <string name="cant_select_work_files_error_title" msgid="6688716319549644354">"    "</string>
     <string name="cant_select_work_files_error_message" msgid="683480676150690641">"IT        ."</string>
     <string name="cant_select_personal_files_error_title" msgid="3200697170148617742">"    "</string>
-    <string name="cant_select_personal_files_error_message" msgid="4105905035459118209">"IT        ."</string>
+    <string name="cant_select_personal_files_error_message" msgid="4105905035459118209">"IT        ."</string>
     <string name="cant_select_cross_profile_files_error_title" msgid="17010948874969413">"<xliff:g id="PROFILE">%1$s</xliff:g>    "</string>
     <string name="cant_select_cross_profile_files_error_message" msgid="3815829574883844944">"IT  <xliff:g id="PROFILE_1">%2$s</xliff:g>  <xliff:g id="PROFILE_0">%1$s</xliff:g>    ."</string>
     <string name="cant_save_to_work_error_title" msgid="1351323070040641358">"    "</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   ."</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"  ."</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>() <xliff:g id="STORAGE"><i>^3</i></xliff:g> <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> ,   <xliff:g id="STORAGE"><i>^2</i></xliff:g>    ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"  "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one"> <xliff:g id="COUNT_0">%1$d</xliff:g></item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"     ."</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">""</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">""</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">""</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>  "</string>
 </resources>
diff --git a/res/values-ky/strings.xml b/res/values-ky/strings.xml
index 1e9a3dcf3..704ed5ff9 100644
--- a/res/values-ky/strings.xml
+++ b/res/values-ky/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">" "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"   "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"- "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">" "</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^2</i></xliff:g>  -,      ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"     "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">""</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"  : <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"    "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>    "</string>
 </resources>
diff --git a/res/values-lo/strings.xml b/res/values-lo/strings.xml
index 46370f5c0..4afe9fa07 100644
--- a/res/values-lo/strings.xml
+++ b/res/values-lo/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">""</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">""</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">""</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">""</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">""</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g> ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>     <xliff:g id="STORAGE"><i>^2</i></xliff:g> ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"> <xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">""</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">""</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">""</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,13 +298,27 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">""</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">""</string>
     <string name="search_bar_hint" msgid="146031513183888721">""</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">""</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">""</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" root"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">""</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">""</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">""</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">""</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">""</string>
     <string name="delete_search_history" msgid="2202015025607694515">" <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
-    <string name="work_tab" msgid="7265359366883747413">""</string>
+    <string name="work_tab" msgid="7265359366883747413">""</string>
     <string name="a11y_work" msgid="7504431382825242153">""</string>
     <string name="drag_from_another_app" msgid="8310249276199969905">"."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">""</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">""</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">""</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">" <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-lt/strings.xml b/res/values-lt/strings.xml
index 1398ebe85..b3bbdb318 100644
--- a/res/values-lt/strings.xml
+++ b/res/values-lt/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Ivalyti"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Rodyti naudojant teikjo program"</string>
     <string name="button_back" msgid="1888621708934742182">"Atgal"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Rodyti aplanke"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Neriuota"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Pavadinimas"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Suvestin"</string>
@@ -243,6 +244,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Nepavyko pervardyti dokumento"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Paalinti"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Kai kurie failai buvo konvertuoti"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"r. isami informacij"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Nukopijuota"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Perkelta"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Itrinta"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Suglaudinta"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Iskleista"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Suteikti <xliff:g id="APPNAME"><b>^1</b></xliff:g> prieig prie katalogo <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Suteikti <xliff:g id="APPNAME"><b>^1</b></xliff:g> prieig prie katalogo <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Suteikti programai <xliff:g id="APPNAME"><b>^1</b></xliff:g> prieig prie duomen, skaitant nuotraukas ir vaizdo raus, <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -254,6 +261,12 @@
       <item quantity="many">Pasirinkta <xliff:g id="COUNT_1">%1$d</xliff:g> failo</item>
       <item quantity="other">Pasirinkta <xliff:g id="COUNT_1">%1$d</xliff:g> fail</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Ivalyti pasirinkim"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"atidaryti"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"panaikinti pasirinkim"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"pasirinkti"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"vilkti"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"pasirinkti kelis"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> elementas</item>
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> elementai</item>
@@ -329,6 +342,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Kad apsaugotumte privatum, pasirinkite kit aplank"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Kurti nauj aplank"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Iekoti iame renginyje"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Ivalyti tekst"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"is aplankas"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"akninis aplankas"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Visur"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Bet kuriuo metu"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"iandien"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Vakar"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Prajusi savait"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Prajs mnuo"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Praj metai"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Visi tipai"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Itrinkite paiekos istorij <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Asmeninis"</string>
     <string name="work_tab" msgid="7265359366883747413">"Darbo"</string>
@@ -338,4 +362,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Rodoma srao reimu."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Failo pavadinimas"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Slpti failo perir"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Perira nepasiekiama"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g> vaizdo perira"</string>
 </resources>
diff --git a/res/values-lv/strings.xml b/res/values-lv/strings.xml
index 8879c27de..1254cd45c 100644
--- a/res/values-lv/strings.xml
+++ b/res/values-lv/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Dzst"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Rdt nodrointj"</string>
     <string name="button_back" msgid="1888621708934742182">"Atpaka"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Rdt map"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Nav krtoti"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nosaukums"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Kopsavilkums"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Neizdevs prdvt dokumentu."</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Noemt"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Dai faili tika prveidoti."</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Skatt detaliztu informciju"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Nokopts"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Prvietots"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Dzsts"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Saspiests"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Izvilkts"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Vai pieirt lietotnei <xliff:g id="APPNAME"><b>^1</b></xliff:g> piekuvi direktorijam <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> aj krtuv: <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Vai pieirt lietotnei <xliff:g id="APPNAME"><b>^1</b></xliff:g> piekuvi direktorijam <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Vai pieirt lietotnei <xliff:g id="APPNAME"><b>^1</b></xliff:g> piekuvi jsu datiem, tostarp fotoattliem un videoklipiem, aj krtuv: <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="one">Atlasts <xliff:g id="COUNT_1">%1$d</xliff:g>vienums</item>
       <item quantity="other">Atlasti <xliff:g id="COUNT_1">%1$d</xliff:g>vienumi</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Notrt atlasi"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"atvrtu"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"noemtu atlasi"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"atlastu"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"vilktu"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"atlastu vairkus"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="zero"><xliff:g id="COUNT_1">%1$d</xliff:g>vienumu</item>
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g>vienums</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Lai aizsargtu savu konfidencialitti, izvlieties citu mapi."</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Izveidot jaunu mapi"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Meklt aj ierc"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Notrt tekstu"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" mape"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Saknes mape"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Visur"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Jebkur laik"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"odien"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Vakar"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Pagjuaj ned"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Pagjuaj mnes"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Pagjuaj gad"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Visi veidi"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Meklanas vstures dzana <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Persongais profils"</string>
     <string name="work_tab" msgid="7265359366883747413">"Darba profils"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Tiek attlots saraksta rems."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Faila nosaukums"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Paslpt faila priekskatjumu"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Priekskatjums nav pieejams"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Attla <xliff:g id="FILENAME">%s</xliff:g> priekskatjums"</string>
 </resources>
diff --git a/res/values-mk/strings.xml b/res/values-mk/strings.xml
index d61524719..4e614e631 100644
--- a/res/values-mk/strings.xml
+++ b/res/values-mk/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"    "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">" "</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"     "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"   "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"  "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"     <xliff:g id="APPNAME"><b>^1</b></xliff:g>   <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"     <xliff:g id="APPNAME"><b>^1</b></xliff:g>   <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"     <xliff:g id="APPNAME"><b>^1</b></xliff:g>   ,    ,  <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g>  </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>  </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"  "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"  "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">" "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"     ,   "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"  "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"     <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"     ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"  "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"    "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"    <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-ml/strings.xml b/res/values-ml/strings.xml
index 116ae0291..47f726eed 100644
--- a/res/values-ml/strings.xml
+++ b/res/values-ml/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">" "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"  "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"   "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">" "</string>
+    <string name="extract_completed" msgid="8824595789915249972">" "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   <xliff:g id="APPNAME"><b>^1</b></xliff:g>   ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>   <xliff:g id="APPNAME"><b>^1</b></xliff:g>   ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="STORAGE"><i>^2</i></xliff:g>    ,   <xliff:g id="APPNAME"><b>^1</b></xliff:g>   ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">" "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"     "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"  <xliff:g id="TEXT">%1$s</xliff:g> "</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">" "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>   "</string>
 </resources>
diff --git a/res/values-mn/strings.xml b/res/values-mn/strings.xml
index 28c3f1670..65f26edb1 100644
--- a/res/values-mn/strings.xml
+++ b/res/values-mn/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"  "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="STORAGE"><i>^3</i></xliff:g>-  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    <xliff:g id="APPNAME"><b>^1</b></xliff:g>-  ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    <xliff:g id="APPNAME"><b>^1</b></xliff:g>-  ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="STORAGE"><i>^2</i></xliff:g>-  ,       <xliff:g id="APPNAME"><b>^1</b></xliff:g>-  ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>- </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g>- </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">" "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"      "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"  "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"   "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"  "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>-   "</string>
 </resources>
diff --git a/res/values-mr/strings.xml b/res/values-mr/strings.xml
index 60b72c986..2d26ab37e 100644
--- a/res/values-mr/strings.xml
+++ b/res/values-mr/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">" "</string>
     <string name="button_show_provider" msgid="6905880493806292753">" "</string>
     <string name="button_back" msgid="1888621708934742182">" "</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">"  "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"    "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">" "</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"    "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">" "</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">" "</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>       <xliff:g id="STORAGE"><i>^2</i></xliff:g>    ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"  "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"  "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">" "</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"      "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"   "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"  "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">""</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"<xliff:g id="TEXT">%1$s</xliff:g>    "</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>   "</string>
 </resources>
diff --git a/res/values-ms/strings.xml b/res/values-ms/strings.xml
index fe02922e9..47e6af533 100644
--- a/res/values-ms/strings.xml
+++ b/res/values-ms/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Kosongkan"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Tunjukkan dalam pembekal"</string>
     <string name="button_back" msgid="1888621708934742182">"Kembali"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Paparkan dalam folder"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Tidak diisih"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nama"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Ringkasan"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Gagal menamakan semula dokumen"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Keluarkan"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Sesetengah fail telah ditukarkan"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Lihat butiran"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Disalin"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Berpindah"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Dipadamkan"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Mampat"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Diekstrak"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Beri <xliff:g id="APPNAME"><b>^1</b></xliff:g> akses kepada direktori <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> di <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Beri <xliff:g id="APPNAME"><b>^1</b></xliff:g> akses kepada direktori <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Beri <xliff:g id="APPNAME"><b>^1</b></xliff:g> akses kepada data anda, termasuk foto dan video di <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> dipilih</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> dipilih</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Kosongkan pilihan"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"buka"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"nyahpilih"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"pilih"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"seret"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"pilih berbilang item"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> item</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> item</item>
@@ -284,7 +297,18 @@
     <string name="directory_blocked_header_title" msgid="1164584889578740066">"Tidak boleh menggunakan folder ini"</string>
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Untuk melindungi privasi anda, pilih folder lain"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Buat folder baharu"</string>
-    <string name="search_bar_hint" msgid="146031513183888721">"Cari peranti ini"</string>
+    <string name="search_bar_hint" msgid="146031513183888721">"Cari pada peranti ini"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Kosongkan teks"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Folder ini"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Folder akar"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Di mana-mana"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Pada bila-bila masa"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Hari ini"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Semalam"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Minggu lalu"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Bulan lalu"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Tahun lalu"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Semua jenis"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Padamkan sejarah carian <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Peribadi"</string>
     <string name="work_tab" msgid="7265359366883747413">"Kerja"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Ditunjukkan dalam mod senarai."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nama fail"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Sembunyikan pratonton fail"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Pratonton tidak tersedia"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Pratonton imej <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-my/strings.xml b/res/values-my/strings.xml
index 573d0bf48..96f614a3b 100644
--- a/res/values-my/strings.xml
+++ b/res/values-my/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">" "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"  "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">" "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  "</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  "</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^2</i></xliff:g>     "</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>  </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g>  </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">""</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">" "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>  </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g>  </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"   "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">" "</string>
     <string name="search_bar_hint" msgid="146031513183888721">" "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">""</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">""</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">""</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">""</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">""</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">""</string>
     <string name="delete_search_history" msgid="2202015025607694515">" <xliff:g id="TEXT">%1$s</xliff:g> "</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">" "</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">""</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">" "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">" "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>  "</string>
 </resources>
diff --git a/res/values-nb/strings.xml b/res/values-nb/strings.xml
index d1a9661ee..c476c5712 100644
--- a/res/values-nb/strings.xml
+++ b/res/values-nb/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Fjern"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Vis i leverandren"</string>
     <string name="button_back" msgid="1888621708934742182">"Tilbake"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Vis i mappen"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Ikke sortert"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Navn"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Sammendrag"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Kunne ikke gi dokumentet nytt navn"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Ls ut"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Noen filer er konvertert"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Se detaljer"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopiert"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Flyttet"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Slettet"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Komprimert"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Utpakket"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Vil du gi <xliff:g id="APPNAME"><b>^1</b></xliff:g> tilgang til <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>-katalogen p <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Vil du gi <xliff:g id="APPNAME"><b>^1</b></xliff:g> tilgang til <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>-katalogen?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Vil du gi <xliff:g id="APPNAME"><b>^1</b></xliff:g> tilgang til dataene dine  inkludert bilder og videoer  p <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> er valgt</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> er valgt</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Fjern valget"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"pne"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"velg bort"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"velg"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"dra"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"velg flere"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> elementer</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> element</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Velg en annen mappe for  beskytte personvernet ditt"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Opprett en ny mappe"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Sk p denne enheten"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Fjern tekst"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Denne mappen"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Rotmappe"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Overalt"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Nr som helst"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"I dag"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"I gr"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Den siste uken"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Den siste mneden"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Det siste ret"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Alle typer"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Slett skelogg <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personlig"</string>
     <string name="work_tab" msgid="7265359366883747413">"Jobb"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Viser i listemodus."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Filnavn"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Skjul forhndsvisning av filen"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Ingen forhndsvisning er tilgjengelig"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Bildeforhndsvisning av <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-ne/strings.xml b/res/values-ne/strings.xml
index cb267f0ca..e171f2335 100644
--- a/res/values-ne/strings.xml
+++ b/res/values-ne/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">" "</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">" "</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">"  "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"    "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">" "</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">" "</string>
+    <string name="extract_completed" msgid="8824595789915249972">" "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>   <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>     ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>     ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^2</i></xliff:g>            ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>  </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g>  </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"   "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"  "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">" "</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">" "</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"    "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"      "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"   "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"  "</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"  "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>   "</string>
 </resources>
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-night-v31/colors.xml b/res/values-night-v31/colors.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-night-v31/colors.xml
rename to res/values-night-v31/colors.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-night-v31/styles.xml b/res/values-night-v31/styles.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-night-v31/styles.xml
rename to res/values-night-v31/styles.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-night/colors.xml b/res/values-night/colors.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-night/colors.xml
rename to res/values-night/colors.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-night/themes.xml b/res/values-night/themes.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-night/themes.xml
rename to res/values-night/themes.xml
diff --git a/res/values-nl/strings.xml b/res/values-nl/strings.xml
index 4f7add78d..e3ea672c0 100644
--- a/res/values-nl/strings.xml
+++ b/res/values-nl/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Wissen"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Tonen in provider"</string>
     <string name="button_back" msgid="1888621708934742182">"Terug"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Tonen in map"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Niet gesorteerd"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Naam"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Overzicht"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Kan naam van document niet wijzigen"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Uitwerpen"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Sommige bestanden zijn geconverteerd"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Details bekijken"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Gekopieerd"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Verplaatst"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Verwijderd"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Gecomprimeerd"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Gextraheerd"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> toegang verlenen tot de map <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> op <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> toegang verlenen tot de map <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> toegang verlenen tot je gegevens, waaronder foto\'s en video\'s, op <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> geselecteerd</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> geselecteerd</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Selectie wissen"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"openen"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"deselecteren"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"selecteren"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"slepen"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"meerdere selecties"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> items</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> item</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Kies een andere map om je privacy te beschermen"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Nieuwe map maken"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Zoeken op dit apparaat"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Tekst wissen"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Deze map"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Hoofdmap"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Overal"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Altijd"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Vandaag"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Gisteren"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Vorige week"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Vorige maand"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Afgelopen jaar"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Alle typen"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Zoekgeschiedenis verwijderen <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Persoonlijk"</string>
     <string name="work_tab" msgid="7265359366883747413">"Werk"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Tonen in lijstmodus."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Bestandsnaam"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Bestandsvoorbeeld verbergen"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Geen voorbeeld beschikbaar"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Voorbeeldafbeelding van <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-or/strings.xml b/res/values-or/strings.xml
index ef985fcbc..008d958a6 100644
--- a/res/values-or/strings.xml
+++ b/res/values-or/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">" "</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">" "</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">" "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"    "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">" "</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"  "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">" "</string>
+    <string name="move_completed" msgid="3981250605092729273">" "</string>
+    <string name="delete_completed" msgid="4149401155614626199">" "</string>
+    <string name="compress_completed" msgid="8808356399995313077">" "</string>
+    <string name="extract_completed" msgid="8824595789915249972">" "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="STORAGE"><i>^3</i></xliff:g> <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="APPNAME"><b>^1</b></xliff:g>   ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="APPNAME"><b>^1</b></xliff:g>   ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"    <xliff:g id="STORAGE"><i>^2</i></xliff:g>,   <xliff:g id="APPNAME"><b>^1</b></xliff:g>   ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"  "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">" "</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">" "</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"       "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"   "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"   "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"  "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"  "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"  <xliff:g id="TEXT">%1$s</xliff:g>  "</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"  "</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>  "</string>
 </resources>
diff --git a/res/values-pa/strings.xml b/res/values-pa/strings.xml
index ac450d395..902921698 100644
--- a/res/values-pa/strings.xml
+++ b/res/values-pa/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">" "</string>
     <string name="button_show_provider" msgid="6905880493806292753">"   "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">"   "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"  -   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">" "</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"      "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">"  "</string>
+    <string name="move_completed" msgid="3981250605092729273">"   \'  "</string>
+    <string name="delete_completed" msgid="4149401155614626199">" "</string>
+    <string name="compress_completed" msgid="8808356399995313077">"  "</string>
+    <string name="extract_completed" msgid="8824595789915249972">"  "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g> \' <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  \'   ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  \'   ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^2</i></xliff:g>        \'   ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g>  </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>  </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"  "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"- "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"   "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"    ,    "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"   "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"  "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"  "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">" "</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">"-"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"      "</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"  "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  - "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"-   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>   -"</string>
 </resources>
diff --git a/res/values-pl/strings.xml b/res/values-pl/strings.xml
index 3e592bc4a..50d89e8dd 100644
--- a/res/values-pl/strings.xml
+++ b/res/values-pl/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Zrezygnuj"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Poka w usudze"</string>
     <string name="button_back" msgid="1888621708934742182">"Wstecz"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Poka wfolderze"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Brak sortowania"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nazwa"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Podsumowanie"</string>
@@ -243,6 +244,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Nie udao si zmieni nazwy dokumentu"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Odcz"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Niektre pliki zostay przekonwertowane"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Zobacz szczegy"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Skopiowano"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Przeniesiono"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Usunito"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Skompresowano"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Wyodrbniono"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Zezwoli aplikacji <xliff:g id="APPNAME"><b>^1</b></xliff:g> na dostp do katalogu <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> w pamici masowej <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Przyzna aplikacji <xliff:g id="APPNAME"><b>^1</b></xliff:g> dostp do katalogu <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Zezwoli aplikacji <xliff:g id="APPNAME"><b>^1</b></xliff:g> na dostp do Twoich danych, w tym zdj i filmw, zapisanych w pamici <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -254,6 +261,12 @@
       <item quantity="other">Wybrano <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one">Wybrano <xliff:g id="COUNT_0">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Odznacz"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"otwrz"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"odznacz"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"zaznacz"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"przecignij"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"zaznacz wiele"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> elementy</item>
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> elementw</item>
@@ -329,6 +342,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Aby chroni swoj prywatno, wybierz inny folder"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Utwrz nowy folder"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Przeszukaj to urzdzenie"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Wyczy tekst"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Ten folder"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Folder gwny"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Wszdzie"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Dowolny czas"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Dzisiaj"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Wczoraj"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Ostatni tydzie"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Ostatni miesic"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Ostatni rok"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Wszystkie typy"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Usu histori wyszukiwania <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Osobiste"</string>
     <string name="work_tab" msgid="7265359366883747413">"Subowe"</string>
@@ -338,4 +362,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Wywietlanie wtrybie listy."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nazwa pliku"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Ukryj podgld pliku"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Podgld niedostpny"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Podgld obrazu zpliku <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-pt-rBR/strings.xml b/res/values-pt-rBR/strings.xml
index 72b72aa1c..eb65117b5 100644
--- a/res/values-pt-rBR/strings.xml
+++ b/res/values-pt-rBR/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Limpar"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Mostrar no provedor"</string>
     <string name="button_back" msgid="1888621708934742182">"Voltar"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Mostrar na pasta"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Sem classificao"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nome"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Resumo"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Falha ao renomear documento"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Ejetar"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Alguns arquivos foram convertidos"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Ver detalhes"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copiado"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Movido"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Excludo"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Compactado"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extrado"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Conceder ao <xliff:g id="APPNAME"><b>^1</b></xliff:g> acesso ao diretrio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> no <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Permitir acesso ao diretrio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> para <xliff:g id="APPNAME"><b>^1</b></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Conceder a <xliff:g id="APPNAME"><b>^1</b></xliff:g> acesso aos seus dados, incluindo fotos e vdeos, no/na <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> selecionados</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> selecionados</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Limpar seleo"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"abrir"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"desmarcar"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"selecionar"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"arrastar"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"selecionar vrias opes"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> item</item>
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> itens</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Para proteger sua privacidade, escolha outra pasta"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Criar nova pasta"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Pesquisar neste dispositivo"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Limpar texto"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Esta pasta"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Pasta raiz"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Qualquer lugar"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Qualquer horrio"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Hoje"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Ontem"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Semana passada"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Ms passado"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Ano passado"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Todos os tipos"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Excluir <xliff:g id="TEXT">%1$s</xliff:g> do histrico de pesquisa"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Pessoal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Trabalho"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Exibindo modo de lista."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nome do arquivo"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Ocultar prvia do arquivo"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Nenhuma visualizao disponvel"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Visualizao da imagem de <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-pt-rPT/strings.xml b/res/values-pt-rPT/strings.xml
index 88466b258..9e2e03977 100644
--- a/res/values-pt-rPT/strings.xml
+++ b/res/values-pt-rPT/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Limpar"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Mostrar no fornecedor"</string>
     <string name="button_back" msgid="1888621708934742182">"Anterior"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Mostrar na pasta"</string>
     <string name="not_sorted" msgid="7813496644889115530">"No ordenados"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nome"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Resumo"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Falha ao mudar o nome do documento"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Ejetar"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Alguns ficheiros foram convertidos"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Ver detalhes"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copiado"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Movido"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Eliminado"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Comprimido"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extrado"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Quer conceder a <xliff:g id="APPNAME"><b>^1</b></xliff:g> acesso ao diretrio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> no(a) <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Quer conceder a <xliff:g id="APPNAME"><b>^1</b></xliff:g> acesso ao diretrio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Quer conceder a <xliff:g id="APPNAME"><b>^1</b></xliff:g> acesso aos seus dados, incluindo fotos e vdeos, no(a) <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> selecionados</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> selecionado</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Limpar seleo"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"abrir"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"desmarcar"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"selecionar"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"arrastar"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"selecionar vrias opes"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> itens</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> itens</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Para proteger a sua privacidade, escolha outra pasta."</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Criar nova pasta"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Pesquise este dispositivo"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Limpar texto"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Esta pasta"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Pasta de raiz"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Em qualquer local"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Qualquer altura"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Hoje"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Ontem"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Semana passada"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Ms passado"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Ano passado"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Todos os tipos"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Elimine o histrico de pesquisas <xliff:g id="TEXT">%1$s</xliff:g>."</string>
     <string name="personal_tab" msgid="3878576287868528503">"Pessoal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Trabalho"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"A mostrar no modo de lista"</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nome do ficheiro"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Ocultar pr-visualizao do ficheiro"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Pr-visualizao no disponvel"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Pr-visualizao da imagem de <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-pt/strings.xml b/res/values-pt/strings.xml
index 72b72aa1c..eb65117b5 100644
--- a/res/values-pt/strings.xml
+++ b/res/values-pt/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Limpar"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Mostrar no provedor"</string>
     <string name="button_back" msgid="1888621708934742182">"Voltar"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Mostrar na pasta"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Sem classificao"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nome"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Resumo"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Falha ao renomear documento"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Ejetar"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Alguns arquivos foram convertidos"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Ver detalhes"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copiado"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Movido"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Excludo"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Compactado"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extrado"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Conceder ao <xliff:g id="APPNAME"><b>^1</b></xliff:g> acesso ao diretrio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> no <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Permitir acesso ao diretrio <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> para <xliff:g id="APPNAME"><b>^1</b></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Conceder a <xliff:g id="APPNAME"><b>^1</b></xliff:g> acesso aos seus dados, incluindo fotos e vdeos, no/na <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> selecionados</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> selecionados</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Limpar seleo"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"abrir"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"desmarcar"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"selecionar"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"arrastar"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"selecionar vrias opes"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> item</item>
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> itens</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Para proteger sua privacidade, escolha outra pasta"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Criar nova pasta"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Pesquisar neste dispositivo"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Limpar texto"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Esta pasta"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Pasta raiz"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Qualquer lugar"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Qualquer horrio"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Hoje"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Ontem"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Semana passada"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Ms passado"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Ano passado"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Todos os tipos"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Excluir <xliff:g id="TEXT">%1$s</xliff:g> do histrico de pesquisa"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Pessoal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Trabalho"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Exibindo modo de lista."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nome do arquivo"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Ocultar prvia do arquivo"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Nenhuma visualizao disponvel"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Visualizao da imagem de <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-ro/strings.xml b/res/values-ro/strings.xml
index 82f43949e..ce7d045f8 100644
--- a/res/values-ro/strings.xml
+++ b/res/values-ro/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"terge"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Afieaz n furnizor"</string>
     <string name="button_back" msgid="1888621708934742182">"napoi"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Afieaz n dosar"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Nesortate"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nume"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Rezumat"</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Documentul nu a putut fi redenumit"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Scoate"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Unele fiiere au fost convertite"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Vezi detaliile"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Copiat"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Mutat"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"ters"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Comprimat"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extras"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Permii aplicaiei <xliff:g id="APPNAME"><b>^1</b></xliff:g> s acceseze directorul <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> de pe <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Permii aplicaiei <xliff:g id="APPNAME"><b>^1</b></xliff:g> s acceseze directorul <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Permii ca <xliff:g id="APPNAME"><b>^1</b></xliff:g> s acceseze datele, inclusiv fotografiile i videoclipurile, de pe <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> selectate</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> selectat</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"terge selecia"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"deschide"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"deselecteaz"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"selecteaz"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"trage"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"selecteaz mai multe"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> elemente</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> de elemente</item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Alege alt dosar, ca s-i protejezi confidenialitatea"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Creeaz un dosar nou"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Caut acest dispozitiv"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"terge textul"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Acest dosar"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Dosar rdcin"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Pretutindeni"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Oricnd"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Azi"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Ieri"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Ultima sptmn"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Ultima lun"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Ultimul an"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Toate tipurile"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"terge istoricul cutrilor <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Serviciu"</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Se afieaz n modul list."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Numele fiierului"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Ascunde previzualizarea fiierului"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Nicio previzualizare disponibil"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Previzualizarea imaginii <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-ru/strings.xml b/res/values-ru/strings.xml
index 931934b27..3e317c12c 100644
--- a/res/values-ru/strings.xml
+++ b/res/values-ru/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"    "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">"  "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -243,6 +244,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"   "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">""</string>
+    <string name="copy_completed" msgid="3749037014674785400">" "</string>
+    <string name="move_completed" msgid="3981250605092729273">" "</string>
+    <string name="delete_completed" msgid="4149401155614626199">" "</string>
+    <string name="compress_completed" msgid="8808356399995313077">" "</string>
+    <string name="extract_completed" msgid="8824595789915249972">" "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"  \"<xliff:g id="APPNAME"><b>^1</b></xliff:g>\"    \"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>\" (<xliff:g id="STORAGE"><i>^3</i></xliff:g>)?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"  \"<xliff:g id="APPNAME"><b>^1</b></xliff:g>\"    \"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>\"?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="STORAGE"><i>^2</i></xliff:g>:   \"<xliff:g id="APPNAME"><b>^1</b></xliff:g>\"    ,    ?"</string>
@@ -254,6 +261,12 @@
       <item quantity="many"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g></item>
@@ -329,6 +342,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"          ."</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">" "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">""</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"  : <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -338,4 +362,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">" "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"   \"<xliff:g id="FILENAME">%s</xliff:g>\""</string>
 </resources>
diff --git a/res/values-si/strings.xml b/res/values-si/strings.xml
index 9dbe949c9..5ae2e16ae 100644
--- a/res/values-si/strings.xml
+++ b/res/values-si/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">" "</string>
     <string name="button_show_provider" msgid="6905880493806292753">"  "</string>
     <string name="button_back" msgid="1888621708934742182">" "</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">"  "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"     "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">" "</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"    "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">"  "</string>
+    <string name="move_completed" msgid="3981250605092729273">"  "</string>
+    <string name="delete_completed" msgid="4149401155614626199">" "</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">"  "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="STORAGE"><i>^2</i></xliff:g> ,    ,   <xliff:g id="APPNAME"><b>^1</b></xliff:g>    ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g>   </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>   </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"  "</string>
+    <string name="document_click_action" msgid="8073338575301415356">" "</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">""</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">" "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"   ,    "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"  "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">" ."</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>   "</string>
 </resources>
diff --git a/res/values-sk/strings.xml b/res/values-sk/strings.xml
index 353cfa113..df2b760f4 100644
--- a/res/values-sk/strings.xml
+++ b/res/values-sk/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Vymaza"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Zobrazi uposkytovatea"</string>
     <string name="button_back" msgid="1888621708934742182">"Sp"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Zobrazi vprieinku"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Nezoraden"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nzov"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Shrn"</string>
@@ -243,6 +244,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Premenovanie dokumentu zlyhalo"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Odpoji"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Niektor sbory boli konvertovan"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Zobrazte si podrobnosti"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Skoprovan"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Presunut"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Odstrnen"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Komprimovan"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extrahovan"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Udeli aplikcii <xliff:g id="APPNAME"><b>^1</b></xliff:g> prstup kadresru <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> vloisku <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Udeli aplikcii <xliff:g id="APPNAME"><b>^1</b></xliff:g> prstup kadresru <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Chcete aplikcii <xliff:g id="APPNAME"><b>^1</b></xliff:g> udeli prstup kdtam (vrtane fotiek avide) vloisku <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -254,6 +261,12 @@
       <item quantity="other">Vybran: <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one">Vybran: <xliff:g id="COUNT_0">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Vymaza vber"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"otvori"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"zrui vber"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"vybra"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"presun"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"vybra viacer"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> poloky</item>
       <item quantity="many"><xliff:g id="COUNT_1">%1$d</xliff:g> poloky</item>
@@ -329,13 +342,27 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Ak chcete ochrni svoje skromie, vyberte in prieinok"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Vytvori nov prieinok"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Vyhadajte vtomto zariaden"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Vymaza text"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Tento prieinok"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Koreov prieinok"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Vade"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Kedykovek"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Dnes"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Vera"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Minul tde"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Minul mesiac"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Minul rok"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Vetky typy"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Odstrni histriu vyhadvania <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Osobn"</string>
-    <string name="work_tab" msgid="7265359366883747413">"Prca"</string>
+    <string name="work_tab" msgid="7265359366883747413">"Pracovn"</string>
     <string name="a11y_work" msgid="7504431382825242153">"Prca"</string>
     <string name="drag_from_another_app" msgid="8310249276199969905">"Nemete presva sbory zinej aplikcie."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Zobrazovan vreime mrieky."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Zobrazovan vreime zoznamu."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Nzov sboru"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Skry ukku sboru"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Nie je kdispozcii iadna ukka"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Ukka obrzka <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-sl/strings.xml b/res/values-sl/strings.xml
index f6d15591f..862884027 100644
--- a/res/values-sl/strings.xml
+++ b/res/values-sl/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Izbrii"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Prikai na izvorni lokaciji"</string>
     <string name="button_back" msgid="1888621708934742182">"Nazaj"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Prikai v mapi"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Ni razvreno"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Ime"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Povzetek"</string>
@@ -243,6 +244,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Dokumenta ni bilo mogoe preimenovati"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Izvrzi"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Nekatere datoteke so bile pretvorjene"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Ogled podrobnosti"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopirano"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Premaknjeno"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Izbrisano"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Stisnjeno"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Razirjeno"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"elite aplikaciji <xliff:g id="APPNAME"><b>^1</b></xliff:g> dovoliti dostop do imenika <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> v shrambi <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"elite aplikaciji <xliff:g id="APPNAME"><b>^1</b></xliff:g> dovoliti dostop do imenika <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"elite aplikaciji dovoliti <xliff:g id="APPNAME"><b>^1</b></xliff:g> dostop do podatkov, vkljuno s fotografijami in videoposnetki, v shrambi <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -254,6 +261,12 @@
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> izbrani</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> izbranih</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Poisti izbor"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"odpiranje"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"poienje izbire"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"izbira"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"vleenje"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"izbira ve elementov"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> element</item>
       <item quantity="two"><xliff:g id="COUNT_1">%1$d</xliff:g> elementa</item>
@@ -329,6 +342,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Izberite drugo mapo, da zaitite svojo zasebnost"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Ustvari novo mapo"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Iskanje v tej napravi"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Izbrii besedilo"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Ta mapa"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Korenska mapa"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Povsod"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Kadar koli"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Danes"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Veraj"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Prejnji teden"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Prejnji mesec"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Prejnje leto"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Vse vrste"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Brisanje zgodovine iskanja <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Osebno"</string>
     <string name="work_tab" msgid="7265359366883747413">"Sluba"</string>
@@ -338,4 +362,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Prikazano v nainu seznama"</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Ime datoteke"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Skrivanje predogleda datoteke"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Predogled ni na voljo"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Slikovni predogled datoteke <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-sq/strings.xml b/res/values-sq/strings.xml
index c8cd908ae..660af7b20 100644
--- a/res/values-sq/strings.xml
+++ b/res/values-sq/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Pastro"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Shfaq te ofruesi"</string>
     <string name="button_back" msgid="1888621708934742182">"Prapa"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Shfaq n dosje"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Nuk jan t renditura"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Emri"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Prmbledhja"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Riemrtimi i dokumentit dshtoi"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Nxirr"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Disa skedar u konvertuan"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Shiko detajet"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"U kopjua"</string>
+    <string name="move_completed" msgid="3981250605092729273">"U zhvendos"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"U fshi"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"U ngjesh"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"U nxor"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Jepi aplikacionit <xliff:g id="APPNAME"><b>^1</b></xliff:g> qasje te direktoria <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> n <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"T\'i jepet aplikacionit <xliff:g id="APPNAME"><b>^1</b></xliff:g> qasje te direktoria <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"T\'i jepet aplikacionit <xliff:g id="APPNAME"><b>^1</b></xliff:g> qasje te t dhnat, duke prfshir fotografit dhe videot, n <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> t zgjedhura</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> i zgjedhur</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Spastro zgjedhjen"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"hap"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"hiq przgjedhjen"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"zgjidh"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"zvarrit"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"zgjidh disa"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> artikuj</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> artikull</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Pr t mbrojtur privatsin tnde, zgjidh nj dosje tjetr"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Krijo dosje t re"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Krko n kt pajisje"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Pastro tekstin"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Kjo dosje"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Dosja kryesore"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Kudo"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"N do koh"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Sot"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Dje"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Javn ne kaluar"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Muajin e kaluar"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Vitin e kaluar"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"T gjitha llojet"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Fshi historikun e krkimeve pr <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personale"</string>
     <string name="work_tab" msgid="7265359366883747413">"Puna"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Po shfaq n modalitetin \"list\"."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Emri i skedarit"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Fshih pamjen paraprake t skedarve"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Pamja paraprake nuk mundsohet."</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Pamja paraprake e imazhit pr <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-sr/strings.xml b/res/values-sr/strings.xml
index 627e35356..df30f3b17 100644
--- a/res/values-sr/strings.xml
+++ b/res/values-sr/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"   "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">" "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -227,6 +228,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"   "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"     <xliff:g id="APPNAME"><b>^1</b></xliff:g>    <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"     <xliff:g id="APPNAME"><b>^1</b></xliff:g>    <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"     <xliff:g id="APPNAME"><b>^1</b></xliff:g>   ,    ,    <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -237,6 +244,12 @@
       <item quantity="few">  <xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other">  <xliff:g id="COUNT_1">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -307,6 +320,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"   ,    "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -316,4 +340,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"    ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"  "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">" : <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-sv/strings.xml b/res/values-sv/strings.xml
index dab4bfbe2..ef6ee07c1 100644
--- a/res/values-sv/strings.xml
+++ b/res/values-sv/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Ta bort"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Visa hos leverantren"</string>
     <string name="button_back" msgid="1888621708934742182">"Tillbaka"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Visa i mapp"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Inte sorterade"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Namn"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"versikt"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Det gick inte att byta namn p dokumentet"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Mata ut"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Vissa filer konverterades"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Visa information"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopierad"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Flyttat"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Raderad"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Komprimerad"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Extraherad"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Vill du ge <xliff:g id="APPNAME"><b>^1</b></xliff:g> tkomst till katalogen <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> p <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Vill du ge <xliff:g id="APPNAME"><b>^1</b></xliff:g> tkomst till katalogen <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Vill du ge <xliff:g id="APPNAME"><b>^1</b></xliff:g> tkomst till din data (inklusive foton och videor) p <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> har valts</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> har valts</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Rensa urvalet"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"ppna"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"avmarkera"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"markera"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"dra"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"vlj flera"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> objekt</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> objekt</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Vlj en annan mapp fr att skydda din integritet"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Skapa ny mapp"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Sk p den hr enheten"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Rensa text"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Denna mapp"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Rotmapp"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"verallt"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Nr som helst"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"I dag"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"I gr"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Frra veckan"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Frra mnaden"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Frra ret"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Alla typer"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Radera skhistorik  <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personlig"</string>
     <string name="work_tab" msgid="7265359366883747413">"Jobb"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Visas i listlge."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Filnamn"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Dlj frhandsgranskning av fil"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Ingen frhandsgranskning r tillgnglig"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Frhandsgranskning av bild frn <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-sw/strings.xml b/res/values-sw/strings.xml
index 7ec3309cf..edeef4b5f 100644
--- a/res/values-sw/strings.xml
+++ b/res/values-sw/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Futa"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Onyesha kwenye programu ya mtoa huduma"</string>
     <string name="button_back" msgid="1888621708934742182">"Nyuma"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Onyesha katika folda"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Hazijapangwa"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Jina"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Muhtasari"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Imeshindwa kubadilisha jina la hati"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Ondoa"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Imebadilisha muundo wa baadhi ya faili"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Angalia maelezo"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Imenakiliwa"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Imesogezwa"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Imefutwa"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Imebanwa"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Imetolewa"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Ungependa kuruhusu <xliff:g id="APPNAME"><b>^1</b></xliff:g> ifikie saraka ya <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> kwenye <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Ungependa kuruhusu <xliff:g id="APPNAME"><b>^1</b></xliff:g> ifikie saraka ya <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Ungependa kuruhusu <xliff:g id="APPNAME"><b>^1</b></xliff:g> ifikie data yako, ikiwa ni pamoja na picha na video kwenye <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other">Imechagua <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one">Imechagua <xliff:g id="COUNT_0">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Ondoa uteuzi"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"ufungue"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"uache kuchagua"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"uchague"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"uburute"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"uchague nyingi"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other">Vipengee <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one">Kipengee <xliff:g id="COUNT_0">%1$d</xliff:g></item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Ili ulinde faragha yako, chagua folda nyingine"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Fungua folda mpya"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Tafuta kwenye kifaa hiki"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Futa maandishi"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Folda hii"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Folda kuu"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Kila mahali"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Wakati wowote"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Leo"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Jana"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Wiki iliyopita"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Mwezi uliopita"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Mwaka uliopita"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Aina zote"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Futa <xliff:g id="TEXT">%1$s</xliff:g> ya historia ya mambo uliyotafuta"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Binafsi"</string>
     <string name="work_tab" msgid="7265359366883747413">"Kazini"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Kuonyesha katika hali ya orodha."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Jina la faili"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Ficha onyesho la kukagua faili"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Hakuna toleo la kukagua linalopatikana"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Onyesho la kukagua picha ya <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-sw600dp/dimens.xml b/res/values-sw600dp/dimens.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-sw600dp/dimens.xml
rename to res/values-sw600dp/dimens.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp-land/dimens.xml b/res/values-sw720dp-land/dimens.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp-land/dimens.xml
rename to res/values-sw720dp-land/dimens.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp-land/layouts.xml b/res/values-sw720dp-land/layouts.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp-land/layouts.xml
rename to res/values-sw720dp-land/layouts.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp/colors.xml b/res/values-sw720dp/colors.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp/colors.xml
rename to res/values-sw720dp/colors.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp/config.xml b/res/values-sw720dp/config.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp/config.xml
rename to res/values-sw720dp/config.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp/dimens.xml b/res/values-sw720dp/dimens.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp/dimens.xml
rename to res/values-sw720dp/dimens.xml
diff --git a/res/values-ta/strings.xml b/res/values-ta/strings.xml
index 35a856f23..fed7235e6 100644
--- a/res/values-ta/strings.xml
+++ b/res/values-ta/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">" "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">" "</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"   "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="STORAGE"><i>^3</i></xliff:g>   <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  , <xliff:g id="APPNAME"><b>^1</b></xliff:g> ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  , <xliff:g id="APPNAME"><b>^1</b></xliff:g> ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="STORAGE"><i>^2</i></xliff:g>   ,     , <xliff:g id="APPNAME"><b>^1</b></xliff:g> ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"     "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"    <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">" "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>  "</string>
 </resources>
diff --git a/res/values-te/strings.xml b/res/values-te/strings.xml
index ba463359d..da7b5f102 100644
--- a/res/values-te/strings.xml
+++ b/res/values-te/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">" "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">" "</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"  "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">" "</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">" "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="STORAGE"><i>^3</i></xliff:g> <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    ?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    ?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="STORAGE"><i>^2</i></xliff:g> ,      <xliff:g id="APPNAME"><b>^1</b></xliff:g>  ?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"  ,   "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"   "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"   "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"  "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">" "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">" "</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"  <xliff:g id="TEXT">%1$s</xliff:g> "</string>
     <string name="personal_tab" msgid="3878576287868528503">" "</string>
     <string name="work_tab" msgid="7265359366883747413">" "</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"  "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"   "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>   "</string>
 </resources>
diff --git a/res/values-th/strings.xml b/res/values-th/strings.xml
index 10181068d..46821d927 100644
--- a/res/values-th/strings.xml
+++ b/res/values-th/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">""</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">""</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">""</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">""</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">""</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g> "</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> "</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">" <xliff:g id="APPNAME"><b>^1</b></xliff:g>   <xliff:g id="STORAGE"><i>^2</i></xliff:g> "</string>
@@ -220,6 +227,12 @@
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"> <xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">""</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">""</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">""</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">""</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">""</string>
     <string name="search_bar_hint" msgid="146031513183888721">""</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">""</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">""</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">""</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">""</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">""</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">""</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">""</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">""</string>
     <string name="delete_search_history" msgid="2202015025607694515">" <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">""</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">""</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">""</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">" <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-tl/strings.xml b/res/values-tl/strings.xml
index 3befbf583..9f76b9cd2 100644
--- a/res/values-tl/strings.xml
+++ b/res/values-tl/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"I-clear"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Ipakita sa provider"</string>
     <string name="button_back" msgid="1888621708934742182">"Bumalik"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Ipakita sa folder"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Hindi napagbukud-bukod"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Pangalan"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Buod"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Hindi napalitan ang pangalan ng dokumento"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"I-eject"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Na-convert ang ilang file"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Tingnan ang mga detalye"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Nakopya"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Lumipat"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Na-delete"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Naka-compress"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Na-extract"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Gusto mo bang bigyan ang <xliff:g id="APPNAME"><b>^1</b></xliff:g> ng access sa directory ng <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> sa <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Gusto mo bang bigyan ang <xliff:g id="APPNAME"><b>^1</b></xliff:g> ng access sa directory ng <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Gusto mo bang bigyan ang <xliff:g id="APPNAME"><b>^1</b></xliff:g> ng access sa iyong data, kabilang ang mga larawan at video, sa <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> ang napili</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> ang napili</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"I-clear ang napili"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"buksan"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"i-deselect"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"pumili"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"i-drag"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"pumili ng marami"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> item</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> na item</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Para maprotektahan ang iyong privacy, pumili ng ibang folder"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Gumawa ng bagong folder"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Maghanap sa device na ito"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"I-clear ang text"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Sa folder na ito"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Root folder"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Sa lahat ng lugar"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Anumang oras"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Ngayon"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Kahapon"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Nakaraang linggo"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Nakaraang buwan"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Nakaraang taon"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Lahat ng uri"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"I-delete ang history ng paghahanap <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personal"</string>
     <string name="work_tab" msgid="7265359366883747413">"Work"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Ipinapakita sa list mode."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Pangalan ng file"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"I-hide ang preview ng file"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Walang available na preview"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Preview ng larawan ng <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-tr/strings.xml b/res/values-tr/strings.xml
index 490f9ca29..821cd26d0 100644
--- a/res/values-tr/strings.xml
+++ b/res/values-tr/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Temizle"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Salaycda gster"</string>
     <string name="button_back" msgid="1888621708934742182">"Geri"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Klasrde gster"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Sralanmad"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Ad"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"zet"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Dokmann ad deitirilemedi"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"kar"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Baz dosyalar dntrld"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Ayrntlar gster"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kopyaland"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Tand"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Silindi"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Sktrld"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"karld"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> uygulamasna <xliff:g id="STORAGE"><i>^3</i></xliff:g> depolama alanndaki <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> dizinine eriim izni verilsin mi?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g> dizinine erimek iin <xliff:g id="APPNAME"><b>^1</b></xliff:g> uygulamasna izin verilsin mi?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> uygulamasnn, fotoraflar ve videolar dahil olmak zere <xliff:g id="STORAGE"><i>^2</i></xliff:g> zerindeki verilerinize erimesine izin verilsin mi?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> e seildi</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> e seildi</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Seimi temizle"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"an"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"seimi kaldrn"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"sein"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"srkleyin"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"oklu sein"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> e</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> e</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Gizliliinizi korumak iin baka bir klasr sein"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Yeni klasr olutur"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Bu cihazda arama yapn"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Metni temizle"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Bu klasr"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Kk klasr"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Her Yer"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Tm zamanlar"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Bugn"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Dn"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Geen hafta"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Geen ay"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Geen yl"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Tm trler"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Arama gemiini sil <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Kiisel"</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Liste modunda gsteriliyor."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Dosya ad"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Dosya nizlemesini gizle"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Hi nizleme yok"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g> resminin nizlemesi"</string>
 </resources>
diff --git a/res/values-uk/strings.xml b/res/values-uk/strings.xml
index 52f36ec44..a7dd0c345 100644
--- a/res/values-uk/strings.xml
+++ b/res/values-uk/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">"   "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">" "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">" "</string>
@@ -243,6 +244,12 @@
     <string name="rename_error" msgid="6700093173508118635">"   "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"  "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">""</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"  <xliff:g id="APPNAME"><b>^1</b></xliff:g>    \"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>\"    <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"  <xliff:g id="APPNAME"><b>^1</b></xliff:g>    \"<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>\"?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"  <xliff:g id="APPNAME"><b>^1</b></xliff:g>    ,         <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -254,6 +261,12 @@
       <item quantity="many"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">" "</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">" "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"  "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="few"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
@@ -329,6 +342,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"   ,   "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">" "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"   "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">" "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"-"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"   (<xliff:g id="TEXT">%1$s</xliff:g>)"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -338,4 +362,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">" "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"   "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"  "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"   \"<xliff:g id="FILENAME">%s</xliff:g>\""</string>
 </resources>
diff --git a/res/values-ur/strings.xml b/res/values-ur/strings.xml
index 9f20a9957..bdff9c47b 100644
--- a/res/values-ur/strings.xml
+++ b/res/values-ur/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">" "</string>
     <string name="button_show_provider" msgid="6905880493806292753">"   "</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"  "</string>
     <string name="not_sorted" msgid="7813496644889115530">"   "</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"      "</string>
     <string name="menu_eject_root" msgid="9215040039374893613">" "</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"      "</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">" "</string>
+    <string name="copy_completed" msgid="3749037014674785400">"  "</string>
+    <string name="move_completed" msgid="3981250605092729273">"  "</string>
+    <string name="delete_completed" msgid="4149401155614626199">" "</string>
+    <string name="compress_completed" msgid="8808356399995313077">" "</string>
+    <string name="extract_completed" msgid="8824595789915249972">"  "</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="STORAGE"><i>^3</i></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>     "</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>  <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>    "</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g>     <xliff:g id="STORAGE"><i>^2</i></xliff:g>         "</string>
@@ -220,6 +227,12 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>  </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g>  </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"  "</string>
+    <string name="document_click_action" msgid="8073338575301415356">" "</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"   "</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"  "</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">" "</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"   "</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"          "</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"  "</string>
     <string name="search_bar_hint" msgid="146031513183888721">"    "</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"  "</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">" "</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">" "</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">" "</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"  "</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">" "</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">" "</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">" "</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">" "</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">" "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"    <xliff:g id="TEXT">%1$s</xliff:g>  "</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"      "</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"  "</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"    "</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"     "</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>     "</string>
 </resources>
diff --git a/res/values-uz/strings.xml b/res/values-uz/strings.xml
index 8e7c154f9..961ec4ab6 100644
--- a/res/values-uz/strings.xml
+++ b/res/values-uz/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Tozalash"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Taminotchi orqali korsatish"</string>
     <string name="button_back" msgid="1888621708934742182">"Orqaga"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Jildda chiqarish"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Saralanmagan"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Nomi"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Qisqacha tavsif"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Hujjatni qayta nomlab bolmadi"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Chiqarish"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Bir nechta fayllar ogirildi"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Tafsilotlar"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Nusxalandi"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Kochirildi"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Ochirib tashlandi"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Siqildi"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Arxivdan chiqarildi"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> ilovasining <xliff:g id="STORAGE"><i>^3</i></xliff:g> xotirasidagi <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> jildiga kirishiga ruxsat berilsinmi?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> ilovasiga <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> jildidan foydalanishiga ruxsat berilsinmi?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> ilovasiga <xliff:g id="STORAGE"><i>^2</i></xliff:g> xotirasidagi malumotlardan, jumladan, rasmlar va videolardan foydalanishiga ruxsat berilsinmi?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other">Belgilandi: <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one">Belgilandi: <xliff:g id="COUNT_0">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Tanlovni tozalash"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"ochish"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"tanlovni bekor qilish"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"tanlash"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"tortish"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"bir nechta tanlash"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> ta element</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> ta element</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Maxfiyligingizni muhofaza qilish uchun boshqa jildni tanlang"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Yangi jild yaratish"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Shu qurilmadan qidirish"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Matnni tozalash"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Shu jild"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Root jild"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Hamma yerda"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Har qanday vaqt"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Bugun"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Kecha"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Avvalgi hafta"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Avvalgi oy"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Otgan yili"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Barcha turlar"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Qidiruv tarixini tozalash (<xliff:g id="TEXT">%1$s</xliff:g>)"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Shaxsiy"</string>
     <string name="work_tab" msgid="7265359366883747413">"Ish"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Royxat shaklida chiqarilmoqda."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Fayl nomi"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Faylga razm solishni yopish"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Razm solish imkonsiz"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g> rasmi eskizi"</string>
 </resources>
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-v31/colors.xml b/res/values-v31/colors.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-v31/colors.xml
rename to res/values-v31/colors.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-v31/dimens.xml b/res/values-v31/dimens.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-v31/dimens.xml
rename to res/values-v31/dimens.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-v31/styles.xml b/res/values-v31/styles.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-v31/styles.xml
rename to res/values-v31/styles.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values-v31/styles_text.xml b/res/values-v31/styles_text.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values-v31/styles_text.xml
rename to res/values-v31/styles_text.xml
diff --git a/res/values-vi/strings.xml b/res/values-vi/strings.xml
index 9d3fe1683..7c0c0a12a 100644
--- a/res/values-vi/strings.xml
+++ b/res/values-vi/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Xa"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Hin th trong nh cung cp"</string>
     <string name="button_back" msgid="1888621708934742182">"Quay li"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Hin th trong th mc"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Cha c sp xp"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Tn"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Tm tt"</string>
@@ -112,7 +113,7 @@
     <string name="cant_save_to_cross_profile_error_title" msgid="5158984057654779022">"Khng lu c vo h s <xliff:g id="PROFILE">%1$s</xliff:g>"</string>
     <string name="cant_save_to_cross_profile_error_message" msgid="5845240315510422749">"Qun tr vin CNTT ca bn khng cho php bn lu tp <xliff:g id="PROFILE_0">%1$s</xliff:g> vo h s <xliff:g id="PROFILE_1">%2$s</xliff:g>"</string>
     <string name="cross_profile_action_not_allowed_title" msgid="6611281348716476478">"Qun tr vin CNTT khng cho php thc hin thao tc ny"</string>
-    <string name="cross_profile_action_not_allowed_message" msgid="7331275433061690947">"Hy lin h vi qun tr vin CNTT  tm hiu thm"</string>
+    <string name="cross_profile_action_not_allowed_message" msgid="7331275433061690947">" tm hiu thm, hy lin h vi qun tr vin CNTT ca bn"</string>
     <string name="root_recent" msgid="1080156975424341623">"Gn y"</string>
     <string name="root_available_bytes" msgid="8269870862691408864">"<xliff:g id="SIZE">%1$s</xliff:g> cn trng"</string>
     <string name="root_type_service" msgid="6521366147466512289">"Dch v lu tr"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Khng i c tn ti liu"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"y ra"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">" chuyn i mt s tp"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Xem chi tit"</string>
+    <string name="copy_completed" msgid="3749037014674785400">" sao chp"</string>
+    <string name="move_completed" msgid="3981250605092729273">" di chuyn"</string>
+    <string name="delete_completed" msgid="4149401155614626199">" xo"</string>
+    <string name="compress_completed" msgid="8808356399995313077">" nn"</string>
+    <string name="extract_completed" msgid="8824595789915249972">" gii nn"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Cp cho <xliff:g id="APPNAME"><b>^1</b></xliff:g> quyn truy cp vo th mc <xliff:g id="DIRECTORY"><i>^2</i></xliff:g> trong <xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Cp cho <xliff:g id="APPNAME"><b>^1</b></xliff:g> quyn truy cp vo th mc <xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Cp cho <xliff:g id="APPNAME"><b>^1</b></xliff:g> quyn truy cp vo d liu ca bn, k c nh v video trn <xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"> chn <xliff:g id="COUNT_1">%1$d</xliff:g></item>
       <item quantity="one"> chn <xliff:g id="COUNT_0">%1$d</xliff:g></item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"B chn cc tp  chn"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"m"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"b chn"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"chn"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"ko"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"chn nhiu tp"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> mc</item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> mc</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">" bo v quyn ring t ca bn, hy chn mt th mc khc"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"To th mc mi"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Tm kim trn thit b ny"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Xo vn bn"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Th mc ny"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Th mc gc"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Mi ni"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Mi lc"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Hm nay"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Hm qua"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Tun trc"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Thng trc"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Nm ngoi"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Tt c cc loi"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Xo nht k tm kim <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"C nhn"</string>
     <string name="work_tab" msgid="7265359366883747413">"Cng vic"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"ang hin th  ch  danh sch."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Tn tp"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"n bn xem trc tp"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Khng c bn xem trc"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Bn xem trc hnh nh ca <xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-zh-rCN/strings.xml b/res/values-zh-rCN/strings.xml
index 939830937..20cb7b6c2 100644
--- a/res/values-zh-rCN/strings.xml
+++ b/res/values-zh-rCN/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">""</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">""</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">""</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">""</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">""</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g><xliff:g id="STORAGE"><i>^3</i></xliff:g><xliff:g id="DIRECTORY"><i>^2</i></xliff:g>"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g><xliff:g id="DIRECTORY"><i>^2</i></xliff:g>"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g><xliff:g id="STORAGE"><i>^2</i></xliff:g>"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"> <xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">""</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">""</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">""</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">""</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">""</string>
     <string name="search_bar_hint" msgid="146031513183888721">""</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">""</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">""</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">""</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">""</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">""</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">""</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">""</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">""</string>
     <string name="delete_search_history" msgid="2202015025607694515">"<xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">""</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">""</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">""</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-zh-rHK/strings.xml b/res/values-zh-rHK/strings.xml
index aa923d75b..b9ddce6ea 100644
--- a/res/values-zh-rHK/strings.xml
+++ b/res/values-zh-rHK/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">""</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">""</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">""</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">""</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">""</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="STORAGE"><i>^3</i></xliff:g><xliff:g id="DIRECTORY"><i>^2</i></xliff:g>"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g><xliff:g id="DIRECTORY"><i>^2</i></xliff:g>"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="STORAGE"><i>^2</i></xliff:g>"</string>
@@ -220,6 +227,12 @@
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"> <xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">""</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">""</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">""</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">""</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">""</string>
     <string name="search_bar_hint" msgid="146031513183888721">""</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">""</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">""</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">""</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">""</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">""</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">""</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">""</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">""</string>
     <string name="delete_search_history" msgid="2202015025607694515">" <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">""</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">""</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">""</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g> "</string>
 </resources>
diff --git a/res/values-zh-rTW/strings.xml b/res/values-zh-rTW/strings.xml
index 9c99307b2..f51f2db53 100644
--- a/res/values-zh-rTW/strings.xml
+++ b/res/values-zh-rTW/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">""</string>
     <string name="button_show_provider" msgid="6905880493806292753">""</string>
     <string name="button_back" msgid="1888621708934742182">""</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">""</string>
     <string name="not_sorted" msgid="7813496644889115530">""</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">""</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">""</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">""</string>
     <string name="menu_eject_root" msgid="9215040039374893613">""</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">""</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">""</string>
+    <string name="copy_completed" msgid="3749037014674785400">""</string>
+    <string name="move_completed" msgid="3981250605092729273">""</string>
+    <string name="delete_completed" msgid="4149401155614626199">""</string>
+    <string name="compress_completed" msgid="8808356399995313077">""</string>
+    <string name="extract_completed" msgid="8824595789915249972">""</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="STORAGE"><i>^3</i></xliff:g><xliff:g id="DIRECTORY"><i>^2</i></xliff:g>"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"<xliff:g id="APPNAME"><b>^1</b></xliff:g><xliff:g id="DIRECTORY"><i>^2</i></xliff:g>"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"<xliff:g id="APPNAME"><b>^1</b></xliff:g> <xliff:g id="STORAGE"><i>^2</i></xliff:g> () "</string>
@@ -220,6 +227,12 @@
       <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"> <xliff:g id="COUNT_0">%1$d</xliff:g> </item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">""</string>
+    <string name="document_click_action" msgid="8073338575301415356">""</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">""</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">""</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">""</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">""</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g> </item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">""</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">""</string>
     <string name="search_bar_hint" msgid="146031513183888721">""</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">""</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">""</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">""</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">""</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">""</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">""</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">""</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">""</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">""</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">""</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">""</string>
     <string name="delete_search_history" msgid="2202015025607694515">" <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
     <string name="work_tab" msgid="7265359366883747413">""</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">""</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">""</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">""</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"<xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/values-zu/strings.xml b/res/values-zu/strings.xml
index 80c39b98f..776b49f48 100644
--- a/res/values-zu/strings.xml
+++ b/res/values-zu/strings.xml
@@ -70,6 +70,7 @@
     <string name="button_clear" msgid="5412304437764369441">"Sula"</string>
     <string name="button_show_provider" msgid="6905880493806292753">"Bonisa kumhlinzeki"</string>
     <string name="button_back" msgid="1888621708934742182">"Emuva"</string>
+    <string name="button_show_in_folder" msgid="6674673478637689386">"Bonisa kufolda"</string>
     <string name="not_sorted" msgid="7813496644889115530">"Akuhlungiwe"</string>
     <string name="sort_dimension_name" msgid="6325591541414177579">"Igama"</string>
     <string name="sort_dimension_summary" msgid="7724534446881397860">"Isifinyezo"</string>
@@ -211,6 +212,12 @@
     <string name="rename_error" msgid="6700093173508118635">"Yehlulekile ukuqamba kabusha idokhumenti"</string>
     <string name="menu_eject_root" msgid="9215040039374893613">"Khipha"</string>
     <string name="notification_copy_files_converted_title" msgid="6916768494891833365">"Amanye amafayela aguqulelwe"</string>
+    <string name="job_progress_item_see_details" msgid="2069387639574541325">"Bona imininingwane"</string>
+    <string name="copy_completed" msgid="3749037014674785400">"Kukopishiwe"</string>
+    <string name="move_completed" msgid="3981250605092729273">"Kuthuthile"</string>
+    <string name="delete_completed" msgid="4149401155614626199">"Kusuliwe"</string>
+    <string name="compress_completed" msgid="8808356399995313077">"Kuminyanisiwe"</string>
+    <string name="extract_completed" msgid="8824595789915249972">"Kucashuniwe"</string>
     <string name="open_external_dialog_request" msgid="8173558471322861268">"Nika i-<xliff:g id="APPNAME"><b>^1</b></xliff:g> ukufinyelela ekuqondiseni kwe-<xliff:g id="DIRECTORY"><i>^2</i></xliff:g> ku-<xliff:g id="STORAGE"><i>^3</i></xliff:g>?"</string>
     <string name="open_external_dialog_request_primary_volume" msgid="2240992164087948176">"Nika ukufinyelela kwe-<xliff:g id="APPNAME"><b>^1</b></xliff:g> kwinkomba ye-<xliff:g id="DIRECTORY"><i>^2</i></xliff:g>?"</string>
     <string name="open_external_dialog_root_request" msgid="6776729293982633">"Nikeza i-<xliff:g id="APPNAME"><b>^1</b></xliff:g> ukufinyelela kudatha yakho, okufaka izithombe namavidiyo, ku-<xliff:g id="STORAGE"><i>^2</i></xliff:g>?"</string>
@@ -220,6 +227,12 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> okukhethiwe</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> okukhethiwe</item>
     </plurals>
+    <string name="clear_selection" msgid="5965968983023105329">"Sula okukhethiwe"</string>
+    <string name="document_click_action" msgid="8073338575301415356">"vula"</string>
+    <string name="selected_document_click_action" msgid="792826130200234885">"susa ukukhetha"</string>
+    <string name="document_long_click_action" msgid="3789836661597702666">"khetha"</string>
+    <string name="selected_document_long_click_action" msgid="666372407184527109">"hudula"</string>
+    <string name="document_long_click_action_picker" msgid="943888101827856784">"khetha okuningi"</string>
     <plurals name="elements_dragged" formatted="false" msgid="5932571296037626279">
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> izinto</item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> izinto</item>
@@ -285,6 +298,17 @@
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Ukuvikela ubumfihlo bakho, khetha enye ifolda"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Dala ifolda entsha"</string>
     <string name="search_bar_hint" msgid="146031513183888721">"Sesha le divayisi"</string>
+    <string name="search_bar_clear" msgid="2072000748823434188">"Sula umbhalo"</string>
+    <string name="search_location_this_folder" msgid="6458835123175563013">"Le folda"</string>
+    <string name="search_location_root_folder" msgid="4280523560213522303">"Ifolda eyinhloko"</string>
+    <string name="search_location_everywhere" msgid="747799487494833887">"Yonke indawo"</string>
+    <string name="search_last_modified_any_time" msgid="6027501367865939696">"Noma yisiphi isikhathi"</string>
+    <string name="search_last_modified_1_day" msgid="7775353928859139915">"Namuhla"</string>
+    <string name="search_last_modified_2_days" msgid="7885735119033678756">"Izolo"</string>
+    <string name="search_last_modified_7_days" msgid="7634290601544418836">"Iviki eledlule"</string>
+    <string name="search_last_modified_30_days" msgid="4936787546211708940">"Inyanga edlule"</string>
+    <string name="search_last_modified_365_days" msgid="7147134152974373466">"Unyaka odlule"</string>
+    <string name="search_file_type_all" msgid="6613664493134355781">"Zonke izinhlobo"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Susa umlando wokusesha <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Okomuntu siqu"</string>
     <string name="work_tab" msgid="7265359366883747413">"Umsebenzi"</string>
@@ -294,4 +318,7 @@
     <string name="list_mode_showing" msgid="1225413902295895166">"Ibonisa kumodi yohlu."</string>
     <string name="bullet" msgid="5606740650312122766">""</string>
     <string name="file_name_hint" msgid="7843637320487415838">"Igama lefayela"</string>
+    <string name="a11y_peek_navigation_icon" msgid="6692873662104342476">"Fihla ukubuka kuqala kwefayela"</string>
+    <string name="peek_no_preview" msgid="8717084152736749464">"Akukho ukubuka kuqala okutholakalayo"</string>
+    <string name="a11y_peek_image_preview" msgid="3917148390186060263">"Umbukisokuqala wesithombe se-<xliff:g id="FILENAME">%s</xliff:g>"</string>
 </resources>
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values/colors.xml b/res/values/colors.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values/colors.xml
rename to res/values/colors.xml
diff --git a/res/values/config.xml b/res/values/config.xml
index 494667da0..743052dc6 100644
--- a/res/values/config.xml
+++ b/res/values/config.xml
@@ -26,9 +26,15 @@
          layouts we reduce this to an input-box adjacent to menu actions. -->
     <bool name="full_bar_search_view">true</bool>
 
+    <!-- Indicates if showing Audio / Downloads / Images / Video roots -->
+    <bool name="show_media_roots">true</bool>
+
     <!-- Indicates if showing as search bar design -->
     <bool name="show_search_bar">false</bool>
 
+    <!-- Indicates if showing the apps row -->
+    <bool name="show_apps_row">true</bool>
+
     <!-- Indicates if showing hidden files by default -->
     <bool name="show_hidden_files_by_default">false</bool>
 
@@ -75,4 +81,11 @@
 
     <!-- The maximum record of search history. -->
     <integer name="config_maximum_search_history">200</integer>
+
+    <!-- The Material3 theme is only enabled IFF this config is true AND the flag `use_material3` is enabled. -->
+    <bool name="force_material3">false</bool>
+
+    <!-- Dictates whether we show a search icon or a docked search bar in the toolbar. It's false
+         on small screens to show the icon and true on larger screens to show the docked search. -->
+    <bool name="show_docked_search">false</bool>
 </resources>
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values/dimens.xml b/res/values/dimens.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values/dimens.xml
rename to res/values/dimens.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values/layouts.xml b/res/values/layouts.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values/layouts.xml
rename to res/values/layouts.xml
diff --git a/res/values/overlayable.xml b/res/values/overlayable.xml
index bda899336..37e64a35c 100644
--- a/res/values/overlayable.xml
+++ b/res/values/overlayable.xml
@@ -39,9 +39,9 @@
             <!-- END THEME / STYLE -->
 
             <!-- START COLOR -->
-            <item type="color" name="primary"/>
-            <item type="color" name="list_item_selected_background_color"/>
             <item type="color" name="color_surface_header"/>
+            <item type="color" name="list_item_selected_background_color"/>
+            <item type="color" name="primary"/>
             <!-- END COLOR -->
 
             <!-- START DIMEN -->
@@ -50,18 +50,22 @@
             <!-- END DIMEN -->
 
             <!-- START DRAWABLE -->
+            <item type="drawable" name="ic_advanced_shortcut"/>
             <item type="drawable" name="ic_eject"/>
             <item type="drawable" name="ic_root_download"/>
-            <item type="drawable" name="ic_sd_storage"/>
             <item type="drawable" name="ic_root_smartphone"/>
+            <item type="drawable" name="ic_sd_storage"/>
             <item type="drawable" name="root_list_selector"/>
             <!-- END DRAWABLE -->
 
             <!-- START BOOLEAN CONFIG -->
             <item type="bool" name="config_button_all_caps"/>
             <item type="bool" name="config_default_show_device_root"/>
+            <item type="bool" name="force_material3"/>
             <item type="bool" name="handle_view_downloads_intent"/>
             <item type="bool" name="is_launcher_enabled"/>
+            <item type="bool" name="show_apps_row"/>
+            <item type="bool" name="show_media_roots"/>
             <item type="bool" name="show_search_bar"/>
             <!-- END BOOLEAN CONFIG -->
 
diff --git a/res/values/strings.xml b/res/values/strings.xml
index c3f11bab4..21b21230d 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -133,6 +133,8 @@
     <string name="button_show_provider">Show in provider</string>
     <!-- Button label that do back action [CHAR LIMIT=24] -->
     <string name="button_back">Back</string>
+    <!-- Button label that navigates to the destination folder of a copy/move. -->
+    <string name="button_show_in_folder">Show in folder</string>
 
     <!-- A string used to show user that currently documents are not sorted in any given order. [CHAR_LIMIT=30] -->
     <string name="not_sorted">Not sorted</string>
@@ -417,6 +419,10 @@
         =1 {Copying <xliff:g id="filename" example="foobar.txt">{filename}</xliff:g> to <xliff:g id="directory" example="example folder">{directory}</xliff:g>}
         other {Copying # files to <xliff:g id="directory" example="example folder">{directory}</xliff:g>}
     }</string>
+    <string name="extract_in_progress" translatable="false">{count, plural,
+        =1 {Extracting \u201C<xliff:g id="filename" example="foobar.txt">{filename}</xliff:g>\u201D to \u201C<xliff:g id="directory" example="example folder">{directory}</xliff:g>\u201D}
+        other {Extracting # archives to \u201C<xliff:g id="directory" example="example folder">{directory}</xliff:g>\u201D}
+    }</string>
     <string name="move_in_progress" translatable="false">{count, plural,
         =1 {Moving <xliff:g id="filename" example="foobar.txt">{filename}</xliff:g> to <xliff:g id="directory" example="example folder">{directory}</xliff:g>}
         other {Moving # files to <xliff:g id="directory" example="example folder">{directory}</xliff:g>}
@@ -430,6 +436,23 @@
         other {Zipping # files}
     }</string>
     <string name="job_progress_panel_title" translatable="false">File Progress</string>
+    <string name="job_progress_item_completed" translatable="false">Completed</string>
+    <string name="job_progress_item_failed" translatable="false">Failed</string>
+    <!-- Label prompting the user to interact to view more details about errors/warnings encountered during a file operation. -->
+    <string name="job_progress_item_see_details">See details</string>
+    <string name="job_progress_item_byte_progress" translatable="false">
+        <xliff:g id="currentBytes" example="2.4 MB">%1$s</xliff:g> of <xliff:g id="totalBytes" example="50 MB">%2$s</xliff:g>
+    </string>
+    <!-- Status message shown when a copy is completed. -->
+    <string name="copy_completed">Copied</string>
+    <!-- Status message shown when a move is completed. -->
+    <string name="move_completed">Moved</string>
+    <!-- Status message shown when a delete is completed. -->
+    <string name="delete_completed">Deleted</string>
+    <!-- Status message shown when a compress file operation is completed. -->
+    <string name="compress_completed">Compressed</string>
+    <!-- Status message shown when an extract file operation is completed. -->
+    <string name="extract_completed">Extracted</string>
 
     <!-- Text in an alert dialog asking user to grant app access to a given directory in an external storage volume -->
     <string name="open_external_dialog_request">Grant <xliff:g id="appName" example="System Settings"><b>^1</b></xliff:g>
@@ -451,6 +474,24 @@
         <item quantity="one"><xliff:g id="count" example="1">%1$d</xliff:g> selected</item>
         <item quantity="other"><xliff:g id="count" example="3">%1$d</xliff:g> selected</item>
     </plurals>
+    <!-- Text used as the content description of the cancel button when files are selected. -->
+    <string name="clear_selection">Clear selection</string>
+    <!-- The voice announcement used as the description of the click action in the file
+         list/grid for normal document in browsing mode. For example: Double tap to open. -->
+    <string name="document_click_action">open</string>
+    <!-- The voice announcement used as the description of the click action in the file list/grid.
+         For example: Double tap to deselect. -->
+    <string name="selected_document_click_action">deselect</string>
+    <!-- The voice announcement used as the description of the long click action in the file
+         list/grid for normal document. For example: Double tap and hold to select. -->
+    <string name="document_long_click_action">select</string>
+    <!-- The voice announcement used as the description of the long click action in the file
+         list/grid for selected document. For example: Double tap and hold to drag. -->
+    <string name="selected_document_long_click_action">drag</string>
+    <!-- The voice announcement used as the description of the long click action in the file
+         list/grid for normal document in picking mode.
+         For example: Double tap and hold to select multiple. -->
+    <string name="document_long_click_action_picker">select multiple</string>
 
     <!-- Label text showing user how many items are being dragged. Can be one or more elements. -->
     <plurals name="elements_dragged">
@@ -575,7 +616,7 @@
     <!-- Confrim dialog title show on open document tree flow. [CHAR_LIMIT=80] -->
     <string name="open_tree_dialog_title">Allow <xliff:g id="appName" example="Drive">%1$s</xliff:g> to access files in <xliff:g id="directory" example="DCIM">%2$s</xliff:g>?</string>
     <!-- Confrim dialog message show on open document tree flow.-->
-    <string name="open_tree_dialog_message">This will let <xliff:g id="appName" example="Drive">%1$s</xliff:g> access current and future content stored in <xliff:g id="directory" example="DCIM">%2$s</xliff:g>.</string>
+    <string name="open_tree_dialog_message">This will let "<xliff:g id="appName" example="Drive">%1$s</xliff:g>" access current and future content stored in <xliff:g id="directory" example="DCIM">%2$s</xliff:g>.</string>
     <!-- Header message title show on open document tree flow when directory is blocked. [CHAR_LIMIT=48] -->
     <string name="directory_blocked_header_title">Can\u2019t use this folder</string>
     <!-- Header message subtitle show on open document tree flow when directory is blocked. [CHAR_LIMIT=90]-->
@@ -587,6 +628,39 @@
     <!-- Search hint on search view. [CHAR LIMIT=48] -->
     <string name="search_bar_hint">Search this device</string>
 
+    <!-- Content description for the X button to clear text [CHAR_LIMIT=NONE] -->
+    <string name="search_bar_clear">Clear text</string>
+
+    <!-- Search location selector placeholder for this folder -->
+    <string name="search_location_this_folder">This folder</string>
+
+    <!-- Search location selector placeholder for root folder -->
+    <string name="search_location_root_folder">Root folder</string>
+
+    <!-- Search location selector placeholder for everywhere -->
+    <string name="search_location_everywhere">Everywhere</string>
+
+    <!-- Search last modified time selector any time-->
+    <string name="search_last_modified_any_time">Any time</string>
+
+    <!-- Search last modified time selector for today -->
+    <string name="search_last_modified_1_day">Today</string>
+
+    <!-- Search last modified time selector last two days -->
+    <string name="search_last_modified_2_days">Yesterday</string>
+
+    <!-- Search last modified time selector for last 7 day -->
+    <string name="search_last_modified_7_days">Last week</string>
+
+    <!-- Search last modified time selector for last 30 days -->
+    <string name="search_last_modified_30_days">Last month</string>
+
+    <!-- Search last modified time selector for last 365 days -->
+    <string name="search_last_modified_365_days">Last year</string>
+
+    <!-- Search file type selector for all types -->
+    <string name="search_file_type_all">All types</string>
+
     <!-- Content description for deleting search history. [CHAR_LIMIT=60] -->
     <string name="delete_search_history">Delete search history <xliff:g id="text" example="image">%1$s</xliff:g></string>
 
@@ -614,4 +688,13 @@
 
     <!-- Text used at the top of the text field when saving a document. [CHAR_LIMIT=100] -->
     <string name="file_name_hint">File name</string>
+
+    <!-- Accessibility label for the Peek navigation icon. -->
+    <string name="a11y_peek_navigation_icon">Hide file preview</string>
+
+    <!-- Text used in Peek to indicate that no preview is available. -->
+    <string name="peek_no_preview">No preview available</string>
+
+    <!-- Accessibility label for an image preview in Peek. -->
+    <string name="a11y_peek_image_preview">Image preview of <xliff:g id="filename" example="image.png">%s</xliff:g></string>
 </resources>
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values/styles.xml b/res/values/styles.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values/styles.xml
rename to res/values/styles.xml
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values/styles_text.xml b/res/values/styles_text.xml
similarity index 99%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values/styles_text.xml
rename to res/values/styles_text.xml
index 084480c2c..0149ef725 100644
--- a/res/flag(!com.android.documentsui.flags.use_material3)/values/styles_text.xml
+++ b/res/values/styles_text.xml
@@ -149,5 +149,4 @@
     <style name="Body1" parent="@android:style/TextAppearance.Material.Body1">
         <item name="fontFamily">@string/config_fontFamily</item>
     </style>
-
 </resources>
\ No newline at end of file
diff --git a/res/flag(!com.android.documentsui.flags.use_material3)/values/themes.xml b/res/values/themes.xml
similarity index 100%
rename from res/flag(!com.android.documentsui.flags.use_material3)/values/themes.xml
rename to res/values/themes.xml
diff --git a/src/com/android/documentsui/AbstractActionHandler.java b/src/com/android/documentsui/AbstractActionHandler.java
index 89e9bc2d6..68aea626a 100644
--- a/src/com/android/documentsui/AbstractActionHandler.java
+++ b/src/com/android/documentsui/AbstractActionHandler.java
@@ -276,6 +276,14 @@ public abstract class AbstractActionHandler<T extends FragmentActivity & CommonA
         throw new UnsupportedOperationException("Can't spring open directories.");
     }
 
+    @Override
+    public void jumpToDirectory(DocumentStack stack) {
+        // reset() takes ownership of the passed in stack's document list, so we need to make a copy
+        // first.
+        mState.stack.reset(new DocumentStack(stack));
+        mActivity.refreshCurrentRootAndDirectory(AnimationView.ANIM_NONE);
+    }
+
     @Override
     public void openSettings(RootInfo root) {
         throw new UnsupportedOperationException("Can't open settings.");
@@ -1008,18 +1016,19 @@ public abstract class AbstractActionHandler<T extends FragmentActivity & CommonA
                 mExecutorService = Executors.newFixedThreadPool(
                         GlobalSearchLoader.MAX_OUTSTANDING_TASK);
             }
-            DocumentStack stack = mState.stack;
-            RootInfo root = stack.getRoot();
             List<UserId> userIdList = DocumentsApplication.getUserIdManager(mActivity).getUserIds();
 
+            DocumentStack stack = mState.stack;
             Duration lastModifiedDelta = stack.isRecents()
                     ? Duration.ofMillis(RecentsLoader.REJECT_OLDER_THAN)
                     : null;
+            RootInfo root = stack.getRoot();
             int maxResults = (root == null || root.isRecents())
                     ? RecentsLoader.MAX_DOCS_FROM_ROOT : MAX_RESULTS;
             QueryOptions options = new QueryOptions(
-                    maxResults, lastModifiedDelta, Duration.ofMillis(MAX_SEARCH_TIME_MS),
-                    mState.showHiddenFiles, mState.acceptMimes, mSearchMgr.buildQueryArgs());
+                    maxResults, maxResults, lastModifiedDelta,
+                    Duration.ofMillis(MAX_SEARCH_TIME_MS), mState.showHiddenFiles,
+                    mState.acceptMimes, mSearchMgr.buildQueryArgs());
 
             if (stack.isRecents() || mSearchMgr.isSearching()) {
                 Log.d(TAG, "Creating search loader V2");
@@ -1027,21 +1036,13 @@ public abstract class AbstractActionHandler<T extends FragmentActivity & CommonA
                 // one of the searched content providers reports a change.
                 final LockingContentObserver observer = new LockingContentObserver(
                         mContentLock, AbstractActionHandler.this::loadDocumentsForCurrentStack);
-                Collection<RootInfo> rootList = new ArrayList<>();
-                if (stack.isRecents()) {
-                    // TODO(b:381346575): Pass roots based on user selection.
-                    rootList.addAll(mProviders.getMatchingRootsBlocking(mState).stream().filter(
-                            r -> r.supportsSearch() && r.authority != null
-                                    && r.rootId != null).toList());
-                } else {
-                    rootList.add(root);
-                }
+                Collection<RootInfo> roots = mProviders.getMatchingRootsBlocking(mState);
                 return new SearchLoader(
                         mActivity,
                         userIdList,
                         mInjector.fileTypeLookup,
                         observer,
-                        rootList,
+                        mSearchMgr.getSearchFolders(roots, stack),
                         mSearchMgr.getCurrentSearch(),
                         options,
                         mState.sortModel,
@@ -1062,7 +1063,6 @@ public abstract class AbstractActionHandler<T extends FragmentActivity & CommonA
                     options,
                     mState.sortModel
             );
-
         }
 
         @Override
diff --git a/src/com/android/documentsui/ActionHandler.java b/src/com/android/documentsui/ActionHandler.java
index 190f5d960..80987a68e 100644
--- a/src/com/android/documentsui/ActionHandler.java
+++ b/src/com/android/documentsui/ActionHandler.java
@@ -141,6 +141,11 @@ public interface ActionHandler {
      */
     void springOpenDirectory(DocumentInfo doc);
 
+    /**
+     * Replaces the existing stack with the given stack.
+     */
+    void jumpToDirectory(DocumentStack stack);
+
     void showChooserForDoc(DocumentInfo doc);
 
     void openRootDocument(@Nullable DocumentInfo rootDoc);
diff --git a/src/com/android/documentsui/ActionModeController.java b/src/com/android/documentsui/ActionModeController.java
index 931942fca..826f4ab55 100644
--- a/src/com/android/documentsui/ActionModeController.java
+++ b/src/com/android/documentsui/ActionModeController.java
@@ -18,6 +18,7 @@ package com.android.documentsui;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Activity;
 import android.util.Log;
@@ -100,8 +101,9 @@ public class ActionModeController extends SelectionObserver<String>
 
         if (mActionMode != null) {
             assert(!mSelected.isEmpty());
-            final String title = mMessages.getQuantityString(
-                    R.plurals.elements_selected, mSelected.size());
+            final String title =
+                    mMessages.getQuantityString(
+                            getRes(R.plurals.elements_selected), mSelected.size());
             mActionMode.setTitle(title);
             mActivity.getWindow().setTitle(title);
         }
@@ -139,8 +141,8 @@ public class ActionModeController extends SelectionObserver<String>
         // Re-enable TalkBack for the toolbars, as they are no longer covered by action mode.
         int[] toolbarIds =
                 isUseMaterial3FlagEnabled()
-                        ? new int[] {R.id.toolbar}
-                        : new int[] {R.id.toolbar, R.id.roots_toolbar};
+                        ? new int[] {getRes(R.id.toolbar)}
+                        : new int[] {getRes(R.id.toolbar), getRes(R.id.roots_toolbar)};
         mScope.accessibilityImportanceSetter.setAccessibilityImportance(
                 View.IMPORTANT_FOR_ACCESSIBILITY_AUTO, toolbarIds);
 
@@ -150,7 +152,7 @@ public class ActionModeController extends SelectionObserver<String>
     @Override
     public boolean onCreateActionMode(ActionMode mode, Menu menu) {
         int size = mSelectionMgr.getSelection().size();
-        mode.getMenuInflater().inflate(R.menu.action_mode_menu, menu);
+        mode.getMenuInflater().inflate(getRes(R.menu.action_mode_menu), menu);
         mode.setTitle(mActivity.getResources().getQuantityString(R.plurals.selected_count, size));
 
         if (size > 0) {
@@ -160,8 +162,8 @@ public class ActionModeController extends SelectionObserver<String>
             // these controls when using linear navigation.
             int[] toolbarIds =
                     isUseMaterial3FlagEnabled()
-                            ? new int[] {R.id.toolbar}
-                            : new int[] {R.id.toolbar, R.id.roots_toolbar};
+                            ? new int[] {getRes(R.id.toolbar)}
+                            : new int[] {getRes(R.id.toolbar), getRes(R.id.roots_toolbar)};
             mScope.accessibilityImportanceSetter.setAccessibilityImportance(
                     View.IMPORTANT_FOR_ACCESSIBILITY_NO_HIDE_DESCENDANTS,
                     toolbarIds);
diff --git a/src/com/android/documentsui/BaseActivity.java b/src/com/android/documentsui/BaseActivity.java
index 8a5779a69..4683707b7 100644
--- a/src/com/android/documentsui/BaseActivity.java
+++ b/src/com/android/documentsui/BaseActivity.java
@@ -19,8 +19,10 @@ package com.android.documentsui;
 import static com.android.documentsui.base.Shared.EXTRA_BENCHMARK;
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.base.State.MODE_GRID;
+import static com.android.documentsui.util.FlagUtils.isSearchV2Enabled;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
-import static com.android.documentsui.util.FlagUtils.isUsePeekPreviewFlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Context;
 import android.content.Intent;
@@ -29,7 +31,6 @@ import android.content.pm.PackageManager;
 import android.content.pm.ProviderInfo;
 import android.graphics.Color;
 import android.net.Uri;
-import android.os.Build;
 import android.os.Bundle;
 import android.os.MessageQueue.IdleHandler;
 import android.preference.PreferenceManager;
@@ -50,6 +51,7 @@ import androidx.annotation.VisibleForTesting;
 import androidx.appcompat.app.AppCompatActivity;
 import androidx.appcompat.widget.ActionMenuView;
 import androidx.appcompat.widget.Toolbar;
+import androidx.core.view.WindowInsetsCompat;
 import androidx.fragment.app.Fragment;
 
 import com.android.documentsui.AbstractActionHandler.CommonAddons;
@@ -66,7 +68,6 @@ import com.android.documentsui.base.UserId;
 import com.android.documentsui.dirlist.AnimationView;
 import com.android.documentsui.dirlist.AppsRowManager;
 import com.android.documentsui.dirlist.DirectoryFragment;
-import com.android.documentsui.peek.PeekViewManager;
 import com.android.documentsui.prefs.LocalPreferences;
 import com.android.documentsui.prefs.PreferencesMonitor;
 import com.android.documentsui.queries.CommandInterceptor;
@@ -98,7 +99,6 @@ public abstract class BaseActivity
 
     protected SearchViewManager mSearchManager;
     protected AppsRowManager mAppsRowManager;
-    protected @Nullable PeekViewManager mPeekViewManager;
     protected UserIdManager mUserIdManager;
     protected UserManagerState mUserManagerState;
     protected State mState;
@@ -185,7 +185,7 @@ public abstract class BaseActivity
         // ToDo Create tool to check resource version before applyStyle for the theme
         // If version code is not match, we should reset overlay package to default,
         // in case Activity continuously encounter resource not found exception.
-        getTheme().applyStyle(R.style.DocumentsDefaultTheme, false);
+        getTheme().applyStyle(getRes(R.style.DocumentsDefaultTheme), false);
 
         if (isUseMaterial3FlagEnabled() && SdkLevel.isAtLeastS()) {
             DynamicColors.applyToActivityIfAvailable(this);
@@ -209,10 +209,10 @@ public abstract class BaseActivity
         Metrics.logActivityLaunch(mState, intent);
 
         if (isUseMaterial3FlagEnabled()) {
-            View navRailRoots = findViewById(R.id.nav_rail_container_roots);
+            View navRailRoots = findViewById(getRes(R.id.nav_rail_container_roots));
             if (navRailRoots != null) {
                 // Bind event listener for the burger menu on nav rail.
-                MaterialButton burgerMenu = findViewById(R.id.nav_rail_burger_menu);
+                MaterialButton burgerMenu = findViewById(getRes(R.id.nav_rail_burger_menu));
                 burgerMenu.setOnClickListener(v -> mDrawer.setOpen(true));
                 burgerMenu.setOnFocusChangeListener(this::onBurgerMenuFocusChange);
             }
@@ -221,16 +221,16 @@ public abstract class BaseActivity
         mProviders = DocumentsApplication.getProvidersCache(this);
         mDocs = DocumentsAccess.create(this, mState);
 
-        Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);
+        Toolbar toolbar = (Toolbar) findViewById(getRes(R.id.toolbar));
         setSupportActionBar(toolbar);
 
-        Breadcrumb breadcrumb = findViewById(R.id.horizontal_breadcrumb);
+        Breadcrumb breadcrumb = findViewById(getRes(R.id.horizontal_breadcrumb));
         assert (breadcrumb != null);
-        View profileTabsContainer = findViewById(R.id.tabs_container);
+        View profileTabsContainer = findViewById(getRes(R.id.tabs_container));
         assert (profileTabsContainer != null);
 
         mNavigator = getNavigationViewManager(breadcrumb, profileTabsContainer);
-        AppBarLayout appBarLayout = findViewById(R.id.app_bar);
+        AppBarLayout appBarLayout = findViewById(getRes(R.id.app_bar));
         if (appBarLayout != null) {
             appBarLayout.addOnOffsetChangedListener(mNavigator);
         }
@@ -259,6 +259,13 @@ public abstract class BaseActivity
                 }
             }
 
+            @Override
+            public void onSearchStarting() {
+                if (isSearchV2Enabled()) {
+                    mInjector.getModel().setLoading(true);
+                }
+            }
+
             @Override
             public void onSearchFinished() {
                 // Restores menu icons state
@@ -284,6 +291,11 @@ public abstract class BaseActivity
                 // We also need to update AppsRowManager because we may want to show/hide the
                 // appsRow in cross-profile search according to the searching conditions.
                 mAppsRowManager.updateView(BaseActivity.this);
+
+                if (isUseMaterial3FlagEnabled()) {
+                    // Whenever a search chip is clicked, close the navigation bar.
+                    mInjector.selectionBarController.closeSelectionBar();
+                }
             }
 
             @Override
@@ -325,7 +337,11 @@ public abstract class BaseActivity
                         mInjector.debugHelper::toggleDebugMode,
                         cmdInterceptor);
 
-        ViewGroup chipGroup = findViewById(R.id.search_chip_group);
+        ViewGroup chipGroup = findViewById(getRes(R.id.search_chip_group));
+        View searchOptionsView = null;
+        if (isUseMaterial3FlagEnabled()) {
+            searchOptionsView = findViewById(getRes(R.id.search_options_row));
+        }
 
         mUserIdManager = DocumentsApplication.getUserIdManager(this);
         mUserManagerState = DocumentsApplication.getUserManagerState(this);
@@ -336,7 +352,7 @@ public abstract class BaseActivity
             mUserManagerState.setCurrentStateIntent(intent);
         }
         mSearchManager = new SearchViewManager(searchListener, queryInterceptor,
-                chipGroup, savedInstanceState);
+                chipGroup, searchOptionsView, savedInstanceState);
         // initialize the chip sets by accept mime types
         mSearchManager.initChipSets(mState.acceptMimes);
         // update the chip items by the mime types of the root
@@ -401,7 +417,7 @@ public abstract class BaseActivity
 
         mSortController = SortController.create(this, mState.derivedMode, mState.sortModel);
         if (isUseMaterial3FlagEnabled()) {
-            View previewIconPlaceholder = findViewById(R.id.preview_icon_placeholder);
+            View previewIconPlaceholder = findViewById(getRes(R.id.preview_icon_placeholder));
             if (previewIconPlaceholder != null) {
                 previewIconPlaceholder.setVisibility(
                         mState.shouldShowPreview() ? View.VISIBLE : View.GONE);
@@ -417,11 +433,6 @@ public abstract class BaseActivity
         // Base classes must update result in their onCreate.
         setResult(AppCompatActivity.RESULT_CANCELED);
         updateRecentsSetting();
-
-        if (isUsePeekPreviewFlagEnabled()) {
-            mPeekViewManager = new PeekViewManager(this);
-            mPeekViewManager.initFragment(getSupportFragmentManager());
-        }
     }
 
     private NavigationViewManager getNavigationViewManager(Breadcrumb breadcrumb,
@@ -435,8 +446,7 @@ public abstract class BaseActivity
                     breadcrumb,
                     profileTabsContainer,
                     DocumentsApplication.getUserManagerState(this),
-                    mConfigStore,
-                    mInjector);
+                    mConfigStore);
         }
         return new NavigationViewManager(
                 this,
@@ -446,8 +456,7 @@ public abstract class BaseActivity
                 breadcrumb,
                 profileTabsContainer,
                 DocumentsApplication.getUserIdManager(this),
-                mConfigStore,
-                mInjector);
+                mConfigStore);
     }
 
     public void onPreferenceChanged(String pref) {
@@ -463,7 +472,7 @@ public abstract class BaseActivity
 
         Runnable finishActionMode =
                 (isUseMaterial3FlagEnabled())
-                        ? mNavigator::closeSelectionBar
+                        ? mInjector.selectionBarController::closeSelectionBar
                         : mInjector.actionModeController::finishActionMode;
 
         mRootsMonitor =
@@ -487,27 +496,22 @@ public abstract class BaseActivity
 
     @Override
     public boolean onCreateOptionsMenu(Menu menu) {
-        if (isUseMaterial3FlagEnabled()) {
-            // In Material3 the menu is now inflated in the `NavigationViewMenu`. This is currently
-            // to allow for us to inflate between the action_menu and the activity menu. Once the
-            // Material 3 flag is removed, the menus will be merged and we can rely on this single
-            // inflation point.
-            return super.onCreateOptionsMenu(menu);
-        }
         boolean showMenu = super.onCreateOptionsMenu(menu);
 
-        getMenuInflater().inflate(R.menu.activity, menu);
+        getMenuInflater().inflate(getRes(R.menu.activity), menu);
         mNavigator.update();
-        boolean fullBarSearch = getResources().getBoolean(R.bool.full_bar_search_view);
-        boolean showSearchBar = getResources().getBoolean(R.bool.show_search_bar);
-        mSearchManager.install(menu, fullBarSearch, showSearchBar);
+        boolean fullBarSearch = getResources().getBoolean(getRes(R.bool.full_bar_search_view));
+        boolean showSearchBar = isUseMaterial3FlagEnabled() ? false : getResources().getBoolean(
+                R.bool.show_search_bar);
+        boolean showDockedSearch = getResources().getBoolean(R.bool.show_docked_search);
+        mSearchManager.install(menu, fullBarSearch, showSearchBar, showDockedSearch);
 
         // Remove the subMenu when material3 is launched b/379776735.
-        final ActionMenuView subMenuView = findViewById(R.id.sub_menu);
+        final ActionMenuView subMenuView = findViewById(getRes(R.id.sub_menu));
         // If size is 0, it means the menu has not inflated and it should only do once.
         if (subMenuView != null && subMenuView.getMenu().size() == 0) {
             subMenuView.setOnMenuItemClickListener(this::onOptionsItemSelected);
-            getMenuInflater().inflate(R.menu.sub_menu, subMenuView.getMenu());
+            getMenuInflater().inflate(getRes(R.menu.sub_menu), subMenuView.getMenu());
         }
 
         return showMenu;
@@ -517,17 +521,20 @@ public abstract class BaseActivity
     @CallSuper
     public boolean onPrepareOptionsMenu(Menu menu) {
         super.onPrepareOptionsMenu(menu);
+        mSearchManager.showMenu(mState.stack);
+
         // Remove the subMenu when material3 is launched b/379776735.
         if (isUseMaterial3FlagEnabled()) {
-            if (mNavigator != null) {
-                mNavigator.updateActionMenu();
-            }
+            mInjector.menuManager.updateSubMenu(null);
         } else {
-            mSearchManager.showMenu(mState.stack);
-            final ActionMenuView subMenuView = findViewById(R.id.sub_menu);
+            final ActionMenuView subMenuView = findViewById(getRes(R.id.sub_menu));
             mInjector.menuManager.updateSubMenu(subMenuView.getMenu());
         }
 
+        if (isVisualSignalsFlagEnabled()) {
+            mInjector.menuManager.instantiateJobProgress(menu);
+        }
+
         return true;
     }
 
@@ -574,7 +581,7 @@ public abstract class BaseActivity
     }
 
     private void setContainer() {
-        View root = findViewById(R.id.coordinator_layout);
+        View root = findViewById(getRes(R.id.coordinator_layout));
         root.setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
                 | View.SYSTEM_UI_FLAG_LAYOUT_STABLE);
         root.setOnApplyWindowInsetsListener(
@@ -585,32 +592,28 @@ public abstract class BaseActivity
                             insets.getSystemWindowInsetRight(),
                             0);
 
-                    // When use_material3 flag is ON and FEATURE_FREEFORM_WINDOW_MANAGEMENT is
-                    // enabled, then there should not be any additional bottom gap in full screen
-                    // mode. Otherwise need to take into account the system window insets such as
-                    // the bottom swipe up navigation gesture.
-                    if (!isUseMaterial3FlagEnabled()
-                            || !getApplicationContext()
-                            .getPackageManager()
-                            .hasSystemFeature(
-                                    PackageManager.FEATURE_FREEFORM_WINDOW_MANAGEMENT)) {
-                        View saveContainer = findViewById(R.id.container_save);
+                    boolean isNavBarVisible =
+                            insets.isVisible(WindowInsetsCompat.Type.navigationBars());
+                    if (isNavBarVisible) {
+                        View saveContainer = findViewById(getRes(R.id.container_save));
                         saveContainer.setPadding(0, 0, 0, insets.getSystemWindowInsetBottom());
 
-                        View rootsContainer = findViewById(R.id.container_roots);
+                        View rootsContainer = findViewById(getRes(R.id.container_roots));
                         rootsContainer.setPadding(0, 0, 0, insets.getSystemWindowInsetBottom());
+
+                        View navRailContainer = findViewById(R.id.nav_rail_container_roots);
+                        if (navRailContainer != null) {
+                            navRailContainer.setPadding(
+                                    0, 0, 0, insets.getSystemWindowInsetBottom());
+                        }
                     }
 
                     return insets.consumeSystemWindowInsets();
                 });
 
         getWindow().setNavigationBarDividerColor(Color.TRANSPARENT);
-        if (Build.VERSION.SDK_INT >= 29) {
-            getWindow().setNavigationBarColor(Color.TRANSPARENT);
-            getWindow().setNavigationBarContrastEnforced(true);
-        } else {
-            getWindow().setNavigationBarColor(getColor(R.color.nav_bar_translucent));
-        }
+        getWindow().setNavigationBarColor(Color.TRANSPARENT);
+        getWindow().setNavigationBarContrastEnforced(true);
     }
 
     @Override
@@ -635,7 +638,7 @@ public abstract class BaseActivity
         }
 
         if (isUseMaterial3FlagEnabled()) {
-            mNavigator.closeSelectionBar();
+            mInjector.selectionBarController.closeSelectionBar();
         } else {
             mInjector.actionModeController.finishActionMode();
         }
@@ -677,31 +680,31 @@ public abstract class BaseActivity
         if (id == android.R.id.home) {
             onBackPressed();
             return true;
-        } else if (id == R.id.option_menu_create_dir) {
+        } else if (id == getRes(R.id.option_menu_create_dir)) {
             getInjector().actions.showCreateDirectoryDialog();
             return true;
-        } else if (id == R.id.option_menu_search) {
+        } else if (id == getRes(R.id.option_menu_search)) {
             // SearchViewManager listens for this directly.
             return false;
-        } else if (id == R.id.option_menu_select_all) {
+        } else if (id == getRes(R.id.option_menu_select_all)) {
             getInjector().actions.selectAllFiles();
             return true;
-        } else if (id == R.id.option_menu_debug) {
+        } else if (id == getRes(R.id.option_menu_debug)) {
             getInjector().actions.showDebugMessage();
             return true;
-        } else if (id == R.id.option_menu_sort) {
+        } else if (id == getRes(R.id.option_menu_sort)) {
             getInjector().actions.showSortDialog();
             return true;
-        } else if (id == R.id.option_menu_launcher) {
+        } else if (id == getRes(R.id.option_menu_launcher)) {
             getInjector().actions.switchLauncherIcon();
             return true;
-        } else if (id == R.id.option_menu_show_hidden_files) {
+        } else if (id == getRes(R.id.option_menu_show_hidden_files)) {
             onClickedShowHiddenFiles();
             return true;
-        } else if (id == R.id.sub_menu_grid) {
+        } else if (id == getRes(R.id.sub_menu_grid)) {
             setViewMode(MODE_GRID);
             return true;
-        } else if (id == R.id.sub_menu_list) {
+        } else if (id == getRes(R.id.sub_menu_list)) {
             setViewMode(State.MODE_LIST);
             return true;
         }
@@ -784,7 +787,7 @@ public abstract class BaseActivity
             }
         }
 
-        String appName = getString(R.string.files_label);
+        String appName = getString(getRes(R.string.files_label));
         String currentTitle = getTitle() != null ? getTitle().toString() : "";
         if (currentTitle.equals(appName)) {
             // First launch, TalkBack announces app name.
@@ -863,7 +866,7 @@ public abstract class BaseActivity
         if (isUseMaterial3FlagEnabled()) {
             mInjector.menuManager.updateSubMenu(null);
         } else {
-            final ActionMenuView subMenuView = findViewById(R.id.sub_menu);
+            final ActionMenuView subMenuView = findViewById(getRes(R.id.sub_menu));
             mInjector.menuManager.updateSubMenu(subMenuView.getMenu());
         }
 
@@ -886,7 +889,7 @@ public abstract class BaseActivity
     }
 
     public void expandAppBar() {
-        final AppBarLayout appBarLayout = findViewById(R.id.app_bar);
+        final AppBarLayout appBarLayout = findViewById(getRes(R.id.app_bar));
         if (appBarLayout != null) {
             appBarLayout.setExpanded(true);
         }
@@ -899,7 +902,7 @@ public abstract class BaseActivity
      */
     public void updateHeader(boolean shouldHideHeader) {
         // Remove headContainer when material3 is launched. b/379776735.
-        View headerContainer = findViewById(R.id.header_container);
+        View headerContainer = findViewById(getRes(R.id.header_container));
         if (headerContainer == null) {
             updateHeaderTitle();
             return;
@@ -947,7 +950,7 @@ public abstract class BaseActivity
         }
 
         // Remove the headerTitle when material3 is launched b/379776735.
-        TextView headerTitle = findViewById(R.id.header_title);
+        TextView headerTitle = findViewById(getRes(R.id.header_title));
         if (headerTitle != null) {
             headerTitle.setText(result);
         }
@@ -958,44 +961,55 @@ public abstract class BaseActivity
         // is not expanded on that time.
         boolean isGlobalSearch = mSearchManager.isSearching() || mState.stack.size() > 1;
         if (mState.isPhotoPicking()) {
-            final int resId = isGlobalSearch
-                    ? R.string.root_info_header_image_global_search
-                    : R.string.root_info_header_image_recent;
+            final int resId =
+                    isGlobalSearch
+                            ? getRes(R.string.root_info_header_image_global_search)
+                            : getRes(R.string.root_info_header_image_recent);
             return getString(resId);
         } else {
-            final int resId = isGlobalSearch
-                    ? R.string.root_info_header_global_search
-                    : R.string.root_info_header_recent;
+            final int resId =
+                    isGlobalSearch
+                            ? getRes(R.string.root_info_header_global_search)
+                            : getRes(R.string.root_info_header_recent);
             return getString(resId);
         }
     }
 
     private String getHeaderDownloadsTitle() {
-        return getString(mState.isPhotoPicking()
-                ? R.string.root_info_header_image_downloads : R.string.root_info_header_downloads);
+        return getString(
+                mState.isPhotoPicking()
+                        ? getRes(R.string.root_info_header_image_downloads)
+                        : getRes(R.string.root_info_header_downloads));
     }
 
     private String getHeaderStorageTitle(String rootTitle) {
         if (mState.stack.size() > 1) {
-            final int resId = mState.isPhotoPicking()
-                    ? R.string.root_info_header_image_folder : R.string.root_info_header_folder;
+            final int resId =
+                    mState.isPhotoPicking()
+                            ? getRes(R.string.root_info_header_image_folder)
+                            : getRes(R.string.root_info_header_folder);
             return getString(resId, getCurrentTitle());
         } else {
-            final int resId = mState.isPhotoPicking()
-                    ? R.string.root_info_header_image_storage : R.string.root_info_header_storage;
+            final int resId =
+                    mState.isPhotoPicking()
+                            ? getRes(R.string.root_info_header_image_storage)
+                            : getRes(R.string.root_info_header_storage);
             return getString(resId, rootTitle);
         }
     }
 
     private String getHeaderDefaultTitle(String rootTitle, String summary) {
         if (TextUtils.isEmpty(summary)) {
-            final int resId = mState.isPhotoPicking()
-                    ? R.string.root_info_header_image_app : R.string.root_info_header_app;
+            final int resId =
+                    mState.isPhotoPicking()
+                            ? getRes(R.string.root_info_header_image_app)
+                            : getRes(R.string.root_info_header_app);
             return getString(resId, rootTitle);
         } else {
-            final int resId = mState.isPhotoPicking()
-                    ? R.string.root_info_header_image_app_with_summary
-                    : R.string.root_info_header_app_with_summary;
+            final int resId =
+                    mState.isPhotoPicking()
+                            ? getRes(R.string.root_info_header_image_app_with_summary)
+                            : getRes(R.string.root_info_header_app_with_summary);
             return getString(resId, rootTitle, summary);
         }
     }
@@ -1198,8 +1212,8 @@ public abstract class BaseActivity
     private void onBurgerMenuFocusChange(View v, boolean hasFocus) {
         MaterialButton burgerMenu = (MaterialButton) v;
         if (hasFocus) {
-            final int focusRingWidth = getResources()
-                    .getDimensionPixelSize(R.dimen.focus_ring_width);
+            final int focusRingWidth =
+                    getResources().getDimensionPixelSize(getRes(R.dimen.focus_ring_width));
             burgerMenu.setStrokeWidth(focusRingWidth);
         } else {
             burgerMenu.setStrokeWidth(0);
diff --git a/src/com/android/documentsui/BreadcrumbHolder.java b/src/com/android/documentsui/BreadcrumbHolder.java
index 4baaf9ca5..97e2e3e7f 100644
--- a/src/com/android/documentsui/BreadcrumbHolder.java
+++ b/src/com/android/documentsui/BreadcrumbHolder.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.view.View;
 import android.widget.ImageView;
 import android.widget.TextView;
@@ -31,8 +33,8 @@ public final class BreadcrumbHolder extends RecyclerView.ViewHolder {
 
     public BreadcrumbHolder(View itemView) {
         super(itemView);
-        mTitle = itemView.findViewById(R.id.breadcrumb_text);
-        mArrow = itemView.findViewById(R.id.breadcrumb_arrow);
+        mTitle = itemView.findViewById(getRes(R.id.breadcrumb_text));
+        mArrow = itemView.findViewById(getRes(R.id.breadcrumb_arrow));
         mLast = false;
     }
 
diff --git a/src/com/android/documentsui/CreateDirectoryFragment.java b/src/com/android/documentsui/CreateDirectoryFragment.java
index 4b066edb6..1c367ea94 100644
--- a/src/com/android/documentsui/CreateDirectoryFragment.java
+++ b/src/com/android/documentsui/CreateDirectoryFragment.java
@@ -19,6 +19,7 @@ package com.android.documentsui;
 import static android.content.ContentResolver.wrap;
 
 import static com.android.documentsui.base.SharedMinimal.TAG;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Dialog;
 import android.content.ContentProviderClient;
@@ -80,13 +81,13 @@ public class CreateDirectoryFragment extends DialogFragment {
         final MaterialAlertDialogBuilder builder = new MaterialAlertDialogBuilder(context);
         final LayoutInflater dialogInflater = LayoutInflater.from(builder.getContext());
 
-        final View view = dialogInflater.inflate(R.layout.dialog_file_name, null, false);
+        final View view = dialogInflater.inflate(getRes(R.layout.dialog_file_name), null, false);
         mEditText = (EditText) view.findViewById(android.R.id.text1);
 
-        mInputWrapper = view.findViewById(R.id.input_wrapper);
-        mInputWrapper.setHint(getString(R.string.input_hint_new_folder));
+        mInputWrapper = view.findViewById(getRes(R.id.input_wrapper));
+        mInputWrapper.setHint(getString(getRes(R.string.input_hint_new_folder)));
 
-        builder.setTitle(R.string.menu_create_dir);
+        builder.setTitle(getRes(R.string.menu_create_dir));
         builder.setView(view);
         builder.setPositiveButton(android.R.string.ok, null);
         builder.setNegativeButton(android.R.string.cancel, null);
@@ -125,8 +126,7 @@ public class CreateDirectoryFragment extends DialogFragment {
 
     private void createDirectory(String name) {
         if (name.isEmpty()) {
-            mInputWrapper.setError(getContext().getString(
-                    R.string.add_folder_name_error));
+            mInputWrapper.setError(getContext().getString(getRes(R.string.add_folder_name_error)));
         } else {
             final BaseActivity activity = (BaseActivity) getActivity();
             final DocumentInfo cwd = activity.getCurrentDirectory();
@@ -175,7 +175,8 @@ public class CreateDirectoryFragment extends DialogFragment {
                 mActivity.onDirectoryCreated(result);
                 Metrics.logCreateDirOperation();
             } else {
-                Snackbars.makeSnackbar(mActivity, R.string.create_error, Snackbar.LENGTH_LONG)
+                Snackbars.makeSnackbar(
+                                mActivity, getRes(R.string.create_error), Snackbar.LENGTH_LONG)
                         .show();
                 Metrics.logCreateDirError();
             }
diff --git a/src/com/android/documentsui/DirectoryResult.java b/src/com/android/documentsui/DirectoryResult.java
index 15ab0076d..736ee767b 100644
--- a/src/com/android/documentsui/DirectoryResult.java
+++ b/src/com/android/documentsui/DirectoryResult.java
@@ -55,6 +55,16 @@ public class DirectoryResult implements AutoCloseable {
         setCursor(null);
     }
 
+    /**
+     * Sets the client on this result. Generally, this should be considered an ownership
+     * transfer. The caller should set its own reference to null, to prevent further interactions
+     * with the client.
+     * @param client The client whose ownership is transferred to this result.
+     */
+    public void setClient(ContentProviderClient client) {
+        this.client = client;
+    }
+
     public Cursor getCursor() {
         return mCursor;
     }
diff --git a/src/com/android/documentsui/DocsSelectionHelper.java b/src/com/android/documentsui/DocsSelectionHelper.java
index 956527a2e..81b0c51f9 100644
--- a/src/com/android/documentsui/DocsSelectionHelper.java
+++ b/src/com/android/documentsui/DocsSelectionHelper.java
@@ -27,6 +27,7 @@ import androidx.recyclerview.selection.Selection;
 import androidx.recyclerview.selection.SelectionTracker;
 import androidx.recyclerview.widget.RecyclerView.AdapterDataObserver;
 
+import java.util.HashSet;
 import java.util.Set;
 
 /**
@@ -42,6 +43,8 @@ public final class DocsSelectionHelper extends SelectionTracker<String> {
     // See: b/69306667.
     private SelectionTracker<String> mDelegate = new StubSelectionTracker<>();
 
+    private Set<ResetObserver> mResetObservers = new HashSet<>();
+
     @VisibleForTesting
     DocsSelectionHelper(DelegateFactory factory) {
         mFactory = factory;
@@ -52,6 +55,40 @@ public final class DocsSelectionHelper extends SelectionTracker<String> {
             mDelegate.clearSelection();
         }
         mDelegate = mFactory.create(selectionTracker);
+        for (ResetObserver observer : mResetObservers) {
+            observer.onReset();
+        }
+    }
+
+    /**
+     * Observes when the DocsSelectionHelper gets reset (this happens on every initialization and
+     * re-initialization).
+     */
+    public abstract static class ResetObserver {
+        /**
+         * Called when the DocsSelectionHelper resets.
+         */
+        public void onReset() {
+        }
+    }
+
+    /**
+     * Adds a ResetObserver.
+     * @param observer
+     */
+    public void addResetObserver(ResetObserver observer) {
+        if (mResetObservers.contains(observer)) {
+            return;
+        }
+        mResetObservers.add(observer);
+    }
+
+    /**
+     * Removes a ResetObserver.
+     * @param observer
+     */
+    public void removeResetObserver(ResetObserver observer) {
+        mResetObservers.remove(observer);
     }
 
     @Override
diff --git a/src/com/android/documentsui/DocumentsApplication.java b/src/com/android/documentsui/DocumentsApplication.java
index ffaa5d740..3220e2adb 100644
--- a/src/com/android/documentsui/DocumentsApplication.java
+++ b/src/com/android/documentsui/DocumentsApplication.java
@@ -43,6 +43,7 @@ import com.android.documentsui.clipping.DocumentClipper;
 import com.android.documentsui.queries.SearchHistoryManager;
 import com.android.documentsui.roots.ProvidersCache;
 import com.android.documentsui.theme.ThemeOverlayManager;
+import com.android.documentsui.util.Material3Config;
 import com.android.modules.utils.build.SdkLevel;
 
 import com.google.common.collect.Lists;
@@ -166,9 +167,20 @@ public class DocumentsApplication extends Application {
         Log.d(TAG, "OverlayManager.setEnabled() result: " + result);
     }
 
+    /**
+     * Initializes configurations for Material3.
+     *
+     * <p>NOTE: It initializes even when the flag is disabled.
+     */
+    private void initializeMaterial3Config() {
+        Material3Config.getInstance()
+                .setForceMaterial3(getResources().getBoolean(R.bool.force_material3));
+    }
+
     @SuppressLint("NewApi") // OverlayManager.class is @hide
     @Override
     public void onCreate() {
+        initializeMaterial3Config();
         super.onCreate();
         synchronized (DocumentsApplication.class) {
             if (sConfigStore == null) {
diff --git a/src/com/android/documentsui/DragAndDropManager.java b/src/com/android/documentsui/DragAndDropManager.java
index 158d43c95..0c7988313 100644
--- a/src/com/android/documentsui/DragAndDropManager.java
+++ b/src/com/android/documentsui/DragAndDropManager.java
@@ -17,6 +17,7 @@
 package com.android.documentsui;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.ClipData;
 import android.content.Context;
@@ -286,8 +287,9 @@ public interface DragAndDropManager {
                 title = doc.displayName;
                 icon = iconHelper.getDocumentIcon(mContext, doc);
             } else {
-                title = mContext.getResources()
-                        .getQuantityString(R.plurals.elements_dragged, size, size);
+                title =
+                        mContext.getResources()
+                                .getQuantityString(getRes(R.plurals.elements_dragged), size, size);
                 icon = mDefaultShadowIcon;
             }
 
diff --git a/src/com/android/documentsui/DragOverTextView.java b/src/com/android/documentsui/DragOverTextView.java
index e9fc2a0fe..df1b8919e 100644
--- a/src/com/android/documentsui/DragOverTextView.java
+++ b/src/com/android/documentsui/DragOverTextView.java
@@ -16,9 +16,10 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.util.AttributeSet;
-import android.view.View.OnDragListener;
 import android.widget.TextView;
 
 /**
@@ -26,7 +27,7 @@ import android.widget.TextView;
  */
 
 public final class DragOverTextView extends TextView {
-    private static final int[] STATE_HIGHLIGHTED = {R.attr.state_highlighted};
+    private static final int[] STATE_HIGHLIGHTED = {getRes(R.attr.state_highlighted)};
 
     private boolean mHighlighted = false;
 
diff --git a/src/com/android/documentsui/DragShadowBuilder.java b/src/com/android/documentsui/DragShadowBuilder.java
index be76302e8..47b14dc33 100644
--- a/src/com/android/documentsui/DragShadowBuilder.java
+++ b/src/com/android/documentsui/DragShadowBuilder.java
@@ -17,6 +17,7 @@
 package com.android.documentsui;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Context;
 import android.graphics.Canvas;
@@ -57,28 +58,36 @@ class DragShadowBuilder extends View.DragShadowBuilder {
     private final int mShadowYOffset;
 
     DragShadowBuilder(Context context) {
-        mWidth = context.getResources().getDimensionPixelSize(R.dimen.drag_shadow_width);
-        mHeight = context.getResources().getDimensionPixelSize(R.dimen.drag_shadow_height);
-        mShadowRadius = context.getResources().getDimensionPixelSize(R.dimen.drag_shadow_radius);
-        mPadding = context.getResources().getDimensionPixelSize(R.dimen.drag_shadow_padding);
-
-        mShadowView = LayoutInflater.from(context).inflate(R.layout.drag_shadow_layout, null);
+        mWidth = context.getResources().getDimensionPixelSize(getRes(R.dimen.drag_shadow_width));
+        mHeight = context.getResources().getDimensionPixelSize(getRes(R.dimen.drag_shadow_height));
+        mShadowRadius =
+                context.getResources().getDimensionPixelSize(getRes(R.dimen.drag_shadow_radius));
+        mPadding =
+                context.getResources().getDimensionPixelSize(getRes(R.dimen.drag_shadow_padding));
+
+        mShadowView =
+                LayoutInflater.from(context).inflate(getRes(R.layout.drag_shadow_layout), null);
         mTitle = (TextView) mShadowView.findViewById(android.R.id.title);
         mIcon = (DropBadgeView) mShadowView.findViewById(android.R.id.icon);
         if (isUseMaterial3FlagEnabled()) {
             mAdditionalShadowView =
-                    LayoutInflater.from(context).inflate(R.layout.additional_drag_shadow, null);
+                    LayoutInflater.from(context)
+                            .inflate(getRes(R.layout.additional_drag_shadow), null);
             mDragContentRadius =
-                    context.getResources().getDimensionPixelSize(R.dimen.drag_content_radius);
+                    context.getResources()
+                            .getDimensionPixelSize(getRes(R.dimen.drag_content_radius));
             mAdditionalLayerOffset =
                     context.getResources()
-                            .getDimensionPixelSize(R.dimen.drag_additional_layer_offset);
+                            .getDimensionPixelSize(getRes(R.dimen.drag_additional_layer_offset));
             mDragFileCounterOffset =
-                    context.getResources().getDimensionPixelSize(R.dimen.drag_file_counter_offset);
+                    context.getResources()
+                            .getDimensionPixelSize(getRes(R.dimen.drag_file_counter_offset));
             mShadow2Radius =
-                    context.getResources().getDimensionPixelSize(R.dimen.drag_shadow_2_radius);
+                    context.getResources()
+                            .getDimensionPixelSize(getRes(R.dimen.drag_shadow_2_radius));
             mShadowYOffset =
-                    context.getResources().getDimensionPixelSize(R.dimen.drag_shadow_y_offset);
+                    context.getResources()
+                            .getDimensionPixelSize(getRes(R.dimen.drag_shadow_y_offset));
         } else {
             mAdditionalShadowView = null;
             mDragContentRadius = 0;
@@ -205,7 +214,7 @@ class DragShadowBuilder extends View.DragShadowBuilder {
             return;
         }
         mDragFileCount = count;
-        TextView dragFileCountView = mShadowView.findViewById(R.id.drag_file_counter);
+        TextView dragFileCountView = mShadowView.findViewById(getRes(R.id.drag_file_counter));
         if (dragFileCountView != null) {
             dragFileCountView.setVisibility(count > 1 ? View.VISIBLE : View.GONE);
             if (count > 1) {
diff --git a/src/com/android/documentsui/DrawerController.java b/src/com/android/documentsui/DrawerController.java
index cc90c9869..253bc6662 100644
--- a/src/com/android/documentsui/DrawerController.java
+++ b/src/com/android/documentsui/DrawerController.java
@@ -18,6 +18,7 @@ package com.android.documentsui;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Activity;
 import android.util.Log;
@@ -32,6 +33,7 @@ import androidx.legacy.app.ActionBarDrawerToggle;
 
 import com.android.documentsui.base.Display;
 import com.android.documentsui.base.Providers;
+import com.android.documentsui.util.ColorUtils;
 
 /**
  * A facade over the various pieces comprising "roots fragment in a Drawer".
@@ -53,24 +55,25 @@ public abstract class DrawerController implements DrawerListener {
      */
     public static DrawerController create(BaseActivity activity, ActivityConfig activityConfig) {
 
-        DrawerLayout layout = (DrawerLayout) activity.findViewById(R.id.drawer_layout);
+        DrawerLayout layout = (DrawerLayout) activity.findViewById(getRes(R.id.drawer_layout));
 
         if (layout == null) {
             return new StubDrawerController();
         }
 
-        View drawer = activity.findViewById(R.id.drawer_roots);
+        View drawer = activity.findViewById(getRes(R.id.drawer_roots));
         // This will be null when use_material3 flag is ON, we will check the flag when it's used in
         // RuntimeDrawerController.
-        Toolbar toolbar = (Toolbar) activity.findViewById(R.id.roots_toolbar);
+        Toolbar toolbar = (Toolbar) activity.findViewById(getRes(R.id.roots_toolbar));
         drawer.getLayoutParams().width = calculateDrawerWidth(activity);
 
-        ActionBarDrawerToggle toggle = new ActionBarDrawerToggle(
-                activity,
-                layout,
-                R.drawable.ic_hamburger,
-                R.string.drawer_open,
-                R.string.drawer_close);
+        ActionBarDrawerToggle toggle =
+                new ActionBarDrawerToggle(
+                        activity,
+                        layout,
+                        getRes(R.drawable.ic_hamburger),
+                        getRes(R.string.drawer_open),
+                        getRes(R.string.drawer_close));
 
         return new RuntimeDrawerController(layout, drawer, toggle, toolbar, activityConfig,
                 activity);
@@ -87,7 +90,7 @@ public abstract class DrawerController implements DrawerListener {
         // Material design specification for navigation drawer:
         // https://www.google.com/design/spec/patterns/navigation-drawer.html
         float width = Display.screenWidth(activity) - Display.actionBarHeight(activity);
-        float maxWidth = activity.getResources().getDimension(R.dimen.max_drawer_width);
+        float maxWidth = activity.getResources().getDimension(getRes(R.dimen.max_drawer_width));
         int finalWidth = (int) ((width > maxWidth ? maxWidth : width));
 
         if (DEBUG)
@@ -126,7 +129,7 @@ public abstract class DrawerController implements DrawerListener {
             mLayout.setDrawerListener(this);
 
             if (activityConfig.dragAndDropEnabled()) {
-                View edge = layout.findViewById(R.id.drawer_edge);
+                View edge = layout.findViewById(getRes(R.id.drawer_edge));
                 // nav_rail_layout also uses DrawerLayout, but it doesn't have drawer edge.
                 if (edge != null) {
                     edge.setOnDragListener(new ItemDragListener<>(this, SPRING_TIMEOUT));
@@ -141,11 +144,20 @@ public abstract class DrawerController implements DrawerListener {
 
         @Override
         public void setDropTargetHighlight(View v, boolean highlight) {
-            assert (v.getId() == R.id.drawer_edge);
-
-            @ColorRes int id = highlight ? R.color.secondary :
-                android.R.color.transparent;
-            v.setBackgroundColor(id);
+            assert (v.getId() == getRes(R.id.drawer_edge));
+
+            if (isUseMaterial3FlagEnabled()) {
+                int highlightColor =
+                        ColorUtils.resolveMaterialColorAttribute(
+                                v.getContext(),
+                                com.google.android.material.R.attr.colorPrimaryContainer);
+                int normalColor = v.getResources().getColor(android.R.color.transparent, null);
+                v.setBackgroundColor(highlight ? highlightColor : normalColor);
+            } else {
+                @ColorRes
+                int id = highlight ? getRes(R.color.secondary) : android.R.color.transparent;
+                v.setBackgroundColor(id);
+            }
         }
 
         @Override
@@ -160,7 +172,7 @@ public abstract class DrawerController implements DrawerListener {
 
         @Override
         public void onViewHovered(View v) {
-            assert (v.getId() == R.id.drawer_edge);
+            assert (v.getId() == getRes(R.id.drawer_edge));
 
             setOpen(true);
         }
@@ -172,7 +184,7 @@ public abstract class DrawerController implements DrawerListener {
 
         @Override
         public void setOpen(boolean open) {
-            View list = mDrawer.findViewById(R.id.roots_list);
+            View list = mDrawer.findViewById(getRes(R.id.roots_list));
             if (open) {
                 mLayout.openDrawer(mDrawer);
                 if (list != null) {
diff --git a/src/com/android/documentsui/DropBadgeView.java b/src/com/android/documentsui/DropBadgeView.java
index 552e2ecd3..9fd71c134 100644
--- a/src/com/android/documentsui/DropBadgeView.java
+++ b/src/com/android/documentsui/DropBadgeView.java
@@ -16,8 +16,7 @@
 
 package com.android.documentsui;
 
-import com.android.documentsui.DragAndDropManager.State;
-import com.android.documentsui.base.MimeTypes;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Context;
 import android.graphics.drawable.Drawable;
@@ -26,26 +25,33 @@ import android.util.AttributeSet;
 import android.view.Gravity;
 import android.widget.ImageView;
 
+import com.android.documentsui.DragAndDropManager.State;
+import com.android.documentsui.base.MimeTypes;
+
 /**
  * Provides a way to encapsulate droppable badge toggling logic into a single class.
  */
 public final class DropBadgeView extends ImageView {
-    private static final int[] STATE_REJECT_DROP = { R.attr.state_reject_drop };
-    private static final int[] STATE_COPY = { R.attr.state_copy };
+    private final int[] mStateRejectDrop;
+    private final int[] mStateCopy;
 
     private @State int mState;
     private LayerDrawable mBackground;
 
     public DropBadgeView(Context context, AttributeSet attrs) {
         super(context, attrs);
-
-        final int badgeHeight = context.getResources()
-                .getDimensionPixelSize(R.dimen.drop_icon_height);
-        final int badgeWidth = context.getResources()
-                .getDimensionPixelSize(R.dimen.drop_icon_width);
-        final int iconSize = context.getResources().getDimensionPixelSize(R.dimen.root_icon_size);
-
-        Drawable okBadge = context.getResources().getDrawable(R.drawable.drop_badge_states, null);
+        mStateRejectDrop = new int[] {getRes(R.attr.state_reject_drop)};
+        mStateCopy = new int[] {getRes(R.attr.state_copy)};
+
+        final int badgeHeight =
+                context.getResources().getDimensionPixelSize(getRes(R.dimen.drop_icon_height));
+        final int badgeWidth =
+                context.getResources().getDimensionPixelSize(getRes(R.dimen.drop_icon_width));
+        final int iconSize =
+                context.getResources().getDimensionPixelSize(getRes(R.dimen.root_icon_size));
+
+        Drawable okBadge =
+                context.getResources().getDrawable(getRes(R.drawable.drop_badge_states), null);
         Drawable defaultIcon = IconUtils.loadMimeIcon(context, MimeTypes.GENERIC_TYPE);
 
         Drawable[] list = {defaultIcon, okBadge};
@@ -66,10 +72,10 @@ public final class DropBadgeView extends ImageView {
 
         switch (mState) {
             case DragAndDropManager.STATE_NOT_ALLOWED:
-                mergeDrawableStates(drawableState, STATE_REJECT_DROP);
+                mergeDrawableStates(drawableState, mStateRejectDrop);
                 break;
             case DragAndDropManager.STATE_COPY:
-                mergeDrawableStates(drawableState, STATE_COPY);
+                mergeDrawableStates(drawableState, mStateCopy);
                 break;
         }
 
@@ -84,4 +90,4 @@ public final class DropBadgeView extends ImageView {
     void updateIcon(Drawable icon) {
         mBackground.setDrawable(0, icon);
     }
-}
\ No newline at end of file
+}
diff --git a/src/com/android/documentsui/GridItemThumbnail.java b/src/com/android/documentsui/GridItemThumbnail.java
index 6348148fd..285c27114 100644
--- a/src/com/android/documentsui/GridItemThumbnail.java
+++ b/src/com/android/documentsui/GridItemThumbnail.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.content.res.ColorStateList;
 import android.content.res.TypedArray;
@@ -37,7 +39,7 @@ public class GridItemThumbnail extends ImageView {
     public GridItemThumbnail(Context context, AttributeSet attrs, int defStyle) {
         super(context, attrs, defStyle);
         TypedArray ta = context.obtainStyledAttributes(R.styleable.GridItem);
-        ColorStateList color = ta.getColorStateList(R.styleable.GridItem_gridItemTint);
+        ColorStateList color = ta.getColorStateList(getRes(R.styleable.GridItem_gridItemTint));
         ta.recycle();
         setImageTintList(color);
     }
diff --git a/src/com/android/documentsui/HorizontalBreadcrumb.java b/src/com/android/documentsui/HorizontalBreadcrumb.java
index 9d2fc723e..0703fcbe5 100644
--- a/src/com/android/documentsui/HorizontalBreadcrumb.java
+++ b/src/com/android/documentsui/HorizontalBreadcrumb.java
@@ -17,6 +17,7 @@
 package com.android.documentsui;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Context;
 import android.util.AttributeSet;
@@ -82,10 +83,17 @@ public final class HorizontalBreadcrumb extends RecyclerView implements Breadcru
         // events.
         setAccessibilityDelegateCompat(
                 new AccessibilityEventRouter(this,
-                        (View child) -> onAccessibilityClick(child), null));
+                        (View child) -> onAccessibilityClick(child), null, state.action));
 
         setLayoutManager(mLayoutManager);
         addOnItemTouchListener(new ClickListener(getContext(), this::onSingleTapUp));
+
+        // When use_material3 flag is ON, the item is focusable but the whole row is not focusable.
+        if (isUseMaterial3FlagEnabled()) {
+            // Noe: setting this in the XML file via "android:focusable=false") somehow doesn't
+            // work, i.e. the breadcrumb bar is still focusable, hence forcing it here in the code.
+            setFocusable(false);
+        }
     }
 
     @Override
@@ -178,8 +186,9 @@ public final class HorizontalBreadcrumb extends RecyclerView implements Breadcru
 
         @Override
         public BreadcrumbHolder onCreateViewHolder(ViewGroup parent, int viewType) {
-            View v = LayoutInflater.from(parent.getContext())
-                    .inflate(R.layout.navigation_breadcrumb_item, null);
+            View v =
+                    LayoutInflater.from(parent.getContext())
+                            .inflate(getRes(R.layout.navigation_breadcrumb_item), null);
             return new BreadcrumbHolder(v);
         }
 
@@ -194,7 +203,7 @@ public final class HorizontalBreadcrumb extends RecyclerView implements Breadcru
                     isFirst ? mEnv.getCurrentRoot().title : mState.stack.get(position).displayName);
             if (isUseMaterial3FlagEnabled()) {
                 // The last path part in the breadcrumb is not clickable.
-                holder.mTitle.setEnabled(!isLast);
+                holder.itemView.setEnabled(!isLast);
             } else {
                 holder.mTitle.setEnabled(isLast);
             }
@@ -203,17 +212,20 @@ public final class HorizontalBreadcrumb extends RecyclerView implements Breadcru
                         (int)
                                 holder.itemView
                                         .getResources()
-                                        .getDimension(R.dimen.breadcrumb_item_padding_horizontal);
+                                        .getDimension(
+                                                getRes(R.dimen.breadcrumb_item_padding_horizontal));
                 final int paddingVertical =
                         (int)
                                 holder.itemView
                                         .getResources()
-                                        .getDimension(R.dimen.breadcrumb_item_padding_vertical);
+                                        .getDimension(
+                                                getRes(R.dimen.breadcrumb_item_padding_vertical));
                 final int arrowPadding =
                         (int)
                                 holder.itemView
                                         .getResources()
-                                        .getDimension(R.dimen.breadcrumb_item_arrow_padding);
+                                        .getDimension(
+                                                getRes(R.dimen.breadcrumb_item_arrow_padding));
                 holder.mTitle.setPadding(
                         paddingHorizontal, paddingVertical, paddingHorizontal, paddingVertical);
 
@@ -223,8 +235,11 @@ public final class HorizontalBreadcrumb extends RecyclerView implements Breadcru
                 params.setMarginEnd(arrowPadding);
                 holder.mArrow.setLayoutParams(params);
             } else {
-                final int padding = (int) holder.itemView.getResources()
-                        .getDimension(R.dimen.breadcrumb_item_padding);
+                final int padding =
+                        (int)
+                                holder.itemView
+                                        .getResources()
+                                        .getDimension(getRes(R.dimen.breadcrumb_item_padding));
                 holder.mTitle.setPadding(
                         isFirst ? padding * 3 : padding,
                         padding,
diff --git a/src/com/android/documentsui/IconUtils.java b/src/com/android/documentsui/IconUtils.java
index 477209150..58c0a2883 100644
--- a/src/com/android/documentsui/IconUtils.java
+++ b/src/com/android/documentsui/IconUtils.java
@@ -22,13 +22,9 @@ import android.content.Context;
 import android.content.pm.PackageManager;
 import android.content.pm.ProviderInfo;
 import android.content.res.Resources;
-import android.graphics.Outline;
 import android.graphics.drawable.Drawable;
 import android.graphics.drawable.Icon;
 import android.util.TypedValue;
-import android.view.View;
-import android.view.ViewOutlineProvider;
-import android.widget.ImageView;
 
 import com.android.documentsui.base.UserId;
 import com.android.documentsui.util.ColorUtils;
@@ -42,7 +38,8 @@ public class IconUtils {
 
     static {
         if (isUseMaterial3FlagEnabled()) {
-            // Use Resources.getSystem().getIdentifier() here instead of R.drawable.ic_doc_folder
+            // Use Resources.getSystem().getIdentifier() here instead of
+            // getRes(R.drawable.ic_doc_folder)
             // because com.android.internal.R is not public.
             sCustomIconColorMap.put(
                     Resources.getSystem().getIdentifier("ic_doc_folder", "drawable", "android"),
@@ -131,32 +128,4 @@ public class IconUtils {
         context.getTheme().resolveAttribute(tintAttrId, outValue, true);
         return applyTintColor(context, drawableId, outValue.resourceId);
     }
-
-    /**
-     * When a ImageView loads a thumbnail from a bitmap, we usually uses a CardView to wrap it to
-     * apply CardView's corner radius to the ImageView. This causes the corner pixelation of the
-     * thumbnail especially when there's a border (stroke) around the CardView. This method creates
-     * a custom clip outline with the correct shape to fix this issue.
-     *
-     * @param imageView ImageView to apply clip outline.
-     * @param strokeWidth stroke width of the thumbnail.
-     * @param cornerRadius corner radius of the thumbnail.
-     */
-    public static void applyThumbnailClipOutline(
-            ImageView imageView, int strokeWidth, int cornerRadius) {
-        ViewOutlineProvider outlineProvider =
-                new ViewOutlineProvider() {
-                    @Override
-                    public void getOutline(View view, Outline outline) {
-                        outline.setRoundRect(
-                                strokeWidth,
-                                strokeWidth,
-                                view.getWidth() - strokeWidth,
-                                view.getHeight() - strokeWidth,
-                                cornerRadius);
-                    }
-                };
-        imageView.setOutlineProvider(outlineProvider);
-        imageView.setClipToOutline(true);
-    }
 }
diff --git a/src/com/android/documentsui/Injector.java b/src/com/android/documentsui/Injector.java
index 6b68ba1f1..aa419165a 100644
--- a/src/com/android/documentsui/Injector.java
+++ b/src/com/android/documentsui/Injector.java
@@ -64,8 +64,11 @@ public class Injector<T extends ActionHandler> {
 
     public final DebugHelper debugHelper;
 
-    @ContentScoped
-    public ActionModeController actionModeController;
+    // Returns null when the `use_material3` flag is enabled.
+    @ContentScoped public @Nullable ActionModeController actionModeController;
+
+    // Returns null when the `use_material3` flag is disabled.
+    @ContentScoped public @Nullable SelectionBarController selectionBarController;
 
     @ContentScoped
     public ProfileTabsController profileTabsController;
@@ -127,6 +130,19 @@ public class Injector<T extends ActionHandler> {
         selectionMgr.reset(selectionTracker);
     }
 
+    /**
+     * When the `DirectoryFragment` is instantiated it gets the latest `SelectionBarController` and
+     * updates the selection details at the same time. This avoids having to reinitialize a new one
+     * on every directory navigation
+     */
+    public final SelectionBarController getSelectionBarController(
+            SelectionDetails selectionDetails, EventHandler<MenuItem> menuItemClicker) {
+        if (!isUseMaterial3FlagEnabled()) {
+            return null;
+        }
+        return selectionBarController.updateSelection(selectionDetails, menuItemClicker);
+    }
+
     public final ActionModeController getActionModeController(
             SelectionDetails selectionDetails, EventHandler<MenuItem> menuItemClicker) {
         if (isUseMaterial3FlagEnabled()) {
diff --git a/src/com/android/documentsui/ItemDragListener.java b/src/com/android/documentsui/ItemDragListener.java
index 284fd55de..68c3c7304 100644
--- a/src/com/android/documentsui/ItemDragListener.java
+++ b/src/com/android/documentsui/ItemDragListener.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.ClipData;
 import android.graphics.drawable.Drawable;
 import android.util.Log;
@@ -95,7 +97,7 @@ public class ItemDragListener<H extends DragHost> implements OnDragListener {
         if (task == null) {
             return;
         }
-        v.setTag(R.id.drag_hovering_tag, task);
+        v.setTag(getRes(R.id.drag_hovering_tag), task);
         mHoverTimer.schedule(task, mSpringTimeout);
     }
 
@@ -108,7 +110,7 @@ public class ItemDragListener<H extends DragHost> implements OnDragListener {
 
     private void handleExitedEndedEvent(View v, DragEvent event) {
         mDragHost.setDropTargetHighlight(v, false);
-        TimerTask task = (TimerTask) v.getTag(R.id.drag_hovering_tag);
+        TimerTask task = (TimerTask) v.getTag(getRes(R.id.drag_hovering_tag));
         if (task != null) {
             task.cancel();
         }
diff --git a/src/com/android/documentsui/JobPanelController.kt b/src/com/android/documentsui/JobPanelController.kt
index a8ab8b0a4..8811dd6e1 100644
--- a/src/com/android/documentsui/JobPanelController.kt
+++ b/src/com/android/documentsui/JobPanelController.kt
@@ -19,61 +19,308 @@ import android.content.BroadcastReceiver
 import android.content.Context
 import android.content.Intent
 import android.content.IntentFilter
-import android.util.Log
+import android.graphics.Rect
+import android.text.format.Formatter
+import android.view.Gravity
 import android.view.LayoutInflater
 import android.view.MenuItem
+import android.view.View
 import android.view.ViewGroup
+import android.widget.Button
+import android.widget.ImageView
 import android.widget.PopupWindow
 import android.widget.ProgressBar
+import android.widget.TextView
+import androidx.core.view.isGone
+import androidx.core.view.isVisible
+import androidx.lifecycle.DefaultLifecycleObserver
+import androidx.lifecycle.LifecycleOwner
+import androidx.recyclerview.widget.DiffUtil
+import androidx.recyclerview.widget.LinearLayoutManager
+import androidx.recyclerview.widget.ListAdapter
+import androidx.recyclerview.widget.RecyclerView
+import com.android.documentsui.JobPanelViewModel.MenuIconState
+import com.android.documentsui.JobPanelViewModel.ProgressViewModel
 import com.android.documentsui.base.Menus
 import com.android.documentsui.services.FileOperationService
-import com.android.documentsui.services.FileOperationService.EXTRA_PROGRESS
+import com.android.documentsui.services.FileOperations
 import com.android.documentsui.services.Job
 import com.android.documentsui.services.JobProgress
+import com.android.documentsui.util.FormatUtils
+import com.android.documentsui.util.Material3Config.Companion.getRes
+import com.google.android.material.button.MaterialButton
+import com.google.android.material.card.MaterialCardView
+import com.google.android.material.progressindicator.LinearProgressIndicator
+import com.google.android.material.shape.ShapeAppearanceModel
+
+/**
+ * Adds a gap between items in a vertical Recycler View.
+ */
+private class VerticalMarginItemDecoration(
+    private val marginSize: Int
+) : RecyclerView.ItemDecoration() {
+    override fun getItemOffsets(
+        outRect: Rect,
+        view: View,
+        parent: RecyclerView,
+        state: RecyclerView.State
+    ) {
+        if (parent.getChildAdapterPosition(view) > 0) {
+            outRect.top = marginSize
+        }
+    }
+}
 
 /**
  * JobPanelController is responsible for receiving broadcast updates from the [FileOperationService]
  * and updating a given menu item to reflect the current progress.
+ *
+ * @param activityContext Context used to receive broadcasts and access resources for UI.
+ * @param viewModel View model containing the state of the job panel.
  */
-class JobPanelController(private val mContext: Context) : BroadcastReceiver() {
+class JobPanelController(
+    private val activityContext: Context,
+    private val actions: ActionHandler,
+    private val viewModel: JobPanelViewModel,
+) : BroadcastReceiver(),
+    DefaultLifecycleObserver {
     companion object {
         private const val TAG = "JobPanelController"
         private const val MAX_PROGRESS = 100
     }
 
-    private enum class State {
-        INVISIBLE, INDETERMINATE, VISIBLE
+    private class ProgressItemHolder(
+        private val controller: JobPanelController,
+        private val cardView: View,
+    ) : RecyclerView.ViewHolder(cardView) {
+
+        private val context = cardView.context
+
+        // Header elements.
+        private val titleView = cardView.findViewById<TextView>(
+            getRes(R.id.job_progress_item_title)
+        )
+        private val toggleExpandButton =
+            cardView.findViewById<MaterialButton>(getRes(R.id.job_progress_item_expand))
+
+        // Body elements.
+        private val progressView =
+            cardView.findViewById<LinearProgressIndicator>(getRes(R.id.job_progress_item_progress))
+        private val primaryStatusView =
+            cardView.findViewById<TextView>(getRes(R.id.job_progress_item_primary_status))
+        private val statusSeparator =
+            cardView.findViewById<TextView>(getRes(R.id.job_progress_item_status_separator))
+        private val secondaryStatusView =
+            cardView.findViewById<TextView>(getRes(R.id.job_progress_item_secondary_status))
+
+        // Buttons
+        private val cancelButton = cardView.findViewById<Button>(
+            getRes(R.id.job_progress_item_cancel)
+        )
+        private val showInFolderButton =
+            cardView.findViewById<Button>(getRes(R.id.job_progress_item_show_in_folder))
+        private val dismissButton = cardView.findViewById<Button>(
+            getRes(R.id.job_progress_item_dismiss)
+        )
+
+        fun setJobProgress(jobProgress: JobProgress, expanded: Boolean) {
+            titleView.text = jobProgress.msg
+            if (expanded) {
+                titleView.isSingleLine = false
+                toggleExpandButton.icon =
+                    context.getDrawable(getRes(R.drawable.ic_job_progress_collapse))
+            } else {
+                titleView.isSingleLine = true
+                toggleExpandButton.icon =
+                    context.getDrawable(getRes(R.drawable.ic_job_progress_expand))
+            }
+
+            updateProgressBar(jobProgress)
+            setStatusText(jobProgress, expanded)
+
+            cardView.setOnClickListener { controller.toggleExpanded(jobProgress.id) }
+            toggleExpandButton.setOnClickListener { controller.toggleExpanded(jobProgress.id) }
+
+            cancelButton.isVisible = expanded && !jobProgress.isFinal
+            if (cancelButton.isVisible) {
+                cancelButton.setOnClickListener { FileOperations.cancel(context, jobProgress.id) }
+            }
+
+            dismissButton.isVisible = expanded && jobProgress.isFinal
+            if (dismissButton.isVisible) {
+                dismissButton.setOnClickListener { controller.dismissProgress(jobProgress.id) }
+            }
+
+            if (expanded && jobProgress.isFinal && jobProgress.destination != null) {
+                showInFolderButton.isVisible = true
+                showInFolderButton.setOnClickListener {
+                    controller.showInFolder(jobProgress)
+                }
+            } else {
+                showInFolderButton.isVisible = false
+            }
+        }
+
+        private fun updateProgressBar(jobProgress: JobProgress) {
+            progressView.let {
+                it.isGone = jobProgress.isFinal
+                it.isIndeterminate = jobProgress.isIndeterminate
+                if (!it.isIndeterminate) {
+                    it.progress = jobProgress.toPercent().toInt()
+                }
+            }
+        }
+
+        private fun setStatusText(jobProgress: JobProgress, expanded: Boolean) {
+            primaryStatusView.isGone = false
+            secondaryStatusView.isGone = false
+            if (jobProgress.state == Job.STATE_COMPLETED) {
+                if (jobProgress.hasFailures) {
+                    primaryStatusView.setTextAppearance(
+                        getRes(R.style.JobProgressItemStatusText_Failure)
+                    )
+                    primaryStatusView.text = context.getString(
+                        getRes(R.string.job_progress_item_failed)
+                    )
+                    secondaryStatusView.isGone = expanded
+                    secondaryStatusView.text =
+                        context.getString(getRes(R.string.job_progress_item_see_details))
+                } else {
+                    primaryStatusView.setTextAppearance(
+                        getRes(R.style.JobProgressItemStatusText_Success)
+                    )
+                    primaryStatusView.text =
+                        context.getString(getRes(R.string.job_progress_item_completed))
+                    secondaryStatusView.text = getCompletionStatusString(jobProgress.operationType)
+                }
+            } else if (expanded && jobProgress.state == Job.STATE_SET_UP &&
+                !jobProgress.isIndeterminate) {
+                primaryStatusView.setTextAppearance(getRes(R.style.JobProgressItemStatusText))
+                primaryStatusView.text = context.getString(
+                    getRes(R.string.job_progress_item_byte_progress),
+                    Formatter.formatFileSize(context, jobProgress.currentBytes),
+                    Formatter.formatFileSize(context, jobProgress.requiredBytes),
+                )
+                secondaryStatusView.text = context.getString(getRes(R.string.copy_remaining),
+                    FormatUtils.formatDuration(jobProgress.msRemaining))
+            } else {
+                primaryStatusView.isGone = true
+                secondaryStatusView.isGone = true
+            }
+            statusSeparator.isGone = primaryStatusView.isGone || secondaryStatusView.isGone
+        }
+
+        private fun getCompletionStatusString(@FileOperationService.OpType opType: Int): String {
+            return when (opType) {
+                FileOperationService.OPERATION_COPY -> context.getString(
+                    getRes(R.string.copy_completed)
+                )
+
+                FileOperationService.OPERATION_MOVE -> context.getString(
+                    getRes(R.string.move_completed)
+                )
+                FileOperationService.OPERATION_DELETE ->
+                    context.getString(getRes(R.string.delete_completed))
+                FileOperationService.OPERATION_COMPRESS ->
+                    context.getString(getRes(R.string.compress_completed))
+                FileOperationService.OPERATION_EXTRACT ->
+                    context.getString(getRes(R.string.extract_completed))
+                else -> ""
+            }
+        }
     }
 
-    /** The current state of the menu progress item. */
-    private var mState = State.INVISIBLE
+    private class ProgressListAdapter(private val controller: JobPanelController) :
+        ListAdapter<ProgressViewModel, ProgressItemHolder>(JobDiffCallback) {
 
-    /** The total progress from 0 to MAX_PROGRESS. */
-    private var mTotalProgress = 0
+        companion object {
+            // Constants for the different view types created by this adapter. The type depends on
+            // the position of the item in the list.
+            private const val VIEW_MIDDLE = 0
+            private const val VIEW_TOP = 1
+            private const val VIEW_BOTTOM = 2
+            private const val VIEW_TOP_BOTTOM = 3
+        }
 
-    /** List of jobs currently tracked by this class. */
-    private val mCurrentJobs = LinkedHashMap<String, JobProgress>()
+        override fun getItemViewType(position: Int): Int {
+            if (itemCount == 1) return VIEW_TOP_BOTTOM
+            if (position == 0) return VIEW_TOP
+            if (position == itemCount - 1) return VIEW_BOTTOM
+            return VIEW_MIDDLE
+        }
+
+        override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ProgressItemHolder {
+            val context = parent.context
+            val view = LayoutInflater.from(context)
+                .inflate(getRes(R.layout.job_progress_item), parent, false) as MaterialCardView
+            if (viewType != 0) {
+                val outerRadius =
+                    context.resources.getDimension(getRes(R.dimen.job_progress_list_corner_radius))
+                view.shapeAppearanceModel = ShapeAppearanceModel
+                    .builder(context, getRes(R.style.JobProgressItemCardBaseShape), 0)
+                    .apply {
+                        if (viewType == VIEW_TOP_BOTTOM || viewType == VIEW_TOP) {
+                            setTopLeftCornerSize(outerRadius)
+                            setTopRightCornerSize(outerRadius)
+                        }
+                        if (viewType == VIEW_TOP_BOTTOM || viewType == VIEW_BOTTOM) {
+                            setBottomLeftCornerSize(outerRadius)
+                            setBottomRightCornerSize(outerRadius)
+                        }
+                    }.build()
+            }
+            return ProgressItemHolder(controller, view)
+        }
+
+        override fun onBindViewHolder(holder: ProgressItemHolder, position: Int) {
+            val (jobProgress, expanded) = getItem(position)
+            holder.setJobProgress(jobProgress, expanded)
+        }
+
+        object JobDiffCallback : DiffUtil.ItemCallback<ProgressViewModel>() {
+            override fun areItemsTheSame(oldModel: ProgressViewModel, newModel: ProgressViewModel) =
+                oldModel.jobProgress.id == newModel.jobProgress.id
+
+            override fun areContentsTheSame(
+                oldModel: ProgressViewModel,
+                newModel: ProgressViewModel
+            ) = oldModel == newModel
+        }
+    }
 
     /** Current menu item being controlled by this class. */
-    private var mMenuItem: MenuItem? = null
+    private var menuItem: MenuItem? = null
+
+    /** Current panel popup shown if any. */
+    private var popup: PopupWindow? = null
+
+    /** Adapter used to display JobProgresses in the recycler list. */
+    private var progressListAdapter: ProgressListAdapter? = null
 
     init {
         val filter = IntentFilter(FileOperationService.ACTION_PROGRESS)
-        mContext.registerReceiver(this, filter, Context.RECEIVER_NOT_EXPORTED)
+        activityContext.registerReceiver(this, filter, Context.RECEIVER_NOT_EXPORTED)
     }
 
-    private fun updateMenuItem(animate: Boolean) {
-        mMenuItem?.let {
-            Menus.setEnabledAndVisible(it, mState != State.INVISIBLE)
-            val icon = it.actionView as ProgressBar
-            when (mState) {
-                State.INDETERMINATE -> icon.isIndeterminate = true
-                State.VISIBLE -> icon.apply {
+    private fun updateMenuItem(menuIconState: MenuIconState, animate: Boolean) {
+        if (menuIconState is MenuIconState.INVISIBLE) {
+            popup?.dismiss()
+        }
+
+        menuItem?.let {
+            Menus.setEnabledAndVisible(it, menuIconState !is MenuIconState.INVISIBLE)
+            val icon = it.actionView!!
+                .findViewById<ProgressBar>(R.id.job_progress_toolbar_indicator)
+            when (menuIconState) {
+                is MenuIconState.INDETERMINATE -> icon.isIndeterminate = true
+                is MenuIconState.VISIBLE -> icon.apply {
                     isIndeterminate = false
-                    setProgress(mTotalProgress, animate)
+                    setProgress(menuIconState.totalProgress, animate)
                 }
-                State.INVISIBLE -> {}
+                is MenuIconState.INVISIBLE -> {}
             }
+            val badge = it.actionView!!.findViewById<ImageView>(R.id.job_progress_toolbar_badge)
+            badge.isVisible = menuIconState.hasFailures
         }
     }
 
@@ -81,70 +328,95 @@ class JobPanelController(private val mContext: Context) : BroadcastReceiver() {
      * Sets the menu item controlled by this class. The item's actionView must be a [ProgressBar].
      */
     @Suppress("ktlint:standard:comment-wrapping")
-    fun setMenuItem(menuItem: MenuItem) {
-        val progressIcon = menuItem.actionView as ProgressBar
+    fun setMenuItem(newMenuItem: MenuItem) {
+        val progressIcon = newMenuItem.actionView!!
+            .findViewById<ProgressBar>(R.id.job_progress_toolbar_indicator)
         progressIcon.max = MAX_PROGRESS
         progressIcon.setOnClickListener { view ->
-            val panel = LayoutInflater.from(mContext).inflate(
-                R.layout.job_progress_panel,
+            val panel = LayoutInflater.from(activityContext).inflate(
+                getRes(R.layout.job_progress_panel),
                 /* root= */ null
             )
-            val popupWidth = mContext.resources.getDimension(R.dimen.job_progress_panel_width) +
-                    mContext.resources.getDimension(R.dimen.job_progress_panel_margin)
-            val popup = PopupWindow(
+            val listAdapter = ProgressListAdapter(this)
+            listAdapter.submitList(ArrayList(viewModel.currentJobs.values))
+            panel.findViewById<RecyclerView>(getRes(R.id.job_progress_list)).apply {
+                layoutManager = LinearLayoutManager(context)
+                addItemDecoration(VerticalMarginItemDecoration(
+                    context.resources.getDimensionPixelSize(getRes(R.dimen.job_progress_list_gap))
+                ))
+                itemAnimator = null
+                adapter = listAdapter
+                if (viewModel.listState != null) {
+                    layoutManager?.onRestoreInstanceState(viewModel.listState)
+                    viewModel.listState = null
+                }
+            }
+            progressListAdapter = listAdapter
+            val popupWidth =
+                activityContext.resources.getDimension(
+                    getRes(R.dimen.job_progress_panel_width)
+                ) + activityContext.resources.getDimension(
+                    getRes(R.dimen.job_progress_panel_margin)
+                )
+            popup = PopupWindow(
                 /* contentView= */ panel,
                 /* width= */ popupWidth.toInt(),
                 /* height= */ ViewGroup.LayoutParams.WRAP_CONTENT,
                 /* focusable= */ true
-            )
-            popup.showAsDropDown(
-                /* anchor= */ view,
-                /* xoff= */ view.width - popupWidth.toInt(),
-                /* yoff= */ 0
-            )
+            ).apply {
+                setOnDismissListener {
+                    progressListAdapter = null
+                    popup = null
+                }
+                showAsDropDown(
+                    /* anchor= */ view,
+                    /* xoff= */ 0,
+                    /* yoff= */ 0,
+                    /* gravity= */ Gravity.TOP or Gravity.END,
+                )
+            }
         }
-        mMenuItem = menuItem
-        updateMenuItem(animate = false)
+        // Restore the popup if we had saved state.
+        if (viewModel.listState != null) {
+            progressIcon.callOnClick()
+        }
+        menuItem = newMenuItem
+        // Don't animate for the initial state update.
+        updateMenuItem(viewModel.getMenuState(), animate = false)
+    }
+
+    override fun onDestroy(owner: LifecycleOwner) {
+        // We need to save the popup's UI state and manually dismiss the popup, as it somehow
+        // stays alive even if the activity is destroyed due to a configuration change.
+        viewModel.listState = popup?.contentView
+            ?.findViewById<RecyclerView>(R.id.job_progress_list)?.layoutManager
+            ?.onSaveInstanceState()
+        popup?.dismiss()
     }
 
     override fun onReceive(context: Context?, intent: Intent) {
-        val progresses = intent.getParcelableArrayListExtra<JobProgress>(
-            EXTRA_PROGRESS,
+        val progresses = intent.getParcelableArrayListExtra(
+            FileOperationService.EXTRA_PROGRESS,
             JobProgress::class.java
         )
-        updateProgress(progresses!!)
+        viewModel.updateProgress(progresses!!)
+        updateMenuItem(viewModel.getMenuState(), animate = true)
+        progressListAdapter?.submitList(ArrayList(viewModel.currentJobs.values))
     }
 
-    private fun updateProgress(progresses: List<JobProgress>) {
-        var requiredBytes = 0L
-        var currentBytes = 0L
-        var allFinished = true
+    private fun dismissProgress(id: String) {
+        viewModel.dismissProgress(id)
+        updateMenuItem(viewModel.getMenuState(), animate = true)
+        progressListAdapter?.submitList(ArrayList(viewModel.currentJobs.values))
+    }
 
-        for (jobProgress in progresses) {
-            Log.d(TAG, "Received $jobProgress")
-            mCurrentJobs.put(jobProgress.id, jobProgress)
-        }
-        for (jobProgress in mCurrentJobs.values) {
-            if (jobProgress.state != Job.STATE_COMPLETED) {
-                allFinished = false
-            }
-            if (jobProgress.requiredBytes != -1L && jobProgress.currentBytes != -1L) {
-                requiredBytes += jobProgress.requiredBytes
-                currentBytes += jobProgress.currentBytes
-            }
-        }
+    private fun toggleExpanded(id: String) {
+        viewModel.toggleExpanded(id)
+        progressListAdapter?.submitList(ArrayList(viewModel.currentJobs.values))
+    }
 
-        if (mCurrentJobs.isEmpty()) {
-            mState = State.INVISIBLE
-        } else if (requiredBytes != 0L) {
-            mState = State.VISIBLE
-            mTotalProgress = (MAX_PROGRESS * currentBytes / requiredBytes).toInt()
-        } else if (allFinished) {
-            mState = State.VISIBLE
-            mTotalProgress = MAX_PROGRESS
-        } else {
-            mState = State.INDETERMINATE
-        }
-        updateMenuItem(animate = true)
+    private fun showInFolder(jobProgress: JobProgress) {
+        actions.jumpToDirectory(jobProgress.destination)
+        popup?.dismiss()
     }
 }
diff --git a/src/com/android/documentsui/JobPanelViewModel.kt b/src/com/android/documentsui/JobPanelViewModel.kt
new file mode 100644
index 000000000..0098c6b7e
--- /dev/null
+++ b/src/com/android/documentsui/JobPanelViewModel.kt
@@ -0,0 +1,124 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui
+
+import android.os.Parcelable
+import android.util.Log
+import androidx.lifecycle.ViewModel
+import com.android.documentsui.base.SharedMinimal.DEBUG
+import com.android.documentsui.services.Job
+import com.android.documentsui.services.JobProgress
+
+/**
+ * Manages the UI state for the [JobPanelController].
+ */
+class JobPanelViewModel : ViewModel() {
+    companion object {
+        private const val TAG = "JobPanelViewModel"
+    }
+
+    /**
+     * The UI state representation of a single progress item.
+     *
+     * @property jobProgress The progress shown by this item.
+     * @property expanded Whether the UI card for this item is expanded or not.
+     */
+    data class ProgressViewModel(val jobProgress: JobProgress, val expanded: Boolean = false)
+
+    /**
+     * The UI state representation of the toolbar progress icon.
+     */
+    sealed class MenuIconState {
+        abstract val hasFailures: Boolean
+        data object INVISIBLE : MenuIconState() {
+            override val hasFailures get() = false
+        }
+        data class INDETERMINATE(override val hasFailures: Boolean) : MenuIconState()
+        data class VISIBLE(val totalProgress: Int, override val hasFailures: Boolean) :
+            MenuIconState()
+    }
+
+    /** List of jobs currently tracked. */
+    private val _currentJobs = LinkedHashMap<String, ProgressViewModel>()
+    val currentJobs: Map<String, ProgressViewModel> get() = _currentJobs
+    var listState: Parcelable? = null
+
+    /**
+     * Gets the state of the toolbar progress icon based off the current jobs tracked.
+     */
+    fun getMenuState(): MenuIconState {
+        var currentPercent = 0f
+        var allIndeterminate = true
+        var hasFailures = false
+
+        for ((jobProgress, _) in currentJobs.values) {
+            if (!jobProgress.isIndeterminate) {
+                allIndeterminate = false
+                currentPercent += jobProgress.toPercent()
+            }
+            if (jobProgress.hasFailures) {
+                hasFailures = true
+            }
+        }
+
+        var state: MenuIconState
+        if (currentJobs.isEmpty()) {
+            state = MenuIconState.INVISIBLE
+        } else if (allIndeterminate) {
+            state = MenuIconState.INDETERMINATE(hasFailures)
+        } else {
+            state = MenuIconState.VISIBLE((currentPercent / currentJobs.size).toInt(), hasFailures)
+        }
+        return state
+    }
+
+    /**
+     * Updates the list of progresses managed by this class. This function will add and update all
+     * given items, while removing any queued/in progress items not in [progresses]. Completed items
+     * are kept.
+     */
+    fun updateProgress(progresses: List<JobProgress>) {
+        val seen = hashSetOf<String>()
+        for (jobProgress in progresses) {
+            if (DEBUG) Log.d(TAG, "Received $jobProgress")
+            seen.add(jobProgress.id)
+            if (jobProgress.state == Job.STATE_CANCELED) {
+                _currentJobs.remove(jobProgress.id)
+            } else {
+                _currentJobs.merge(jobProgress.id, ProgressViewModel(jobProgress)) { old, new ->
+                    ProgressViewModel(new.jobProgress, old.expanded)
+                }
+            }
+        }
+        _currentJobs.entries.removeAll { (id, model) -> !model.jobProgress.isFinal && id !in seen }
+    }
+
+    /**
+     * Removes a specific progress item from the list managed by this class.
+     */
+    fun dismissProgress(id: String) {
+        _currentJobs.remove(id)
+    }
+
+    /**
+     * Toggles the expanded state of a specific progress item.
+     */
+    fun toggleExpanded(id: String) {
+        _currentJobs.computeIfPresent(id) { _, (jobProgress, expanded) ->
+            ProgressViewModel(jobProgress, !expanded)
+        }
+    }
+}
diff --git a/src/com/android/documentsui/MenuManager.java b/src/com/android/documentsui/MenuManager.java
index a46659c77..b34118cfd 100644
--- a/src/com/android/documentsui/MenuManager.java
+++ b/src/com/android/documentsui/MenuManager.java
@@ -18,6 +18,7 @@ package com.android.documentsui;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.view.KeyboardShortcutGroup;
 import android.view.Menu;
@@ -65,20 +66,20 @@ public abstract class MenuManager {
 
     /** @see ActionModeController */
     public void updateActionMenu(Menu menu, SelectionDetails selection) {
-        updateOpenWith(menu.findItem(R.id.action_menu_open_with), selection);
-        updateDelete(menu.findItem(R.id.action_menu_delete), selection);
-        updateShare(menu.findItem(R.id.action_menu_share), selection);
-        updateRename(menu.findItem(R.id.action_menu_rename), selection);
-        updateSelect(menu.findItem(R.id.action_menu_select), selection);
-        updateSelectAll(menu.findItem(R.id.action_menu_select_all), selection);
-        updateDeselectAll(menu.findItem(R.id.action_menu_deselect_all), selection);
-        updateMoveTo(menu.findItem(R.id.action_menu_move_to), selection);
-        updateCopyTo(menu.findItem(R.id.action_menu_copy_to), selection);
-        updateCompress(menu.findItem(R.id.action_menu_compress), selection);
-        updateExtractTo(menu.findItem(R.id.action_menu_extract_to), selection);
-        updateInspect(menu.findItem(R.id.action_menu_inspect), selection);
-        updateViewInOwner(menu.findItem(R.id.action_menu_view_in_owner), selection);
-        updateSort(menu.findItem(R.id.action_menu_sort));
+        updateOpenWith(menu.findItem(getRes(R.id.action_menu_open_with)), selection);
+        updateDelete(menu.findItem(getRes(R.id.action_menu_delete)), selection);
+        updateShare(menu.findItem(getRes(R.id.action_menu_share)), selection);
+        updateRename(menu.findItem(getRes(R.id.action_menu_rename)), selection);
+        updateSelect(menu.findItem(getRes(R.id.action_menu_select)), selection);
+        updateSelectAll(menu.findItem(getRes(R.id.action_menu_select_all)), selection);
+        updateDeselectAll(menu.findItem(getRes(R.id.action_menu_deselect_all)), selection);
+        updateMoveTo(menu.findItem(getRes(R.id.action_menu_move_to)), selection);
+        updateCopyTo(menu.findItem(getRes(R.id.action_menu_copy_to)), selection);
+        updateCompress(menu.findItem(getRes(R.id.action_menu_compress)), selection);
+        updateExtractTo(menu.findItem(getRes(R.id.action_menu_extract_to)), selection);
+        updateInspect(menu.findItem(getRes(R.id.action_menu_inspect)), selection);
+        updateViewInOwner(menu.findItem(getRes(R.id.action_menu_view_in_owner)), selection);
+        updateSort(menu.findItem(getRes(R.id.action_menu_sort)));
 
         Menus.disableHiddenItems(menu);
     }
@@ -93,22 +94,23 @@ public abstract class MenuManager {
         if (mOptionMenu == null) {
             return;
         }
-        updateCreateDir(mOptionMenu.findItem(R.id.option_menu_create_dir));
+        updateCreateDir(mOptionMenu.findItem(getRes(R.id.option_menu_create_dir)));
         if (isZipNgFlagEnabled()) {
-            updateExtractAll(mOptionMenu.findItem(R.id.option_menu_extract_all));
+            updateExtractAll(mOptionMenu.findItem(getRes(R.id.option_menu_extract_all)));
         }
-        updateSettings(mOptionMenu.findItem(R.id.option_menu_settings));
-        updateSelectAll(mOptionMenu.findItem(R.id.option_menu_select_all));
-        updateNewWindow(mOptionMenu.findItem(R.id.option_menu_new_window));
-        updateDebug(mOptionMenu.findItem(R.id.option_menu_debug));
-        updateInspect(mOptionMenu.findItem(R.id.option_menu_inspect));
-        updateSort(mOptionMenu.findItem(R.id.option_menu_sort));
-        updateLauncher(mOptionMenu.findItem(R.id.option_menu_launcher));
-        updateShowHiddenFiles(mOptionMenu.findItem(R.id.option_menu_show_hidden_files));
+        updateSettings(mOptionMenu.findItem(getRes(R.id.option_menu_settings)));
+        updateSelectAll(mOptionMenu.findItem(getRes(R.id.option_menu_select_all)));
+        updateNewWindow(mOptionMenu.findItem(getRes(R.id.option_menu_new_window)));
+        updateDebug(mOptionMenu.findItem(getRes(R.id.option_menu_debug)));
+        updateInspect(mOptionMenu.findItem(getRes(R.id.option_menu_inspect)));
+        updateSort(mOptionMenu.findItem(getRes(R.id.option_menu_sort)));
+        updateLauncher(mOptionMenu.findItem(getRes(R.id.option_menu_launcher)));
+        updateShowHiddenFiles(mOptionMenu.findItem(getRes(R.id.option_menu_show_hidden_files)));
 
         if (isUseMaterial3FlagEnabled()) {
-            updateModePicker(mOptionMenu.findItem(R.id.sub_menu_grid),
-                    mOptionMenu.findItem(R.id.sub_menu_list));
+            updateModePicker(
+                    mOptionMenu.findItem(getRes(R.id.sub_menu_grid)),
+                    mOptionMenu.findItem(getRes(R.id.sub_menu_list)));
         }
 
         Menus.disableHiddenItems(mOptionMenu);
@@ -123,8 +125,9 @@ public abstract class MenuManager {
                 return;
             }
         }
-        updateModePicker(menu.findItem(R.id.sub_menu_grid), menu.findItem(R.id.sub_menu_list));
-
+        updateModePicker(
+                menu.findItem(getRes(R.id.sub_menu_grid)),
+                menu.findItem(getRes(R.id.sub_menu_list)));
     }
 
     public void updateModel(Model model) {}
@@ -172,11 +175,11 @@ public abstract class MenuManager {
     public void updateContextMenuForFiles(Menu menu, SelectionDetails selectionDetails) {
         assert selectionDetails != null;
 
-        MenuItem share = menu.findItem(R.id.dir_menu_share);
-        MenuItem open = menu.findItem(R.id.dir_menu_open);
-        MenuItem openWith = menu.findItem(R.id.dir_menu_open_with);
-        MenuItem rename = menu.findItem(R.id.dir_menu_rename);
-        MenuItem viewInOwner = menu.findItem(R.id.dir_menu_view_in_owner);
+        MenuItem share = menu.findItem(getRes(R.id.dir_menu_share));
+        MenuItem open = menu.findItem(getRes(R.id.dir_menu_open));
+        MenuItem openWith = menu.findItem(getRes(R.id.dir_menu_open_with));
+        MenuItem rename = menu.findItem(getRes(R.id.dir_menu_rename));
+        MenuItem viewInOwner = menu.findItem(getRes(R.id.dir_menu_view_in_owner));
 
         updateShare(share, selectionDetails);
         updateOpenInContextMenu(open, selectionDetails);
@@ -185,8 +188,8 @@ public abstract class MenuManager {
         updateViewInOwner(viewInOwner, selectionDetails);
 
         if (isZipNgFlagEnabled()) {
-            updateExtractHere(menu.findItem(R.id.dir_menu_extract_here), selectionDetails);
-            updateBrowse(menu.findItem(R.id.dir_menu_browse), selectionDetails);
+            updateExtractHere(menu.findItem(getRes(R.id.dir_menu_extract_here)), selectionDetails);
+            updateBrowse(menu.findItem(getRes(R.id.dir_menu_browse)), selectionDetails);
         }
 
         updateContextMenu(menu, selectionDetails);
@@ -206,9 +209,9 @@ public abstract class MenuManager {
     public void updateContextMenuForDirs(Menu menu, SelectionDetails selectionDetails) {
         assert selectionDetails != null;
 
-        MenuItem openInNewWindow = menu.findItem(R.id.dir_menu_open_in_new_window);
-        MenuItem rename = menu.findItem(R.id.dir_menu_rename);
-        MenuItem pasteInto = menu.findItem(R.id.dir_menu_paste_into_folder);
+        MenuItem openInNewWindow = menu.findItem(getRes(R.id.dir_menu_open_in_new_window));
+        MenuItem rename = menu.findItem(getRes(R.id.dir_menu_rename));
+        MenuItem pasteInto = menu.findItem(getRes(R.id.dir_menu_paste_into_folder));
 
         updateOpenInNewWindow(openInNewWindow, selectionDetails);
         updateRename(rename, selectionDetails);
@@ -226,10 +229,10 @@ public abstract class MenuManager {
     public void updateContextMenu(Menu menu, SelectionDetails selectionDetails) {
         assert selectionDetails != null;
 
-        MenuItem cut = menu.findItem(R.id.dir_menu_cut_to_clipboard);
-        MenuItem copy = menu.findItem(R.id.dir_menu_copy_to_clipboard);
-        MenuItem delete = menu.findItem(R.id.dir_menu_delete);
-        MenuItem inspect = menu.findItem(R.id.dir_menu_inspect);
+        MenuItem cut = menu.findItem(getRes(R.id.dir_menu_cut_to_clipboard));
+        MenuItem copy = menu.findItem(getRes(R.id.dir_menu_copy_to_clipboard));
+        MenuItem delete = menu.findItem(getRes(R.id.dir_menu_delete));
+        MenuItem inspect = menu.findItem(getRes(R.id.dir_menu_inspect));
 
         final boolean canCopy =
                 selectionDetails.size() > 0 && !selectionDetails.containsPartialFiles();
@@ -240,7 +243,7 @@ public abstract class MenuManager {
 
         Menus.setEnabledAndVisible(inspect, selectionDetails.size() == 1);
 
-        updateCompress(menu.findItem(R.id.dir_menu_compress), selectionDetails);
+        updateCompress(menu.findItem(getRes(R.id.dir_menu_compress)), selectionDetails);
     }
 
     /**
@@ -250,11 +253,11 @@ public abstract class MenuManager {
      */
     @VisibleForTesting
     public void updateContextMenuForContainer(Menu menu, SelectionDetails selectionDetails) {
-        MenuItem paste = menu.findItem(R.id.dir_menu_paste_from_clipboard);
-        MenuItem selectAll = menu.findItem(R.id.dir_menu_select_all);
-        MenuItem deselectAll = menu.findItem(R.id.dir_menu_deselect_all);
-        MenuItem createDir = menu.findItem(R.id.dir_menu_create_dir);
-        MenuItem inspect = menu.findItem(R.id.dir_menu_inspect);
+        MenuItem paste = menu.findItem(getRes(R.id.dir_menu_paste_from_clipboard));
+        MenuItem selectAll = menu.findItem(getRes(R.id.dir_menu_select_all));
+        MenuItem deselectAll = menu.findItem(getRes(R.id.dir_menu_deselect_all));
+        MenuItem createDir = menu.findItem(getRes(R.id.dir_menu_create_dir));
+        MenuItem inspect = menu.findItem(getRes(R.id.dir_menu_inspect));
 
         Menus.setEnabledAndVisible(paste,
                 mDirDetails.hasItemsToPaste() && mDirDetails.canCreateDoc());
@@ -268,10 +271,10 @@ public abstract class MenuManager {
      * @see RootsFragment#onCreateContextMenu
      */
     public void updateRootContextMenu(Menu menu, RootInfo root, DocumentInfo docInfo) {
-        MenuItem eject = menu.findItem(R.id.root_menu_eject_root);
-        MenuItem pasteInto = menu.findItem(R.id.root_menu_paste_into_folder);
-        MenuItem openInNewWindow = menu.findItem(R.id.root_menu_open_in_new_window);
-        MenuItem settings = menu.findItem(R.id.root_menu_settings);
+        MenuItem eject = menu.findItem(getRes(R.id.root_menu_eject_root));
+        MenuItem pasteInto = menu.findItem(getRes(R.id.root_menu_paste_into_folder));
+        MenuItem openInNewWindow = menu.findItem(getRes(R.id.root_menu_open_in_new_window));
+        MenuItem settings = menu.findItem(getRes(R.id.root_menu_settings));
 
         updateEject(eject, root);
         updatePasteInto(pasteInto, root, docInfo);
@@ -304,9 +307,10 @@ public abstract class MenuManager {
 
     protected void updateShowHiddenFiles(MenuItem showHidden) {
         Menus.setEnabledAndVisible(showHidden, true);
-        showHidden.setTitle(mState.showHiddenFiles
-                ? R.string.menu_hide_hidden_files
-                : R.string.menu_show_hidden_files);
+        showHidden.setTitle(
+                mState.showHiddenFiles
+                        ? getRes(R.string.menu_hide_hidden_files)
+                        : getRes(R.string.menu_show_hidden_files));
     }
 
     protected void updateSort(MenuItem sort) {
diff --git a/src/com/android/documentsui/Metrics.java b/src/com/android/documentsui/Metrics.java
index 9d20fce1e..a65f9b8b2 100644
--- a/src/com/android/documentsui/Metrics.java
+++ b/src/com/android/documentsui/Metrics.java
@@ -19,6 +19,7 @@ package com.android.documentsui;
 import static android.content.ContentResolver.wrap;
 
 import static com.android.documentsui.DocumentsApplication.acquireUnstableProviderOrThrow;
+import static com.android.documentsui.base.SharedMinimal.redact;
 
 import android.content.ContentProviderClient;
 import android.content.Context;
@@ -640,7 +641,7 @@ public final class Metrics {
         try {
             return DocumentsContract.getRootId(uri);
         } catch (IllegalArgumentException iae) {
-            Log.w(TAG, "Invalid root Uri " + uri.toSafeString());
+            Log.w(TAG, "Invalid root Uri " + redact(uri));
         }
         return null;
     }
diff --git a/src/com/android/documentsui/Model.java b/src/com/android/documentsui/Model.java
index fdcebae3c..9820d4790 100644
--- a/src/com/android/documentsui/Model.java
+++ b/src/com/android/documentsui/Model.java
@@ -18,6 +18,7 @@ package com.android.documentsui;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.base.SharedMinimal.VERBOSE;
+import static com.android.documentsui.util.FlagUtils.isSearchV2Enabled;
 
 import android.app.AuthenticationRequiredException;
 import android.database.Cursor;
@@ -140,7 +141,11 @@ public class Model {
         }
 
         final Bundle extras = mCursor.getExtras();
-        if (extras != null) {
+        if (extras == null) {
+            if (isSearchV2Enabled()) {
+                mIsLoading = false;
+            }
+        } else {
             info = extras.getString(DocumentsContract.EXTRA_INFO);
             error = extras.getString(DocumentsContract.EXTRA_ERROR);
             mIsLoading = extras.getBoolean(DocumentsContract.EXTRA_LOADING, false);
@@ -149,6 +154,19 @@ public class Model {
         notifyUpdateListeners();
     }
 
+    /**
+     * Explicitly sets whether this model is in the loading state or not.
+     * @param loading If this model is considered to be loading new content.
+     */
+    public void setLoading(boolean loading) {
+        if (isSearchV2Enabled()) {
+            if (mIsLoading != loading) {
+                mIsLoading = loading;
+                notifyUpdateListeners();
+            }
+        }
+    }
+
     @VisibleForTesting
     public int getItemCount() {
         return mCursorCount;
diff --git a/src/com/android/documentsui/NavigationViewManager.java b/src/com/android/documentsui/NavigationViewManager.java
index bbae22d42..d371737be 100644
--- a/src/com/android/documentsui/NavigationViewManager.java
+++ b/src/com/android/documentsui/NavigationViewManager.java
@@ -18,7 +18,7 @@ package com.android.documentsui;
 
 import static com.android.documentsui.base.SharedMinimal.VERBOSE;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
-import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.res.Resources;
 import android.content.res.TypedArray;
@@ -26,7 +26,6 @@ import android.graphics.Outline;
 import android.graphics.drawable.ColorDrawable;
 import android.graphics.drawable.Drawable;
 import android.util.Log;
-import android.view.MenuItem;
 import android.view.View;
 import android.view.ViewGroup;
 import android.view.ViewOutlineProvider;
@@ -37,10 +36,7 @@ import androidx.annotation.ColorRes;
 import androidx.annotation.Nullable;
 import androidx.appcompat.widget.Toolbar;
 import androidx.core.content.ContextCompat;
-import androidx.recyclerview.selection.SelectionTracker;
 
-import com.android.documentsui.Injector.Injected;
-import com.android.documentsui.base.EventHandler;
 import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.base.State;
 import com.android.documentsui.base.UserId;
@@ -54,8 +50,7 @@ import com.google.android.material.appbar.CollapsingToolbarLayout;
 import java.util.function.IntConsumer;
 
 /** A facade over the portions of the app and drawer toolbars. */
-public class NavigationViewManager extends SelectionTracker.SelectionObserver<String>
-        implements AppBarLayout.OnOffsetChangedListener {
+public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListener {
 
     private static final String TAG = "NavigationViewManager";
 
@@ -74,11 +69,8 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
     private final ViewOutlineProvider mSearchBarOutlineProvider;
     private final boolean mShowSearchBar;
     private final ConfigStore mConfigStore;
-    @Injected private final Injector<?> mInjector;
     private boolean mIsActionModeActivated = false;
     @ColorRes private int mDefaultStatusBarColorResId;
-    private MenuManager.SelectionDetails mSelectionDetails;
-    private EventHandler<MenuItem> mActionMenuItemClicker;
 
     public NavigationViewManager(
             BaseActivity activity,
@@ -88,8 +80,7 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
             Breadcrumb breadcrumb,
             View tabLayoutContainer,
             UserIdManager userIdManager,
-            ConfigStore configStore,
-            Injector injector) {
+            ConfigStore configStore) {
         this(
                 activity,
                 drawer,
@@ -99,8 +90,7 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
                 tabLayoutContainer,
                 userIdManager,
                 null,
-                configStore,
-                injector);
+                configStore);
     }
 
     public NavigationViewManager(
@@ -111,8 +101,7 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
             Breadcrumb breadcrumb,
             View tabLayoutContainer,
             UserManagerState userManagerState,
-            ConfigStore configStore,
-            Injector injector) {
+            ConfigStore configStore) {
         this(
                 activity,
                 drawer,
@@ -122,8 +111,7 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
                 tabLayoutContainer,
                 null,
                 userManagerState,
-                configStore,
-                injector);
+                configStore);
     }
 
     public NavigationViewManager(
@@ -135,12 +123,11 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
             View tabLayoutContainer,
             UserIdManager userIdManager,
             UserManagerState userManagerState,
-            ConfigStore configStore,
-            Injector injector) {
+            ConfigStore configStore) {
 
         mActivity = activity;
-        mToolbar = activity.findViewById(R.id.toolbar);
-        mHeader = activity.findViewById(R.id.directory_header);
+        mToolbar = activity.findViewById(getRes(R.id.toolbar));
+        mHeader = activity.findViewById(getRes(R.id.directory_header));
         mDrawer = drawer;
         mState = state;
         mEnv = env;
@@ -150,10 +137,9 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
                 state,
                 this::onNavigationItemSelected,
                 isUseMaterial3FlagEnabled()
-                        ? activity.findViewById(R.id.breadcrumb_top_divider)
+                        ? activity.findViewById(getRes(R.id.breadcrumb_top_divider))
                         : null);
         mConfigStore = configStore;
-        mInjector = injector;
         mProfileTabs =
                 getProfileTabs(tabLayoutContainer, userIdManager, userManagerState, activity);
 
@@ -164,36 +150,28 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
                         onNavigationIconClicked();
                     }
                 });
-        if (isUseMaterial3FlagEnabled()) {
-            mToolbar.setOnMenuItemClickListener(
-                    new Toolbar.OnMenuItemClickListener() {
-                        @Override
-                        public boolean onMenuItemClick(MenuItem menuItem) {
-                            return onToolbarMenuItemClicked(menuItem);
-                        }
-                    });
-        }
-        mSearchBarView = activity.findViewById(R.id.searchbar_title);
-        mCollapsingBarLayout = activity.findViewById(R.id.collapsing_toolbar);
+        mSearchBarView = activity.findViewById(getRes(R.id.searchbar_title));
+        mCollapsingBarLayout = activity.findViewById(getRes(R.id.collapsing_toolbar));
         mDefaultActionBarBackground = mToolbar.getBackground();
         mDefaultOutlineProvider = mToolbar.getOutlineProvider();
-        mShowSearchBar = activity.getResources().getBoolean(R.bool.show_search_bar);
+        mShowSearchBar = isUseMaterial3FlagEnabled() ? false : activity.getResources().getBoolean(
+                R.bool.show_search_bar);
 
         final int[] styledAttrs = {android.R.attr.statusBarColor};
         TypedArray a = mActivity.obtainStyledAttributes(styledAttrs);
         mDefaultStatusBarColorResId = a.getResourceId(0, -1);
         if (mDefaultStatusBarColorResId == -1) {
             Log.w(TAG, "Retrieve statusBarColorResId from theme failed, assigned default");
-            mDefaultStatusBarColorResId = R.color.app_background_color;
+            mDefaultStatusBarColorResId = getRes(R.color.app_background_color);
         }
         a.recycle();
 
         final Resources resources = mToolbar.getResources();
-        final int radius = resources.getDimensionPixelSize(R.dimen.search_bar_radius);
+        final int radius = resources.getDimensionPixelSize(getRes(R.dimen.search_bar_radius));
         final int marginStart =
-                resources.getDimensionPixelSize(R.dimen.search_bar_background_margin_start);
+                resources.getDimensionPixelSize(getRes(R.dimen.search_bar_background_margin_start));
         final int marginEnd =
-                resources.getDimensionPixelSize(R.dimen.search_bar_background_margin_end);
+                resources.getDimensionPixelSize(getRes(R.dimen.search_bar_background_margin_end));
         mSearchBarOutlineProvider = new ViewOutlineProvider() {
             @Override
             public void getOutline(View view, Outline outline) {
@@ -227,8 +205,12 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
         Window window = mActivity.getWindow();
         View actionBar =
                 window.getDecorView().findViewById(androidx.appcompat.R.id.action_mode_bar);
-        int dynamicHeaderColor = ContextCompat.getColor(mActivity,
-                offset == 0 ? mDefaultStatusBarColorResId : R.color.color_surface_header);
+        int dynamicHeaderColor =
+                ContextCompat.getColor(
+                        mActivity,
+                        offset == 0
+                                ? mDefaultStatusBarColorResId
+                                : getRes(R.color.color_surface_header));
         if (actionBar != null) {
             // Action bar needs to be updated separately for selection mode.
             actionBar.setBackgroundColor(dynamicHeaderColor);
@@ -268,21 +250,11 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
     }
 
     private void onNavigationIconClicked() {
-        if (isUseMaterial3FlagEnabled() && inSelectionMode()) {
-            closeSelectionBar();
-        } else if (mDrawer.isPresent()) {
+        if (mDrawer.isPresent()) {
             mDrawer.setOpen(true);
         }
     }
 
-    private boolean onToolbarMenuItemClicked(MenuItem menuItem) {
-        if (inSelectionMode()) {
-            mActionMenuItemClicker.accept(menuItem);
-            return true;
-        }
-        return mActivity.onOptionsItemSelected(menuItem);
-    }
-
     void onNavigationItemSelected(int position) {
         boolean changed = false;
         while (mState.stack.size() > position + 1) {
@@ -304,15 +276,14 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
     }
 
     public void update() {
-        // If use_material3 flag is ON, we don't want any scroll behavior, thus skipping this logic.
-        if (!isUseMaterial3FlagEnabled()) {
-            updateScrollFlag();
-        }
+        updateScrollFlag();
         updateToolbar();
         mProfileTabs.updateView();
 
-        // TODO: Looks to me like this block is never getting hit.
-        if (mEnv.isSearchExpanded()) {
+        // When the search view is expanded, most of the toolbar is hidden. Except when docked
+        // search is enabled, in which case the toolbar is shown as normal.
+        boolean showDockedSearch = mActivity.getResources().getBoolean(R.bool.show_docked_search);
+        if (mEnv.isSearchExpanded() && !(isUseMaterial3FlagEnabled() && showDockedSearch)) {
             mToolbar.setTitle(null);
             mBreadcrumb.show(false);
             return;
@@ -320,18 +291,14 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
 
         mDrawer.setTitle(mEnv.getDrawerTitle());
 
-        boolean showBurgerMenuOnToolbar = true;
-        if (isUseMaterial3FlagEnabled()) {
-            View navRailRoots = mActivity.findViewById(R.id.nav_rail_container_roots);
-            if (navRailRoots != null) {
-                // If nav rail exists, burger menu will show on the nav rail instead.
-                showBurgerMenuOnToolbar = false;
-            }
-        }
-
+        // Show burger menu on toolbar unless `use_material3` flag is on and the nav rail exists
+        // (the burger menu will show on the nav rail instead).
+        boolean showBurgerMenuOnToolbar =
+                !isUseMaterial3FlagEnabled()
+                        || mActivity.findViewById(getRes(R.id.nav_rail_container_roots)) == null;
         if (showBurgerMenuOnToolbar) {
             mToolbar.setNavigationIcon(getActionBarIcon());
-            mToolbar.setNavigationContentDescription(R.string.drawer_open);
+            mToolbar.setNavigationContentDescription(getRes(R.string.drawer_open));
         } else {
             mToolbar.setNavigationIcon(null);
             mToolbar.setNavigationContentDescription(null);
@@ -345,23 +312,6 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
         }
 
         mSearchBarView.setVisibility(View.GONE);
-
-        if (isUseMaterial3FlagEnabled()) {
-            updateActionMenu();
-            if (inSelectionMode()) {
-                final int quantity = mInjector.selectionMgr.getSelection().size();
-                final String title =
-                        mToolbar.getContext()
-                                .getResources()
-                                .getQuantityString(R.plurals.elements_selected, quantity, quantity);
-                mToolbar.setTitle(title);
-                mActivity.getWindow().setTitle(title);
-                mToolbar.setNavigationIcon(R.drawable.ic_cancel);
-                mToolbar.setNavigationContentDescription(android.R.string.cancel);
-                return;
-            }
-        }
-
         String title =
                 mState.stack.size() <= 1 ? mEnv.getCurrentRoot().title : mState.stack.getTitle();
         if (VERBOSE) Log.v(TAG, "New toolbar title is: " + title);
@@ -370,62 +320,6 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
         mBreadcrumb.postUpdate();
     }
 
-    @Override
-    public void onSelectionChanged() {
-        update();
-    }
-
-    /** Identifies if the `NavigationViewManager` is in selection mode or not. */
-    public boolean inSelectionMode() {
-        return mInjector != null
-                && mInjector.selectionMgr != null
-                && mInjector.selectionMgr.hasSelection();
-    }
-
-    private boolean hasActionMenu() {
-        return mToolbar.getMenu().findItem(R.id.action_menu_open_with) != null;
-    }
-
-    /** Updates the action menu based on whether a selection is currently being made or not. */
-    public void updateActionMenu() {
-        // For the first start up of the application, the menu might not exist at all but we also
-        // don't want to inflate the menu multiple times. So along with checking if the expected
-        // menu is already inflated, validate that a menu exists at all as well.
-        boolean isMenuInflated = mToolbar.getMenu() != null && mToolbar.getMenu().size() > 0;
-        if (inSelectionMode()) {
-            if (!isMenuInflated || !hasActionMenu()) {
-                mToolbar.getMenu().clear();
-                mToolbar.inflateMenu(R.menu.action_mode_menu);
-                mToolbar.invalidateMenu();
-            }
-            mInjector.menuManager.updateActionMenu(mToolbar.getMenu(), mSelectionDetails);
-            return;
-        }
-
-        if (!isMenuInflated || hasActionMenu()) {
-            mToolbar.getMenu().clear();
-            mToolbar.inflateMenu(R.menu.activity);
-            mToolbar.invalidateMenu();
-            boolean fullBarSearch =
-                    mActivity.getResources().getBoolean(R.bool.full_bar_search_view);
-            boolean showSearchBar = mActivity.getResources().getBoolean(R.bool.show_search_bar);
-            mInjector.searchManager.install(mToolbar.getMenu(), fullBarSearch, showSearchBar);
-            if (isVisualSignalsFlagEnabled()) {
-                mInjector.menuManager.instantiateJobProgress(mToolbar.getMenu());
-            }
-        }
-        mInjector.menuManager.updateOptionMenu(mToolbar.getMenu());
-        mInjector.searchManager.showMenu(mState.stack);
-    }
-
-    /** Everytime a selection is made, update the selection. */
-    public void updateSelection(
-            MenuManager.SelectionDetails selectionDetails,
-            EventHandler<MenuItem> actionMenuItemClicker) {
-        mSelectionDetails = selectionDetails;
-        mActionMenuItemClicker = actionMenuItemClicker;
-    }
-
     private void updateScrollFlag() {
         if (mCollapsingBarLayout == null) {
             return;
@@ -443,7 +337,7 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
             // Tablet mode does not use CollapsingBarLayout
             // (res/layout-sw720dp/directory_app_bar.xml or res/layout/fixed_layout.xml)
             if (shouldShowSearchBar()) {
-                mToolbar.setBackgroundResource(R.drawable.search_bar_background);
+                mToolbar.setBackgroundResource(getRes(R.drawable.search_bar_background));
                 mToolbar.setOutlineProvider(mSearchBarOutlineProvider);
             } else {
                 mToolbar.setBackground(mDefaultActionBarBackground);
@@ -457,25 +351,29 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
 
         int headerTopOffset = 0;
         if (shouldShowSearchBar() && !mIsActionModeActivated) {
-            mToolbar.setBackgroundResource(R.drawable.search_bar_background);
+            mToolbar.setBackgroundResource(getRes(R.drawable.search_bar_background));
             mToolbar.setOutlineProvider(mSearchBarOutlineProvider);
-            int searchBarMargin = mToolbar.getResources().getDimensionPixelSize(
-                    R.dimen.search_bar_margin);
+            int searchBarMargin =
+                    mToolbar.getResources()
+                            .getDimensionPixelSize(getRes(R.dimen.search_bar_margin));
             toolbarLayoutParams.setMargins(searchBarMargin, searchBarMargin, searchBarMargin,
                     searchBarMargin);
             mToolbar.setLayoutParams(toolbarLayoutParams);
             mToolbar.setElevation(
-                    mToolbar.getResources().getDimensionPixelSize(R.dimen.search_bar_elevation));
+                    mToolbar.getResources()
+                            .getDimensionPixelSize(getRes(R.dimen.search_bar_elevation)));
             headerTopOffset = toolbarLayoutParams.height + searchBarMargin * 2;
         } else {
             mToolbar.setBackground(mDefaultActionBarBackground);
             mToolbar.setOutlineProvider(mDefaultOutlineProvider);
-            int actionBarMargin = mToolbar.getResources().getDimensionPixelSize(
-                    R.dimen.action_bar_margin);
+            int actionBarMargin =
+                    mToolbar.getResources()
+                            .getDimensionPixelSize(getRes(R.dimen.action_bar_margin));
             toolbarLayoutParams.setMargins(0, 0, 0, /* bottom= */ actionBarMargin);
             mToolbar.setLayoutParams(toolbarLayoutParams);
             mToolbar.setElevation(
-                    mToolbar.getResources().getDimensionPixelSize(R.dimen.action_bar_elevation));
+                    mToolbar.getResources()
+                            .getDimensionPixelSize(getRes(R.dimen.action_bar_elevation)));
             headerTopOffset = toolbarLayoutParams.height + actionBarMargin;
         }
 
@@ -498,7 +396,7 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
     private @Nullable
     Drawable getActionBarIcon() {
         if (mDrawer.isPresent()) {
-            return mToolbar.getContext().getDrawable(R.drawable.ic_hamburger);
+            return mToolbar.getContext().getDrawable(getRes(R.drawable.ic_hamburger));
         } else {
             return null;
         }
@@ -508,11 +406,6 @@ public class NavigationViewManager extends SelectionTracker.SelectionObserver<St
         mDrawer.setOpen(open);
     }
 
-    /** Helper method to close the selection bar. */
-    public void closeSelectionBar() {
-        mInjector.selectionMgr.clearSelection();
-    }
-
     interface Breadcrumb {
         void setup(Environment env, State state, IntConsumer listener, @Nullable View topDivider);
 
diff --git a/src/com/android/documentsui/OperationDialogFragment.java b/src/com/android/documentsui/OperationDialogFragment.java
index bc98662dc..a918756d1 100644
--- a/src/com/android/documentsui/OperationDialogFragment.java
+++ b/src/com/android/documentsui/OperationDialogFragment.java
@@ -16,13 +16,20 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.app.Dialog;
 import android.content.DialogInterface;
+import android.content.res.Resources;
 import android.net.Uri;
 import android.os.Bundle;
 import android.text.Html;
+import android.widget.TextView;
 
 import androidx.annotation.IntDef;
+import androidx.annotation.NonNull;
+import androidx.appcompat.app.AlertDialog;
 import androidx.fragment.app.DialogFragment;
 import androidx.fragment.app.FragmentManager;
 import androidx.fragment.app.FragmentTransaction;
@@ -38,6 +45,7 @@ import com.google.android.material.dialog.MaterialAlertDialogBuilder;
 import java.lang.annotation.Retention;
 import java.lang.annotation.RetentionPolicy;
 import java.util.ArrayList;
+import java.util.List;
 
 /**
  * Alert dialog for operation dialogs.
@@ -62,16 +70,18 @@ public class OperationDialogFragment extends DialogFragment {
     public static void show(
             FragmentManager fm,
             @DialogType int dialogType,
-            ArrayList<DocumentInfo> failedSrcList,
-            ArrayList<Uri> uriList,
+            ArrayList<DocumentInfo> failedDocs,
+            ArrayList<Uri> failedUris,
+            ArrayList<String> failedPaths,
             DocumentStack dstStack,
             @OpType int operationType) {
 
         final Bundle args = new Bundle();
         args.putInt(FileOperationService.EXTRA_DIALOG_TYPE, dialogType);
         args.putInt(FileOperationService.EXTRA_OPERATION_TYPE, operationType);
-        args.putParcelableArrayList(FileOperationService.EXTRA_FAILED_DOCS, failedSrcList);
-        args.putParcelableArrayList(FileOperationService.EXTRA_FAILED_URIS, uriList);
+        args.putParcelableArrayList(FileOperationService.EXTRA_FAILED_DOCS, failedDocs);
+        args.putParcelableArrayList(FileOperationService.EXTRA_FAILED_URIS, failedUris);
+        args.putStringArrayList(FileOperationService.EXTRA_FAILED_PATHS, failedPaths);
 
         final FragmentTransaction ft = fm.beginTransaction();
         final OperationDialogFragment fragment = new OperationDialogFragment();
@@ -82,25 +92,27 @@ public class OperationDialogFragment extends DialogFragment {
     }
 
     @Override
-    public Dialog onCreateDialog(Bundle inState) {
+    public @NonNull Dialog onCreateDialog(Bundle inState) {
         super.onCreate(inState);
 
         final @DialogType int dialogType =
               getArguments().getInt(FileOperationService.EXTRA_DIALOG_TYPE);
         final @OpType int operationType =
               getArguments().getInt(FileOperationService.EXTRA_OPERATION_TYPE);
-        final ArrayList<Uri> uriList = getArguments().getParcelableArrayList(
-                FileOperationService.EXTRA_FAILED_URIS);
-        final ArrayList<DocumentInfo> docList = getArguments().getParcelableArrayList(
-                FileOperationService.EXTRA_FAILED_DOCS);
+        final List<DocumentInfo> failedDocs = getArguments().getParcelableArrayList(
+                FileOperationService.EXTRA_FAILED_DOCS, DocumentInfo.class);
+        final List<Uri> failedUris = getArguments().getParcelableArrayList(
+                FileOperationService.EXTRA_FAILED_URIS, Uri.class);
+        final List<String> failedPaths = getArguments().getStringArrayList(
+                FileOperationService.EXTRA_FAILED_PATHS);
 
         final MaterialAlertDialogBuilder builder = new MaterialAlertDialogBuilder(getActivity());
         final String message = new MessageBuilder(getContext()).generateListMessage(
-                dialogType, operationType, docList, uriList);
+                dialogType, operationType, failedDocs, failedUris, failedPaths);
 
         builder.setMessage(Html.fromHtml(message));
         builder.setPositiveButton(
-                R.string.close,
+                getRes(R.string.close),
                 new DialogInterface.OnClickListener() {
                     @Override
                     public void onClick(DialogInterface dialog, int id) {
@@ -108,6 +120,31 @@ public class OperationDialogFragment extends DialogFragment {
                     }
                 });
 
-        return builder.create();
+        Dialog dialog = builder.create();
+        // message content returned by `Html.fromHtml()` above doesn't inherit the theme level
+        // dialog body text style, we need to manually apply it. In addition, set the same padding
+        // as other dialogs.
+        if (isUseMaterial3FlagEnabled()) {
+            final Resources resources = getResources();
+            dialog.setOnShowListener(
+                    dialogInterface -> {
+                        TextView body =
+                                ((AlertDialog) dialogInterface).findViewById(android.R.id.message);
+                        if (body != null) {
+                            body.setTextAppearance(getRes(R.style.MaterialAlertDialogBodyStyle));
+                            body.setPadding(
+                                    resources.getDimensionPixelSize(
+                                            getRes(R.dimen.dialog_content_padding_horizontal)),
+                                    resources.getDimensionPixelSize(
+                                            getRes(R.dimen.dialog_content_padding_top)),
+                                    resources.getDimensionPixelSize(
+                                            getRes(R.dimen.dialog_content_padding_horizontal)),
+                                    resources.getDimensionPixelSize(
+                                            getRes(R.dimen.dialog_content_padding_bottom)));
+                        }
+                    });
+        }
+
+        return dialog;
     }
 }
diff --git a/src/com/android/documentsui/ProfileTabs.java b/src/com/android/documentsui/ProfileTabs.java
index 74db6f4bd..5dbf77933 100644
--- a/src/com/android/documentsui/ProfileTabs.java
+++ b/src/com/android/documentsui/ProfileTabs.java
@@ -21,6 +21,7 @@ import static androidx.core.util.Preconditions.checkNotNull;
 import static com.android.documentsui.DevicePolicyResources.Strings.PERSONAL_TAB;
 import static com.android.documentsui.DevicePolicyResources.Strings.WORK_TAB;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.admin.DevicePolicyManager;
 import android.os.Build;
@@ -82,7 +83,7 @@ public class ProfileTabs implements ProfileTabsAddons {
             @Nullable UserManagerState userManagerState, NavigationViewManager.Environment env,
             AbstractActionHandler.CommonAddons commonAddons, ConfigStore configStore) {
         mTabsContainer = checkNotNull(tabLayoutContainer);
-        mTabs = tabLayoutContainer.findViewById(R.id.tabs);
+        mTabs = tabLayoutContainer.findViewById(getRes(R.id.tabs));
         mState = checkNotNull(state);
         mEnv = checkNotNull(env);
         mCommonAddons = checkNotNull(commonAddons);
@@ -96,7 +97,7 @@ public class ProfileTabs implements ProfileTabsAddons {
         }
         mTabs.removeAllTabs();
         mUserIds = Collections.singletonList(UserId.CURRENT_USER);
-        mTabSeparator = tabLayoutContainer.findViewById(R.id.tab_separator);
+        mTabSeparator = tabLayoutContainer.findViewById(getRes(R.id.tab_separator));
 
         mOnTabSelectedListener = new TabLayout.OnTabSelectedListener() {
             @Override
@@ -137,13 +138,21 @@ public class ProfileTabs implements ProfileTabsAddons {
         // Material next changes apply only for version S or greater
         if (SdkLevel.isAtLeastS()) {
             mTabSeparator.setVisibility(View.GONE);
-            int tabContainerHeightInDp = (int) mTabsContainer.getContext().getResources()
-                    .getDimension(R.dimen.tab_container_height);
+            int tabContainerHeightInDp =
+                    (int)
+                            mTabsContainer
+                                    .getContext()
+                                    .getResources()
+                                    .getDimension(getRes(R.dimen.tab_container_height));
             mTabsContainer.getLayoutParams().height = tabContainerHeightInDp;
             ViewGroup.MarginLayoutParams tabContainerMarginLayoutParams =
                     (ViewGroup.MarginLayoutParams) mTabsContainer.getLayoutParams();
-            int tabContainerMarginTop = (int) mTabsContainer.getContext().getResources()
-                    .getDimension(R.dimen.profile_tab_margin_top);
+            int tabContainerMarginTop =
+                    (int)
+                            mTabsContainer
+                                    .getContext()
+                                    .getResources()
+                                    .getDimension(getRes(R.dimen.profile_tab_margin_top));
             tabContainerMarginLayoutParams.setMargins(0, tabContainerMarginTop, 0, 0);
             mTabsContainer.requestLayout();
             for (int i = 0; i < mTabs.getTabCount(); i++) {
@@ -154,8 +163,12 @@ public class ProfileTabs implements ProfileTabsAddons {
                 // Get individual tab to set the style
                 ViewGroup.MarginLayoutParams marginLayoutParams =
                         (ViewGroup.MarginLayoutParams) tab.getLayoutParams();
-                int tabMarginSide = (int) mTabsContainer.getContext().getResources()
-                        .getDimension(R.dimen.profile_tab_margin_side);
+                int tabMarginSide =
+                        (int)
+                                mTabsContainer
+                                        .getContext()
+                                        .getResources()
+                                        .getDimension(getRes(R.dimen.profile_tab_margin_side));
                 if (isUseMaterial3FlagEnabled()) {
                     final boolean isRtl = mTabs.getLayoutDirection() == View.LAYOUT_DIRECTION_RTL;
                     // if use_material3 flag is ON, we uses the margin value as the right margin
@@ -167,11 +180,15 @@ public class ProfileTabs implements ProfileTabsAddons {
                 } else {
                     marginLayoutParams.setMargins(tabMarginSide, 0, tabMarginSide, 0);
                 }
-                int tabHeightInDp = (int) mTabsContainer.getContext().getResources()
-                        .getDimension(R.dimen.tab_height);
+                int tabHeightInDp =
+                        (int)
+                                mTabsContainer
+                                        .getContext()
+                                        .getResources()
+                                        .getDimension(getRes(R.dimen.tab_height));
                 tab.getLayoutParams().height = tabHeightInDp;
                 tab.requestLayout();
-                tab.setBackgroundResource(R.drawable.tab_border_rounded);
+                tab.setBackgroundResource(getRes(R.drawable.tab_border_rounded));
             }
 
         }
@@ -224,12 +241,16 @@ public class ProfileTabs implements ProfileTabsAddons {
     private void addTabsPrivateSpaceDisabled() {
         // set setSelected to false otherwise it will trigger callback.
         assert mUserIdManager != null;
-        mTabs.addTab(createTab(
-                getEnterpriseString(PERSONAL_TAB, R.string.personal_tab),
-                mUserIdManager.getSystemUser()), /* setSelected= */false);
-        mTabs.addTab(createTab(
-                getEnterpriseString(WORK_TAB, R.string.work_tab),
-                mUserIdManager.getManagedUser()), /* setSelected= */false);
+        mTabs.addTab(
+                createTab(
+                        getEnterpriseString(PERSONAL_TAB, getRes(R.string.personal_tab)),
+                        mUserIdManager.getSystemUser()),
+                /* setSelected= */ false);
+        mTabs.addTab(
+                createTab(
+                        getEnterpriseString(WORK_TAB, getRes(R.string.work_tab)),
+                        mUserIdManager.getManagedUser()),
+                /* setSelected= */ false);
     }
 
     private String getEnterpriseString(String updatableStringId, int defaultStringId) {
diff --git a/src/com/android/documentsui/SelectionBarController.kt b/src/com/android/documentsui/SelectionBarController.kt
new file mode 100644
index 000000000..8a72f20e2
--- /dev/null
+++ b/src/com/android/documentsui/SelectionBarController.kt
@@ -0,0 +1,104 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui
+
+import android.view.MenuItem
+import android.view.View
+import androidx.core.view.isNotEmpty
+import androidx.recyclerview.selection.MutableSelection
+import androidx.recyclerview.selection.SelectionTracker
+import com.android.documentsui.base.EventHandler
+import com.android.documentsui.util.Material3Config.Companion.getRes
+import com.google.android.material.appbar.MaterialToolbar
+
+/**
+ * Controls the secondary `MaterialToolbar` that shows the current selection and the associated
+ * action menu for the selected items. This is only instantiated when the `use_material3` flag is
+ * enabled.
+ */
+class SelectionBarController(
+    private val selectionBar: MaterialToolbar,
+    private val menuManager: MenuManager,
+    private val selectionManager: DocsSelectionHelper
+) : SelectionTracker.SelectionObserver<String>() {
+    // The clicker and selectionDetails are initialised in the DirectoryFragment and thus gets setup
+    // each time the directory changes.
+    private var selectionDetails: MenuManager.SelectionDetails? = null
+    private var menuItemClicker: EventHandler<MenuItem>? = null
+
+    // Copy the selection when it changes to ensure the update is done without any interference.
+    private var selectedItems = MutableSelection<String>()
+
+    override fun onSelectionChanged() {
+        selectionManager.copySelection(selectedItems)
+        updateSelectionBar()
+    }
+
+    override fun onSelectionRestored() {
+        onSelectionChanged()
+    }
+
+    /**
+     * Method that is used by the DirectoryFragment to effectively "reset" the current selection and
+     * menu item click function when the directory fragment is changed. This enforces the
+     * @ContentScoped invariant.
+     */
+    fun updateSelection(
+        selectionDetails: MenuManager.SelectionDetails,
+        menuItemClicker: EventHandler<MenuItem>
+    ): SelectionBarController {
+        this.selectionDetails = selectionDetails
+        this.menuItemClicker = menuItemClicker
+        return this
+    }
+
+    fun closeSelectionBar() {
+        selectionManager.clearSelection()
+    }
+
+    private fun updateSelectionBar() {
+        if (selectedItems.isEmpty) {
+            selectionBar.visibility = View.GONE
+            return
+        }
+        selectionBar.visibility = View.VISIBLE
+        val quantity: Int = selectedItems.size()
+        val title: String =
+            selectionBar.context
+                .getResources()
+                .getQuantityString(
+                    getRes(R.plurals.elements_selected),
+                    quantity,
+                    quantity
+                )
+        selectionBar.title = title
+        selectionBar.setNavigationIcon(getRes(R.drawable.ic_cancel))
+        selectionBar.setNavigationContentDescription(R.string.clear_selection)
+        selectionBar.setOnMenuItemClickListener { menuItemClicker?.accept(it) == true }
+        selectionBar.setNavigationOnClickListener { closeSelectionBar() }
+        updateSelectionMenu()
+    }
+
+    /** Updates the selection menu (including inflating it if required). */
+    private fun updateSelectionMenu() {
+        val isMenuInflated = selectionBar.menu != null && selectionBar.menu.isNotEmpty()
+        if (!isMenuInflated) {
+            selectionBar.inflateMenu(getRes(R.menu.action_mode_menu))
+        }
+        selectionBar.visibility = View.VISIBLE
+        menuManager.updateActionMenu(selectionBar.menu, selectionDetails)
+    }
+}
diff --git a/src/com/android/documentsui/ShortcutsUpdater.java b/src/com/android/documentsui/ShortcutsUpdater.java
index e71d7bc93..8668f7dd2 100644
--- a/src/com/android/documentsui/ShortcutsUpdater.java
+++ b/src/com/android/documentsui/ShortcutsUpdater.java
@@ -15,6 +15,8 @@
  */
 package com.android.documentsui;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.content.Intent;
 import android.content.pm.ShortcutInfo;
@@ -86,14 +88,14 @@ public final class ShortcutsUpdater {
             // disambiguate for the user. So, we don't add them.
             // if (!Providers.isSystemProvider(root.authority)) {
             //    // add third party providers at the beginning of the list.
-            //    devices.add(createShortcut(root, R.drawable.ic_folder_shortcut));
+            //    devices.add(createShortcut(root, getRes(R.drawable.ic_folder_shortcut)));
             // } else
             if (root.isAdvanced() && root.authority.equals(Providers.AUTHORITY_STORAGE)) {
                 // internal storage
-                devices.add(0, createShortcut(root, R.drawable.ic_advanced_shortcut));
+                devices.add(0, createShortcut(root, getRes(R.drawable.ic_advanced_shortcut)));
             } else if (root.isAdvanced()) {
                 // probably just bugreports provider
-                devices.add(0, createShortcut(root, R.drawable.ic_folder_shortcut));
+                devices.add(0, createShortcut(root, getRes(R.drawable.ic_folder_shortcut)));
             }
             // TODO: Hook up USB and MTP devices. In order to do this we need
             // to fire up a broadcast to listen for ACTION_MEDIA_MOUNTED
@@ -101,7 +103,7 @@ public final class ShortcutsUpdater {
             // bit of refactoring, rendering out of scope for now. <sadface>.
             // else if (root.isUsb() || root.isMtp()) {
             //    // probably just bugreports provider
-            //    devices.add(0, createShortcut(root, R.drawable.ic_usb_shortcut));
+            //    devices.add(0, createShortcut(root, getRes(R.drawable.ic_usb_shortcut)));
             // }
         }
 
diff --git a/src/com/android/documentsui/UserManagerState.java b/src/com/android/documentsui/UserManagerState.java
index 1023c8c1d..747149f89 100644
--- a/src/com/android/documentsui/UserManagerState.java
+++ b/src/com/android/documentsui/UserManagerState.java
@@ -22,6 +22,7 @@ import static com.android.documentsui.DevicePolicyResources.Drawables.Style.SOLI
 import static com.android.documentsui.DevicePolicyResources.Drawables.WORK_PROFILE_ICON;
 import static com.android.documentsui.DevicePolicyResources.Strings.PERSONAL_TAB;
 import static com.android.documentsui.DevicePolicyResources.Strings.WORK_TAB;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.Manifest;
 import android.annotation.SuppressLint;
@@ -313,7 +314,6 @@ public interface UserManagerState {
 
             final List<UserHandle> userProfiles = mUserManager.getUserProfiles();
 
-            result.add(mCurrentUser);
             boolean currentUserIsManaged =
                     mUserManager.isManagedProfile(mCurrentUser.getIdentifier());
 
@@ -323,8 +323,13 @@ public interface UserManagerState {
                         continue;
                     }
                 } else {
-                    // Only allow managed profiles + the parent user on lower than V.
-                    if (currentUserIsManaged
+                    // On Android U and below, ensure the following profiles are included:
+                    //  - The currently active profile
+                    //  - The currently active profile's parent
+                    //  - All managed profiles
+                    if (mCurrentUser.getIdentifier() == handle.getIdentifier()) {
+                        // Intentionally empty so that this profile gets added.
+                    } else if (currentUserIsManaged
                             && mUserManager.getProfileParent(mCurrentUser.getUserHandle())
                                     == handle) {
                         // Intentionally empty so that this profile gets added.
@@ -447,12 +452,13 @@ public interface UserManagerState {
                 if (mUserManager.isManagedProfile(userId.getIdentifier())) {
                     synchronized (mUserIdToLabelMap) {
                         mUserIdToLabelMap.put(
-                                userId, getEnterpriseString(WORK_TAB, R.string.work_tab));
+                                userId, getEnterpriseString(WORK_TAB, getRes(R.string.work_tab)));
                     }
                 } else {
                     synchronized (mUserIdToLabelMap) {
                         mUserIdToLabelMap.put(
-                                userId, getEnterpriseString(PERSONAL_TAB, R.string.personal_tab));
+                                userId,
+                                getEnterpriseString(PERSONAL_TAB, getRes(R.string.personal_tab)));
                     }
                 }
             }
@@ -461,7 +467,7 @@ public interface UserManagerState {
         @SuppressLint("NewApi")
         private String getProfileLabel(UserId userId) {
             if (userId.getIdentifier() == ActivityManager.getCurrentUser()) {
-                return getEnterpriseString(PERSONAL_TAB, R.string.personal_tab);
+                return getEnterpriseString(PERSONAL_TAB, getRes(R.string.personal_tab));
             }
             try {
                 Context userContext =
@@ -534,7 +540,7 @@ public interface UserManagerState {
                                 userId,
                                 SdkLevel.isAtLeastT()
                                         ? getWorkProfileBadge()
-                                        : mContext.getDrawable(R.drawable.ic_briefcase));
+                                        : mContext.getDrawable(getRes(R.drawable.ic_briefcase)));
                     }
                 }
             }
@@ -569,7 +575,7 @@ public interface UserManagerState {
                             .getDrawable(
                                     WORK_PROFILE_ICON,
                                     SOLID_COLORED,
-                                    () -> mContext.getDrawable(R.drawable.ic_briefcase));
+                                    () -> mContext.getDrawable(getRes(R.drawable.ic_briefcase)));
             return drawable;
         }
 
diff --git a/src/com/android/documentsui/archives/ArchiveEntryInputStream.java b/src/com/android/documentsui/archives/ArchiveEntryInputStream.java
index 2c34e5a71..29774670b 100644
--- a/src/com/android/documentsui/archives/ArchiveEntryInputStream.java
+++ b/src/com/android/documentsui/archives/ArchiveEntryInputStream.java
@@ -16,12 +16,16 @@
 
 package com.android.documentsui.archives;
 
+import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
+
 import android.text.TextUtils;
 
 import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
 
 import org.apache.commons.compress.archivers.ArchiveEntry;
 import org.apache.commons.compress.archivers.ArchiveInputStream;
+import org.apache.commons.compress.archivers.sevenz.SevenZArchiveEntry;
 import org.apache.commons.compress.archivers.sevenz.SevenZFile;
 import org.apache.commons.compress.archivers.zip.ZipArchiveEntry;
 import org.apache.commons.compress.archivers.zip.ZipFile;
@@ -29,17 +33,34 @@ import org.apache.commons.compress.archivers.zip.ZipFile;
 import java.io.Closeable;
 import java.io.IOException;
 import java.io.InputStream;
+import java.util.zip.CRC32;
+import java.util.zip.Checksum;
 
 /**
  * To simulate the input stream by using ZipFile, SevenZFile, or ArchiveInputStream.
  */
 abstract class ArchiveEntryInputStream extends InputStream {
-    private final long mSize;
-    private final ReadSource mReadSource;
-
-    private ArchiveEntryInputStream(ReadSource readSource, @NonNull ArchiveEntry archiveEntry) {
+    private final @NonNull ReadSource mReadSource;
+    /** Expected number of bytes if the data being extracted. */
+    private final long mExpectedSize;
+    /** Number of bytes having been extracted so far. */
+    private long mAccumulatedSize = 0;
+    /** Expected CRC when all the data has been extracted, or -1 if no CRC needs to be checked. */
+    private long mExpectedCrc = -1;
+    /** CRC accumulator, or null if no CRC needs to be checked. */
+    private @Nullable Checksum mCrcComputer = null;
+
+    private ArchiveEntryInputStream(@NonNull ReadSource readSource, @NonNull ArchiveEntry entry) {
         mReadSource = readSource;
-        mSize = archiveEntry.getSize();
+        mExpectedSize = entry.getSize();
+        if (isZipNgFlagEnabled()) {
+            if (entry instanceof ZipArchiveEntry) {
+                mExpectedCrc = ((ZipArchiveEntry) entry).getCrc();
+            } else if (entry instanceof SevenZArchiveEntry) {
+                mExpectedCrc = ((SevenZArchiveEntry) entry).getCrcValue();
+            }
+            if (mExpectedCrc >= 0) mCrcComputer = new CRC32();
+        }
     }
 
     @Override
@@ -49,16 +70,51 @@ abstract class ArchiveEntryInputStream extends InputStream {
 
     @Override
     public int read(byte[] b, int off, int len) throws IOException {
-        if (mReadSource != null) {
-            return mReadSource.read(b, off, len);
+        if (mReadSource == null) return -1;
+
+        final int n = mReadSource.read(b, off, len);
+
+        if (n >= 0) {
+            if (isZipNgFlagEnabled()) {
+                mAccumulatedSize += n;
+                if (mAccumulatedSize > mExpectedSize) {
+                    throw new IOException(
+                            "Extracted file is too long: Already extracted " + mAccumulatedSize
+                                    + " bytes when only " + mExpectedSize + " bytes are expected");
+                }
+
+                if (mCrcComputer != null) mCrcComputer.update(b, off, n);
+            }
+
+            return n;
         }
 
-        return -1; /* end of input stream */
+        // End of stream.
+        if (isZipNgFlagEnabled()) {
+            // Check file size.
+            if (mAccumulatedSize != mExpectedSize) {
+                throw new IOException(
+                        "Extracted file is too short: Only extracted " + mAccumulatedSize
+                                + " bytes when " + mExpectedSize + " bytes are expected");
+            }
+
+            // Check CRC.
+            if (mCrcComputer != null) {
+                final long crc = mCrcComputer.getValue();
+                mCrcComputer = null;
+                if (crc != mExpectedCrc) {
+                    throw new IOException(
+                            String.format("Bad CRC: got %08X, want %08X", crc, mExpectedCrc));
+                }
+            }
+        }
+
+        return -1;
     }
 
     @Override
     public int available() throws IOException {
-        return mReadSource == null ? 0 : StrictMath.toIntExact(mSize);
+        return mReadSource == null ? 0 : StrictMath.toIntExact(mExpectedSize);
     }
 
     /**
@@ -114,42 +170,38 @@ abstract class ArchiveEntryInputStream extends InputStream {
         }
     }
 
-    static InputStream create(@NonNull ArchiveHandle archiveHandle,
-            @NonNull ArchiveEntry archiveEntry) throws IOException {
-        if (archiveHandle == null) {
-            throw new IllegalArgumentException("archiveHandle is null");
+    static @NonNull InputStream create(@NonNull ArchiveHandle handle, @NonNull ArchiveEntry entry)
+            throws IOException {
+        if (handle == null) {
+            throw new IllegalArgumentException("handle is null");
         }
 
-        if (archiveEntry == null) {
-            throw new IllegalArgumentException("ArchiveEntry is empty");
+        if (entry == null) {
+            throw new IllegalArgumentException("entry is null");
         }
 
-        if (archiveEntry.isDirectory() || archiveEntry.getSize() < 0
-                || TextUtils.isEmpty(archiveEntry.getName())) {
+        if (entry.isDirectory() || entry.getSize() < 0 || TextUtils.isEmpty(entry.getName())) {
             throw new IllegalArgumentException("ArchiveEntry is an invalid file entry");
         }
 
-        Object commonArchive = archiveHandle.getCommonArchive();
-
-        if (commonArchive instanceof SevenZFile) {
-            return new WrapArchiveInputStream(
-                (b, off, len) -> ((SevenZFile) commonArchive).read(b, off, len),
-                archiveEntry,
-                () -> ((SevenZFile) commonArchive).getNextEntry());
-        } else if (commonArchive instanceof ZipFile) {
-            final InputStream inputStream =
-                    ((ZipFile) commonArchive).getInputStream((ZipArchiveEntry) archiveEntry);
-            return new WrapZipFileInputStream(
-                (b, off, len) -> inputStream.read(b, off, len),
-                archiveEntry,
-                () -> inputStream.close());
-        } else if (commonArchive instanceof ArchiveInputStream) {
-            return new WrapArchiveInputStream(
-                (b, off, len) -> ((ArchiveInputStream) commonArchive).read(b, off, len),
-                archiveEntry,
-                () -> ((ArchiveInputStream) commonArchive).getNextEntry());
+        final Object archive = handle.getCommonArchive();
+
+        if (archive instanceof SevenZFile) {
+            final SevenZFile file = (SevenZFile) archive;
+            return new WrapArchiveInputStream(file::read, entry, file::getNextEntry);
+        }
+
+        if (archive instanceof ZipFile) {
+            final ZipFile file = (ZipFile) archive;
+            InputStream stream = file.getInputStream((ZipArchiveEntry) entry);
+            return new WrapZipFileInputStream(stream::read, entry, stream);
+        }
+
+        if (archive instanceof ArchiveInputStream) {
+            final ArchiveInputStream stream = (ArchiveInputStream) archive;
+            return new WrapArchiveInputStream(stream::read, entry, stream::getNextEntry);
         }
 
-        return null;
+        throw new IllegalArgumentException("Unexpected archive type " + archive);
     }
 }
diff --git a/src/com/android/documentsui/archives/ArchiveHandle.java b/src/com/android/documentsui/archives/ArchiveHandle.java
index 45792a176..e0c49e40f 100644
--- a/src/com/android/documentsui/archives/ArchiveHandle.java
+++ b/src/com/android/documentsui/archives/ArchiveHandle.java
@@ -30,6 +30,16 @@ import android.util.Log;
 
 import androidx.annotation.NonNull;
 
+import org.apache.commons.compress.archivers.ArchiveEntry;
+import org.apache.commons.compress.archivers.ArchiveException;
+import org.apache.commons.compress.archivers.ArchiveInputStream;
+import org.apache.commons.compress.archivers.ArchiveStreamFactory;
+import org.apache.commons.compress.archivers.sevenz.SevenZFile;
+import org.apache.commons.compress.archivers.zip.ZipArchiveEntry;
+import org.apache.commons.compress.archivers.zip.ZipFile;
+import org.apache.commons.compress.compressors.CompressorException;
+import org.apache.commons.compress.compressors.CompressorStreamFactory;
+
 import java.io.Closeable;
 import java.io.FileInputStream;
 import java.io.IOException;
@@ -41,16 +51,6 @@ import java.util.Collections;
 import java.util.Enumeration;
 import java.util.List;
 
-import org.apache.commons.compress.archivers.ArchiveEntry;
-import org.apache.commons.compress.archivers.ArchiveException;
-import org.apache.commons.compress.archivers.ArchiveInputStream;
-import org.apache.commons.compress.archivers.ArchiveStreamFactory;
-import org.apache.commons.compress.archivers.sevenz.SevenZFile;
-import org.apache.commons.compress.archivers.zip.ZipArchiveEntry;
-import org.apache.commons.compress.archivers.zip.ZipFile;
-import org.apache.commons.compress.compressors.CompressorException;
-import org.apache.commons.compress.compressors.CompressorStreamFactory;
-
 /**
  * To handle to all of supported support types of archive or compressed+archive files.
  * @param <T> the archive class such as SevenZFile, ZipFile, ArchiveInputStream etc.
@@ -129,17 +129,14 @@ abstract class ArchiveHandle<T> implements Closeable {
     }
 
     /**
-     * Neither SevenZFile nor ArchiveInputStream likes ZipFile that has the API
-     * getInputStream(ArchiveEntry), rewind or reset, so it needs to close the
-     * current instance and recreate a new one.
+     * Gets an InputStream for reading the contents of the given entry.
      *
-     * @param archiveEntry the target entry
-     * @return the input stream related to archiveEntry
-     * @throws IOException invalid file descriptor may raise the IOException
-     * @throws CompressorException invalid compress name may raise the CompressException
-     * @throws ArchiveException invalid Archive name may raise the ArchiveException
+     * @throws IOException         if there is an error when reading the archive file, or if the
+     *                             given entry is an encrypted file (in a 7Z or a ZIP archive).
+     * @throws CompressorException if there is an error while decompressing the archive data.
+     * @throws ArchiveException    if there is an error with archive format itself.
      */
-    protected InputStream getInputStream(@NonNull ArchiveEntry archiveEntry)
+    protected @NonNull InputStream getInputStream(@NonNull ArchiveEntry archiveEntry)
             throws IOException, CompressorException, ArchiveException {
 
         if (!isCommonArchiveSupportGetInputStream()) {
diff --git a/src/com/android/documentsui/archives/ArchivesProvider.java b/src/com/android/documentsui/archives/ArchivesProvider.java
index dd221f416..437b8eb36 100644
--- a/src/com/android/documentsui/archives/ArchivesProvider.java
+++ b/src/com/android/documentsui/archives/ArchivesProvider.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.archives;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.ContentProviderClient;
 import android.content.res.AssetFileDescriptor;
 import android.database.Cursor;
@@ -116,8 +118,9 @@ public class ArchivesProvider extends DocumentsProvider {
                 // Return an empty cursor with EXTRA_LOADING, which shows spinner
                 // in DocumentsUI. Once the archive is loaded, the notification will
                 // be sent, and the directory reloaded.
-                bundle.putString(DocumentsContract.EXTRA_ERROR,
-                        getContext().getString(R.string.archive_loading_failed));
+                bundle.putString(
+                        DocumentsContract.EXTRA_ERROR,
+                        getContext().getString(getRes(R.string.archive_loading_failed)));
                 break;
         }
 
diff --git a/src/com/android/documentsui/archives/ReadableArchive.java b/src/com/android/documentsui/archives/ReadableArchive.java
index ad9c8242e..d8d3c3cff 100644
--- a/src/com/android/documentsui/archives/ReadableArchive.java
+++ b/src/com/android/documentsui/archives/ReadableArchive.java
@@ -20,6 +20,8 @@ import static android.os.ParcelFileDescriptor.MODE_READ_ONLY;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 
+import static java.util.Collections.unmodifiableList;
+
 import android.content.Context;
 import android.content.res.AssetFileDescriptor;
 import android.graphics.Point;
@@ -64,6 +66,8 @@ import java.util.Stack;
 public class ReadableArchive extends Archive {
     private static final String TAG = "ReadableArchive";
 
+    // All the archive entries, in the order they are listed in the archive.
+    private final List<ArchiveEntry> mAllEntries = new ArrayList<>();
     private final StorageManager mStorageManager;
     private final ArchiveHandle mArchiveHandle;
     private final ParcelFileDescriptor mParcelFileDescriptor;
@@ -98,6 +102,8 @@ public class ReadableArchive extends Archive {
         final Stack<ArchiveEntry> stack = new Stack<>();
         while (it.hasMoreElements()) {
             entry = it.nextElement();
+            mAllEntries.add(entry);
+
             if (entry.isDirectory() != entry.getName().endsWith("/")) {
                 if (DEBUG) {
                     Log.d(TAG, "directory entry doesn't end with /");
@@ -188,19 +194,21 @@ public class ReadableArchive extends Archive {
     }
 
     /**
-     * Creates a DocumentsArchive instance for opening, browsing and accessing
-     * documents within the archive passed as a file descriptor.
+     * Creates a ReadableArchive instance for opening, browsing and accessing documents within
+     * the archive passed as a file descriptor.
      * <p>
      * If the file descriptor is not seekable, then a snapshot will be created.
      * </p><p>
      * This method takes ownership for the passed descriptor. The caller must
      * not use it after passing.
      * </p>
-     * @param context Context of the provider.
-     * @param descriptor File descriptor for the archive's contents.
-     * @param archiveUri Uri of the archive document.
-     * @param accessMode Access mode for the archive {@see ParcelFileDescriptor}.
-     * @param notificationUri notificationUri Uri for notifying that the archive file has changed.
+     *
+     * @param context         Context of the provider.
+     * @param descriptor      File descriptor for the archive's contents.
+     * @param archiveUri      URI of the archive document.
+     * @param archiveMimeType MIME type of the archive document.
+     * @param accessMode      Access mode for the archive {@see ParcelFileDescriptor}.
+     * @param notificationUri URI for notifying that the archive file has changed.
      */
     public static ReadableArchive createForParcelFileDescriptor(
             Context context, ParcelFileDescriptor descriptor, Uri archiveUri,
@@ -340,6 +348,20 @@ public class ReadableArchive extends Archive {
                 openDocument(documentId, "r", signal), 0, entry.getSize(), null);
     }
 
+    /**
+     * Gets the unmodifiable list of all the entries of this archive, in the original order they are
+     * stored in the archive.
+     */
+    public List<ArchiveEntry> getEntries() {
+        return unmodifiableList(mAllEntries);
+    }
+
+    /** Gets an InputStream for reading the contents of the given entry. */
+    public @NonNull InputStream getInputStream(@NonNull ArchiveEntry entry)
+            throws IOException, CompressorException, ArchiveException {
+        return mArchiveHandle.getInputStream(entry);
+    }
+
     /**
      * Closes an archive.
      *
diff --git a/src/com/android/documentsui/base/DebugHelper.java b/src/com/android/documentsui/base/DebugHelper.java
index 201f7257f..2ac0357e4 100644
--- a/src/com/android/documentsui/base/DebugHelper.java
+++ b/src/com/android/documentsui/base/DebugHelper.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.base;
 
 import static com.android.documentsui.base.SharedMinimal.VERBOSE;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.util.Log;
 import android.util.Pair;
@@ -43,11 +44,7 @@ public class DebugHelper {
             {0xFF4885ed, 0xFF0D47A1}
     };
 
-    @SuppressWarnings("unchecked")
-    private static final Pair<String, Integer>[] sMessages = new Pair[]{
-            new Pair<>("Woof Woof", R.drawable.debug_msg_1),
-            new Pair<>("", R.drawable.debug_msg_2)
-    };
+    private final Pair<String, Integer>[] mMessages;
 
     private final Injector<?> mInjector;
 
@@ -60,6 +57,14 @@ public class DebugHelper {
 
     public DebugHelper(Injector<?> injector) {
         mInjector = injector;
+
+        @SuppressWarnings("unchecked")
+        Pair<String, Integer>[] messages =
+                new Pair[] {
+                    new Pair<>("Woof Woof", getRes(R.drawable.debug_msg_1)),
+                    new Pair<>("", getRes(R.drawable.debug_msg_2))
+                };
+        mMessages = messages;
     }
 
     public int[] getNextColors() {
@@ -75,11 +80,11 @@ public class DebugHelper {
     public Pair<String, Integer> getNextMessage() {
         assert (mInjector.features.isDebugSupportEnabled());
 
-        if (mMessageIndex == sMessages.length) {
+        if (mMessageIndex == mMessages.length) {
             mMessageIndex = 0;
         }
 
-        return sMessages[mMessageIndex++];
+        return mMessages[mMessageIndex++];
     }
 
     public void debugCheck(long time, int keyCode) {
diff --git a/src/com/android/documentsui/base/DocumentInfo.java b/src/com/android/documentsui/base/DocumentInfo.java
index 6306f14f1..cd6f58bfa 100644
--- a/src/com/android/documentsui/base/DocumentInfo.java
+++ b/src/com/android/documentsui/base/DocumentInfo.java
@@ -17,7 +17,7 @@
 package com.android.documentsui.base;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
-import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
+import static com.android.documentsui.base.SharedMinimal.redact;
 
 import android.content.ContentProviderClient;
 import android.content.ContentResolver;
@@ -236,7 +236,7 @@ public class DocumentInfo implements Durable, Parcelable {
         return "DocumentInfo{"
                 + "docId=" + documentId
                 + ", userId=" + userId
-                + ", name=" + displayName
+                + ", displayName=" + displayName
                 + ", mimeType=" + mimeType
                 + ", isContainer=" + isContainer()
                 + ", isDirectory=" + isDirectory()
@@ -320,8 +320,7 @@ public class DocumentInfo implements Durable, Parcelable {
 
     // Containers are documents which can be opened in DocumentsUI as folders.
     public boolean isContainer() {
-        return isDirectory() || (isArchive() && !isPartial() && (isZipNgFlagEnabled()
-                || !isInArchive()));
+        return isDirectory() || (isArchive() && !isPartial() && !isInArchive());
     }
 
     public boolean isVirtual() {
@@ -446,10 +445,8 @@ public class DocumentInfo implements Durable, Parcelable {
             final String type = resolver.getType(uri);
             if (type != null) {
                 mimeTypes.add(type);
-            } else {
-                if (DEBUG) {
-                    Log.d(TAG, "resolver.getType(uri) return null, url:" + uri.toSafeString());
-                }
+            } else if (DEBUG) {
+                Log.d(TAG, "resolver.getType(" + redact(uri) + ") returned null");
             }
             final String[] streamTypes = resolver.getStreamTypes(uri, "*/*");
             if (streamTypes != null) {
diff --git a/src/com/android/documentsui/base/Events.java b/src/com/android/documentsui/base/Events.java
index 1e6be6c3c..f17228eea 100644
--- a/src/com/android/documentsui/base/Events.java
+++ b/src/com/android/documentsui/base/Events.java
@@ -16,6 +16,7 @@
 
 package com.android.documentsui.base;
 
+import android.view.InputDevice;
 import android.view.KeyEvent;
 import android.view.MotionEvent;
 
@@ -24,8 +25,18 @@ import android.view.MotionEvent;
  */
 public final class Events {
 
-    public static boolean isMouseEvent(MotionEvent e) {
-        return e.getToolType(0) == MotionEvent.TOOL_TYPE_MOUSE;
+    public static boolean isMousyEvent(MotionEvent e) {
+        int toolType = e.getToolType(0);
+        if (toolType == MotionEvent.TOOL_TYPE_MOUSE) {
+            return true;
+        } else if (toolType == MotionEvent.TOOL_TYPE_FINGER) {
+            // For compatibility reasons, some touchpads (but not on ChromeOS
+            // ARC devices) fire SOURCE_MOUSE and TOOL_TYPE_FINGER events even
+            // though the source should be SOURCE_TOUCHPAD and the tool type
+            // could arguably be TOOL_TYPE_MOUSE.
+            return e.getSource() == InputDevice.SOURCE_MOUSE;
+        }
+        return false;
     }
 
     public static boolean isActionDown(MotionEvent e) {
diff --git a/src/com/android/documentsui/base/FolderInfo.kt b/src/com/android/documentsui/base/FolderInfo.kt
new file mode 100644
index 000000000..5012e8042
--- /dev/null
+++ b/src/com/android/documentsui/base/FolderInfo.kt
@@ -0,0 +1,47 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.base
+
+/**
+ * Represents core information about folder that is to be searched or listed. The reason this
+ * class exists is so that we can represent root or nested folders for search. The existing
+ * classes, RootInfo and DocumentInfo do not share common ancestor, and thus cannot be used
+ * interchangeably. Additionally the "folderId" is rootId for the RootInfo, but documentId for
+ * DocumentInfo.
+ */
+data class FolderInfo(
+    val folderId: String,
+    val authority: String,
+    // Specifies whether the Root this folder exists on supports search result limiting: this can
+    // help to find more search results (increasing the limit) or improve performance (decreasing
+    // the limit). We could just send the limit regardless of whether the root says it supports this
+    // but this allows SearchLoader to be judicious and not starting sending new parameters that
+    // it hasn't done in the past.
+    //
+    // TODO(b:419704219) remove this property when RootInfo/DocumentInfo have a shared interface.
+    val supportsSearchResultLimiting: Boolean
+) {
+    constructor(rootInfo: RootInfo) : this(
+        rootInfo.rootId,
+        rootInfo.authority,
+        rootInfo.supportsSearchResultLimit()
+    )
+    constructor(folder: DocumentInfo, folderRoot: RootInfo) : this(
+        folder.documentId,
+        folder.authority,
+        folderRoot.supportsSearchResultLimit()
+    )
+}
diff --git a/src/com/android/documentsui/base/RootInfo.java b/src/com/android/documentsui/base/RootInfo.java
index df1dfee46..3527f9e3d 100644
--- a/src/com/android/documentsui/base/RootInfo.java
+++ b/src/com/android/documentsui/base/RootInfo.java
@@ -23,7 +23,9 @@ import static com.android.documentsui.base.DocumentInfo.getCursorLong;
 import static com.android.documentsui.base.DocumentInfo.getCursorString;
 import static com.android.documentsui.base.Shared.compareToIgnoreCaseNullable;
 import static com.android.documentsui.base.SharedMinimal.VERBOSE;
+import static com.android.documentsui.util.Material3Config.getRes;
 
+import android.content.ContentResolver;
 import android.content.Context;
 import android.database.Cursor;
 import android.graphics.drawable.Drawable;
@@ -246,19 +248,19 @@ public class RootInfo implements Durable, Parcelable, Comparable<RootInfo> {
 
         if (isMtp()) {
             derivedType = TYPE_MTP;
-            derivedIcon = R.drawable.ic_usb_storage;
+            derivedIcon = getRes(R.drawable.ic_usb_storage);
         } else if (isUsb()) {
             derivedType = TYPE_USB;
-            derivedIcon = R.drawable.ic_usb_storage;
+            derivedIcon = getRes(R.drawable.ic_usb_storage);
         } else if (isSd()) {
             derivedType = TYPE_SD;
-            derivedIcon = R.drawable.ic_sd_storage;
+            derivedIcon = getRes(R.drawable.ic_sd_storage);
         } else if (isExternalStorage()) {
             derivedType = TYPE_LOCAL;
-            derivedIcon = R.drawable.ic_root_smartphone;
+            derivedIcon = getRes(R.drawable.ic_root_smartphone);
         } else if (isDownloads()) {
             derivedType = TYPE_DOWNLOADS;
-            derivedIcon = R.drawable.ic_root_download;
+            derivedIcon = getRes(R.drawable.ic_root_download);
         } else if (isImages()) {
             derivedType = TYPE_IMAGES;
             derivedIcon = LOAD_FROM_CONTENT_RESOLVER;
@@ -278,7 +280,7 @@ public class RootInfo implements Durable, Parcelable, Comparable<RootInfo> {
             derivedType = TYPE_RECENTS;
         } else if (isBugReport()) {
             derivedType = TYPE_OTHER;
-            derivedIcon = R.drawable.ic_root_bugreport;
+            derivedIcon = getRes(R.drawable.ic_root_bugreport);
         } else {
             derivedType = TYPE_OTHER;
         }
@@ -389,6 +391,14 @@ public class RootInfo implements Durable, Parcelable, Comparable<RootInfo> {
         return queryArgs != null && queryArgs.contains(QUERY_ARG_MIME_TYPES);
     }
 
+    /**
+     * Returns true if the DocumentsProvider hosting this root supports us specifying a limit for
+     * the maximum number of search results it should return.
+     */
+    public boolean supportsSearchResultLimit() {
+        return queryArgs != null && queryArgs.contains(ContentResolver.QUERY_ARG_LIMIT);
+    }
+
     public boolean supportsEject() {
         return (flags & Root.FLAG_SUPPORTS_EJECT) != 0;
     }
@@ -446,17 +456,18 @@ public class RootInfo implements Durable, Parcelable, Comparable<RootInfo> {
 
     public Drawable loadDrawerIcon(Context context, boolean maybeShowBadge) {
         if (derivedIcon == LOAD_FROM_CONTENT_RESOLVER) {
-            return IconUtils.applyTintColor(context, loadMimeTypeIcon(context),
-                    R.color.item_root_icon);
+            return IconUtils.applyTintColor(
+                    context, loadMimeTypeIcon(context), getRes(R.color.item_root_icon));
         } else if (derivedIcon != 0) {
-            return IconUtils.applyTintColor(context, derivedIcon, R.color.item_root_icon);
+            return IconUtils.applyTintColor(context, derivedIcon, getRes(R.color.item_root_icon));
         } else {
             return IconUtils.loadPackageIcon(context, userId, authority, icon, maybeShowBadge);
         }
     }
 
     public Drawable loadEjectIcon(Context context) {
-        return IconUtils.applyTintColor(context, R.drawable.ic_eject, R.color.item_action_icon);
+        return IconUtils.applyTintColor(
+                context, getRes(R.drawable.ic_eject), getRes(R.color.item_action_icon));
     }
 
     @Override
diff --git a/src/com/android/documentsui/base/Shared.java b/src/com/android/documentsui/base/Shared.java
index ac089999f..4b9fbfa96 100644
--- a/src/com/android/documentsui/base/Shared.java
+++ b/src/com/android/documentsui/base/Shared.java
@@ -16,8 +16,12 @@
 
 package com.android.documentsui.base;
 
-import static com.android.documentsui.base.SharedMinimal.TAG;
+import static android.text.TextUtils.SAFE_STRING_FLAG_SINGLE_LINE;
+import static android.text.TextUtils.SAFE_STRING_FLAG_TRIM;
+
 import static com.android.documentsui.ChangeIds.RESTRICT_STORAGE_ACCESS_FRAMEWORK;
+import static com.android.documentsui.base.SharedMinimal.TAG;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Activity;
 import android.app.compat.CompatChanges;
@@ -265,8 +269,8 @@ public final class Shared {
      * @return the calling app name or general anonymous name if not found
      */
     @NonNull
-    public static String getCallingAppName(Activity activity) {
-        final String anonymous = activity.getString(R.string.anonymous_application);
+    public static CharSequence getCallingAppName(Activity activity) {
+        final String anonymous = activity.getString(getRes(R.string.anonymous_application));
         final String packageName = getCallingPackageName(activity);
         if (TextUtils.isEmpty(packageName)) {
             return anonymous;
@@ -281,7 +285,12 @@ public final class Shared {
         }
 
         CharSequence result = pm.getApplicationLabel(ai);
-        return TextUtils.isEmpty(result) ? anonymous : result.toString();
+        if (TextUtils.isEmpty(result)) {
+            return anonymous;
+        }
+
+        return TextUtils.makeSafeForPresentation(
+                result.toString(), 500, 0, SAFE_STRING_FLAG_TRIM | SAFE_STRING_FLAG_SINGLE_LINE);
     }
 
     /**
diff --git a/src/com/android/documentsui/base/SharedMinimal.java b/src/com/android/documentsui/base/SharedMinimal.java
index 86b660873..d746d2371 100644
--- a/src/com/android/documentsui/base/SharedMinimal.java
+++ b/src/com/android/documentsui/base/SharedMinimal.java
@@ -16,6 +16,7 @@
 
 package com.android.documentsui.base;
 
+import android.net.Uri;
 import android.os.Build;
 import android.util.Log;
 
@@ -36,4 +37,20 @@ public final class SharedMinimal {
     private SharedMinimal() {
         throw new UnsupportedOperationException("provides static fields only");
     }
+
+    /**
+     * Gets a redacted string representation of the given object. Can be used to redact file names,
+     * file paths or URIs in log messages.
+     */
+    public static String redact(Object o) {
+        if (o == null) return "(null)";
+
+        if (DEBUG) {
+            if (o instanceof Uri) return o.toString();
+            return "'" + o.toString() + "'";
+        }
+
+        if (o instanceof Uri) return ((Uri) o).toSafeString();
+        return "(redacted)";
+    }
 }
diff --git a/src/com/android/documentsui/clipping/RuntimeDocumentClipper.java b/src/com/android/documentsui/clipping/RuntimeDocumentClipper.java
index d6c0bd53b..fdec8164f 100644
--- a/src/com/android/documentsui/clipping/RuntimeDocumentClipper.java
+++ b/src/com/android/documentsui/clipping/RuntimeDocumentClipper.java
@@ -31,7 +31,6 @@ import androidx.recyclerview.selection.Selection;
 
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.DocumentStack;
-import com.android.documentsui.base.Features;
 import com.android.documentsui.base.Shared;
 import com.android.documentsui.services.FileOperation;
 import com.android.documentsui.services.FileOperationService;
@@ -240,7 +239,13 @@ final class RuntimeDocumentClipper implements DocumentClipper {
             @Nullable ClipData clipData,
             FileOperations.Callback callback) {
 
-        DocumentStack dstStack = new DocumentStack(docStack, destination);
+        // In the case where a destination is actually a root, the docStack contains a single value
+        // of the root. We can avoid copying and recreating a new `DocumentStack` here as the
+        // `docStack` is sufficiently describing the destination.
+        DocumentStack dstStack =
+                (docStack != null && docStack.size() == 1 && docStack.get(0).equals(destination))
+                        ? docStack
+                        : new DocumentStack(docStack, destination);
         copyFromClipData(dstStack, clipData, callback);
     }
 
diff --git a/src/com/android/documentsui/dirlist/AccessibilityEventRouter.java b/src/com/android/documentsui/dirlist/AccessibilityEventRouter.java
index f235159ed..289a4d7e3 100644
--- a/src/com/android/documentsui/dirlist/AccessibilityEventRouter.java
+++ b/src/com/android/documentsui/dirlist/AccessibilityEventRouter.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.dirlist;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.os.Bundle;
 import android.view.View;
 
@@ -28,6 +30,8 @@ import androidx.recyclerview.widget.RecyclerView;
 import androidx.recyclerview.widget.RecyclerViewAccessibilityDelegate;
 
 import com.android.documentsui.BreadcrumbHolder;
+import com.android.documentsui.R;
+import com.android.documentsui.base.State;
 
 import java.util.function.Function;
 
@@ -53,7 +57,8 @@ public class AccessibilityEventRouter extends RecyclerViewAccessibilityDelegate
 
     public AccessibilityEventRouter(
             RecyclerView recyclerView, @NonNull Function<View, Boolean> clickCallback,
-            @Nullable Function<View, Boolean> longClickCallback) {
+            @Nullable Function<View, Boolean> longClickCallback,
+            @State.ActionType int actionType) {
         super(recyclerView);
         mClickCallback = clickCallback;
         mLongClickCallback = longClickCallback;
@@ -67,7 +72,11 @@ public class AccessibilityEventRouter extends RecyclerViewAccessibilityDelegate
                 // is null, it can't be clicked
                 if (holder instanceof DocumentHolder) {
                     if (((DocumentHolder) holder).getItemDetails() != null) {
-                        addAction(info);
+                        if (isUseMaterial3FlagEnabled()) {
+                            addActionForDocumentHolder(info, host, actionType);
+                        } else {
+                            addAction(info);
+                        }
                     }
                 } else if (holder instanceof BreadcrumbHolder) {
                     if (!((BreadcrumbHolder) holder).isLast()) {
@@ -104,4 +113,63 @@ public class AccessibilityEventRouter extends RecyclerViewAccessibilityDelegate
             info.addAction(AccessibilityNodeInfoCompat.ACTION_LONG_CLICK);
         }
     }
+
+    private void addActionForDocumentHolder(AccessibilityNodeInfoCompat info, View host,
+            @State.ActionType int actionType) {
+        // The click and long click actions behave differently based on its selection state
+        // and app intent action mode (e.g. browsing/picker mode):
+        // * browsing:
+        //      * for unselected document: click -> open, long click -> select
+        //      * for selected document: click -> deselect, long click -> drag
+        // * picker:
+        //      * for unselected document: click -> select, long click -> select multiple
+        //      * for selected document: click -> deselect, long click -> no op
+
+        String clickDescription =
+                host.getResources().getString(R.string.document_click_action);
+        String longClickDescription =
+                host.getResources().getString(R.string.document_long_click_action);
+        String clickForSelectedDescription =
+                host.getResources().getString(R.string.selected_document_click_action);
+        String longClickForSelectedDescription =
+                host.getResources().getString(R.string.selected_document_long_click_action);
+        String clickPickerDescription =
+                host.getResources().getString(R.string.document_long_click_action);
+        String longClickPickerDescription =
+                host.getResources().getString(R.string.document_long_click_action_picker);
+        String clickForSelectedPickerDescription =
+                host.getResources().getString(R.string.selected_document_click_action);
+
+        final boolean isBrowsingMode = actionType == State.ACTION_BROWSE;
+        final boolean isSelected = host.isActivated();
+        final boolean isLongClickSupported = mLongClickCallback != null;
+        String clickActionDescription;
+        String longClickActionDescription;
+        if (isSelected) {
+            clickActionDescription = isBrowsingMode ? clickForSelectedDescription
+                    : clickForSelectedPickerDescription;
+            longClickActionDescription = isBrowsingMode ? longClickForSelectedDescription : "";
+        } else {
+            clickActionDescription = isBrowsingMode ? clickDescription : clickPickerDescription;
+            longClickActionDescription =
+                    isBrowsingMode ? longClickDescription : longClickPickerDescription;
+        }
+        // Add click action.
+        AccessibilityActionCompat clickAction =
+                new AccessibilityActionCompat(AccessibilityNodeInfoCompat.ACTION_CLICK,
+                        clickActionDescription);
+        info.addAction(clickAction);
+        // Add long click action if supported.
+        if (!isLongClickSupported) {
+            return;
+        }
+        if (longClickActionDescription.isEmpty()) {
+            info.addAction(AccessibilityNodeInfoCompat.ACTION_LONG_CLICK);
+        } else {
+            AccessibilityActionCompat longClickAction =
+                    new AccessibilityActionCompat(AccessibilityNodeInfoCompat.ACTION_LONG_CLICK,
+                            longClickActionDescription);
+            info.addAction(longClickAction);
+        }
+    }
 }
\ No newline at end of file
diff --git a/src/com/android/documentsui/dirlist/AnimationView.java b/src/com/android/documentsui/dirlist/AnimationView.java
index 5813085b3..602490c03 100644
--- a/src/com/android/documentsui/dirlist/AnimationView.java
+++ b/src/com/android/documentsui/dirlist/AnimationView.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.dirlist;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Context;
 import android.os.Bundle;
@@ -122,7 +123,7 @@ public class AnimationView extends LinearLayout {
         setY((mSpan > 0) ? (mPosition * mSpan) : 0);
 
         if (mPosition != 0) {
-            setTranslationZ(getResources().getDimensionPixelSize(R.dimen.dir_elevation));
+            setTranslationZ(getResources().getDimensionPixelSize(getRes(R.dimen.dir_elevation)));
         } else {
             setTranslationZ(0);
         }
diff --git a/src/com/android/documentsui/dirlist/AppsRowManager.java b/src/com/android/documentsui/dirlist/AppsRowManager.java
index eb0d8bf2e..dd4aaa935 100644
--- a/src/com/android/documentsui/dirlist/AppsRowManager.java
+++ b/src/com/android/documentsui/dirlist/AppsRowManager.java
@@ -16,7 +16,7 @@
 
 package com.android.documentsui.dirlist;
 
-import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.text.TextUtils;
 import android.view.LayoutInflater;
@@ -47,7 +47,6 @@ import java.util.Map;
 
 /**
  * A manager class stored apps row chip data list. Data will be synced by RootsFragment.
- * TODO(b/379776735): Remove this after use_material3 flag is launched.
  */
 public class AppsRowManager {
 
@@ -57,25 +56,36 @@ public class AppsRowManager {
     private final UserIdManager mUserIdManager;
     private final UserManagerState mUserManagerState;
     private final ConfigStore mConfigStore;
-
-    public AppsRowManager(ActionHandler handler, boolean maybeShowBadge,
-            UserIdManager userIdManager, ConfigStore configStore) {
+    private final boolean mShouldShowByDefault;
+
+    public AppsRowManager(
+            ActionHandler handler,
+            boolean maybeShowBadge,
+            UserIdManager userIdManager,
+            ConfigStore configStore,
+            boolean shouldShowByDefault) {
         mDataList = new ArrayList<>();
         mActionHandler = handler;
         mMaybeShowBadge = maybeShowBadge;
         mUserIdManager = userIdManager;
         mUserManagerState = null;
         mConfigStore = configStore;
+        mShouldShowByDefault = shouldShowByDefault;
     }
 
-    public AppsRowManager(ActionHandler handler, boolean maybeShowBadge,
-            UserManagerState userManagerState, ConfigStore configStore) {
+    public AppsRowManager(
+            ActionHandler handler,
+            boolean maybeShowBadge,
+            UserManagerState userManagerState,
+            ConfigStore configStore,
+            boolean shouldShowByDefault) {
         mDataList = new ArrayList<>();
         mActionHandler = handler;
         mMaybeShowBadge = maybeShowBadge;
         mUserIdManager = null;
         mUserManagerState = userManagerState;
         mConfigStore = configStore;
+        mShouldShowByDefault = shouldShowByDefault;
     }
 
     public List<AppsRowItemData> updateList(List<Item> itemList) {
@@ -105,7 +115,7 @@ public class AppsRowManager {
     }
 
     private boolean shouldShow(State state, boolean isSearchExpanded) {
-        if (isUseMaterial3FlagEnabled()) {
+        if (!mShouldShowByDefault) {
             return false;
         }
 
@@ -121,21 +131,21 @@ public class AppsRowManager {
     }
 
     public void updateView(BaseActivity activity) {
-        final View appsRowLayout = activity.findViewById(R.id.apps_row);
+        final View appsRowLayout = activity.findViewById(getRes(R.id.apps_row));
 
         if (!shouldShow(activity.getDisplayState(), activity.isSearchExpanded())) {
             appsRowLayout.setVisibility(View.GONE);
             return;
         }
 
-        final LinearLayout appsGroup = activity.findViewById(R.id.apps_group);
+        final LinearLayout appsGroup = activity.findViewById(getRes(R.id.apps_group));
         appsGroup.removeAllViews();
 
         final LayoutInflater inflater = activity.getLayoutInflater();
         final UserId selectedUser = activity.getSelectedUser();
         for (AppsRowItemData data : mDataList) {
             if (selectedUser.equals(data.getUserId())) {
-                View item = inflater.inflate(R.layout.apps_item, appsGroup, false);
+                View item = inflater.inflate(getRes(R.layout.apps_item), appsGroup, false);
                 bindView(item, data);
                 appsGroup.addView(item);
             }
@@ -145,9 +155,9 @@ public class AppsRowManager {
     }
 
     private void bindView(View view, AppsRowItemData data) {
-        final ImageView app_icon = view.findViewById(R.id.app_icon);
+        final ImageView app_icon = view.findViewById(getRes(R.id.app_icon));
         final TextView title = view.findViewById(android.R.id.title);
-        final TextView summary = view.findViewById(R.id.summary);
+        final TextView summary = view.findViewById(getRes(R.id.summary));
 
         app_icon.setImageDrawable(data.getIconDrawable(view.getContext()));
         title.setText(data.getTitle());
diff --git a/src/com/android/documentsui/dirlist/DirectoryAddonsAdapter.java b/src/com/android/documentsui/dirlist/DirectoryAddonsAdapter.java
index 8be400924..5b4b326cc 100644
--- a/src/com/android/documentsui/dirlist/DirectoryAddonsAdapter.java
+++ b/src/com/android/documentsui/dirlist/DirectoryAddonsAdapter.java
@@ -103,7 +103,8 @@ final class DirectoryAddonsAdapter extends DocumentsAdapter {
                         || getItemViewType(position) == ITEM_TYPE_HEADER_MESSAGE
                         || getItemViewType(position) == ITEM_TYPE_INFLATED_MESSAGE) {
                     return columnCount;
-                } else if (mEnv.getDisplayState().isPhotoPicking()
+                } else if (!isUseMaterial3FlagEnabled()
+                        && mEnv.getDisplayState().isPhotoPicking()
                         && mEnv.getDisplayState().derivedMode == State.MODE_GRID) {
                     // If on photo picking state and grid mode,
                     // the UI should show 3 images a row or 2 folders a row.
diff --git a/src/com/android/documentsui/dirlist/DirectoryFragment.java b/src/com/android/documentsui/dirlist/DirectoryFragment.java
index 2911d04e9..ee7eac8d3 100644
--- a/src/com/android/documentsui/dirlist/DirectoryFragment.java
+++ b/src/com/android/documentsui/dirlist/DirectoryFragment.java
@@ -24,6 +24,7 @@ import static com.android.documentsui.base.State.MODE_LIST;
 import static com.android.documentsui.util.FlagUtils.isDesktopFileHandlingFlagEnabled;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.ActivityManager;
 import android.content.BroadcastReceiver;
@@ -32,6 +33,7 @@ import android.content.Context;
 import android.content.Intent;
 import android.content.IntentFilter;
 import android.content.pm.UserProperties;
+import android.content.res.Resources;
 import android.database.Cursor;
 import android.net.Uri;
 import android.os.Bundle;
@@ -92,6 +94,7 @@ import com.android.documentsui.Metrics;
 import com.android.documentsui.Model;
 import com.android.documentsui.ProfileTabsController;
 import com.android.documentsui.R;
+import com.android.documentsui.SelectionBarController;
 import com.android.documentsui.ThumbnailCache;
 import com.android.documentsui.TimeoutTask;
 import com.android.documentsui.base.DocumentFilters;
@@ -177,9 +180,11 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
     @ContentScoped
     private ActionHandler mActions;
 
-    @Injected
-    @ContentScoped
-    private ActionModeController mActionModeController;
+    // Returns null when the `use_material3` flag is enabled.
+    @Injected @ContentScoped private @Nullable ActionModeController mActionModeController;
+
+    // Returns null when the `use_material3` flag is disabled.
+    @Injected @ContentScoped private @Nullable SelectionBarController mSelectionBarController;
 
     @Injected
     @ContentScoped
@@ -193,6 +198,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
     private IconHelper mIconHelper;
     private SwipeRefreshLayout mRefreshLayout;
     private RecyclerView mRecView;
+    private GridEvenSpacingDecoration mGridEvenSpacingDecoration;
     private DocumentsAdapter mAdapter;
     private DocumentClipper mClipper;
     private GridLayoutManager mLayout;
@@ -434,15 +440,17 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
 
         mHandler = new Handler(Looper.getMainLooper());
         mActivity = (BaseActivity) getActivity();
-        mRootView = (AnimationView) inflater.inflate(R.layout.fragment_directory, container, false);
+        mRootView =
+                (AnimationView)
+                        inflater.inflate(getRes(R.layout.fragment_directory), container, false);
         if (isUseMaterial3FlagEnabled()) {
             mRootView.addOnSizeChangedListener(mOnSizeChangedListener);
         }
 
-        mProgressBar = mRootView.findViewById(R.id.progressbar);
+        mProgressBar = mRootView.findViewById(getRes(R.id.progressbar));
         assert mProgressBar != null;
 
-        mRecView = (RecyclerView) mRootView.findViewById(R.id.dir_list);
+        mRecView = (RecyclerView) mRootView.findViewById(getRes(R.id.dir_list));
         mRecView.setRecyclerListener(
                 new RecyclerListener() {
                     @Override
@@ -451,7 +459,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
                     }
                 });
 
-        mRefreshLayout = (SwipeRefreshLayout) mRootView.findViewById(R.id.refresh_layout);
+        mRefreshLayout = (SwipeRefreshLayout) mRootView.findViewById(getRes(R.id.refresh_layout));
         mRefreshLayout.setOnRefreshListener(this);
         mRecView.setItemAnimator(new DirectoryItemAnimator());
 
@@ -525,6 +533,14 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
 
         mState = mActivity.getDisplayState();
 
+        if (isUseMaterial3FlagEnabled()) {
+            mGridEvenSpacingDecoration = new GridEvenSpacingDecoration();
+            if (mState.derivedMode == MODE_GRID) {
+                // Ensure items are spaced evenly in the grid layout.
+                mRecView.addItemDecoration(mGridEvenSpacingDecoration);
+            }
+        }
+
         // Read arguments when object created for the first time.
         // Restore state if fragment recreated.
         Bundle args = savedInstanceState == null ? getArguments() : savedInstanceState;
@@ -569,7 +585,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         mRecView.setAccessibilityDelegateCompat(
                 new AccessibilityEventRouter(mRecView,
                         (View child) -> onAccessibilityClick(child),
-                        (View child) -> onAccessibilityLongClick(child)));
+                        (View child) -> onAccessibilityLongClick(child), mState.action));
         mSelectionMetadata = new SelectionMetadata(mModel::getItem);
         mDetailsLookup = new DocsItemDetailsLookup(mRecView);
 
@@ -588,22 +604,23 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         {
             // Limiting the scope of the localTracker so nobody uses it.
             // This block initializes/updates the global SelectionTracker held in mSelectionMgr.
-            SelectionTracker<String> localTracker = new SelectionTracker.Builder<>(
-                    mLocalState.mSelectionId,
-                    mRecView,
-                    new DocsStableIdProvider(mAdapter),
-                    mDetailsLookup,
-                    StorageStrategy.createStringStorage())
-                    .withBandOverlay(R.drawable.band_select_overlay)
-                    .withFocusDelegate(mFocusManager)
-                    .withOnDragInitiatedListener(dragStartListener::onDragEvent)
-                    .withOnContextClickListener(this::onContextMenuClick)
-                    .withOnItemActivatedListener(this::onItemActivated)
-                    .withOperationMonitor(mContentLock.getMonitor())
-                    .withSelectionPredicate(selectionPredicate)
-                    .withGestureTooltypes(MotionEvent.TOOL_TYPE_FINGER,
-                            MotionEvent.TOOL_TYPE_STYLUS)
-                    .build();
+            SelectionTracker<String> localTracker =
+                    new SelectionTracker.Builder<>(
+                                    mLocalState.mSelectionId,
+                                    mRecView,
+                                    new DocsStableIdProvider(mAdapter),
+                                    mDetailsLookup,
+                                    StorageStrategy.createStringStorage())
+                            .withBandOverlay(getRes(R.drawable.band_select_overlay))
+                            .withFocusDelegate(mFocusManager)
+                            .withOnDragInitiatedListener(dragStartListener::onDragEvent)
+                            .withOnContextClickListener(this::onContextMenuClick)
+                            .withOnItemActivatedListener(this::onItemActivated)
+                            .withOperationMonitor(mContentLock.getMonitor())
+                            .withSelectionPredicate(selectionPredicate)
+                            .withGestureTooltypes(
+                                    MotionEvent.TOOL_TYPE_FINGER, MotionEvent.TOOL_TYPE_STYLUS)
+                            .build();
             mInjector.updateSharedSelectionTracker(localTracker);
         }
 
@@ -632,8 +649,10 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
                 .attach(mRecView);
 
         if (isUseMaterial3FlagEnabled()) {
-            mSelectionMgr.addObserver(mActivity.getNavigator());
-            mActivity.getNavigator().updateSelection(mSelectionMetadata, this::handleMenuItemClick);
+            mSelectionBarController =
+                    mInjector.getSelectionBarController(
+                            mSelectionMetadata, this::handleMenuItemClick);
+            mSelectionMgr.addObserver(mSelectionBarController);
         } else {
             mActionModeController =
                     mInjector.getActionModeController(
@@ -751,7 +770,12 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
 
     @Override
     public boolean onContextItemSelected(MenuItem item) {
-        return handleMenuItemClick(item);
+        try {
+            return handleMenuItemClick(item);
+        } catch (Exception e) {
+            Log.e(TAG, "Cannot handle menu item " + item.getItemId(), e);
+            return false;
+        }
     }
 
     private void onCopyDestinationPicked(int resultCode, Intent data) {
@@ -805,10 +829,21 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
     }
 
     public void onViewModeChanged() {
+        if (isUseMaterial3FlagEnabled()) {
+            // Only enable the decoration for grid mode.
+            if (mState.derivedMode != MODE_GRID) {
+                mRecView.removeItemDecoration(mGridEvenSpacingDecoration);
+            } else {
+                mRecView.addItemDecoration(mGridEvenSpacingDecoration);
+
+            }
+        }
         // Mode change is just visual change; no need to kick loader.
-        mRootView.announceForAccessibility(getString(
-                mState.derivedMode == State.MODE_GRID ? R.string.grid_mode_showing
-                        : R.string.list_mode_showing));
+        mRootView.announceForAccessibility(
+                getString(
+                        mState.derivedMode == State.MODE_GRID
+                                ? getRes(R.string.grid_mode_showing)
+                                : getRes(R.string.list_mode_showing)));
         onDisplayStateChanged();
     }
 
@@ -824,24 +859,70 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
      */
     private void updateLayout(@ViewMode int mode) {
         mMode = mode;
-        mColumnCount = calculateColumnCount(mode);
-        if (mLayout != null) {
-            mLayout.setSpanCount(mColumnCount);
-        }
-        int pad = getDirectoryPadding(mode);
         mAppBarHeight = getAppBarLayoutHeight();
         mSaveLayoutHeight = getSaveLayoutHeight();
-        mRecView.setPadding(pad, mAppBarHeight, pad, mSaveLayoutHeight);
-        mRecView.requestLayout();
+
+        if (isUseMaterial3FlagEnabled()) {
+            if (mode == MODE_GRID) {
+                int itemMarg =
+                        getResources().getDimensionPixelSize(getRes(R.dimen.grid_item_margin));
+                // Subtract the item's margin since we don't want to double count the margin in the
+                // distance between the outer grid items and the grid boundary.
+                int leftPad =
+                        getResources()
+                                        .getDimensionPixelSize(
+                                                getRes(R.dimen.grid_container_padding_left))
+                                - itemMarg;
+                int topPad =
+                        getResources()
+                                        .getDimensionPixelSize(
+                                                getRes(R.dimen.grid_container_padding_top))
+                                - itemMarg;
+                int rightPad =
+                        getResources()
+                                        .getDimensionPixelSize(
+                                                getRes(R.dimen.grid_container_padding_right))
+                                - itemMarg;
+                int botPad =
+                        getResources()
+                                        .getDimensionPixelSize(
+                                                getRes(R.dimen.grid_container_padding_bottom))
+                                - itemMarg;
+                mRecView.setPadding(leftPad, topPad + mAppBarHeight, rightPad,
+                        botPad + mSaveLayoutHeight);
+            } else {
+                int pad = getDirectoryPadding(mode);
+                mRecView.setPadding(pad, mAppBarHeight, pad, mSaveLayoutHeight);
+            }
+            mColumnCount = calculateColumnCount(mode);
+            if (mLayout != null) {
+                mLayout.setSpanCount(mColumnCount);
+            }
+        } else {
+            mColumnCount = calculateColumnCount(mode);
+            if (mLayout != null) {
+                mLayout.setSpanCount(mColumnCount);
+            }
+            int pad = getDirectoryPadding(mode);
+            mRecView.setPadding(pad, mAppBarHeight, pad, mSaveLayoutHeight);
+        }
+
+        if (isUseMaterial3FlagEnabled() && mRecView.getItemDecorationCount() > 0) {
+            // Invalidate item decorations so they are recalculated before layout. This also
+            // calls requestLayout().
+            mRecView.invalidateItemDecorations();
+        } else {
+            mRecView.requestLayout();
+        }
         mIconHelper.setViewMode(mode);
 
-        int range = getResources().getDimensionPixelOffset(R.dimen.refresh_icon_range);
+        int range = getResources().getDimensionPixelOffset(getRes(R.dimen.refresh_icon_range));
         mRefreshLayout.setProgressViewOffset(true, mAppBarHeight, mAppBarHeight + range);
     }
 
     private int getAppBarLayoutHeight() {
-        View appBarLayout = getActivity().findViewById(R.id.app_bar);
-        View collapsingBar = getActivity().findViewById(R.id.collapsing_toolbar);
+        View appBarLayout = getActivity().findViewById(getRes(R.id.app_bar));
+        View collapsingBar = getActivity().findViewById(getRes(R.id.collapsing_toolbar));
         return collapsingBar == null ? 0 : appBarLayout.getHeight();
     }
 
@@ -850,10 +931,10 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         // but also includes the breadcrumb and the divider, so we need to use the total height
         // for their parent container.
         if (isUseMaterial3FlagEnabled()) {
-            View bottomSection = getActivity().findViewById(R.id.bottom_container);
+            View bottomSection = getActivity().findViewById(getRes(R.id.bottom_container));
             return bottomSection == null ? 0 : bottomSection.getHeight();
         }
-        View containerSave = getActivity().findViewById(R.id.container_save);
+        View containerSave = getActivity().findViewById(getRes(R.id.container_save));
         return containerSave == null ? 0 : containerSave.getHeight();
     }
 
@@ -907,23 +988,36 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
             // List mode is a "grid" with 1 column.
             return 1;
         }
+        Resources resources = getResources();
+        float scaling = isUseMaterial3FlagEnabled() ? 1.0f : mLiveScale;
 
-        int cellWidth = getScaledSize(R.dimen.grid_width);
-        int cellMargin = 2 * getScaledSize(R.dimen.grid_item_margin);
+        int cellWidth =
+                (int) (resources.getDimensionPixelSize(getRes(R.dimen.grid_width)) * scaling);
+        int cellMargin =
+                2
+                        * (int)
+                                (resources.getDimensionPixelSize(getRes(R.dimen.grid_item_margin))
+                                        * scaling);
         int viewPadding =
-                (int) ((mRecView.getPaddingLeft() + mRecView.getPaddingRight()) * mLiveScale);
+                (int) ((mRecView.getPaddingLeft() + mRecView.getPaddingRight()) * scaling);
+        int viewWidth =
+                isUseMaterial3FlagEnabled() ? (int) (mRecView.getMeasuredWidth() * scaling)
+                        : mRecView.getWidth();
 
         // RecyclerView sometimes gets a width of 0 (see b/27150284).
         // Clamp so that we always lay out the grid with at least 2 columns by default.
         // If on photo picking state, the UI should show 3 images a row or 2 folders a row,
         // so use 6 columns by default and set folder size to 3 and document size is to 2.
-        mColumnUnit = mState.isPhotoPicking() ? 3 : 1;
+        mColumnUnit = (!isUseMaterial3FlagEnabled() && mState.isPhotoPicking()) ? 3 : 1;
         int columnCount = mColumnUnit * Math.max(2,
-                (mRecView.getWidth() - viewPadding) / (cellWidth + cellMargin));
+                (viewWidth - viewPadding) / (cellWidth + cellMargin));
 
         // Finally with our grid count logic firmly in place, we apply any live scaling
         // captured by the scale gesture detector.
-        return Math.max(1, Math.round(columnCount / mLiveScale));
+        if (isUseMaterial3FlagEnabled()) {
+            return Math.max(1, (int) Math.floor(columnCount / scaling));
+        }
+        return Math.max(1, Math.round(columnCount / scaling));
     }
 
 
@@ -941,9 +1035,9 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
     private int getDirectoryPadding(@ViewMode int mode) {
         switch (mode) {
             case MODE_GRID:
-                return getResources().getDimensionPixelSize(R.dimen.grid_container_padding);
+                return getResources().getDimensionPixelSize(getRes(R.dimen.grid_container_padding));
             case MODE_LIST:
-                return getResources().getDimensionPixelSize(R.dimen.list_container_padding);
+                return getResources().getDimensionPixelSize(getRes(R.dimen.list_container_padding));
             default:
                 throw new IllegalArgumentException("Unsupported layout mode: " + mode);
         }
@@ -951,7 +1045,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
 
     private void closeSelectionBar() {
         if (isUseMaterial3FlagEnabled()) {
-            mActivity.getNavigator().closeSelectionBar();
+            mSelectionBarController.closeSelectionBar();
         } else {
             mActionModeController.finishActionMode();
         }
@@ -965,8 +1059,8 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         mSelectionMgr.copySelection(selection);
 
         final int id = item.getItemId();
-        if ((isDesktopFileHandlingFlagEnabled() && id == R.id.dir_menu_open)
-                || (isZipNgFlagEnabled() && id == R.id.dir_menu_browse)) {
+        if ((isDesktopFileHandlingFlagEnabled() && id == getRes(R.id.dir_menu_open))
+                || (isZipNgFlagEnabled() && id == getRes(R.id.dir_menu_browse))) {
             // The "Open" menu item is displayed in desktop mode.
             // The "Browse" menu item is displayed for supported archives in advanced ZIP mode.
             // These menu items behave the same as a double click on the matching document which
@@ -974,49 +1068,54 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
             // ItemDetails, we're using viewDocument that takes a Selection.
             viewDocument(selection);
             return true;
-        } else if (id == R.id.action_menu_select || id == R.id.dir_menu_open) {
+        } else if (id == getRes(R.id.action_menu_select) || id == getRes(R.id.dir_menu_open)) {
             // Note: this code path is never executed for `dir_menu_open`. The menu item is always
             // hidden unless the desktopFileHandling flag is enabled, in which case the menu item
             // will be handled by the condition above.
             openDocuments(selection);
             closeSelectionBar();
             return true;
-        } else if (id == R.id.action_menu_open_with || id == R.id.dir_menu_open_with) {
+        } else if (id == getRes(R.id.action_menu_open_with)
+                || id == getRes(R.id.dir_menu_open_with)) {
             showChooserForDoc(selection);
             return true;
-        } else if (id == R.id.dir_menu_open_in_new_window) {
+        } else if (id == getRes(R.id.dir_menu_open_in_new_window)) {
             mActions.openSelectedInNewWindow();
             return true;
-        } else if (id == R.id.action_menu_share || id == R.id.dir_menu_share) {
+        } else if (id == getRes(R.id.action_menu_share) || id == getRes(R.id.dir_menu_share)) {
             mActions.shareSelectedDocuments();
             return true;
-        } else if (id == R.id.action_menu_delete || id == R.id.dir_menu_delete) {
+        } else if (id == getRes(R.id.action_menu_delete) || id == getRes(R.id.dir_menu_delete)) {
             // deleteDocuments will end action mode if the documents are deleted.
             // It won't end action mode if user cancels the delete.
             mActions.showDeleteDialog();
             return true;
-        } else if (id == R.id.action_menu_copy_to) {
+        } else if (id == getRes(R.id.action_menu_copy_to)) {
             transferDocuments(selection, null, FileOperationService.OPERATION_COPY);
             // TODO: Only finish selection mode if copy-to is not canceled.
             // Need to plum down into handling the way we do with deleteDocuments.
             closeSelectionBar();
             return true;
-        } else if (id == R.id.action_menu_compress || id == R.id.dir_menu_compress) {
+        } else if (id == getRes(R.id.action_menu_compress)
+                || id == getRes(R.id.dir_menu_compress)) {
             transferDocuments(selection, mState.stack,
                     FileOperationService.OPERATION_COMPRESS);
             // TODO: Only finish selection mode if compress is not canceled.
             // Need to plum down into handling the way we do with deleteDocuments.
             closeSelectionBar();
             return true;
-
-            // TODO: Implement extract (to the current directory).
-        } else if (id == R.id.action_menu_extract_to || id == R.id.option_menu_extract_all) {
+        } else if (isZipNgFlagEnabled() && id == getRes(R.id.dir_menu_extract_here)) {
+            transferDocuments(selection, mState.stack, FileOperationService.OPERATION_UNPACK);
+            closeSelectionBar();
+            return true;
+        } else if (id == getRes(R.id.action_menu_extract_to)
+                || id == getRes(R.id.option_menu_extract_all)) {
             transferDocuments(selection, null, FileOperationService.OPERATION_EXTRACT);
             // TODO: Only finish selection mode if compress-to is not canceled.
             // Need to plum down into handling the way we do with deleteDocuments.
             closeSelectionBar();
             return true;
-        } else if (id == R.id.action_menu_move_to) {
+        } else if (id == getRes(R.id.action_menu_move_to)) {
             if (mModel.hasDocuments(selection, DocumentFilters.NOT_MOVABLE)) {
                 mInjector.dialogs.showOperationUnsupported();
                 return true;
@@ -1025,7 +1124,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
             closeSelectionBar();
             transferDocuments(selection, null, FileOperationService.OPERATION_MOVE);
             return true;
-        } else if (id == R.id.action_menu_inspect || id == R.id.dir_menu_inspect) {
+        } else if (id == getRes(R.id.action_menu_inspect) || id == getRes(R.id.dir_menu_inspect)) {
             closeSelectionBar();
             assert selection.size() <= 1;
             DocumentInfo doc = selection.isEmpty()
@@ -1034,34 +1133,36 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
 
             mActions.showPreview(doc);
             return true;
-        } else if (id == R.id.dir_menu_cut_to_clipboard) {
+        } else if (id == getRes(R.id.dir_menu_cut_to_clipboard)) {
             mActions.cutToClipboard();
             return true;
-        } else if (id == R.id.dir_menu_copy_to_clipboard) {
+        } else if (id == getRes(R.id.dir_menu_copy_to_clipboard)) {
             mActions.copyToClipboard();
             return true;
-        } else if (id == R.id.dir_menu_paste_from_clipboard) {
+        } else if (id == getRes(R.id.dir_menu_paste_from_clipboard)) {
             pasteFromClipboard();
             return true;
-        } else if (id == R.id.dir_menu_paste_into_folder) {
+        } else if (id == getRes(R.id.dir_menu_paste_into_folder)) {
             pasteIntoFolder();
             return true;
-        } else if (id == R.id.action_menu_select_all || id == R.id.dir_menu_select_all) {
+        } else if (id == getRes(R.id.action_menu_select_all)
+                || id == getRes(R.id.dir_menu_select_all)) {
             mActions.selectAllFiles();
             return true;
-        } else if (id == R.id.action_menu_deselect_all || id == R.id.dir_menu_deselect_all) {
+        } else if (id == getRes(R.id.action_menu_deselect_all)
+                || id == getRes(R.id.dir_menu_deselect_all)) {
             mActions.deselectAllFiles();
             return true;
-        } else if (id == R.id.action_menu_rename || id == R.id.dir_menu_rename) {
+        } else if (id == getRes(R.id.action_menu_rename) || id == getRes(R.id.dir_menu_rename)) {
             renameDocuments(selection);
             return true;
-        } else if (id == R.id.dir_menu_create_dir) {
+        } else if (id == getRes(R.id.dir_menu_create_dir)) {
             mActions.showCreateDirectoryDialog();
             return true;
-        } else if (id == R.id.dir_menu_view_in_owner) {
+        } else if (id == getRes(R.id.dir_menu_view_in_owner)) {
             mActions.viewInOwner();
             return true;
-        } else if (id == R.id.action_menu_sort) {
+        } else if (id == getRes(R.id.action_menu_sort)) {
             mActions.showSortDialog();
             return true;
         }
@@ -1099,7 +1200,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
     }
 
     private void cancelThumbnailTask(View view) {
-        final ImageView iconThumb = (ImageView) view.findViewById(R.id.icon_thumb);
+        final ImageView iconThumb = (ImageView) view.findViewById(getRes(R.id.icon_thumb));
         if (iconThumb != null) {
             mIconHelper.stopLoading(iconThumb);
         }
@@ -1213,16 +1314,16 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         int drawerTitleId;
         switch (mode) {
             case FileOperationService.OPERATION_COPY:
-                drawerTitleId = R.string.menu_copy;
+                drawerTitleId = getRes(R.string.menu_copy);
                 break;
             case FileOperationService.OPERATION_COMPRESS:
-                drawerTitleId = R.string.menu_compress;
+                drawerTitleId = getRes(R.string.menu_compress);
                 break;
             case FileOperationService.OPERATION_EXTRACT:
-                drawerTitleId = R.string.menu_extract;
+                drawerTitleId = getRes(R.string.menu_extract);
                 break;
             case FileOperationService.OPERATION_MOVE:
-                drawerTitleId = R.string.menu_move;
+                drawerTitleId = getRes(R.string.menu_move);
                 break;
             default:
                 throw new UnsupportedOperationException("Unknown mode: " + mode);
@@ -1369,7 +1470,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
             return;
         }
 
-        final View bar = mActivity.findViewById(R.id.collapsing_toolbar);
+        final View bar = mActivity.findViewById(getRes(R.id.collapsing_toolbar));
         if (bar != null) {
             bar.getViewTreeObserver().removeOnPreDrawListener(mToolbarPreDrawListener);
             if (enable) {
@@ -1380,9 +1481,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
 
     public static void showDirectory(
             FragmentManager fm, RootInfo root, DocumentInfo doc, int anim) {
-        if (DEBUG) {
-            Log.d(TAG, "Showing directory: " + DocumentInfo.debugString(doc));
-        }
+        if (DEBUG) Log.d(TAG, "Showing dir " + doc);
         create(fm, root, doc, anim);
     }
 
@@ -1395,14 +1494,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
             RootInfo root,
             @Nullable DocumentInfo doc,
             @AnimationType int anim) {
-
-        if (DEBUG) {
-            if (doc == null) {
-                Log.d(TAG, "Creating new fragment null directory");
-            } else {
-                Log.d(TAG, "Creating new fragment for directory: " + DocumentInfo.debugString(doc));
-            }
-        }
+        if (DEBUG) Log.d(TAG, "Creating new fragment for dir " + doc);
 
         final Bundle args = new Bundle();
         args.putParcelable(Shared.EXTRA_ROOT, root);
@@ -1428,7 +1520,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
     }
 
     private static int getFragmentId() {
-        return R.id.container_directory;
+        return getRes(R.id.container_directory);
     }
 
     /**
@@ -1563,11 +1655,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
                 // For orientation changed case, sometimes the docs loading comes after the menu
                 // update. We need to update the menu here to ensure the status is correct.
                 mInjector.menuManager.updateModel(mModel);
-                if (isUseMaterial3FlagEnabled()) {
-                    mActivity.getNavigator().updateActionMenu();
-                } else {
-                    mInjector.menuManager.updateOptionMenu();
-                }
+                mInjector.menuManager.updateOptionMenu();
                 if (VersionUtils.isAtLeastS()) {
                     mActivity.updateHeader(update.hasCrossProfileException());
                 } else {
@@ -1634,10 +1722,5 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         public ActionHandler getActionHandler() {
             return mActions;
         }
-
-        @Override
-        public String getCallingAppName() {
-            return Shared.getCallingAppName(mActivity);
-        }
     }
 }
diff --git a/src/com/android/documentsui/dirlist/DocumentHolder.java b/src/com/android/documentsui/dirlist/DocumentHolder.java
index 957975c4b..db8eea591 100644
--- a/src/com/android/documentsui/dirlist/DocumentHolder.java
+++ b/src/com/android/documentsui/dirlist/DocumentHolder.java
@@ -19,6 +19,7 @@ package com.android.documentsui.dirlist;
 import static com.android.documentsui.DevicePolicyResources.Strings.PREVIEW_WORK_FILE_ACCESSIBILITY;
 import static com.android.documentsui.DevicePolicyResources.Strings.UNDEFINED;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.Context;
@@ -214,9 +215,12 @@ public abstract class DocumentHolder
         if (SdkLevel.isAtLeastT()) {
             return getUpdatablePreviewIconContentDescription(isNonPersonalProfile, fileName);
         } else {
-            return itemView.getResources().getString(
-                    isNonPersonalProfile ? R.string.preview_work_file : R.string.preview_file,
-                    fileName);
+            return itemView.getResources()
+                    .getString(
+                            isNonPersonalProfile
+                                    ? getRes(R.string.preview_work_file)
+                                    : getRes(R.string.preview_file),
+                            fileName);
         }
     }
 
@@ -227,7 +231,7 @@ public abstract class DocumentHolder
                 DevicePolicyManager.class);
         String updatableStringId = isWorkProfile ? PREVIEW_WORK_FILE_ACCESSIBILITY : UNDEFINED;
         int defaultStringId =
-                isWorkProfile ? R.string.preview_work_file : R.string.preview_file;
+                isWorkProfile ? getRes(R.string.preview_work_file) : getRes(R.string.preview_file);
         return dpm.getResources().getString(
                 updatableStringId,
                 () -> itemView.getResources().getString(defaultStringId, fileName),
diff --git a/src/com/android/documentsui/dirlist/DocumentsAdapter.java b/src/com/android/documentsui/dirlist/DocumentsAdapter.java
index 41ce73c8c..b32c15335 100644
--- a/src/com/android/documentsui/dirlist/DocumentsAdapter.java
+++ b/src/com/android/documentsui/dirlist/DocumentsAdapter.java
@@ -90,7 +90,6 @@ public abstract class DocumentsAdapter extends RecyclerView.Adapter<DocumentHold
         boolean isInSearchMode();
         boolean isSelected(String id);
         Model getModel();
-        String getCallingAppName();
         boolean isDocumentEnabled(String mimeType, int flags);
         void initDocumentHolder(DocumentHolder holder);
         void onBindDocumentHolder(DocumentHolder holder, Cursor cursor);
diff --git a/src/com/android/documentsui/dirlist/DocumentsSwipeRefreshLayout.java b/src/com/android/documentsui/dirlist/DocumentsSwipeRefreshLayout.java
index 64409673e..c487f79a8 100644
--- a/src/com/android/documentsui/dirlist/DocumentsSwipeRefreshLayout.java
+++ b/src/com/android/documentsui/dirlist/DocumentsSwipeRefreshLayout.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.dirlist;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Context;
 import android.content.res.TypedArray;
@@ -59,7 +60,7 @@ public class DocumentsSwipeRefreshLayout extends SwipeRefreshLayout {
             @ColorRes int colorId = a.getResourceId(0, -1);
             if (colorId == -1) {
                 Log.w(TAG, "Retrieve colorAccent colorId from theme fail, assign R.color.primary");
-                colorId = R.color.primary;
+                colorId = getRes(R.color.primary);
             }
             a.recycle();
             setColorSchemeResources(colorId);
diff --git a/src/com/android/documentsui/dirlist/DragHost.java b/src/com/android/documentsui/dirlist/DragHost.java
index de5f7a423..2295073b0 100644
--- a/src/com/android/documentsui/dirlist/DragHost.java
+++ b/src/com/android/documentsui/dirlist/DragHost.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.dirlist;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Activity;
 import android.content.ClipData;
@@ -114,8 +115,7 @@ class DragHost<T extends Activity & AbstractActionHandler.CommonAddons> extends
         boolean dragInitiatedFromDocsUI = mDragAndDropManager.isDragFromSameApp();
         Metrics.logDragInitiated(dragInitiatedFromDocsUI);
         if (!dragInitiatedFromDocsUI) {
-            Snackbar.make(
-                    v, R.string.drag_from_another_app, Snackbar.LENGTH_LONG).show();
+            Snackbar.make(v, getRes(R.string.drag_from_another_app), Snackbar.LENGTH_LONG).show();
             return false;
         }
         return true;
diff --git a/src/com/android/documentsui/dirlist/GridDirectoryHolder.java b/src/com/android/documentsui/dirlist/GridDirectoryHolder.java
index b7a8b6d05..4a6c03b6c 100644
--- a/src/com/android/documentsui/dirlist/GridDirectoryHolder.java
+++ b/src/com/android/documentsui/dirlist/GridDirectoryHolder.java
@@ -19,6 +19,7 @@ package com.android.documentsui.dirlist;
 import static com.android.documentsui.DevicePolicyResources.Drawables.Style.SOLID_COLORED;
 import static com.android.documentsui.DevicePolicyResources.Drawables.WORK_PROFILE_ICON;
 import static com.android.documentsui.base.DocumentInfo.getCursorString;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.Context;
@@ -59,13 +60,13 @@ final class GridDirectoryHolder extends DocumentHolder {
 
     GridDirectoryHolder(
             Context context, ViewGroup parent, IconHelper iconHelper, ConfigStore configStore) {
-        super(context, parent, R.layout.item_dir_grid, configStore);
+        super(context, parent, getRes(R.layout.item_dir_grid), configStore);
 
-        mIconLayout = itemView.findViewById(R.id.icon);
+        mIconLayout = itemView.findViewById(getRes(R.id.icon));
         mTitle = (TextView) itemView.findViewById(android.R.id.title);
-        mIconMime = (ImageView) itemView.findViewById(R.id.icon_mime_sm);
-        mIconCheck = (ImageView) itemView.findViewById(R.id.icon_check);
-        mIconBadge = (ImageView) itemView.findViewById(R.id.icon_profile_badge);
+        mIconMime = (ImageView) itemView.findViewById(getRes(R.id.icon_mime_sm));
+        mIconCheck = (ImageView) itemView.findViewById(getRes(R.id.icon_check));
+        mIconBadge = (ImageView) itemView.findViewById(getRes(R.id.icon_profile_badge));
         mIconMime.setImageDrawable(
                 IconUtils.loadMimeIcon(context, DocumentsContract.Document.MIME_TYPE_DIR));
         mIconHelper = iconHelper;
@@ -78,8 +79,12 @@ final class GridDirectoryHolder extends DocumentHolder {
     @RequiresApi(Build.VERSION_CODES.TIRAMISU)
     private void setUpdatableWorkProfileIcon(Context context) {
         DevicePolicyManager dpm = context.getSystemService(DevicePolicyManager.class);
-        Drawable drawable = dpm.getResources().getDrawable(WORK_PROFILE_ICON, SOLID_COLORED, () ->
-                context.getDrawable(R.drawable.ic_briefcase));
+        Drawable drawable =
+                dpm.getResources()
+                        .getDrawable(
+                                WORK_PROFILE_ICON,
+                                SOLID_COLORED,
+                                () -> context.getDrawable(getRes(R.drawable.ic_briefcase)));
         mIconBadge.setImageDrawable(drawable);
     }
 
diff --git a/src/com/android/documentsui/dirlist/GridDocumentHolder.java b/src/com/android/documentsui/dirlist/GridDocumentHolder.java
index 703f870e2..13d5ef466 100644
--- a/src/com/android/documentsui/dirlist/GridDocumentHolder.java
+++ b/src/com/android/documentsui/dirlist/GridDocumentHolder.java
@@ -22,6 +22,7 @@ import static com.android.documentsui.base.DocumentInfo.getCursorInt;
 import static com.android.documentsui.base.DocumentInfo.getCursorLong;
 import static com.android.documentsui.base.DocumentInfo.getCursorString;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.Context;
@@ -41,7 +42,6 @@ import androidx.annotation.RequiresApi;
 
 import com.android.documentsui.ConfigStore;
 import com.android.documentsui.DocumentsApplication;
-import com.android.documentsui.IconUtils;
 import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.Shared;
@@ -67,59 +67,48 @@ final class GridDocumentHolder extends DocumentHolder {
     // Null when useMaterial3 flag is ON.
     final @Nullable ImageView mIconMimeSm;
     final ImageView mIconThumb;
-    // Null when useMaterial3 flag is ON.
-    final @Nullable ImageView mIconCheck;
+    // Non-null only when useMaterial3 flag is ON.
+    final @Nullable ImageView mSelectionCircle;
+    final ImageView mIconCheck;
     final ImageView mIconBadge;
     final IconHelper mIconHelper;
     // Null when useMaterial3 flag is ON.
     final @Nullable View mIconLayout;
     final View mPreviewIcon;
+    boolean mHasSelectionRegion;
 
     // This is used in as a convenience in our bind method.
     private final DocumentInfo mDoc = new DocumentInfo();
 
     // Non-null only when useMaterial3 flag is ON.
     private final @Nullable MaterialCardView mIconWrapper;
-    // It will be 0 when use_material flag is OFF.
-    private final int mThumbnailStrokeWidth;
 
     GridDocumentHolder(Context context, ViewGroup parent, IconHelper iconHelper,
             ConfigStore configStore) {
-        super(context, parent, R.layout.item_doc_grid, configStore);
+        super(context, parent, getRes(R.layout.item_doc_grid), configStore);
 
         if (isUseMaterial3FlagEnabled()) {
-            mBullet = itemView.findViewById(R.id.bullet);
-            mIconWrapper = itemView.findViewById(R.id.icon_wrapper);
+            mBullet = itemView.findViewById(getRes(R.id.bullet));
+            mIconWrapper = itemView.findViewById(getRes(R.id.icon_wrapper));
+            mSelectionCircle = (ImageView) itemView.findViewById(getRes(R.id.selection_circle));
             mIconLayout = null;
             mIconMimeSm = null;
-            mIconCheck = null;
-            mThumbnailStrokeWidth =
-                    context.getResources()
-                            .getDimensionPixelSize(R.dimen.thumbnail_border_width);
         } else {
             mBullet = null;
             mIconWrapper = null;
-            mIconLayout = itemView.findViewById(R.id.icon);
-            mIconMimeSm = (ImageView) itemView.findViewById(R.id.icon_mime_sm);
-            mIconCheck = (ImageView) itemView.findViewById(R.id.icon_check);
-            mThumbnailStrokeWidth = 0;
+            mSelectionCircle = null;
+            mIconLayout = itemView.findViewById(getRes(R.id.icon));
+            mIconMimeSm = (ImageView) itemView.findViewById(getRes(R.id.icon_mime_sm));
         }
 
         mTitle = (TextView) itemView.findViewById(android.R.id.title);
-        mDate = (TextView) itemView.findViewById(R.id.date);
-        mDetails = (TextView) itemView.findViewById(R.id.details);
-        mIconMimeLg = (ImageView) itemView.findViewById(R.id.icon_mime_lg);
-        mIconThumb = (ImageView) itemView.findViewById(R.id.icon_thumb);
-        mIconBadge = (ImageView) itemView.findViewById(R.id.icon_profile_badge);
-        mPreviewIcon = itemView.findViewById(R.id.preview_icon);
-
-        if (isUseMaterial3FlagEnabled()) {
-            int clipCornerRadius = context.getResources()
-                    .getDimensionPixelSize(R.dimen.thumbnail_clip_corner_radius);
-            IconUtils.applyThumbnailClipOutline(
-                    mIconThumb, mThumbnailStrokeWidth, clipCornerRadius);
-        }
-
+        mDate = (TextView) itemView.findViewById(getRes(R.id.date));
+        mDetails = (TextView) itemView.findViewById(getRes(R.id.details));
+        mIconCheck = (ImageView) itemView.findViewById(getRes(R.id.icon_check));
+        mIconMimeLg = (ImageView) itemView.findViewById(getRes(R.id.icon_mime_lg));
+        mIconThumb = (ImageView) itemView.findViewById(getRes(R.id.icon_thumb));
+        mIconBadge = (ImageView) itemView.findViewById(getRes(R.id.icon_profile_badge));
+        mPreviewIcon = itemView.findViewById(getRes(R.id.preview_icon));
         mIconHelper = iconHelper;
 
         if (SdkLevel.isAtLeastT() && !mConfigStore.isPrivateSpaceInDocsUIEnabled()) {
@@ -130,24 +119,36 @@ final class GridDocumentHolder extends DocumentHolder {
     @RequiresApi(Build.VERSION_CODES.TIRAMISU)
     private void setUpdatableWorkProfileIcon(Context context) {
         DevicePolicyManager dpm = context.getSystemService(DevicePolicyManager.class);
-        Drawable drawable = dpm.getResources().getDrawable(WORK_PROFILE_ICON, SOLID_COLORED, () ->
-                context.getDrawable(R.drawable.ic_briefcase));
+        Drawable drawable =
+                dpm.getResources()
+                        .getDrawable(
+                                WORK_PROFILE_ICON,
+                                SOLID_COLORED,
+                                () -> context.getDrawable(getRes(R.drawable.ic_briefcase)));
         mIconBadge.setImageDrawable(drawable);
     }
 
     @Override
     public void setSelected(boolean selected, boolean animate) {
         float checkAlpha = selected ? 1f : 0f;
-        if (!isUseMaterial3FlagEnabled()) {
-            // We always want to make sure our check box disappears if we're not selected,
-            // even if the item is disabled. This is because this object can be reused
-            // and this method will be called to setup initial state.
-            if (animate) {
+        float circleAlpha = (selected || !isUseMaterial3FlagEnabled()) ? 0f : 1f;
+        // We always want to make sure our check box disappears if we're not selected,
+        // even if the item is disabled. This is because this object can be reused
+        // and this method will be called to setup initial state.
+        if (animate) {
+            if (!isUseMaterial3FlagEnabled()) {
                 fade(mIconMimeSm, checkAlpha).start();
-                fade(mIconCheck, checkAlpha).start();
-            } else {
-                mIconCheck.setAlpha(checkAlpha);
             }
+            if (mHasSelectionRegion) {
+                fade(mSelectionCircle, circleAlpha).start();
+            }
+            fade(mIconCheck, checkAlpha).start();
+        } else {
+            if (mHasSelectionRegion) {
+                mSelectionCircle.setAlpha(circleAlpha);
+            }
+            mIconCheck.setAlpha(checkAlpha);
+
         }
 
 
@@ -165,15 +166,6 @@ final class GridDocumentHolder extends DocumentHolder {
                 mIconMimeSm.setAlpha(1f - checkAlpha);
             }
         }
-
-        // Do not show stroke when selected, only show stroke when not selected if it has thumbnail.
-        if (mIconWrapper != null) {
-            if (selected) {
-                mIconWrapper.setStrokeWidth(0);
-            } else if (mIconThumb.getDrawable() != null) {
-                mIconWrapper.setStrokeWidth(mThumbnailStrokeWidth);
-            }
-        }
     }
 
     @Override
@@ -182,11 +174,13 @@ final class GridDocumentHolder extends DocumentHolder {
 
         float imgAlpha = enabled ? 1f : DISABLED_ALPHA;
 
-        mIconMimeLg.setAlpha(imgAlpha);
-        if (!isUseMaterial3FlagEnabled()) {
+        if (isUseMaterial3FlagEnabled()) {
+            itemView.setAlpha(imgAlpha);
+        } else {
+            mIconMimeLg.setAlpha(imgAlpha);
             mIconMimeSm.setAlpha(imgAlpha);
+            mIconThumb.setAlpha(imgAlpha);
         }
-        mIconThumb.setAlpha(imgAlpha);
     }
 
     @Override
@@ -231,8 +225,11 @@ final class GridDocumentHolder extends DocumentHolder {
     @Override
     public boolean inSelectRegion(MotionEvent event) {
         if (isUseMaterial3FlagEnabled()) {
-            return (mDoc.isDirectory() && !(mAction == State.ACTION_BROWSE)) ? false
-                    : Views.isEventOver(event, itemView.getParent(), mIconWrapper);
+            if (!mHasSelectionRegion) {
+                // There is no selection region.
+                return false;
+            }
+            return Views.isEventOver(event, itemView.getParent(), mSelectionCircle);
         }
         return Views.isEventOver(event, itemView.getParent(), mIconLayout);
     }
@@ -258,6 +255,16 @@ final class GridDocumentHolder extends DocumentHolder {
                 UserId.of(getCursorInt(cursor, RootCursorWrapper.COLUMN_USER_ID)),
                 getCursorString(cursor, RootCursorWrapper.COLUMN_AUTHORITY));
 
+        // Only have a selection region when the Material3 flag is on and if this is in non-browsing
+        // mode, the item must not be a folder.
+        mHasSelectionRegion =
+                isUseMaterial3FlagEnabled() && (!mDoc.isDirectory()
+                        || mAction == State.ACTION_BROWSE);
+
+        if (isUseMaterial3FlagEnabled() && !mHasSelectionRegion) {
+            mSelectionCircle.setVisibility(View.GONE);
+        }
+
         mIconHelper.stopLoading(mIconThumb);
 
         mIconMimeLg.animate().cancel();
@@ -265,35 +272,36 @@ final class GridDocumentHolder extends DocumentHolder {
         mIconThumb.animate().cancel();
         mIconThumb.setAlpha(0f);
 
+        mIconHelper.load(mDoc, mIconThumb, mIconMimeLg, mIconMimeSm);
+
         if (isUseMaterial3FlagEnabled()) {
-            mIconHelper.load(
-                    mDoc, mIconThumb, mIconMimeLg, /* subIconMime= */ null,
-                    thumbnailLoaded -> {
-                        // Show stroke when thumbnail is loaded.
-                        if (mIconWrapper != null) {
-                            mIconWrapper.setStrokeWidth(
-                                    thumbnailLoaded ? mThumbnailStrokeWidth : 0);
-                        }
-                    });
+            // Only Normal type works with ellipsize=middle.
+            mTitle.setText(mDoc.displayName, TextView.BufferType.NORMAL);
         } else {
-            mIconHelper.load(
-                    mDoc, mIconThumb, mIconMimeLg, mIconMimeSm, /* thumbnailLoadedCallback= */
-                    null);
+            mTitle.setText(mDoc.displayName, TextView.BufferType.SPANNABLE);
         }
-
-        mTitle.setText(mDoc.displayName, TextView.BufferType.SPANNABLE);
         mTitle.setVisibility(View.VISIBLE);
+        // Show the full name in a tooltip.
+        itemView.setTooltipText(mDoc.displayName);
 
         // If file is partial, we want to show summary field as that's more relevant than fileSize
         // and date
         if (mDoc.isPartial()) {
             final String docSummary = getCursorString(cursor, Document.COLUMN_SUMMARY);
             mDetails.setVisibility(View.VISIBLE);
-            mDate.setText(null);
+            if (isUseMaterial3FlagEnabled()) {
+                mDate.setVisibility(View.GONE);
+            } else {
+                mDate.setText(null);
+            }
             mDetails.setText(docSummary);
         } else {
             if (mDoc.lastModified == -1) {
-                mDate.setText(null);
+                if (isUseMaterial3FlagEnabled()) {
+                    mDate.setVisibility(View.GONE);
+                } else {
+                    mDate.setText(null);
+                }
             } else {
                 mDate.setText(Shared.formatTime(mContext, mDoc.lastModified));
             }
diff --git a/src/com/android/documentsui/dirlist/GridEvenSpacingDecoration.java b/src/com/android/documentsui/dirlist/GridEvenSpacingDecoration.java
new file mode 100644
index 000000000..c9163e026
--- /dev/null
+++ b/src/com/android/documentsui/dirlist/GridEvenSpacingDecoration.java
@@ -0,0 +1,63 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.dirlist;
+
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
+import android.graphics.Rect;
+import android.view.View;
+import android.view.ViewGroup;
+
+import androidx.recyclerview.widget.GridLayoutManager;
+import androidx.recyclerview.widget.RecyclerView;
+
+/**
+ * RecyclerView ItemDecorator that distributes the horizontal space into equal size buckets
+ * for each item (to match the bounds given by the GridViewLayout) and adds an offset to
+ * either side to centre the item within its bucket. This only works when the layout manager
+ * is GridViewLayout and all items have the same fixed width.
+ */
+public class GridEvenSpacingDecoration extends RecyclerView.ItemDecoration {
+    @Override
+    public void getItemOffsets(Rect outRect, View view, RecyclerView parent,
+            RecyclerView.State state) {
+        if (!isUseMaterial3FlagEnabled()) {
+            return;
+        }
+        RecyclerView.LayoutManager layoutManager = parent.getLayoutManager();
+        if (!(layoutManager instanceof GridLayoutManager)) {
+            return;
+        }
+        ViewGroup.MarginLayoutParams lp = (ViewGroup.MarginLayoutParams) view.getLayoutParams();
+        if (lp.width == ViewGroup.LayoutParams.MATCH_PARENT
+                || lp.width == ViewGroup.LayoutParams.WRAP_CONTENT) {
+            // This item does not have a fixed width.
+            return;
+        }
+        // Distribute the horizontal space into equal size buckets for each item and add an
+        // offset to either side to centre the item within its bucket.
+        int spanCount = ((GridLayoutManager) layoutManager).getSpanCount();
+        int itemWidth = lp.getMarginStart() + lp.width + lp.getMarginEnd();
+        int allocatedGridSpace =
+                (parent.getMeasuredWidth() - parent.getPaddingLeft() - parent.getPaddingRight())
+                        / spanCount;
+        int extraSpace = allocatedGridSpace - itemWidth;
+        int offset = extraSpace / 2;
+        outRect.left = offset;
+        outRect.right = offset;
+    }
+}
diff --git a/src/com/android/documentsui/dirlist/GridPhotoHolder.java b/src/com/android/documentsui/dirlist/GridPhotoHolder.java
index 70c8a6ffc..ee9508790 100644
--- a/src/com/android/documentsui/dirlist/GridPhotoHolder.java
+++ b/src/com/android/documentsui/dirlist/GridPhotoHolder.java
@@ -21,6 +21,7 @@ import static com.android.documentsui.DevicePolicyResources.Drawables.WORK_PROFI
 import static com.android.documentsui.base.DocumentInfo.getCursorInt;
 import static com.android.documentsui.base.DocumentInfo.getCursorLong;
 import static com.android.documentsui.base.DocumentInfo.getCursorString;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.Context;
@@ -49,6 +50,8 @@ import com.android.modules.utils.build.SdkLevel;
 import java.util.Map;
 import java.util.function.Function;
 
+// TODO(b/379776735): remove this file after use_material3 flag is launched.
+// GridDocumentHolder is used for all types of grid items.
 final class GridPhotoHolder extends DocumentHolder {
 
     private final ImageView mIconMimeLg;
@@ -63,13 +66,13 @@ final class GridPhotoHolder extends DocumentHolder {
 
     GridPhotoHolder(Context context, ViewGroup parent, IconHelper iconHelper,
             ConfigStore configStore) {
-        super(context, parent, R.layout.item_photo_grid, configStore);
+        super(context, parent, getRes(R.layout.item_photo_grid), configStore);
 
-        mIconMimeLg = (ImageView) itemView.findViewById(R.id.icon_mime_lg);
-        mIconThumb = (ImageView) itemView.findViewById(R.id.icon_thumb);
-        mIconCheck = (ImageView) itemView.findViewById(R.id.icon_check);
-        mIconBadge = itemView.findViewById(R.id.icon_profile_badge);
-        mPreviewIcon = itemView.findViewById(R.id.preview_icon);
+        mIconMimeLg = (ImageView) itemView.findViewById(getRes(R.id.icon_mime_lg));
+        mIconThumb = (ImageView) itemView.findViewById(getRes(R.id.icon_thumb));
+        mIconCheck = (ImageView) itemView.findViewById(getRes(R.id.icon_check));
+        mIconBadge = itemView.findViewById(getRes(R.id.icon_profile_badge));
+        mPreviewIcon = itemView.findViewById(getRes(R.id.preview_icon));
 
         mIconHelper = iconHelper;
 
@@ -81,10 +84,13 @@ final class GridPhotoHolder extends DocumentHolder {
     @RequiresApi(Build.VERSION_CODES.TIRAMISU)
     private void setUpdatableWorkProfileIcon(Context context) {
         DevicePolicyManager dpm = context.getSystemService(DevicePolicyManager.class);
-        Drawable drawable = dpm.getResources().getDrawable(
-                WORK_PROFILE_ICON, SOLID_NOT_COLORED, () ->
-                        context.getDrawable(R.drawable.ic_briefcase));
-        ImageView icon = (ImageView) mIconBadge.findViewById(R.id.icon_id);
+        Drawable drawable =
+                dpm.getResources()
+                        .getDrawable(
+                                WORK_PROFILE_ICON,
+                                SOLID_NOT_COLORED,
+                                () -> context.getDrawable(getRes(R.drawable.ic_briefcase)));
+        ImageView icon = (ImageView) mIconBadge.findViewById(getRes(R.id.icon_id));
 
         icon.setImageDrawable(drawable);
     }
@@ -143,7 +149,7 @@ final class GridPhotoHolder extends DocumentHolder {
         Map<UserId, Drawable> userIdToBadgeMap = DocumentsApplication.getUserManagerState(
                 mContext).getUserIdToBadgeMap();
         Drawable drawable = userIdToBadgeMap.get(UserId.of(userIdIdentifier));
-        ImageView icon = mIconBadge.findViewById(R.id.icon_id);
+        ImageView icon = mIconBadge.findViewById(getRes(R.id.icon_id));
         icon.setImageDrawable(drawable);
         mIconBadge.setVisibility(show ? View.VISIBLE : View.GONE);
         mIconBadge.setContentDescription(mIconHelper.getProfileLabel(userIdIdentifier));
@@ -189,12 +195,7 @@ final class GridPhotoHolder extends DocumentHolder {
         mIconThumb.animate().cancel();
         mIconThumb.setAlpha(0f);
 
-        mIconHelper.load(
-                mDoc,
-                mIconThumb,
-                mIconMimeLg,
-                /* subIconMime= */ null,
-                /* thumbnailLoadedCallback= */ null);
+        mIconHelper.load(mDoc, mIconThumb, mIconMimeLg, /* subIconMime= */ null);
 
         final String docSize =
                 Formatter.formatFileSize(mContext, getCursorLong(cursor, Document.COLUMN_SIZE));
diff --git a/src/com/android/documentsui/dirlist/HeaderMessageDocumentHolder.java b/src/com/android/documentsui/dirlist/HeaderMessageDocumentHolder.java
index aa4170882..8da5e7207 100644
--- a/src/com/android/documentsui/dirlist/HeaderMessageDocumentHolder.java
+++ b/src/com/android/documentsui/dirlist/HeaderMessageDocumentHolder.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.dirlist;
 
 import static com.android.documentsui.base.State.MODE_GRID;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Context;
 import android.database.Cursor;
@@ -47,16 +48,16 @@ final class HeaderMessageDocumentHolder extends MessageHolder {
     private Message mMessage;
 
     HeaderMessageDocumentHolder(Context context, ViewGroup parent, ConfigStore configStore) {
-        super(context, parent, R.layout.item_doc_header_message, configStore);
+        super(context, parent, getRes(R.layout.item_doc_header_message), configStore);
 
-        mRoot = itemView.findViewById(R.id.item_root);
-        mIcon = (ImageView) itemView.findViewById(R.id.message_icon);
-        mTitle = itemView.findViewById(R.id.message_title);
-        mSubtitle = itemView.findViewById(R.id.message_subtitle);
-        mTextView = (TextView) itemView.findViewById(R.id.message_textview);
-        mActionView = (View) itemView.findViewById(R.id.action_view);
-        mActionButton = (Button) itemView.findViewById(R.id.action_button);
-        mDismissButton = (Button) itemView.findViewById(R.id.dismiss_button);
+        mRoot = itemView.findViewById(getRes(R.id.item_root));
+        mIcon = (ImageView) itemView.findViewById(getRes(R.id.message_icon));
+        mTitle = itemView.findViewById(getRes(R.id.message_title));
+        mSubtitle = itemView.findViewById(getRes(R.id.message_subtitle));
+        mTextView = (TextView) itemView.findViewById(getRes(R.id.message_textview));
+        mActionView = (View) itemView.findViewById(getRes(R.id.action_view));
+        mActionButton = (Button) itemView.findViewById(getRes(R.id.action_button));
+        mDismissButton = (Button) itemView.findViewById(getRes(R.id.dismiss_button));
     }
 
     public void bind(Message message) {
@@ -72,8 +73,12 @@ final class HeaderMessageDocumentHolder extends MessageHolder {
      * display mode changed, we set the opposite padding on the item.
      */
     public void setPadding(@ViewMode int mode) {
-        int padding = itemView.getResources().getDimensionPixelSize(mode == MODE_GRID
-                ? R.dimen.list_container_padding : R.dimen.grid_container_padding);
+        int padding =
+                itemView.getResources()
+                        .getDimensionPixelSize(
+                                mode == MODE_GRID
+                                        ? getRes(R.dimen.list_container_padding)
+                                        : getRes(R.dimen.grid_container_padding));
         mRoot.setPadding(padding, 0, padding, 0);
     }
 
diff --git a/src/com/android/documentsui/dirlist/IconHelper.java b/src/com/android/documentsui/dirlist/IconHelper.java
index 6d53bbee1..0f2599600 100644
--- a/src/com/android/documentsui/dirlist/IconHelper.java
+++ b/src/com/android/documentsui/dirlist/IconHelper.java
@@ -19,6 +19,8 @@ package com.android.documentsui.dirlist;
 import static com.android.documentsui.base.SharedMinimal.VERBOSE;
 import static com.android.documentsui.base.State.MODE_GRID;
 import static com.android.documentsui.base.State.MODE_LIST;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.ActivityManager;
 import android.content.Context;
@@ -51,8 +53,9 @@ import com.android.documentsui.base.State.ViewMode;
 import com.android.documentsui.base.UserId;
 import com.android.modules.utils.build.SdkLevel;
 
+import com.google.android.material.imageview.ShapeableImageView;
+
 import java.util.function.BiConsumer;
-import java.util.function.Consumer;
 
 /**
  * A class to assist with loading and managing the Images (i.e. thumbnails and icons) associated
@@ -73,6 +76,8 @@ public class IconHelper {
     private final UserId mManagedUser;
     private final UserManagerState mUserManagerState;
     private final ConfigStore mConfigStore;
+    // It will be 0 when use_material3 flag is OFF.
+    private final int mThumbnailStrokeWidth;
 
     /**
      * @param mode MODE_GRID or MODE_LIST
@@ -97,6 +102,13 @@ public class IconHelper {
         mMaybeShowBadge = maybeShowBadge;
         mUserManagerState = userManagerState;
         mConfigStore = configStore;
+        if (isUseMaterial3FlagEnabled()) {
+            mThumbnailStrokeWidth =
+                    context.getResources()
+                            .getDimensionPixelSize(getRes(R.dimen.thumbnail_border_width));
+        } else {
+            mThumbnailStrokeWidth = 0;
+        }
     }
 
     /**
@@ -122,11 +134,13 @@ public class IconHelper {
         int thumbSize;
         switch (mode) {
             case MODE_GRID:
-                thumbSize = mContext.getResources().getDimensionPixelSize(R.dimen.grid_width);
+                thumbSize =
+                        mContext.getResources().getDimensionPixelSize(getRes(R.dimen.grid_width));
                 break;
             case MODE_LIST:
-                thumbSize = mContext.getResources().getDimensionPixelSize(
-                        R.dimen.list_item_thumbnail_size);
+                thumbSize =
+                        mContext.getResources()
+                                .getDimensionPixelSize(getRes(R.dimen.list_item_thumbnail_size));
                 break;
             default:
                 throw new IllegalArgumentException("Unsupported layout mode: " + mode);
@@ -152,18 +166,14 @@ public class IconHelper {
      * @param iconThumb   The itemview's thumbnail icon.
      * @param iconMime    The itemview's mime icon. Hidden when iconThumb is shown.
      * @param subIconMime The second itemview's mime icon. Always visible.
-     * @param thumbnailLoadedCallback The callback function which will be invoked after the
-     *                                thumbnail is loaded, with a boolean parameter to indicate
-     *                                if it's loaded or not.
      */
     public void load(
             DocumentInfo doc,
             ImageView iconThumb,
             ImageView iconMime,
-            @Nullable ImageView subIconMime,
-            @Nullable Consumer<Boolean> thumbnailLoadedCallback) {
+            @Nullable ImageView subIconMime) {
         load(doc.derivedUri, doc.userId, doc.mimeType, doc.flags, doc.icon, doc.lastModified,
-                iconThumb, iconMime, subIconMime, thumbnailLoadedCallback);
+                iconThumb, iconMime, subIconMime);
     }
 
     /**
@@ -177,13 +187,10 @@ public class IconHelper {
      * @param iconThumb       The itemview's thumbnail icon.
      * @param iconMime        The itemview's mime icon. Hidden when iconThumb is shown.
      * @param subIconMime     The second itemview's mime icon. Always visible.
-     * @param thumbnailLoadedCallback The callback function which will be invoked after the
-     *                                thumbnail is loaded, with a boolean parameter to indicate
-     *                                if it's loaded or not.
      */
     public void load(Uri uri, UserId userId, String mimeType, int docFlags, int docIcon,
             long docLastModified, ImageView iconThumb, ImageView iconMime,
-            @Nullable ImageView subIconMime, @Nullable Consumer<Boolean> thumbnailLoadedCallback) {
+            @Nullable ImageView subIconMime) {
         boolean loadedThumbnail = false;
 
         final String docAuthority = uri.getAuthority();
@@ -194,14 +201,7 @@ public class IconHelper {
         final boolean showThumbnail = supportsThumbnail && allowThumbnail && mThumbnailsEnabled;
         if (showThumbnail) {
             loadedThumbnail =
-                    loadThumbnail(
-                            uri,
-                            userId,
-                            docAuthority,
-                            docLastModified,
-                            iconThumb,
-                            iconMime,
-                            thumbnailLoadedCallback);
+                    loadThumbnail(uri, userId, docAuthority, docLastModified, iconThumb, iconMime);
         }
 
         final Drawable mimeIcon = getDocumentIcon(mContext, userId, docAuthority,
@@ -211,27 +211,32 @@ public class IconHelper {
         }
 
         if (loadedThumbnail) {
+            if (isUseMaterial3FlagEnabled()) {
+                // Show the thumbnail.
+                iconThumb.setAlpha(1f);
+            }
             hideImageView(iconMime);
         } else {
             // Add a mime icon if the thumbnail is not shown.
             setMimeIcon(iconMime, mimeIcon);
             hideImageView(iconThumb);
         }
-        if (thumbnailLoadedCallback != null) {
-            thumbnailLoadedCallback.accept(loadedThumbnail);
+        if (isUseMaterial3FlagEnabled()) {
+            ((ShapeableImageView) iconThumb)
+                    .setStrokeWidth(loadedThumbnail ? mThumbnailStrokeWidth : 0);
         }
     }
 
     private boolean loadThumbnail(Uri uri, UserId userId, String docAuthority, long docLastModified,
-            ImageView iconThumb, ImageView iconMime,
-            @Nullable Consumer<Boolean> thumbnailLoadedCallback) {
+            ImageView iconThumb, ImageView iconMime) {
         final Result result = mThumbnailCache.getThumbnail(uri, userId, mCurrentSize);
 
         try {
             final Bitmap cachedThumbnail = result.getThumbnail();
             iconThumb.setImageBitmap(cachedThumbnail);
-            if (thumbnailLoadedCallback != null) {
-                thumbnailLoadedCallback.accept(cachedThumbnail != null);
+            if (isUseMaterial3FlagEnabled()) {
+                ((ShapeableImageView) iconThumb)
+                        .setStrokeWidth(cachedThumbnail != null ? mThumbnailStrokeWidth : 0);
             }
 
             boolean stale = (docLastModified > result.getLastModified());
@@ -252,8 +257,9 @@ public class IconHelper {
                                 iconThumb.setImageBitmap(bitmap);
                                 animator.accept(iconMime, iconThumb);
                             }
-                            if (thumbnailLoadedCallback != null) {
-                                thumbnailLoadedCallback.accept(bitmap != null);
+                            if (isUseMaterial3FlagEnabled()) {
+                                ((ShapeableImageView) iconThumb)
+                                        .setStrokeWidth(bitmap != null ? mThumbnailStrokeWidth : 0);
                             }
                         }, true /* addToCache */);
 
diff --git a/src/com/android/documentsui/dirlist/InflateMessageDocumentHolder.java b/src/com/android/documentsui/dirlist/InflateMessageDocumentHolder.java
index 1fbb32b49..247ed3b2f 100644
--- a/src/com/android/documentsui/dirlist/InflateMessageDocumentHolder.java
+++ b/src/com/android/documentsui/dirlist/InflateMessageDocumentHolder.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.dirlist;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.database.Cursor;
 import android.text.TextUtils;
@@ -54,19 +56,19 @@ final class InflateMessageDocumentHolder extends MessageHolder {
     private ProgressBar mCrossProfileProgress;
 
     InflateMessageDocumentHolder(Context context, ViewGroup parent, ConfigStore configStore) {
-        super(context, parent, R.layout.item_doc_inflated_message, configStore);
-        mContentView = itemView.findViewById(R.id.content);
-        mCrossProfileView = itemView.findViewById(R.id.cross_profile);
-        mCrossProfileContent = mCrossProfileView.findViewById(R.id.cross_profile_content);
-        mCrossProfileProgress = mCrossProfileView.findViewById(R.id.cross_profile_progress);
-
-        mContentMessage = mContentView.findViewById(R.id.message);
-        mContentImage = mContentView.findViewById(R.id.artwork);
-
-        mCrossProfileTitle = mCrossProfileView.findViewById(R.id.title);
-        mCrossProfileMessage = mCrossProfileView.findViewById(R.id.message);
-        mCrossProfileImage = mCrossProfileView.findViewById(R.id.artwork);
-        mCrossProfileButton = mCrossProfileView.findViewById(R.id.button);
+        super(context, parent, getRes(R.layout.item_doc_inflated_message), configStore);
+        mContentView = itemView.findViewById(getRes(R.id.content));
+        mCrossProfileView = itemView.findViewById(getRes(R.id.cross_profile));
+        mCrossProfileContent = mCrossProfileView.findViewById(getRes(R.id.cross_profile_content));
+        mCrossProfileProgress = mCrossProfileView.findViewById(getRes(R.id.cross_profile_progress));
+
+        mContentMessage = mContentView.findViewById(getRes(R.id.message));
+        mContentImage = mContentView.findViewById(getRes(R.id.artwork));
+
+        mCrossProfileTitle = mCrossProfileView.findViewById(getRes(R.id.title));
+        mCrossProfileMessage = mCrossProfileView.findViewById(getRes(R.id.message));
+        mCrossProfileImage = mCrossProfileView.findViewById(getRes(R.id.artwork));
+        mCrossProfileButton = mCrossProfileView.findViewById(getRes(R.id.button));
     }
 
     public void bind(Message message) {
diff --git a/src/com/android/documentsui/dirlist/ListDocumentHolder.java b/src/com/android/documentsui/dirlist/ListDocumentHolder.java
index a0db097d0..4e224d362 100644
--- a/src/com/android/documentsui/dirlist/ListDocumentHolder.java
+++ b/src/com/android/documentsui/dirlist/ListDocumentHolder.java
@@ -21,6 +21,7 @@ import static com.android.documentsui.DevicePolicyResources.Drawables.WORK_PROFI
 import static com.android.documentsui.base.DocumentInfo.getCursorInt;
 import static com.android.documentsui.base.DocumentInfo.getCursorString;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.Context;
@@ -43,7 +44,6 @@ import androidx.annotation.RequiresApi;
 
 import com.android.documentsui.ConfigStore;
 import com.android.documentsui.DocumentsApplication;
-import com.android.documentsui.IconUtils;
 import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.Lookup;
@@ -54,8 +54,6 @@ import com.android.documentsui.roots.RootCursorWrapper;
 import com.android.documentsui.ui.Views;
 import com.android.modules.utils.build.SdkLevel;
 
-import com.google.android.material.card.MaterialCardView;
-
 import java.util.ArrayList;
 import java.util.Map;
 import java.util.function.Function;
@@ -71,16 +69,12 @@ final class ListDocumentHolder extends DocumentHolder {
     private final @Nullable LinearLayout mDetails;
     // TextView for date + size + summary, null only for tablets/sw720dp
     private final @Nullable TextView mMetadataView;
-    // Non-null only when use_material3 flag is ON.
-    private final @Nullable MaterialCardView mIconWrapper;
     private final ImageView mIconMime;
     private final ImageView mIconThumb;
     private final ImageView mIconCheck;
     private final ImageView mIconBadge;
     private final View mIconLayout;
     final View mPreviewIcon;
-    // It will be 0 when use_material flag is OFF.
-    private final int mThumbnailStrokeWidth;
 
     private final IconHelper mIconHelper;
     private final Lookup<String, String> mFileTypeLookup;
@@ -89,34 +83,21 @@ final class ListDocumentHolder extends DocumentHolder {
 
     public ListDocumentHolder(Context context, ViewGroup parent, IconHelper iconHelper,
             Lookup<String, String> fileTypeLookup, ConfigStore configStore) {
-        super(context, parent, R.layout.item_doc_list, configStore);
-
-        mIconLayout = itemView.findViewById(R.id.icon);
-        mIconWrapper =
-                isUseMaterial3FlagEnabled() ? itemView.findViewById(R.id.icon_wrapper) : null;
-        mIconMime = (ImageView) itemView.findViewById(R.id.icon_mime);
-        mIconThumb = (ImageView) itemView.findViewById(R.id.icon_thumb);
-        mIconCheck = (ImageView) itemView.findViewById(R.id.icon_check);
-        mIconBadge = (ImageView) itemView.findViewById(R.id.icon_profile_badge);
+        super(context, parent, getRes(R.layout.item_doc_list), configStore);
+
+        mIconLayout = itemView.findViewById(getRes(R.id.icon));
+        mIconMime = (ImageView) itemView.findViewById(getRes(R.id.icon_mime));
+        mIconThumb = (ImageView) itemView.findViewById(getRes(R.id.icon_thumb));
+        mIconCheck = (ImageView) itemView.findViewById(getRes(R.id.icon_check));
+        mIconBadge = (ImageView) itemView.findViewById(getRes(R.id.icon_profile_badge));
         mTitle = (TextView) itemView.findViewById(android.R.id.title);
-        mSize = (TextView) itemView.findViewById(R.id.size);
-        mDate = (TextView) itemView.findViewById(R.id.date);
-        mType = (TextView) itemView.findViewById(R.id.file_type);
-        mMetadataView = (TextView) itemView.findViewById(R.id.metadata);
+        mSize = (TextView) itemView.findViewById(getRes(R.id.size));
+        mDate = (TextView) itemView.findViewById(getRes(R.id.date));
+        mType = (TextView) itemView.findViewById(getRes(R.id.file_type));
+        mMetadataView = (TextView) itemView.findViewById(getRes(R.id.metadata));
         // Warning: mDetails view doesn't exists in layout-sw720dp-land layout
-        mDetails = (LinearLayout) itemView.findViewById(R.id.line2);
-        mPreviewIcon = itemView.findViewById(R.id.preview_icon);
-        if (isUseMaterial3FlagEnabled()) {
-            mThumbnailStrokeWidth =
-                    context.getResources()
-                            .getDimensionPixelSize(R.dimen.thumbnail_border_width);
-            int clipCornerRadius = context.getResources()
-                    .getDimensionPixelSize(R.dimen.thumbnail_clip_corner_radius);
-            IconUtils.applyThumbnailClipOutline(
-                    mIconThumb, mThumbnailStrokeWidth, clipCornerRadius);
-        } else {
-            mThumbnailStrokeWidth = 0;
-        }
+        mDetails = (LinearLayout) itemView.findViewById(getRes(R.id.line2));
+        mPreviewIcon = itemView.findViewById(getRes(R.id.preview_icon));
 
         mIconHelper = iconHelper;
         mFileTypeLookup = fileTypeLookup;
@@ -130,8 +111,12 @@ final class ListDocumentHolder extends DocumentHolder {
     @RequiresApi(Build.VERSION_CODES.TIRAMISU)
     private void setUpdatableWorkProfileIcon(Context context) {
         DevicePolicyManager dpm = context.getSystemService(DevicePolicyManager.class);
-        Drawable drawable = dpm.getResources().getDrawable(WORK_PROFILE_ICON, SOLID_COLORED, () ->
-                context.getDrawable(R.drawable.ic_briefcase));
+        Drawable drawable =
+                dpm.getResources()
+                        .getDrawable(
+                                WORK_PROFILE_ICON,
+                                SOLID_COLORED,
+                                () -> context.getDrawable(getRes(R.drawable.ic_briefcase)));
         mIconBadge.setImageDrawable(drawable);
     }
 
@@ -160,15 +145,6 @@ final class ListDocumentHolder extends DocumentHolder {
             mIconMime.setAlpha(1f - checkAlpha);
             mIconThumb.setAlpha(1f - checkAlpha);
         }
-
-        // Do not show stroke when selected, only show stroke when not selected if it has thumbnail.
-        if (isUseMaterial3FlagEnabled() && mIconWrapper != null) {
-            if (selected) {
-                mIconWrapper.setStrokeWidth(0);
-            } else if (mIconThumb.getDrawable() != null) {
-                mIconWrapper.setStrokeWidth(mThumbnailStrokeWidth);
-            }
-        }
     }
 
     @Override
@@ -277,20 +253,25 @@ final class ListDocumentHolder extends DocumentHolder {
         mIconThumb.animate().cancel();
         mIconThumb.setAlpha(0f);
 
-        mIconHelper.load(
-                mDoc,
-                mIconThumb,
-                mIconMime,
-                /* subIconMime= */ null,
-                thumbnailLoaded -> {
-                    // Show stroke when thumbnail is loaded.
-                    if (isUseMaterial3FlagEnabled() && mIconWrapper != null) {
-                        mIconWrapper.setStrokeWidth(
-                                thumbnailLoaded ? mThumbnailStrokeWidth : 0);
-                    }
-                });
-
-        mTitle.setText(mDoc.displayName, TextView.BufferType.SPANNABLE);
+        mIconHelper.load(mDoc, mIconThumb, mIconMime, /* subIconMime= */ null);
+
+        if (isUseMaterial3FlagEnabled()) {
+            // Only Normal type work with ellipsize=middle.
+            mTitle.setText(mDoc.displayName, TextView.BufferType.NORMAL);
+            // Doing this hacky way instead of just "mTitle.setTooltipText()" because calling
+            // "mTitle.setTooltipText()" directly will break the ripple effects on the title area.
+            itemView.setOnHoverListener(
+                    (v, event) -> {
+                        if (event.getAction() == MotionEvent.ACTION_HOVER_ENTER) {
+                            mTitle.setTooltipText(mDoc.displayName);
+                        } else if (event.getAction() == MotionEvent.ACTION_HOVER_EXIT) {
+                            mTitle.setTooltipText(null);
+                        }
+                        return false;
+                    });
+        } else {
+            mTitle.setText(mDoc.displayName, TextView.BufferType.SPANNABLE);
+        }
         mTitle.setVisibility(View.VISIBLE);
 
         if (mDoc.isDirectory()) {
diff --git a/src/com/android/documentsui/dirlist/Message.java b/src/com/android/documentsui/dirlist/Message.java
index 7b2d6c309..9cd3dc5a0 100644
--- a/src/com/android/documentsui/dirlist/Message.java
+++ b/src/com/android/documentsui/dirlist/Message.java
@@ -30,6 +30,8 @@ import static com.android.documentsui.DevicePolicyResources.Strings.CROSS_PROFIL
 import static com.android.documentsui.DevicePolicyResources.Strings.CROSS_PROFILE_NOT_ALLOWED_TITLE;
 import static com.android.documentsui.DevicePolicyResources.Strings.WORK_PROFILE_OFF_ENABLE_BUTTON;
 import static com.android.documentsui.DevicePolicyResources.Strings.WORK_PROFILE_OFF_ERROR_TITLE;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.Manifest;
 import android.app.ActivityManager;
@@ -44,6 +46,7 @@ import android.os.UserHandle;
 import android.os.UserManager;
 import android.util.Log;
 
+import androidx.annotation.DrawableRes;
 import androidx.annotation.Nullable;
 import androidx.annotation.RequiresApi;
 
@@ -172,11 +175,17 @@ abstract class Message {
             if (event.hasAuthenticationException()) {
                 updateToAuthenticationExceptionHeader(event);
             } else if (mEnv.getModel().error != null) {
-                update(null, mEnv.getModel().error, null,
-                        mEnv.getContext().getDrawable(R.drawable.ic_dialog_alert));
+                update(
+                        null,
+                        mEnv.getModel().error,
+                        null,
+                        mEnv.getContext().getDrawable(getRes(R.drawable.ic_dialog_alert)));
             } else if (mEnv.getModel().info != null) {
-                update(null, mEnv.getModel().info, null,
-                        mEnv.getContext().getDrawable(R.drawable.ic_dialog_info));
+                update(
+                        null,
+                        mEnv.getModel().info,
+                        null,
+                        mEnv.getContext().getDrawable(getRes(R.drawable.ic_dialog_info)));
             } else if (mEnv.getDisplayState().action == State.ACTION_OPEN_TREE
                     && mEnv.getDisplayState().stack.peek() != null
                     && mEnv.getDisplayState().stack.peek().isBlockedFromTree()
@@ -194,9 +203,11 @@ abstract class Message {
             RootInfo root = mEnv.getDisplayState().stack.getRoot();
             String appName = DocumentsApplication.getProvidersCache(
                     mEnv.getContext()).getApplicationName(root.userId, root.authority);
-            update(null, mEnv.getContext().getString(R.string.authentication_required, appName),
+            update(
+                    null,
+                    mEnv.getContext().getString(getRes(R.string.authentication_required), appName),
                     mEnv.getContext().getResources().getText(R.string.sign_in),
-                    mEnv.getContext().getDrawable(R.drawable.ic_dialog_info));
+                    mEnv.getContext().getDrawable(getRes(R.drawable.ic_dialog_info)));
             mCallback = () -> {
                 AuthenticationRequiredException exception =
                         (AuthenticationRequiredException) event.getException();
@@ -206,10 +217,11 @@ abstract class Message {
 
         private void updateBlockFromTreeMessage() {
             mShouldKeep = true;
-            update(mEnv.getContext().getString(R.string.directory_blocked_header_title),
-                    mEnv.getContext().getString(R.string.directory_blocked_header_subtitle),
-                    mEnv.getContext().getString(R.string.create_new_folder_button),
-                    mEnv.getContext().getDrawable(R.drawable.ic_dialog_info));
+            update(
+                    mEnv.getContext().getString(getRes(R.string.directory_blocked_header_title)),
+                    mEnv.getContext().getString(getRes(R.string.directory_blocked_header_subtitle)),
+                    mEnv.getContext().getString(getRes(R.string.create_new_folder_button)),
+                    mEnv.getContext().getDrawable(getRes(R.drawable.ic_dialog_info)));
         }
     }
 
@@ -300,20 +312,26 @@ abstract class Message {
                 selectedProfile = mUserIdToLabelMap.get(userId);
             }
             if (mCanModifyQuietMode) {
-                buttonText = mConfigStore.isPrivateSpaceInDocsUIEnabled()
-                        ? res.getString(R.string.profile_quiet_mode_button,
-                        selectedProfile.toLowerCase(Locale.getDefault()))
-                        : getEnterpriseString(
-                                WORK_PROFILE_OFF_ENABLE_BUTTON, R.string.quiet_mode_button);
+                buttonText =
+                        mConfigStore.isPrivateSpaceInDocsUIEnabled()
+                                ? res.getString(
+                                        getRes(R.string.profile_quiet_mode_button),
+                                        selectedProfile.toLowerCase(Locale.getDefault()))
+                                : getEnterpriseString(
+                                        WORK_PROFILE_OFF_ENABLE_BUTTON,
+                                        getRes(R.string.quiet_mode_button));
                 mCallback = () -> mEnv.getActionHandler().requestQuietModeDisabled(
                         mEnv.getDisplayState().stack.getRoot(), userId);
             }
 
-            update(mConfigStore.isPrivateSpaceInDocsUIEnabled()
-                            ? res.getString(R.string.profile_quiet_mode_error_title,
-                            selectedProfile)
+            update(
+                    mConfigStore.isPrivateSpaceInDocsUIEnabled()
+                            ? res.getString(
+                                    getRes(R.string.profile_quiet_mode_error_title),
+                                    selectedProfile)
                             : getEnterpriseString(
-                                    WORK_PROFILE_OFF_ERROR_TITLE, R.string.quiet_mode_error_title),
+                                    WORK_PROFILE_OFF_ERROR_TITLE,
+                                    getRes(R.string.quiet_mode_error_title)),
                     /* messageString= */ "",
                     buttonText,
                     getWorkProfileOffIcon());
@@ -321,10 +339,11 @@ abstract class Message {
 
         private void updateToCrossProfileNoPermissionErrorMessage() {
             mLayout = InflateMessageDocumentHolder.LAYOUT_CROSS_PROFILE_ERROR;
-            update(getCrossProfileNoPermissionErrorTitle(),
+            update(
+                    getCrossProfileNoPermissionErrorTitle(),
                     getCrossProfileNoPermissionErrorMessage(),
                     /* buttonString= */ null,
-                    mEnv.getContext().getDrawable(R.drawable.share_off));
+                    mEnv.getContext().getDrawable(getRes(R.drawable.share_off)));
         }
 
         private CharSequence getCrossProfileNoPermissionErrorTitle() {
@@ -342,7 +361,7 @@ abstract class Message {
             }
             return getEnterpriseString(
                     CROSS_PROFILE_NOT_ALLOWED_TITLE,
-                    R.string.cross_profile_action_not_allowed_title);
+                    getRes(R.string.cross_profile_action_not_allowed_title));
         }
 
         private CharSequence getErrorTitlePrivateSpaceEnabled(int action) {
@@ -350,10 +369,12 @@ abstract class Message {
             String selectedProfileLabel = mUserIdToLabelMap.get(mSelectedUserId);
             if (selectedProfileLabel == null) return "";
             if (action == ACCESS_CROSS_PROFILE_FILES) {
-                return res.getString(R.string.cant_select_cross_profile_files_error_title,
+                return res.getString(
+                        getRes(R.string.cant_select_cross_profile_files_error_title),
                         selectedProfileLabel.toLowerCase(Locale.getDefault()));
             } else if (action == State.ACTION_CREATE) {
-                return res.getString(R.string.cant_save_to_cross_profile_error_title,
+                return res.getString(
+                        getRes(R.string.cant_save_to_cross_profile_error_title),
                         selectedProfileLabel.toLowerCase(Locale.getDefault()));
             } else {
                 Log.e(TAG, "Unexpected intent action received.");
@@ -365,16 +386,20 @@ abstract class Message {
             boolean currentUserIsSystem = UserId.CURRENT_USER.isSystem();
             if (action == ACCESS_CROSS_PROFILE_FILES) {
                 return currentUserIsSystem
-                        ? getEnterpriseString(CANT_SELECT_WORK_FILES_TITLE,
-                        R.string.cant_select_work_files_error_title)
-                        : getEnterpriseString(CANT_SELECT_PERSONAL_FILES_TITLE,
-                                R.string.cant_select_personal_files_error_title);
+                        ? getEnterpriseString(
+                                CANT_SELECT_WORK_FILES_TITLE,
+                                getRes(R.string.cant_select_work_files_error_title))
+                        : getEnterpriseString(
+                                CANT_SELECT_PERSONAL_FILES_TITLE,
+                                getRes(R.string.cant_select_personal_files_error_title));
             } else if (action == State.ACTION_CREATE) {
                 return currentUserIsSystem
-                        ? getEnterpriseString(CANT_SAVE_TO_WORK_TITLE,
-                        R.string.cant_save_to_work_error_title)
-                        : getEnterpriseString(CANT_SAVE_TO_PERSONAL_TITLE,
-                                R.string.cant_save_to_personal_error_title);
+                        ? getEnterpriseString(
+                                CANT_SAVE_TO_WORK_TITLE,
+                                getRes(R.string.cant_save_to_work_error_title))
+                        : getEnterpriseString(
+                                CANT_SAVE_TO_PERSONAL_TITLE,
+                                getRes(R.string.cant_save_to_personal_error_title));
             } else {
                 Log.e(TAG, "Unexpected intent action received.");
                 return "";
@@ -397,7 +422,7 @@ abstract class Message {
             }
             return getEnterpriseString(
                     CROSS_PROFILE_NOT_ALLOWED_MESSAGE,
-                    R.string.cross_profile_action_not_allowed_message);
+                    getRes(R.string.cross_profile_action_not_allowed_message));
         }
 
         private CharSequence getErrorMessagePrivateSpaceEnabled(int action) {
@@ -406,11 +431,13 @@ abstract class Message {
             String selectedProfileLabel = mUserIdToLabelMap.get(mSelectedUserId);
             if (sourceProfileLabel == null || selectedProfileLabel == null) return "";
             if (action == ACCESS_CROSS_PROFILE_FILES) {
-                return res.getString(R.string.cant_select_cross_profile_files_error_message,
+                return res.getString(
+                        getRes(R.string.cant_select_cross_profile_files_error_message),
                         selectedProfileLabel.toLowerCase(Locale.getDefault()),
                         sourceProfileLabel.toLowerCase(Locale.getDefault()));
             } else if (action == State.ACTION_CREATE) {
-                return res.getString(R.string.cant_save_to_cross_profile_error_message,
+                return res.getString(
+                        getRes(R.string.cant_save_to_cross_profile_error_message),
                         sourceProfileLabel.toLowerCase(Locale.getDefault()),
                         selectedProfileLabel.toLowerCase(Locale.getDefault()));
             } else {
@@ -423,16 +450,20 @@ abstract class Message {
             boolean currentUserIsSystem = UserId.CURRENT_USER.isSystem();
             if (action == ACCESS_CROSS_PROFILE_FILES) {
                 return currentUserIsSystem
-                        ? getEnterpriseString(CANT_SELECT_WORK_FILES_MESSAGE,
-                        R.string.cant_select_work_files_error_message)
-                        : getEnterpriseString(CANT_SELECT_PERSONAL_FILES_MESSAGE,
-                                R.string.cant_select_personal_files_error_message);
+                        ? getEnterpriseString(
+                                CANT_SELECT_WORK_FILES_MESSAGE,
+                                getRes(R.string.cant_select_work_files_error_message))
+                        : getEnterpriseString(
+                                CANT_SELECT_PERSONAL_FILES_MESSAGE,
+                                getRes(R.string.cant_select_personal_files_error_message));
             } else if (action == State.ACTION_CREATE) {
                 return currentUserIsSystem
-                        ? getEnterpriseString(CANT_SAVE_TO_WORK_MESSAGE,
-                        R.string.cant_save_to_work_error_message)
-                        : getEnterpriseString(CANT_SAVE_TO_PERSONAL_MESSAGE,
-                                R.string.cant_save_to_personal_error_message);
+                        ? getEnterpriseString(
+                                CANT_SAVE_TO_WORK_MESSAGE,
+                                getRes(R.string.cant_save_to_work_error_message))
+                        : getEnterpriseString(
+                                CANT_SAVE_TO_PERSONAL_MESSAGE,
+                                getRes(R.string.cant_save_to_personal_error_message));
             } else {
                 Log.e(TAG, "Unexpected intent action received.");
                 return "";
@@ -440,26 +471,38 @@ abstract class Message {
         }
 
         private void updateToInflatedErrorMessage() {
-            update(null, mEnv.getContext().getResources().getText(R.string.query_error), null,
-                    mEnv.getContext().getDrawable(R.drawable.hourglass));
+            update(
+                    null,
+                    mEnv.getContext().getResources().getText(R.string.query_error),
+                    null,
+                    mEnv.getContext().getDrawable(getRes(R.drawable.hourglass)));
         }
 
         private void updateToCantDisplayContentMessage() {
-            update(null, mEnv.getContext().getResources().getText(R.string.cant_display_content),
-                    null, mEnv.getContext().getDrawable(R.drawable.empty));
+            update(
+                    null,
+                    mEnv.getContext().getResources().getText(R.string.cant_display_content),
+                    null,
+                    mEnv.getContext().getDrawable(getRes(R.drawable.empty)));
         }
 
         private void updateToInflatedEmptyMessage() {
             final CharSequence message;
+            final @DrawableRes int drawableId;
             if (mEnv.isInSearchMode()) {
                 message = String.format(
                         String.valueOf(
                                 mEnv.getContext().getResources().getText(R.string.no_results)),
                         mEnv.getDisplayState().stack.getRoot().title);
+                drawableId =
+                        isUseMaterial3FlagEnabled()
+                                ? R.drawable.empty_search
+                                : R.drawable.empty;
             } else {
                 message = mEnv.getContext().getResources().getText(R.string.empty);
+                drawableId = getRes(R.drawable.empty);
             }
-            update(null, message, null, mEnv.getContext().getDrawable(R.drawable.empty));
+            update(null, message, null, mEnv.getContext().getDrawable(drawableId));
         }
 
         private String getEnterpriseString(String updatableStringId, int defaultStringId) {
@@ -482,7 +525,7 @@ abstract class Message {
             if (SdkLevel.isAtLeastT()) {
                 return getUpdatableWorkProfileIcon();
             } else {
-                return mEnv.getContext().getDrawable(R.drawable.work_off);
+                return mEnv.getContext().getDrawable(getRes(R.drawable.work_off));
             }
         }
 
@@ -490,9 +533,11 @@ abstract class Message {
         private Drawable getUpdatableWorkProfileIcon() {
             DevicePolicyManager dpm = mEnv.getContext().getSystemService(
                     DevicePolicyManager.class);
-            return dpm.getResources().getDrawable(
-                    WORK_PROFILE_OFF_ICON, OUTLINE,
-                    () -> mEnv.getContext().getDrawable(R.drawable.work_off));
+            return dpm.getResources()
+                    .getDrawable(
+                            WORK_PROFILE_OFF_ICON,
+                            OUTLINE,
+                            () -> mEnv.getContext().getDrawable(getRes(R.drawable.work_off)));
         }
     }
 }
diff --git a/src/com/android/documentsui/dirlist/ModelBackedDocumentsAdapter.java b/src/com/android/documentsui/dirlist/ModelBackedDocumentsAdapter.java
index 112b70da8..28c424c68 100644
--- a/src/com/android/documentsui/dirlist/ModelBackedDocumentsAdapter.java
+++ b/src/com/android/documentsui/dirlist/ModelBackedDocumentsAdapter.java
@@ -105,11 +105,18 @@ final class ModelBackedDocumentsAdapter extends DocumentsAdapter {
                                         mEnv.getContext(), parent, mIconHelper, mConfigStore);
                         break;
                     case ITEM_TYPE_DOCUMENT:
-                        holder = state.isPhotoPicking()
-                                ? new GridPhotoHolder(mEnv.getContext(), parent, mIconHelper,
-                                mConfigStore)
-                                : new GridDocumentHolder(mEnv.getContext(), parent, mIconHelper,
-                                        mConfigStore);
+                        holder =
+                                (!isUseMaterial3FlagEnabled() && state.isPhotoPicking())
+                                        ? new GridPhotoHolder(
+                                                mEnv.getContext(),
+                                                parent,
+                                                mIconHelper,
+                                                mConfigStore)
+                                        : new GridDocumentHolder(
+                                                mEnv.getContext(),
+                                                parent,
+                                                mIconHelper,
+                                                mConfigStore);
                         break;
                     default:
                         throw new IllegalStateException("Unsupported layout type.");
@@ -141,6 +148,10 @@ final class ModelBackedDocumentsAdapter extends DocumentsAdapter {
     public void onBindViewHolder(DocumentHolder holder, int position) {
         String modelId = mModelIds.get(position);
         Cursor cursor = mEnv.getModel().getItem(modelId);
+        if (isUseMaterial3FlagEnabled()) {
+            // Need the action to be set for bind().
+            holder.setAction(mEnv.getDisplayState().action);
+        }
         holder.bind(cursor, modelId);
 
         final String docMimeType = getCursorString(cursor, Document.COLUMN_MIME_TYPE);
@@ -154,7 +165,9 @@ final class ModelBackedDocumentsAdapter extends DocumentsAdapter {
         }
         holder.setEnabled(enabled);
         holder.setSelected(mEnv.isSelected(modelId), false);
-        holder.setAction(mEnv.getDisplayState().action);
+        if (!isUseMaterial3FlagEnabled()) {
+            holder.setAction(mEnv.getDisplayState().action);
+        }
         holder.bindPreviewIcon(mEnv.getDisplayState().shouldShowPreview() && enabled,
                 view -> mEnv.getActionHandler().previewItem(holder.getItemDetails()));
         if (mConfigStore.isPrivateSpaceInDocsUIEnabled() && SdkLevel.isAtLeastS()) {
diff --git a/src/com/android/documentsui/dirlist/RefreshHelper.java b/src/com/android/documentsui/dirlist/RefreshHelper.java
index fb7b47855..d71c7c89f 100644
--- a/src/com/android/documentsui/dirlist/RefreshHelper.java
+++ b/src/com/android/documentsui/dirlist/RefreshHelper.java
@@ -17,9 +17,10 @@ package com.android.documentsui.dirlist;
 
 import static androidx.core.util.Preconditions.checkState;
 
+import android.view.MotionEvent;
+
 import androidx.recyclerview.widget.RecyclerView;
 import androidx.recyclerview.widget.RecyclerView.OnItemTouchListener;
-import android.view.MotionEvent;
 
 import com.android.documentsui.base.BooleanConsumer;
 import com.android.documentsui.base.Events;
@@ -38,7 +39,7 @@ final class RefreshHelper {
     }
 
     private boolean onInterceptTouchEvent(RecyclerView rv, MotionEvent e) {
-        if (Events.isMouseEvent(e)) {
+        if (Events.isMousyEvent(e)) {
             if (Events.isActionDown(e)) {
                 mRefreshLayoutEnabler.accept(false);
             }
diff --git a/src/com/android/documentsui/dirlist/RenameDocumentFragment.java b/src/com/android/documentsui/dirlist/RenameDocumentFragment.java
index 12873a218..f5959c913 100644
--- a/src/com/android/documentsui/dirlist/RenameDocumentFragment.java
+++ b/src/com/android/documentsui/dirlist/RenameDocumentFragment.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.dirlist;
 
 import static com.android.documentsui.base.SharedMinimal.TAG;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Dialog;
 import android.content.Context;
@@ -79,12 +80,12 @@ public class RenameDocumentFragment extends DialogFragment {
         Context context = getActivity();
         MaterialAlertDialogBuilder builder = new MaterialAlertDialogBuilder(context);
         LayoutInflater dialogInflater = LayoutInflater.from(builder.getContext());
-        View view = dialogInflater.inflate(R.layout.dialog_file_name, null, false);
+        View view = dialogInflater.inflate(getRes(R.layout.dialog_file_name), null, false);
 
         mEditText = (EditText) view.findViewById(android.R.id.text1);
-        mRenameInputWrapper = (TextInputLayout) view.findViewById(R.id.input_wrapper);
-        mRenameInputWrapper.setHint(getString(R.string.input_hint_rename));
-        builder.setTitle(R.string.menu_rename);
+        mRenameInputWrapper = (TextInputLayout) view.findViewById(getRes(R.id.input_wrapper));
+        mRenameInputWrapper.setHint(getString(getRes(R.string.input_hint_rename)));
+        builder.setTitle(getRes(R.string.menu_rename));
         builder.setView(view);
         builder.setPositiveButton(android.R.string.ok, null);
         builder.setNegativeButton(android.R.string.cancel, null);
@@ -184,9 +185,10 @@ public class RenameDocumentFragment extends DialogFragment {
         if (newDisplayName.equals(mDocument.displayName)) {
             mDialog.dismiss();
         } else if (newDisplayName.isEmpty()) {
-            mRenameInputWrapper.setError(getContext().getString(R.string.missing_rename_error));
+            mRenameInputWrapper.setError(
+                    getContext().getString(getRes(R.string.missing_rename_error)));
         } else if (activity.getInjector().getModel().hasFileWithName(newDisplayName)) {
-            mRenameInputWrapper.setError(getContext().getString(R.string.name_conflict));
+            mRenameInputWrapper.setError(getContext().getString(getRes(R.string.name_conflict)));
             selectFileName(mEditText);
         } else {
             new RenameDocumentsTask(activity, newDisplayName).execute(mDocument);
diff --git a/src/com/android/documentsui/dirlist/SelectionMetadata.java b/src/com/android/documentsui/dirlist/SelectionMetadata.java
index 0d0644502..aad082895 100644
--- a/src/com/android/documentsui/dirlist/SelectionMetadata.java
+++ b/src/com/android/documentsui/dirlist/SelectionMetadata.java
@@ -186,6 +186,6 @@ public class SelectionMetadata extends SelectionObserver<String>
     @Override
     public boolean canOpen() {
         return mFileCount == 1 && mDirectoryCount == 0 && mPartialCount == 0 && (
-                isZipNgFlagEnabled() || mInArchiveCount == 0);
+                mInArchiveCount == 0 || (isZipNgFlagEnabled() && mArchiveCount == 0));
     }
 }
diff --git a/src/com/android/documentsui/dirlist/TransparentDividerDocumentHolder.java b/src/com/android/documentsui/dirlist/TransparentDividerDocumentHolder.java
index cb65e7023..9a6468774 100644
--- a/src/com/android/documentsui/dirlist/TransparentDividerDocumentHolder.java
+++ b/src/com/android/documentsui/dirlist/TransparentDividerDocumentHolder.java
@@ -16,6 +16,7 @@
 
 package com.android.documentsui.dirlist;
 
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Context;
 import android.database.Cursor;
@@ -36,8 +37,9 @@ final class TransparentDividerDocumentHolder extends MessageHolder {
     TransparentDividerDocumentHolder(Context context, ConfigStore configStore) {
         super(context, new Space(context), configStore);
 
-        mVisibleHeight = context.getResources().getDimensionPixelSize(
-                R.dimen.grid_section_separator_height);
+        mVisibleHeight =
+                context.getResources()
+                        .getDimensionPixelSize(getRes(R.dimen.grid_section_separator_height));
     }
 
     public void bind(State state) {
diff --git a/src/com/android/documentsui/files/ActionHandler.java b/src/com/android/documentsui/files/ActionHandler.java
index cbe02dc25..21c8c8b63 100644
--- a/src/com/android/documentsui/files/ActionHandler.java
+++ b/src/com/android/documentsui/files/ActionHandler.java
@@ -614,9 +614,11 @@ public class ActionHandler<T extends FragmentActivity & AbstractActionHandler.Co
     }
 
     private void showPeek(DocumentInfo doc) {
-        if (mPeekViewManager != null) {
-            mPeekViewManager.peekDocument(doc);
+        if (mPeekViewManager == null) {
+            Log.e(TAG, "Attempting to show Peek when PeekViewManager is not defined");
+            return;
         }
+        mPeekViewManager.peekDocument(doc);
     }
 
     @Override
diff --git a/src/com/android/documentsui/files/DeleteDocumentFragment.java b/src/com/android/documentsui/files/DeleteDocumentFragment.java
index 64393a355..ecf0a9c34 100644
--- a/src/com/android/documentsui/files/DeleteDocumentFragment.java
+++ b/src/com/android/documentsui/files/DeleteDocumentFragment.java
@@ -16,6 +16,7 @@
 package com.android.documentsui.files;
 
 import static com.android.documentsui.base.SharedMinimal.TAG;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Dialog;
 import android.content.Context;
@@ -84,8 +85,10 @@ public class DeleteDocumentFragment extends DialogFragment {
         Context context = getActivity();
         Injector<?> injector = ((FilesActivity) getActivity()).getInjector();
         LayoutInflater dialogInflater = LayoutInflater.from(context);
-        TextView message = (TextView) dialogInflater.inflate(
-                R.layout.dialog_delete_confirmation, null, false);
+        TextView message =
+                (TextView)
+                        dialogInflater.inflate(
+                                getRes(R.layout.dialog_delete_confirmation), null, false);
         message.setText(injector.messages.generateDeleteMessage(mDocuments));
 
         final AlertDialog alertDialog = new MaterialAlertDialogBuilder(context)
diff --git a/src/com/android/documentsui/files/FilesActivity.java b/src/com/android/documentsui/files/FilesActivity.java
index b254ce525..62aff8e9f 100644
--- a/src/com/android/documentsui/files/FilesActivity.java
+++ b/src/com/android/documentsui/files/FilesActivity.java
@@ -18,9 +18,12 @@ package com.android.documentsui.files;
 
 import static com.android.documentsui.OperationDialogFragment.DIALOG_TYPE_UNKNOWN;
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.flags.Flags.usePeekPreviewRo;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isUsePeekPreviewFlagEnabled;
 import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
 import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.ActivityManager.TaskDescription;
 import android.content.Intent;
@@ -36,6 +39,7 @@ import android.view.View;
 
 import androidx.annotation.CallSuper;
 import androidx.fragment.app.FragmentManager;
+import androidx.lifecycle.ViewModelProvider;
 
 import com.android.documentsui.AbstractActionHandler;
 import com.android.documentsui.ActionModeController;
@@ -44,6 +48,8 @@ import com.android.documentsui.DocsSelectionHelper;
 import com.android.documentsui.DocumentsApplication;
 import com.android.documentsui.FocusManager;
 import com.android.documentsui.Injector;
+import com.android.documentsui.JobPanelController;
+import com.android.documentsui.JobPanelViewModel;
 import com.android.documentsui.MenuManager.DirectoryDetails;
 import com.android.documentsui.OperationDialogFragment;
 import com.android.documentsui.OperationDialogFragment.DialogType;
@@ -51,6 +57,7 @@ import com.android.documentsui.ProfileTabsAddons;
 import com.android.documentsui.ProfileTabsController;
 import com.android.documentsui.ProviderExecutor;
 import com.android.documentsui.R;
+import com.android.documentsui.SelectionBarController;
 import com.android.documentsui.SharedInputHandler;
 import com.android.documentsui.ShortcutsUpdater;
 import com.android.documentsui.StubProfileTabsAddons;
@@ -62,6 +69,8 @@ import com.android.documentsui.clipping.DocumentClipper;
 import com.android.documentsui.dirlist.AnimationView.AnimationType;
 import com.android.documentsui.dirlist.AppsRowManager;
 import com.android.documentsui.dirlist.DirectoryFragment;
+import com.android.documentsui.peek.PeekViewManager;
+import com.android.documentsui.peek.PeekViewModel;
 import com.android.documentsui.services.FileOperationService;
 import com.android.documentsui.sidebar.RootsFragment;
 import com.android.documentsui.ui.DialogController;
@@ -70,6 +79,8 @@ import com.android.documentsui.ui.MessageBuilder;
 import java.util.ArrayList;
 import java.util.List;
 
+import javax.annotation.Nullable;
+
 /**
  * Standalone file management activity.
  */
@@ -81,10 +92,11 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
     private Injector<ActionHandler<FilesActivity>> mInjector;
     private ActivityInputHandler mActivityInputHandler;
     private SharedInputHandler mSharedInputHandler;
+    private @Nullable PeekViewManager mPeekViewManager;
     private final ProfileTabsAddons mProfileTabsAddonsStub = new StubProfileTabsAddons();
 
     public FilesActivity() {
-        super(R.layout.files_activity, TAG);
+        super(getRes(R.layout.files_activity), TAG);
     }
 
     // make these methods visible in this package to work around compiler bug http://b/62218600
@@ -100,7 +112,7 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
 
     @Override
     public void onCreate(Bundle icicle) {
-        setTheme(R.style.DocumentsTheme);
+        setTheme(getRes(R.style.DocumentsTheme));
 
         MessageBuilder messages = new MessageBuilder(this);
         Features features = Features.create(this);
@@ -118,14 +130,15 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
         DocumentClipper clipper = DocumentsApplication.getDocumentClipper(this);
         mInjector.selectionMgr = DocsSelectionHelper.create();
 
-        mInjector.focusManager = new FocusManager(
-                mInjector.features,
-                mInjector.selectionMgr,
-                mDrawer,
-                this::focusSidebar,
-                getColor(R.color.primary));
+        mInjector.focusManager =
+                new FocusManager(
+                        mInjector.features,
+                        mInjector.selectionMgr,
+                        mDrawer,
+                        this::focusSidebar,
+                        getColor(getRes(R.color.primary)));
 
-        mInjector.menuManager = new MenuManager(
+        MenuManager menuManager = new MenuManager(
                 mInjector.features,
                 mSearchManager,
                 mState,
@@ -135,13 +148,20 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
                         return clipper.hasItemsToPaste();
                     }
                 },
-                isVisualSignalsFlagEnabled() ? this : getApplicationContext(),
+                getApplicationContext(),
                 mInjector.selectionMgr,
                 mProviders::getApplicationName,
                 mInjector.getModel()::getItemUri,
                 mInjector.getModel()::getItemCount);
+        mInjector.menuManager = menuManager;
 
-        if (!isUseMaterial3FlagEnabled()) {
+        if (isUseMaterial3FlagEnabled()) {
+            mInjector.selectionBarController =
+                    new SelectionBarController(
+                            findViewById(getRes(R.id.selection_bar)),
+                            mInjector.menuManager,
+                            mInjector.selectionMgr);
+        } else {
             mInjector.actionModeController =
                     new ActionModeController(
                             this,
@@ -151,6 +171,28 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
                             mInjector.messages);
         }
 
+        // Directly use the generated method `usePeekPreviewRo` to optimize out Peek when the flag
+        // isn't enabled. The optimization is not happening with the FlagUtils's
+        // `isUsePeekPreviewFlagEnabled`.
+        if (usePeekPreviewRo()) {
+            if (isUsePeekPreviewFlagEnabled()) {
+                ViewModelProvider viewModelProvider = new ViewModelProvider(this);
+                PeekViewModel viewModel = viewModelProvider.get(PeekViewModel.class);
+                mPeekViewManager = new PeekViewManager(
+                        viewModel,
+                        findViewById(getRes(R.id.peek_overlay)),
+                        getSupportFragmentManager());
+                viewModel.getOverlayActive().observe(
+                        this,
+                        mPeekViewManager);
+            }
+        }
+
+        Runnable closeSelectionBarRunnable =
+                (isUseMaterial3FlagEnabled()
+                        ? mInjector.selectionBarController::closeSelectionBar
+                        : () -> {});
+
         mInjector.actions =
                 new ActionHandler<>(
                         this,
@@ -160,13 +202,21 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
                         mSearchManager,
                         ProviderExecutor::forAuthority,
                         mInjector.actionModeController,
-                        getNavigator()::closeSelectionBar,
+                        closeSelectionBarRunnable,
                         clipper,
                         DocumentsApplication.getClipStore(this),
                         DocumentsApplication.getDragAndDropManager(this),
                         mPeekViewManager,
                         mInjector);
 
+        if (isVisualSignalsFlagEnabled()) {
+            JobPanelController jobPanelController = new JobPanelController(this,
+                    mInjector.actions,
+                    new ViewModelProvider(this).get(JobPanelViewModel.class));
+            getLifecycle().addObserver(jobPanelController);
+            menuManager.setJobPanelController(jobPanelController);
+        }
+
         mInjector.searchManager = mSearchManager;
 
         // No profile tabs will be shown on FilesActivity. Use a stub to avoid unnecessary
@@ -193,7 +243,7 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
         RootsFragment.show(getSupportFragmentManager(), /* includeApps= */ false,
                 /* intent= */ null);
         if (isUseMaterial3FlagEnabled()) {
-            View navRailRoots = findViewById(R.id.nav_rail_container_roots);
+            View navRailRoots = findViewById(getRes(R.id.nav_rail_container_roots));
             if (navRailRoots != null) {
                 // Medium layout, populate navigation rail layout.
                 RootsFragment.showNavRail(getSupportFragmentManager(), /* includeApps= */ false,
@@ -216,7 +266,7 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
         // hence the edge to edge nav bar is no longer required.
         if (!isUseMaterial3FlagEnabled()) {
             // Set save container background to transparent for edge to edge nav bar.
-            View saveContainer = findViewById(R.id.container_save);
+            View saveContainer = findViewById(getRes(R.id.container_save));
             saveContainer.setBackgroundColor(Color.TRANSPARENT);
         }
 
@@ -224,11 +274,22 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
     }
 
     private AppsRowManager getAppsRowManager() {
+        boolean shouldShowByDefault =
+                !isUseMaterial3FlagEnabled()
+                        || getResources().getBoolean(R.bool.show_apps_row);
         return mConfigStore.isPrivateSpaceInDocsUIEnabled()
-                ? new AppsRowManager(mInjector.actions, mState.supportsCrossProfile(),
-                mUserManagerState, mConfigStore)
-                : new AppsRowManager(mInjector.actions, mState.supportsCrossProfile(),
-                        mUserIdManager, mConfigStore);
+                ? new AppsRowManager(
+                mInjector.actions,
+                mState.supportsCrossProfile(),
+                mUserManagerState,
+                mConfigStore,
+                shouldShowByDefault)
+                : new AppsRowManager(
+                        mInjector.actions,
+                        mState.supportsCrossProfile(),
+                        mUserIdManager,
+                        mConfigStore,
+                        shouldShowByDefault);
     }
 
     // This is called in the intent contains label and icon resources.
@@ -262,15 +323,18 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
             final int opType = intent.getIntExtra(
                     FileOperationService.EXTRA_OPERATION_TYPE,
                     FileOperationService.OPERATION_COPY);
-            final ArrayList<DocumentInfo> docList =
-                    intent.getParcelableArrayListExtra(FileOperationService.EXTRA_FAILED_DOCS);
-            final ArrayList<Uri> uriList =
-                    intent.getParcelableArrayListExtra(FileOperationService.EXTRA_FAILED_URIS);
+            final ArrayList<DocumentInfo> failedDocs = intent.getParcelableArrayListExtra(
+                    FileOperationService.EXTRA_FAILED_DOCS, DocumentInfo.class);
+            final ArrayList<Uri> failedUris = intent.getParcelableArrayListExtra(
+                    FileOperationService.EXTRA_FAILED_URIS, Uri.class);
+            final ArrayList<String> failedPaths = intent.getStringArrayListExtra(
+                    FileOperationService.EXTRA_FAILED_PATHS);
             OperationDialogFragment.show(
                     getSupportFragmentManager(),
                     dialogType,
-                    docList,
-                    uriList,
+                    failedDocs,
+                    failedUris,
+                    failedPaths,
                     mState.stack,
                     opType);
         }
@@ -332,37 +396,35 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
         Intent intent = getIntent();
         return (intent != null && intent.hasExtra(Intent.EXTRA_TITLE))
                 ? intent.getStringExtra(Intent.EXTRA_TITLE)
-                : getString(R.string.app_label);
+                : getString(getRes(R.string.app_label));
     }
 
     @Override
     public boolean onPrepareOptionsMenu(Menu menu) {
         super.onPrepareOptionsMenu(menu);
-        if (!isUseMaterial3FlagEnabled()) {
-            mInjector.menuManager.updateOptionMenu(menu);
-        }
+        mInjector.menuManager.updateOptionMenu(menu);
         return true;
     }
 
     @Override
     public boolean onOptionsItemSelected(MenuItem item) {
         final int id = item.getItemId();
-        if (id == R.id.option_menu_create_dir) {
+        if (id == getRes(R.id.option_menu_create_dir)) {
             assert (canCreateDirectory());
             mInjector.actions.showCreateDirectoryDialog();
-        } else if (id == R.id.option_menu_new_window) {
+        } else if (id == getRes(R.id.option_menu_new_window)) {
             mInjector.actions.openInNewWindow(mState.stack);
-        } else if (id == R.id.option_menu_settings) {
+        } else if (id == getRes(R.id.option_menu_settings)) {
             mInjector.actions.openSettings(getCurrentRoot());
-        } else if (id == R.id.option_menu_extract_all) {
+        } else if (id == getRes(R.id.option_menu_extract_all)) {
             if (!isZipNgFlagEnabled()) return false;
             final DirectoryFragment dir = getDirectoryFragment();
             if (dir == null) return false;
             mInjector.actions.selectAllFiles();
             return dir.onContextItemSelected(item);
-        } else if (id == R.id.option_menu_select_all) {
+        } else if (id == getRes(R.id.option_menu_select_all)) {
             mInjector.actions.selectAllFiles();
-        } else if (id == R.id.option_menu_inspect) {
+        } else if (id == getRes(R.id.option_menu_inspect)) {
             mInjector.actions.showPreview(getCurrentDirectory());
         } else {
             final boolean ok = super.onOptionsItemSelected(item);
diff --git a/src/com/android/documentsui/files/LauncherActivity.java b/src/com/android/documentsui/files/LauncherActivity.java
index 8cd7dcbb8..855288eca 100644
--- a/src/com/android/documentsui/files/LauncherActivity.java
+++ b/src/com/android/documentsui/files/LauncherActivity.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.files;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Activity;
 import android.app.ActivityManager;
@@ -26,9 +27,10 @@ import android.content.Intent;
 import android.net.Uri;
 import android.os.Bundle;
 import android.provider.DocumentsContract;
-import androidx.annotation.Nullable;
 import android.util.Log;
 
+import androidx.annotation.Nullable;
+
 import com.android.documentsui.R;
 
 import java.util.List;
@@ -98,8 +100,8 @@ public class LauncherActivity extends Activity {
     private void startTask() {
         Intent intent = createLaunchIntent(this);
 
-        intent.putExtra(TASK_LABEL_RES, R.string.launcher_label);
-        intent.putExtra(TASK_ICON_RES, R.drawable.launcher_icon);
+        intent.putExtra(TASK_LABEL_RES, getRes(R.string.launcher_label));
+        intent.putExtra(TASK_ICON_RES, getRes(R.drawable.launcher_icon));
 
         // Forward any flags from the original intent.
         intent.setFlags(getIntent().getFlags());
diff --git a/src/com/android/documentsui/files/MenuManager.java b/src/com/android/documentsui/files/MenuManager.java
index 2c85dcb01..004602714 100644
--- a/src/com/android/documentsui/files/MenuManager.java
+++ b/src/com/android/documentsui/files/MenuManager.java
@@ -17,7 +17,8 @@
 package com.android.documentsui.files;
 
 import static com.android.documentsui.util.FlagUtils.isDesktopFileHandlingFlagEnabled;
-import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Context;
 import android.content.res.Resources;
@@ -59,7 +60,7 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
     private final SelectionTracker<String> mSelectionManager;
     private final Lookup<String, Uri> mUriLookup;
     private final LookupApplicationName mAppNameLookup;
-    @Nullable private final JobPanelController mJobPanelController;
+    @Nullable private JobPanelController mJobPanelController;
 
     public MenuManager(
             Features features,
@@ -79,37 +80,48 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
         mSelectionManager = selectionManager;
         mAppNameLookup = appNameLookup;
         mUriLookup = uriLookup;
+    }
 
-        if (isVisualSignalsFlagEnabled()) {
-            mJobPanelController = new JobPanelController(context);
-        } else {
-            mJobPanelController = null;
-        }
+    // TODO(b/378011512): Remove and merge with constructor once visual signals flag is removed.
+    public void setJobPanelController(JobPanelController controller) {
+        mJobPanelController = controller;
     }
 
     @Override
     public void updateKeyboardShortcutsMenu(
             List<KeyboardShortcutGroup> data, IntFunction<String> stringSupplier) {
-        KeyboardShortcutGroup group = new KeyboardShortcutGroup(
-                stringSupplier.apply(R.string.app_label));
-        group.addItem(new KeyboardShortcutInfo(
-                stringSupplier.apply(R.string.menu_cut_to_clipboard), KeyEvent.KEYCODE_X,
-                KeyEvent.META_CTRL_ON));
-        group.addItem(new KeyboardShortcutInfo(
-                stringSupplier.apply(R.string.menu_copy_to_clipboard), KeyEvent.KEYCODE_C,
-                KeyEvent.META_CTRL_ON));
-        group.addItem(new KeyboardShortcutInfo(
-                stringSupplier.apply(R.string.menu_paste_from_clipboard), KeyEvent.KEYCODE_V,
-                KeyEvent.META_CTRL_ON));
-        group.addItem(new KeyboardShortcutInfo(
-                stringSupplier.apply(R.string.menu_create_dir), KeyEvent.KEYCODE_E,
-                KeyEvent.META_CTRL_ON));
-        group.addItem(new KeyboardShortcutInfo(
-                stringSupplier.apply(R.string.menu_select_all), KeyEvent.KEYCODE_A,
-                KeyEvent.META_CTRL_ON));
-        group.addItem(new KeyboardShortcutInfo(
-                stringSupplier.apply(R.string.menu_new_window), KeyEvent.KEYCODE_N,
-                KeyEvent.META_CTRL_ON));
+        KeyboardShortcutGroup group =
+                new KeyboardShortcutGroup(stringSupplier.apply(getRes(R.string.app_label)));
+        group.addItem(
+                new KeyboardShortcutInfo(
+                        stringSupplier.apply(getRes(R.string.menu_cut_to_clipboard)),
+                        KeyEvent.KEYCODE_X,
+                        KeyEvent.META_CTRL_ON));
+        group.addItem(
+                new KeyboardShortcutInfo(
+                        stringSupplier.apply(getRes(R.string.menu_copy_to_clipboard)),
+                        KeyEvent.KEYCODE_C,
+                        KeyEvent.META_CTRL_ON));
+        group.addItem(
+                new KeyboardShortcutInfo(
+                        stringSupplier.apply(getRes(R.string.menu_paste_from_clipboard)),
+                        KeyEvent.KEYCODE_V,
+                        KeyEvent.META_CTRL_ON));
+        group.addItem(
+                new KeyboardShortcutInfo(
+                        stringSupplier.apply(getRes(R.string.menu_create_dir)),
+                        KeyEvent.KEYCODE_E,
+                        KeyEvent.META_CTRL_ON));
+        group.addItem(
+                new KeyboardShortcutInfo(
+                        stringSupplier.apply(getRes(R.string.menu_select_all)),
+                        KeyEvent.KEYCODE_A,
+                        KeyEvent.META_CTRL_ON));
+        group.addItem(
+                new KeyboardShortcutInfo(
+                        stringSupplier.apply(getRes(R.string.menu_new_window)),
+                        KeyEvent.KEYCODE_N,
+                        KeyEvent.META_CTRL_ON));
         data.add(group);
     }
 
@@ -124,7 +136,7 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
     @Override
     public void inflateContextMenuForContainer(
             Menu menu, MenuInflater inflater, SelectionDetails selectionDetails) {
-        inflater.inflate(R.menu.container_context_menu, menu);
+        inflater.inflate(getRes(R.menu.container_context_menu), menu);
         updateContextMenuForContainer(menu, selectionDetails);
     }
 
@@ -134,20 +146,20 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
         final boolean hasDir = selectionDetails.containsDirectories();
         final boolean hasFile = selectionDetails.containsFiles();
 
-        assert(hasDir || hasFile);
+        assert hasDir || hasFile;
         if (!hasDir) {
-            inflater.inflate(R.menu.file_context_menu, menu);
+            inflater.inflate(getRes(R.menu.file_context_menu), menu);
             updateContextMenuForFiles(menu, selectionDetails);
             return;
         }
 
         if (!hasFile) {
-            inflater.inflate(R.menu.dir_context_menu, menu);
+            inflater.inflate(getRes(R.menu.dir_context_menu), menu);
             updateContextMenuForDirs(menu, selectionDetails);
             return;
         }
 
-        inflater.inflate(R.menu.mixed_context_menu, menu);
+        inflater.inflate(getRes(R.menu.mixed_context_menu), menu);
         updateContextMenu(menu, selectionDetails);
     }
 
@@ -156,7 +168,7 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
         if (mJobPanelController == null) {
             return;
         }
-        mJobPanelController.setMenuItem(menu.findItem(R.id.option_menu_job_progress));
+        mJobPanelController.setMenuItem(menu.findItem(getRes(R.id.option_menu_job_progress)));
     }
 
     @Override
@@ -195,12 +207,12 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
     protected void updateOpenInNewWindow(
             MenuItem openInNewWindow, SelectionDetails selectionDetails) {
         Menus.setEnabledAndVisible(openInNewWindow, selectionDetails.size() == 1
-            && !selectionDetails.containsPartialFiles());
+                && !selectionDetails.containsPartialFiles());
     }
 
     @Override
     protected void updateOpenInNewWindow(MenuItem openInNewWindow, RootInfo root) {
-        assert(openInNewWindow.isVisible() && openInNewWindow.isEnabled());
+        assert openInNewWindow.isVisible() && openInNewWindow.isEnabled();
     }
 
     @Override
@@ -228,16 +240,17 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
     protected void updateExtractTo(MenuItem extractTo, SelectionDetails selectionDetails) {
         boolean enabled = selectionDetails.canExtract();
         Menus.setEnabledAndVisible(extractTo, enabled);
+        if (isZipNgFlagEnabled()) extractTo.setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM);
     }
 
     @Override
     protected void updateExtractHere(@NonNull MenuItem it, @NonNull SelectionDetails selection) {
-        Menus.setEnabledAndVisible(it, selection.isArchive());
+        Menus.setEnabledAndVisible(it, selection.isArchive() && mDirDetails.canCreateDirectory());
     }
 
     @Override
     protected void updateBrowse(@NonNull MenuItem it, @NonNull SelectionDetails selection) {
-        Menus.setEnabledAndVisible(it, selection.isArchive());
+        Menus.setEnabledAndVisible(it, selection.isArchive() && !mDirDetails.isInArchive());
     }
 
     @Override
@@ -323,10 +336,9 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
             Uri selectedUri = mUriLookup.lookup(selectedModelId);
             String appName = mAppNameLookup.getApplicationName(UserId.DEFAULT_USER,
                     selectedUri.getAuthority());
-            String title = res.getString(R.string.menu_view_in_owner, appName);
+            String title = res.getString(getRes(R.string.menu_view_in_owner), appName);
             view.setTitle(title);
-        }
-        else {
+        } else {
             Menus.setEnabledAndVisible(view, false);
         }
     }
diff --git a/src/com/android/documentsui/files/QuickViewIntentBuilder.java b/src/com/android/documentsui/files/QuickViewIntentBuilder.java
index bab675308..e6ae3c8a0 100644
--- a/src/com/android/documentsui/files/QuickViewIntentBuilder.java
+++ b/src/com/android/documentsui/files/QuickViewIntentBuilder.java
@@ -20,6 +20,7 @@ import static com.android.documentsui.base.DocumentInfo.getCursorInt;
 import static com.android.documentsui.base.DocumentInfo.getCursorString;
 import static com.android.documentsui.base.Shared.MAX_DOCS_IN_INTENT;
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.ClipData;
 import android.content.ClipDescription;
@@ -159,7 +160,7 @@ public final class QuickViewIntentBuilder {
     }
 
     private String getQuickViewPackage() {
-        String resValue = mResources.getString(R.string.trusted_quick_viewer_package);
+        String resValue = mResources.getString(getRes(R.string.trusted_quick_viewer_package));
 
         // Allow automated tests to hard-disable quick viewing.
         if (IGNORE_DEBUG_PROP.equals(resValue)) {
diff --git a/src/com/android/documentsui/inspector/DateUtils.java b/src/com/android/documentsui/inspector/DateUtils.java
index 7e4901e2f..deeb253bf 100644
--- a/src/com/android/documentsui/inspector/DateUtils.java
+++ b/src/com/android/documentsui/inspector/DateUtils.java
@@ -15,6 +15,8 @@
  */
 package com.android.documentsui.inspector;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.content.res.Resources;
 import android.text.format.DateFormat;
@@ -35,9 +37,10 @@ final class DateUtils {
      */
     static String formatDate(Context context, long date) {
         Resources res = context.getResources();
-        int formatRes = DateFormat.is24HourFormat(context)
-                ? R.string.datetime_format_24
-                : R.string.datetime_format_12;
+        int formatRes =
+                DateFormat.is24HourFormat(context)
+                        ? getRes(R.string.datetime_format_24)
+                        : getRes(R.string.datetime_format_12);
         String format = DateFormat.getBestDateTimePattern(
                 Locale.getDefault(),
                 res.getString(formatRes));
diff --git a/src/com/android/documentsui/inspector/DebugView.java b/src/com/android/documentsui/inspector/DebugView.java
index 908d19242..2aad9c4b4 100644
--- a/src/com/android/documentsui/inspector/DebugView.java
+++ b/src/com/android/documentsui/inspector/DebugView.java
@@ -15,6 +15,8 @@
  */
 package com.android.documentsui.inspector;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.content.res.Resources;
 import android.os.AsyncTask;
@@ -70,29 +72,29 @@ public class DebugView extends TableView implements DebugDisplay {
 
     @Override
     public void accept(DocumentInfo info) {
-        setTitle(R.string.inspector_debug_section, true);
-
-        put(R.string.debug_user_id, info.userId.toString());
-        put(R.string.debug_content_uri, info.derivedUri.toString());
-        put(R.string.debug_document_id, info.documentId);
-        put(R.string.debug_raw_mimetype, info.mimeType);
-        put(R.string.debug_stream_types, "-");
-        put(R.string.debug_raw_size, NumberFormat.getInstance().format(info.size));
-        put(R.string.debug_is_archive, info.isArchive());
-        put(R.string.debug_is_blocked_from_tree, info.isBlockedFromTree());
-        put(R.string.debug_is_container, info.isContainer());
-        put(R.string.debug_is_partial, info.isPartial());
-        put(R.string.debug_is_virtual, info.isVirtual());
-        put(R.string.debug_supports_create, info.isCreateSupported());
-        put(R.string.debug_supports_delete, info.isDeleteSupported());
-        put(R.string.debug_supports_metadata, info.isMetadataSupported());
-        put(R.string.debug_supports_move, info.isMoveSupported());
-        put(R.string.debug_supports_remove, info.isRemoveSupported());
-        put(R.string.debug_supports_rename, info.isRenameSupported());
-        put(R.string.debug_supports_settings, info.isSettingsSupported());
-        put(R.string.debug_supports_thumbnail, info.isThumbnailSupported());
-        put(R.string.debug_supports_weblink, info.isWeblinkSupported());
-        put(R.string.debug_supports_write, info.isWriteSupported());
+        setTitle(getRes(R.string.inspector_debug_section), true);
+
+        put(getRes(R.string.debug_user_id), info.userId.toString());
+        put(getRes(R.string.debug_content_uri), info.derivedUri.toString());
+        put(getRes(R.string.debug_document_id), info.documentId);
+        put(getRes(R.string.debug_raw_mimetype), info.mimeType);
+        put(getRes(R.string.debug_stream_types), "-");
+        put(getRes(R.string.debug_raw_size), NumberFormat.getInstance().format(info.size));
+        put(getRes(R.string.debug_is_archive), info.isArchive());
+        put(getRes(R.string.debug_is_blocked_from_tree), info.isBlockedFromTree());
+        put(getRes(R.string.debug_is_container), info.isContainer());
+        put(getRes(R.string.debug_is_partial), info.isPartial());
+        put(getRes(R.string.debug_is_virtual), info.isVirtual());
+        put(getRes(R.string.debug_supports_create), info.isCreateSupported());
+        put(getRes(R.string.debug_supports_delete), info.isDeleteSupported());
+        put(getRes(R.string.debug_supports_metadata), info.isMetadataSupported());
+        put(getRes(R.string.debug_supports_move), info.isMoveSupported());
+        put(getRes(R.string.debug_supports_remove), info.isRemoveSupported());
+        put(getRes(R.string.debug_supports_rename), info.isRenameSupported());
+        put(getRes(R.string.debug_supports_settings), info.isSettingsSupported());
+        put(getRes(R.string.debug_supports_thumbnail), info.isThumbnailSupported());
+        put(getRes(R.string.debug_supports_weblink), info.isWeblinkSupported());
+        put(getRes(R.string.debug_supports_write), info.isWriteSupported());
 
         // Load Document stream types of the file. For virtual files, this should be
         // something other than the primary type of the file.
@@ -106,7 +108,8 @@ public class DebugView extends TableView implements DebugDisplay {
 
                 @Override
                 protected void onPostExecute(String[] streamTypes) {
-                    put(R.string.debug_stream_types,
+                    put(
+                            getRes(R.string.debug_stream_types),
                             streamTypes != null ? Arrays.toString(streamTypes) : "[]");
                 }
             }.executeOnExecutor(executor, (Void[]) null);
@@ -130,8 +133,9 @@ public class DebugView extends TableView implements DebugDisplay {
     }
 
     private void dumpMetadata(String type, Bundle bundle) {
-        String title = mContext.getResources().getString(
-                R.string.inspector_debug_metadata_section);
+        String title =
+                mContext.getResources()
+                        .getString(getRes(R.string.inspector_debug_metadata_section));
         putTitle(String.format(title, type), true);
         List<String> keys = new ArrayList<>(bundle.keySet());
         Collections.sort(keys);
@@ -142,7 +146,7 @@ public class DebugView extends TableView implements DebugDisplay {
 
     private void put(@StringRes int key, boolean value) {
         KeyValueRow row = put(mRes.getString(key), String.valueOf(value));
-        TextView valueView = ((TextView) row.findViewById(R.id.table_row_value));
+        TextView valueView = ((TextView) row.findViewById(getRes(R.id.table_row_value)));
         valueView.setTextColor(value ? 0xFF006400 : 0xFF9A2020);
     }
 }
diff --git a/src/com/android/documentsui/inspector/DetailsView.java b/src/com/android/documentsui/inspector/DetailsView.java
index 8b3009761..29d23e07b 100644
--- a/src/com/android/documentsui/inspector/DetailsView.java
+++ b/src/com/android/documentsui/inspector/DetailsView.java
@@ -15,6 +15,8 @@
  */
 package com.android.documentsui.inspector;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.text.format.Formatter;
 import android.util.AttributeSet;
@@ -52,16 +54,19 @@ public class DetailsView extends TableView implements DetailsDisplay {
 
         String mimeType = fileTypeLookup.lookup(doc.mimeType);
 
-        put(R.string.sort_dimension_file_type, mimeType);
+        put(getRes(R.string.sort_dimension_file_type), mimeType);
 
         // TODO: Each of these rows need to be removed if the condition is false and previously
         // set.
         if (doc.size >= 0 && !doc.isDirectory()) {
-            put(R.string.sort_dimension_size, Formatter.formatFileSize(getContext(), doc.size));
+            put(
+                    getRes(R.string.sort_dimension_size),
+                    Formatter.formatFileSize(getContext(), doc.size));
         }
 
         if (doc.lastModified > 0) {
-            put(R.string.sort_dimension_date,
+            put(
+                    getRes(R.string.sort_dimension_date),
                     DateUtils.formatDate(this.getContext(), doc.lastModified));
         }
 
@@ -72,12 +77,12 @@ public class DetailsView extends TableView implements DetailsDisplay {
         // after the file is renamed, it creates even more confusion (since it still
         // shows the original). For that reason, and others. We only display on partial files.
         if (doc.isPartial() && doc.summary != null) {
-            put(R.string.sort_dimension_summary, doc.summary);
+            put(getRes(R.string.sort_dimension_summary), doc.summary);
         }
     }
 
     @Override
     public void setChildrenCount(int count) {
-        put(R.string.directory_items, String.valueOf(count));
+        put(getRes(R.string.directory_items), String.valueOf(count));
     }
 }
diff --git a/src/com/android/documentsui/inspector/HeaderView.java b/src/com/android/documentsui/inspector/HeaderView.java
index ddff7acd7..d49dd9d55 100644
--- a/src/com/android/documentsui/inspector/HeaderView.java
+++ b/src/com/android/documentsui/inspector/HeaderView.java
@@ -15,6 +15,8 @@
  */
 package com.android.documentsui.inspector;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.app.Activity;
 import android.content.Context;
 import android.graphics.Bitmap;
@@ -62,11 +64,13 @@ public final class HeaderView extends RelativeLayout implements HeaderDisplay {
         LayoutInflater inflater = (LayoutInflater) getContext().getSystemService(
                 Context.LAYOUT_INFLATER_SERVICE);
         mContext = context;
-        mHeader = inflater.inflate(R.layout.inspector_header, null);
-        mThumbnail = (ImageView) mHeader.findViewById(R.id.inspector_thumbnail);
+        mHeader = inflater.inflate(getRes(R.layout.inspector_header), null);
+        mThumbnail = (ImageView) mHeader.findViewById(getRes(R.id.inspector_thumbnail));
 
         int width = (int) Display.screenWidth((Activity)context);
-        int height = mContext.getResources().getDimensionPixelSize(R.dimen.inspector_header_height);
+        int height =
+                mContext.getResources()
+                        .getDimensionPixelSize(getRes(R.dimen.inspector_header_height));
         mImageDimensions = new Point(width, height);
         addView(mHeader);
     }
diff --git a/src/com/android/documentsui/inspector/InspectorActivity.java b/src/com/android/documentsui/inspector/InspectorActivity.java
index 948d66fb2..9d381b5b2 100644
--- a/src/com/android/documentsui/inspector/InspectorActivity.java
+++ b/src/com/android/documentsui/inspector/InspectorActivity.java
@@ -17,11 +17,12 @@ package com.android.documentsui.inspector;
 
 import static androidx.core.util.Preconditions.checkArgument;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.content.Intent;
 import android.graphics.Color;
 import android.net.Uri;
-import android.os.Build;
 import android.os.Bundle;
 import android.view.MenuItem;
 import android.view.View;
@@ -60,13 +61,13 @@ public class InspectorActivity extends AppCompatActivity {
         // ToDo Create tool to check resource version before applyStyle for the theme
         // If version code is not match, we should reset overlay package to default,
         // in case Activity continueusly encounter resource not found exception
-        getTheme().applyStyle(R.style.DocumentsDefaultTheme, false);
+        getTheme().applyStyle(getRes(R.style.DocumentsDefaultTheme), false);
 
-        setContentView(R.layout.inspector_activity);
+        setContentView(getRes(R.layout.inspector_activity));
 
         setContainer();
 
-        mToolbar = findViewById(R.id.toolbar);
+        mToolbar = findViewById(getRes(R.id.toolbar));
         setSupportActionBar(mToolbar);
         getSupportActionBar().setDisplayHomeAsUpEnabled(true);
 
@@ -105,25 +106,24 @@ public class InspectorActivity extends AppCompatActivity {
     }
 
     private void setContainer() {
-        mView = findViewById(R.id.inspector_root);
+        mView = findViewById(getRes(R.id.inspector_root));
         mView.setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
                 | View.SYSTEM_UI_FLAG_LAYOUT_STABLE);
-        mView.setOnApplyWindowInsetsListener((v, insets) -> {
-            mView.setPadding(insets.getSystemWindowInsetLeft(),
-                    insets.getSystemWindowInsetTop(),
-                    insets.getSystemWindowInsetRight(), 0);
-
-            View container = findViewById(R.id.inspector_container);
-            container.setPadding(0, 0, 0, insets.getSystemWindowInsetBottom());
-            return insets;
-        });
+        mView.setOnApplyWindowInsetsListener(
+                (v, insets) -> {
+                    mView.setPadding(
+                            insets.getSystemWindowInsetLeft(),
+                            insets.getSystemWindowInsetTop(),
+                            insets.getSystemWindowInsetRight(),
+                            0);
+
+                    View container = findViewById(getRes(R.id.inspector_container));
+                    container.setPadding(0, 0, 0, insets.getSystemWindowInsetBottom());
+                    return insets;
+                });
 
         getWindow().setNavigationBarDividerColor(Color.TRANSPARENT);
-        if (Build.VERSION.SDK_INT >= 29) {
-            getWindow().setNavigationBarColor(Color.TRANSPARENT);
-            getWindow().setNavigationBarContrastEnforced(true);
-        } else {
-            getWindow().setNavigationBarColor(getColor(R.color.nav_bar_translucent));
-        }
+        getWindow().setNavigationBarColor(Color.TRANSPARENT);
+        getWindow().setNavigationBarContrastEnforced(true);
     }
 }
\ No newline at end of file
diff --git a/src/com/android/documentsui/inspector/InspectorController.java b/src/com/android/documentsui/inspector/InspectorController.java
index 68c465dfe..8bfc1bc99 100644
--- a/src/com/android/documentsui/inspector/InspectorController.java
+++ b/src/com/android/documentsui/inspector/InspectorController.java
@@ -17,6 +17,8 @@ package com.android.documentsui.inspector;
 
 import static androidx.core.util.Preconditions.checkArgument;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.app.Activity;
 import android.content.Context;
 import android.content.Intent;
@@ -45,6 +47,7 @@ import com.android.documentsui.roots.ProvidersAccess;
 import com.android.documentsui.ui.Snackbars;
 
 import java.util.function.Consumer;
+
 /**
  * A controller that coordinates retrieving document information and sending it to the view.
  */
@@ -121,26 +124,26 @@ public final class InspectorController {
      */
     public InspectorController(Activity activity, DataSupplier loader, View layout,
             String title, boolean showDebug) {
-        this(activity,
-            loader,
-            activity.getPackageManager(),
-            DocumentsApplication.getProvidersCache (activity),
-            (HeaderView) layout.findViewById(R.id.inspector_header_view),
-            (DetailsView) layout.findViewById(R.id.inspector_details_view),
-            (MediaView) layout.findViewById(R.id.inspector_media_view),
-            (ActionDisplay) layout.findViewById(R.id.inspector_show_in_provider_view),
-            (ActionDisplay) layout.findViewById(R.id.inspector_app_defaults_view),
-            (DebugView) layout.findViewById(R.id.inspector_debug_view),
-            title,
-            showDebug,
-            () -> {
-                // using a runnable to support unit testing this feature.
-                Snackbars.showInspectorError(activity);
-            }
-        );
+        this(
+                activity,
+                loader,
+                activity.getPackageManager(),
+                DocumentsApplication.getProvidersCache(activity),
+                (HeaderView) layout.findViewById(getRes(R.id.inspector_header_view)),
+                (DetailsView) layout.findViewById(getRes(R.id.inspector_details_view)),
+                (MediaView) layout.findViewById(getRes(R.id.inspector_media_view)),
+                (ActionDisplay) layout.findViewById(getRes(R.id.inspector_show_in_provider_view)),
+                (ActionDisplay) layout.findViewById(getRes(R.id.inspector_app_defaults_view)),
+                (DebugView) layout.findViewById(getRes(R.id.inspector_debug_view)),
+                title,
+                showDebug,
+                () -> {
+                    // using a runnable to support unit testing this feature.
+                    Snackbars.showInspectorError(activity);
+                });
 
         if (showDebug) {
-            DebugView view = (DebugView) layout.findViewById(R.id.inspector_debug_view);
+            DebugView view = (DebugView) layout.findViewById(getRes(R.id.inspector_debug_view));
             view.init(ProviderExecutor::forAuthority);
         }
     }
diff --git a/src/com/android/documentsui/inspector/KeyValueRow.java b/src/com/android/documentsui/inspector/KeyValueRow.java
index 349d01794..0f03235b4 100644
--- a/src/com/android/documentsui/inspector/KeyValueRow.java
+++ b/src/com/android/documentsui/inspector/KeyValueRow.java
@@ -15,6 +15,8 @@
  */
 package com.android.documentsui.inspector;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.content.res.ColorStateList;
 import android.content.res.Resources;
@@ -64,7 +66,7 @@ public class KeyValueRow extends LinearLayout {
      * should be passed.
      */
     public void setKey(CharSequence key) {
-        ((TextView) findViewById(R.id.table_row_key)).setText(key);
+        ((TextView) findViewById(getRes(R.id.table_row_key))).setText(key);
     }
 
     public void setKey(@StringRes int id) {
@@ -72,7 +74,7 @@ public class KeyValueRow extends LinearLayout {
     }
 
     public void setValue(CharSequence value) {
-        TextView text = ((TextView) findViewById(R.id.table_row_value));
+        TextView text = ((TextView) findViewById(getRes(R.id.table_row_value)));
         text.setText(value);
         text.setTextClassifier(mClassifier);
         text.setOnLongClickListener((View view) -> {
@@ -90,13 +92,13 @@ public class KeyValueRow extends LinearLayout {
 
     @Override
     public boolean hasOnClickListeners() {
-        TextView value = findViewById(R.id.table_row_value);
+        TextView value = findViewById(getRes(R.id.table_row_value));
         return value.hasOnClickListeners();
     }
 
     @Override
     public void setOnClickListener(OnClickListener callback) {
-        TextView clickable = ((TextView) findViewById(R.id.table_row_value));
+        TextView clickable = ((TextView) findViewById(getRes(R.id.table_row_value)));
         mDefaultTextColor = clickable.getTextColors();
         TypedArray ta =
                 getContext().obtainStyledAttributes(androidx.appcompat.R.styleable.TextAppearance);
@@ -110,7 +112,7 @@ public class KeyValueRow extends LinearLayout {
     }
 
     public void removeOnClickListener() {
-        TextView reset = ((TextView) findViewById(R.id.table_row_value));
+        TextView reset = ((TextView) findViewById(getRes(R.id.table_row_value)));
         if (mDefaultTextColor != null) {
             reset.setTextColor(mDefaultTextColor);
         }
diff --git a/src/com/android/documentsui/inspector/MediaView.java b/src/com/android/documentsui/inspector/MediaView.java
index 19ec94cb6..a564824b7 100644
--- a/src/com/android/documentsui/inspector/MediaView.java
+++ b/src/com/android/documentsui/inspector/MediaView.java
@@ -15,6 +15,8 @@
  */
 package com.android.documentsui.inspector;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.content.res.Resources;
 import android.location.Address;
@@ -24,10 +26,11 @@ import android.media.MediaMetadata;
 import android.os.AsyncTask;
 import android.os.Bundle;
 import android.provider.DocumentsContract;
-import androidx.annotation.VisibleForTesting;
 import android.text.format.DateUtils;
 import android.util.AttributeSet;
 
+import androidx.annotation.VisibleForTesting;
+
 import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.Shared;
@@ -89,21 +92,27 @@ public class MediaView extends TableView implements MediaDisplay {
     public static void showAudioData(TableDisplay table, Bundle tags) {
 
         if (tags.containsKey(MediaMetadata.METADATA_KEY_ARTIST)) {
-            table.put(R.string.metadata_artist, tags.getString(MediaMetadata.METADATA_KEY_ARTIST));
+            table.put(
+                    getRes(R.string.metadata_artist),
+                    tags.getString(MediaMetadata.METADATA_KEY_ARTIST));
         }
 
         if (tags.containsKey(MediaMetadata.METADATA_KEY_COMPOSER)) {
-            table.put(R.string.metadata_composer,
+            table.put(
+                    getRes(R.string.metadata_composer),
                     tags.getString(MediaMetadata.METADATA_KEY_COMPOSER));
         }
 
         if (tags.containsKey(MediaMetadata.METADATA_KEY_ALBUM)) {
-            table.put(R.string.metadata_album, tags.getString(MediaMetadata.METADATA_KEY_ALBUM));
+            table.put(
+                    getRes(R.string.metadata_album),
+                    tags.getString(MediaMetadata.METADATA_KEY_ALBUM));
         }
 
         if (tags.containsKey(MediaMetadata.METADATA_KEY_DURATION)) {
             int millis = tags.getInt(MediaMetadata.METADATA_KEY_DURATION);
-            table.put(R.string.metadata_duration, DateUtils.formatElapsedTime(millis / 1000));
+            table.put(
+                    getRes(R.string.metadata_duration), DateUtils.formatElapsedTime(millis / 1000));
         }
     }
 
@@ -124,7 +133,8 @@ public class MediaView extends TableView implements MediaDisplay {
 
         if (tags.containsKey(MediaMetadata.METADATA_KEY_DURATION)) {
             int millis = tags.getInt(MediaMetadata.METADATA_KEY_DURATION);
-            table.put(R.string.metadata_duration, DateUtils.formatElapsedTime(millis / 1000));
+            table.put(
+                    getRes(R.string.metadata_duration), DateUtils.formatElapsedTime(millis / 1000));
         }
     }
 
@@ -141,12 +151,12 @@ public class MediaView extends TableView implements MediaDisplay {
 
         if (tags.containsKey(ExifInterface.TAG_DATETIME)) {
             String date = tags.getString(ExifInterface.TAG_DATETIME);
-            table.put(R.string.metadata_date_time, date);
+            table.put(getRes(R.string.metadata_date_time), date);
         }
 
         if (tags.containsKey(ExifInterface.TAG_GPS_ALTITUDE)) {
             double altitude = tags.getDouble(ExifInterface.TAG_GPS_ALTITUDE);
-            table.put(R.string.metadata_altitude, String.valueOf(altitude));
+            table.put(getRes(R.string.metadata_altitude), String.valueOf(altitude));
         }
 
         if (tags.containsKey(ExifInterface.TAG_MAKE) || tags.containsKey(ExifInterface.TAG_MODEL)) {
@@ -154,32 +164,38 @@ public class MediaView extends TableView implements MediaDisplay {
                 String model = tags.getString(ExifInterface.TAG_MODEL);
                 make = make != null ? make : "";
                 model = model != null ? model : "";
-                table.put(
-                        R.string.metadata_camera,
-                        resources.getString(R.string.metadata_camera_format, make, model));
+            table.put(
+                    getRes(R.string.metadata_camera),
+                    resources.getString(getRes(R.string.metadata_camera_format), make, model));
         }
 
         if (tags.containsKey(ExifInterface.TAG_APERTURE)) {
-            table.put(R.string.metadata_aperture, resources.getString(
-                    R.string.metadata_aperture_format, tags.getDouble(ExifInterface.TAG_APERTURE)));
+            table.put(
+                    getRes(R.string.metadata_aperture),
+                    resources.getString(
+                            getRes(R.string.metadata_aperture_format),
+                            tags.getDouble(ExifInterface.TAG_APERTURE)));
         }
 
         if (tags.containsKey(ExifInterface.TAG_SHUTTER_SPEED_VALUE)) {
             String shutterSpeed = String.valueOf(
                     formatShutterSpeed(tags.getDouble(ExifInterface.TAG_SHUTTER_SPEED_VALUE)));
-            table.put(R.string.metadata_shutter_speed, shutterSpeed);
+            table.put(getRes(R.string.metadata_shutter_speed), shutterSpeed);
         }
 
         if (tags.containsKey(ExifInterface.TAG_FOCAL_LENGTH)) {
             double length = tags.getDouble(ExifInterface.TAG_FOCAL_LENGTH);
-            table.put(R.string.metadata_focal_length,
-                    String.format(resources.getString(R.string.metadata_focal_format), length));
+            table.put(
+                    getRes(R.string.metadata_focal_length),
+                    String.format(
+                            resources.getString(getRes(R.string.metadata_focal_format)), length));
         }
 
         if (tags.containsKey(ExifInterface.TAG_ISO_SPEED_RATINGS)) {
             int iso = tags.getInt(ExifInterface.TAG_ISO_SPEED_RATINGS);
-            table.put(R.string.metadata_iso_speed_ratings,
-                    String.format(resources.getString(R.string.metadata_iso_format), iso));
+            table.put(
+                    getRes(R.string.metadata_iso_speed_ratings),
+                    String.format(resources.getString(getRes(R.string.metadata_iso_format)), iso));
         }
 
         if (MetadataUtils.hasExifGpsFields(tags)) {
@@ -195,18 +211,18 @@ public class MediaView extends TableView implements MediaDisplay {
             float[] coords,
             @Nullable Runnable geoClickListener) {
 
-        String value = resources.getString(
-                R.string.metadata_coordinates_format, coords[0], coords[1]);
+        String value =
+                resources.getString(
+                        getRes(R.string.metadata_coordinates_format), coords[0], coords[1]);
         if (geoClickListener != null) {
             table.put(
-                    R.string.metadata_coordinates,
+                    getRes(R.string.metadata_coordinates),
                     value,
                     view -> {
                         geoClickListener.run();
-                    }
-            );
+                    });
         } else {
-            table.put(R.string.metadata_coordinates, value);
+            table.put(getRes(R.string.metadata_coordinates), value);
         }
     }
 
@@ -221,15 +237,19 @@ public class MediaView extends TableView implements MediaDisplay {
                 assert (coords.length == 2);
                 Geocoder geocoder = new Geocoder(mContext);
                 try {
-                    Address address = geocoder.getFromLocation(coords[0], // latitude
-                            coords[1], // longitude
-                            1 // amount of results returned
-                    ).get(0);
+                    Address address =
+                            geocoder.getFromLocation(
+                                            coords[0], // latitude
+                                            coords[1], // longitude
+                                            1 // amount of results returned
+                                            )
+                                    .get(0);
                     return address;
                 } catch (IOException e) {
                     return null;
                 }
             }
+
             @Override
             protected void onPostExecute(@Nullable Address address) {
                 if (address != null) {
@@ -246,16 +266,17 @@ public class MediaView extends TableView implements MediaDisplay {
                             }
                         }
                         formattedAddress = addressBuilder.toString();
-                        table.put(R.string.metadata_address, formattedAddress);
+                        table.put(getRes(R.string.metadata_address), formattedAddress);
                     } else if (address.getLocality() != null) {
-                        table.put(R.string.metadata_address, address.getLocality());
+                        table.put(getRes(R.string.metadata_address), address.getLocality());
                     } else if (address.getSubAdminArea() != null) {
-                        table.put(R.string.metadata_address, address.getSubAdminArea());
+                        table.put(getRes(R.string.metadata_address), address.getSubAdminArea());
                     } else if (address.getAdminArea() != null) {
-                        table.put(R.string.metadata_address, address.getAdminArea());
+                        table.put(getRes(R.string.metadata_address), address.getAdminArea());
                     } else if (address.getCountryName() != null) {
-                        table.put(R.string.metadata_address, address.getCountryName());
-                    }                }
+                        table.put(getRes(R.string.metadata_address), address.getCountryName());
+                    }
+                }
             }
         }.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, coords[0], coords[1]);
     }
@@ -289,9 +310,13 @@ public class MediaView extends TableView implements MediaDisplay {
             int width = tags.getInt(ExifInterface.TAG_IMAGE_WIDTH);
             int height = tags.getInt(ExifInterface.TAG_IMAGE_LENGTH);
             float megaPixels = height * width / 1000000f;
-            table.put(R.string.metadata_dimensions,
+            table.put(
+                    getRes(R.string.metadata_dimensions),
                     resources.getString(
-                            R.string.metadata_dimensions_format, width, height, megaPixels));
+                            getRes(R.string.metadata_dimensions_format),
+                            width,
+                            height,
+                            megaPixels));
         }
     }
 }
diff --git a/src/com/android/documentsui/inspector/TableView.java b/src/com/android/documentsui/inspector/TableView.java
index b259773dc..428579ae6 100644
--- a/src/com/android/documentsui/inspector/TableView.java
+++ b/src/com/android/documentsui/inspector/TableView.java
@@ -15,6 +15,8 @@
  */
 package com.android.documentsui.inspector;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.content.res.Resources;
 import android.text.Selection;
@@ -71,11 +73,12 @@ public class TableView extends LinearLayout implements TableDisplay {
         TextView view = mTitles.get(title);
         if (view == null) {
             LinearLayout layout =
-                (LinearLayout) mInflater.inflate(R.layout.inspector_section_title, null);
+                    (LinearLayout)
+                            mInflater.inflate(getRes(R.layout.inspector_section_title), null);
             if (!showDivider) {
                 layout.setDividerDrawable(null);
             }
-            view = (TextView) layout.findViewById(R.id.inspector_header_title);
+            view = (TextView) layout.findViewById(getRes(R.id.inspector_header_title));
             addView(layout);
             mTitles.put(title, view);
         }
@@ -90,7 +93,8 @@ public class TableView extends LinearLayout implements TableDisplay {
     }
 
     protected KeyValueRow createKeyValueRow(ViewGroup parent) {
-        KeyValueRow row = (KeyValueRow) mInflater.inflate(R.layout.table_key_value_row, null);
+        KeyValueRow row =
+                (KeyValueRow) mInflater.inflate(getRes(R.layout.table_key_value_row), null);
         parent.addView(row);
         row.setTextClassifier(mClassifier);
         return row;
diff --git a/src/com/android/documentsui/inspector/actions/ActionView.java b/src/com/android/documentsui/inspector/actions/ActionView.java
index 398a6b654..ca54ade69 100644
--- a/src/com/android/documentsui/inspector/actions/ActionView.java
+++ b/src/com/android/documentsui/inspector/actions/ActionView.java
@@ -15,7 +15,8 @@
  */
 package com.android.documentsui.inspector.actions;
 
-import androidx.annotation.Nullable;
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.graphics.drawable.Drawable;
 import android.util.AttributeSet;
@@ -26,6 +27,8 @@ import android.widget.ImageView;
 import android.widget.LinearLayout;
 import android.widget.TextView;
 
+import androidx.annotation.Nullable;
+
 import com.android.documentsui.R;
 import com.android.documentsui.inspector.InspectorController;
 
@@ -54,19 +57,19 @@ public final class ActionView extends LinearLayout implements InspectorControlle
         super(context, attrs, defStyleAttr);
         LayoutInflater inflater = (LayoutInflater) getContext().getSystemService(
             Context.LAYOUT_INFLATER_SERVICE);
-        View view = inflater.inflate(R.layout.inspector_action_view, null);
+        View view = inflater.inflate(getRes(R.layout.inspector_action_view), null);
         addView(view);
 
         mContext = context;
         mHeader = getSectionTitle();
-        mAppIcon = (ImageView) findViewById(R.id.app_icon);
-        mAppName = (TextView) findViewById(R.id.app_name);
-        mActionButton = (ImageButton) findViewById(R.id.inspector_action_button);
+        mAppIcon = (ImageView) findViewById(getRes(R.id.app_icon));
+        mAppName = (TextView) findViewById(getRes(R.id.app_name));
+        mActionButton = (ImageButton) findViewById(getRes(R.id.inspector_action_button));
     }
 
     public TextView getSectionTitle() {
-        LinearLayout header = (LinearLayout) findViewById(R.id.action_header);
-        return (TextView) header.findViewById(R.id.inspector_header_title);
+        LinearLayout header = (LinearLayout) findViewById(getRes(R.id.action_header));
+        return (TextView) header.findViewById(getRes(R.id.inspector_header_title));
     }
 
     @Override
diff --git a/src/com/android/documentsui/inspector/actions/ClearDefaultAppAction.java b/src/com/android/documentsui/inspector/actions/ClearDefaultAppAction.java
index c57237c7a..d8cf9149a 100644
--- a/src/com/android/documentsui/inspector/actions/ClearDefaultAppAction.java
+++ b/src/com/android/documentsui/inspector/actions/ClearDefaultAppAction.java
@@ -15,17 +15,18 @@
  */
 package com.android.documentsui.inspector.actions;
 
-import androidx.annotation.StringRes;
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.content.Intent;
 import android.content.pm.PackageManager;
 import android.content.pm.ResolveInfo;
 
+import androidx.annotation.StringRes;
+
 import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 
-import java.util.List;
-
 /**
  * Model for clearing the default app that opens a file.
  */
@@ -40,12 +41,12 @@ public final class ClearDefaultAppAction extends Action {
      */
     @Override
     public String getHeader() {
-        return mContext.getString(R.string.handler_app_file_opens_with);
+        return mContext.getString(getRes(R.string.handler_app_file_opens_with));
     }
 
     @Override
     public int getButtonIcon() {
-        return R.drawable.ic_action_clear;
+        return getRes(R.drawable.ic_action_clear);
     }
 
     /**
@@ -72,6 +73,6 @@ public final class ClearDefaultAppAction extends Action {
     }
 
     public @StringRes int getButtonLabel() {
-        return R.string.button_clear;
+        return getRes(R.string.button_clear);
     }
 }
\ No newline at end of file
diff --git a/src/com/android/documentsui/inspector/actions/ShowInProviderAction.java b/src/com/android/documentsui/inspector/actions/ShowInProviderAction.java
index 447cc1885..8d0988779 100644
--- a/src/com/android/documentsui/inspector/actions/ShowInProviderAction.java
+++ b/src/com/android/documentsui/inspector/actions/ShowInProviderAction.java
@@ -17,6 +17,8 @@ package com.android.documentsui.inspector.actions;
 
 import static android.provider.DocumentsContract.Document.FLAG_SUPPORTS_SETTINGS;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.content.pm.PackageManager;
 
@@ -45,12 +47,12 @@ public final class ShowInProviderAction extends Action {
      */
     @Override
     public String getHeader() {
-        return mContext.getString(R.string.handler_app_belongs_to);
+        return mContext.getString(getRes(R.string.handler_app_belongs_to));
     }
 
     @Override
     public int getButtonIcon() {
-        return R.drawable.ic_action_open;
+        return getRes(R.drawable.ic_action_open);
     }
 
     /**
@@ -71,6 +73,6 @@ public final class ShowInProviderAction extends Action {
     }
 
     public @StringRes int getButtonLabel() {
-        return R.string.button_show_provider;
+        return getRes(R.string.button_show_provider);
     }
 }
\ No newline at end of file
diff --git a/src/com/android/documentsui/loaders/BaseFileLoader.kt b/src/com/android/documentsui/loaders/BaseFileLoader.kt
index fcb1d4cb0..d63e3ceef 100644
--- a/src/com/android/documentsui/loaders/BaseFileLoader.kt
+++ b/src/com/android/documentsui/loaders/BaseFileLoader.kt
@@ -28,6 +28,7 @@ import android.util.Log
 import androidx.loader.content.AsyncTaskLoader
 import com.android.documentsui.DirectoryResult
 import com.android.documentsui.base.Lookup
+import com.android.documentsui.base.SharedMinimal.DEBUG
 import com.android.documentsui.base.UserId
 import com.android.documentsui.roots.RootCursorWrapper
 
@@ -69,30 +70,34 @@ fun toSingleCursor(cursorList: List<Cursor>): Cursor {
  */
 abstract class BaseFileLoader(
     context: Context,
-    private val mUserIdList: List<UserId>,
-    protected val mMimeTypeLookup: Lookup<String, String>,
+    private val userIdList: List<UserId>,
+    protected val mimeTypeLookup: Lookup<String, String>,
 ) : AsyncTaskLoader<DirectoryResult>(context) {
 
-    private var mSignal: CancellationSignal? = null
-    private var mResult: DirectoryResult? = null
+    private var signal: CancellationSignal? = null
+    private var storedResult: DirectoryResult? = null
 
     override fun cancelLoadInBackground() {
-        Log.d(TAG, "${this::class.simpleName}.cancelLoadInBackground")
+        if (DEBUG) {
+            Log.d(TAG, "${this::class.simpleName}.cancelLoadInBackground")
+        }
         super.cancelLoadInBackground()
 
         synchronized(this) {
-            mSignal?.cancel()
+            signal?.cancel()
         }
     }
 
     override fun deliverResult(result: DirectoryResult?) {
-        Log.d(TAG, "${this::class.simpleName}.deliverResult")
+        if (DEBUG) {
+            Log.d(TAG, "${this::class.simpleName}.deliverResult")
+        }
         if (isReset) {
             closeResult(result)
             return
         }
-        val oldResult: DirectoryResult? = mResult
-        mResult = result
+        val oldResult: DirectoryResult? = storedResult
+        storedResult = result
 
         if (isStarted) {
             super.deliverResult(result)
@@ -104,35 +109,43 @@ abstract class BaseFileLoader(
     }
 
     override fun onStartLoading() {
-        Log.d(TAG, "${this::class.simpleName}.onStartLoading")
-        val isCursorStale: Boolean = checkIfCursorStale(mResult)
-        if (mResult != null && !isCursorStale) {
-            deliverResult(mResult)
+        if (DEBUG) {
+            Log.d(TAG, "${this::class.simpleName}.onStartLoading")
+        }
+        val isCursorStale: Boolean = checkIfCursorStale(storedResult)
+        if (storedResult != null && !isCursorStale) {
+            deliverResult(storedResult)
         }
-        if (takeContentChanged() || mResult == null || isCursorStale) {
+        if (takeContentChanged() || storedResult == null || isCursorStale) {
             forceLoad()
         }
     }
 
     override fun onStopLoading() {
-        Log.d(TAG, "${this::class.simpleName}.onStopLoading")
+        if (DEBUG) {
+            Log.d(TAG, "${this::class.simpleName}.onStopLoading")
+        }
         cancelLoad()
     }
 
     override fun onCanceled(result: DirectoryResult?) {
-        Log.d(TAG, "${this::class.simpleName}.onCanceled")
+        if (DEBUG) {
+            Log.d(TAG, "${this::class.simpleName}.onCanceled")
+        }
         closeResult(result)
     }
 
     override fun onReset() {
-        Log.d(TAG, "${this::class.simpleName}.onReset")
+        if (DEBUG) {
+            Log.d(TAG, "${this::class.simpleName}.onReset")
+        }
         super.onReset()
 
         // Ensure the loader is stopped
         onStopLoading()
 
-        closeResult(mResult)
-        mResult = null
+        closeResult(storedResult)
+        storedResult = null
     }
 
     /**
@@ -142,7 +155,9 @@ abstract class BaseFileLoader(
         try {
             result?.close()
         } catch (e: Exception) {
-            Log.d(TAG, "Failed to close result", e)
+            if (DEBUG) {
+                Log.d(TAG, "Failed to close result", e)
+            }
         }
     }
 
@@ -154,7 +169,9 @@ abstract class BaseFileLoader(
         if (cursor.isClosed) {
             return true
         }
-        Log.d(TAG, "Long check of cursor staleness")
+        if (DEBUG) {
+            Log.d(TAG, "Long check of cursor staleness")
+        }
         val count = cursor.count
         if (!cursor.moveToPosition(-1)) {
             return true
@@ -180,8 +197,10 @@ abstract class BaseFileLoader(
         maxResults: Int,
     ): Cursor? {
         val authority = locationUri.authority ?: return null
-        for (userId in mUserIdList) {
-            Log.d(TAG, "BaseFileLoader.queryLocation for $userId at $locationUri")
+        for (userId in userIdList) {
+            if (DEBUG) {
+                Log.d(TAG, "BaseFileLoader.queryLocation for $userId at $locationUri")
+            }
             val resolver = userId.getContentResolver(context)
             try {
                 resolver.acquireUnstableContentProviderClient(
@@ -192,14 +211,18 @@ abstract class BaseFileLoader(
                     }
                     try {
                         val cursor =
-                            client.query(locationUri, null, queryArgs, mSignal) ?: return null
+                            client.query(locationUri, null, queryArgs, signal) ?: return null
                         return RootCursorWrapper(userId, authority, rootId, cursor, maxResults)
                     } catch (e: RemoteException) {
-                        Log.d(TAG, "Failed to get cursor for $locationUri", e)
+                        if (DEBUG) {
+                            Log.d(TAG, "Failed to get cursor for $locationUri", e)
+                        }
                     }
                 }
             } catch (e: Exception) {
-                Log.d(TAG, "Failed to get a content provider client for $locationUri", e)
+                if (DEBUG) {
+                    Log.d(TAG, "Failed to get a content provider client for $locationUri", e)
+                }
             }
         }
 
diff --git a/src/com/android/documentsui/loaders/FolderLoader.kt b/src/com/android/documentsui/loaders/FolderLoader.kt
index 40c15dfe1..66a3d973d 100644
--- a/src/com/android/documentsui/loaders/FolderLoader.kt
+++ b/src/com/android/documentsui/loaders/FolderLoader.kt
@@ -15,11 +15,16 @@
  */
 package com.android.documentsui.loaders
 
+import android.content.ContentProviderClient
 import android.content.Context
+import android.net.Uri
+import android.os.RemoteException
 import android.provider.DocumentsContract
+import android.util.Log
 import com.android.documentsui.ContentLock
 import com.android.documentsui.DirectoryResult
 import com.android.documentsui.LockingContentObserver
+import com.android.documentsui.archives.ArchivesProvider
 import com.android.documentsui.base.DocumentInfo
 import com.android.documentsui.base.FilteringCursorWrapper
 import com.android.documentsui.base.Lookup
@@ -35,9 +40,14 @@ import com.android.documentsui.sorting.SortModel
  *  - A content lock for which a locking content observer is built
  *  - A list of user IDs on behalf of which the search is conducted
  *  - The root info of the listed directory
- *  - The document info of the listed directory
+ *  - The document info of the listed directory, may be null.
  *  - a lookup from file extension to file type
  *  - The model capable of sorting results
+ *
+ *  Typically, here we expect mListedDir to be not null, as this is the directory we are listing.
+ *  However, when profile is switched while using the app as a file picker, it is possible that
+ *  the listing directory is null. If this is the case, we assume that we should be listing the
+ *  location specified by the mRoot.
  */
 class FolderLoader(
     context: Context,
@@ -45,7 +55,7 @@ class FolderLoader(
     mimeTypeLookup: Lookup<String, String>,
     contentLock: ContentLock,
     private val mRoot: RootInfo,
-    private val mListedDir: DocumentInfo,
+    private val mListedDir: DocumentInfo?,
     private val mOptions: QueryOptions,
     private val mSortModel: SortModel,
 ) : BaseFileLoader(context, userIdList, mimeTypeLookup) {
@@ -56,13 +66,30 @@ class FolderLoader(
     // Creates a directory result object corresponding to the current parameters of the loader.
     override fun loadInBackground(): DirectoryResult? {
         val rejectBeforeTimestamp = mOptions.getRejectBeforeTimestamp()
-        val folderChildrenUri = DocumentsContract.buildChildDocumentsUri(
-            mListedDir.authority,
-            mListedDir.documentId
-        )
-        val cursor =
+        val folderChildrenUri =
+            if (mListedDir == null) {
+                DocumentsContract.buildChildDocumentsUri(
+                    mRoot.authority,
+                    mRoot.documentId
+                )
+            } else {
+                DocumentsContract.buildChildDocumentsUri(
+                    mListedDir.authority,
+                    mListedDir.documentId
+                )
+            }
+        val result = DirectoryResult()
+        // If we are listing an archive, in the current approach, we cache the client as part of
+        // DirectoryResult. This way, when the loader is closed, we can close the archive client.
+        if (mListedDir != null && mListedDir.isInArchive) {
+            result.setClient(openArchive(folderChildrenUri))
+        }
+        var cursor =
             queryLocation(mRoot.rootId, folderChildrenUri, mOptions.otherQueryArgs, ALL_RESULTS)
-                ?: emptyCursor()
+        if (cursor == null) {
+            cursor = emptyCursor()
+            result.setClient(null)
+        }
         cursor.registerContentObserver(mObserver)
 
         val filteredCursor = FilteringCursorWrapper(cursor)
@@ -72,11 +99,31 @@ class FolderLoader(
             filteredCursor.filterLastModified(rejectBeforeTimestamp)
         }
         // TODO(b:380945065): Add filtering by category, such as images, audio, video.
-        val sortedCursor = mSortModel.sortCursor(filteredCursor, mMimeTypeLookup)
+        val sortedCursor = mSortModel.sortCursor(filteredCursor, mimeTypeLookup)
 
-        val result = DirectoryResult()
-        result.doc = mListedDir
+        result.doc = mListedDir ?: DocumentInfo()
         result.cursor = sortedCursor
         return result
     }
+
+    /**
+     * Helper function that attempts to open an archive and return a long lasting content provider
+     * client to the soon to be scanned archive. This must be done before attempting to acquire the
+     * cursor, as we depend on archive content to be read (see acquireArchive method).
+     */
+    private fun openArchive(folderChildrenUri: Uri): ContentProviderClient? {
+        // If we are opening an archive, we need, in the current approach, to have a long lived
+        // ContentProviderClient for it. This is so that the archive can be closed, once the
+        // loader results are closed.
+        var client: ContentProviderClient? = null
+        try {
+            val resolver = mRoot.userId.getContentResolver(context)
+            client = resolver.acquireUnstableContentProviderClient(folderChildrenUri.authority!!)
+            ArchivesProvider.acquireArchive(client, folderChildrenUri)
+        } catch (e: RemoteException) {
+            Log.e(TAG, "Failed to acquire archive client", e)
+            client?.close()
+        }
+        return client
+    }
 }
diff --git a/src/com/android/documentsui/loaders/QueryOptions.kt b/src/com/android/documentsui/loaders/QueryOptions.kt
index 385815e99..dbcee5368 100644
--- a/src/com/android/documentsui/loaders/QueryOptions.kt
+++ b/src/com/android/documentsui/loaders/QueryOptions.kt
@@ -17,6 +17,7 @@ package com.android.documentsui.loaders
 
 import android.os.Bundle
 import java.time.Duration
+import java.util.Objects
 
 /**
  * The constant to be used for the maxResults parameter, if we wish to get all (unlimited) results.
@@ -25,7 +26,11 @@ const val ALL_RESULTS: Int = -1
 
 /**
  * Common query options. These are:
- *  - maximum number to return; pass ALL_RESULTS to impose no limits.
+ *  - maximum number of results to return across all queried providers; pass ALL_RESULTS to impose
+ *    no limits.
+ *  - maximum number of results to return *per root*; pass ALL_RESULTS to impose no limits,
+ *    and note that this only works for DocumentsProviders that support QUERY_ARG_LIMIT for queries
+ *    on their Roots.
  *  - maximum lastModified delta in milliseconds: the delta from now used to reject files that were
  *    not modified in the specified milliseconds; pass null for no limits.
  *  - maximum time the query should return, including empty, results; pass null for no limits.
@@ -40,6 +45,7 @@ const val ALL_RESULTS: Int = -1
  */
 data class QueryOptions(
     val maxResults: Int,
+    val maxResultsPerRoot: Int,
     val maxLastModifiedDelta: Duration?,
     val maxQueryTime: Duration?,
     val showHidden: Boolean,
@@ -54,6 +60,7 @@ data class QueryOptions(
         other as QueryOptions
 
         return maxResults == other.maxResults &&
+                maxResultsPerRoot == other.maxResultsPerRoot &&
                 maxLastModifiedDelta == other.maxLastModifiedDelta &&
                 maxQueryTime == other.maxQueryTime &&
                 showHidden == other.showHidden &&
@@ -80,11 +87,13 @@ data class QueryOptions(
     fun isQueryTimeUnlimited() = maxQueryTime == null
 
     override fun hashCode(): Int {
-        var result = maxResults
-        result = 31 * result + maxLastModifiedDelta.hashCode()
-        result = 31 * result + maxQueryTime.hashCode()
-        result = 31 * result + showHidden.hashCode()
-        result = 31 * result + acceptableMimeTypes.contentHashCode()
-        return result
+        return Objects.hash(
+            maxResults,
+            maxResultsPerRoot,
+            maxLastModifiedDelta,
+            maxQueryTime,
+            showHidden,
+            acceptableMimeTypes.contentHashCode()
+        )
     }
 }
diff --git a/src/com/android/documentsui/loaders/SearchLoader.kt b/src/com/android/documentsui/loaders/SearchLoader.kt
index f0da924e2..358328c82 100644
--- a/src/com/android/documentsui/loaders/SearchLoader.kt
+++ b/src/com/android/documentsui/loaders/SearchLoader.kt
@@ -15,6 +15,7 @@
  */
 package com.android.documentsui.loaders
 
+import android.content.ContentResolver
 import android.content.Context
 import android.database.Cursor
 import android.net.Uri
@@ -27,8 +28,9 @@ import com.android.documentsui.DirectoryResult
 import com.android.documentsui.LockingContentObserver
 import com.android.documentsui.base.DocumentInfo
 import com.android.documentsui.base.FilteringCursorWrapper
+import com.android.documentsui.base.FolderInfo
 import com.android.documentsui.base.Lookup
-import com.android.documentsui.base.RootInfo
+import com.android.documentsui.base.SharedMinimal.DEBUG
 import com.android.documentsui.base.UserId
 import com.android.documentsui.sorting.SortModel
 import com.google.common.util.concurrent.AbstractFuture
@@ -60,12 +62,12 @@ class SearchLoader(
     context: Context,
     userIdList: List<UserId>,
     mimeTypeLookup: Lookup<String, String>,
-    private val mObserver: LockingContentObserver,
-    private val mRootList: Collection<RootInfo>,
-    private val mQuery: String?,
-    private val mOptions: QueryOptions,
-    private val mSortModel: SortModel,
-    private val mExecutorService: ExecutorService,
+    private val observer: LockingContentObserver,
+    private val folderList: Collection<FolderInfo>,
+    private val query: String?,
+    private val options: QueryOptions,
+    private val sortModel: SortModel,
+    private val executorService: ExecutorService,
 ) : BaseFileLoader(context, userIdList, mimeTypeLookup) {
 
     /**
@@ -74,29 +76,30 @@ class SearchLoader(
      * method.
      */
     inner class SearchTask(
-        private val mRootId: String,
-        private val mSearchUri: Uri,
-        private val mQueryArgs: Bundle,
-        private val mLatch: CountDownLatch,
+        private val rootId: String,
+        private val searchUri: Uri,
+        private val queryArgs: Bundle,
+        private val latch: CountDownLatch,
     ) : Closeable, Runnable, AbstractFuture<Cursor>() {
-        private var mCursor: Cursor? = null
-        val cursor: Cursor? get() = mCursor
-        val taskId: String get() = mSearchUri.toString()
+        internal var cursor: Cursor? = null
+        val taskId: String get() = searchUri.toString()
 
         override fun close() {
-            mCursor = null
+            cursor = null
         }
 
         override fun run() {
             val queryDuration = measureTime {
                 try {
-                    mCursor = queryLocation(mRootId, mSearchUri, mQueryArgs, mOptions.maxResults)
-                    set(mCursor)
+                    cursor = queryLocation(rootId, searchUri, queryArgs, options.maxResults)
+                    set(cursor)
                 } finally {
-                    mLatch.countDown()
+                    latch.countDown()
                 }
             }
-            Log.d(TAG, "Query on $mSearchUri took $queryDuration")
+            if (DEBUG) {
+                Log.d(TAG, "Query on $searchUri took $queryDuration")
+            }
         }
     }
 
@@ -110,14 +113,15 @@ class SearchLoader(
         result.doc = DocumentInfo()
         result.cursor = emptyCursor()
 
-        val searchedRoots = mRootList
-        val countDownLatch = CountDownLatch(searchedRoots.size)
-        val rejectBeforeTimestamp = mOptions.getRejectBeforeTimestamp()
+        val countDownLatch = CountDownLatch(folderList.size)
+        val rejectBeforeTimestamp = options.getRejectBeforeTimestamp()
 
         // Step 1: Build a list of search tasks.
         val searchTaskList =
-            createSearchTaskList(rejectBeforeTimestamp, countDownLatch, mRootList)
-        Log.d(TAG, "${searchTaskList.size} tasks have been created")
+            createSearchTaskList(rejectBeforeTimestamp, countDownLatch, folderList)
+        if (DEBUG) {
+            Log.d(TAG, "${searchTaskList.size} tasks have been created")
+        }
 
         // Check if we are cancelled; if not copy the task list.
         if (isLoadInBackgroundCanceled) {
@@ -127,94 +131,123 @@ class SearchLoader(
 
         // Step 2: Enqueue tasks and wait for them to complete or time out.
         for (task in mSearchTaskList) {
-            mExecutorService.execute(task)
+            executorService.execute(task)
+        }
+        if (DEBUG) {
+            Log.d(TAG, "${mSearchTaskList.size} tasks have been enqueued")
         }
-        Log.d(TAG, "${mSearchTaskList.size} tasks have been enqueued")
 
         // Step 3: Wait for the results.
         try {
-            if (mOptions.isQueryTimeUnlimited()) {
-                Log.d(TAG, "Waiting for results with no time limit")
+            if (options.isQueryTimeUnlimited()) {
+                if (DEBUG) {
+                    Log.d(TAG, "Waiting for results with no time limit")
+                }
                 countDownLatch.await()
             } else {
-                Log.d(TAG, "Waiting ${mOptions.maxQueryTime!!.toMillis()}ms for results")
+                if (DEBUG) {
+                    Log.d(TAG, "Waiting ${options.maxQueryTime!!.toMillis()}ms for results")
+                }
                 countDownLatch.await(
-                    mOptions.maxQueryTime.toMillis(),
+                    options.maxQueryTime!!.toMillis(),
                     TimeUnit.MILLISECONDS
                 )
             }
-            Log.d(TAG, "Waiting for results is done")
+            if (DEBUG) {
+                Log.d(TAG, "Waiting for results is done")
+            }
         } catch (e: InterruptedException) {
-            Log.d(TAG, "Failed to complete all searches within ${mOptions.maxQueryTime}")
+            if (DEBUG) {
+                Log.d(TAG, "Failed to complete all searches within ${options.maxQueryTime}")
+            }
             // TODO(b:388336095): Record a metrics indicating incomplete search.
             throw RuntimeException(e)
         }
 
         // Step 4: Collect cursors from done tasks.
+        var allDone = true
         val cursorList = mutableListOf<Cursor>()
         for (task in mSearchTaskList) {
-            Log.d(TAG, "Processing task ${task.taskId}")
+            if (DEBUG) {
+                Log.d(TAG, "Processing task ${task.taskId}")
+            }
             if (isLoadInBackgroundCanceled) {
                 break
             }
             // TODO(b:388336095): Record a metric for each done and not done task.
             val cursor = task.cursor
-            if (task.isDone && cursor != null) {
+            if (!task.isDone) {
+                allDone = false
+            } else if (cursor != null) {
                 // TODO(b:388336095): Record a metric for null and not null cursor.
-                Log.d(TAG, "Task ${task.taskId} has ${cursor.count} results")
+                if (DEBUG) {
+                    Log.d(TAG, "Task ${task.taskId} has ${cursor.count} results")
+                }
                 cursorList.add(cursor)
             }
         }
-        Log.d(TAG, "Search complete with ${cursorList.size} cursors collected")
+        if (DEBUG) {
+            Log.d(TAG, "Search complete with ${cursorList.size} cursors collected")
+        }
 
         // Step 5: Assign the cursor, after adding filtering and sorting, to the results.
-        val mergedCursor = toSingleCursor(cursorList)
-        mergedCursor.registerContentObserver(mObserver)
+        val cursorExtras = Bundle().apply {
+            putBoolean(DocumentsContract.EXTRA_LOADING, !allDone)
+        }
+        val mergedCursor = toSingleCursor(cursorList).apply {
+            setExtras(cursorExtras)
+        }
+        mergedCursor.registerContentObserver(observer)
         val filteringCursor = FilteringCursorWrapper(mergedCursor)
-        filteringCursor.filterHiddenFiles(mOptions.showHidden)
+        filteringCursor.filterHiddenFiles(options.showHidden)
         filteringCursor.filterMimes(
-            mOptions.acceptableMimeTypes,
-            if (TextUtils.isEmpty(mQuery)) arrayOf<String>(Document.MIME_TYPE_DIR) else null
+            options.acceptableMimeTypes,
+            if (TextUtils.isEmpty(query)) arrayOf(Document.MIME_TYPE_DIR) else null
         )
         if (rejectBeforeTimestamp > 0L) {
             filteringCursor.filterLastModified(rejectBeforeTimestamp)
         }
-        result.cursor = mSortModel.sortCursor(filteringCursor, mMimeTypeLookup)
+        result.cursor = sortModel.sortCursor(filteringCursor, mimeTypeLookup)
 
         // TODO(b:388336095): Record the total time it took to complete search.
         return result
     }
 
-    private fun createContentProviderQuery(root: RootInfo) =
-        if (TextUtils.isEmpty(mQuery) && mOptions.otherQueryArgs.isEmpty) {
+    private fun createContentProviderQuery(folder: FolderInfo) =
+        if (TextUtils.isEmpty(query) && options.otherQueryArgs.isEmpty) {
             // NOTE: recent document URI does not respect query-arg-mime-types restrictions. Thus
             // we only create the recents URI if both the query and other args are empty.
             DocumentsContract.buildRecentDocumentsUri(
-                root.authority,
-                root.rootId
+                folder.authority,
+                folder.folderId
             )
         } else {
-            // NOTE: We pass empty query, as the name matching query is placed in queryArgs.
             DocumentsContract.buildSearchDocumentsUri(
-                root.authority,
-                root.rootId,
-                ""
+                folder.authority,
+                folder.folderId,
+                query,
             )
         }
 
-    private fun createQueryArgs(rejectBeforeTimestamp: Long): Bundle {
+    private fun createQueryArgs(
+        rootSupportsSearchResultLimiting: Boolean,
+        rejectBeforeTimestamp: Long
+    ): Bundle {
         val queryArgs = Bundle()
-        mSortModel.addQuerySortArgs(queryArgs)
+        sortModel.addQuerySortArgs(queryArgs)
         if (rejectBeforeTimestamp > 0L) {
             queryArgs.putLong(
                 DocumentsContract.QUERY_ARG_LAST_MODIFIED_AFTER,
                 rejectBeforeTimestamp
             )
         }
-        if (!TextUtils.isEmpty(mQuery)) {
-            queryArgs.putString(DocumentsContract.QUERY_ARG_DISPLAY_NAME, mQuery)
+        if (!TextUtils.isEmpty(query)) {
+            queryArgs.putString(DocumentsContract.QUERY_ARG_DISPLAY_NAME, query)
         }
-        queryArgs.putAll(mOptions.otherQueryArgs)
+        if (rootSupportsSearchResultLimiting && options.maxResultsPerRoot > ALL_RESULTS) {
+            queryArgs.putInt(ContentResolver.QUERY_ARG_LIMIT, options.maxResultsPerRoot)
+        }
+        queryArgs.putAll(options.otherQueryArgs)
         return queryArgs
     }
 
@@ -224,20 +257,23 @@ class SearchLoader(
     private fun createSearchTaskList(
         rejectBeforeTimestamp: Long,
         countDownLatch: CountDownLatch,
-        rootList: Collection<RootInfo>
+        folderList: Collection<FolderInfo>
     ): List<SearchTask> {
         val searchTaskList = mutableListOf<SearchTask>()
-        for (root in rootList) {
+        for (folder in folderList) {
             if (isLoadInBackgroundCanceled) {
                 break
             }
-            val rootSearchUri = createContentProviderQuery(root)
+            val rootSearchUri = createContentProviderQuery(folder)
             // TODO(b:385789236): Correctly pass sort order information.
-            val queryArgs = createQueryArgs(rejectBeforeTimestamp)
-            mSortModel.addQuerySortArgs(queryArgs)
-            Log.d(TAG, "Query $rootSearchUri and queryArgs $queryArgs")
+            val queryArgs =
+                createQueryArgs(folder.supportsSearchResultLimiting, rejectBeforeTimestamp)
+            sortModel.addQuerySortArgs(queryArgs)
+            if (DEBUG) {
+                Log.d(TAG, "Query $rootSearchUri and queryArgs $queryArgs")
+            }
             val task = SearchTask(
-                root.rootId,
+                folder.folderId,
                 rootSearchUri,
                 queryArgs,
                 countDownLatch
@@ -251,7 +287,9 @@ class SearchLoader(
         for (task in mSearchTaskList) {
             task.close()
         }
-        Log.d(TAG, "Resetting search loader; search task list emptied.")
+        if (DEBUG) {
+            Log.d(TAG, "Resetting search loader; search task list emptied.")
+        }
         super.onReset()
     }
 }
diff --git a/src/com/android/documentsui/peek/MetadataView.kt b/src/com/android/documentsui/peek/MetadataView.kt
new file mode 100644
index 000000000..98a68ff56
--- /dev/null
+++ b/src/com/android/documentsui/peek/MetadataView.kt
@@ -0,0 +1,34 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.peek
+
+import android.content.Context
+import android.view.LayoutInflater
+import android.widget.FrameLayout
+import com.android.documentsui.R
+import com.android.documentsui.base.DocumentInfo
+
+/** Custom view component used to display the metadata in Peek. */
+class MetadataView(context: Context) : FrameLayout(context), PeekFragment.Display {
+    init {
+        @Suppress("ktlint:standard:comment-wrapping")
+        LayoutInflater.from(context).inflate(R.layout.peek_metadata_layout, /* root= */ this)
+    }
+
+    override fun accept(doc: DocumentInfo) {}
+
+    override fun clear() {}
+}
diff --git a/src/com/android/documentsui/peek/PeekFragment.kt b/src/com/android/documentsui/peek/PeekFragment.kt
index 50ee64efc..8f968fb79 100644
--- a/src/com/android/documentsui/peek/PeekFragment.kt
+++ b/src/com/android/documentsui/peek/PeekFragment.kt
@@ -16,17 +16,141 @@
 package com.android.documentsui.peek
 
 import android.os.Bundle
+import android.util.Log
 import android.view.LayoutInflater
 import android.view.View
 import android.view.ViewGroup
+import android.widget.FrameLayout
 import androidx.fragment.app.Fragment
-
+import androidx.lifecycle.Observer
+import androidx.lifecycle.ViewModelProvider
 import com.android.documentsui.R
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.util.Material3Config.Companion.getRes
+import com.google.android.material.appbar.MaterialToolbar
+import com.google.android.material.sidesheet.SideSheetBehavior
+import java.io.FileNotFoundException
 
+/** Manages the Peek UI. */
 class PeekFragment : Fragment() {
+    companion object {
+        private const val TAG = "PeekFragment"
+    }
+
+    // Interface for custom view components that are rendered based on a DocumentInfo.
+    interface Display {
+        fun accept(doc: DocumentInfo)
+
+        fun clear()
+    }
+
+    // ViewModel holding the UI state of Peek, scoped to DocumentsUI's activity.
+    private lateinit var viewModel: PeekViewModel
+
+    // Top bar view.
+    private var toolbar: MaterialToolbar? = null
+
+    // Rendering view.
+    private var previewFrame: FrameLayout? = null
+    private var previewHandler: PreviewHandler? = null
+
+    // Metadata view.
+    private var metadataContainer: FrameLayout? = null
+    private var metadataView: MetadataView? = null
+    private var metadataSheetBehavior: SideSheetBehavior<FrameLayout>? = null
+
+    override fun onCreate(savedInstanceState: Bundle?) {
+        super.onCreate(savedInstanceState)
+        viewModel = ViewModelProvider(requireActivity())[PeekViewModel::class.java]
+        viewModel.docInfo.observe(
+            requireActivity(),
+            Observer { docInfo ->
+                // Executes immediately when the observer is set.
+                updateView(docInfo)
+            }
+        )
+    }
+
+    @Suppress("ktlint:standard:comment-wrapping")
     override fun onCreateView(
-        inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?
+        inflater: LayoutInflater,
+        container: ViewGroup?,
+        savedInstanceState: Bundle?
     ): View? {
-        return inflater.inflate(R.layout.peek_layout, container, /* attachToRoot= */ false)
+        val view =
+            inflater.inflate(getRes(R.layout.peek_layout), container, /* attachToRoot= */ false)
+        toolbar = view.findViewById(getRes(R.id.peek_toolbar))
+        toolbar!!.setNavigationOnClickListener { clearAndHide() }
+        previewFrame = view.findViewById(getRes(R.id.peek_preview_frame))
+
+        metadataContainer = view.findViewById(R.id.peek_metadata_container)
+        metadataView = MetadataView(requireContext())
+        metadataContainer!!.addView(metadataView)
+        metadataSheetBehavior = SideSheetBehavior.from(metadataContainer!!)
+
+        val savedDocInfo = viewModel.docInfo.value
+        if (savedDocInfo != null) {
+            try {
+                savedDocInfo.updateSelf(
+                    savedDocInfo.userId.getContentResolver(context),
+                    savedDocInfo.userId
+                )
+                updateView(savedDocInfo)
+            } catch (e: FileNotFoundException) {
+                Log.e(TAG, "Stale document info: $e")
+                clearAndHide()
+            }
+        }
+        return view
+    }
+
+    override fun onViewStateRestored(savedInstanceState: Bundle?) {
+        super.onViewStateRestored(savedInstanceState)
+        // Hide the metadata sheet to override the Material SideSheet state restoration behavior.
+        // Details:
+        // After `onCreateView`, the metadataSheetBehavior restores the expanded state of the sheet
+        // via its `onRestoreInstanceState` implementation. `onViewStateRestored` is subsequently
+        // called, allowing us to override this state restoration with `metadataSheetBehavior.hide`.
+        // `updateView` is responsible for re-expanding the sheet, by posting a
+        // `metadataSheetBehavior.expand` task which executes after the fragment has been rendered
+        // on screen (which triggers an expand animation, addressing b/419446581).
+        metadataSheetBehavior?.hide()
+    }
+
+    private fun updateView(docInfo: DocumentInfo?) {
+        if (docInfo == null) {
+            return
+        }
+        if (toolbar == null ||
+            previewFrame == null ||
+            metadataView == null ||
+            metadataContainer == null ||
+            metadataSheetBehavior == null) {
+            // `updateView` will be called again when onCreateView executes.
+            return
+        }
+        // `Expand` needs to be called after the view is visible and fully drawn (see b/419446581).
+        // With the check above, we know that onCreateView has been called.
+        // The `post` task will execute after the current layout pass, ensuring that we can see the
+        // "expand" animation.
+        if (viewModel.overlayActive.value == true) {
+            metadataContainer!!.post { metadataSheetBehavior!!.expand() }
+        }
+        toolbar!!.title = docInfo.displayName
+        previewHandler?.clear()
+        previewHandler =
+            when {
+                docInfo.mimeType.startsWith("image/") ->
+                    ImagePreviewHandler(previewFrame!!, docInfo)
+                else -> DefaultPreviewHandler(previewFrame!!)
+            }
+        metadataView!!.accept(docInfo)
+    }
+
+    private fun clearAndHide() {
+        viewModel.clear()
+        toolbar?.title = ""
+        previewHandler?.clear()
+        previewHandler = null
     }
 }
diff --git a/src/com/android/documentsui/peek/PeekViewManager.kt b/src/com/android/documentsui/peek/PeekViewManager.kt
index 9bbeba3bf..7d6adf91a 100644
--- a/src/com/android/documentsui/peek/PeekViewManager.kt
+++ b/src/com/android/documentsui/peek/PeekViewManager.kt
@@ -15,69 +15,76 @@
  */
 package com.android.documentsui.peek
 
-import android.app.Activity
-import android.os.Bundle
 import android.util.Log
 import android.view.View
 import android.widget.FrameLayout
-import androidx.annotation.IdRes
 import androidx.fragment.app.FragmentManager
-import com.android.documentsui.R
 import androidx.fragment.app.FragmentTransaction
+import androidx.lifecycle.Observer
+import com.android.documentsui.R
 import com.android.documentsui.base.DocumentInfo
-import com.android.documentsui.util.FlagUtils.Companion.isUsePeekPreviewFlagEnabled
+import com.android.documentsui.util.Material3Config.Companion.getRes
 
-/**
- * Manager that controls the Peek UI.
- */
+/** Manager that controls the Peek UI. */
 open class PeekViewManager(
-    private val mActivity: Activity
-) {
+    private val viewModel: PeekViewModel,
+    private val container: FrameLayout,
+    val fm: FragmentManager
+) : Observer<Boolean?> {
     companion object {
-        const val TAG = "PeekViewManager"
+        private const val TAG = "PeekViewManager"
     }
 
-    private var mPeekFragment: PeekFragment? = null
+    private lateinit var peekFragment: PeekFragment
 
-    open fun initFragment(
-        fm: FragmentManager
-    ) {
-        if (!isUsePeekPreviewFlagEnabled()) {
-            Log.e(TAG, "Attempting to create PeekViewManager while Peek disabled")
-            return
-        }
+    init {
+        initialize()
+    }
 
-        if (getOverlayContainer() == null) {
-            Log.e(TAG, "Unable to find Peek container")
-            return
+    protected open fun initialize() {
+        // Restore the Peek overlay if it was active.
+        if (viewModel.overlayActive.value == true) {
+            maybeInitializeFragment()
+            setContainerVisibility(true)
         }
-
-        // Load the Peek fragment into its container.
-        val peekFragment = PeekFragment()
-        mPeekFragment = peekFragment
-        val ft: FragmentTransaction = fm.beginTransaction()
-        ft.replace(getOverlayId(), peekFragment)
-        ft.commitAllowingStateLoss()
     }
 
-    open fun peekDocument(doc: DocumentInfo) {
-        if (mPeekFragment == null) {
-            Log.e(TAG, "Peek fragment not initialized")
-            return
+    /**
+     * Sets the Peek fragment. By either querying it if it has been restored by the fragment
+     * manager, or by initializing it.
+     */
+    private fun maybeInitializeFragment() {
+        // The fragment manager automatically handles state restoration: the fragment might already
+        // exist.
+        val existingFragment = fm.findFragmentById(getRes(R.id.peek_overlay))
+        if (existingFragment == null) {
+            peekFragment = PeekFragment()
+            val ft: FragmentTransaction = fm.beginTransaction()
+            ft.add(getRes(R.id.peek_overlay), peekFragment)
+            ft.commitAllowingStateLoss()
+        } else {
+            peekFragment = existingFragment as PeekFragment
         }
-        show()
+
+        // Restore visibility.
+        setContainerVisibility(viewModel.overlayActive.value == true)
     }
 
-    @IdRes
-    private fun getOverlayId(): Int {
-        return R.id.peek_overlay
+    /** This method is called every time viewModel.overlayActive changes its value. */
+    override fun onChanged(value: Boolean?) {
+        setContainerVisibility(value ?: false)
     }
 
-    private fun getOverlayContainer(): FrameLayout? {
-        return mActivity.findViewById(getOverlayId())
+    private fun setContainerVisibility(visible: Boolean) {
+        container.visibility = if (visible) View.VISIBLE else View.GONE
     }
 
-    private fun show() {
-        getOverlayContainer()?.visibility = View.VISIBLE
+    open fun peekDocument(doc: DocumentInfo) {
+        maybeInitializeFragment()
+        if (!::peekFragment.isInitialized) {
+            Log.e(TAG, "PeekFragment has not been initialized")
+            return
+        }
+        viewModel.setDocInfoAndActivateOverlay(doc)
     }
-}
\ No newline at end of file
+}
diff --git a/src/com/android/documentsui/peek/PeekViewModel.kt b/src/com/android/documentsui/peek/PeekViewModel.kt
new file mode 100644
index 000000000..c74055f60
--- /dev/null
+++ b/src/com/android/documentsui/peek/PeekViewModel.kt
@@ -0,0 +1,48 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.peek
+
+import androidx.lifecycle.LiveData
+import androidx.lifecycle.MutableLiveData
+import androidx.lifecycle.ViewModel
+import com.android.documentsui.base.DocumentInfo
+
+/** Manages the UI state for Peek. */
+class PeekViewModel : ViewModel() {
+    // Whether the Peek overlay is active or not.
+    private val _overlayActive: MutableLiveData<Boolean> = MutableLiveData(false)
+    val overlayActive: LiveData<Boolean> = _overlayActive
+
+    // Peek fragment's state.
+    private val _docInfo: MutableLiveData<DocumentInfo> = MutableLiveData(null)
+    val docInfo: LiveData<DocumentInfo> = _docInfo
+
+    fun clear() {
+        _overlayActive.value = false
+        _docInfo.value = null
+    }
+
+    /**
+     * A DocumentInfo is set when a new file has been selected for preview. Doing so is always
+     * associated with the overlay being active.
+     */
+    fun setDocInfoAndActivateOverlay(docInfo: DocumentInfo) {
+        // OverlayActive has to be set first, since its value is relevant for the listener of
+        // docInfo.
+        _overlayActive.value = true
+        _docInfo.value = docInfo
+    }
+}
diff --git a/src/com/android/documentsui/peek/PreviewHandler.kt b/src/com/android/documentsui/peek/PreviewHandler.kt
new file mode 100644
index 000000000..53eb87de6
--- /dev/null
+++ b/src/com/android/documentsui/peek/PreviewHandler.kt
@@ -0,0 +1,119 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.peek
+
+import android.graphics.drawable.Drawable
+import android.util.Log
+import android.view.LayoutInflater
+import android.widget.FrameLayout
+import android.widget.FrameLayout.LayoutParams
+import android.widget.ImageView
+import com.android.documentsui.R
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.util.Material3Config.Companion.getRes
+import com.bumptech.glide.Glide
+import com.bumptech.glide.load.DataSource
+import com.bumptech.glide.load.engine.DiskCacheStrategy
+import com.bumptech.glide.load.engine.GlideException
+import com.bumptech.glide.request.RequestListener
+import com.bumptech.glide.request.target.Target
+
+/** Abstract class for file rendering in the provided frame. */
+abstract class PreviewHandler(protected val previewFrame: FrameLayout) {
+    open fun clear() {
+        previewFrame.removeAllViews()
+    }
+
+    @Suppress("ktlint:standard:comment-wrapping")
+    protected fun handleUnsupportedFileType() {
+        LayoutInflater.from(previewFrame.context)
+            .inflate(getRes(R.layout.peek_no_preview), /* root= */ previewFrame)
+    }
+}
+
+/** Preview handler for unsupported file types. */
+class DefaultPreviewHandler(previewFrame: FrameLayout) : PreviewHandler(previewFrame) {
+    init {
+        handleUnsupportedFileType()
+    }
+}
+
+/** Preview handler for unsupported images. */
+class ImagePreviewHandler(previewFrame: FrameLayout, doc: DocumentInfo) :
+    PreviewHandler(previewFrame) {
+    companion object {
+        private const val TAG = "ImagePreviewHandler"
+    }
+
+    // Keep a reference to the displayed ImageView, for cleanup purpose.
+    private var imageView: ImageView? = null
+
+    private val glideRequestListener = object : RequestListener<Drawable> {
+        override fun onLoadFailed(
+            e: GlideException?,
+            model: Any?,
+            target: Target<Drawable>,
+            isFirstResource: Boolean,
+        ): Boolean {
+            Log.e(TAG, "Glide image load request failed: ", e)
+            // Remove the ImageView from the view hierarchy.
+            imageView = null
+            previewFrame.removeAllViews()
+            // Display default "No preview available" screen.
+            handleUnsupportedFileType()
+            // Return false to indicate the target hasn't been modified by the listener.
+            return false
+        }
+
+        override fun onResourceReady(
+            resource: Drawable,
+            model: Any,
+            target: Target<Drawable>,
+            datasource: DataSource,
+            isFirstResource: Boolean,
+        ): Boolean {
+            // Return false to indicate the target hasn't been modified by the listener.
+            return false
+        }
+    }
+
+    init {
+        imageView =
+            ImageView(previewFrame.context).apply {
+                layoutParams = LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT)
+                scaleType = ImageView.ScaleType.FIT_CENTER
+                contentDescription =
+                    context.getString(R.string.a11y_peek_image_preview, doc.displayName)
+            }
+        previewFrame.addView(imageView)
+
+        Glide.with(previewFrame)
+            .load(doc.derivedUri)
+            .fitCenter()
+            .diskCacheStrategy(DiskCacheStrategy.NONE)
+            .listener(glideRequestListener)
+            .into(imageView!!)
+    }
+
+    override fun clear() {
+        // Cancel any Glide load request if one is in progress.
+        imageView?.let {
+            Glide.with(previewFrame).clear(it)
+            imageView = null
+        }
+        super.clear()
+    }
+}
diff --git a/src/com/android/documentsui/picker/ActionHandler.java b/src/com/android/documentsui/picker/ActionHandler.java
index 553fa6986..9eb416a22 100644
--- a/src/com/android/documentsui/picker/ActionHandler.java
+++ b/src/com/android/documentsui/picker/ActionHandler.java
@@ -24,6 +24,7 @@ import static com.android.documentsui.base.State.ACTION_GET_CONTENT;
 import static com.android.documentsui.base.State.ACTION_OPEN;
 import static com.android.documentsui.base.State.ACTION_OPEN_TREE;
 import static com.android.documentsui.base.State.ACTION_PICK_COPY_DESTINATION;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import static java.util.regex.Pattern.CASE_INSENSITIVE;
 
@@ -71,6 +72,7 @@ import com.android.documentsui.util.FileUtils;
 
 import java.io.IOException;
 import java.util.Arrays;
+import java.util.List;
 import java.util.concurrent.Executor;
 import java.util.regex.Pattern;
 
@@ -270,7 +272,7 @@ class ActionHandler<T extends FragmentActivity & Addons> extends AbstractActionH
     }
 
     private void onLastAccessedStackLoaded(@Nullable DocumentStack stack) {
-        if (stack == null) {
+        if (stack == null || stack.peek() == null) {
             loadDefaultLocation();
         } else if (shouldPreemptivelyRestrictRequestedInitialUri(stack.peek().getDocumentUri())) {
             // If the last accessed stack has restricted uri, load default location
@@ -427,6 +429,9 @@ class ActionHandler<T extends FragmentActivity & Addons> extends AbstractActionH
         return !doc.isContainer();
     }
 
+    /**
+     * Picks a folder for the ACTION_OPEN_TREE or ACTION_PICK_COPY_DESTINATION picker.
+     */
     void pickDocument(FragmentManager fm, DocumentInfo pickTarget) {
         assert (pickTarget != null);
         mInjector.pickResult.increaseActionCount();
@@ -445,6 +450,28 @@ class ActionHandler<T extends FragmentActivity & Addons> extends AbstractActionH
         }
     }
 
+    /**
+     * Picks selected documents for the ACTION_OPEN or ACTION_GET_CONTENT picker.
+     */
+    void pickSelected() {
+        if (!isUseMaterial3FlagEnabled()) {
+            return;
+        }
+        assert (mState.action == ACTION_OPEN || mState.action == ACTION_GET_CONTENT);
+        List<DocumentInfo> selection = mInjector.getModel().getDocuments(
+                mInjector.selectionMgr.getSelection());
+        if (selection.isEmpty()) {
+            Log.w(TAG, "There are no selected files");
+            return;
+        }
+
+        if (selection.size() > 1) {
+            mActivity.onDocumentsPicked(selection);
+        } else {
+            mActivity.onDocumentPicked(selection.getFirst());
+        }
+    }
+
     void saveDocument(
             String mimeType, String displayName, BooleanConsumer inProgressStateListener) {
         assert (mState.action == ACTION_CREATE);
@@ -477,6 +504,20 @@ class ActionHandler<T extends FragmentActivity & Addons> extends AbstractActionH
         }
     }
 
+    /** Cancels the picking by first setting the last accessed location first. */
+    void cancelPicking() {
+        new SetLastAccessedStackTask(mActivity, mLastAccessed, mState.stack, this::onPickCanceled)
+                .executeOnExecutor(getExecutorForCurrentDirectory());
+    }
+
+    /** Sets the activity result to canceled and finishes the current activity. */
+    private void onPickCanceled() {
+        if (DEBUG) Log.d(TAG, "onPickCanceled()");
+
+        mActivity.setResult(FragmentActivity.RESULT_CANCELED, /* intent= */ null, 0);
+        mActivity.finish();
+    }
+
     void finishPicking(Uri... docs) {
         new SetLastAccessedStackTask(
                 mActivity,
diff --git a/src/com/android/documentsui/picker/ConfirmFragment.java b/src/com/android/documentsui/picker/ConfirmFragment.java
index e1af281bc..45b317b51 100644
--- a/src/com/android/documentsui/picker/ConfirmFragment.java
+++ b/src/com/android/documentsui/picker/ConfirmFragment.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.picker;
 
 import static com.android.documentsui.base.Shared.getCallingAppName;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Dialog;
 import android.content.DialogInterface;
@@ -69,9 +70,10 @@ public class ConfirmFragment extends DialogFragment {
         final MaterialAlertDialogBuilder builder = new MaterialAlertDialogBuilder(getActivity());
         switch (mType) {
             case TYPE_OVERWRITE:
-                String message = String.format(
-                        getString(R.string.overwrite_file_confirmation_message),
-                        mTarget.displayName);
+                String message =
+                        String.format(
+                                getString(getRes(R.string.overwrite_file_confirmation_message)),
+                                mTarget.displayName);
                 builder.setMessage(message);
                 builder.setPositiveButton(
                         android.R.string.ok,
@@ -84,15 +86,21 @@ public class ConfirmFragment extends DialogFragment {
                 final Uri treeUri = mTarget.getTreeDocumentUri();
                 final BaseActivity activity = (BaseActivity) getActivity();
                 final String target = activity.getCurrentTitle();
-                final String text = getString(R.string.open_tree_dialog_title,
-                        getCallingAppName(getActivity()), target);
-                message = getString(R.string.open_tree_dialog_message,
-                        getCallingAppName(getActivity()), target);
+                final String text =
+                        getString(
+                                getRes(R.string.open_tree_dialog_title),
+                                getCallingAppName(getActivity()),
+                                target);
+                message =
+                        getString(
+                                getRes(R.string.open_tree_dialog_message),
+                                getCallingAppName(getActivity()),
+                                target);
 
                 builder.setTitle(text);
                 builder.setMessage(message);
                 builder.setPositiveButton(
-                        R.string.allow,
+                        getRes(R.string.allow),
                         (DialogInterface dialog, int id) -> {
                             pickResult.increaseActionCount();
                             mActions.finishPicking(treeUri);
diff --git a/src/com/android/documentsui/picker/CreatePickedDocumentTask.java b/src/com/android/documentsui/picker/CreatePickedDocumentTask.java
index ebd3325b3..adef0325e 100644
--- a/src/com/android/documentsui/picker/CreatePickedDocumentTask.java
+++ b/src/com/android/documentsui/picker/CreatePickedDocumentTask.java
@@ -16,17 +16,12 @@
 
 package com.android.documentsui.picker;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.app.Activity;
-import android.content.ContentProviderClient;
-import android.content.ContentResolver;
 import android.net.Uri;
-import android.provider.DocumentsContract;
-import android.util.Log;
-
-import com.google.android.material.snackbar.Snackbar;
 
 import com.android.documentsui.DocumentsAccess;
-import com.android.documentsui.DocumentsApplication;
 import com.android.documentsui.R;
 import com.android.documentsui.base.BooleanConsumer;
 import com.android.documentsui.base.DocumentInfo;
@@ -34,6 +29,8 @@ import com.android.documentsui.base.DocumentStack;
 import com.android.documentsui.base.PairedTask;
 import com.android.documentsui.ui.Snackbars;
 
+import com.google.android.material.snackbar.Snackbar;
+
 import java.util.function.Consumer;
 
 /**
@@ -90,8 +87,8 @@ class CreatePickedDocumentTask extends PairedTask<Activity, Void, Uri> {
         if (result != null) {
             mCallback.accept(result);
         } else {
-            Snackbars.makeSnackbar(
-                    mOwner, R.string.save_error, Snackbar.LENGTH_LONG).show();
+            Snackbars.makeSnackbar(mOwner, getRes(R.string.save_error), Snackbar.LENGTH_LONG)
+                    .show();
         }
 
         mInProgressStateListener.accept(false);
diff --git a/src/com/android/documentsui/picker/MenuManager.java b/src/com/android/documentsui/picker/MenuManager.java
index dced23dbd..22d3b96f0 100644
--- a/src/com/android/documentsui/picker/MenuManager.java
+++ b/src/com/android/documentsui/picker/MenuManager.java
@@ -22,6 +22,8 @@ import static com.android.documentsui.base.State.ACTION_GET_CONTENT;
 import static com.android.documentsui.base.State.ACTION_OPEN;
 import static com.android.documentsui.base.State.ACTION_OPEN_TREE;
 import static com.android.documentsui.base.State.ACTION_PICK_COPY_DESTINATION;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.database.Cursor;
 import android.provider.DocumentsContract.Document;
@@ -73,8 +75,11 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
             mSearchManager.showMenu(null);
 
             // Show on toolbar because there are only two menu items while ACTION_OPEN_TREE.
-            menu.findItem(R.id.option_menu_sort).setShowAsAction(mState.action == ACTION_OPEN_TREE
-                    ? MenuItem.SHOW_AS_ACTION_ALWAYS : MenuItem.SHOW_AS_ACTION_NEVER);
+            menu.findItem(getRes(R.id.option_menu_sort))
+                    .setShowAsAction(
+                            mState.action == ACTION_OPEN_TREE
+                                    ? MenuItem.SHOW_AS_ACTION_ALWAYS
+                                    : MenuItem.SHOW_AS_ACTION_NEVER);
         }
     }
 
@@ -133,9 +138,10 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
 
     @Override
     protected void updateSelect(MenuItem select, SelectionDetails selectionDetails) {
-        Menus.setEnabledAndVisible(select, (mState.action == ACTION_GET_CONTENT
+        Menus.setEnabledAndVisible(select,
+                !isUseMaterial3FlagEnabled() && (mState.action == ACTION_GET_CONTENT
                 || mState.action == ACTION_OPEN)
                 && selectionDetails.size() > 0);
-        select.setTitle(R.string.menu_select);
+        select.setTitle(getRes(R.string.menu_select));
     }
 }
diff --git a/src/com/android/documentsui/picker/PickActivity.java b/src/com/android/documentsui/picker/PickActivity.java
index 4f875072e..c2fb1ea3a 100644
--- a/src/com/android/documentsui/picker/PickActivity.java
+++ b/src/com/android/documentsui/picker/PickActivity.java
@@ -22,6 +22,7 @@ import static com.android.documentsui.base.State.ACTION_OPEN;
 import static com.android.documentsui.base.State.ACTION_OPEN_TREE;
 import static com.android.documentsui.base.State.ACTION_PICK_COPY_DESTINATION;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Intent;
 import android.content.res.Resources;
@@ -51,6 +52,7 @@ import com.android.documentsui.Metrics;
 import com.android.documentsui.ProfileTabsController;
 import com.android.documentsui.ProviderExecutor;
 import com.android.documentsui.R;
+import com.android.documentsui.SelectionBarController;
 import com.android.documentsui.SharedInputHandler;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.Features;
@@ -83,7 +85,7 @@ public class PickActivity extends BaseActivity implements ActionHandler.Addons {
     private SharedInputHandler mSharedInputHandler;
 
     public PickActivity() {
-        super(R.layout.documents_activity, TAG);
+        super(getRes(R.layout.documents_activity), TAG);
     }
 
     // make these methods visible in this package to work around compiler bug http://b/62218600
@@ -99,7 +101,7 @@ public class PickActivity extends BaseActivity implements ActionHandler.Addons {
 
     @Override
     public void onCreate(Bundle icicle) {
-        setTheme(R.style.DocumentsTheme);
+        setTheme(getRes(R.style.DocumentsTheme));
         Features features = Features.create(this);
 
         mInjector = new Injector<>(
@@ -115,12 +117,13 @@ public class PickActivity extends BaseActivity implements ActionHandler.Addons {
 
         mInjector.selectionMgr = DocsSelectionHelper.create();
 
-        mInjector.focusManager = new FocusManager(
-                mInjector.features,
-                mInjector.selectionMgr,
-                mDrawer,
-                this::focusSidebar,
-                getColor(R.color.primary));
+        mInjector.focusManager =
+                new FocusManager(
+                        mInjector.features,
+                        mInjector.selectionMgr,
+                        mDrawer,
+                        this::focusSidebar,
+                        getColor(getRes(R.color.primary)));
 
         mInjector.menuManager = new MenuManager(
                 mSearchManager,
@@ -128,7 +131,13 @@ public class PickActivity extends BaseActivity implements ActionHandler.Addons {
                 new DirectoryDetails(this),
                 mInjector.getModel()::getItemCount);
 
-        if (!isUseMaterial3FlagEnabled()) {
+        if (isUseMaterial3FlagEnabled()) {
+            mInjector.selectionBarController =
+                    new SelectionBarController(
+                            findViewById(getRes(R.id.selection_bar)),
+                            mInjector.menuManager,
+                            mInjector.selectionMgr);
+        } else {
             mInjector.actionModeController =
                     new ActionModeController(
                             this,
@@ -175,11 +184,22 @@ public class PickActivity extends BaseActivity implements ActionHandler.Addons {
     }
 
     private AppsRowManager getAppsRowManager() {
+        boolean shouldShowByDefault =
+                !isUseMaterial3FlagEnabled()
+                        || getResources().getBoolean(R.bool.show_apps_row);
         return mConfigStore.isPrivateSpaceInDocsUIEnabled()
-                ? new AppsRowManager(mInjector.actions, mState.supportsCrossProfile(),
-                mUserManagerState, mConfigStore)
-                : new AppsRowManager(mInjector.actions, mState.supportsCrossProfile(),
-                        mUserIdManager, mConfigStore);
+                ? new AppsRowManager(
+                mInjector.actions,
+                mState.supportsCrossProfile(),
+                mUserManagerState,
+                mConfigStore,
+                shouldShowByDefault)
+                : new AppsRowManager(
+                        mInjector.actions,
+                        mState.supportsCrossProfile(),
+                        mUserIdManager,
+                        mConfigStore,
+                        shouldShowByDefault);
     }
 
     @Override
@@ -223,13 +243,16 @@ public class PickActivity extends BaseActivity implements ActionHandler.Addons {
             SaveFragment.show(getSupportFragmentManager(), mimeType, title);
         } else if (mState.action == ACTION_OPEN_TREE ||
                 mState.action == ACTION_PICK_COPY_DESTINATION) {
-            PickFragment.show(getSupportFragmentManager());
+            PickDirectoryFragment.show(getSupportFragmentManager());
+        } else if (isUseMaterial3FlagEnabled() && (mState.action == ACTION_OPEN
+                || mState.action == ACTION_GET_CONTENT)) {
+            PickFilesFragment.show(getSupportFragmentManager(), mState.action);
         } else if (!isUseMaterial3FlagEnabled()) {
-            // If PickFragment or SaveFragment does not show,
+            // If PickDirectoryFragment, PickFilesFragment or SaveFragment does not show,
             // Set save container background to transparent for edge to edge nav bar.
             // However when the use_material3 flag is on, the file path bar is at the bottom of the
             // layout and hence the edge to edge nav bar is no longer required.
-            View saveContainer = findViewById(R.id.container_save);
+            View saveContainer = findViewById(getRes(R.id.container_save));
             saveContainer.setBackgroundColor(Color.TRANSPARENT);
         }
 
@@ -256,7 +279,7 @@ public class PickActivity extends BaseActivity implements ActionHandler.Addons {
                     /* includeApps= */ mState.action == ACTION_GET_CONTENT,
                     /* intent= */ moreApps);
             if (isUseMaterial3FlagEnabled()) {
-                View navRailRoots = findViewById(R.id.nav_rail_container_roots);
+                View navRailRoots = findViewById(getRes(R.id.nav_rail_container_roots));
                 if (navRailRoots != null) {
                     // Medium layout, populate navigation rail layout.
                     RootsFragment.showNavRail(getSupportFragmentManager(),
@@ -401,7 +424,7 @@ public class PickActivity extends BaseActivity implements ActionHandler.Addons {
 
         if (mState.action == ACTION_OPEN_TREE ||
                 mState.action == ACTION_PICK_COPY_DESTINATION) {
-            final PickFragment pick = PickFragment.get(fm);
+            final PickDirectoryFragment pick = PickDirectoryFragment.get(fm);
             if (pick != null) {
                 pick.setPickTarget(mState.action,
                         mState.copyOperationSubType, mState.restrictScopeStorage, cwd);
diff --git a/src/com/android/documentsui/picker/PickFragment.java b/src/com/android/documentsui/picker/PickDirectoryFragment.java
similarity index 88%
rename from src/com/android/documentsui/picker/PickFragment.java
rename to src/com/android/documentsui/picker/PickDirectoryFragment.java
index 0d20083a8..4a79bf5af 100644
--- a/src/com/android/documentsui/picker/PickFragment.java
+++ b/src/com/android/documentsui/picker/PickDirectoryFragment.java
@@ -23,6 +23,7 @@ import static com.android.documentsui.services.FileOperationService.OPERATION_EX
 import static com.android.documentsui.services.FileOperationService.OPERATION_MOVE;
 import static com.android.documentsui.services.FileOperationService.OPERATION_UNKNOWN;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.pm.PackageManager;
 import android.os.Bundle;
@@ -47,10 +48,10 @@ import com.android.documentsui.ui.Snackbars;
 import com.google.android.material.snackbar.Snackbar;
 
 /**
- * Display pick confirmation bar, usually for selecting a directory.
+ * Display pick confirmation bar for selecting a directory.
  */
-public class PickFragment extends Fragment {
-    public static final String TAG = "PickFragment";
+public class PickDirectoryFragment extends Fragment {
+    public static final String TAG = "PickDirectoryFragment";
 
     private static final String ACTION_KEY = "action";
     private static final String COPY_OPERATION_SUBTYPE_KEY = "copyOperationSubType";
@@ -73,7 +74,7 @@ public class PickFragment extends Fragment {
         @Override
         public void onClick(View v) {
             mInjector.pickResult.increaseActionCount();
-            final BaseActivity activity = BaseActivity.get(PickFragment.this);
+            final BaseActivity activity = BaseActivity.get(PickDirectoryFragment.this);
             activity.setResult(FragmentActivity.RESULT_CANCELED);
             activity.finish();
         }
@@ -97,23 +98,23 @@ public class PickFragment extends Fragment {
             return;
         }
 
-        final PickFragment fragment = new PickFragment();
+        final PickDirectoryFragment fragment = new PickDirectoryFragment();
         final FragmentTransaction ft = fm.beginTransaction();
-        ft.replace(R.id.container_save, fragment, TAG);
+        ft.replace(getRes(R.id.container_save), fragment, TAG);
         ft.commitNowAllowingStateLoss();
     }
 
-    public static PickFragment get(FragmentManager fm) {
-        return (PickFragment) fm.findFragmentByTag(TAG);
+    public static PickDirectoryFragment get(FragmentManager fm) {
+        return (PickDirectoryFragment) fm.findFragmentByTag(TAG);
     }
 
     @Override
     public View onCreateView(
             LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
-        mContainer = inflater.inflate(R.layout.fragment_pick, container, false);
+        mContainer = inflater.inflate(getRes(R.layout.fragment_pick_directory), container, false);
 
         mPick = (Button) mContainer.findViewById(android.R.id.button1);
-        mPickOverlay = mContainer.findViewById((R.id.pick_button_overlay));
+        mPickOverlay = mContainer.findViewById((getRes(R.id.pick_button_overlay)));
         mPickOverlay.setOnClickListener(mPickListener);
         mPick.setOnClickListener(mPickListener);
 
@@ -180,7 +181,7 @@ public class PickFragment extends Fragment {
 
         switch (mAction) {
             case State.ACTION_OPEN_TREE:
-                mPick.setText(getString(R.string.open_tree_button));
+                mPick.setText(getString(getRes(R.string.open_tree_button)));
                 // When use_material3 flag is enabled, all form factors should have the pick button
                 // wrap the text content instead of taking up the full width.
                 if (!isUseMaterial3FlagEnabled()) {
@@ -208,16 +209,16 @@ public class PickFragment extends Fragment {
                 int titleId;
                 switch (mCopyOperationSubType) {
                     case OPERATION_COPY:
-                        titleId = R.string.button_copy;
+                        titleId = getRes(R.string.button_copy);
                         break;
                     case OPERATION_COMPRESS:
-                        titleId = R.string.button_compress;
+                        titleId = getRes(R.string.button_compress);
                         break;
                     case OPERATION_EXTRACT:
-                        titleId = R.string.button_extract;
+                        titleId = getRes(R.string.button_extract);
                         break;
                     case OPERATION_MOVE:
-                        titleId = R.string.button_move;
+                        titleId = getRes(R.string.button_move);
                         break;
                     default:
                         throw new UnsupportedOperationException();
diff --git a/src/com/android/documentsui/picker/PickFilesFragment.kt b/src/com/android/documentsui/picker/PickFilesFragment.kt
new file mode 100644
index 000000000..fdc8b1636
--- /dev/null
+++ b/src/com/android/documentsui/picker/PickFilesFragment.kt
@@ -0,0 +1,130 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.picker
+
+import android.os.Bundle
+import android.view.LayoutInflater
+import android.view.View
+import android.view.ViewGroup
+import androidx.fragment.app.Fragment
+import androidx.fragment.app.FragmentManager
+import androidx.recyclerview.selection.SelectionTracker
+import com.android.documentsui.DocsSelectionHelper
+import com.android.documentsui.R
+import com.android.documentsui.base.State.ACTION_GET_CONTENT
+import com.android.documentsui.base.State.ACTION_OPEN
+import com.android.documentsui.base.State.ActionType
+import com.android.documentsui.util.FlagUtils.Companion.isUseMaterial3FlagEnabled
+import com.android.documentsui.util.Material3Config.Companion.getRes
+import com.google.android.material.button.MaterialButton
+
+/**
+ * Display pick confirmation bar for selecting one or more files. This is only used when the
+ * useMaterial3 is enabled.
+ */
+class PickFilesFragment : Fragment() {
+    private val resetObserver = object : DocsSelectionHelper.ResetObserver() {
+        override fun onReset() {
+            // Only add the selectionObserver once the selectionMgr is initialised (reset).
+            selectionMgr!!.addObserver(selectionObserver)
+        }
+    }
+    private val selectionObserver = object : SelectionTracker.SelectionObserver<String>() {
+        override fun onSelectionChanged() {
+            togglePickButton()
+        }
+    }
+    private var selectionMgr: DocsSelectionHelper? = null
+    private val pickListener: View.OnClickListener = View.OnClickListener {
+        actionHandler!!.pickSelected()
+    }
+
+    private val cancelListener: View.OnClickListener = View.OnClickListener {
+        actionHandler!!.cancelPicking()
+    }
+
+    private var actionHandler: ActionHandler<PickActivity?>? = null
+    private var pick: MaterialButton? = null
+    private var cancel: MaterialButton? = null
+
+    override fun onCreateView(
+        inflater: LayoutInflater,
+        container: ViewGroup?,
+        savedInstanceState: Bundle?
+    ): View? {
+        val containerView =
+            inflater.inflate(getRes(R.layout.fragment_pick_files_m3), container, false)
+
+        actionHandler = (getActivity() as PickActivity).getInjector()!!.actions
+
+        pick = containerView!!.findViewById(getRes(R.id.button_pick))
+        pick!!.setOnClickListener(pickListener)
+
+        cancel = containerView!!.findViewById(getRes(R.id.button_cancel))
+        cancel!!.setOnClickListener(cancelListener)
+
+        selectionMgr = (getActivity() as PickActivity).getInjector().selectionMgr
+        selectionMgr?.addResetObserver(resetObserver)
+
+        togglePickButton()
+        return containerView
+    }
+
+    override fun onDestroyView() {
+        super.onDestroyView()
+        selectionMgr?.removeResetObserver(resetObserver)
+    }
+
+    /**
+     * Enables/disables the pick button based on the state of selection.
+     */
+    private fun togglePickButton() {
+        if (!isUseMaterial3FlagEnabled()) {
+            return
+        }
+        // The pick button is only available when the user has selected files.
+        pick!!.setEnabled(selectionMgr?.hasSelection() ?: false)
+    }
+
+    companion object {
+        private const val TAG: String = "PickFilesFragment"
+
+        @JvmStatic
+        fun show(
+            fm: FragmentManager,
+            @ActionType action: Int
+        ) {
+            if (action != ACTION_GET_CONTENT && action != ACTION_OPEN) {
+                return
+            }
+
+            // Fragment will be restored by FragmentManager automatically.
+            if (get(fm) != null) {
+                return
+            }
+
+            val fragment = PickFilesFragment()
+            val ft = fm.beginTransaction()
+            ft.replace(R.id.container_save, fragment, TAG)
+            ft.commitNowAllowingStateLoss()
+        }
+
+        @JvmStatic
+        fun get(fm: FragmentManager): PickFilesFragment? {
+            return fm.findFragmentByTag(TAG) as PickFilesFragment?
+        }
+    }
+}
diff --git a/src/com/android/documentsui/picker/SaveFragment.java b/src/com/android/documentsui/picker/SaveFragment.java
index 8316688e7..3fd9e5be2 100644
--- a/src/com/android/documentsui/picker/SaveFragment.java
+++ b/src/com/android/documentsui/picker/SaveFragment.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.picker;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Context;
 import android.content.pm.PackageManager;
@@ -77,7 +78,7 @@ public class SaveFragment extends Fragment {
         fragment.setArguments(args);
 
         final FragmentTransaction ft = fm.beginTransaction();
-        ft.replace(R.id.container_save, fragment, TAG);
+        ft.replace(getRes(R.id.container_save), fragment, TAG);
         ft.commitAllowingStateLoss();
     }
 
@@ -90,13 +91,13 @@ public class SaveFragment extends Fragment {
             LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         final Context context = inflater.getContext();
 
-        final View view = inflater.inflate(R.layout.fragment_save, container, false);
+        final View view = inflater.inflate(getRes(R.layout.fragment_save), container, false);
 
         final Drawable icon =
                 IconUtils.loadMimeIcon(context, getArguments().getString(EXTRA_MIME_TYPE));
         if (isUseMaterial3FlagEnabled()) {
             final TextInputLayout titleWrapper =
-                    (TextInputLayout) view.findViewById(R.id.title_wrapper);
+                    (TextInputLayout) view.findViewById(getRes(R.id.title_wrapper));
             titleWrapper.setStartIconDrawable(icon);
         } else {
             final ImageView iconHolder = view.findViewById(android.R.id.icon);
@@ -201,12 +202,13 @@ public class SaveFragment extends Fragment {
 
     };
 
-    private View.OnClickListener mCancelListener = new View.OnClickListener() {
-        @Override
-        public void onClick(View v) {
-            mInjector.actions.finishPicking();
-        }
-    };
+    private View.OnClickListener mCancelListener =
+            new View.OnClickListener() {
+                @Override
+                public void onClick(View v) {
+                    mInjector.actions.cancelPicking();
+                }
+            };
 
     private void performSave() {
         if (mReplaceTarget != null) {
diff --git a/src/com/android/documentsui/picker/TrampolineActivity.kt b/src/com/android/documentsui/picker/TrampolineActivity.kt
index dba09f2f3..b01b27fcc 100644
--- a/src/com/android/documentsui/picker/TrampolineActivity.kt
+++ b/src/com/android/documentsui/picker/TrampolineActivity.kt
@@ -15,18 +15,11 @@
  */
 package com.android.documentsui.picker
 
-import android.content.ComponentName
 import android.content.Intent
 import android.content.Intent.ACTION_GET_CONTENT
-import android.content.pm.PackageInfo
-import android.content.pm.PackageManager
-import android.os.Build
 import android.os.Bundle
-import android.os.ext.SdkExtensions
-import android.provider.MediaStore.ACTION_PICK_IMAGES
-import android.util.Log
 import androidx.appcompat.app.AppCompatActivity
-import com.android.documentsui.base.SharedMinimal.DEBUG
+import com.android.documentsui.util.getPhotopickerGetContentComponentNameForType
 
 /**
  * DocumentsUI PickActivity currently defers picking of media mime types to the Photopicker. This
@@ -49,7 +42,8 @@ class TrampolineActivity : AppCompatActivity() {
         }
 
         // In the event there is no photopicker returned, just refer to DocumentsUI.
-        val photopickerComponentName = getPhotopickerComponentName(intent.type)
+        val photopickerComponentName =
+            getPhotopickerGetContentComponentNameForType(packageManager, intent.type)
         if (photopickerComponentName == null) {
             forwardIntentToDocumentsUI()
             return
@@ -74,78 +68,9 @@ class TrampolineActivity : AppCompatActivity() {
         startActivity(intent)
         finish()
     }
-
-    private fun getPhotopickerComponentName(type: String?): ComponentName? {
-        // Intent.ACTION_PICK_IMAGES is only available from SdkExtensions v2 onwards. Prior to that
-        // the Photopicker was not available, so in those cases should always send to DocumentsUI.
-        if (SdkExtensions.getExtensionVersion(Build.VERSION_CODES.R) < 2) {
-            return null
-        }
-
-        // Attempt to resolve the `ACTION_PICK_IMAGES` intent to get the Photopicker package.
-        // On T+ devices this is is a standalone package, whilst prior to T it is part of the
-        // MediaProvider module.
-        val pickImagesIntent = Intent(
-            ACTION_PICK_IMAGES
-        ).apply { addCategory(Intent.CATEGORY_DEFAULT) }
-        val photopickerComponentName: ComponentName? = pickImagesIntent.resolveActivity(
-            packageManager
-        )
-
-        // For certain devices the activity that handles ACTION_GET_CONTENT can be disabled (when
-        // the ACTION_PICK_IMAGES is enabled) so double check by explicitly checking the
-        // ACTION_GET_CONTENT activity on the same activity that handles ACTION_PICK_IMAGES.
-        val photopickerGetContentIntent = Intent(ACTION_GET_CONTENT).apply {
-            setType(type)
-            setPackage(photopickerComponentName?.packageName)
-        }
-        val photopickerGetContentComponent: ComponentName? =
-            photopickerGetContentIntent.resolveActivity(packageManager)
-
-        // Ensure the `ACTION_GET_CONTENT` activity is enabled.
-        if (!isComponentEnabled(photopickerGetContentComponent)) {
-            if (DEBUG) {
-                Log.d(TAG, "Photopicker PICK_IMAGES component has no enabled GET_CONTENT handler")
-            }
-            return null
-        }
-
-        return photopickerGetContentComponent
-    }
-
-    private fun isComponentEnabled(componentName: ComponentName?): Boolean {
-        if (componentName == null) {
-            return false
-        }
-
-        return when (packageManager.getComponentEnabledSetting(componentName)) {
-            PackageManager.COMPONENT_ENABLED_STATE_ENABLED -> true
-            PackageManager.COMPONENT_ENABLED_STATE_DEFAULT -> {
-                // DEFAULT is a state that essentially defers to the state defined in the
-                // AndroidManifest which can be either enabled or disabled.
-                packageManager.getPackageInfo(
-                    componentName.packageName,
-                    PackageManager.GET_ACTIVITIES
-                )?.let { packageInfo: PackageInfo ->
-                    if (packageInfo.activities == null) {
-                        return false
-                    }
-                    for (val info in packageInfo.activities) {
-                        if (info.name == componentName.className) {
-                            return info.enabled
-                        }
-                    }
-                }
-                return false
-            }
-
-            // Everything else is considered disabled.
-            else -> false
-        }
-    }
 }
 
-fun shouldForwardIntentToPhotopicker(intent: Intent): Boolean {
+private fun shouldForwardIntentToPhotopicker(intent: Intent): Boolean {
     // Photopicker can only handle `ACTION_GET_CONTENT` intents.
     if (intent.action != ACTION_GET_CONTENT) {
         return false
@@ -174,7 +99,7 @@ fun shouldForwardIntentToPhotopicker(intent: Intent): Boolean {
     return extraMimeTypes.isNotEmpty() && extraMimeTypes.none { !isMediaMimeType(it) }
 }
 
-fun isMediaMimeType(mimeType: String?): Boolean {
+private fun isMediaMimeType(mimeType: String?): Boolean {
     return mimeType?.let { mimeType ->
         mimeType.startsWith("image/") || mimeType.startsWith("video/")
     } == true
diff --git a/src/com/android/documentsui/prefs/LocalPreferences.java b/src/com/android/documentsui/prefs/LocalPreferences.java
index 5503408c1..17603d1d8 100644
--- a/src/com/android/documentsui/prefs/LocalPreferences.java
+++ b/src/com/android/documentsui/prefs/LocalPreferences.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.prefs;
 
 import static com.android.documentsui.base.State.MODE_UNKNOWN;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.content.Context;
 import android.content.SharedPreferences;
@@ -36,10 +37,14 @@ import java.lang.annotation.RetentionPolicy;
  */
 public class LocalPreferences {
     private static final String ROOT_VIEW_MODE_PREFIX = "rootViewMode-";
+    private static final String VIEW_MODE_STATE = "viewModeState";
     private static final String SHOW_HIDDEN_FILES = "showHiddenFiles";
 
     public static @ViewMode int getViewMode(Context context, RootInfo root,
             @ViewMode int fallback) {
+        if (isUseMaterial3FlagEnabled()) {
+            return getPrefs(context).getInt(VIEW_MODE_STATE, fallback);
+        }
         return getPrefs(context).getInt(createKey(ROOT_VIEW_MODE_PREFIX, root), fallback);
     }
 
@@ -50,7 +55,13 @@ public class LocalPreferences {
 
     public static void setViewMode(Context context, RootInfo root, @ViewMode int viewMode) {
         assert(viewMode != MODE_UNKNOWN);
-        getPrefs(context).edit().putInt(createKey(ROOT_VIEW_MODE_PREFIX, root), viewMode).apply();
+        if (isUseMaterial3FlagEnabled()) {
+            getPrefs(context).edit().putInt(VIEW_MODE_STATE, viewMode).apply();
+        } else {
+            getPrefs(context).edit()
+                    .putInt(createKey(ROOT_VIEW_MODE_PREFIX, root), viewMode)
+                    .apply();
+        }
     }
 
     /** Sets if hidden files should be shown. */
diff --git a/src/com/android/documentsui/queries/FileTypeOption.kt b/src/com/android/documentsui/queries/FileTypeOption.kt
new file mode 100644
index 000000000..6cc6c872b
--- /dev/null
+++ b/src/com/android/documentsui/queries/FileTypeOption.kt
@@ -0,0 +1,37 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.queries
+
+import com.android.documentsui.R
+import com.android.documentsui.util.Material3Config.Companion.getRes
+
+/**
+ * Enumerates possible file types used for restricting file search. These values correspond directly
+ * to the values of the search_file_type_menu.
+ */
+enum class FileTypeOption(val value: Int) {
+    ANY_TYPE(getRes(R.id.file_type_all_option)),
+    AUDIO(getRes(R.id.file_type_audio_option)),
+    DOCUMENTS(getRes(R.id.file_type_documents_option)),
+    IMAGES(getRes(R.id.file_type_images_option)),
+    VIDEO(getRes(R.id.file_type_videos_option)),
+}
+
+/**
+ * For the given integer value, attempts to return the corresponding FileTypeOption enum.
+ */
+fun fileTypeOptionFor(value: Int): FileTypeOption? =
+    enumValues<FileTypeOption>().firstOrNull { it.value == value }
diff --git a/src/com/android/documentsui/queries/LastModifiedOption.kt b/src/com/android/documentsui/queries/LastModifiedOption.kt
new file mode 100644
index 000000000..f229b3bb0
--- /dev/null
+++ b/src/com/android/documentsui/queries/LastModifiedOption.kt
@@ -0,0 +1,39 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.queries
+
+import com.android.documentsui.R
+import com.android.documentsui.util.Material3Config.Companion.getRes
+import kotlin.time.Duration.Companion.days
+
+/**
+ * Enumerates possible options for the last modified filters. These values correspond directly
+ * to the values of hte search_last_modified_menu.
+ */
+enum class LastModifiedOption(val value: Int, val millis: Long) {
+    ANY_TIME(getRes(R.id.last_modified_any_time_option), 0),
+    LAST_DAY(getRes(R.id.last_modified_1_day_option), 1.days.inWholeMilliseconds),
+    LAST_2_DAYS(getRes(R.id.last_modified_2_days_option), 2.days.inWholeMilliseconds),
+    LAST_7_DAYS(getRes(R.id.last_modified_7_days_option), 7.days.inWholeMilliseconds),
+    LAST_30_DAYS(getRes(R.id.last_modified_30_days_option), 30.days.inWholeMilliseconds),
+    LAST_365_DAYS(getRes(R.id.last_modified_365_days_option), 365.days.inWholeMilliseconds),
+}
+
+/**
+ * For the given integer value, attempts to return the corresponding LastModifiedOption enum.
+ */
+fun lastModifiedOptionFor(value: Int): LastModifiedOption? =
+    enumValues<LastModifiedOption>().firstOrNull { it.value == value }
diff --git a/src/com/android/documentsui/queries/SearchChipViewManager.java b/src/com/android/documentsui/queries/SearchChipViewManager.java
index bf3d1e865..7ee2a6c07 100644
--- a/src/com/android/documentsui/queries/SearchChipViewManager.java
+++ b/src/com/android/documentsui/queries/SearchChipViewManager.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.queries;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.animation.ObjectAnimator;
 import android.content.Context;
@@ -79,11 +80,11 @@ public class SearchChipViewManager {
     private static final ChipComparator CHIP_COMPARATOR = new ChipComparator();
 
     // we will get the icon drawable with the first mimeType
-    private static final String[] IMAGES_MIMETYPES = new String[]{"image/*"};
-    private static final String[] VIDEOS_MIMETYPES = new String[]{"video/*"};
-    private static final String[] AUDIO_MIMETYPES =
+    public static final String[] IMAGES_MIMETYPES = new String[]{"image/*"};
+    public static final String[] VIDEOS_MIMETYPES = new String[]{"video/*"};
+    public static final String[] AUDIO_MIMETYPES =
             new String[]{"audio/*", "application/ogg", "application/x-flac"};
-    private static final String[] DOCUMENTS_MIMETYPES = MimeTypes.getDocumentMimeTypeArray();
+    public static final String[] DOCUMENTS_MIMETYPES = MimeTypes.getDocumentMimeTypeArray();
     private static final String[] EMPTY_MIMETYPES = new String[]{""};
 
     private static final Map<Integer, SearchChipData> sMimeTypesChipItems = new HashMap<>();
@@ -99,25 +100,29 @@ public class SearchChipViewManager {
     Set<SearchChipData> mCheckedChipItems = new HashSet<>();
 
     static {
-        sMimeTypesChipItems.put(TYPE_IMAGES,
+        sMimeTypesChipItems.put(
+                TYPE_IMAGES,
                 new SearchChipData(TYPE_IMAGES, R.string.chip_title_images, IMAGES_MIMETYPES));
         if (VersionUtils.isAtLeastR()) {
-            sMimeTypesChipItems.put(TYPE_DOCUMENTS,
-                    new SearchChipData(TYPE_DOCUMENTS, R.string.chip_title_documents,
-                            DOCUMENTS_MIMETYPES));
+            sMimeTypesChipItems.put(
+                    TYPE_DOCUMENTS,
+                    new SearchChipData(
+                            TYPE_DOCUMENTS, R.string.chip_title_documents, DOCUMENTS_MIMETYPES));
         }
-        sMimeTypesChipItems.put(TYPE_AUDIO,
+        sMimeTypesChipItems.put(
+                TYPE_AUDIO,
                 new SearchChipData(TYPE_AUDIO, R.string.chip_title_audio, AUDIO_MIMETYPES));
-        sMimeTypesChipItems.put(TYPE_VIDEOS,
+        sMimeTypesChipItems.put(
+                TYPE_VIDEOS,
                 new SearchChipData(TYPE_VIDEOS, R.string.chip_title_videos, VIDEOS_MIMETYPES));
-        sDefaultChipItems.put(TYPE_LARGE_FILES,
-                new SearchChipData(TYPE_LARGE_FILES,
-                        R.string.chip_title_large_files,
-                        EMPTY_MIMETYPES));
-        sDefaultChipItems.put(TYPE_FROM_THIS_WEEK,
-                new SearchChipData(TYPE_FROM_THIS_WEEK,
-                        R.string.chip_title_from_this_week,
-                        EMPTY_MIMETYPES));
+        sDefaultChipItems.put(
+                TYPE_LARGE_FILES,
+                new SearchChipData(
+                        TYPE_LARGE_FILES, R.string.chip_title_large_files, EMPTY_MIMETYPES));
+        sDefaultChipItems.put(
+                TYPE_FROM_THIS_WEEK,
+                new SearchChipData(
+                        TYPE_FROM_THIS_WEEK, R.string.chip_title_from_this_week, EMPTY_MIMETYPES));
     }
 
     public SearchChipViewManager(@NonNull ViewGroup chipGroup) {
@@ -282,7 +287,7 @@ public class SearchChipViewManager {
     }
 
     private void addChipToGroup(ViewGroup group, SearchChipData data, LayoutInflater inflater) {
-        Chip chip = (Chip) inflater.inflate(R.layout.search_chip_item, mChipGroup, false);
+        Chip chip = (Chip) inflater.inflate(getRes(R.layout.search_chip_item), mChipGroup, false);
         bindChip(chip, data);
         group.addView(chip);
     }
@@ -382,14 +387,17 @@ public class SearchChipViewManager {
     private void onChipFocusChange(View v, boolean hasFocus) {
         Chip chip = (Chip) v;
         if (hasFocus) {
-            final int focusRingWidth = mChipGroup
-                    .getResources()
-                    .getDimensionPixelSize(R.dimen.focus_ring_width);
+            final int focusRingWidth =
+                    mChipGroup
+                            .getResources()
+                            .getDimensionPixelSize(getRes(R.dimen.focus_ring_width));
             chip.setChipStrokeWidth(focusRingWidth);
         } else {
-            final int strokeWidth = mChipGroup
-                    .getResources()
-                    .getDimensionPixelSize(R.dimen.search_chip_inactive_stroke_width);
+            final int strokeWidth =
+                    mChipGroup
+                            .getResources()
+                            .getDimensionPixelSize(
+                                    getRes(R.dimen.search_chip_inactive_stroke_width));
             chip.setChipStrokeWidth(strokeWidth);
         }
     }
@@ -415,20 +423,20 @@ public class SearchChipViewManager {
         final Context context = mChipGroup.getContext();
         int chipType = chipData.getChipType();
         if (chipType == TYPE_LARGE_FILES) {
-            return context.getDrawable(R.drawable.ic_chip_large_files);
+            return context.getDrawable(getRes(R.drawable.ic_chip_large_files));
         }
         if (chipType == TYPE_FROM_THIS_WEEK) {
-            return context.getDrawable(R.drawable.ic_chip_from_this_week);
+            return context.getDrawable(getRes(R.drawable.ic_chip_from_this_week));
         }
 
         // When use_material3 flag is ON, we don't want to use MIME type icons for
         // image/audio/video/document from the system.
         if (isUseMaterial3FlagEnabled()) {
             return switch (chipType) {
-                case TYPE_IMAGES -> context.getDrawable(R.drawable.ic_chip_image);
-                case TYPE_AUDIO -> context.getDrawable(R.drawable.ic_chip_audio);
-                case TYPE_VIDEOS -> context.getDrawable(R.drawable.ic_chip_video);
-                case TYPE_DOCUMENTS -> context.getDrawable(R.drawable.ic_chip_document);
+                case TYPE_IMAGES -> context.getDrawable(getRes(R.drawable.ic_chip_image));
+                case TYPE_AUDIO -> context.getDrawable(getRes(R.drawable.ic_chip_audio));
+                case TYPE_VIDEOS -> context.getDrawable(getRes(R.drawable.ic_chip_video));
+                case TYPE_DOCUMENTS -> context.getDrawable(getRes(R.drawable.ic_chip_document));
                 default -> null;
             };
         }
@@ -475,14 +483,14 @@ public class SearchChipViewManager {
                         ? ((ChipGroup) mChipGroup).getChipSpacingHorizontal()
                         : mChipGroup
                                 .getResources()
-                                .getDimensionPixelSize(R.dimen.search_chip_spacing);
+                                .getDimensionPixelSize(getRes(R.dimen.search_chip_spacing));
         final boolean isRtl = mChipGroup.getLayoutDirection() == View.LAYOUT_DIRECTION_RTL;
         final float chipGroupPaddingStart =
                 isUseMaterial3FlagEnabled()
                         ? mChipGroup.getPaddingStart()
                         : mChipGroup
                                 .getResources()
-                                .getDimensionPixelSize(R.dimen.search_chip_half_spacing);
+                                .getDimensionPixelSize(getRes(R.dimen.search_chip_half_spacing));
         float lastX = isRtl ? mChipGroup.getWidth() - chipGroupPaddingStart : chipGroupPaddingStart;
 
         // remove all chips except current clicked chip to avoid losing
diff --git a/src/com/android/documentsui/queries/SearchFragment.java b/src/com/android/documentsui/queries/SearchFragment.java
index 890d2b262..0cfd9eecd 100644
--- a/src/com/android/documentsui/queries/SearchFragment.java
+++ b/src/com/android/documentsui/queries/SearchFragment.java
@@ -16,6 +16,9 @@
 
 package com.android.documentsui.queries;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.os.Bundle;
 import android.util.Log;
@@ -59,6 +62,10 @@ public class SearchFragment extends Fragment {
             Log.w(TAG, "Skip show because state saved");
             return;
         }
+        // TODO(b/414507592): Enable recent searches after DockedSearchBar is available.
+        if (isUseMaterial3FlagEnabled()) {
+            return;
+        }
 
         final SearchFragment fragment = new SearchFragment();
         final Bundle args = new Bundle();
@@ -88,10 +95,10 @@ public class SearchFragment extends Fragment {
     @Override
     public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container,
             @Nullable Bundle savedInstanceState) {
-        final View view = inflater.inflate(R.layout.fragment_search, container, false);
+        final View view = inflater.inflate(getRes(R.layout.fragment_search), container, false);
 
-        mSearchChipGroup = view.findViewById(R.id.search_chip_group);
-        mListView = view.findViewById(R.id.history_list);
+        mSearchChipGroup = view.findViewById(getRes(R.id.search_chip_group));
+        mListView = view.findViewById(getRes(R.id.history_list));
 
         return view;
     }
@@ -121,16 +128,20 @@ public class SearchFragment extends Fragment {
         mListView.setAdapter(mAdapter);
         mListView.setOnItemClickListener(this::onHistoryItemClicked);
 
-        View toolbar = getActivity().findViewById(R.id.toolbar);
-        View collapsingBarLayout = getActivity().findViewById(R.id.collapsing_toolbar);
+        View toolbar = getActivity().findViewById(getRes(R.id.toolbar));
+        View collapsingBarLayout = getActivity().findViewById(getRes(R.id.collapsing_toolbar));
         if (toolbar != null && collapsingBarLayout != null) {
             // If collapsingBarLayout is used (i.e. not in Tablet mode),
             // need to align top with the bottom of search bar.
             FrameLayout.LayoutParams layoutParams = new FrameLayout.LayoutParams(
                     ViewGroup.LayoutParams.MATCH_PARENT,
                     ViewGroup.LayoutParams.MATCH_PARENT);
-            layoutParams.setMargins(0, getResources().getDimensionPixelSize(
-                    R.dimen.action_bar_margin) + toolbar.getLayoutParams().height, 0, 0);
+            layoutParams.setMargins(
+                    0,
+                    getResources().getDimensionPixelSize(getRes(R.dimen.action_bar_margin))
+                            + toolbar.getLayoutParams().height,
+                    0,
+                    0);
             getView().setLayoutParams(layoutParams);
         }
 
@@ -138,7 +149,7 @@ public class SearchFragment extends Fragment {
     }
 
     private static int getFragmentId() {
-        return R.id.container_search_fragment;
+        return getRes(R.id.container_search_fragment);
     }
 
     private void onChipClicked(View view) {
@@ -169,12 +180,12 @@ public class SearchFragment extends Fragment {
     }
 
     private void updateDirectoryVisibility(int visibility) {
-        View directoryHeader = getActivity().findViewById(R.id.directory_header);
+        View directoryHeader = getActivity().findViewById(getRes(R.id.directory_header));
         if (directoryHeader != null) {
             directoryHeader.setVisibility(visibility);
         }
 
-        View directoryContainer = getActivity().findViewById(R.id.container_directory);
+        View directoryContainer = getActivity().findViewById(getRes(R.id.container_directory));
         if (directoryContainer != null) {
             directoryContainer.setVisibility(visibility);
         }
@@ -183,13 +194,14 @@ public class SearchFragment extends Fragment {
     private class HistoryListAdapter extends ArrayAdapter<String> {
 
         public HistoryListAdapter(Context context, List<String> list) {
-            super(context, R.layout.item_history, list);
+            super(context, getRes(R.layout.item_history), list);
         }
 
         @Override
         public View getView(int position, View convertView, ViewGroup parent) {
             if (convertView == null) {
-                convertView = getLayoutInflater().inflate(R.layout.item_history, parent, false);
+                convertView =
+                        getLayoutInflater().inflate(getRes(R.layout.item_history), parent, false);
             }
             final String history = getItem(position);
             final TextView text = convertView.findViewById(android.R.id.title);
@@ -202,7 +214,7 @@ public class SearchFragment extends Fragment {
                 notifyDataSetChanged();
             });
             button.setContentDescription(
-                    getContext().getString(R.string.delete_search_history, history));
+                    getContext().getString(getRes(R.string.delete_search_history), history));
 
             return convertView;
         }
diff --git a/src/com/android/documentsui/queries/SearchHistoryManager.java b/src/com/android/documentsui/queries/SearchHistoryManager.java
index 6ccad6a29..acc8c21d5 100644
--- a/src/com/android/documentsui/queries/SearchHistoryManager.java
+++ b/src/com/android/documentsui/queries/SearchHistoryManager.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.queries;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.ContentValues;
 import android.content.Context;
@@ -63,8 +64,8 @@ public class SearchHistoryManager {
 
     private SearchHistoryManager(Context context) {
         mHelper = new DatabaseHelper(context);
-        mLimitedHistoryCount = context.getResources().getInteger(
-            R.integer.config_maximum_search_history);
+        mLimitedHistoryCount =
+                context.getResources().getInteger(getRes(R.integer.config_maximum_search_history));
     }
 
     /**
diff --git a/src/com/android/documentsui/queries/SearchLocationOption.kt b/src/com/android/documentsui/queries/SearchLocationOption.kt
new file mode 100644
index 000000000..37e5f7780
--- /dev/null
+++ b/src/com/android/documentsui/queries/SearchLocationOption.kt
@@ -0,0 +1,35 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.queries
+
+import com.android.documentsui.R
+import com.android.documentsui.util.Material3Config.Companion.getRes
+
+/**
+ * Enumerates possible options for the last modified filters. These values correspond directly
+ * to the values of hte search_last_modified_menu.
+ */
+enum class SearchLocationOption(val value: Int) {
+    CURRENT_FOLDER(getRes(R.id.this_folder_option)),
+    ROOT_FOLDER(getRes(R.id.root_folder_option)),
+    EVERYWHERE(getRes(R.id.everywhere_options)),
+}
+
+/**
+ * For the given integer value, attempts to return the corresponding SearchLocationOption enum.
+ */
+fun searchLocationOptionFor(value: Int): SearchLocationOption? =
+    enumValues<SearchLocationOption>().firstOrNull { it.value == value }
diff --git a/src/com/android/documentsui/queries/SearchOptionsController.kt b/src/com/android/documentsui/queries/SearchOptionsController.kt
new file mode 100644
index 000000000..a095d3f42
--- /dev/null
+++ b/src/com/android/documentsui/queries/SearchOptionsController.kt
@@ -0,0 +1,234 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.queries
+
+import android.os.Bundle
+import android.provider.DocumentsContract
+import android.view.MenuItem
+import android.view.View
+import androidx.annotation.IdRes
+import androidx.annotation.MenuRes
+import androidx.appcompat.widget.PopupMenu
+import androidx.core.view.iterator
+import com.android.documentsui.R
+import com.android.documentsui.util.FlagUtils
+import com.android.documentsui.util.Material3Config.Companion.getRes
+import com.google.android.material.chip.Chip
+import java.lang.IllegalArgumentException
+import java.time.LocalDate
+import java.time.ZoneId
+
+/**
+ * The controller for the search option dropdowns. This controller manages the UI interactions
+ * and converts them to a state of the dropdowns. It must be created with the view that contains
+ * the buttons that trigger showing or hiding of the dropdowns.
+ */
+class SearchOptionsController(private val container: View?) {
+    // The value of currently selected options. Initialized to sensible defaults.
+    private var lastModifiedOption: LastModifiedOption = LastModifiedOption.ANY_TIME
+    private var fileTypeOption: FileTypeOption = FileTypeOption.ANY_TYPE
+    private var locationOption: SearchLocationOption = SearchLocationOption.CURRENT_FOLDER
+
+    // A single listener to query option change events.
+    private var optionsListener: SearchOptionsListener? = null
+
+    init {
+        if (FlagUtils.isUseMaterial3FlagEnabled() && container != null) {
+            makeTrigger(
+                getRes(R.id.search_location_trigger),
+                getRes(R.menu.search_location_menu),
+                this::onLocationSelected
+            )
+            makeTrigger(
+                getRes(R.id.search_last_modified_trigger),
+                getRes(R.menu.search_last_modified_menu),
+                this::onLastModifiedSelected
+            )
+            makeTrigger(
+                getRes(R.id.search_file_type_trigger),
+                getRes(R.menu.search_file_type_menu),
+                this::onFileTypeSelected
+            )
+        }
+    }
+
+    private fun getSelectedMenuOption(@MenuRes menuId: Int): Int {
+        return when (menuId) {
+            R.menu.search_location_menu -> locationOption.value
+            R.menu.search_last_modified_menu -> lastModifiedOption.value
+            R.menu.search_file_type_menu -> fileTypeOption.value
+            else -> throw IllegalArgumentException("Unexpected menu ID $menuId")
+        }
+    }
+
+    /**
+     * Helper function that removes repetitive setup for each of the option triggers.
+     */
+    private fun makeTrigger(
+        @IdRes triggerId: Int,
+        @MenuRes menuId: Int,
+        callback: (option: Int) -> Boolean
+    ) {
+        val trigger = container?.findViewById<Chip>(triggerId)
+        trigger?.setOnClickListener {
+            showMenu(trigger, menuId) {
+                if (callback(it)) {
+                    notifyOptionsChangeListener()
+                }
+            }
+        }
+    }
+
+    /**
+     * Updates the location option based on the given resource ID. Returns true, if the option
+     * has been changed. Otherwise, returns false.
+     */
+    fun onLocationSelected(locationId: Int): Boolean {
+        val selectedOption = searchLocationOptionFor(locationId) ?: return false
+        if (selectedOption == locationOption) {
+            return false
+        }
+        locationOption = selectedOption
+        return true
+    }
+
+    /**
+     * Updates the file type option based on the given resource ID. Returns true, if the option
+     * has been changed. Otherwise, returns false.
+     */
+    fun onFileTypeSelected(fileTypeId: Int): Boolean {
+        val selectedOption = fileTypeOptionFor(fileTypeId) ?: return false
+        if (selectedOption == fileTypeOption) {
+            return false
+        }
+        fileTypeOption = selectedOption
+        return true
+    }
+
+    /**
+     * Updates the last modified option based on the given resource ID. Returns true, if the option
+     * has been changed. Otherwise, returns false.
+     */
+    fun onLastModifiedSelected(lastModifiedId: Int): Boolean {
+        val selectedOption = lastModifiedOptionFor(lastModifiedId) ?: return false
+        if (selectedOption == lastModifiedOption) {
+            return false
+        }
+        lastModifiedOption = selectedOption
+        return true
+    }
+
+    /**
+     * Notifies an option listener about options change, if one is registered.
+     */
+    fun notifyOptionsChangeListener() {
+        optionsListener?.onOptionsChanged(
+            SearchOptionsState(
+                fileTypeOption,
+                lastModifiedOption,
+                locationOption
+            )
+        )
+    }
+
+    /**
+     * Sets the option change listener. Currently only one listener is supported. If the listener
+     * is set to null, that is equivalent to removing the listener.
+     */
+    fun setOptionChangeListener(listener: SearchOptionsListener) {
+        optionsListener = listener
+    }
+
+    /**
+     * Creates a bundle, potentially empty, that contains DocumentsContract last modified argument
+     * set based on mLastModifiedOptions.
+     */
+    private fun getLastModifiedQueryArgs(): Bundle {
+        val bundle = Bundle()
+        if (lastModifiedOption != LastModifiedOption.ANY_TIME) {
+            bundle.putLong(
+                DocumentsContract.QUERY_ARG_LAST_MODIFIED_AFTER,
+                LocalDate.now()
+                    .atStartOfDay(ZoneId.systemDefault())
+                    .toInstant()
+                    .toEpochMilli() - lastModifiedOption.millis
+            )
+        }
+        return bundle
+    }
+
+    private fun getFileTypeQueryArgs(): Bundle {
+        val bundle = Bundle()
+        val mimeTypes = when (fileTypeOption) {
+            FileTypeOption.AUDIO -> SearchChipViewManager.AUDIO_MIMETYPES
+            FileTypeOption.DOCUMENTS -> SearchChipViewManager.DOCUMENTS_MIMETYPES
+            FileTypeOption.IMAGES -> SearchChipViewManager.IMAGES_MIMETYPES
+            FileTypeOption.VIDEO -> SearchChipViewManager.VIDEOS_MIMETYPES
+            else -> arrayOf<String>()
+        }
+        if (mimeTypes.isNotEmpty()) {
+            bundle.putStringArray(DocumentsContract.QUERY_ARG_MIME_TYPES, mimeTypes)
+        }
+        return bundle
+    }
+
+    /**
+     * Creates a bundle with query arguments compliant with DocumentsContract.
+     */
+    fun getOptionsQueryArgs(): Bundle {
+        val bundle = Bundle()
+        bundle.putAll(getLastModifiedQueryArgs())
+        bundle.putAll(getFileTypeQueryArgs())
+        return bundle
+    }
+
+    /**
+     * Sets the visibility of the search drop down options bar.
+     */
+    fun setVisible(visible: Boolean) {
+        container?.visibility = if (visible) View.VISIBLE else View.GONE
+    }
+
+    /**
+     * Returns whether or not this controller is visible.
+     */
+    fun isVisible(): Boolean {
+        return container?.visibility == View.VISIBLE
+    }
+
+    fun showMenu(chip: Chip, @MenuRes menuRes: Int, callback: (option: Int) -> Unit) {
+        // We prevent the chip from working as a chip. Instead it acts as a button.
+        chip.isChecked = false
+
+        // Activate the specified popup menu for the chip.
+        PopupMenu(chip.context, chip).apply {
+            menuInflater.inflate(menuRes, menu)
+            setForceShowIcon(true)
+            setOnMenuItemClickListener { menuItem: MenuItem ->
+                chip.text = menuItem.title
+                callback(menuItem.itemId)
+                false
+            }
+            val selectedValue = getSelectedMenuOption(menuRes)
+            for (menuItem in menu) {
+                if (menuItem.itemId != selectedValue) {
+                   menuItem.icon = null
+                }
+            }
+            show()
+        }
+    }
+}
diff --git a/src/com/android/documentsui/queries/SearchOptionsListener.kt b/src/com/android/documentsui/queries/SearchOptionsListener.kt
new file mode 100644
index 000000000..182d8caa0
--- /dev/null
+++ b/src/com/android/documentsui/queries/SearchOptionsListener.kt
@@ -0,0 +1,26 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.queries
+
+/**
+ * A listener that a class must implement to be notified when the query option change.
+ */
+interface SearchOptionsListener {
+    /**
+     * Notifies the listener that the new option values have been established.
+     */
+    fun onOptionsChanged(options: SearchOptionsState)
+}
diff --git a/src/com/android/documentsui/queries/SearchOptionsState.kt b/src/com/android/documentsui/queries/SearchOptionsState.kt
new file mode 100644
index 000000000..b1b45088b
--- /dev/null
+++ b/src/com/android/documentsui/queries/SearchOptionsState.kt
@@ -0,0 +1,25 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.queries
+
+/**
+ * Represents a snapshot of search options.
+ */
+data class SearchOptionsState(
+    val fileType: FileTypeOption,
+    val lastModified: LastModifiedOption,
+    val location: SearchLocationOption
+)
diff --git a/src/com/android/documentsui/queries/SearchViewManager.java b/src/com/android/documentsui/queries/SearchViewManager.java
index ca132a187..cff9c6738 100644
--- a/src/com/android/documentsui/queries/SearchViewManager.java
+++ b/src/com/android/documentsui/queries/SearchViewManager.java
@@ -20,14 +20,18 @@ import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.base.State.ACTION_GET_CONTENT;
 import static com.android.documentsui.base.State.ACTION_OPEN;
 import static com.android.documentsui.base.State.ActionType;
+import static com.android.documentsui.util.FlagUtils.isSearchV2Enabled;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Intent;
 import android.os.Bundle;
 import android.os.Handler;
 import android.os.Looper;
 import android.provider.DocumentsContract;
+import android.text.Editable;
 import android.text.TextUtils;
+import android.text.TextWatcher;
 import android.util.Log;
 import android.view.Menu;
 import android.view.MenuItem;
@@ -36,6 +40,7 @@ import android.view.View;
 import android.view.View.OnClickListener;
 import android.view.View.OnFocusChangeListener;
 import android.view.ViewGroup;
+import android.widget.EditText;
 
 import androidx.annotation.GuardedBy;
 import androidx.annotation.Nullable;
@@ -50,13 +55,20 @@ import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.DocumentStack;
 import com.android.documentsui.base.EventHandler;
+import com.android.documentsui.base.FolderInfo;
+import com.android.documentsui.base.Providers;
 import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.base.Shared;
 import com.android.documentsui.base.State;
 import com.android.modules.utils.build.SdkLevel;
 
+import java.util.ArrayList;
+import java.util.Collection;
+import java.util.Collections;
 import java.util.Timer;
 import java.util.TimerTask;
+import java.util.function.Predicate;
+import java.util.stream.Collectors;
 
 /**
  * Manages searching UI behavior.
@@ -73,6 +85,7 @@ public class SearchViewManager implements
     private final SearchManagerListener mListener;
     private final EventHandler<String> mCommandProcessor;
     private final SearchChipViewManager mChipViewManager;
+    private final SearchOptionsController mSearchOptionsController;
     private final Timer mTimer;
     private final Handler mUiHandler;
 
@@ -88,18 +101,24 @@ public class SearchViewManager implements
     private boolean mFullBar;
     private boolean mIsHistorySearch;
     private boolean mShowSearchBar;
+    private @Nullable SearchLocationOption mLocationOption;
+    private boolean mShowDockedSearch;
 
     private @Nullable Menu mMenu;
     private @Nullable MenuItem mMenuItem;
     private @Nullable SearchView mSearchView;
+    private @Nullable MenuItem mDockedSearch;
+    private @Nullable EditText mDockedSearchEditText;
     private @Nullable FragmentManager mFragmentManager;
 
     public SearchViewManager(
             SearchManagerListener listener,
             EventHandler<String> commandProcessor,
             ViewGroup chipGroup,
+            @Nullable View optionsContainer,
             @Nullable Bundle savedState) {
-        this(listener, commandProcessor, new SearchChipViewManager(chipGroup), savedState,
+        this(listener, commandProcessor, new SearchChipViewManager(chipGroup),
+                new SearchOptionsController(optionsContainer), savedState,
                 new Timer(), new Handler(Looper.getMainLooper()));
     }
 
@@ -108,6 +127,7 @@ public class SearchViewManager implements
             SearchManagerListener listener,
             EventHandler<String> commandProcessor,
             SearchChipViewManager chipViewManager,
+            @Nullable SearchOptionsController searchOptionsController,
             @Nullable Bundle savedState,
             Timer timer,
             Handler handler) {
@@ -121,6 +141,15 @@ public class SearchViewManager implements
         mUiHandler = handler;
         mChipViewManager = chipViewManager;
         mChipViewManager.setSearchChipViewManagerListener(this::onChipCheckedStateChanged);
+        if (!isSearchV2Enabled()) {
+            mSearchOptionsController = null;
+        } else {
+            mSearchOptionsController = searchOptionsController;
+            mLocationOption = SearchLocationOption.CURRENT_FOLDER;
+            if (mSearchOptionsController != null) {
+                mSearchOptionsController.setOptionChangeListener(this::onSearchOptionsChanged);
+            }
+        }
 
         if (savedState != null) {
             mCurrentSearch = savedState.getString(Shared.EXTRA_QUERY);
@@ -135,6 +164,11 @@ public class SearchViewManager implements
         performSearch(mCurrentSearch);
     }
 
+    private void onSearchOptionsChanged(SearchOptionsState optionsState) {
+        mLocationOption = optionsState.getLocation();
+        performSearch(mCurrentSearch);
+    }
+
     /**
      * Parse the query content from Intent. If the action is not {@link State#ACTION_GET_CONTENT}
      * or {@link State#ACTION_OPEN}, don't perform search.
@@ -160,7 +194,9 @@ public class SearchViewManager implements
      * @return the bundle of query arguments
      */
     public Bundle buildQueryArgs() {
-        final Bundle queryArgs = mChipViewManager.getCheckedChipQueryArgs();
+        final Bundle queryArgs = isSearchV2Enabled() && mSearchOptionsController.isVisible()
+                ? mSearchOptionsController.getOptionsQueryArgs()
+                : mChipViewManager.getCheckedChipQueryArgs();
         if (!TextUtils.isEmpty(mCurrentSearch)) {
             queryArgs.putString(DocumentsContract.QUERY_ARG_DISPLAY_NAME, mCurrentSearch);
         } else if (isExpanded() && isSearching()) {
@@ -209,19 +245,26 @@ public class SearchViewManager implements
      */
     public void onMirrorChipClick(SearchChipData data) {
         mChipViewManager.onMirrorChipClick(data);
-        mSearchView.clearFocus();
+        if (!mShowDockedSearch && mSearchView != null) {
+            mSearchView.clearFocus();
+        } else if (mShowDockedSearch && mDockedSearchEditText != null) {
+            mDockedSearchEditText.clearFocus();
+        }
     }
 
     /**
      * Initailize search view by option menu.
      *
-     * @param menu the menu include search view
+     * @param menu            the menu include search view
      * @param isFullBarSearch whether hide other menu when search view expand
      * @param isShowSearchBar whether replace collapsed search view by search hint text
+     * @param showDockedSearch whether show a docked (inline) search bar in the toolbar. When true,
+     *                         the search icon and search view will be hidden.
      */
-    public void install(Menu menu, boolean isFullBarSearch, boolean isShowSearchBar) {
+    public void install(Menu menu, boolean isFullBarSearch, boolean isShowSearchBar,
+            boolean showDockedSearch) {
         mMenu = menu;
-        mMenuItem = mMenu.findItem(R.id.option_menu_search);
+        mMenuItem = mMenu.findItem(getRes(R.id.option_menu_search));
         mSearchView = (SearchView) mMenuItem.getActionView();
 
         mSearchView.setOnQueryTextListener(this);
@@ -251,6 +294,46 @@ public class SearchViewManager implements
             }
         }
 
+        // showDockedSearch comes from a config but enforce that use_material3 flag is enabled.
+        mShowDockedSearch = isUseMaterial3FlagEnabled() && showDockedSearch;
+        if (mShowDockedSearch) {
+            mDockedSearch = mMenu.findItem(R.id.option_menu_docked_search);
+            mDockedSearchEditText = mDockedSearch.getActionView().findViewById(
+                    R.id.docked_search_text);
+            View dockedSearchClear = mDockedSearch.getActionView().findViewById(
+                    R.id.docked_search_clear);
+
+            mDockedSearchEditText.setOnFocusChangeListener((v, hasFocus) -> {
+                if (hasFocus) {
+                    onSearchExpanded();
+                } else if (mCurrentSearch == null || mCurrentSearch.isEmpty()) {
+                    onClose();
+                }
+                mListener.onSearchViewFocusChanged(hasFocus);
+            });
+            mDockedSearchEditText.addTextChangedListener(new TextWatcher() {
+                @Override
+                public void beforeTextChanged(CharSequence s, int start, int count, int after) { }
+
+                @Override
+                public void onTextChanged(CharSequence s, int start, int before, int count) {
+                    dockedSearchClear.setVisibility(
+                            TextUtils.isEmpty(s) ? View.INVISIBLE : View.VISIBLE);
+                    onQueryTextChange(s.toString());
+                }
+
+                @Override
+                public void afterTextChanged(Editable s) { }
+            });
+            mDockedSearchEditText.setOnEditorActionListener(
+                    (v, actionId, event) -> onQueryTextSubmit(v.getText().toString()));
+            dockedSearchClear.setOnClickListener(v -> {
+                mDockedSearchEditText.setText("");
+                mDockedSearchEditText.requestFocus();
+                mListener.onSearchViewClearClicked();
+            });
+        }
+
         mFullBar = isFullBarSearch;
         mShowSearchBar = isShowSearchBar;
         mSearchView.setMaxWidth(Integer.MAX_VALUE);
@@ -269,7 +352,7 @@ public class SearchViewManager implements
      */
     public void updateMenu() {
         if (mMenu != null && isExpanded() && mFullBar) {
-            mMenu.setGroupVisible(R.id.group_hide_when_searching, false);
+            mMenu.setGroupVisible(getRes(R.id.group_hide_when_searching), false);
         }
     }
 
@@ -277,28 +360,44 @@ public class SearchViewManager implements
      * @param stack New stack.
      */
     public void update(DocumentStack stack) {
-        if (mMenuItem == null || mSearchView == null) {
-            if (DEBUG) {
-                Log.d(TAG, "update called before Search MenuItem installed.");
+        // If docked search is enabled, restore the search query. Otherwise expand search view
+        // and restore the search query there.
+        if (mShowDockedSearch) {
+            if (mDockedSearchEditText == null) {
+                if (DEBUG) {
+                    Log.d(TAG, "update called before Search MenuItem installed.");
+                }
+                return;
+            }
+            if (mCurrentSearch != null) {
+                mDockedSearchEditText.setText(mCurrentSearch);
+            } else {
+                mDockedSearchEditText.setText("");
+                mDockedSearchEditText.clearFocus();
             }
-            return;
-        }
-
-        if (mCurrentSearch != null) {
-            mMenuItem.expandActionView();
-
-            mSearchView.setIconified(false);
-            mSearchView.clearFocus();
-            mSearchView.setQuery(mCurrentSearch, false);
         } else {
-            mSearchView.clearFocus();
-            if (!mSearchView.isIconified()) {
-                mIgnoreNextClose = true;
-                mSearchView.setIconified(true);
+            if (mMenuItem == null || mSearchView == null) {
+                if (DEBUG) {
+                    Log.d(TAG, "update called before Search MenuItem installed.");
+                }
+                return;
             }
+            if (mCurrentSearch != null) {
+                mMenuItem.expandActionView();
 
-            if (mMenuItem.isActionViewExpanded()) {
-                mMenuItem.collapseActionView();
+                mSearchView.setIconified(false);
+                mSearchView.clearFocus();
+                mSearchView.setQuery(mCurrentSearch, false);
+            } else {
+                mSearchView.clearFocus();
+                if (!mSearchView.isIconified()) {
+                    mIgnoreNextClose = true;
+                    mSearchView.setIconified(true);
+                }
+
+                if (mMenuItem.isActionViewExpanded()) {
+                    mMenuItem.collapseActionView();
+                }
             }
         }
 
@@ -332,17 +431,19 @@ public class SearchViewManager implements
             mCurrentSearch = null;
         }
 
-        // Recent root show open search bar, do not show duplicate search icon.
-        boolean enabled = supportsSearch && (!stack.isRecents() || !mShowSearchBar);
-        mMenuItem.setVisible(enabled);
-        if (isUseMaterial3FlagEnabled()) {
-            // When the use_material3 flag is enabled, we inflate and deflate the menu.
-            // This causes the search button to be disabled on inflation, toggle it in
-            // this scenario.
-            mMenuItem.setEnabled(enabled);
+        if (mShowDockedSearch && !mShowSearchBar) {
+            // When show_docked_search is enabled, we replace the search icon with a docked
+            // searchbar.
+            mMenuItem.setVisible(false);
+            mDockedSearch.setVisible(supportsSearch);
+        } else {
+            // Recent root show open search bar, do not show duplicate search icon.
+            mMenuItem.setVisible(supportsSearch && (!stack.isRecents() || !mShowSearchBar));
         }
 
-        mChipViewManager.setChipsRowVisible(supportsSearch && root.supportsMimeTypesSearch());
+        if (!isSearchV2Enabled()) {
+            mChipViewManager.setChipsRowVisible(supportsSearch && root.supportsMimeTypesSearch());
+        }
     }
 
     /**
@@ -351,12 +452,12 @@ public class SearchViewManager implements
      * @return True if it cancels search. False if it does not operate search currently.
      */
     public boolean cancelSearch() {
-        if (mSearchView != null && (isExpanded() || isSearching())) {
+        if ((isExpanded() || isSearching())) {
             cancelQueuedSearch();
 
-            if (mFullBar) {
-                onClose();
-            } else {
+            if (mFullBar || mShowDockedSearch) {
+                this.onStopSearch();
+            } else if (mSearchView != null) {
                 // Causes calling onClose(). onClose() is triggering directory content update.
                 mSearchView.setIconified(true);
             }
@@ -388,18 +489,33 @@ public class SearchViewManager implements
      * change.
      */
     public void restoreSearch(boolean keepFocus) {
-        if (mSearchView == null) {
-            return;
-        }
-
         if (isTextSearching()) {
-            onSearchBarClicked();
-            mSearchView.setQuery(mCurrentSearch, false);
+            if (!mShowDockedSearch) {
+                if (mSearchView == null) {
+                    return;
+                }
 
-            if (keepFocus) {
-                mSearchView.requestFocus();
+                onSearchBarClicked();
+                mSearchView.setQuery(mCurrentSearch, false);
+
+                if (keepFocus) {
+                    mSearchView.requestFocus();
+                } else {
+                    mSearchView.clearFocus();
+                }
             } else {
-                mSearchView.clearFocus();
+                if (mDockedSearchEditText == null) {
+                    return;
+                }
+
+                onSearchExpanded();
+                mDockedSearchEditText.setText(mCurrentSearch);
+
+                if (keepFocus) {
+                    mDockedSearchEditText.requestFocus();
+                } else {
+                    mDockedSearchEditText.clearFocus();
+                }
             }
         }
     }
@@ -416,7 +532,7 @@ public class SearchViewManager implements
     private void onSearchExpanded() {
         mSearchExpanded = true;
         if (mFullBar && mMenu != null) {
-            mMenu.setGroupVisible(R.id.group_hide_when_searching, false);
+            mMenu.setGroupVisible(getRes(R.id.group_hide_when_searching), false);
         }
 
         mListener.onSearchViewChanged(true);
@@ -430,6 +546,16 @@ public class SearchViewManager implements
      */
     @Override
     public boolean onClose() {
+        if (isSearchV2Enabled()) {
+            if (mSearchOptionsController != null) {
+                mSearchOptionsController.setVisible(false);
+            }
+            mChipViewManager.setChipsRowVisible(true);
+        }
+        return this.onStopSearch();
+    }
+
+    private boolean onStopSearch() {
         mSearchExpanded = false;
         if (mIgnoreNextClose) {
             mIgnoreNextClose = false;
@@ -465,7 +591,9 @@ public class SearchViewManager implements
      * @param state Bundle to save state too
      */
     public void onSaveInstanceState(Bundle state) {
-        if (mSearchView != null && mSearchView.hasFocus() && mCurrentSearch == null) {
+        boolean hasFocus = mShowDockedSearch ? mDockedSearchEditText != null
+                && mDockedSearchEditText.hasFocus() : mSearchView != null && mSearchView.hasFocus();
+        if (hasFocus && mCurrentSearch == null) {
             // Restore focus even if no text was input before screen rotation.
             mCurrentSearch = "";
         }
@@ -484,9 +612,12 @@ public class SearchViewManager implements
 
     @Override
     public boolean onQueryTextSubmit(String query) {
-
         if (mCommandProcessor.accept(query)) {
-            mSearchView.setQuery("", false);
+            if (!mShowDockedSearch && mSearchView != null) {
+                mSearchView.setQuery("", false);
+            } else if (mShowDockedSearch && mDockedSearchEditText != null) {
+                mDockedSearchEditText.setText("");
+            }
         } else {
             cancelQueuedSearch();
             // Don't kick off a search if we've already finished it.
@@ -495,7 +626,11 @@ public class SearchViewManager implements
                 mListener.onSearchChanged(mCurrentSearch);
             }
             recordHistory();
-            mSearchView.clearFocus();
+            if (!mShowDockedSearch && mSearchView != null) {
+                mSearchView.clearFocus();
+            } else if (mShowDockedSearch && mDockedSearchEditText != null) {
+                mDockedSearchEditText.clearFocus();
+            }
         }
 
         return true;
@@ -506,9 +641,12 @@ public class SearchViewManager implements
      */
     @Override
     public void onFocusChange(View v, boolean hasFocus) {
+        // This is only called for SearchView. The docked search has a separate focus listener.
         if (!hasFocus && !mChipViewManager.hasCheckedItems()) {
-            if (mSearchView != null && mCurrentSearch == null) {
-                mSearchView.setIconified(true);
+            if (mCurrentSearch == null) {
+                if (!mShowDockedSearch && mSearchView != null) {
+                    mSearchView.setIconified(true);
+                }
             } else if (TextUtils.isEmpty(getSearchViewText())) {
                 cancelSearch();
             }
@@ -539,6 +677,12 @@ public class SearchViewManager implements
 
     @Override
     public boolean onQueryTextChange(String newText) {
+        if (isSearchV2Enabled()) {
+            if (!newText.isEmpty()) {
+                mChipViewManager.setChipsRowVisible(false);
+                mSearchOptionsController.setVisible(true);
+            }
+        }
         //Skip first search when search expanded
         if (mCurrentSearch == null && newText.isEmpty()) {
             return true;
@@ -556,6 +700,9 @@ public class SearchViewManager implements
     }
 
     private void performSearch(String newText) {
+        if (isSearchV2Enabled()) {
+            mListener.onSearchStarting();
+        }
         cancelQueuedSearch();
         synchronized (mSearchLock) {
             mQueuedSearchTask = createSearchTask(newText);
@@ -566,7 +713,7 @@ public class SearchViewManager implements
 
     @Override
     public boolean onMenuItemActionCollapse(MenuItem item) {
-        mMenu.setGroupVisible(R.id.group_hide_when_searching, true);
+        mMenu.setGroupVisible(getRes(R.id.group_hide_when_searching), true);
 
         // Handles case when search view is collapsed by using the arrow on the left of the bar
         if (isExpanded() || isSearching()) {
@@ -591,11 +738,12 @@ public class SearchViewManager implements
      * @return  Current string on search view
      */
     public String getSearchViewText() {
-        if (mSearchView == null) {
-            return null;
+        if (!mShowDockedSearch && mSearchView != null) {
+            return mSearchView.getQuery().toString();
+        } else if (mShowDockedSearch && mDockedSearchEditText != null) {
+            return mDockedSearchEditText.getText().toString();
         }
-
-        return mSearchView.getQuery().toString();
+        return null;
     }
 
     /**
@@ -680,9 +828,77 @@ public class SearchViewManager implements
         return mSearchExpanded;
     }
 
+    /**
+     * For the given set of roots, and the current state of the document stack, it returns a list
+     * of searchable folders. This method uses the state of the search options to narrow down
+     * the list of folders to the one that the user asks to be searched.
+     *
+     * @param roots The list of roots that are used to form a list of searchable folders.
+     * @param stack The current state of the document stack.
+     * @return A list of folders that should be searched based on the search options.
+     */
+    public Collection<FolderInfo> getSearchFolders(Collection<RootInfo> roots,
+            DocumentStack stack) {
+        Collection<FolderInfo> folderList = new ArrayList<>();
+        // A predicate that selects all searchable roots that have an authority and a rootID.
+        // TODO(b:391232249): Resolve if we should test for r.isStorage() to eliminate media roots.
+        Predicate<RootInfo> baseFilter =
+                r -> r.supportsSearch() && r.authority != null && r.rootId != null;
+        if (stack.isRecents()) {
+            Predicate<RootInfo> filter = baseFilter;
+            if (mLocationOption != SearchLocationOption.EVERYWHERE) {
+                // If we are not searching everywhere, limit the search to local roots only.
+                filter = baseFilter.and(RootInfo::isLocalOnly);
+            }
+            folderList = roots.stream().filter(filter).map(FolderInfo::new).collect(
+                    Collectors.toList());
+        } else if (mLocationOption != null) {
+            RootInfo root = stack.getRoot();
+            if (root == null) {
+                return Collections.emptyList();
+            }
+            DocumentInfo topFolder = stack.peek();
+            switch (mLocationOption) {
+                case CURRENT_FOLDER:
+                    // Fall-through.
+                    // TODO(b:391232249): Searching with stack.peek().documentId does not work.
+                case ROOT_FOLDER: {
+                    if (Providers.AUTHORITY_DOWNLOADS.equals(root.authority) && topFolder != null) {
+                        folderList.add(new FolderInfo(topFolder, root));
+                    } else {
+                        // Here we are searching with rootId, even though we are suppose to search
+                        // in the current folder. This needs to be fixed.
+                        folderList.add(new FolderInfo(root));
+                    }
+                    break;
+                }
+                case EVERYWHERE: {
+                    // When searching locally, to avoid duplicates, do not rely on MediaStore or
+                    // DownloadStorageProvider.
+                    folderList = roots.stream().filter(baseFilter.and(
+                            r -> !Providers.AUTHORITY_MEDIA.equals(r.authority)
+                                    && !Providers.AUTHORITY_DOWNLOADS.equals(r.authority))).map(
+                            FolderInfo::new).collect(Collectors.toList());
+                    break;
+                }
+                default:
+                    throw new IllegalStateException(
+                            "Unhandled location option " + mLocationOption.name());
+            }
+        }
+        return folderList;
+    }
+
     public interface SearchManagerListener {
         void onSearchChanged(@Nullable String query);
 
+        /**
+         * Called when the search is about to start. There may be other tasks performed
+         * before actual searching commences, such as debouncing, etc. However, this is
+         * the signal that the SearchViewManager is getting ready to start searching.
+         */
+        void onSearchStarting();
+
         void onSearchFinished();
 
         void onSearchViewChanged(boolean opened);
diff --git a/src/com/android/documentsui/roots/ProvidersCache.java b/src/com/android/documentsui/roots/ProvidersCache.java
index bc54fce83..b46763147 100644
--- a/src/com/android/documentsui/roots/ProvidersCache.java
+++ b/src/com/android/documentsui/roots/ProvidersCache.java
@@ -22,6 +22,7 @@ import static androidx.core.util.Preconditions.checkNotNull;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.base.SharedMinimal.VERBOSE;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.BroadcastReceiver.PendingResult;
 import android.content.ContentProviderClient;
@@ -130,16 +131,21 @@ public class ProvidersCache implements ProvidersAccess, LookupApplicationName {
      * Generates recent root for the provided user id
      */
     private RootInfo generateRecentsRoot(UserId rootUserId) {
-        return new RootInfo() {{
-            // Special root for recents
-            userId = rootUserId;
-            derivedIcon = R.drawable.ic_root_recent;
-            derivedType = RootInfo.TYPE_RECENTS;
-            flags = Root.FLAG_LOCAL_ONLY | Root.FLAG_SUPPORTS_IS_CHILD | Root.FLAG_SUPPORTS_SEARCH;
-            queryArgs = QUERY_ARG_MIME_TYPES;
-            title = mContext.getString(R.string.root_recent);
-            availableBytes = -1;
-        }};
+        return new RootInfo() {
+            {
+                // Special root for recents
+                userId = rootUserId;
+                derivedIcon = getRes(R.drawable.ic_root_recent);
+                derivedType = RootInfo.TYPE_RECENTS;
+                flags =
+                        Root.FLAG_LOCAL_ONLY
+                                | Root.FLAG_SUPPORTS_IS_CHILD
+                                | Root.FLAG_SUPPORTS_SEARCH;
+                queryArgs = QUERY_ARG_MIME_TYPES;
+                title = mContext.getString(getRes(R.string.root_recent));
+                availableBytes = -1;
+            }
+        };
     }
 
     private RootInfo createOrGetRecentsRoot(UserId userId) {
@@ -199,7 +205,7 @@ public class ProvidersCache implements ProvidersAccess, LookupApplicationName {
         // NOTE: This method is called when the UI language changes.
         // For that reason we update our RecentsRoot to reflect
         // the current language.
-        final String title = mContext.getString(R.string.root_recent);
+        final String title = mContext.getString(getRes(R.string.root_recent));
         List<UserId> userIds = new ArrayList<>(getUserIds());
         for (UserId userId : userIds) {
             RootInfo recentRoot = createOrGetRecentsRoot(userId);
@@ -207,7 +213,7 @@ public class ProvidersCache implements ProvidersAccess, LookupApplicationName {
             // Nothing else about the root should ever change.
             assert (recentRoot.authority == null);
             assert (recentRoot.rootId == null);
-            assert (recentRoot.derivedIcon == R.drawable.ic_root_recent);
+            assert (recentRoot.derivedIcon == getRes(R.drawable.ic_root_recent));
             assert (recentRoot.derivedType == RootInfo.TYPE_RECENTS);
             assert (recentRoot.flags == (Root.FLAG_LOCAL_ONLY | Root.FLAG_SUPPORTS_IS_CHILD));
             assert (recentRoot.availableBytes == -1);
diff --git a/src/com/android/documentsui/roots/RootCursorWrapper.java b/src/com/android/documentsui/roots/RootCursorWrapper.java
index b40972e3a..e2a4264b7 100644
--- a/src/com/android/documentsui/roots/RootCursorWrapper.java
+++ b/src/com/android/documentsui/roots/RootCursorWrapper.java
@@ -16,14 +16,14 @@
 
 package com.android.documentsui.roots;
 
+import static com.android.documentsui.base.SharedMinimal.VERBOSE;
+
 import android.database.AbstractCursor;
 import android.database.ContentObserver;
 import android.database.Cursor;
 import android.os.Bundle;
 import android.util.Log;
 
-import static com.android.documentsui.base.SharedMinimal.VERBOSE;
-
 import com.android.documentsui.base.UserId;
 
 /**
@@ -92,6 +92,11 @@ public class RootCursorWrapper extends AbstractCursor {
         return extras;
     }
 
+    @Override
+    public void setExtras(Bundle bundle) {
+        mCursor.setExtras(bundle);
+    }
+
     @Override
     public void close() {
         super.close();
diff --git a/src/com/android/documentsui/services/CompressJob.java b/src/com/android/documentsui/services/CompressJob.java
index ccb3ee835..b0c70fe83 100644
--- a/src/com/android/documentsui/services/CompressJob.java
+++ b/src/com/android/documentsui/services/CompressJob.java
@@ -19,18 +19,17 @@ package com.android.documentsui.services;
 import static android.content.ContentResolver.wrap;
 
 import static com.android.documentsui.services.FileOperationService.OPERATION_MOVE;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Notification;
 import android.app.Notification.Builder;
 import android.content.ContentResolver;
 import android.content.Context;
-import android.icu.text.MessageFormat;
 import android.net.Uri;
 import android.os.Messenger;
 import android.os.ParcelFileDescriptor;
 import android.os.RemoteException;
 import android.provider.DocumentsContract;
-import android.text.BidiFormatter;
 import android.util.Log;
 
 import com.android.documentsui.R;
@@ -42,9 +41,6 @@ import com.android.documentsui.base.UserId;
 import com.android.documentsui.clipping.UrisSupplier;
 
 import java.io.FileNotFoundException;
-import java.util.HashMap;
-import java.util.Locale;
-import java.util.Map;
 
 // TODO: Stop extending CopyJob.
 final class CompressJob extends CopyJob {
@@ -69,46 +65,32 @@ final class CompressJob extends CopyJob {
     @Override
     Builder createProgressBuilder() {
         return super.createProgressBuilder(
-                service.getString(R.string.compress_notification_title),
-                R.drawable.ic_menu_compress,
+                service.getString(getRes(R.string.compress_notification_title)),
+                getRes(R.drawable.ic_menu_compress),
                 service.getString(android.R.string.cancel),
-                R.drawable.ic_cab_cancel);
+                getRes(R.drawable.ic_cab_cancel));
     }
 
     @Override
     public Notification getSetupNotification() {
-        return getSetupNotification(service.getString(R.string.compress_preparing));
+        return getSetupNotification(service.getString(getRes(R.string.compress_preparing)));
     }
 
     @Override
     public Notification getProgressNotification() {
-        return getProgressNotification(R.string.copy_remaining);
+        return getProgressNotification(getRes(R.string.copy_remaining));
     }
 
     @Override
-    Notification getFailureNotification() {
+    public Notification getFailureNotification() {
         return getFailureNotification(
-                R.plurals.compress_error_notification_title, R.drawable.ic_menu_compress);
+                getRes(R.plurals.compress_error_notification_title),
+                getRes(R.drawable.ic_menu_compress));
     }
 
     @Override
     protected String getProgressMessage() {
-        switch (getState()) {
-            case Job.STATE_SET_UP:
-            case Job.STATE_COMPLETED:
-            case Job.STATE_CANCELED:
-                Map<String, Object> formatArgs = new HashMap<>();
-                formatArgs.put("count", mResolvedDocs.size());
-                if (mResolvedDocs.size() == 1) {
-                    formatArgs.put("filename", BidiFormatter.getInstance().unicodeWrap(
-                            mResolvedDocs.get(0).displayName));
-                }
-                return (new MessageFormat(
-                        service.getString(R.string.compress_in_progress), Locale.getDefault()))
-                        .format(formatArgs);
-            default:
-                return "";
-        }
+        return getProgressMessage(R.string.compress_in_progress);
     }
 
     @Override
@@ -125,7 +107,9 @@ final class CompressJob extends CopyJob {
         if (mResolvedDocs.size() == 1) {
             displayName = mResolvedDocs.get(0).displayName + NEW_ARCHIVE_EXTENSION;
         } else {
-            displayName = service.getString(R.string.new_archive_file_name, NEW_ARCHIVE_EXTENSION);
+            displayName =
+                    service.getString(
+                            getRes(R.string.new_archive_file_name), NEW_ARCHIVE_EXTENSION);
         }
 
         try {
diff --git a/src/com/android/documentsui/services/CopyJob.java b/src/com/android/documentsui/services/CopyJob.java
index 9fb3f5d09..99a68fb6c 100644
--- a/src/com/android/documentsui/services/CopyJob.java
+++ b/src/com/android/documentsui/services/CopyJob.java
@@ -35,6 +35,8 @@ import static com.android.documentsui.services.FileOperationService.EXTRA_OPERAT
 import static com.android.documentsui.services.FileOperationService.MESSAGE_FINISH;
 import static com.android.documentsui.services.FileOperationService.MESSAGE_PROGRESS;
 import static com.android.documentsui.services.FileOperationService.OPERATION_COPY;
+import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Notification;
 import android.app.Notification.Builder;
@@ -44,9 +46,9 @@ import android.content.ContentResolver;
 import android.content.Context;
 import android.content.Intent;
 import android.content.res.AssetFileDescriptor;
+import android.content.res.Resources;
 import android.database.ContentObserver;
 import android.database.Cursor;
-import android.icu.text.MessageFormat;
 import android.net.Uri;
 import android.os.DeadObjectException;
 import android.os.FileUtils;
@@ -96,7 +98,6 @@ import java.io.SyncFailedException;
 import java.text.NumberFormat;
 import java.util.ArrayList;
 import java.util.HashMap;
-import java.util.Locale;
 import java.util.Map;
 import java.util.concurrent.atomic.AtomicLong;
 import java.util.function.Function;
@@ -137,15 +138,15 @@ class CopyJob extends ResolvedResourcesJob {
     @Override
     Builder createProgressBuilder() {
         return super.createProgressBuilder(
-                service.getString(R.string.copy_notification_title),
-                R.drawable.ic_menu_copy,
+                service.getString(getRes(R.string.copy_notification_title)),
+                getRes(R.drawable.ic_menu_copy),
                 service.getString(android.R.string.cancel),
-                R.drawable.ic_cab_cancel);
+                getRes(R.drawable.ic_cab_cancel));
     }
 
     @Override
     public Notification getSetupNotification() {
-        return getSetupNotification(service.getString(R.string.copy_preparing));
+        return getSetupNotification(service.getString(getRes(R.string.copy_preparing)));
     }
 
     Notification getProgressNotification(@StringRes int msgId) {
@@ -156,7 +157,7 @@ class CopyJob extends ResolvedResourcesJob {
 
     @Override
     public Notification getProgressNotification() {
-        return getProgressNotification(R.string.copy_remaining);
+        return getProgressNotification(getRes(R.string.copy_remaining));
     }
 
     @Override
@@ -170,9 +171,9 @@ class CopyJob extends ResolvedResourcesJob {
     }
 
     @Override
-    Notification getFailureNotification() {
+    public Notification getFailureNotification() {
         return getFailureNotification(
-                R.plurals.copy_error_notification_title, R.drawable.ic_menu_copy);
+                getRes(R.plurals.copy_error_notification_title), getRes(R.drawable.ic_menu_copy));
     }
 
     @Override
@@ -182,44 +183,34 @@ class CopyJob extends ResolvedResourcesJob {
         navigateIntent.putExtra(EXTRA_OPERATION_TYPE, operationType);
 
         navigateIntent.putParcelableArrayListExtra(EXTRA_FAILED_DOCS, convertedFiles);
-
+        final Resources resources = service.getResources();
         // TODO: Consider adding a dialog on tapping the notification with a list of
         // converted files.
-        final Notification.Builder warningBuilder = createNotificationBuilder()
-                .setContentTitle(service.getResources().getString(
-                        R.string.notification_copy_files_converted_title))
-                .setContentText(service.getString(
-                        R.string.notification_touch_for_details))
-                .setContentIntent(PendingIntent.getActivity(appContext, 0, navigateIntent,
-                        PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_ONE_SHOT
-                                | PendingIntent.FLAG_IMMUTABLE))
-                .setCategory(Notification.CATEGORY_ERROR)
-                .setSmallIcon(R.drawable.ic_menu_copy)
-                .setAutoCancel(true);
+        final Notification.Builder warningBuilder =
+                createNotificationBuilder()
+                        .setContentTitle(
+                                resources.getString(
+                                        getRes(R.string.notification_copy_files_converted_title)))
+                        .setContentText(
+                                service.getString(getRes(R.string.notification_touch_for_details)))
+                        .setContentIntent(
+                                PendingIntent.getActivity(
+                                        appContext,
+                                        0,
+                                        navigateIntent,
+                                        PendingIntent.FLAG_UPDATE_CURRENT
+                                                | PendingIntent.FLAG_ONE_SHOT
+                                                | PendingIntent.FLAG_IMMUTABLE))
+                        .setCategory(Notification.CATEGORY_ERROR)
+                        .setSmallIcon(getRes(R.drawable.ic_menu_copy))
+                        .setAutoCancel(true);
         return warningBuilder.build();
     }
 
     protected String getProgressMessage() {
-        switch (getState()) {
-            case Job.STATE_SET_UP:
-            case Job.STATE_COMPLETED:
-            case Job.STATE_CANCELED:
-                Map<String, Object> formatArgs = new HashMap<>();
-                formatArgs.put("count", mResolvedDocs.size());
-                formatArgs.put("directory",
-                        BidiFormatter.getInstance().unicodeWrap(mDstInfo.displayName));
-                if (mResolvedDocs.size() == 1) {
-                    formatArgs.put("filename",
-                            BidiFormatter.getInstance().unicodeWrap(
-                                    mResolvedDocs.get(0).displayName));
-                }
-                return (new MessageFormat(
-                        service.getString(R.string.copy_in_progress), Locale.getDefault()))
-                        .format(formatArgs);
-
-            default:
-                return "";
-        }
+        Map<String, Object> formatArgs = new HashMap<>();
+        formatArgs.put("directory", BidiFormatter.getInstance().unicodeWrap(stack.getTitle()));
+        return getProgressMessage(R.string.copy_in_progress, formatArgs);
     }
 
     @Override
@@ -227,16 +218,20 @@ class CopyJob extends ResolvedResourcesJob {
         if (mProgressTracker == null) {
             return new JobProgress(
                     id,
+                    operationType,
                     getState(),
                     getProgressMessage(),
-                    hasFailures());
+                    hasFailures(),
+                    stack);
         }
         mProgressTracker.updateEstimateRemainingTime();
         return new JobProgress(
                 id,
+                operationType,
                 getState(),
                 getProgressMessage(),
                 hasFailures(),
+                stack,
                 mProgressTracker.getCurrentBytes(),
                 mProgressTracker.getRequiredBytes(),
                 mProgressTracker.getRemainingTimeEstimate());
@@ -1042,7 +1037,11 @@ class CopyJob extends ResolvedResourcesJob {
         }
 
         protected void update(Builder builder, Function<Long, String> messageFormatter) {
-            updateEstimateRemainingTime();
+            // When the flag is enabled, updateEstimatedRemainingTime() is already called
+            // elsewhere at the same time, so only call it when the flag is disabled.
+            if (!isVisualSignalsFlagEnabled()) {
+                updateEstimateRemainingTime();
+            }
             final double completed = getProgress();
 
             builder.setProgress(100, (int) (completed * 100), false);
diff --git a/src/com/android/documentsui/services/DeleteJob.java b/src/com/android/documentsui/services/DeleteJob.java
index 801cc6dd3..387c3794d 100644
--- a/src/com/android/documentsui/services/DeleteJob.java
+++ b/src/com/android/documentsui/services/DeleteJob.java
@@ -18,14 +18,13 @@ package com.android.documentsui.services;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.services.FileOperationService.OPERATION_DELETE;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Notification;
 import android.app.Notification.Builder;
 import android.content.ContentResolver;
 import android.content.Context;
-import android.icu.text.MessageFormat;
 import android.net.Uri;
-import android.text.BidiFormatter;
 import android.util.Log;
 
 import com.android.documentsui.MetricConsts;
@@ -38,9 +37,6 @@ import com.android.documentsui.base.UserId;
 import com.android.documentsui.clipping.UrisSupplier;
 
 import java.io.FileNotFoundException;
-import java.util.HashMap;
-import java.util.Locale;
-import java.util.Map;
 
 import javax.annotation.Nullable;
 
@@ -68,21 +64,21 @@ final class DeleteJob extends ResolvedResourcesJob {
     @Override
     Builder createProgressBuilder() {
         return super.createProgressBuilder(
-                service.getString(R.string.delete_notification_title),
-                R.drawable.ic_menu_delete,
+                service.getString(getRes(R.string.delete_notification_title)),
+                getRes(R.drawable.ic_menu_delete),
                 service.getString(android.R.string.cancel),
-                R.drawable.ic_cab_cancel);
+                getRes(R.drawable.ic_cab_cancel));
     }
 
     @Override
     public Notification getSetupNotification() {
-        return getSetupNotification(service.getString(R.string.delete_preparing));
+        return getSetupNotification(service.getString(getRes(R.string.delete_preparing)));
     }
 
     @Override
     public Notification getProgressNotification() {
         mProgressBuilder.setProgress(mResourceUris.getItemCount(), mDocsProcessed, false);
-        String format = service.getString(R.string.delete_progress);
+        String format = service.getString(getRes(R.string.delete_progress));
         mProgressBuilder.setSubText(
                 String.format(format, mDocsProcessed, mResourceUris.getItemCount()));
 
@@ -92,39 +88,21 @@ final class DeleteJob extends ResolvedResourcesJob {
     }
 
     @Override
-    Notification getFailureNotification() {
+    public Notification getFailureNotification() {
         return getFailureNotification(
-                R.plurals.delete_error_notification_title, R.drawable.ic_menu_delete);
-    }
-
-    @Override
-    Notification getWarningNotification() {
-        throw new UnsupportedOperationException();
+                getRes(R.plurals.delete_error_notification_title),
+                getRes(R.drawable.ic_menu_delete));
     }
 
     private String getProgressMessage() {
-        switch (getState()) {
-            case Job.STATE_SET_UP:
-            case Job.STATE_COMPLETED:
-            case Job.STATE_CANCELED:
-                Map<String, Object> formatArgs = new HashMap<>();
-                formatArgs.put("count", mResolvedDocs.size());
-                if (mResolvedDocs.size() == 1) {
-                    formatArgs.put("filename", BidiFormatter.getInstance().unicodeWrap(
-                            mResolvedDocs.get(0).displayName));
-                }
-                return (new MessageFormat(
-                        service.getString(R.string.delete_in_progress), Locale.getDefault()))
-                        .format(formatArgs);
-            default:
-                return "";
-        }
+        return getProgressMessage(R.string.delete_in_progress);
     }
 
     @Override
     JobProgress getJobProgress() {
         return new JobProgress(
                 id,
+                operationType,
                 getState(),
                 getProgressMessage(),
                 hasFailures());
diff --git a/src/com/android/documentsui/services/FileOperation.java b/src/com/android/documentsui/services/FileOperation.java
index 89525bee1..080b6e48b 100644
--- a/src/com/android/documentsui/services/FileOperation.java
+++ b/src/com/android/documentsui/services/FileOperation.java
@@ -22,6 +22,7 @@ import static com.android.documentsui.services.FileOperationService.OPERATION_CO
 import static com.android.documentsui.services.FileOperationService.OPERATION_COPY;
 import static com.android.documentsui.services.FileOperationService.OPERATION_DELETE;
 import static com.android.documentsui.services.FileOperationService.OPERATION_EXTRACT;
+import static com.android.documentsui.services.FileOperationService.OPERATION_UNPACK;
 import static com.android.documentsui.services.FileOperationService.OPERATION_MOVE;
 import static com.android.documentsui.services.FileOperationService.OPERATION_UNKNOWN;
 
@@ -102,8 +103,8 @@ public abstract class FileOperation implements Parcelable {
 
     private void appendInfoTo(StringBuilder builder) {
         builder.append("opType=").append(mOpType);
-        builder.append(", srcs=").append(mSrcs.toString());
-        builder.append(", destination=").append(mDestination.toString());
+        builder.append(", srcs=").append(mSrcs);
+        builder.append(", destination=").append(mDestination);
     }
 
     @Override
@@ -122,8 +123,8 @@ public abstract class FileOperation implements Parcelable {
     }
 
     public static class CopyOperation extends FileOperation {
-        private CopyOperation(UrisSupplier srcs, DocumentStack destination) {
-            super(OPERATION_COPY, srcs, destination);
+        private CopyOperation(@OpType int opType, UrisSupplier srcs, DocumentStack destination) {
+            super(opType, srcs, destination);
         }
 
         @Override
@@ -203,44 +204,43 @@ public abstract class FileOperation implements Parcelable {
                 };
     }
 
-    public static class ExtractOperation extends FileOperation {
-        private ExtractOperation(UrisSupplier srcs, DocumentStack destination) {
-            super(OPERATION_EXTRACT, srcs, destination);
+    public static class UnpackOperation extends FileOperation {
+        private UnpackOperation(UrisSupplier srcs, DocumentStack destination) {
+            super(OPERATION_UNPACK, srcs, destination);
         }
 
         @Override
         public String toString() {
             StringBuilder builder = new StringBuilder();
 
-            builder.append("ExtractOperation{");
+            builder.append("UnpackOperation{");
             super.appendInfoTo(builder);
             builder.append("}");
 
             return builder.toString();
         }
 
-        // TODO: Replace CopyJob with ExtractJob.
         @Override
-        CopyJob createJob(Context service, Job.Listener listener, String id, Features features) {
-            return new CopyJob(
-                    service, listener, id, getDestination(), getSrc(), getMessenger(), features);
+        UnpackJob createJob(Context service, Job.Listener listener, String id, Features features) {
+            return new UnpackJob(
+                    service, listener, id, getDestination(), getSrc(), features);
         }
 
-        private ExtractOperation(Parcel in) {
+        private UnpackOperation(Parcel in) {
             super(in);
         }
 
-        public static final Parcelable.Creator<ExtractOperation> CREATOR =
-                new Parcelable.Creator<ExtractOperation>() {
+        public static final Parcelable.Creator<UnpackOperation> CREATOR =
+                new Parcelable.Creator<UnpackOperation>() {
 
                     @Override
-                    public ExtractOperation createFromParcel(Parcel source) {
-                        return new ExtractOperation(source);
+                    public UnpackOperation createFromParcel(Parcel source) {
+                        return new UnpackOperation(source);
                     }
 
                     @Override
-                    public ExtractOperation[] newArray(int size) {
-                        return new ExtractOperation[size];
+                    public UnpackOperation[] newArray(int size) {
+                        return new UnpackOperation[size];
                     }
                 };
     }
@@ -276,7 +276,7 @@ public abstract class FileOperation implements Parcelable {
 
             builder.append("MoveDeleteOperation{");
             super.appendInfoTo(builder);
-            builder.append(", srcParent=").append(mSrcParent.toString());
+            builder.append(", srcParent=").append(mSrcParent);
             builder.append("}");
 
             return builder.toString();
@@ -338,14 +338,15 @@ public abstract class FileOperation implements Parcelable {
         public FileOperation build() {
             switch (mOpType) {
                 case OPERATION_COPY:
-                    return new CopyOperation(mSrcs, mDestination);
+                case OPERATION_EXTRACT:
+                    return new CopyOperation(mOpType, mSrcs, mDestination);
                 case OPERATION_COMPRESS:
                     return new CompressOperation(mSrcs, mDestination);
-                case OPERATION_EXTRACT:
-                    return new ExtractOperation(mSrcs, mDestination);
                 case OPERATION_MOVE:
                 case OPERATION_DELETE:
                     return new MoveDeleteOperation(mOpType, mSrcs, mDestination, mSrcParent);
+                case OPERATION_UNPACK:
+                    return new UnpackOperation(mSrcs, mDestination);
                 default:
                     throw new UnsupportedOperationException("Unsupported op type: " + mOpType);
             }
diff --git a/src/com/android/documentsui/services/FileOperationService.java b/src/com/android/documentsui/services/FileOperationService.java
index 14b87ef5b..3a8d1a8ca 100644
--- a/src/com/android/documentsui/services/FileOperationService.java
+++ b/src/com/android/documentsui/services/FileOperationService.java
@@ -18,6 +18,7 @@ package com.android.documentsui.services;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Notification;
 import android.app.NotificationChannel;
@@ -62,6 +63,7 @@ public class FileOperationService extends Service implements Job.Listener {
 
     public static final String EXTRA_FAILED_URIS = "com.android.documentsui.FAILED_URIS";
     public static final String EXTRA_FAILED_DOCS = "com.android.documentsui.FAILED_DOCS";
+    public static final String EXTRA_FAILED_PATHS = "com.android.documentsui.FAILED_PATHS";
 
     // Extras used to start or cancel a file operation...
     public static final String EXTRA_JOB_ID = "com.android.documentsui.JOB_ID";
@@ -70,6 +72,7 @@ public class FileOperationService extends Service implements Job.Listener {
 
     public static final String ACTION_PROGRESS = "com.android.documentsui.action.PROGRESS";
     public static final String EXTRA_PROGRESS = "com.android.documentsui.PROGRESS";
+    public static final String EXTRA_PROGRESS_ID = "com.android.documentsui.PROGRESS_ID";
 
     @IntDef({
             OPERATION_UNKNOWN,
@@ -77,7 +80,8 @@ public class FileOperationService extends Service implements Job.Listener {
             OPERATION_COMPRESS,
             OPERATION_EXTRACT,
             OPERATION_MOVE,
-            OPERATION_DELETE
+            OPERATION_DELETE,
+            OPERATION_UNPACK,
     })
     @Retention(RetentionPolicy.SOURCE)
     public @interface OpType {}
@@ -87,6 +91,7 @@ public class FileOperationService extends Service implements Job.Listener {
     public static final int OPERATION_COMPRESS = 3;
     public static final int OPERATION_MOVE = 4;
     public static final int OPERATION_DELETE = 5;
+    public static final int OPERATION_UNPACK = 6;
 
     @IntDef({
             MESSAGE_PROGRESS,
@@ -188,10 +193,11 @@ public class FileOperationService extends Service implements Job.Listener {
 
     private void setUpNotificationChannel() {
         if (features.isNotificationChannelEnabled()) {
-            NotificationChannel channel = new NotificationChannel(
-                    NOTIFICATION_CHANNEL_ID,
-                    getString(R.string.app_label),
-                    NotificationManager.IMPORTANCE_LOW);
+            NotificationChannel channel =
+                    new NotificationChannel(
+                            NOTIFICATION_CHANNEL_ID,
+                            getString(getRes(R.string.app_label)),
+                            NotificationManager.IMPORTANCE_LOW);
             notificationManager.createNotificationChannel(channel);
         }
     }
@@ -306,6 +312,7 @@ public class FileOperationService extends Service implements Job.Listener {
             if (record != null) {
                 record.job.cancel();
                 updateForegroundState(record.job);
+                onFinished(record.job);
             }
         }
 
@@ -324,6 +331,7 @@ public class FileOperationService extends Service implements Job.Listener {
             case OPERATION_COMPRESS:
             case OPERATION_EXTRACT:
             case OPERATION_MOVE:
+            case OPERATION_UNPACK:
                 return executor;
             case OPERATION_DELETE:
                 return deletionExecutor;
@@ -425,11 +433,16 @@ public class FileOperationService extends Service implements Job.Listener {
         if (DEBUG) {
             Log.d(TAG, "onFinished: " + job.id);
         }
-        if (mVisualSignalsEnabled) {
-            mJobMonitor.sendProgress();
-        }
 
         synchronized (mJobs) {
+            if (!mJobs.containsKey(job.id)) {
+                return;
+            }
+
+            if (mVisualSignalsEnabled) {
+                mJobMonitor.sendProgress();
+            }
+
             // Delete the job from mJobs first to avoid this job being selected as the foreground
             // task again if we need to swap the foreground job.
             deleteJob(job);
@@ -473,9 +486,11 @@ public class FileOperationService extends Service implements Job.Listener {
                 }
 
                 notificationManager.cancel(candidate.id, NOTIFICATION_ID_PROGRESS);
-                Notification notification = (candidate.getState() == Job.STATE_STARTED)
-                        ? candidate.getSetupNotification()
-                        : candidate.getProgressNotification();
+                var jobState = candidate.getState();
+                Notification notification =
+                        (jobState == Job.STATE_CREATED || jobState == Job.STATE_STARTED)
+                                ? candidate.getSetupNotification()
+                                : candidate.getProgressNotification();
                 notificationManager.notify(NOTIFICATION_ID_PROGRESS, notification);
             }
         }
@@ -496,6 +511,9 @@ public class FileOperationService extends Service implements Job.Listener {
             if (!job.failedDocs.isEmpty()) {
                 Log.e(TAG, "Job failed to process docs: " + job.failedDocs + ".");
             }
+            if (!job.failedPaths.isEmpty()) {
+                Log.e(TAG, "Job failed to extract paths: " + job.failedPaths);
+            }
             notificationManager.notify(
                     job.id, NOTIFICATION_ID_FAILURE, job.getFailureNotification());
         }
@@ -601,13 +619,22 @@ public class FileOperationService extends Service implements Job.Listener {
             var progress = new ArrayList<JobProgress>();
             synchronized (mJobs) {
                 for (JobRecord rec : mJobs.values()) {
-                    progress.add(rec.job.getJobProgress());
+                    var job = rec.job;
+                    progress.add(job.getJobProgress());
+
+                    // Only job in set up state has progress bar
+                    if (job.getState() == Job.STATE_SET_UP) {
+                        notificationManager.notify(
+                                mForegroundJob == job ? null : job.id,
+                                NOTIFICATION_ID_PROGRESS,
+                                job.getProgressNotification());
+                    }
                 }
             }
             Intent intent = new Intent();
             intent.setPackage(getPackageName());
             intent.setAction(ACTION_PROGRESS);
-            intent.putExtra("id", mLastId++);
+            intent.putExtra(EXTRA_PROGRESS_ID, mLastId++);
             intent.putParcelableArrayListExtra(EXTRA_PROGRESS, progress);
             sendBroadcast(intent);
         }
diff --git a/src/com/android/documentsui/services/FileOperations.java b/src/com/android/documentsui/services/FileOperations.java
index e8a2c354f..e4ff6e020 100644
--- a/src/com/android/documentsui/services/FileOperations.java
+++ b/src/com/android/documentsui/services/FileOperations.java
@@ -17,18 +17,18 @@
 package com.android.documentsui.services;
 
 import static android.os.SystemClock.elapsedRealtime;
+
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.services.FileOperationService.EXTRA_CANCEL;
 import static com.android.documentsui.services.FileOperationService.EXTRA_JOB_ID;
 import static com.android.documentsui.services.FileOperationService.EXTRA_OPERATION;
 
-import androidx.annotation.IntDef;
-import android.app.Activity;
 import android.content.Context;
 import android.content.Intent;
-import androidx.annotation.VisibleForTesting;
 import android.util.Log;
 
+import androidx.annotation.IntDef;
+
 import com.android.documentsui.services.FileOperationService.OpType;
 
 import java.lang.annotation.Retention;
@@ -74,17 +74,21 @@ public final class FileOperations {
         return newJobId;
     }
 
-    @VisibleForTesting
-    public static void cancel(Activity activity, String jobId) {
+    /**
+     * Tries to cancel a given operation by its job id.
+     * @param context
+     * @param jobId The job to cancel.
+     */
+    public static void cancel(Context context, String jobId) {
         if (DEBUG) {
             Log.d(TAG, "Attempting to canceling operation: " + jobId);
         }
 
-        Intent intent = new Intent(activity, FileOperationService.class);
+        Intent intent = new Intent(context, FileOperationService.class);
         intent.putExtra(EXTRA_CANCEL, true);
         intent.putExtra(EXTRA_JOB_ID, jobId);
 
-        activity.startService(intent);
+        context.startService(intent);
     }
 
     /**
diff --git a/src/com/android/documentsui/services/Job.java b/src/com/android/documentsui/services/Job.java
index 95ad8b335..75bb684a7 100644
--- a/src/com/android/documentsui/services/Job.java
+++ b/src/com/android/documentsui/services/Job.java
@@ -22,10 +22,12 @@ import static com.android.documentsui.DocumentsApplication.acquireUnstableProvid
 import static com.android.documentsui.services.FileOperationService.EXTRA_CANCEL;
 import static com.android.documentsui.services.FileOperationService.EXTRA_DIALOG_TYPE;
 import static com.android.documentsui.services.FileOperationService.EXTRA_FAILED_DOCS;
+import static com.android.documentsui.services.FileOperationService.EXTRA_FAILED_PATHS;
 import static com.android.documentsui.services.FileOperationService.EXTRA_FAILED_URIS;
 import static com.android.documentsui.services.FileOperationService.EXTRA_JOB_ID;
 import static com.android.documentsui.services.FileOperationService.EXTRA_OPERATION_TYPE;
 import static com.android.documentsui.services.FileOperationService.OPERATION_UNKNOWN;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Notification;
 import android.app.Notification.Builder;
@@ -45,6 +47,7 @@ import android.util.Log;
 
 import androidx.annotation.DrawableRes;
 import androidx.annotation.IntDef;
+import androidx.annotation.NonNull;
 import androidx.annotation.PluralsRes;
 
 import com.android.documentsui.Metrics;
@@ -85,7 +88,7 @@ abstract public class Job implements Runnable {
      * A job is in canceled state as long as {@link #cancel()} is called on it, even after it is
      * completed.
      */
-    static final int STATE_CANCELED = 4;
+    public static final int STATE_CANCELED = 4;
 
     static final String INTENT_TAG_WARNING = "warning";
     static final String INTENT_TAG_FAILURE = "failure";
@@ -102,9 +105,14 @@ abstract public class Job implements Runnable {
 
     final UrisSupplier mResourceUris;
 
-    int failureCount = 0;
+    /**
+     * Number of errors. It is modified by the main thread running setUp(), start() and finish(),
+     * and it is read by the progress reporting thread running getJobProgress().
+     */
+    volatile int failureCount = 0;
     final ArrayList<DocumentInfo> failedDocs = new ArrayList<>();
     final ArrayList<Uri> failedUris = new ArrayList<>();
+    final ArrayList<String> failedPaths = new ArrayList<>();
 
     final Notification.Builder mProgressBuilder;
 
@@ -113,7 +121,7 @@ abstract public class Job implements Runnable {
     private final Map<String, ContentProviderClient> mClients = new HashMap<>();
     private final Features mFeatures;
 
-    private volatile @State int mState = STATE_CREATED;
+    private @State int mState = STATE_CREATED;
 
     /**
      * A simple progressable job, much like an AsyncTask, but with support
@@ -147,19 +155,30 @@ abstract public class Job implements Runnable {
 
     @Override
     public final void run() {
-        if (isCanceled()) {
-            // Canceled before running
-            return;
+        synchronized (this) {
+            if (mState == STATE_CANCELED) {
+                // Canceled before running
+                return;
+            }
+
+            mState = STATE_STARTED;
         }
 
-        mState = STATE_STARTED;
         listener.onStart(this);
 
         try {
-            boolean result = setUp();
-            if (result && !isCanceled()) {
-                mState = STATE_SET_UP;
-                start();
+            boolean ok = setUp();
+
+            if (ok) {
+                synchronized (this) {
+                    if (mState == STATE_CANCELED) {
+                        ok = false;
+                    } else {
+                        mState = STATE_SET_UP;
+                    }
+                }
+
+                if (ok) start();
             }
         } catch (RuntimeException e) {
             // No exceptions should be thrown here, as all calls to the provider must be
@@ -167,7 +186,10 @@ abstract public class Job implements Runnable {
             Log.e(TAG, "Operation failed due to an unhandled runtime exception.", e);
             Metrics.logFileOperationErrors(operationType, failedDocs, failedUris);
         } finally {
-            mState = (mState == STATE_STARTED || mState == STATE_SET_UP) ? STATE_COMPLETED : mState;
+            synchronized (this) {
+                if (mState == STATE_STARTED || mState == STATE_SET_UP) mState = STATE_COMPLETED;
+            }
+
             finish();
             listener.onFinished(this);
 
@@ -184,11 +206,15 @@ abstract public class Job implements Runnable {
     abstract void finish();
 
     abstract void start();
-    abstract Notification getSetupNotification();
-    abstract Notification getProgressNotification();
-    abstract Notification getFailureNotification();
 
-    abstract Notification getWarningNotification();
+    public abstract Notification getSetupNotification();
+    public abstract Notification getProgressNotification();
+    public abstract Notification getFailureNotification();
+
+    /** Must be implemented if hasWarnings() can return true. */
+    Notification getWarningNotification() {
+        throw new UnsupportedOperationException();
+    }
 
     abstract JobProgress getJobProgress();
 
@@ -233,21 +259,24 @@ abstract public class Job implements Runnable {
         }
     }
 
-    final @State int getState() {
+    final synchronized @State int getState() {
         return mState;
     }
 
+    /** Requests the cancellation of this job. Can be called from any thread. */
     final void cancel() {
-        mState = STATE_CANCELED;
+        synchronized (this) {
+            mState = STATE_CANCELED;
+        }
         mSignal.cancel();
         Metrics.logFileOperationCancelled(operationType);
     }
 
-    final boolean isCanceled() {
+    final synchronized boolean isCanceled() {
         return mState == STATE_CANCELED;
     }
 
-    final boolean isFinished() {
+    final synchronized boolean isFinished() {
         return mState == STATE_CANCELED || mState == STATE_COMPLETED;
     }
 
@@ -265,6 +294,11 @@ abstract public class Job implements Runnable {
         failedUris.add(uri);
     }
 
+    void onPathFailed(@NonNull String path) {
+        failureCount++;
+        failedPaths.add(path);
+    }
+
     final boolean hasFailures() {
         return failureCount > 0;
     }
@@ -304,19 +338,37 @@ abstract public class Job implements Runnable {
         final Intent navigateIntent = buildNavigateIntent(INTENT_TAG_FAILURE);
         navigateIntent.putExtra(EXTRA_DIALOG_TYPE, OperationDialogFragment.DIALOG_TYPE_FAILURE);
         navigateIntent.putExtra(EXTRA_OPERATION_TYPE, operationType);
-        navigateIntent.putParcelableArrayListExtra(EXTRA_FAILED_DOCS, failedDocs);
-        navigateIntent.putParcelableArrayListExtra(EXTRA_FAILED_URIS, failedUris);
-
-        final Notification.Builder errorBuilder = createNotificationBuilder()
-                .setContentTitle(service.getResources().getQuantityString(titleId,
-                        failureCount, failureCount))
-                .setContentText(service.getString(R.string.notification_touch_for_details))
-                .setContentIntent(PendingIntent.getActivity(appContext, 0, navigateIntent,
-                        PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_ONE_SHOT
-                        | PendingIntent.FLAG_MUTABLE))
-                .setCategory(Notification.CATEGORY_ERROR)
-                .setSmallIcon(icon)
-                .setAutoCancel(true);
+
+        // Limit the size of the lists getting passed with the failure notification.
+        final int maxListSize = 100;
+        navigateIntent.putParcelableArrayListExtra(EXTRA_FAILED_DOCS,
+                failedDocs.size() <= maxListSize ? failedDocs
+                        : new ArrayList<>(failedDocs.subList(0, maxListSize)));
+        navigateIntent.putParcelableArrayListExtra(EXTRA_FAILED_URIS,
+                failedUris.size() <= maxListSize ? failedUris
+                        : new ArrayList<>(failedUris.subList(0, maxListSize)));
+        navigateIntent.putStringArrayListExtra(EXTRA_FAILED_PATHS,
+                failedPaths.size() <= maxListSize ? failedPaths
+                        : new ArrayList<>(failedPaths.subList(0, maxListSize)));
+
+        final Notification.Builder errorBuilder =
+                createNotificationBuilder()
+                        .setContentTitle(
+                                service.getResources()
+                                        .getQuantityString(titleId, failureCount, failureCount))
+                        .setContentText(
+                                service.getString(getRes(R.string.notification_touch_for_details)))
+                        .setContentIntent(
+                                PendingIntent.getActivity(
+                                        appContext,
+                                        0,
+                                        navigateIntent,
+                                        PendingIntent.FLAG_UPDATE_CURRENT
+                                                | PendingIntent.FLAG_ONE_SHOT
+                                                | PendingIntent.FLAG_MUTABLE))
+                        .setCategory(Notification.CATEGORY_ERROR)
+                        .setSmallIcon(icon)
+                        .setAutoCancel(true);
 
         return errorBuilder.build();
     }
@@ -390,7 +442,7 @@ abstract public class Job implements Runnable {
     /**
      * Listener interface employed by the service that owns us as well as tests.
      */
-    interface Listener {
+    public interface Listener {
         void onStart(Job job);
         void onFinished(Job job);
     }
diff --git a/src/com/android/documentsui/services/JobProgress.kt b/src/com/android/documentsui/services/JobProgress.kt
index 98be92f6a..b663bf8ad 100644
--- a/src/com/android/documentsui/services/JobProgress.kt
+++ b/src/com/android/documentsui/services/JobProgress.kt
@@ -18,6 +18,7 @@ package com.android.documentsui.services
 
 import android.os.Parcel
 import android.os.Parcelable
+import com.android.documentsui.base.DocumentStack
 
 /**
  * Represents the current progress on an individual job owned by the FileOperationService.
@@ -25,14 +26,31 @@ import android.os.Parcelable
  */
 data class JobProgress @JvmOverloads constructor(
     @JvmField val id: String,
+    @JvmField @FileOperationService.OpType val operationType: Int,
     @JvmField @Job.State val state: Int,
     @JvmField val msg: String?,
     @JvmField val hasFailures: Boolean,
+    @JvmField val destination: DocumentStack? = null,
     @JvmField val currentBytes: Long = -1,
     @JvmField val requiredBytes: Long = -1,
     @JvmField val msRemaining: Long = -1,
 ) : Parcelable {
 
+    val isIndeterminate get() =
+        state == Job.STATE_SET_UP &&
+                (currentBytes == -1L || requiredBytes == -1L || requiredBytes == 0L)
+
+    fun toPercent(): Float = when (state) {
+        Job.STATE_CREATED, Job.STATE_STARTED -> 0f
+        Job.STATE_COMPLETED, Job.STATE_CANCELED -> 100f
+        else -> 100f * currentBytes / requiredBytes
+    }
+
+    val isFinal get() = when (state) {
+        Job.STATE_COMPLETED, Job.STATE_CANCELED -> true
+        else -> false
+    }
+
     override fun describeContents(): Int {
         return 0
     }
@@ -40,22 +58,29 @@ data class JobProgress @JvmOverloads constructor(
     override fun writeToParcel(dest: Parcel, flags: Int) {
         dest.apply {
             writeString(id)
+            writeInt(operationType)
             writeInt(state)
             writeString(msg)
             writeBoolean(hasFailures)
+            writeParcelable(destination, flags)
             writeLong(currentBytes)
             writeLong(requiredBytes)
             writeLong(msRemaining)
         }
     }
 
-    companion object CREATOR : Parcelable.Creator<JobProgress?> {
-        override fun createFromParcel(parcel: Parcel): JobProgress? {
+    companion object CREATOR : Parcelable.Creator<JobProgress> {
+        override fun createFromParcel(parcel: Parcel): JobProgress {
             return JobProgress(
                 parcel.readString()!!,
                 parcel.readInt(),
+                parcel.readInt(),
                 parcel.readString(),
                 parcel.readBoolean(),
+                parcel.readParcelable(
+                    DocumentStack::class.java.classLoader,
+                    DocumentStack::class.java
+                ),
                 parcel.readLong(),
                 parcel.readLong(),
                 parcel.readLong(),
diff --git a/src/com/android/documentsui/services/MoveJob.java b/src/com/android/documentsui/services/MoveJob.java
index b2974c5e7..59a3cadc6 100644
--- a/src/com/android/documentsui/services/MoveJob.java
+++ b/src/com/android/documentsui/services/MoveJob.java
@@ -20,11 +20,11 @@ import static android.content.ContentResolver.wrap;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.services.FileOperationService.OPERATION_MOVE;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Notification;
 import android.app.Notification.Builder;
 import android.content.Context;
-import android.icu.text.MessageFormat;
 import android.net.Uri;
 import android.os.DeadObjectException;
 import android.os.Messenger;
@@ -45,7 +45,6 @@ import com.android.documentsui.clipping.UrisSupplier;
 
 import java.io.FileNotFoundException;
 import java.util.HashMap;
-import java.util.Locale;
 import java.util.Map;
 
 import javax.annotation.Nullable;
@@ -76,48 +75,33 @@ final class MoveJob extends CopyJob {
     @Override
     Builder createProgressBuilder() {
         return super.createProgressBuilder(
-                service.getString(R.string.move_notification_title),
-                R.drawable.ic_menu_copy,
+                service.getString(getRes(R.string.move_notification_title)),
+                getRes(R.drawable.ic_menu_copy),
                 service.getString(android.R.string.cancel),
-                R.drawable.ic_cab_cancel);
+                getRes(R.drawable.ic_cab_cancel));
     }
 
     @Override
     public Notification getSetupNotification() {
-        return getSetupNotification(service.getString(R.string.move_preparing));
+        return getSetupNotification(service.getString(getRes(R.string.move_preparing)));
     }
 
     @Override
     public Notification getProgressNotification() {
-        return getProgressNotification(R.string.copy_remaining);
+        return getProgressNotification(getRes(R.string.copy_remaining));
     }
 
     @Override
-    Notification getFailureNotification() {
+    public Notification getFailureNotification() {
         return getFailureNotification(
-                R.plurals.move_error_notification_title, R.drawable.ic_menu_copy);
+                getRes(R.plurals.move_error_notification_title), getRes(R.drawable.ic_menu_copy));
     }
 
     @Override
     protected String getProgressMessage() {
-        switch (getState()) {
-            case Job.STATE_SET_UP:
-            case Job.STATE_COMPLETED:
-            case Job.STATE_CANCELED:
-                Map<String, Object> formatArgs = new HashMap<>();
-                formatArgs.put("count", mResolvedDocs.size());
-                formatArgs.put("directory",
-                        BidiFormatter.getInstance().unicodeWrap(mDstInfo.displayName));
-                if (mResolvedDocs.size() == 1) {
-                    formatArgs.put("filename", BidiFormatter.getInstance().unicodeWrap(
-                            mResolvedDocs.get(0).displayName));
-                }
-                return (new MessageFormat(
-                        service.getString(R.string.move_in_progress), Locale.getDefault()))
-                        .format(formatArgs);
-            default:
-                return "";
-        }
+        Map<String, Object> formatArgs = new HashMap<>();
+        formatArgs.put("directory", BidiFormatter.getInstance().unicodeWrap(stack.getTitle()));
+        return getProgressMessage(R.string.move_in_progress, formatArgs);
     }
 
     @Override
diff --git a/src/com/android/documentsui/services/ResolvedResourcesJob.java b/src/com/android/documentsui/services/ResolvedResourcesJob.java
index a6001d5f8..8ffb02bbc 100644
--- a/src/com/android/documentsui/services/ResolvedResourcesJob.java
+++ b/src/com/android/documentsui/services/ResolvedResourcesJob.java
@@ -19,11 +19,15 @@ package com.android.documentsui.services;
 import static android.os.SystemClock.uptimeMillis;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.ContentResolver;
 import android.content.Context;
+import android.icu.text.MessageFormat;
 import android.net.Uri;
 import android.os.RemoteException;
+import android.text.BidiFormatter;
 import android.util.Log;
 
 import com.android.documentsui.archives.ArchivesProvider;
@@ -38,7 +42,10 @@ import com.android.documentsui.services.FileOperationService.OpType;
 import java.io.FileNotFoundException;
 import java.io.IOException;
 import java.util.ArrayList;
+import java.util.HashMap;
 import java.util.List;
+import java.util.Locale;
+import java.util.Map;
 
 /**
  * Abstract job that resolves all resource URIs into mResolvedDocs. This provides
@@ -62,6 +69,12 @@ public abstract class ResolvedResourcesJob extends Job {
 
         // Delay the initialization of it to setUp() because it may be IO extensive.
         mResolvedDocs = new ArrayList<>(srcs.getItemCount());
+
+        if (isVisualSignalsFlagEnabled() && srcs.getItemCount() == 1) {
+            // Prebuild the document list so we can get the filename for a single file progress
+            // message. With a single file only, this should not be IO intensive.
+            buildDocumentList();
+        }
     }
 
     boolean setUp() {
@@ -88,7 +101,7 @@ public abstract class ResolvedResourcesJob extends Job {
             return false;
         }
 
-        int docsResolved = buildDocumentList();
+        int docsResolved = refreshDocumentList();
         if (!isCanceled() && docsResolved < mResourceUris.getItemCount()) {
             if (docsResolved == 0) {
                 Log.e(TAG, "Cannot load any documents. Aborting.");
@@ -129,7 +142,7 @@ public abstract class ResolvedResourcesJob extends Job {
     /**
      * @return number of docs successfully loaded.
      */
-    protected int buildDocumentList() {
+    private int buildDocumentList() {
         final ContentResolver resolver = appContext.getContentResolver();
         Iterable<Uri> uris;
         try {
@@ -166,4 +179,37 @@ public abstract class ResolvedResourcesJob extends Job {
 
         return docsLoaded;
     }
+
+    private int refreshDocumentList() {
+        // We've never built the list in the first place.
+        if (mResolvedDocs.isEmpty() && failureCount == 0) {
+            return buildDocumentList();
+        }
+
+        final ContentResolver resolver = appContext.getContentResolver();
+        mResolvedDocs.removeIf(doc -> {
+            try {
+                doc.updateSelf(resolver, UserId.DEFAULT_USER);
+            } catch (FileNotFoundException e) {
+                onFileFailed(doc);
+                return true;
+            }
+            return false;
+        });
+        return mResolvedDocs.size();
+    }
+
+    protected String getProgressMessage(int stringId, Map<String, Object> formatArgs) {
+        formatArgs.put("count", mResourceUris.getItemCount());
+        if (mResourceUris.getItemCount() == 1 && mResolvedDocs.size() == 1) {
+            formatArgs.put("filename",
+                    BidiFormatter.getInstance().unicodeWrap(mResolvedDocs.get(0).displayName));
+        }
+        return (new MessageFormat(service.getString(getRes(stringId)), Locale.getDefault()))
+                .format(formatArgs);
+    }
+
+    protected String getProgressMessage(int stringId) {
+        return getProgressMessage(stringId, new HashMap<>());
+    }
 }
diff --git a/src/com/android/documentsui/services/UnpackJob.kt b/src/com/android/documentsui/services/UnpackJob.kt
new file mode 100644
index 000000000..f5527c97e
--- /dev/null
+++ b/src/com/android/documentsui/services/UnpackJob.kt
@@ -0,0 +1,552 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.services
+
+import android.app.Notification
+import android.content.Context
+import android.icu.text.MessageFormat
+import android.net.Uri
+import android.os.FileUtils.copy
+import android.os.OperationCanceledException
+import android.os.ParcelFileDescriptor
+import android.os.SystemClock
+import android.provider.DocumentsContract
+import android.text.BidiFormatter
+import android.text.TextUtils
+import android.util.Log
+import com.android.documentsui.DocumentsApplication
+import com.android.documentsui.R
+import com.android.documentsui.archives.ReadableArchive
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.base.DocumentStack
+import com.android.documentsui.base.Features
+import com.android.documentsui.base.SharedMinimal.DEBUG
+import com.android.documentsui.base.SharedMinimal.VERBOSE
+import com.android.documentsui.base.SharedMinimal.redact
+import com.android.documentsui.clipping.UrisSupplier
+import com.android.documentsui.util.FormatUtils
+import com.android.documentsui.util.Material3Config.Companion.getRes
+import com.google.common.io.Files
+import java.io.File
+import java.io.IOException
+import java.io.InputStream
+import java.text.NumberFormat
+import java.util.LinkedList
+import java.util.Locale
+import org.apache.commons.compress.archivers.ArchiveEntry
+
+/**
+ * UnpackJob extracts all the files from a supported archive. It only works on one archive at a
+ * time. Given an archive to unpack, it:
+ * - Opens the archive
+ * - Lists all the entries of the archive
+ * - Estimates the number of directories, files and bytes to extract
+ * - Checks the free space in the destination directory
+ * - Creates a unique extraction directory in the destination directory
+ * - Creates all the intermediate directories in the extraction directory
+ * - Extracts all the files from the archive
+ * - Tracks and reports its own progress
+ * - Records file extraction errors
+ * - Deletes any partially extracted file in case of error
+ * - Handles cancellation gracefully
+ */
+class UnpackJob(
+    service: Context,
+    listener: Listener,
+    id: String,
+    destination: DocumentStack,
+    srcs: UrisSupplier,
+    features: Features
+) : ResolvedResourcesJob(
+    service,
+    listener,
+    id,
+    FileOperationService.OPERATION_UNPACK,
+    destination,
+    srcs,
+    features
+) {
+    private val dirPathToUri: MutableMap<String, Uri> = mutableMapOf()
+    private val tracker = ProgressTracker()
+    private val dstInfo: DocumentInfo = destination.peek()
+    private var archive: ReadableArchive? = null
+
+    override fun createProgressBuilder(): Notification.Builder {
+        return super.createProgressBuilder(
+            service.getString(getRes(R.string.extract_notification_title)),
+            getRes(R.drawable.ic_menu_extract),
+            service.getString(android.R.string.cancel),
+            getRes(R.drawable.ic_cab_cancel)
+        )
+    }
+
+    override fun getSetupNotification(): Notification {
+        return getSetupNotification(service.getString(getRes(R.string.extract_preparing)))
+    }
+
+    /** This method is called on a different thread than the thread running the extraction. */
+    override fun getProgressNotification(): Notification {
+        val absoluteProgress: Double
+        val absoluteTarget: Double
+        val remainingTime: Long
+
+        synchronized(this) {
+            absoluteProgress = tracker.absoluteProgress
+            absoluteTarget = tracker.absoluteTarget
+            remainingTime = tracker.getRemainingTimeEstimate(absoluteProgress, absoluteTarget)
+            if (DEBUG) Log.d(TAG, "$tracker, ${remainingTime / 1000} seconds left")
+        }
+
+        if (absoluteTarget > 0) {
+            val relativeProgress = absoluteProgress / absoluteTarget
+            mProgressBuilder.setProgress(100, (relativeProgress * 100).toInt(), false)
+            mProgressBuilder.setSubText(NumberFormat.getPercentInstance().format(relativeProgress))
+        } else {
+            mProgressBuilder.setProgress(100, 0, true)
+            mProgressBuilder.setSubText(null)
+        }
+
+        mProgressBuilder.setContentText(
+            if (remainingTime > 0) {
+                service.getString(
+                    getRes(R.string.copy_remaining),
+                    FormatUtils.formatDuration(remainingTime)
+                )
+            } else {
+                null
+            }
+        )
+
+        return mProgressBuilder.build()
+    }
+
+    override fun finish() {
+        if (DEBUG) Log.d(TAG, "Finished with $tracker")
+        archive?.close()
+        super.finish()
+    }
+
+    override fun getFailureNotification(): Notification {
+        return getFailureNotification(
+            getRes(R.plurals.copy_error_notification_title),
+            getRes(R.drawable.ic_menu_extract)
+        )
+    }
+
+    /** This method is called on a different thread than the thread running the extraction. */
+    @Synchronized
+    public override fun getJobProgress(): JobProgress {
+        val args: MutableMap<String, Any> = mutableMapOf(
+            "directory" to BidiFormatter.getInstance().unicodeWrap(dstInfo.displayName),
+            "count" to mResolvedDocs.size,
+        )
+
+        if (mResolvedDocs.size == 1) {
+            args.put(
+                "filename",
+                BidiFormatter.getInstance().unicodeWrap(archiveInfo.displayName)
+            )
+        }
+
+        val message = MessageFormat(
+            service.getString(getRes(R.string.extract_in_progress)),
+            Locale.getDefault()
+        ).format(args)
+
+        return JobProgress(
+            id,
+            operationType,
+            state,
+            message,
+            hasFailures(),
+            stack,
+            tracker.bytesCopied,
+            tracker.bytesRequired,
+            tracker.remainingTimeEstimate
+        )
+    }
+
+    private val resolver = appContext.getContentResolver()
+
+    private val archiveInfo: DocumentInfo
+        get() {
+            assert(mResolvedDocs.size == 1)
+            return mResolvedDocs.first()
+        }
+
+    override fun setUp(): Boolean {
+        synchronized(this) {
+            if (!super.setUp()) return false
+        }
+
+        if (DEBUG) Log.d(TAG, "Unpacking ${archiveInfo.derivedUri}")
+
+        try {
+            openArchive()
+            checkFreeSpace()
+            createExtractionDirectory()
+            return true
+        } catch (_: OperationCanceledException) {
+            if (DEBUG) Log.d(TAG, "Canceled unpacking of ${archiveInfo.derivedUri}")
+        } catch (t: Throwable) {
+            Log.e(TAG, "Cannot unpack ${redact(archiveInfo.derivedUri)}", t)
+            onFileFailed(archiveInfo)
+        }
+
+        return false
+    }
+
+    private fun createExtractionDirectory() {
+        mSignal.throwIfCanceled()
+
+        // Create the extraction directory with the same base name as the archive.
+        // This lets the destination document provider deal with name collisions, if necessary.
+        val dirName = Files.getNameWithoutExtension(archiveInfo.displayName)
+        val dirUri = DocumentsContract.createDocument(
+            resolver,
+            dstInfo.derivedUri,
+            DocumentsContract.Document.MIME_TYPE_DIR,
+            dirName
+        )
+
+        if (dirUri == null) {
+            throw IOException(
+                "Cannot create extraction dir ${redact(dirName)} in ${redact(dstInfo.derivedUri)}"
+            )
+        }
+
+        dirPathToUri.put("/", dirUri)
+        val dirInfo = DocumentInfo.fromUri(resolver, dirUri, dstInfo.userId)
+        if (VERBOSE) Log.v(TAG, "Created extraction dir ${redact(dirInfo)}")
+        stack.push(dirInfo)
+    }
+
+    private fun openArchive() {
+        mSignal.throwIfCanceled()
+
+        // Open the archive.
+        archive = ReadableArchive.createForParcelFileDescriptor(
+            appContext,
+            resolver.openFileDescriptor(archiveInfo.derivedUri, "r", null),
+            archiveInfo.derivedUri,
+            archiveInfo.mimeType,
+            ParcelFileDescriptor.MODE_READ_ONLY,
+            null
+        )
+
+        mSignal.throwIfCanceled()
+
+        // Count all the directories to create, all the files to extract, and all the bytes
+        // to copy.
+        val dirs = mutableSetOf("/")
+        for (entry in archive!!.entries) {
+            var path = File(ReadableArchive.getEntryPath(entry))
+
+            if (!entry.isDirectory()) {
+                // The entry represents a file. Get the path of its containing directory.
+                path = path.getParentFile()!!
+                synchronized(this) {
+                    tracker.bytesRequired += entry.getSize()
+                    tracker.filesRequired++
+                }
+            }
+
+            while (dirs.add(path.toString())) {
+                path = path.getParentFile()!!
+                synchronized(this) {
+                    tracker.dirsRequired++
+                }
+            }
+        }
+    }
+
+    override fun start() {
+        synchronized(this) {
+            tracker.addPoint()
+        }
+
+        try {
+            // Create all the directories first, to ensure that no directory will be renamed
+            // because of a collision with a file name.
+            createAllDirectories()
+            extractAllFiles()
+        } catch (_: OperationCanceledException) {
+            if (DEBUG) Log.d(TAG, "Canceled unpacking of ${redact(archiveInfo.derivedUri)}")
+        } catch (t: Throwable) {
+            Log.e(TAG, "Cannot unpack ${redact(archiveInfo.derivedUri)}", t)
+            onFileFailed(archiveInfo)
+        }
+    }
+
+    private fun extractAllFiles() {
+        for (entry in archive!!.entries) {
+            mSignal.throwIfCanceled()
+            if (!entry.isDirectory()) processFileEntry(entry)
+        }
+    }
+
+    private fun createAllDirectories() {
+        for (entry in archive!!.entries) {
+            mSignal.throwIfCanceled()
+            var path = File(ReadableArchive.getEntryPath(entry))
+            if (!entry.isDirectory()) path = path.getParentFile()!!
+            ensureDirectoryExists(path)
+        }
+    }
+
+    private fun processFileEntry(entry: ArchiveEntry) {
+        val path = File(ReadableArchive.getEntryPath(entry))
+        val dirUri = ensureDirectoryExists(path.getParentFile()!!)
+        val fileName = path.getName()
+
+        try {
+            extractFile(entry, dirUri, fileName)
+        } catch (e: OperationCanceledException) {
+            // Propagate cancellation request.
+            throw e
+        } catch (t: Throwable) {
+            Log.e(TAG, "Cannot extract ${redact(path)} from ${redact(archiveInfo.derivedUri)}", t)
+            synchronized(this) {
+                tracker.filesRequired--
+            }
+            onPathFailed(path.toString())
+        }
+
+        // Adjust progress expectations after extracting a file.
+        synchronized(this) {
+            tracker.bytesRequired -= entry.getSize() - tracker.bytesCopiedInCurrentFile
+            tracker.bytesCopiedInPreviousFiles += tracker.bytesCopiedInCurrentFile
+            tracker.bytesCopiedInCurrentFile = 0
+            tracker.addPoint()
+        }
+    }
+
+    private fun extractFile(entry: ArchiveEntry, dirUri: Uri, fileName: String) {
+        // Open input stream serving the archive entry's contents.
+        archive!!.getInputStream(entry).use { inputStream ->
+            mSignal.throwIfCanceled()
+            // Create output file.
+            val fileUri = DocumentsContract.createDocument(resolver, dirUri, "", fileName)!!
+            if (VERBOSE) Log.v(TAG, "Created file $fileUri")
+            try {
+                copyFile(inputStream, fileUri)
+            } catch (t: Throwable) {
+                // Error or cancellation while copying a file.
+                deletePartialFile(fileUri)
+                throw t
+            }
+        }
+    }
+
+    @Synchronized
+    private fun trackBytesInCurrentFile(bytes: Long) {
+        tracker.bytesCopiedInCurrentFile = bytes
+        tracker.addPoint()
+    }
+
+    private fun copyFile(inputStream: InputStream, outputFile: Uri) {
+        val client = getClient(outputFile)
+        // Open output file for writing.
+        try {
+            client.openFile(outputFile, "w", mSignal).use { fd ->
+                ParcelFileDescriptor.AutoCloseOutputStream(fd).use { outputStream ->
+                    // Copy bytes.
+                    val bytes = copy(
+                        inputStream,
+                        outputStream,
+                        mSignal,
+                        Runnable::run,
+                        ::trackBytesInCurrentFile
+                    )
+                    trackBytesInCurrentFile(bytes)
+                }
+            }
+        } finally {
+            releaseClient(outputFile)
+        }
+
+        synchronized(this) {
+            tracker.filesCopied++
+            tracker.addPoint()
+        }
+    }
+
+    private fun deletePartialFile(uri: Uri) {
+        try {
+            if (DocumentsContract.deleteDocument(resolver, uri)) {
+                if (DEBUG) Log.d(TAG, "Deleted partial file ${redact(uri)}")
+            } else {
+                Log.e(TAG, "Cannot delete partial file ${redact(uri)}")
+            }
+        } catch (t: Throwable) {
+            Log.e(TAG, "Cannot delete partial file ${redact(uri)}", t)
+        }
+    }
+
+    @Throws(IOException::class)
+    private fun ensureDirectoryExists(path: File): Uri {
+        val uri = dirPathToUri[path.toString()]
+        if (uri != null) return uri
+
+        val parentUri = ensureDirectoryExists(path.getParentFile()!!)
+        val name = path.getName()
+        if (TextUtils.isEmpty(name)) return parentUri
+
+        mSignal.throwIfCanceled()
+        val newDirUri = DocumentsContract.createDocument(
+            resolver,
+            parentUri,
+            DocumentsContract.Document.MIME_TYPE_DIR,
+            name
+        )
+
+        if (newDirUri == null) {
+            throw IOException("Cannot create dir ${redact(name)} in ${redact(parentUri)}")
+        }
+
+        if (VERBOSE) Log.v(TAG, "Created dir ${redact(newDirUri)}")
+        dirPathToUri.put(path.toString(), newDirUri)
+
+        synchronized(this) {
+            tracker.dirsCreated++
+            tracker.addPoint()
+        }
+
+        return newDirUri
+    }
+
+    /** Checks whether the destination directory has enough free space.  */
+    private fun checkFreeSpace() {
+        mSignal.throwIfCanceled()
+        val bytesRequired = tracker.bytesRequired
+        if (DEBUG) Log.d(TAG, "Need at least $bytesRequired bytes of free space")
+
+        var root = stack.root
+        if (root == null) {
+            Log.w(TAG, "No root info for destination dir ${redact(dstInfo.derivedUri)}")
+            return
+        }
+
+        // Query root info again instead of using stack.root because the numbers may be stale.
+        root = DocumentsApplication.getProvidersCache(appContext).getRootOneshot(
+            root.userId, root.authority, root.rootId, true
+        )
+
+        if (root == null || root.availableBytes < 0) {
+            Log.w(TAG, "Root $root does not provide its free space amount")
+            return
+        }
+
+        if (DEBUG) Log.d(TAG, "Root $root has ${root.availableBytes} bytes of free space")
+
+        if (bytesRequired > root.availableBytes) {
+            throw IOException(
+                "Not enough free space in ${redact(dstInfo.derivedUri)}: " +
+                        "Need $bytesRequired bytes, " +
+                        "but only got ${root.availableBytes} bytes of free space"
+            )
+        }
+    }
+
+    override fun toString(): String {
+        return "UnpackJob {id=$id, uris=$mResourceUris, docs=$mResolvedDocs, dest=$dstInfo}"
+    }
+
+    private class ProgressTracker : Job.ProgressTracker {
+        var bytesRequired: Long = 0
+        var bytesCopiedInPreviousFiles: Long = 0
+        var bytesCopiedInCurrentFile: Long = 0
+        var filesRequired = 0
+        var filesCopied = 0
+        var dirsRequired = 0
+        var dirsCreated = 0
+
+        /** A progress sample. */
+        private data class Point(val time: Long, val progress: Double)
+
+        /** Circular queue of the most recent progress samples. */
+        val points = LinkedList<Point>()
+
+        /** Records a progress sample if the latest one was recorded more than a second ago. */
+        fun addPoint() {
+            val now = SystemClock.uptimeMillis()
+            val last = points.peekLast()
+            if (last != null && now - last.time < 1000) return
+            points.addLast(Point(now, absoluteProgress))
+            // Only keep a handful of the most recent samples.
+            while (points.size > 20) points.removeFirst()
+        }
+
+        val bytesCopied: Long
+            get() = bytesCopiedInPreviousFiles + bytesCopiedInCurrentFile
+
+        val absoluteProgress: Double
+            get() = getLinear(dirsCreated, filesCopied, bytesCopied)
+
+        val absoluteTarget: Double
+            get() = getLinear(dirsRequired, filesRequired, bytesRequired)
+
+        override fun getProgress(): Double {
+            return absoluteProgress / absoluteTarget
+        }
+
+        override fun getRemainingTimeEstimate(): Long {
+            return getRemainingTimeEstimate(absoluteProgress, absoluteTarget)
+        }
+
+        fun getRemainingTimeEstimate(progress: Double, target: Double): Long {
+            val first = points.peekFirst()
+            if (first == null) return -1
+            val now = SystemClock.uptimeMillis()
+            val elapsedTime = now - first.time
+            val t: Double = elapsedTime * (target - progress) / (progress - first.progress)
+            return if (t > 0) t.toLong() else -1
+        }
+
+        override fun toString(): String {
+            return "Progress %.0f%%, %,d/%,d dirs, %,d/%,d files, %,d/%,d bytes".format(
+                progress * 100,
+                dirsCreated,
+                dirsRequired,
+                filesCopied,
+                filesRequired,
+                bytesCopied,
+                bytesRequired
+            )
+        }
+
+        companion object {
+            /**
+             * Gets a linear approximation of the time taken to create the given number of
+             * directories, create the given number of files and write the given number of bytes.
+             * The unit of measure of the returned value is the time taken to write one byte.
+             *
+             * The constants used in this formula have been empirically determined to
+             * approximate a smooth progress tracking with a test device. The time taken to
+             * create an empty file and open it for writing matches the time taken to transfer
+             * 2.9e6 bytes. The time taken to create a directory matches the time taken to
+             * transfer 2.0e7 bytes.
+             */
+            private fun getLinear(dirs: Int, files: Int, bytes: Long): Double {
+                return bytes.toDouble() + 2.9e6 * files + 2.0e7 * dirs
+            }
+        }
+    }
+
+    companion object {
+        private const val TAG = "UnpackJob"
+    }
+}
diff --git a/src/com/android/documentsui/sidebar/AppItem.java b/src/com/android/documentsui/sidebar/AppItem.java
index b72e4041c..e1f143a38 100644
--- a/src/com/android/documentsui/sidebar/AppItem.java
+++ b/src/com/android/documentsui/sidebar/AppItem.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.sidebar;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Intent;
 import android.content.pm.ActivityInfo;
@@ -45,7 +46,7 @@ public class AppItem extends Item {
     private final ActionHandler mActionHandler;
 
     public AppItem(ResolveInfo info, String title, UserId userId, ActionHandler actionHandler) {
-        this(R.layout.item_root, info, title, userId, actionHandler);
+        this(getRes(R.layout.item_root), info, title, userId, actionHandler);
     }
 
     public AppItem(
@@ -78,9 +79,10 @@ public class AppItem extends Item {
         actionIconArea.setVisibility(View.VISIBLE);
         actionIconArea.setFocusable(false);
         actionIcon.setImageDrawable(
-                IconUtils.applyTintColor(actionIcon.getContext(), R.drawable.ic_exit_to_app,
-                        R.color.item_action_icon));
-
+                IconUtils.applyTintColor(
+                        actionIcon.getContext(),
+                        getRes(R.drawable.ic_exit_to_app),
+                        getRes(R.color.item_action_icon)));
     }
 
     @Override
@@ -103,8 +105,9 @@ public class AppItem extends Item {
         // When use_material3 flag is ON, we don't show action icon for the app items, do nothing
         // here because the icons are hidden by default.
         if (!isUseMaterial3FlagEnabled()) {
-            final View actionIconArea = convertView.findViewById(R.id.action_icon_area);
-            final ImageView actionIcon = (ImageView) convertView.findViewById(R.id.action_icon);
+            final View actionIconArea = convertView.findViewById(getRes(R.id.action_icon_area));
+            final ImageView actionIcon =
+                    (ImageView) convertView.findViewById(getRes(R.id.action_icon));
             bindActionIcon(actionIconArea, actionIcon);
         }
 
diff --git a/src/com/android/documentsui/sidebar/HeaderItem.java b/src/com/android/documentsui/sidebar/HeaderItem.java
index 1d9bddc8e..47a830b10 100644
--- a/src/com/android/documentsui/sidebar/HeaderItem.java
+++ b/src/com/android/documentsui/sidebar/HeaderItem.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.sidebar;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.util.Log;
 import android.view.View;
@@ -34,7 +35,7 @@ class HeaderItem extends Item {
     private static final String STRING_ID = "HeaderItem";
 
     HeaderItem(String title) {
-        super(R.layout.item_root_header, title, STRING_ID, UserId.UNSPECIFIED_USER);
+        super(getRes(R.layout.item_root_header), title, STRING_ID, UserId.UNSPECIFIED_USER);
     }
 
     @Override
diff --git a/src/com/android/documentsui/sidebar/Item.java b/src/com/android/documentsui/sidebar/Item.java
index 84f990f5f..c38a53f44 100644
--- a/src/com/android/documentsui/sidebar/Item.java
+++ b/src/com/android/documentsui/sidebar/Item.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.sidebar;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.view.DragEvent;
 import android.view.LayoutInflater;
 import android.view.Menu;
@@ -50,11 +52,11 @@ public abstract class Item {
 
     public View getView(View convertView, ViewGroup parent) {
         if (convertView == null
-                || (Integer) convertView.getTag(R.id.layout_id_tag) != mLayoutId) {
+                || (Integer) convertView.getTag(getRes(R.id.layout_id_tag)) != mLayoutId) {
             convertView = LayoutInflater.from(parent.getContext())
                     .inflate(mLayoutId, parent, false);
         }
-        convertView.setTag(R.id.layout_id_tag, mLayoutId);
+        convertView.setTag(getRes(R.id.layout_id_tag), mLayoutId);
         bindView(convertView);
         return convertView;
     }
diff --git a/src/com/android/documentsui/sidebar/NavRailAppItem.java b/src/com/android/documentsui/sidebar/NavRailAppItem.java
index befddf0aa..847ee4bbe 100644
--- a/src/com/android/documentsui/sidebar/NavRailAppItem.java
+++ b/src/com/android/documentsui/sidebar/NavRailAppItem.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.sidebar;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.pm.ResolveInfo;
 import android.view.View;
 import android.widget.ImageView;
@@ -32,7 +34,7 @@ public class NavRailAppItem extends AppItem {
 
     public NavRailAppItem(
             ResolveInfo info, String title, UserId userId, ActionHandler actionHandler) {
-        super(R.layout.nav_rail_item_root, info, title, userId, actionHandler);
+        super(getRes(R.layout.nav_rail_item_root), info, title, userId, actionHandler);
     }
 
     @Override
@@ -45,4 +47,13 @@ public class NavRailAppItem extends AppItem {
 
         bindIcon(icon);
     }
+
+    @Override
+    public String toString() {
+        return "NavRailAppItem{"
+                + "id=" + stringId
+                + ", userId=" + userId
+                + ", resolveInfo=" + info
+                + "}";
+    }
 }
diff --git a/src/com/android/documentsui/sidebar/NavRailProfileItem.java b/src/com/android/documentsui/sidebar/NavRailProfileItem.java
index fe69c286f..35a55b7fc 100644
--- a/src/com/android/documentsui/sidebar/NavRailProfileItem.java
+++ b/src/com/android/documentsui/sidebar/NavRailProfileItem.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.sidebar;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.pm.ResolveInfo;
 import android.view.View;
 import android.widget.ImageView;
@@ -24,14 +26,13 @@ import android.widget.TextView;
 import com.android.documentsui.ActionHandler;
 import com.android.documentsui.R;
 
-
 /**
  * Similar to {@link ProfileItem} but only used in the navigation rail.
  */
 public class NavRailProfileItem extends ProfileItem {
 
     public NavRailProfileItem(ResolveInfo info, String title, ActionHandler actionHandler) {
-        super(R.layout.nav_rail_item_root, info, title, actionHandler);
+        super(getRes(R.layout.nav_rail_item_root), info, title, actionHandler);
     }
 
     @Override
@@ -44,4 +45,13 @@ public class NavRailProfileItem extends ProfileItem {
 
         bindIcon(icon);
     }
+
+    @Override
+    public String toString() {
+        return "NavRailProfileItem{"
+                + "id=" + stringId
+                + ", userId=" + userId
+                + ", resolveInfo=" + info
+                + "}";
+    }
 }
diff --git a/src/com/android/documentsui/sidebar/NavRailRootAndAppItem.java b/src/com/android/documentsui/sidebar/NavRailRootAndAppItem.java
index 1bcc42f5c..7209bac66 100644
--- a/src/com/android/documentsui/sidebar/NavRailRootAndAppItem.java
+++ b/src/com/android/documentsui/sidebar/NavRailRootAndAppItem.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.sidebar;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.pm.ResolveInfo;
 import android.view.View;
 
@@ -30,11 +32,22 @@ public class NavRailRootAndAppItem extends RootAndAppItem {
 
     public NavRailRootAndAppItem(
             RootInfo root, ResolveInfo info, ActionHandler actionHandler, boolean maybeShowBadge) {
-        super(R.layout.nav_rail_item_root, root, info, actionHandler, maybeShowBadge);
+        super(getRes(R.layout.nav_rail_item_root), root, info, actionHandler, maybeShowBadge);
     }
 
     @Override
     public void bindView(View convertView) {
         bindIconAndTitle(convertView);
     }
+
+    @Override
+    public String toString() {
+        return "NavRailRootAndAppItem{"
+                + "id=" + stringId
+                + ", userId=" + userId
+                + ", root=" + root
+                + ", resolveInfo=" + resolveInfo
+                + ", docInfo=" + docInfo
+                + "}";
+    }
 }
diff --git a/src/com/android/documentsui/sidebar/NavRailRootItem.java b/src/com/android/documentsui/sidebar/NavRailRootItem.java
index 3d4042f22..13d05b3a3 100644
--- a/src/com/android/documentsui/sidebar/NavRailRootItem.java
+++ b/src/com/android/documentsui/sidebar/NavRailRootItem.java
@@ -16,12 +16,14 @@
 
 package com.android.documentsui.sidebar;
 
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.view.View;
 
 import com.android.documentsui.ActionHandler;
 import com.android.documentsui.R;
 import com.android.documentsui.base.RootInfo;
+import com.android.documentsui.base.UserId;
 
 /**
  * Similar to {@link RootItem} but only used in the navigation rail.
@@ -30,7 +32,7 @@ public class NavRailRootItem extends RootItem {
 
     public NavRailRootItem(RootInfo root, ActionHandler actionHandler, boolean maybeShowBadge) {
         super(
-                R.layout.nav_rail_item_root,
+                getRes(R.layout.nav_rail_item_root),
                 root,
                 actionHandler,
                 "" /* packageName */,
@@ -42,11 +44,36 @@ public class NavRailRootItem extends RootItem {
             ActionHandler actionHandler,
             String packageName,
             boolean maybeShowBadge) {
-        super(R.layout.nav_rail_item_root, root, actionHandler, packageName, maybeShowBadge);
+        super(
+                getRes(R.layout.nav_rail_item_root),
+                root,
+                actionHandler,
+                packageName,
+                maybeShowBadge);
     }
 
     @Override
     public void bindView(View convertView) {
         bindIconAndTitle(convertView);
     }
+
+    @Override
+    public String toString() {
+        return "NavRailRootItem{"
+                + "id=" + stringId
+                + ", userId=" + userId
+                + ", root=" + root
+                + ", docInfo=" + docInfo
+                + "}";
+    }
+
+    /**
+     * Creates a stub root item for a user. A stub root item is used as a place holder when
+     * there is no such root available. We can therefore show the item on the UI.
+     */
+    public static NavRailRootItem createStubItem(NavRailRootItem item, UserId targetUser) {
+        RootInfo stubRootInfo = RootInfo.copyRootInfo(item.root);
+        stubRootInfo.userId = targetUser;
+        return new NavRailRootItem(stubRootInfo, item.mActionHandler, item.mMaybeShowBadge);
+    }
 }
diff --git a/src/com/android/documentsui/sidebar/ProfileItem.java b/src/com/android/documentsui/sidebar/ProfileItem.java
index 779f54445..0325a1c4e 100644
--- a/src/com/android/documentsui/sidebar/ProfileItem.java
+++ b/src/com/android/documentsui/sidebar/ProfileItem.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.sidebar;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.pm.ResolveInfo;
 import android.view.View;
 import android.widget.ImageView;
@@ -41,7 +43,7 @@ class ProfileItem extends AppItem {
 
     @Override
     protected void bindIcon(ImageView icon) {
-        icon.setImageResource(com.android.documentsui.R.drawable.ic_user_profile);
+        icon.setImageResource(getRes(com.android.documentsui.R.drawable.ic_user_profile));
     }
 
     @Override
diff --git a/src/com/android/documentsui/sidebar/RootAndAppItem.java b/src/com/android/documentsui/sidebar/RootAndAppItem.java
index 8861f6058..30ca7eab5 100644
--- a/src/com/android/documentsui/sidebar/RootAndAppItem.java
+++ b/src/com/android/documentsui/sidebar/RootAndAppItem.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.sidebar;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.content.pm.ResolveInfo;
 import android.provider.DocumentsProvider;
@@ -38,7 +40,7 @@ class RootAndAppItem extends RootItem {
 
     RootAndAppItem(
             RootInfo root, ResolveInfo info, ActionHandler actionHandler, boolean maybeShowBadge) {
-        this(R.layout.item_root, root, info, actionHandler, maybeShowBadge);
+        this(getRes(R.layout.item_root), root, info, actionHandler, maybeShowBadge);
     }
 
     RootAndAppItem(
@@ -62,10 +64,13 @@ class RootAndAppItem extends RootItem {
         final Context context = convertView.getContext();
 
         String contentDescription =
-                context.getResources().getString(
-                        R.string.open_external_app, userId.getUserBadgedLabel(context, root.title));
+                context.getResources()
+                        .getString(
+                                getRes(R.string.open_external_app),
+                                userId.getUserBadgedLabel(context, root.title));
 
-        bindAction(convertView, View.VISIBLE, R.drawable.ic_exit_to_app, contentDescription);
+        bindAction(
+                convertView, View.VISIBLE, getRes(R.drawable.ic_exit_to_app), contentDescription);
         bindIconAndTitle(convertView);
         bindSummary(convertView, root.summary);
     }
diff --git a/src/com/android/documentsui/sidebar/RootItem.java b/src/com/android/documentsui/sidebar/RootItem.java
index af72a5239..4754d76d3 100644
--- a/src/com/android/documentsui/sidebar/RootItem.java
+++ b/src/com/android/documentsui/sidebar/RootItem.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.sidebar;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.Context;
 import android.graphics.drawable.Drawable;
@@ -65,7 +66,7 @@ public class RootItem extends Item {
 
     public RootItem(RootInfo root, ActionHandler actionHandler, String packageName,
             boolean maybeShowBadge) {
-        this(R.layout.item_root, root, actionHandler, packageName, maybeShowBadge);
+        this(getRes(R.layout.item_root), root, actionHandler, packageName, maybeShowBadge);
     }
 
     public RootItem(
@@ -93,7 +94,10 @@ public class RootItem extends Item {
     public void bindView(View convertView) {
         final Context context = convertView.getContext();
         if (root.supportsEject()) {
-            bindAction(convertView, View.VISIBLE, R.drawable.ic_eject,
+            bindAction(
+                    convertView,
+                    View.VISIBLE,
+                    getRes(R.drawable.ic_eject),
                     context.getResources().getString(R.string.menu_eject_root));
         } else {
             bindAction(convertView, View.GONE, -1 /* iconResource */, null /* description */);
@@ -101,8 +105,10 @@ public class RootItem extends Item {
         // Show available space if no summary
         String summaryText = root.summary;
         if (TextUtils.isEmpty(summaryText) && root.availableBytes >= 0) {
-            summaryText = context.getString(R.string.root_available_bytes,
-                    Formatter.formatFileSize(context, root.availableBytes));
+            summaryText =
+                    context.getString(
+                            getRes(R.string.root_available_bytes),
+                            Formatter.formatFileSize(context, root.availableBytes));
         }
 
         bindIconAndTitle(convertView);
@@ -111,7 +117,7 @@ public class RootItem extends Item {
 
     protected final void bindAction(View view, int visibility, int iconId, String description) {
         if (isUseMaterial3FlagEnabled()) {
-            final MaterialButton actionIcon = view.findViewById(R.id.action_icon);
+            final MaterialButton actionIcon = view.findViewById(getRes(R.id.action_icon));
 
             actionIcon.setVisibility(visibility);
             actionIcon.setOnClickListener(visibility == View.VISIBLE ? this::onActionClick : null);
@@ -124,9 +130,9 @@ public class RootItem extends Item {
                 actionIcon.setIconResource(iconId);
             }
         } else {
-            final ImageView actionIcon = (ImageView) view.findViewById(R.id.action_icon);
-            final View verticalDivider = view.findViewById(R.id.vertical_divider);
-            final View actionIconArea = view.findViewById(R.id.action_icon_area);
+            final ImageView actionIcon = (ImageView) view.findViewById(getRes(R.id.action_icon));
+            final View verticalDivider = view.findViewById(getRes(R.id.vertical_divider));
+            final View actionIconArea = view.findViewById(getRes(R.id.action_icon_area));
 
             verticalDivider.setVisibility(visibility);
             actionIconArea.setVisibility(visibility);
@@ -138,7 +144,7 @@ public class RootItem extends Item {
             if (iconId > 0) {
                 actionIcon.setImageDrawable(
                         IconUtils.applyTintColor(
-                                view.getContext(), iconId, R.color.item_action_icon));
+                                view.getContext(), iconId, getRes(R.color.item_action_icon)));
             }
         }
     }
@@ -155,7 +161,9 @@ public class RootItem extends Item {
         MaterialButton actionIcon = (MaterialButton) view;
         if (hasFocus) {
             final int focusRingWidth =
-                    actionIcon.getResources().getDimensionPixelSize(R.dimen.focus_ring_width);
+                    actionIcon
+                            .getResources()
+                            .getDimensionPixelSize(getRes(R.dimen.focus_ring_width));
             actionIcon.setStrokeWidth(focusRingWidth);
         } else {
             actionIcon.setStrokeWidth(0);
@@ -215,7 +223,7 @@ public class RootItem extends Item {
 
     @Override
     void createContextMenu(Menu menu, MenuInflater inflater, MenuManager menuManager) {
-        inflater.inflate(R.menu.root_context_menu, menu);
+        inflater.inflate(getRes(R.menu.root_context_menu), menu);
         menuManager.updateRootContextMenu(menu, root, docInfo);
     }
 
diff --git a/src/com/android/documentsui/sidebar/RootItemListBuilder.java b/src/com/android/documentsui/sidebar/RootItemListBuilder.java
index b29bd0d87..cfcc4fdea 100644
--- a/src/com/android/documentsui/sidebar/RootItemListBuilder.java
+++ b/src/com/android/documentsui/sidebar/RootItemListBuilder.java
@@ -18,6 +18,8 @@ package com.android.documentsui.sidebar;
 
 import static androidx.core.util.Preconditions.checkNotNull;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import com.android.documentsui.base.UserId;
 
 import com.google.common.collect.ArrayListMultimap;
@@ -96,6 +98,16 @@ class RootItemListBuilder {
             }
         }
 
-        return Collections.singletonList(RootItem.createStubItem(testRootItem, mSelectedUser));
+        final RootItem stubItem;
+        // When use_material3 flag is ON, a sub class of RootItem is introduced: NavRailRootItem,
+        // which has different underlying layout, so for NavRailRootItem we need to call its own
+        // static method to create stub item.
+        if (isUseMaterial3FlagEnabled() && testRootItem instanceof NavRailRootItem) {
+            stubItem =
+                    NavRailRootItem.createStubItem((NavRailRootItem) testRootItem, mSelectedUser);
+        } else {
+            stubItem = RootItem.createStubItem(testRootItem, mSelectedUser);
+        }
+        return Collections.singletonList(stubItem);
     }
 }
diff --git a/src/com/android/documentsui/sidebar/RootItemView.java b/src/com/android/documentsui/sidebar/RootItemView.java
index 5700f9dd1..2ec6823a6 100644
--- a/src/com/android/documentsui/sidebar/RootItemView.java
+++ b/src/com/android/documentsui/sidebar/RootItemView.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.sidebar;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
 import android.util.AttributeSet;
 import android.widget.LinearLayout;
@@ -23,20 +25,20 @@ import android.widget.LinearLayout;
 import com.android.documentsui.R;
 
 public final class RootItemView extends LinearLayout {
-    private static final int[] STATE_HIGHLIGHTED = {R.attr.state_highlighted};
+    private final int[] mStateHighlighted;
 
     private boolean mHighlighted = false;
 
     public RootItemView(Context context, AttributeSet attrs) {
         super(context, attrs);
+        mStateHighlighted = new int[] {getRes(R.attr.state_highlighted)};
     }
 
     @Override
     public int[] onCreateDrawableState(int extraSpace) {
         final int[] drawableState = super.onCreateDrawableState(extraSpace + 1);
-
         if (mHighlighted) {
-            mergeDrawableStates(drawableState, STATE_HIGHLIGHTED);
+            mergeDrawableStates(drawableState, mStateHighlighted);
         }
 
         return drawableState;
diff --git a/src/com/android/documentsui/sidebar/RootsAdapter.java b/src/com/android/documentsui/sidebar/RootsAdapter.java
index d689705be..df970be6a 100644
--- a/src/com/android/documentsui/sidebar/RootsAdapter.java
+++ b/src/com/android/documentsui/sidebar/RootsAdapter.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.sidebar;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Activity;
 import android.os.Looper;
@@ -97,10 +98,10 @@ class RootsAdapter extends ArrayAdapter<Item> {
         }
 
         if (item.isRoot()) {
-            view.setTag(R.id.item_position_tag, position);
+            view.setTag(getRes(R.id.item_position_tag), position);
             view.setOnDragListener(mDragListener);
         } else {
-            view.setTag(R.id.item_position_tag, null);
+            view.setTag(getRes(R.id.item_position_tag), null);
             view.setOnDragListener(null);
         }
         return view;
diff --git a/src/com/android/documentsui/sidebar/RootsFragment.java b/src/com/android/documentsui/sidebar/RootsFragment.java
index 1735f9a29..94ae925ed 100644
--- a/src/com/android/documentsui/sidebar/RootsFragment.java
+++ b/src/com/android/documentsui/sidebar/RootsFragment.java
@@ -19,8 +19,8 @@ package com.android.documentsui.sidebar;
 import static com.android.documentsui.base.Shared.compareToIgnoreCaseNullable;
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.base.SharedMinimal.VERBOSE;
-import static com.android.documentsui.util.FlagUtils.isHideRootsOnDesktopFlagEnabled;
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.Context;
@@ -31,6 +31,7 @@ import android.graphics.Color;
 import android.graphics.drawable.ColorDrawable;
 import android.os.Build;
 import android.os.Bundle;
+import android.os.UserManager;
 import android.os.ext.SdkExtensions;
 import android.provider.DocumentsContract;
 import android.provider.MediaStore;
@@ -157,7 +158,7 @@ public class RootsFragment extends Fragment {
      * Show the RootsFragment inside the navigation drawer container.
      */
     public static RootsFragment show(FragmentManager fm, boolean includeApps, Intent intent) {
-        return showWithLayout(R.id.container_roots, fm, includeApps, intent);
+        return showWithLayout(getRes(R.id.container_roots), fm, includeApps, intent);
     }
 
     /**
@@ -165,7 +166,7 @@ public class RootsFragment extends Fragment {
      */
     public static RootsFragment showNavRail(FragmentManager fm, boolean includeApps,
             Intent intent) {
-        return showWithLayout(R.id.nav_rail_container_roots, fm, includeApps, intent);
+        return showWithLayout(getRes(R.id.nav_rail_container_roots), fm, includeApps, intent);
     }
 
     /**
@@ -201,14 +202,14 @@ public class RootsFragment extends Fragment {
      * Get the RootsFragment instance for the navigation drawer.
      */
     public static RootsFragment get(FragmentManager fm) {
-        return (RootsFragment) fm.findFragmentById(R.id.container_roots);
+        return (RootsFragment) fm.findFragmentById(getRes(R.id.container_roots));
     }
 
     /**
      * Get the RootsFragment instance for the navigation drawer.
      */
     public static RootsFragment getNavRail(FragmentManager fm) {
-        return (RootsFragment) fm.findFragmentById(R.id.nav_rail_container_roots);
+        return (RootsFragment) fm.findFragmentById(getRes(R.id.nav_rail_container_roots));
     }
 
     @Override
@@ -219,7 +220,7 @@ public class RootsFragment extends Fragment {
             mUseRailAsContainer =
                     getArguments() != null
                             && getArguments().getInt(EXTRA_CONTAINER_ID)
-                                    == R.id.nav_rail_container_roots;
+                                    == getRes(R.id.nav_rail_container_roots);
         }
 
         mInjector = getBaseActivity().getInjector();
@@ -227,11 +228,11 @@ public class RootsFragment extends Fragment {
         final View view =
                 inflater.inflate(
                         mUseRailAsContainer
-                                ? R.layout.fragment_nav_rail_roots
-                                : R.layout.fragment_roots,
+                                ? getRes(R.layout.fragment_nav_rail_roots)
+                                : getRes(R.layout.fragment_roots),
                         container,
                         false);
-        mList = (ListView) view.findViewById(R.id.roots_list);
+        mList = (ListView) view.findViewById(getRes(R.id.roots_list));
         mList.setOnItemClickListener(mItemListener);
         // ListView does not have right-click specific listeners, so we will have a
         // GenericMotionListener to listen for it.
@@ -243,7 +244,7 @@ public class RootsFragment extends Fragment {
                 new OnGenericMotionListener() {
                     @Override
                     public boolean onGenericMotion(View v, MotionEvent event) {
-                        if (Events.isMouseEvent(event)
+                        if (Events.isMousyEvent(event)
                                 && event.getButtonState() == MotionEvent.BUTTON_SECONDARY) {
                             int x = (int) event.getX();
                             int y = (int) event.getY();
@@ -475,20 +476,20 @@ public class RootsFragment extends Fragment {
         final RootItemListBuilder storageProvidersBuilder = new RootItemListBuilder(selectedUser,
                 userIds);
         final List<RootItem> otherProviders = new ArrayList<>();
+        final boolean hideMediaRoots =
+                isUseMaterial3FlagEnabled()
+                        && !context.getResources().getBoolean(R.bool.show_media_roots);
 
         for (final RootInfo root : roots) {
             final RootItem item;
 
             if (root.isExternalStorageHome()) {
-                continue;
-            } else if (isHideRootsOnDesktopFlagEnabled()
-                    && context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_PC)
+                // No-op.
+            } else if (hideMediaRoots
                     && (root.isImages() || root.isVideos()
                     || root.isDocuments()
                     || root.isAudio())) {
-                // Hide Images/Videos/Documents/Audio roots on desktop.
                 Log.d(TAG, "Hiding " + root);
-                continue;
             } else if (root.isLibrary() || root.isDownloads()) {
                 item =
                         mUseRailAsContainer
@@ -573,16 +574,22 @@ public class RootsFragment extends Fragment {
     private List<Item> getPresentableListPrivateSpaceEnabled(Context context, State state,
             List<List<Item>> rootListAllUsers, List<UserId> userIds,
             UserManagerState userManagerState) {
-        return new UserItemsCombiner(context.getResources(),
-                context.getSystemService(DevicePolicyManager.class), state)
+        return new UserItemsCombiner(
+                        context.getResources(),
+                        context.getSystemService(UserManager.class),
+                        context.getSystemService(DevicePolicyManager.class),
+                        state)
                 .setRootListForAllUsers(rootListAllUsers)
                 .createPresentableListForAllUsers(userIds, userManagerState.getUserIdToLabelMap());
     }
 
     private List<Item> getPresentableListPrivateSpaceDisabled(Context context, State state,
             List<Item> rootList, List<Item> rootListOtherUser) {
-        return new UserItemsCombiner(context.getResources(),
-                context.getSystemService(DevicePolicyManager.class), state)
+        return new UserItemsCombiner(
+                        context.getResources(),
+                        context.getSystemService(UserManager.class),
+                        context.getSystemService(DevicePolicyManager.class),
+                        state)
                 .setRootListForCurrentUser(rootList)
                 .setRootListForOtherUser(rootListOtherUser)
                 .createPresentableList();
@@ -710,8 +717,8 @@ public class RootsFragment extends Fragment {
             }
         }
 
-        final String preferredRootPackage = getResources().getString(
-                R.string.preferred_root_package, "");
+        final String preferredRootPackage =
+                getResources().getString(getRes(R.string.preferred_root_package), "");
         final ItemComparator comp = new ItemComparator(preferredRootPackage);
 
         if (state.configStore.isPrivateSpaceInDocsUIEnabled()) {
@@ -852,17 +859,18 @@ public class RootsFragment extends Fragment {
         }
         final RootItem rootItem = (RootItem) mAdapter.getItem(adapterMenuInfo.position);
         final int id = item.getItemId();
-        if (id == R.id.root_menu_eject_root) {
-            final View ejectIcon = adapterMenuInfo.targetView.findViewById(R.id.action_icon);
+        if (id == getRes(R.id.root_menu_eject_root)) {
+            final View ejectIcon =
+                    adapterMenuInfo.targetView.findViewById(getRes(R.id.action_icon));
             ejectClicked(ejectIcon, rootItem.root, mActionHandler);
             return true;
-        } else if (id == R.id.root_menu_open_in_new_window) {
+        } else if (id == getRes(R.id.root_menu_open_in_new_window)) {
             mActionHandler.openInNewWindow(new DocumentStack(rootItem.root));
             return true;
-        } else if (id == R.id.root_menu_paste_into_folder) {
+        } else if (id == getRes(R.id.root_menu_paste_into_folder)) {
             mActionHandler.pasteIntoFolder(rootItem.root);
             return true;
-        } else if (id == R.id.root_menu_settings) {
+        } else if (id == getRes(R.id.root_menu_settings)) {
             mActionHandler.openSettings(rootItem.root);
             return true;
         }
@@ -884,7 +892,7 @@ public class RootsFragment extends Fragment {
     }
 
     private Item getItem(View v) {
-        final int pos = (Integer) v.getTag(R.id.item_position_tag);
+        final int pos = (Integer) v.getTag(getRes(R.id.item_position_tag));
         return mAdapter.getItem(pos);
     }
 
diff --git a/src/com/android/documentsui/sidebar/SpacerItem.java b/src/com/android/documentsui/sidebar/SpacerItem.java
index 44dd75cbb..8397c4e05 100644
--- a/src/com/android/documentsui/sidebar/SpacerItem.java
+++ b/src/com/android/documentsui/sidebar/SpacerItem.java
@@ -17,6 +17,8 @@
 package com.android.documentsui.sidebar;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.util.Log;
 import android.view.View;
@@ -34,12 +36,20 @@ class SpacerItem extends Item {
 
     public SpacerItem() {
         // Multiple spacer items can share the same string id as they're identical.
-        super(R.layout.item_root_spacer, "" /* title */, STRING_ID, UserId.UNSPECIFIED_USER);
+        super(
+                getRes(R.layout.item_root_spacer),
+                "" /* title */,
+                STRING_ID,
+                UserId.UNSPECIFIED_USER);
     }
 
     @Override
     void bindView(View convertView) {
         // Nothing to bind
+        if (isUseMaterial3FlagEnabled()) {
+            // Let TalkBack ignore the spacer item.
+            convertView.setImportantForAccessibility(View.IMPORTANT_FOR_ACCESSIBILITY_NO);
+        }
     }
 
     @Override
diff --git a/src/com/android/documentsui/sidebar/UserItemsCombiner.java b/src/com/android/documentsui/sidebar/UserItemsCombiner.java
index 564a51127..081fd785d 100644
--- a/src/com/android/documentsui/sidebar/UserItemsCombiner.java
+++ b/src/com/android/documentsui/sidebar/UserItemsCombiner.java
@@ -21,10 +21,12 @@ import static androidx.core.util.Preconditions.checkNotNull;
 
 import static com.android.documentsui.DevicePolicyResources.Strings.PERSONAL_TAB;
 import static com.android.documentsui.DevicePolicyResources.Strings.WORK_TAB;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.res.Resources;
 import android.os.Build;
+import android.os.UserManager;
 
 import androidx.annotation.RequiresApi;
 import androidx.annotation.VisibleForTesting;
@@ -46,14 +48,17 @@ class UserItemsCombiner {
 
     private UserId mCurrentUser;
     private final Resources mResources;
+    private final UserManager mUserManager;
     private final DevicePolicyManager mDpm;
     private final State mState;
     private List<Item> mRootList;
     private List<Item> mRootListOtherUser;
     private List<List<Item>> mRootListAllUsers;
 
-    UserItemsCombiner(Resources resources, DevicePolicyManager dpm, State state) {
+    UserItemsCombiner(
+            Resources resources, UserManager userManager, DevicePolicyManager dpm, State state) {
         mCurrentUser = UserId.CURRENT_USER;
+        mUserManager = userManager;
         mResources = checkNotNull(resources);
         mDpm = dpm;
         mState = checkNotNull(state);
@@ -94,17 +99,20 @@ class UserItemsCombiner {
                 // Identify personal and work root list.
                 final List<Item> personalRootList;
                 final List<Item> workRootList;
-                if (mCurrentUser.isSystem()) {
-                    personalRootList = mRootList;
-                    workRootList = mRootListOtherUser;
-                } else {
+
+                if (mCurrentUser.isManagedProfile(mUserManager)) {
                     personalRootList = mRootListOtherUser;
                     workRootList = mRootList;
+                } else {
+                    personalRootList = mRootList;
+                    workRootList = mRootListOtherUser;
                 }
-                result.add(new HeaderItem(getEnterpriseString(
-                        PERSONAL_TAB, R.string.personal_tab)));
+                result.add(
+                        new HeaderItem(
+                                getEnterpriseString(PERSONAL_TAB, getRes(R.string.personal_tab))));
                 result.addAll(personalRootList);
-                result.add(new HeaderItem(getEnterpriseString(WORK_TAB, R.string.work_tab)));
+                result.add(
+                        new HeaderItem(getEnterpriseString(WORK_TAB, getRes(R.string.work_tab))));
                 result.addAll(workRootList);
             } else {
                 result.addAll(mRootList);
diff --git a/src/com/android/documentsui/sorting/HeaderCell.java b/src/com/android/documentsui/sorting/HeaderCell.java
index 7f72f13da..8f5040bf8 100644
--- a/src/com/android/documentsui/sorting/HeaderCell.java
+++ b/src/com/android/documentsui/sorting/HeaderCell.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.sorting;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.animation.AnimatorInflater;
 import android.animation.LayoutTransition;
@@ -62,7 +63,7 @@ public class HeaderCell extends LinearLayout {
         setVisibility(dimension.getVisibility());
 
         if (dimension.getVisibility() == View.VISIBLE) {
-            TextView label = findViewById(R.id.label);
+            TextView label = findViewById(getRes(R.id.label));
             label.setText(dimension.getLabelId());
             switch (dimension.getDataType()) {
                 case SortDimension.DATA_TYPE_NUMBER:
@@ -77,7 +78,7 @@ public class HeaderCell extends LinearLayout {
             }
 
             if (mCurDirection != dimension.getSortDirection()) {
-                ImageView arrow = findViewById(R.id.sort_arrow);
+                ImageView arrow = findViewById(getRes(R.id.sort_arrow));
                 switch (dimension.getSortDirection()) {
                     case SortDimension.SORT_DIRECTION_NONE:
                         arrow.setVisibility(View.GONE);
@@ -86,13 +87,13 @@ public class HeaderCell extends LinearLayout {
                         showArrow(
                                 arrow,
                                 R.animator.arrow_rotate_up,
-                                R.string.sort_direction_ascending);
+                                getRes(R.string.sort_direction_ascending));
                         break;
                     case SortDimension.SORT_DIRECTION_DESCENDING:
                         showArrow(
                                 arrow,
                                 R.animator.arrow_rotate_down,
-                                R.string.sort_direction_descending);
+                                getRes(R.string.sort_direction_descending));
                         break;
                     default:
                         throw new IllegalArgumentException(
@@ -114,7 +115,7 @@ public class HeaderCell extends LinearLayout {
             View.OnClickListener clickListener,
             View.OnKeyListener keyListener,
             SortDimension dimension) {
-        ImageView arrow = findViewById(R.id.sort_arrow);
+        ImageView arrow = findViewById(getRes(R.id.sort_arrow));
         arrow.setTag(dimension);
         arrow.setOnKeyListener(keyListener);
         arrow.setOnClickListener(clickListener);
diff --git a/src/com/android/documentsui/sorting/SortController.java b/src/com/android/documentsui/sorting/SortController.java
index 4fc28448d..f5e102cc7 100644
--- a/src/com/android/documentsui/sorting/SortController.java
+++ b/src/com/android/documentsui/sorting/SortController.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.sorting;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.view.View;
 
 import androidx.annotation.Nullable;
@@ -84,8 +86,10 @@ public final class SortController {
             }
         });
 
-        SortController controller = new SortController(
-                TableHeaderController.create(sortModel, activity.findViewById(R.id.table_header)));
+        SortController controller =
+                new SortController(
+                        TableHeaderController.create(
+                                sortModel, activity.findViewById(getRes(R.id.table_header))));
 
         controller.onViewModeChanged(initialMode);
         return controller;
diff --git a/src/com/android/documentsui/sorting/SortListFragment.java b/src/com/android/documentsui/sorting/SortListFragment.java
index 8d4032c9e..a7d6b646a 100644
--- a/src/com/android/documentsui/sorting/SortListFragment.java
+++ b/src/com/android/documentsui/sorting/SortListFragment.java
@@ -1,11 +1,14 @@
 package com.android.documentsui.sorting;
 
 import static com.android.documentsui.base.SharedMinimal.TAG;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Dialog;
 import android.content.Context;
 import android.os.Bundle;
 import android.util.Log;
+import android.view.KeyEvent;
 import android.view.View;
 import android.view.ViewGroup;
 import android.widget.AdapterView;
@@ -94,17 +97,21 @@ public class SortListFragment extends DialogFragment {
         boolean isAscending = direction == SortDimension.SORT_DIRECTION_ASCENDING;
         final int id = dimension.getId();
         if (id == SortModel.SORT_DIMENSION_ID_TITLE) {
-            return isAscending ? R.string.sort_dimension_name_ascending :
-                    R.string.sort_dimension_name_descending;
+            return isAscending
+                    ? getRes(R.string.sort_dimension_name_ascending)
+                    : getRes(R.string.sort_dimension_name_descending);
         } else if (id == SortModel.SORT_DIMENSION_ID_DATE) {
-            return isAscending ? R.string.sort_dimension_date_ascending :
-                    R.string.sort_dimension_date_descending;
+            return isAscending
+                    ? getRes(R.string.sort_dimension_date_ascending)
+                    : getRes(R.string.sort_dimension_date_descending);
         } else if (id == SortModel.SORT_DIMENSION_ID_FILE_TYPE) {
-            return isAscending ? R.string.sort_dimension_file_type_ascending :
-                    R.string.sort_dimension_file_type_descending;
+            return isAscending
+                    ? getRes(R.string.sort_dimension_file_type_ascending)
+                    : getRes(R.string.sort_dimension_file_type_descending);
         } else if (id == SortModel.SORT_DIMENSION_ID_SIZE) {
-            return isAscending ? R.string.sort_dimension_size_ascending :
-                    R.string.sort_dimension_size_descending;
+            return isAscending
+                    ? getRes(R.string.sort_dimension_size_ascending)
+                    : getRes(R.string.sort_dimension_size_descending);
         }
         return dimension.getLabelId();
     }
@@ -121,7 +128,7 @@ public class SortListFragment extends DialogFragment {
 
         BottomSheetDialog dialog =
                 new BottomSheetDialog(getContext());
-        dialog.setContentView(R.layout.dialog_sorting);
+        dialog.setContentView(getRes(R.layout.dialog_sorting));
 
         // Workaround for solve issue about dialog not full expanded when landscape.
         FrameLayout bottomSheet = (FrameLayout)
@@ -129,10 +136,27 @@ public class SortListFragment extends DialogFragment {
         BottomSheetBehavior.from(bottomSheet)
                 .setState(BottomSheetBehavior.STATE_EXPANDED);
 
-        ListView listView = dialog.findViewById(R.id.sorting_dialog_list);
+        ListView listView = dialog.findViewById(getRes(R.id.sorting_dialog_list));
 
         listView.setAdapter(new SortingListAdapter(getContext(), mSortingList));
-        listView.setOnItemClickListener(this::onItemClicked);
+        // When use_material flag is ON, we want to show hover effect on the list item, which
+        // requires a "clickable:true" on the item level, this attribute will ignore the list level
+        // click listener, we need to bind this click listener to the item level.
+        if (!isUseMaterial3FlagEnabled()) {
+            listView.setOnItemClickListener(this::onItemClicked);
+        } else {
+            // "clickable:true" also break the default onKey handler for behaviors like pressing
+            // Enter/Space to select, so we need to explicitly handle it here.
+            listView.setOnKeyListener(
+                    (v, keyCode, event) -> {
+                        if ((keyCode == KeyEvent.KEYCODE_ENTER || keyCode == KeyEvent.KEYCODE_SPACE)
+                                && event.getAction() == KeyEvent.ACTION_UP) {
+                            onItemClicked(null, v, listView.getSelectedItemPosition(), 0);
+                            return true;
+                        }
+                        return false;
+                    });
+        }
 
         return dialog;
     }
@@ -146,7 +170,7 @@ public class SortListFragment extends DialogFragment {
     private class SortingListAdapter extends ArrayAdapter<SortItem> {
 
         public SortingListAdapter(Context context, List<SortItem> list) {
-            super(context, R.layout.sort_list_item, list);
+            super(context, getRes(R.layout.sort_list_item), list);
         }
 
         @Override
@@ -159,6 +183,18 @@ public class SortListFragment extends DialogFragment {
             boolean selected = item.id == mModel.getSortedDimensionId()
                     && item.direction == mModel.getCurrentSortDirection();
             text.setChecked(selected);
+            // If use_material3 flag is ON, instead of using "android:checkMark" attribute in the
+            // layout file, we programmatically set the checkmark icon here. This is because the
+            // "android:checkMark" drawable acts as an icon button which has its own hover/ripple
+            // effect, and we don't want that.
+            if (isUseMaterial3FlagEnabled()) {
+                // Note "Relative" version of "setCompoundDrawable" handles RTL automatically.
+                text.setCompoundDrawablesRelativeWithIntrinsicBounds(
+                        0, 0, selected ? getRes(R.drawable.ic_done) : 0, 0);
+                // "clickable=true" on the item level makes the list level click listener stop
+                // working, we need to bind click listener on the item level.
+                text.setOnClickListener(v -> onItemClicked(null, v, position, 0));
+            }
             return view;
         }
     }
diff --git a/src/com/android/documentsui/sorting/SortModel.java b/src/com/android/documentsui/sorting/SortModel.java
index 9bf5b9666..5a418c4a9 100644
--- a/src/com/android/documentsui/sorting/SortModel.java
+++ b/src/com/android/documentsui/sorting/SortModel.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.sorting;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.content.ContentResolver;
 import android.database.Cursor;
@@ -50,9 +51,9 @@ public class SortModel implements Parcelable {
     public static final int SORT_DIMENSION_ID_UNKNOWN = 0;
     public static final int SORT_DIMENSION_ID_TITLE = android.R.id.title;
     public static final int SORT_DIMENSION_ID_SUMMARY = android.R.id.summary;
-    public static final int SORT_DIMENSION_ID_SIZE = R.id.size;
-    public static final int SORT_DIMENSION_ID_FILE_TYPE = R.id.file_type;
-    public static final int SORT_DIMENSION_ID_DATE = R.id.date;
+    public static final int SORT_DIMENSION_ID_SIZE = getRes(R.id.size);
+    public static final int SORT_DIMENSION_ID_FILE_TYPE = getRes(R.id.file_type);
+    public static final int SORT_DIMENSION_ID_DATE = getRes(R.id.date);
 
     @IntDef(flag = true, value = {
             UPDATE_TYPE_NONE,
@@ -235,15 +236,15 @@ public class SortModel implements Parcelable {
             queryArgs.putStringArray(
                     ContentResolver.QUERY_ARG_SORT_COLUMNS,
                     new String[]{Document.COLUMN_DISPLAY_NAME});
-        } else if (id == SortModel.SORT_DIMENSION_ID_DATE) {
+        } else if (id == getRes(SortModel.SORT_DIMENSION_ID_DATE)) {
             queryArgs.putStringArray(
                     ContentResolver.QUERY_ARG_SORT_COLUMNS,
                     new String[]{Document.COLUMN_LAST_MODIFIED});
-        } else if (id == SortModel.SORT_DIMENSION_ID_SIZE) {
+        } else if (id == getRes(SortModel.SORT_DIMENSION_ID_SIZE)) {
             queryArgs.putStringArray(
                     ContentResolver.QUERY_ARG_SORT_COLUMNS,
                     new String[]{Document.COLUMN_SIZE});
-        } else if (id == SortModel.SORT_DIMENSION_ID_FILE_TYPE) {
+        } else if (id == getRes(SortModel.SORT_DIMENSION_ID_FILE_TYPE)) {
             // Unfortunately sorting by mime type is pretty much guaranteed different from
             // sorting by user-friendly type, so there is no point to guide the provider to sort
             // in a particular order.
@@ -286,11 +287,11 @@ public class SortModel implements Parcelable {
             return null;
         } else if (id == SortModel.SORT_DIMENSION_ID_TITLE) {
             columnName = Document.COLUMN_DISPLAY_NAME;
-        } else if (id == SortModel.SORT_DIMENSION_ID_DATE) {
+        } else if (id == getRes(SortModel.SORT_DIMENSION_ID_DATE)) {
             columnName = Document.COLUMN_LAST_MODIFIED;
-        } else if (id == SortModel.SORT_DIMENSION_ID_SIZE) {
+        } else if (id == getRes(SortModel.SORT_DIMENSION_ID_SIZE)) {
             columnName = Document.COLUMN_SIZE;
-        } else if (id == SortModel.SORT_DIMENSION_ID_FILE_TYPE) {
+        } else if (id == getRes(SortModel.SORT_DIMENSION_ID_FILE_TYPE)) {
             // Unfortunately sorting by mime type is pretty much guaranteed different from
             // sorting by user-friendly type, so there is no point to guide the provider to sort
             // in a particular order.
@@ -437,58 +438,54 @@ public class SortModel implements Parcelable {
         SortDimension.Builder builder = new SortDimension.Builder();
 
         // Name column
-        dimensions.add(builder
-                .withId(SORT_DIMENSION_ID_TITLE)
-                .withLabelId(R.string.sort_dimension_name)
-                .withDataType(SortDimension.DATA_TYPE_STRING)
-                .withSortCapability(SortDimension.SORT_CAPABILITY_BOTH_DIRECTION)
-                .withDefaultSortDirection(SortDimension.SORT_DIRECTION_ASCENDING)
-                .withVisibility(View.VISIBLE)
-                .build()
-        );
+        dimensions.add(
+                builder.withId(SORT_DIMENSION_ID_TITLE)
+                        .withLabelId(getRes(R.string.sort_dimension_name))
+                        .withDataType(SortDimension.DATA_TYPE_STRING)
+                        .withSortCapability(SortDimension.SORT_CAPABILITY_BOTH_DIRECTION)
+                        .withDefaultSortDirection(SortDimension.SORT_DIRECTION_ASCENDING)
+                        .withVisibility(View.VISIBLE)
+                        .build());
 
         // Summary column
         // Summary is only visible in Downloads and Recents root.
-        dimensions.add(builder
-                .withId(SORT_DIMENSION_ID_SUMMARY)
-                .withLabelId(R.string.sort_dimension_summary)
-                .withDataType(SortDimension.DATA_TYPE_STRING)
-                .withSortCapability(SortDimension.SORT_CAPABILITY_NONE)
-                .withVisibility(View.INVISIBLE)
-                .build()
-        );
+        dimensions.add(
+                builder.withId(SORT_DIMENSION_ID_SUMMARY)
+                        .withLabelId(getRes(R.string.sort_dimension_summary))
+                        .withDataType(SortDimension.DATA_TYPE_STRING)
+                        .withSortCapability(SortDimension.SORT_CAPABILITY_NONE)
+                        .withVisibility(View.INVISIBLE)
+                        .build());
 
         // Size column
-        dimensions.add(builder
-                .withId(SORT_DIMENSION_ID_SIZE)
-                .withLabelId(R.string.sort_dimension_size)
-                .withDataType(SortDimension.DATA_TYPE_NUMBER)
-                .withSortCapability(SortDimension.SORT_CAPABILITY_BOTH_DIRECTION)
-                .withDefaultSortDirection(SortDimension.SORT_DIRECTION_ASCENDING)
-                .withVisibility(View.VISIBLE)
-                .build()
-        );
+        dimensions.add(
+                builder.withId(getRes(SORT_DIMENSION_ID_SIZE))
+                        .withLabelId(getRes(R.string.sort_dimension_size))
+                        .withDataType(SortDimension.DATA_TYPE_NUMBER)
+                        .withSortCapability(SortDimension.SORT_CAPABILITY_BOTH_DIRECTION)
+                        .withDefaultSortDirection(SortDimension.SORT_DIRECTION_ASCENDING)
+                        .withVisibility(View.VISIBLE)
+                        .build());
 
         // Type column
-        dimensions.add(builder
-            .withId(SORT_DIMENSION_ID_FILE_TYPE)
-            .withLabelId(R.string.sort_dimension_file_type)
-            .withDataType(SortDimension.DATA_TYPE_STRING)
-            .withSortCapability(SortDimension.SORT_CAPABILITY_BOTH_DIRECTION)
-            .withDefaultSortDirection(SortDimension.SORT_DIRECTION_ASCENDING)
-            .withVisibility(View.VISIBLE)
-            .build());
+        dimensions.add(
+                builder.withId(getRes(SORT_DIMENSION_ID_FILE_TYPE))
+                        .withLabelId(getRes(R.string.sort_dimension_file_type))
+                        .withDataType(SortDimension.DATA_TYPE_STRING)
+                        .withSortCapability(SortDimension.SORT_CAPABILITY_BOTH_DIRECTION)
+                        .withDefaultSortDirection(SortDimension.SORT_DIRECTION_ASCENDING)
+                        .withVisibility(View.VISIBLE)
+                        .build());
 
         // Date column
-        dimensions.add(builder
-                .withId(SORT_DIMENSION_ID_DATE)
-                .withLabelId(R.string.sort_dimension_date)
-                .withDataType(SortDimension.DATA_TYPE_NUMBER)
-                .withSortCapability(SortDimension.SORT_CAPABILITY_BOTH_DIRECTION)
-                .withDefaultSortDirection(SortDimension.SORT_DIRECTION_DESCENDING)
-                .withVisibility(View.VISIBLE)
-                .build()
-        );
+        dimensions.add(
+                builder.withId(getRes(SORT_DIMENSION_ID_DATE))
+                        .withLabelId(getRes(R.string.sort_dimension_date))
+                        .withDataType(SortDimension.DATA_TYPE_NUMBER)
+                        .withSortCapability(SortDimension.SORT_CAPABILITY_BOTH_DIRECTION)
+                        .withDefaultSortDirection(SortDimension.SORT_DIRECTION_DESCENDING)
+                        .withVisibility(View.VISIBLE)
+                        .build());
 
         return new SortModel(dimensions);
     }
diff --git a/src/com/android/documentsui/sorting/TableHeaderController.java b/src/com/android/documentsui/sorting/TableHeaderController.java
index fda7b2713..8cc4b18b5 100644
--- a/src/com/android/documentsui/sorting/TableHeaderController.java
+++ b/src/com/android/documentsui/sorting/TableHeaderController.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.sorting;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.view.KeyEvent;
 import android.view.View;
@@ -50,9 +51,9 @@ public final class TableHeaderController implements SortController.WidgetControl
 
         mTitleCell = tableHeader.findViewById(android.R.id.title);
         mSummaryCell = tableHeader.findViewById(android.R.id.summary);
-        mSizeCell = tableHeader.findViewById(R.id.size);
-        mFileTypeCell = tableHeader.findViewById(R.id.file_type);
-        mDateCell = tableHeader.findViewById(R.id.date);
+        mSizeCell = tableHeader.findViewById(getRes(R.id.size));
+        mFileTypeCell = tableHeader.findViewById(getRes(R.id.file_type));
+        mDateCell = tableHeader.findViewById(getRes(R.id.date));
 
         onModelUpdate(mModel, SortModel.UPDATE_TYPE_UNSPECIFIED);
 
diff --git a/src/com/android/documentsui/ui/DialogController.java b/src/com/android/documentsui/ui/DialogController.java
index 768c14e68..f9518cef5 100644
--- a/src/com/android/documentsui/ui/DialogController.java
+++ b/src/com/android/documentsui/ui/DialogController.java
@@ -15,6 +15,8 @@
  */
 package com.android.documentsui.ui;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.app.Activity;
 
 import androidx.fragment.app.FragmentManager;
@@ -101,6 +103,7 @@ public interface DialogController {
                     Snackbars.showCompress(mActivity, docCount);
                     break;
                 case FileOperationService.OPERATION_EXTRACT:
+                case FileOperationService.OPERATION_UNPACK:
                     Snackbars.showExtract(mActivity, docCount);
                     break;
                 case FileOperationService.OPERATION_DELETE:
@@ -140,13 +143,17 @@ public interface DialogController {
         public void showActionNotAllowed() {
             // Shows as a last resort when a document is not allowed to share across users
             Snackbars.makeSnackbar(
-                    mActivity, R.string.toast_action_not_allowed, Snackbar.LENGTH_LONG).show();
+                            mActivity,
+                            getRes(R.string.toast_action_not_allowed),
+                            Snackbar.LENGTH_LONG)
+                    .show();
         }
 
         @Override
         public void showNoApplicationFound() {
             Snackbars.makeSnackbar(
-                    mActivity, R.string.toast_no_application, Snackbar.LENGTH_LONG).show();
+                            mActivity, getRes(R.string.toast_no_application), Snackbar.LENGTH_LONG)
+                    .show();
         }
 
         @Override
@@ -156,8 +163,11 @@ public interface DialogController {
 
         @Override
         public void showViewInArchivesUnsupported() {
-            Snackbars.makeSnackbar(mActivity, R.string.toast_view_in_archives_unsupported,
-                    Snackbar.LENGTH_LONG).show();
+            Snackbars.makeSnackbar(
+                            mActivity,
+                            getRes(R.string.toast_view_in_archives_unsupported),
+                            Snackbar.LENGTH_LONG)
+                    .show();
         }
 
         @Override
@@ -167,7 +177,7 @@ public interface DialogController {
 
         @Override
         public void showShareOverLimit(int size) {
-            String message = mActivity.getString(R.string.toast_share_over_limit, size);
+            String message = mActivity.getString(getRes(R.string.toast_share_over_limit), size);
             Snackbars.makeSnackbar(mActivity, message, Snackbar.LENGTH_LONG).show();
         }
 
diff --git a/src/com/android/documentsui/ui/MessageBuilder.java b/src/com/android/documentsui/ui/MessageBuilder.java
index 179b73d06..5ac764f07 100644
--- a/src/com/android/documentsui/ui/MessageBuilder.java
+++ b/src/com/android/documentsui/ui/MessageBuilder.java
@@ -15,23 +15,25 @@
  */
 package com.android.documentsui.ui;
 
-import androidx.annotation.PluralsRes;
+import static com.android.documentsui.OperationDialogFragment.DIALOG_TYPE_CONVERTED;
+import static com.android.documentsui.OperationDialogFragment.DIALOG_TYPE_FAILURE;
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.content.Context;
-import android.text.BidiFormatter;
 import android.net.Uri;
+import android.text.BidiFormatter;
 import android.text.Html;
 
+import androidx.annotation.PluralsRes;
+
 import com.android.documentsui.OperationDialogFragment.DialogType;
 import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.Shared;
 import com.android.documentsui.services.FileOperationService;
 import com.android.documentsui.services.FileOperationService.OpType;
-import com.android.documentsui.OperationDialogFragment.DialogType;
-
-import static com.android.documentsui.OperationDialogFragment.DIALOG_TYPE_FAILURE;
-import static com.android.documentsui.OperationDialogFragment.DIALOG_TYPE_CONVERTED;
 
+import java.io.File;
 import java.util.List;
 
 public class MessageBuilder {
@@ -58,53 +60,66 @@ public class MessageBuilder {
             // Address b/28772371, where including user strings in message can result in
             // broken bidirectional support.
             String displayName = BidiFormatter.getInstance().unicodeWrap(docs.get(0).displayName);
-            message = dirsCount == 0
-                    ? mContext.getString(R.string.delete_filename_confirmation_message,
-                            displayName)
-                    : mContext.getString(R.string.delete_foldername_confirmation_message,
-                            displayName);
+            message =
+                    dirsCount == 0
+                            ? mContext.getString(
+                                    getRes(R.string.delete_filename_confirmation_message),
+                                    displayName)
+                            : mContext.getString(
+                                    getRes(R.string.delete_foldername_confirmation_message),
+                                    displayName);
         } else if (dirsCount == 0) {
             // Deleting only files in cwd
-            message = Shared.getQuantityString(mContext,
-                    R.plurals.delete_files_confirmation_message, docs.size());
+            message =
+                    Shared.getQuantityString(
+                            mContext,
+                            getRes(R.plurals.delete_files_confirmation_message),
+                            docs.size());
         } else if (dirsCount == docs.size()) {
             // Deleting only folders in cwd
-            message = Shared.getQuantityString(mContext,
-                    R.plurals.delete_folders_confirmation_message, docs.size());
+            message =
+                    Shared.getQuantityString(
+                            mContext,
+                            getRes(R.plurals.delete_folders_confirmation_message),
+                            docs.size());
         } else {
             // Deleting mixed items (files and folders) in cwd
-            message = Shared.getQuantityString(mContext,
-                    R.plurals.delete_items_confirmation_message, docs.size());
+            message =
+                    Shared.getQuantityString(
+                            mContext,
+                            getRes(R.plurals.delete_items_confirmation_message),
+                            docs.size());
         }
         return message;
     }
 
     public String generateListMessage(
             @DialogType int dialogType, @OpType int operationType, List<DocumentInfo> docs,
-            List<Uri> uris) {
+            List<Uri> uris, List<String> paths) {
         int resourceId;
 
         switch (dialogType) {
             case DIALOG_TYPE_CONVERTED:
-                resourceId = R.plurals.copy_converted_warning_content;
+                resourceId = getRes(R.plurals.copy_converted_warning_content);
                 break;
 
             case DIALOG_TYPE_FAILURE:
                 switch (operationType) {
                     case FileOperationService.OPERATION_COPY:
-                        resourceId = R.plurals.copy_failure_alert_content;
+                        resourceId = getRes(R.plurals.copy_failure_alert_content);
                         break;
                     case FileOperationService.OPERATION_COMPRESS:
-                        resourceId = R.plurals.compress_failure_alert_content;
+                        resourceId = getRes(R.plurals.compress_failure_alert_content);
                         break;
                     case FileOperationService.OPERATION_EXTRACT:
-                        resourceId = R.plurals.extract_failure_alert_content;
+                    case FileOperationService.OPERATION_UNPACK:
+                        resourceId = getRes(R.plurals.extract_failure_alert_content);
                         break;
                     case FileOperationService.OPERATION_DELETE:
-                        resourceId = R.plurals.delete_failure_alert_content;
+                        resourceId = getRes(R.plurals.delete_failure_alert_content);
                         break;
                     case FileOperationService.OPERATION_MOVE:
-                        resourceId = R.plurals.move_failure_alert_content;
+                        resourceId = getRes(R.plurals.move_failure_alert_content);
                         break;
                     default:
                         throw new UnsupportedOperationException();
@@ -116,16 +131,32 @@ public class MessageBuilder {
         }
 
         final StringBuilder list = new StringBuilder("<p>");
-        for (DocumentInfo documentInfo : docs) {
-            list.append("&#8226; " + Html.escapeHtml(BidiFormatter.getInstance().unicodeWrap(
-                    documentInfo.displayName)) + "<br>");
+        final BidiFormatter bdf = BidiFormatter.getInstance();
+
+        if (docs != null) {
+            for (DocumentInfo doc : docs) {
+                list.append("&#8226; ");
+                list.append(Html.escapeHtml(bdf.unicodeWrap(doc.displayName)));
+                list.append("<br>");
+            }
         }
+
         if (uris != null) {
             for (Uri uri : uris) {
-                list.append("&#8226; " + BidiFormatter.getInstance().unicodeWrap(uri.toSafeString()) +
-                        "<br>");
+                list.append("&#8226; ");
+                list.append(Html.escapeHtml(bdf.unicodeWrap(uri.toSafeString())));
+                list.append("<br>");
             }
         }
+
+        if (paths != null) {
+            for (String path : paths) {
+                list.append("&#8226; ");
+                list.append(Html.escapeHtml(bdf.unicodeWrap(new File(path).getName())));
+                list.append("<br>");
+            }
+        }
+
         list.append("</p>");
 
         final int totalItems = docs.size() + (uris != null ? uris.size() : 0);
diff --git a/src/com/android/documentsui/ui/OperationProgressDialog.java b/src/com/android/documentsui/ui/OperationProgressDialog.java
index 1c08580a6..7b610e378 100644
--- a/src/com/android/documentsui/ui/OperationProgressDialog.java
+++ b/src/com/android/documentsui/ui/OperationProgressDialog.java
@@ -16,11 +16,12 @@
 
 package com.android.documentsui.ui;
 
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import android.app.Activity;
 import android.app.ProgressDialog;
 import android.os.Handler;
 import android.os.Message;
-import android.text.format.DateUtils;
 
 import androidx.annotation.StringRes;
 
@@ -56,32 +57,36 @@ public class OperationProgressDialog {
                     mDialog.dismiss();
                 });
 
-        mDialog.setButton(ProgressDialog.BUTTON_NEUTRAL,
-                activity.getString(R.string.continue_in_background),
+        mDialog.setButton(
+                ProgressDialog.BUTTON_NEUTRAL,
+                activity.getString(getRes(R.string.continue_in_background)),
                 (dialog, button) -> mDialog.dismiss());
 
-        operation.addMessageListener(new Handler.Callback() {
-            @Override
-            public boolean handleMessage(Message message) {
-                switch (message.what) {
-                    case FileOperationService.MESSAGE_PROGRESS:
-                        mDialog.setIndeterminate(false);
-                        if (message.arg1 != -1) {
-                            mDialog.setProgress(message.arg1);
-                        }
-                        if (message.arg2 > 0) {
-                            mDialog.setMessage(mActivity.getString(R.string.copy_remaining,
-                                    FormatUtils.formatDuration(message.arg2)));
+        operation.addMessageListener(
+                new Handler.Callback() {
+                    @Override
+                    public boolean handleMessage(Message message) {
+                        switch (message.what) {
+                            case FileOperationService.MESSAGE_PROGRESS:
+                                mDialog.setIndeterminate(false);
+                                if (message.arg1 != -1) {
+                                    mDialog.setProgress(message.arg1);
+                                }
+                                if (message.arg2 > 0) {
+                                    mDialog.setMessage(
+                                            mActivity.getString(
+                                                    getRes(R.string.copy_remaining),
+                                                    FormatUtils.formatDuration(message.arg2)));
+                                }
+                                return true;
+                            case FileOperationService.MESSAGE_FINISH:
+                                operation.removeMessageListener(this);
+                                mDialog.dismiss();
+                                return true;
                         }
-                        return true;
-                    case FileOperationService.MESSAGE_FINISH:
-                        operation.removeMessageListener(this);
-                        mDialog.dismiss();
-                        return true;
-                }
-                return false;
-            }
-        });
+                        return false;
+                    }
+                });
     }
 
     public static OperationProgressDialog create(Activity activity, String jobId,
@@ -90,20 +95,21 @@ public class OperationProgressDialog {
         int prepareResId;
         switch (operation.getOpType()) {
             case FileOperationService.OPERATION_COPY:
-                titleResId = R.string.copy_notification_title;
-                prepareResId = R.string.copy_preparing;
+                titleResId = getRes(R.string.copy_notification_title);
+                prepareResId = getRes(R.string.copy_preparing);
                 break;
             case FileOperationService.OPERATION_COMPRESS:
-                titleResId = R.string.compress_notification_title;
-                prepareResId = R.string.compress_preparing;
+                titleResId = getRes(R.string.compress_notification_title);
+                prepareResId = getRes(R.string.compress_preparing);
                 break;
             case FileOperationService.OPERATION_EXTRACT:
-                titleResId = R.string.extract_notification_title;
-                prepareResId = R.string.extract_preparing;
+            case FileOperationService.OPERATION_UNPACK:
+                titleResId = getRes(R.string.extract_notification_title);
+                prepareResId = getRes(R.string.extract_preparing);
                 break;
             case FileOperationService.OPERATION_MOVE:
-                titleResId = R.string.move_notification_title;
-                prepareResId = R.string.move_preparing;
+                titleResId = getRes(R.string.move_notification_title);
+                prepareResId = getRes(R.string.move_preparing);
                 break;
             case FileOperationService.OPERATION_DELETE:
                 // Not supported yet. Pass through to default.
diff --git a/src/com/android/documentsui/ui/Snackbars.java b/src/com/android/documentsui/ui/Snackbars.java
index 795b6248b..a8cc4a64d 100644
--- a/src/com/android/documentsui/ui/Snackbars.java
+++ b/src/com/android/documentsui/ui/Snackbars.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.ui;
 
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import android.app.Activity;
 import android.view.Gravity;
@@ -37,52 +38,60 @@ public final class Snackbars {
     private Snackbars() {}
 
     public static final void showDocumentsClipped(Activity activity, int docCount) {
-        String msg = Shared.getQuantityString(
-                activity, R.plurals.clipboard_files_clipped, docCount);
+        String msg =
+                Shared.getQuantityString(
+                        activity, getRes(R.plurals.clipboard_files_clipped), docCount);
         Snackbars.makeSnackbar(activity, msg, Snackbar.LENGTH_LONG).show();
     }
 
     public static final void showMove(Activity activity, int docCount) {
-        CharSequence message = Shared.getQuantityString(activity, R.plurals.move_begin, docCount);
+        CharSequence message =
+                Shared.getQuantityString(activity, getRes(R.plurals.move_begin), docCount);
         makeSnackbar(activity, message, Snackbar.LENGTH_LONG).show();
     }
 
     public static final void showCopy(Activity activity, int docCount) {
-        CharSequence message = Shared.getQuantityString(activity, R.plurals.copy_begin, docCount);
+        CharSequence message =
+                Shared.getQuantityString(activity, getRes(R.plurals.copy_begin), docCount);
         makeSnackbar(activity, message, Snackbar.LENGTH_LONG).show();
     }
 
     public static final void showCompress(Activity activity, int docCount) {
-        CharSequence message = Shared.getQuantityString(activity, R.plurals.compress_begin, docCount);
+        CharSequence message =
+                Shared.getQuantityString(activity, getRes(R.plurals.compress_begin), docCount);
         makeSnackbar(activity, message, Snackbar.LENGTH_LONG).show();
     }
 
     public static final void showExtract(Activity activity, int docCount) {
-        CharSequence message = Shared.getQuantityString(activity, R.plurals.extract_begin, docCount);
+        CharSequence message =
+                Shared.getQuantityString(activity, getRes(R.plurals.extract_begin), docCount);
         makeSnackbar(activity, message, Snackbar.LENGTH_LONG).show();
     }
 
     public static final void showDelete(Activity activity, int docCount) {
-        CharSequence message = Shared.getQuantityString(activity, R.plurals.deleting, docCount);
+        CharSequence message =
+                Shared.getQuantityString(activity, getRes(R.plurals.deleting), docCount);
         makeSnackbar(activity, message, Snackbar.LENGTH_LONG).show();
     }
 
     public static final void showOperationRejected(Activity activity) {
-        makeSnackbar(activity, R.string.file_operation_rejected, Snackbar.LENGTH_LONG).show();
+        makeSnackbar(activity, getRes(R.string.file_operation_rejected), Snackbar.LENGTH_LONG)
+                .show();
     }
 
     public static final void showOperationFailed(Activity activity) {
-        makeSnackbar(activity, R.string.file_operation_error, Snackbar.LENGTH_LONG).show();
+        makeSnackbar(activity, getRes(R.string.file_operation_error), Snackbar.LENGTH_LONG).show();
     }
 
     public static final void showRenameFailed(Activity activity) {
-        makeSnackbar(activity, R.string.rename_error, Snackbar.LENGTH_LONG).show();
+        makeSnackbar(activity, getRes(R.string.rename_error), Snackbar.LENGTH_LONG).show();
     }
 
     public static final void showInspectorError(Activity activity) {
-        //Document Inspector uses a different view from other files app activities.
-        final View view = activity.findViewById(R.id.inspector_root);
-        Snackbar.make(view, R.string.inspector_load_error, Snackbar.LENGTH_INDEFINITE).show();
+        // Document Inspector uses a different view from other files app activities.
+        final View view = activity.findViewById(getRes(R.id.inspector_root));
+        Snackbar.make(view, getRes(R.string.inspector_load_error), Snackbar.LENGTH_INDEFINITE)
+                .show();
     }
 
     public static final void showCustomTextWithImage(Activity activity, String text, int imageRes) {
@@ -112,10 +121,11 @@ public final class Snackbars {
 
     public static final Snackbar makeSnackbar(
             Activity activity, CharSequence message, int duration) {
-        final View view = activity.findViewById(isUseMaterial3FlagEnabled()
-                ? R.id.coordinator_layout
-                : R.id.container_save
-        );
+        final View view =
+                activity.findViewById(
+                        isUseMaterial3FlagEnabled()
+                                ? getRes(R.id.coordinator_layout)
+                                : getRes(R.id.container_save));
         return Snackbar.make(view, message, duration);
     }
 }
diff --git a/src/com/android/documentsui/util/ComponentUtils.kt b/src/com/android/documentsui/util/ComponentUtils.kt
new file mode 100644
index 000000000..f57e1f2ef
--- /dev/null
+++ b/src/com/android/documentsui/util/ComponentUtils.kt
@@ -0,0 +1,115 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.util
+
+import android.content.ComponentName
+import android.content.Intent
+import android.content.Intent.ACTION_GET_CONTENT
+import android.content.pm.PackageInfo
+import android.content.pm.PackageManager
+import android.os.Build
+import android.os.ext.SdkExtensions
+import android.provider.MediaStore.ACTION_PICK_IMAGES
+import android.util.Log
+import com.android.documentsui.base.SharedMinimal.DEBUG
+import com.android.documentsui.picker.TrampolineActivity
+
+/**
+ * Returns the ComponentName for the Photopicker on the device that handles the GET_CONTENT action.
+ * Uses the PICK_IMAGES action to get the proper component name then attempts to find the
+ * GET_CONTENT handler for that explicit component.
+ */
+fun getPhotopickerGetContentComponentNameForType(
+    packageManager: PackageManager,
+    type: String?
+): ComponentName? {
+    // Intent.ACTION_PICK_IMAGES is only available from SdkExtensions v2 onwards. Prior to that
+    // the Photopicker was not available, so in those cases should always send to DocumentsUI.
+    if (SdkExtensions.getExtensionVersion(Build.VERSION_CODES.R) < 2) {
+        return null
+    }
+
+    // Attempt to resolve the `ACTION_PICK_IMAGES` intent to get the Photopicker package.
+    // On T+ devices this is is a standalone package, whilst prior to T it is part of the
+    // MediaProvider module.
+    val pickImagesIntent = Intent(
+        ACTION_PICK_IMAGES
+    ).apply { addCategory(Intent.CATEGORY_DEFAULT) }
+    val photopickerComponentName: ComponentName? = pickImagesIntent.resolveActivity(
+        packageManager
+    )
+
+    // For certain devices the activity that handles ACTION_GET_CONTENT can be disabled (when
+    // the ACTION_PICK_IMAGES is enabled) so double check by explicitly checking the
+    // ACTION_GET_CONTENT activity on the same activity that handles ACTION_PICK_IMAGES.
+    val photopickerGetContentIntent = Intent(ACTION_GET_CONTENT).apply {
+        setType(type)
+        setPackage(photopickerComponentName?.packageName)
+    }
+    val photopickerGetContentComponent: ComponentName? =
+        photopickerGetContentIntent.resolveActivity(packageManager)
+
+    // Ensure the `ACTION_GET_CONTENT` activity is enabled.
+    if (!isComponentEnabled(packageManager, photopickerGetContentComponent)) {
+        if (DEBUG) {
+            Log.d(
+                TrampolineActivity.Companion.TAG,
+                "Photopicker PICK_IMAGES component has no enabled GET_CONTENT handler"
+            )
+        }
+        return null
+    }
+
+    return photopickerGetContentComponent
+}
+
+/**
+ * Private method to check if the supplied ComponentName is enabled or not.
+ * Photopicker dynamically disables itself in some instances.
+ */
+private fun isComponentEnabled(
+    packageManager: PackageManager,
+    componentName: ComponentName?
+): Boolean {
+    if (componentName == null) {
+        return false
+    }
+
+    return when (packageManager.getComponentEnabledSetting(componentName)) {
+        PackageManager.COMPONENT_ENABLED_STATE_ENABLED -> true
+        PackageManager.COMPONENT_ENABLED_STATE_DEFAULT -> {
+            // DEFAULT is a state that essentially defers to the state defined in the
+            // AndroidManifest which can be either enabled or disabled.
+            packageManager.getPackageInfo(
+                componentName.packageName,
+                PackageManager.GET_ACTIVITIES
+            )?.let { packageInfo: PackageInfo ->
+                if (packageInfo.activities == null) {
+                    return false
+                }
+                for (val info in packageInfo.activities) {
+                    if (info.name == componentName.className) {
+                        return info.enabled
+                    }
+                }
+            }
+            return false
+        }
+
+        // Everything else is considered disabled.
+        else -> false
+    }
+}
diff --git a/src/com/android/documentsui/util/FlagUtils.kt b/src/com/android/documentsui/util/FlagUtils.kt
index cf81d5966..1be3da1ef 100644
--- a/src/com/android/documentsui/util/FlagUtils.kt
+++ b/src/com/android/documentsui/util/FlagUtils.kt
@@ -26,7 +26,7 @@ class FlagUtils {
     companion object {
         @JvmStatic
         fun isUseMaterial3FlagEnabled(): Boolean {
-            return Flags.useMaterial3()
+            return Flags.useMaterial3() && Material3Config.getInstance().forceMaterial3 == true
         }
 
         @JvmStatic
@@ -39,6 +39,9 @@ class FlagUtils {
             return Flags.useSearchV2ReadOnly()
         }
 
+        @JvmStatic
+        fun isSearchV2Enabled() = Flags.useSearchV2ReadOnly() && Flags.useMaterial3()
+
         @JvmStatic
         fun isDesktopFileHandlingFlagEnabled(): Boolean {
             return Flags.desktopFileHandlingRo()
@@ -50,13 +53,13 @@ class FlagUtils {
         }
 
         @JvmStatic
-        fun isHideRootsOnDesktopFlagEnabled(): Boolean {
-            return Flags.hideRootsOnDesktopRo()
+        fun isUsePeekPreviewFlagEnabled(): Boolean {
+            return Flags.usePeekPreviewRo() && isUseMaterial3FlagEnabled()
         }
 
         @JvmStatic
-        fun isUsePeekPreviewFlagEnabled(): Boolean {
-            return Flags.usePeekPreviewRo() && isUseMaterial3FlagEnabled()
+        fun isTrashFlowEnabled(): Boolean {
+            return Flags.enableTrashFlowRo()
         }
     }
 }
diff --git a/src/com/android/documentsui/util/ThemeUtils.kt b/src/com/android/documentsui/util/ThemeUtils.kt
new file mode 100644
index 000000000..7837ec997
--- /dev/null
+++ b/src/com/android/documentsui/util/ThemeUtils.kt
@@ -0,0 +1,420 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.util
+
+import android.util.Log
+import androidx.annotation.AnyRes
+import com.android.documentsui.R
+import com.android.documentsui.base.SharedMinimal.DEBUG
+import com.android.documentsui.util.FlagUtils.Companion.isUseMaterial3FlagEnabled
+
+/**
+ * Mapping of resource IDs from the pre-material3 (aka legacy) theme to the new resource ID in the
+ * material3 theme.
+ */
+private var idMapping: Map<Int, Int> = mapOf()
+private var initialized = false
+
+private const val TAG = "ThemeUtils"
+
+/**
+ * Only initialize the mapping when the use_material3 flag is enabled, because the IDs for the
+ * Material3 version only exists then.
+ */
+@Suppress("ktlint:standard:max-line-length")
+private fun initializeIdMapping() {
+  idMapping = mapOf(
+    R.bool.full_bar_search_view to R.bool.full_bar_search_view_m3,
+    R.color.app_background_color to R.color.app_background_color_m3,
+    R.color.app_icon_background to R.color.app_icon_background_m3,
+    R.color.background_floating to R.color.background_floating_m3,
+    R.color.band_select_background to R.color.band_select_background_m3,
+    R.color.band_select_border to R.color.band_select_border_m3,
+    R.color.chip_background_disable_color to R.color.chip_background_disable_color_m3,
+    R.color.color_surface_header to R.color.color_surface_header_m3,
+    R.color.doc_list_item_subtitle_color to R.color.doc_list_item_subtitle_color_m3,
+    R.color.downloads_icon_background to R.color.downloads_icon_background_m3,
+    R.color.error_image_color to R.color.error_image_color_m3,
+    R.color.hairline to R.color.hairline_m3,
+    R.color.horizontal_breadcrumb_color to R.color.horizontal_breadcrumb_color_m3,
+    R.color.item_action_icon to R.color.item_action_icon_m3,
+    R.color.item_breadcrumb_background_hovered to R.color.item_breadcrumb_background_hovered_m3,
+    R.color.item_details to R.color.item_details_m3,
+    R.color.item_doc_grid_border to R.color.item_doc_grid_border_m3,
+    R.color.item_doc_grid_tint to R.color.item_doc_grid_tint_m3,
+    R.color.item_drag_shadow_background to R.color.item_drag_shadow_background_m3,
+    R.color.item_drag_shadow_container_background to R.color.item_drag_shadow_container_background_m3,
+    R.color.item_root_icon to R.color.item_root_icon_m3,
+    R.color.item_root_primary_text to R.color.item_root_primary_text_m3,
+    R.color.item_root_secondary_text to R.color.item_root_secondary_text_m3,
+    R.color.list_divider_color to R.color.list_divider_color_m3,
+    R.color.list_item_selected_background_color to R.color.list_item_selected_background_color_m3,
+    R.color.menu_search_background to R.color.menu_search_background_m3,
+    R.color.nav_bar_translucent to R.color.nav_bar_translucent_m3,
+    R.color.primary to R.color.primary_m3,
+    R.color.search_chip_background_color to R.color.search_chip_background_color_m3,
+    R.color.search_chip_ripple_color to R.color.search_chip_ripple_color_m3,
+    R.color.search_chip_stroke_color to R.color.search_chip_stroke_color_m3,
+    R.color.search_chip_text_color to R.color.search_chip_text_color_m3,
+    R.color.search_chip_text_selected_color to R.color.search_chip_text_selected_color_m3,
+    R.color.secondary to R.color.secondary_m3,
+    R.color.shortcut_background to R.color.shortcut_background_m3,
+    R.color.shortcut_foreground to R.color.shortcut_foreground_m3,
+    R.color.sort_list_text to R.color.sort_list_text_m3,
+    R.color.tool_bar_gradient_max to R.color.tool_bar_gradient_max_m3,
+    R.dimen.action_bar_elevation to R.dimen.action_bar_elevation_m3,
+    R.dimen.action_bar_margin to R.dimen.action_bar_margin_m3,
+    R.dimen.action_mode_text_size to R.dimen.action_mode_text_size_m3,
+    R.dimen.apps_row_app_icon_size to R.dimen.apps_row_app_icon_size_m3,
+    R.dimen.apps_row_exit_icon_margin_bottom to R.dimen.apps_row_exit_icon_margin_bottom_m3,
+    R.dimen.apps_row_exit_icon_margin_top to R.dimen.apps_row_exit_icon_margin_top_m3,
+    R.dimen.apps_row_item_width to R.dimen.apps_row_item_width_m3,
+    R.dimen.bottom_bar_button_corner_radius to R.dimen.bottom_bar_button_corner_radius_m3,
+    R.dimen.bottom_bar_button_height to R.dimen.bottom_bar_button_height_m3,
+    R.dimen.bottom_bar_button_horizontal_padding to R.dimen.bottom_bar_button_horizontal_padding_m3,
+    R.dimen.bottom_bar_height to R.dimen.bottom_bar_height_m3,
+    R.dimen.bottom_bar_padding to R.dimen.bottom_bar_padding_m3,
+    R.dimen.breadcrumb_item_height to R.dimen.breadcrumb_item_height_m3,
+    R.dimen.breadcrumb_item_padding to R.dimen.breadcrumb_item_padding_m3,
+    R.dimen.briefcase_icon_margin to R.dimen.briefcase_icon_margin_m3,
+    R.dimen.briefcase_icon_size to R.dimen.briefcase_icon_size_m3,
+    R.dimen.briefcase_icon_size_photo to R.dimen.briefcase_icon_size_photo_m3,
+    R.dimen.button_corner_radius to R.dimen.button_corner_radius_m3,
+    R.dimen.button_touch_size to R.dimen.button_touch_size_m3,
+    R.dimen.check_icon_size to R.dimen.check_icon_size_m3,
+    R.dimen.cross_profile_button_message_margin_top to R.dimen.cross_profile_button_message_margin_top_m3,
+    R.dimen.dialog_content_padding_bottom to R.dimen.dialog_content_padding_bottom_m3,
+    R.dimen.dialog_content_padding_top to R.dimen.dialog_content_padding_top_m3,
+    R.dimen.dir_elevation to R.dimen.dir_elevation_m3,
+    R.dimen.doc_header_height to R.dimen.doc_header_height_m3,
+    R.dimen.doc_header_sort_icon_size to R.dimen.doc_header_sort_icon_size_m3,
+    R.dimen.drag_shadow_height to R.dimen.drag_shadow_height_m3,
+    R.dimen.drag_shadow_padding to R.dimen.drag_shadow_padding_m3,
+    R.dimen.drag_shadow_radius to R.dimen.drag_shadow_radius_m3,
+    R.dimen.drag_shadow_size to R.dimen.drag_shadow_size_m3,
+    R.dimen.drag_shadow_width to R.dimen.drag_shadow_width_m3,
+    R.dimen.drawer_edge_width to R.dimen.drawer_edge_width_m3,
+    R.dimen.drop_icon_height to R.dimen.drop_icon_height_m3,
+    R.dimen.drop_icon_width to R.dimen.drop_icon_width_m3,
+    R.dimen.dropdown_sort_text_size to R.dimen.dropdown_sort_text_size_m3,
+    R.dimen.dropdown_sort_widget_margin to R.dimen.dropdown_sort_widget_margin_m3,
+    R.dimen.dropdown_sort_widget_size to R.dimen.dropdown_sort_widget_size_m3,
+    R.dimen.fastscroll_default_thickness to R.dimen.fastscroll_default_thickness_m3,
+    R.dimen.fastscroll_margin to R.dimen.fastscroll_margin_m3,
+    R.dimen.fastscroll_minimum_range to R.dimen.fastscroll_minimum_range_m3,
+    R.dimen.grid_container_padding to R.dimen.grid_container_padding_m3,
+    R.dimen.grid_item_elevation to R.dimen.grid_item_elevation_m3,
+    R.dimen.grid_item_icon_size to R.dimen.grid_item_icon_size_m3,
+    R.dimen.grid_item_margin to R.dimen.grid_item_margin_m3,
+    R.dimen.grid_item_radius to R.dimen.grid_item_radius_m3,
+    R.dimen.grid_padding_horiz to R.dimen.grid_padding_horiz_m3,
+    R.dimen.grid_padding_vert to R.dimen.grid_padding_vert_m3,
+    R.dimen.grid_section_separator_height to R.dimen.grid_section_separator_height_m3,
+    R.dimen.grid_width to R.dimen.grid_width_m3,
+    R.dimen.header_message_horizontal_padding to R.dimen.header_message_horizontal_padding_m3,
+    R.dimen.icon_size to R.dimen.icon_size_m3,
+    R.dimen.inspector_header_height to R.dimen.inspector_header_height_m3,
+    R.dimen.list_container_padding to R.dimen.list_container_padding_m3,
+    R.dimen.list_divider_inset to R.dimen.list_divider_inset_m3,
+    R.dimen.list_item_height to R.dimen.list_item_height_m3,
+    R.dimen.list_item_icon_padding to R.dimen.list_item_icon_padding_m3,
+    R.dimen.list_item_padding to R.dimen.list_item_padding_m3,
+    R.dimen.list_item_thumbnail_size to R.dimen.list_item_thumbnail_size_m3,
+    R.dimen.list_item_width to R.dimen.list_item_width_m3,
+    R.dimen.material_round_radius to R.dimen.material_round_radius_m3,
+    R.dimen.max_drawer_width to R.dimen.max_drawer_width_m3,
+    R.dimen.profile_tab_margin_side to R.dimen.profile_tab_margin_side_m3,
+    R.dimen.profile_tab_margin_top to R.dimen.profile_tab_margin_top_m3,
+    R.dimen.profile_tab_padding to R.dimen.profile_tab_padding_m3,
+    R.dimen.progress_bar_height to R.dimen.progress_bar_height_m3,
+    R.dimen.refresh_icon_range to R.dimen.refresh_icon_range_m3,
+    R.dimen.root_action_icon_size to R.dimen.root_action_icon_size_m3,
+    R.dimen.root_icon_disabled_alpha to R.dimen.root_icon_disabled_alpha_m3,
+    R.dimen.root_icon_margin to R.dimen.root_icon_margin_m3,
+    R.dimen.root_icon_size to R.dimen.root_icon_size_m3,
+    R.dimen.root_info_header_height to R.dimen.root_info_header_height_m3,
+    R.dimen.root_info_header_horizontal_padding to R.dimen.root_info_header_horizontal_padding_m3,
+    R.dimen.root_spacer_padding to R.dimen.root_spacer_padding_m3,
+    R.dimen.search_bar_background_margin_end to R.dimen.search_bar_background_margin_end_m3,
+    R.dimen.search_bar_background_margin_start to R.dimen.search_bar_background_margin_start_m3,
+    R.dimen.search_bar_elevation to R.dimen.search_bar_elevation_m3,
+    R.dimen.search_bar_icon_padding to R.dimen.search_bar_icon_padding_m3,
+    R.dimen.search_bar_margin to R.dimen.search_bar_margin_m3,
+    R.dimen.search_bar_radius to R.dimen.search_bar_radius_m3,
+    R.dimen.search_bar_text_margin_end to R.dimen.search_bar_text_margin_end_m3,
+    R.dimen.search_bar_text_margin_start to R.dimen.search_bar_text_margin_start_m3,
+    R.dimen.search_bar_text_size to R.dimen.search_bar_text_size_m3,
+    R.dimen.search_chip_group_margin to R.dimen.search_chip_group_margin_m3,
+    R.dimen.search_chip_half_spacing to R.dimen.search_chip_half_spacing_m3,
+    R.dimen.search_chip_icon_padding to R.dimen.search_chip_icon_padding_m3,
+    R.dimen.search_chip_radius to R.dimen.search_chip_radius_m3,
+    R.dimen.search_chip_spacing to R.dimen.search_chip_spacing_m3,
+    R.dimen.tab_container_height to R.dimen.tab_container_height_m3,
+    R.dimen.tab_height to R.dimen.tab_height_m3,
+    R.dimen.tab_selector_indicator_height to R.dimen.tab_selector_indicator_height_m3,
+    R.dimen.zoom_icon_size to R.dimen.zoom_icon_size_m3,
+    R.drawable.band_select_overlay to R.drawable.band_select_overlay_m3,
+    R.drawable.bottom_sheet_dialog_background to R.drawable.bottom_sheet_dialog_background_m3,
+    R.drawable.breadcrumb_item_background to R.drawable.breadcrumb_item_background_m3,
+    R.drawable.circle_button_background to R.drawable.circle_button_background_m3,
+    R.drawable.drag_shadow_background to R.drawable.drag_shadow_background_m3,
+    R.drawable.drop_badge_states to R.drawable.drop_badge_states_m3,
+    R.drawable.dropdown_sort_widget_background to R.drawable.dropdown_sort_widget_background_m3,
+    R.drawable.empty to R.drawable.empty_m3,
+    R.drawable.fast_scroll_thumb_drawable to R.drawable.fast_scroll_thumb_drawable_m3,
+    R.drawable.fast_scroll_track_drawable to R.drawable.fast_scroll_track_drawable_m3,
+    R.drawable.generic_ripple_background to R.drawable.generic_ripple_background_m3,
+    R.drawable.grid_item_background to R.drawable.grid_item_background_m3,
+    R.drawable.hourglass to R.drawable.hourglass_m3,
+    R.drawable.ic_action_clear to R.drawable.ic_action_clear_m3,
+    R.drawable.ic_action_open to R.drawable.ic_action_open_m3,
+    R.drawable.ic_advanced_shortcut to R.drawable.ic_advanced_shortcut_m3,
+    R.drawable.ic_arrow_back to R.drawable.ic_arrow_back_m3,
+    R.drawable.ic_arrow_upward to R.drawable.ic_arrow_upward_m3,
+    R.drawable.ic_breadcrumb_arrow to R.drawable.ic_breadcrumb_arrow_m3,
+    R.drawable.ic_briefcase to R.drawable.ic_briefcase_m3,
+    R.drawable.ic_briefcase_white to R.drawable.ic_briefcase_white_m3,
+    R.drawable.ic_cab_cancel to R.drawable.ic_cab_cancel_m3,
+    R.drawable.ic_check to R.drawable.ic_check_m3,
+    R.drawable.ic_check_circle to R.drawable.ic_check_circle_m3,
+    R.drawable.ic_chip_from_this_week to R.drawable.ic_chip_from_this_week_m3,
+    R.drawable.ic_chip_large_files to R.drawable.ic_chip_large_files_m3,
+    R.drawable.ic_create_new_folder to R.drawable.ic_create_new_folder_m3,
+    R.drawable.ic_debug_menu to R.drawable.ic_debug_menu_m3,
+    R.drawable.ic_dialog_alert to R.drawable.ic_dialog_alert_m3,
+    R.drawable.ic_dialog_info to R.drawable.ic_dialog_info_m3,
+    R.drawable.ic_done to R.drawable.ic_done_m3,
+    R.drawable.ic_drop_copy_badge to R.drawable.ic_drop_copy_badge_m3,
+    R.drawable.ic_eject to R.drawable.ic_eject_m3,
+    R.drawable.ic_exit_to_app to R.drawable.ic_exit_to_app_m3,
+    R.drawable.ic_folder_shortcut to R.drawable.ic_folder_shortcut_m3,
+    R.drawable.ic_hamburger to R.drawable.ic_hamburger_m3,
+    R.drawable.ic_history to R.drawable.ic_history_m3,
+    R.drawable.ic_menu_compress to R.drawable.ic_menu_compress_m3,
+    R.drawable.ic_menu_copy to R.drawable.ic_menu_copy_m3,
+    R.drawable.ic_menu_delete to R.drawable.ic_menu_delete_m3,
+    R.drawable.ic_menu_extract to R.drawable.ic_menu_extract_m3,
+    R.drawable.ic_menu_search to R.drawable.ic_menu_search_m3,
+    R.drawable.ic_menu_share to R.drawable.ic_menu_share_m3,
+    R.drawable.ic_menu_view_grid to R.drawable.ic_menu_view_grid_m3,
+    R.drawable.ic_menu_view_list to R.drawable.ic_menu_view_list_m3,
+    R.drawable.ic_reject_drop_badge to R.drawable.ic_reject_drop_badge_m3,
+    R.drawable.ic_root_bugreport to R.drawable.ic_root_bugreport_m3,
+    R.drawable.ic_root_download to R.drawable.ic_root_download_m3,
+    R.drawable.ic_root_recent to R.drawable.ic_root_recent_m3,
+    R.drawable.ic_root_smartphone to R.drawable.ic_root_smartphone_m3,
+    R.drawable.ic_sd_storage to R.drawable.ic_sd_storage_m3,
+    R.drawable.ic_sort to R.drawable.ic_sort_m3,
+    R.drawable.ic_sort_arrow to R.drawable.ic_sort_arrow_m3,
+    R.drawable.ic_subdirectory_arrow to R.drawable.ic_subdirectory_arrow_m3,
+    R.drawable.ic_usb_shortcut to R.drawable.ic_usb_shortcut_m3,
+    R.drawable.ic_usb_storage to R.drawable.ic_usb_storage_m3,
+    R.drawable.ic_user_profile to R.drawable.ic_user_profile_m3,
+    R.drawable.ic_zoom_out to R.drawable.ic_zoom_out_m3,
+    R.drawable.inspector_separator to R.drawable.inspector_separator_m3,
+    R.drawable.item_doc_grid_border to R.drawable.item_doc_grid_border_m3,
+    R.drawable.item_doc_grid_border_rounded to R.drawable.item_doc_grid_border_rounded_m3,
+    R.drawable.launcher_screen to R.drawable.launcher_screen_m3,
+    R.drawable.list_checker to R.drawable.list_checker_m3,
+    R.drawable.list_divider to R.drawable.list_divider_m3,
+    R.drawable.list_item_background to R.drawable.list_item_background_m3,
+    R.drawable.menu_dropdown_panel to R.drawable.menu_dropdown_panel_m3,
+    R.drawable.progress_indeterminate_horizontal_material_trimmed to R.drawable.progress_indeterminate_horizontal_material_trimmed_m3,
+    R.drawable.root_item_background to R.drawable.root_item_background_m3,
+    R.drawable.root_list_selector to R.drawable.root_list_selector_m3,
+    R.drawable.roots_list_border to R.drawable.roots_list_border_m3,
+    R.drawable.search_bar_background to R.drawable.search_bar_background_m3,
+    R.drawable.share_off to R.drawable.share_off_m3,
+    R.drawable.sort_widget_background to R.drawable.sort_widget_background_m3,
+    R.drawable.splash_screen to R.drawable.splash_screen_m3,
+    R.drawable.tab_border_rounded to R.drawable.tab_border_rounded_m3,
+    R.drawable.vector_drawable_progress_indeterminate_horizontal_trimmed to R.drawable.vector_drawable_progress_indeterminate_horizontal_trimmed_m3,
+    R.drawable.work_off to R.drawable.work_off_m3,
+    R.layout.apps_item to R.layout.apps_item_m3,
+    R.layout.apps_row to R.layout.apps_row_m3,
+    R.layout.column_headers to R.layout.column_headers_m3,
+    R.layout.dialog_delete_confirmation to R.layout.dialog_delete_confirmation_m3,
+    R.layout.dialog_file_name to R.layout.dialog_file_name_m3,
+    R.layout.dialog_sorting to R.layout.dialog_sorting_m3,
+    R.layout.directory_app_bar to R.layout.directory_app_bar_m3,
+    R.layout.directory_header to R.layout.directory_header_m3,
+    R.layout.documents_activity to R.layout.documents_activity_m3,
+    R.layout.drag_shadow_layout to R.layout.drag_shadow_layout_m3,
+    R.layout.drawer_layout to R.layout.drawer_layout_m3,
+    R.layout.drop_badge to R.layout.drop_badge_m3,
+    R.layout.files_activity to R.layout.files_activity_m3,
+    R.layout.fixed_layout to R.layout.fixed_layout_m3,
+    R.layout.fragment_directory to R.layout.fragment_directory_m3,
+    R.layout.fragment_pick_directory to R.layout.fragment_pick_directory_m3,
+    R.layout.fragment_roots to R.layout.fragment_roots_m3,
+    R.layout.fragment_save to R.layout.fragment_save_m3,
+    R.layout.fragment_search to R.layout.fragment_search_m3,
+    R.layout.inspector_action_view to R.layout.inspector_action_view_m3,
+    R.layout.inspector_activity to R.layout.inspector_activity_m3,
+    R.layout.inspector_header to R.layout.inspector_header_m3,
+    R.layout.inspector_section_title to R.layout.inspector_section_title_m3,
+    R.layout.item_dir_grid to R.layout.item_dir_grid_m3,
+    R.layout.item_doc_grid to R.layout.item_doc_grid_m3,
+    R.layout.item_doc_header_message to R.layout.item_doc_header_message_m3,
+    R.layout.item_doc_inflated_message to R.layout.item_doc_inflated_message_m3,
+    R.layout.item_doc_inflated_message_content to R.layout.item_doc_inflated_message_content_m3,
+    R.layout.item_doc_inflated_message_cross_profile to R.layout.item_doc_inflated_message_cross_profile_m3,
+    R.layout.item_doc_list to R.layout.item_doc_list_m3,
+    R.layout.item_history to R.layout.item_history_m3,
+    R.layout.item_photo_grid to R.layout.item_photo_grid_m3,
+    R.layout.item_root to R.layout.item_root_m3,
+    R.layout.item_root_header to R.layout.item_root_header_m3,
+    R.layout.item_root_spacer to R.layout.item_root_spacer_m3,
+    R.layout.navigation_breadcrumb_item to R.layout.navigation_breadcrumb_item_m3,
+    R.layout.root_vertical_divider to R.layout.root_vertical_divider_m3,
+    R.layout.search_chip_item to R.layout.search_chip_item_m3,
+    R.layout.search_chip_row to R.layout.search_chip_row_m3,
+    R.layout.shared_cell_content to R.layout.shared_cell_content_m3,
+    R.layout.sort_list_item to R.layout.sort_list_item_m3,
+    R.layout.table_key_value_row to R.layout.table_key_value_row_m3,
+    R.menu.action_mode_menu to R.menu.action_mode_menu_m3,
+    R.menu.activity to R.menu.activity_m3,
+    R.menu.container_context_menu to R.menu.container_context_menu_m3,
+    R.menu.dir_context_menu to R.menu.dir_context_menu_m3,
+    R.menu.file_context_menu to R.menu.file_context_menu_m3,
+    R.menu.mixed_context_menu to R.menu.mixed_context_menu_m3,
+    R.menu.root_context_menu to R.menu.root_context_menu_m3,
+    R.string.scrolling_behavior to R.string.scrolling_behavior_m3,
+    R.style.ActionBarTheme to R.style.ActionBarThemeM3,
+    R.style.ActionBarThemeCommon to R.style.ActionBarThemeCommonM3,
+    R.style.AppsItemSubText to R.style.AppsItemSubTextM3,
+    R.style.AutoCompleteText to R.style.AutoCompleteTextM3,
+    R.style.AutoCompleteTextViewStyle to R.style.AutoCompleteTextViewStyleM3,
+    R.style.BottomSheet to R.style.BottomSheetM3,
+    R.style.BottomSheetDialogStyle to R.style.BottomSheetDialogStyleM3,
+    R.style.BreadcrumbText to R.style.BreadcrumbTextM3,
+    R.style.CardPrimaryText to R.style.CardPrimaryTextM3,
+    R.style.DialogTextButton to R.style.DialogTextButtonM3,
+    R.style.DocumentsDefaultTheme to R.style.DocumentsDefaultThemeM3,
+    R.style.DocumentsTheme to R.style.DocumentsThemeM3,
+    R.style.DrawerMenuHeader to R.style.DrawerMenuHeaderM3,
+    R.style.DrawerMenuPrimary to R.style.DrawerMenuPrimaryM3,
+    R.style.DrawerMenuSecondary to R.style.DrawerMenuSecondaryM3,
+    R.style.EmptyStateTitleText to R.style.EmptyStateTitleTextM3,
+    R.style.InspectorKeySubTitle to R.style.InspectorKeySubTitleM3,
+    R.style.ItemCaptionText to R.style.ItemCaptionTextM3,
+    R.style.LauncherTheme to R.style.LauncherThemeM3,
+    R.style.MaterialAlertDialogTheme to R.style.MaterialAlertDialogThemeM3,
+    R.style.MaterialAlertDialogTitleStyle to R.style.MaterialAlertDialogTitleStyleM3,
+    R.style.MaterialButton to R.style.MaterialButtonM3,
+    R.style.MaterialButtonTextAppearance to R.style.MaterialButtonTextAppearanceM3,
+    R.style.MaterialOutlinedButton to R.style.MaterialOutlinedButtonM3,
+    R.style.MenuItemTextAppearance to R.style.MenuItemTextAppearanceM3,
+    R.style.OverflowButtonStyle to R.style.OverflowButtonStyleM3,
+    R.style.OverflowMenuStyle to R.style.OverflowMenuStyleM3,
+    R.style.SearchBarTitle to R.style.SearchBarTitleM3,
+    R.style.SearchChipText to R.style.SearchChipTextM3,
+    R.style.SnackbarButtonStyle to R.style.SnackbarButtonStyleM3,
+    R.style.SortList to R.style.SortListM3,
+    R.style.Subhead to R.style.SubheadM3,
+    R.style.TabTextAppearance to R.style.TabTextAppearanceM3,
+    R.style.ToolbarTitle to R.style.ToolbarTitleM3,
+  )
+}
+
+interface Config {
+  /**
+   * Material3 is only fully enabled if the config forceMaterial3 is true AND the flag use_material3
+   * is enabled.
+   */
+  var forceMaterial3: Boolean?
+}
+
+class Material3ConfigImpl() : Config {
+  override var forceMaterial3: Boolean? = null
+    set(value) {
+      if (field != null && field != value) {
+        Log.w(
+            TAG,
+            "forceMaterial3 already set ($field) but overriding to $value. " +
+                    "This could result in unstable behaviour."
+        )
+      }
+
+      field = value
+      if (DEBUG) {
+        Log.d(
+          TAG,
+          "forceMaterial3 initializing with $value use_material3: ${
+            isUseMaterial3FlagEnabled()
+          }",
+        )
+      }
+    }
+}
+
+abstract class Material3Config private constructor() {
+  companion object {
+    private val _instance: Config by lazy { Material3ConfigImpl() }
+
+    @JvmStatic
+    fun getInstance(): Config {
+      return _instance
+    }
+
+    /**
+     * Convert the resource ID from non-Material3 to Material3 version if the Material3 is enabled,
+     * otherwise it returns the given ID as is.
+     */
+    @JvmStatic
+    @AnyRes
+    fun getRes(@AnyRes originalResourceId: Int): Int {
+      // NOTE: isUseMaterial3FlagEnabled() already checks for the config forceMaterial3.
+      if (!isUseMaterial3FlagEnabled()) {
+        return originalResourceId
+      }
+
+      if (!initialized) {
+        initializeIdMapping()
+      }
+
+      val newId = idMapping[originalResourceId] ?: originalResourceId
+      if (DEBUG) {
+        if (newId != originalResourceId) {
+          Log.d(
+            TAG,
+            "Replacing R ID from ${
+              Integer.toHexString(
+                originalResourceId
+              )
+            } to ${Integer.toHexString(newId)}",
+          )
+        }
+      }
+
+      return newId
+    }
+
+    @JvmStatic
+    fun overrideMappingForTest(overrides: Map<Int, Int>) {
+      initialized = true
+      idMapping = overrides
+    }
+
+    @JvmStatic
+    fun setEnabledForTest(enabled: Boolean) {
+      getInstance().forceMaterial3 = enabled
+      // Force the mapping to be re-initialized.
+      initialized = false
+    }
+  }
+}
diff --git a/tests/Android.bp b/tests/Android.bp
index 65e3f259f..de380f730 100644
--- a/tests/Android.bp
+++ b/tests/Android.bp
@@ -58,6 +58,7 @@ android_library {
         "androidx.test.espresso.core",
         "androidx.test.rules",
         "androidx.test.uiautomator_uiautomator",
+        "flag-junit",
         "mockito-target",
         "ub-janktesthelper",
     ],
diff --git a/tests/assets/archives/zip/bad-crc.zip b/tests/assets/archives/zip/bad-crc.zip
new file mode 100644
index 000000000..3413ac65a
Binary files /dev/null and b/tests/assets/archives/zip/bad-crc.zip differ
diff --git a/tests/assets/archives/zip/bad-sizes.zip b/tests/assets/archives/zip/bad-sizes.zip
new file mode 100644
index 000000000..b83c66fe7
Binary files /dev/null and b/tests/assets/archives/zip/bad-sizes.zip differ
diff --git a/tests/assets/archives/zip/different-encryptions.zip b/tests/assets/archives/zip/different-encryptions.zip
new file mode 100644
index 000000000..858e7c74b
Binary files /dev/null and b/tests/assets/archives/zip/different-encryptions.zip differ
diff --git a/tests/assets/archives/zip/empty.zip b/tests/assets/archives/zip/empty.zip
new file mode 100644
index 000000000..15cb0ecb3
Binary files /dev/null and b/tests/assets/archives/zip/empty.zip differ
diff --git a/tests/assets/archives/zip/file-dir-same-name.zip b/tests/assets/archives/zip/file-dir-same-name.zip
new file mode 100644
index 000000000..a0ec6b4bb
Binary files /dev/null and b/tests/assets/archives/zip/file-dir-same-name.zip differ
diff --git a/tests/assets/documents/sample.log b/tests/assets/documents/sample.log
new file mode 100644
index 000000000..ac2fe6425
--- /dev/null
+++ b/tests/assets/documents/sample.log
@@ -0,0 +1 @@
+AssertionFailedError
diff --git a/tests/assets/images/sample.jpg b/tests/assets/images/sample.jpg
new file mode 100644
index 000000000..bf446e435
Binary files /dev/null and b/tests/assets/images/sample.jpg differ
diff --git a/tests/assets/images/sample.svg b/tests/assets/images/sample.svg
new file mode 100644
index 000000000..d367944ec
--- /dev/null
+++ b/tests/assets/images/sample.svg
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
+<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 302 302">
+    <g>
+        <rect y="31" style="fill:#005ECE;" width="302" height="40" />
+        <rect y="231" style="fill:#005ECE;" width="302" height="40" />
+        <rect y="131" style="fill:#005ECE;" width="302" height="40" />
+    </g>
+</svg>
diff --git a/tests/common/com/android/documentsui/DocumentsProviderHelper.java b/tests/common/com/android/documentsui/DocumentsProviderHelper.java
index f68c9258c..a36069d2c 100644
--- a/tests/common/com/android/documentsui/DocumentsProviderHelper.java
+++ b/tests/common/com/android/documentsui/DocumentsProviderHelper.java
@@ -57,7 +57,10 @@ import com.google.common.collect.Lists;
 import libcore.io.Streams;
 
 import java.io.FileNotFoundException;
+import java.io.FileOutputStream;
 import java.io.IOException;
+import java.io.InputStream;
+import java.io.OutputStream;
 import java.util.ArrayList;
 import java.util.List;
 
@@ -145,6 +148,17 @@ public class DocumentsProviderHelper {
         return createDocument(root, Document.MIME_TYPE_DIR, name);
     }
 
+    public void writeDocument(Uri documentUri, InputStream contents)
+            throws RemoteException, IOException {
+        try (ParcelFileDescriptor fd = mClient.openFile(documentUri, "w", null)) {
+            assert fd != null;
+            try (OutputStream out = new FileOutputStream(fd.getFileDescriptor())) {
+                FileUtils.copy(contents, out);
+            }
+        }
+        waitForWrite();
+    }
+
     public void writeDocument(Uri documentUri, byte[] contents)
             throws RemoteException, IOException {
         ParcelFileDescriptor file = mClient.openFile(documentUri, "w", null);
@@ -304,6 +318,25 @@ public class DocumentsProviderHelper {
         return children;
     }
 
+    /** List all the children for the specific `root`. */
+    public List<DocumentInfo> listAllChildren(RootInfo root) throws Exception {
+        List<DocumentInfo> children = new ArrayList<>();
+        try (Cursor cursor =
+                mClient.query(
+                        buildChildDocumentsUri(root.authority, root.documentId),
+                        null,
+                        null,
+                        null,
+                        null,
+                        null)) {
+            Cursor wrapper = new RootCursorWrapper(mUserId, mAuthority, root.rootId, cursor, 100);
+            while (wrapper.moveToNext()) {
+                children.add(DocumentInfo.fromDirectoryCursor(wrapper));
+            }
+        }
+        return children;
+    }
+
     public void assertFileContents(Uri documentUri, byte[] expected) throws Exception {
         MoreAsserts.assertEquals(
                 "Copied file contents differ",
diff --git a/tests/common/com/android/documentsui/TestActivity.java b/tests/common/com/android/documentsui/TestActivity.java
index 5aa3faace..7671fc3b4 100644
--- a/tests/common/com/android/documentsui/TestActivity.java
+++ b/tests/common/com/android/documentsui/TestActivity.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import static junit.framework.Assert.assertEquals;
 
 import static org.mockito.ArgumentMatchers.any;
@@ -54,6 +56,8 @@ import com.android.documentsui.testing.TestSupportLoaderManager;
 
 import org.mockito.Mockito;
 
+import java.util.List;
+
 /**
  * Abstract to avoid having to implement unnecessary Activity stuff.
  * Instances are created using {@link #create()}.
@@ -76,6 +80,8 @@ public abstract class TestActivity extends AbstractBase {
     public TestEventListener<Intent> startService;
     public TestEventListener<Pair<IntentSender, Integer>> startIntentSender;
     public TestEventListener<RootInfo> rootPicked;
+    public TestEventListener<List<DocumentInfo>> documentsPicked;
+    public TestEventListener<DocumentInfo> documentPicked;
     public TestEventListener<Void> restoreRootAndDirectory;
     public TestEventListener<Integer> refreshCurrentRootAndDirectory;
     public TestEventListener<Boolean> setRootsDrawerOpen;
@@ -100,6 +106,8 @@ public abstract class TestActivity extends AbstractBase {
         startService = new TestEventListener<>();
         startIntentSender = new TestEventListener<>();
         rootPicked = new TestEventListener<>();
+        documentsPicked = new TestEventListener<>();
+        documentPicked = new TestEventListener<>();
         restoreRootAndDirectory = new TestEventListener<>();
         refreshCurrentRootAndDirectory =  new TestEventListener<>();
         setRootsDrawerOpen = new TestEventListener<>();
@@ -184,9 +192,20 @@ public abstract class TestActivity extends AbstractBase {
         rootPicked.accept(root);
     }
 
+    @Override
+    public final void onDocumentsPicked(List<DocumentInfo> docs) {
+        if (!isUseMaterial3FlagEnabled()) {
+            throw new UnsupportedOperationException();
+        }
+        documentsPicked.accept(docs);
+    }
+
     @Override
     public final void onDocumentPicked(DocumentInfo doc) {
-        throw new UnsupportedOperationException();
+        if (!isUseMaterial3FlagEnabled()) {
+            throw new UnsupportedOperationException();
+        }
+        documentPicked.accept(doc);
     }
 
     @Override
diff --git a/tests/common/com/android/documentsui/actions/RelaxedClickAction.kt b/tests/common/com/android/documentsui/actions/RelaxedClickAction.kt
new file mode 100644
index 000000000..7638ea4a4
--- /dev/null
+++ b/tests/common/com/android/documentsui/actions/RelaxedClickAction.kt
@@ -0,0 +1,39 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.actions
+
+import android.view.View
+import androidx.test.espresso.UiController
+import androidx.test.espresso.ViewAction
+import androidx.test.espresso.action.ViewActions
+import androidx.test.espresso.matcher.ViewMatchers
+import org.hamcrest.Matcher
+
+/**
+ * A custom action to remove the constraints on requiring 90% of the views area to be covered.
+ * Useful to use on elements (such as menus or search chips which don't fulfill this criteria).
+ */
+class RelaxedClickAction internal constructor() : ViewAction {
+    private val mWrappedClickAction: ViewAction = ViewActions.click()
+
+    override fun getConstraints(): Matcher<View?> = ViewMatchers.isEnabled()
+
+    override fun getDescription(): String? = mWrappedClickAction.description
+
+    override fun perform(uiController: UiController?, view: View?) {
+        mWrappedClickAction.perform(uiController, view)
+    }
+}
diff --git a/tests/common/com/android/documentsui/bots/Bots.java b/tests/common/com/android/documentsui/bots/Bots.java
index f0f69b9cf..5c052e619 100644
--- a/tests/common/com/android/documentsui/bots/Bots.java
+++ b/tests/common/com/android/documentsui/bots/Bots.java
@@ -20,6 +20,8 @@ import static junit.framework.Assert.assertNotNull;
 
 import android.app.UiAutomation;
 import android.content.Context;
+import android.os.SystemClock;
+import android.view.MotionEvent;
 
 import androidx.test.InstrumentationRegistry;
 import androidx.test.uiautomator.By;
@@ -48,12 +50,12 @@ public final class Bots {
     public final UiBot main;
     public final InspectorBot inspector;
     public final NotificationsBot notifications;
-    public final PeekBot peek;
+    public final PickerBot picker;
 
     public Bots(UiDevice device, UiAutomation automation, Context context, int timeout) {
         main = new UiBot(device, context, TIMEOUT);
         breadcrumb = new BreadBot(device, context, TIMEOUT);
-        roots = new SidebarBot(device, context, TIMEOUT);
+        roots = new SidebarBot(device, automation, context, TIMEOUT);
         directory = new DirectoryListBot(device, automation, context, TIMEOUT);
         sort = new SortBot(device, context, TIMEOUT, main);
         keyboard = new KeyboardBot(device, context, TIMEOUT);
@@ -62,7 +64,7 @@ public final class Bots {
         menu = new MenuBot(device, context, TIMEOUT);
         inspector = new InspectorBot(device, context, TIMEOUT);
         notifications = new NotificationsBot(device, context, TIMEOUT);
-        peek = new PeekBot(device, context, TIMEOUT);
+        picker = new PickerBot(device, context, TIMEOUT);
     }
 
     /**
@@ -71,9 +73,9 @@ public final class Bots {
      */
     public static abstract class BaseBot {
         public final UiDevice mDevice;
+        public final String mTargetPackage;
         final Context mContext;
         final int mTimeout;
-        public final String mTargetPackage;
 
         BaseBot(UiDevice device, Context context, int timeout) {
             mDevice = device;
@@ -84,6 +86,55 @@ public final class Bots {
                             .getTargetContext().getPackageName();
         }
 
+        /**
+         * Returns a `MotionEvent` that mocks a right click.
+         * There are 2 ways right clicks are intercepted throughout DocumentsUI:
+         *   1. Via an onClickListener and thus the actions can simply be one of ACTION_DOWN and
+         *      ACTION_UP.
+         *   2. Via an onGenericMotionListener and therefore there needs to be 4 actions,
+         *      ACTION_DOWN, ACTION_BUTTON_PRESS, ACTION_BUTTON_RELEASE and ACTION_UP.
+         */
+        protected static MotionEvent getTestRightClickMotionEvent(int action, int x, int y) {
+            long eventTime = SystemClock.uptimeMillis();
+
+            MotionEvent.PointerProperties[] pp = {new MotionEvent.PointerProperties()};
+            pp[0].clear();
+            pp[0].id = 0;
+            pp[0].toolType = MotionEvent.TOOL_TYPE_MOUSE;
+
+            MotionEvent.PointerCoords[] pointerCoords = {new MotionEvent.PointerCoords()};
+            pointerCoords[0].clear();
+            pointerCoords[0].x = x;
+            pointerCoords[0].y = y;
+            pointerCoords[0].pressure = 0;
+            pointerCoords[0].size = 1;
+
+            MotionEvent event =
+                    MotionEvent.obtain(
+                            eventTime,
+                            eventTime,
+                            action,
+                            1, // pointerCount.
+                            pp,
+                            pointerCoords,
+                            0, // metaState.
+                            MotionEvent.BUTTON_SECONDARY,
+                            1f, // xPrecision.
+                            1f, // yPrecision.
+                            0, // deviceId.
+                            0, // edgeFlags.
+                            android.view.InputDevice.SOURCE_MOUSE,
+                            0 // flags.
+                    );
+
+            if (action == MotionEvent.ACTION_BUTTON_PRESS
+                    || action == MotionEvent.ACTION_BUTTON_RELEASE) {
+                event.setActionButton(MotionEvent.BUTTON_SECONDARY);
+            }
+
+            return event;
+        }
+
         /**
          * Asserts that the specified view or one of its descendents has focus.
          */
diff --git a/tests/common/com/android/documentsui/bots/DirectoryListBot.java b/tests/common/com/android/documentsui/bots/DirectoryListBot.java
index 8884bf0f2..cf817b0a2 100644
--- a/tests/common/com/android/documentsui/bots/DirectoryListBot.java
+++ b/tests/common/com/android/documentsui/bots/DirectoryListBot.java
@@ -16,6 +16,12 @@
 
 package com.android.documentsui.bots;
 
+import static androidx.test.espresso.Espresso.onView;
+import static androidx.test.espresso.action.ViewActions.click;
+import static androidx.test.espresso.matcher.ViewMatchers.isDescendantOfA;
+import static androidx.test.espresso.matcher.ViewMatchers.withContentDescription;
+import static androidx.test.espresso.matcher.ViewMatchers.withId;
+
 import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import static junit.framework.Assert.assertEquals;
@@ -24,12 +30,13 @@ import static junit.framework.Assert.assertNotNull;
 import static junit.framework.Assert.assertTrue;
 import static junit.framework.Assert.fail;
 
+import static org.hamcrest.Matchers.allOf;
+
 import android.app.UiAutomation;
 import android.content.Context;
 import android.graphics.Point;
 import android.graphics.Rect;
 import android.os.SystemClock;
-import android.view.InputDevice;
 import android.view.KeyEvent;
 import android.view.MotionEvent;
 import android.view.View;
@@ -45,6 +52,8 @@ import androidx.test.uiautomator.UiScrollable;
 import androidx.test.uiautomator.UiSelector;
 import androidx.test.uiautomator.Until;
 
+import com.android.documentsui.R;
+
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.List;
@@ -61,7 +70,8 @@ public class DirectoryListBot extends Bots.BaseBot {
     private final String mDirListId;
     private final String mItemRootId;
     private final String mPreviewId;
-    private final String mIconId;
+    private final String mGridSelectionRegionId;
+    private final String mListSelectionRegionId;
 
     private final UiAutomation mAutomation;
 
@@ -73,7 +83,10 @@ public class DirectoryListBot extends Bots.BaseBot {
         mDirListId = mTargetPackage + ":id/dir_list";
         mItemRootId = mTargetPackage + ":id/item_root";
         mPreviewId = mTargetPackage + ":id/preview_icon";
-        mIconId = mTargetPackage + (isUseMaterial3FlagEnabled() ? ":id/icon_wrapper" : ":id/icon");
+        mListSelectionRegionId = mTargetPackage + ":id/icon";
+        mGridSelectionRegionId =
+                mTargetPackage
+                        + (isUseMaterial3FlagEnabled() ? ":id/selection_circle" : ":id/icon");
     }
 
     public void assertDocumentsCount(int count) throws UiObjectNotFoundException {
@@ -184,7 +197,7 @@ public class DirectoryListBot extends Bots.BaseBot {
         Configurator.getInstance().setToolType(toolType);
     }
 
-    public void selectDocument(String label) throws UiObjectNotFoundException {
+    private void selectDocument(String label) throws UiObjectNotFoundException {
         waitForDocument(label);
         UiObject2 selectionHotspot = findSelectionHotspot(label);
         selectionHotspot.click();
@@ -202,6 +215,25 @@ public class DirectoryListBot extends Bots.BaseBot {
         assertSelection(number);
     }
 
+    private BySelector getSelectionRegionSelector() {
+        BySelector selectionRegionSelector = By.res(mGridSelectionRegionId);
+        if (mDevice.findObject(selectionRegionSelector) == null) {
+            selectionRegionSelector = By.res(mListSelectionRegionId);
+        }
+        return selectionRegionSelector;
+    }
+
+    /** Select the first document that has a selectable region in the list or grid view. */
+    public void selectFirstDocument() throws UiObjectNotFoundException {
+        final BySelector list = By.res(mDirListId);
+        final BySelector selectionRegionSelector = getSelectionRegionSelector();
+
+        UiObject2 firstAvailableSelectionHotspot =
+                mDevice.findObject(list).findObject(selectionRegionSelector);
+        firstAvailableSelectionHotspot.click();
+        assertSelection(1);
+    }
+
     public UiObject2 findSelectionHotspot(String label) throws UiObjectNotFoundException {
         final BySelector list = By.res(mDirListId);
 
@@ -210,11 +242,12 @@ public class DirectoryListBot extends Bots.BaseBot {
         final UiSelector docList = findDocumentsListSelector();
         new UiScrollable(docList).scrollIntoView(new UiSelector().text(label));
 
+        final BySelector selectionRegionSelector = getSelectionRegionSelector();
         UiObject2 parent = mDevice.findObject(list).findObject(selector);
         UiObject2 selectionHotspot = null;
         for (int i = 1; i <= MAX_LAYOUT_LEVEL; i++) {
             parent = parent.getParent();
-            selectionHotspot = parent.findObject(By.res(mIconId));
+            selectionHotspot = parent.findObject(selectionRegionSelector);
             if (selectionHotspot != null) {
                 break;
             }
@@ -222,6 +255,18 @@ public class DirectoryListBot extends Bots.BaseBot {
         return selectionHotspot;
     }
 
+    /**
+     * Clicks the "X" cancel selection button.
+     */
+    public void clearSelection() {
+        int parentId = isUseMaterial3FlagEnabled()
+                ? R.id.selection_bar : androidx.appcompat.R.id.action_mode_bar;
+        int contentDescription = isUseMaterial3FlagEnabled()
+                ? R.string.clear_selection : android.R.string.cancel;
+        onView(allOf(withContentDescription(contentDescription),
+                isDescendantOfA(withId(parentId)))).perform(click());
+    }
+
     public void pasteFilesFromClipboard() {
         mDevice.pressKeyCode(KeyEvent.KEYCODE_V, KeyEvent.META_CTRL_ON);
     }
@@ -327,61 +372,18 @@ public class DirectoryListBot extends Bots.BaseBot {
     }
 
     public void rightClickDocument(Point point) throws UiObjectNotFoundException {
-        //TODO: Use Espresso instead of doing the events mock ourselves
-        MotionEvent motionDown = getTestMotionEvent(
-                MotionEvent.ACTION_DOWN,
-                MotionEvent.BUTTON_SECONDARY,
-                MotionEvent.TOOL_TYPE_MOUSE,
-                InputDevice.SOURCE_MOUSE,
-                point.x,
-                point.y);
+        // TODO: Use Espresso instead of doing the events mock ourselves
+        MotionEvent motionDown =
+                getTestRightClickMotionEvent(MotionEvent.ACTION_DOWN, point.x, point.y);
         mAutomation.injectInputEvent(motionDown, true);
         SystemClock.sleep(100);
 
-        MotionEvent motionUp = getTestMotionEvent(
-                MotionEvent.ACTION_UP,
-                MotionEvent.BUTTON_SECONDARY,
-                MotionEvent.TOOL_TYPE_MOUSE,
-                InputDevice.SOURCE_MOUSE,
-                point.x,
-                point.y);
+        MotionEvent motionUp =
+                getTestRightClickMotionEvent(MotionEvent.ACTION_UP, point.x, point.y);
 
         mAutomation.injectInputEvent(motionUp, true);
     }
 
-    private MotionEvent getTestMotionEvent(
-            int action, int buttonState, int toolType, int source, int x, int y) {
-        long eventTime = SystemClock.uptimeMillis();
-
-        MotionEvent.PointerProperties[] pp = {new MotionEvent.PointerProperties()};
-        pp[0].clear();
-        pp[0].id = 0;
-        pp[0].toolType = toolType;
-
-        MotionEvent.PointerCoords[] pointerCoords = {new MotionEvent.PointerCoords()};
-        pointerCoords[0].clear();
-        pointerCoords[0].x = x;
-        pointerCoords[0].y = y;
-        pointerCoords[0].pressure = 0;
-        pointerCoords[0].size = 1;
-
-        return MotionEvent.obtain(
-                eventTime,
-                eventTime,
-                action,
-                1,
-                pp,
-                pointerCoords,
-                0,
-                buttonState,
-                1f,
-                1f,
-                0,
-                0,
-                source,
-                0);
-    }
-
     private void assertOrder(String first, String second) throws UiObjectNotFoundException {
 
         final UiObject firstObj = findDocument(first);
diff --git a/tests/common/com/android/documentsui/bots/PeekBot.kt b/tests/common/com/android/documentsui/bots/PeekBot.kt
index 6906d5a1a..f3fce0360 100644
--- a/tests/common/com/android/documentsui/bots/PeekBot.kt
+++ b/tests/common/com/android/documentsui/bots/PeekBot.kt
@@ -16,35 +16,110 @@
 package com.android.documentsui.bots
 
 import android.content.Context
+import android.widget.FrameLayout
+import androidx.coordinatorlayout.widget.CoordinatorLayout
+import androidx.test.espresso.Espresso.onView
+import androidx.test.espresso.ViewAssertion
+import androidx.test.espresso.action.ViewActions
+import androidx.test.espresso.assertion.ViewAssertions.matches
+import androidx.test.espresso.matcher.ViewMatchers
+import androidx.test.espresso.matcher.ViewMatchers.isAssignableFrom
+import androidx.test.espresso.matcher.ViewMatchers.isDescendantOfA
+import androidx.test.espresso.matcher.ViewMatchers.isDisplayed
+import androidx.test.espresso.matcher.ViewMatchers.withContentDescription
+import androidx.test.espresso.matcher.ViewMatchers.withEffectiveVisibility
+import androidx.test.espresso.matcher.ViewMatchers.withId
+import androidx.test.espresso.matcher.ViewMatchers.withText
 import androidx.test.uiautomator.UiDevice
-import androidx.test.uiautomator.UiObject
-import junit.framework.Assert.assertFalse
+import com.android.documentsui.R
+import com.google.android.material.appbar.MaterialToolbar
+import com.google.android.material.sidesheet.SideSheetBehavior
+import junit.framework.Assert.assertEquals
 import junit.framework.Assert.assertTrue
+import org.hamcrest.CoreMatchers.allOf
 
 /**
- * A test helper class that provides support for controlling the peek overlay
- * and making assertions against the state of it.
+ * A test helper class that provides support for controlling the peek overlay and making assertions
+ * against the state of it.
  */
-class PeekBot(
-    device: UiDevice,
-    context: Context,
-    timeout: Int
-) : Bots.BaseBot(device, context, timeout) {
+class PeekBot(device: UiDevice, context: Context, timeout: Int) :
+    Bots.BaseBot(device, context, timeout) {
+    private val peekOverlayMatcher = withId(R.id.peek_overlay)
+    private val peekContainerMatcher =
+        allOf(withId(R.id.peek_container), isDescendantOfA(peekOverlayMatcher))
+    private val toolbarMatcher =
+        allOf(isAssignableFrom(MaterialToolbar::class.java), withId(R.id.peek_toolbar))
+    private val metadataContainerMatcher =
+        allOf(withId(R.id.peek_metadata_container), isDescendantOfA(peekContainerMatcher))
 
-    private val mOverlayId: String = "$mTargetPackage:id/peek_overlay"
-    private val mContainerId: String = "$mTargetPackage:id/peek_container"
+    /**
+     * Validates the metadata sheet's expanded state. Assertion made on the metadata sheet
+     * container.
+     */
+    private fun metadataSheetExpandedStateAssertion(expectExpanded: Boolean): ViewAssertion {
+        return ViewAssertion { view, noViewFoundException ->
+            if (view == null) {
+                throw noViewFoundException
+            }
+            val metadataSheetBehavior = SideSheetBehavior.from(view)
+            assertEquals(
+                if (expectExpanded) {
+                    SideSheetBehavior.STATE_EXPANDED
+                } else {
+                    SideSheetBehavior.STATE_HIDDEN
+                },
+                metadataSheetBehavior.state
+            )
+        }
+    }
 
-    fun assertPeekActive() {
-        val peekContainer = findPeekContainer()
-        assertTrue(peekContainer.exists())
+    /**
+     * Validates that if the metadata sheet is expanded, the preview container is resized so that it
+     * doesn't overlap with the metadata sheet. Assertion made on the root of the Peek fragment.
+     */
+    private fun metadataSheetWidthAssertion(expectExpanded: Boolean): ViewAssertion {
+        return ViewAssertion { rootView, noViewFoundException ->
+            if (rootView == null) {
+                throw noViewFoundException
+            }
+            val previewContainer = rootView.findViewById<FrameLayout>(R.id.peek_preview_container)
+            val metadataContainer = rootView.findViewById<FrameLayout>(R.id.peek_metadata_container)
+            assertTrue(rootView is CoordinatorLayout)
+            assertTrue(metadataContainer.width > 0)
+            assertEquals(
+                rootView.width,
+                if (expectExpanded) {
+                    previewContainer.width + metadataContainer.width
+                } else {
+                    previewContainer.width
+                }
+            )
+        }
     }
 
     fun assertPeekHidden() {
-        val peekContainer = findPeekContainer()
-        assertFalse(peekContainer.exists())
+        onView(peekOverlayMatcher)
+            .check(matches(withEffectiveVisibility(ViewMatchers.Visibility.GONE)))
+    }
+
+    fun assertPeekActive() {
+        onView(peekContainerMatcher).check(matches(isDisplayed()))
+    }
+
+    fun assertHasTitle(title: String) {
+        onView(allOf(withText(title), isDescendantOfA(peekContainerMatcher)))
+            .check(matches(isDisplayed()))
+    }
+
+    fun validateMetadataSheetState(expectExpanded: Boolean) {
+        mDevice.waitForIdle()
+        onView(metadataContainerMatcher).check(metadataSheetExpandedStateAssertion(expectExpanded))
+        onView(peekContainerMatcher).check(metadataSheetWidthAssertion(expectExpanded))
     }
 
-    fun findPeekContainer(): UiObject {
-        return findObject(mOverlayId, mContainerId)
+    fun hide() {
+        onView(allOf(withContentDescription("Hide file preview"), isDescendantOfA(toolbarMatcher)))
+            .perform(ViewActions.click())
+        assertPeekHidden()
     }
 }
diff --git a/tests/common/com/android/documentsui/bots/PickerBot.kt b/tests/common/com/android/documentsui/bots/PickerBot.kt
new file mode 100644
index 000000000..7de68e43a
--- /dev/null
+++ b/tests/common/com/android/documentsui/bots/PickerBot.kt
@@ -0,0 +1,110 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.bots
+
+import android.content.Context
+import androidx.test.espresso.Espresso.onView
+import androidx.test.espresso.action.ViewActions.click
+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist
+import androidx.test.espresso.assertion.ViewAssertions.matches
+import androidx.test.espresso.matcher.ViewMatchers.isDisplayed
+import androidx.test.espresso.matcher.ViewMatchers.isEnabled
+import androidx.test.espresso.matcher.ViewMatchers.isNotEnabled
+import androidx.test.espresso.matcher.ViewMatchers.withId
+import androidx.test.uiautomator.UiDevice
+import com.android.documentsui.R
+import com.android.documentsui.bots.Bots.BaseBot
+import com.android.documentsui.util.Material3Config.Companion.getRes
+
+/**
+ * A test helper class that provides support for controlling picker activities
+ * programmatically, and making assertions against the state of the UI.
+ */
+class PickerBot(device: UiDevice?, context: Context?, timeout: Int) : BaseBot(
+    device,
+    context,
+    timeout
+) {
+    /**
+     * Clicks the save button with id button1
+     */
+    fun clickSaveButton() {
+        onView(withId(android.R.id.button1)).perform(click())
+    }
+
+    /**
+     * Checks that the pick button doesn't exist.
+     */
+    fun checkPickButtonDoesNotExist() {
+        onView(withId(getRes(R.id.button_pick))).check(doesNotExist())
+    }
+
+    /**
+     * Checks that the cancel button doesn't exist.
+     */
+    fun checkCancelButtonDoesNotExist() {
+        onView(withId(getRes(R.id.button_cancel))).check(doesNotExist())
+    }
+
+    /**
+     * Checks that the pick button is shown.
+     */
+    fun checkPickButtonDisplayed() {
+        onView(withId(getRes(R.id.button_pick))).check(matches(isDisplayed()))
+    }
+
+    /**
+     * Checks that the cancel button is shown.
+     */
+    fun checkCancelButtonDisplayed() {
+        onView(withId(getRes(R.id.button_cancel))).check(matches(isDisplayed()))
+    }
+
+    /**
+     * Checks that the pick button is enabled.
+     */
+    fun checkPickButtonEnabled() {
+        onView(withId(getRes(R.id.button_pick))).check(matches(isEnabled()))
+    }
+
+    /**
+     * Checks that the cancel button is enabled.
+     */
+    fun checkCancelButtonEnabled() {
+        onView(withId(getRes(R.id.button_cancel))).check(matches(isEnabled()))
+    }
+
+    /**
+     * Checks that the pick button is disabled.
+     */
+    fun checkPickButtonDisabled() {
+        onView(withId(getRes(R.id.button_pick))).check(matches(isNotEnabled()))
+    }
+
+    /**
+     * Clicks the pick button.
+     */
+    fun clickPickButton() {
+        onView(withId(getRes(R.id.button_pick))).perform(click())
+    }
+
+    /**
+     * Clicks the cancel button.
+     */
+    fun clickCancelButton() {
+        onView(withId(getRes(R.id.button_cancel))).perform(click())
+    }
+}
diff --git a/tests/common/com/android/documentsui/bots/SearchBot.java b/tests/common/com/android/documentsui/bots/SearchBot.java
index bde74cab7..52fa494bc 100644
--- a/tests/common/com/android/documentsui/bots/SearchBot.java
+++ b/tests/common/com/android/documentsui/bots/SearchBot.java
@@ -33,10 +33,13 @@ import static org.hamcrest.CoreMatchers.anyOf;
 import android.content.Context;
 import android.view.View;
 
+import androidx.test.uiautomator.By;
+import androidx.test.uiautomator.BySelector;
 import androidx.test.uiautomator.UiDevice;
 import androidx.test.uiautomator.UiObject;
 import androidx.test.uiautomator.UiObjectNotFoundException;
 import androidx.test.uiautomator.UiSelector;
+import androidx.test.uiautomator.Until;
 
 import com.android.documentsui.R;
 
@@ -56,26 +59,29 @@ public class SearchBot extends Bots.BaseBot {
             withId(R.id.option_menu_search),
             anyOf(isClickable(), hasDescendant(isClickable())));
 
-    // Note that input is visible when the clicky button is not
-    // present. So to clearly qualify the two...we explicitly
-    // require this input be not clickable.
-    @SuppressWarnings("unchecked")
-    private static final Matcher<View> SEARCH_INPUT = allOf(
-            withId(androidx.appcompat.R.id.search_src_text),
-            isDisplayed());
-
     public SearchBot(UiDevice device, Context context, int timeout) {
         super(device, context, timeout);
     }
 
-    public void clickIcon() throws UiObjectNotFoundException {
-        UiObject searchView = findSearchView();
-        searchView.click();
+    public void expand() throws UiObjectNotFoundException {
+        if (!showsDockedSearch()) {
+            UiObject searchView = findObject(mTargetPackage + ":id/option_menu_search");
+            searchView.click();
+        } else {
+            findDockedSearchInput().click();
+        }
     }
 
     public void clickSearchViewClearButton() throws UiObjectNotFoundException {
-        UiObject clear = findSearchViewClearButton();
-        clear.click();
+        if (!showsDockedSearch()) {
+            UiObject clear = findObject(mTargetPackage + ":id/option_menu_search",
+                    mTargetPackage + ":id/search_close_btn");
+            clear.click();
+        } else {
+            UiObject clear = findObject(mTargetPackage + ":id/option_menu_docked_search",
+                    mTargetPackage + ":id/docked_search_clear");
+            clear.click();
+        }
     }
 
     // Click on the search history item with specified queryText, if exists.
@@ -86,7 +92,38 @@ public class SearchBot extends Bots.BaseBot {
     }
 
     public void setInputText(String query) throws UiObjectNotFoundException {
-        onView(SEARCH_INPUT).perform(typeText(query));
+        if (!showsDockedSearch()) {
+            BySelector selector = By.res(mTargetPackage + ":id/search_src_text");
+            mDevice.wait(Until.findObject(selector), 5000);
+            onView(allOf(withId(androidx.appcompat.R.id.search_src_text), isDisplayed()))
+                    .perform(typeText(query));
+        } else {
+            BySelector selector = By.res(mTargetPackage + ":id/docked_search_text");
+            mDevice.wait(Until.findObject(selector), 5000);
+            onView(allOf(withId(R.id.docked_search_text), isDisplayed())).perform(typeText(query));
+        }
+    }
+
+    public void assertIsExpanded(boolean expanded) throws UiObjectNotFoundException {
+        if (!showsDockedSearch()) {
+            assertIconVisible(!expanded);
+            assertEquals(expanded, findSearchViewTextField().exists());
+        } else {
+            assertTrue(findDockedSearchInput().exists());
+        }
+    }
+
+    public void assertIsVisible(boolean visible) throws UiObjectNotFoundException {
+        if (!showsDockedSearch()) {
+            assertIconVisible(visible);
+            // Only look for input when asserting invisible. Input visibility is checked with
+            // assertIsExpanded.
+            if (!visible) {
+                assertFalse(findSearchViewTextField().exists());
+            }
+        } else {
+            assertEquals(visible, findDockedSearchInput().exists());
+        }
     }
 
     public void assertIconVisible(boolean visible) {
@@ -115,7 +152,12 @@ public class SearchBot extends Bots.BaseBot {
 
     public void assertInputEquals(String query)
             throws UiObjectNotFoundException {
-        UiObject textField = findSearchViewTextField();
+        UiObject textField;
+        if (showsDockedSearch()) {
+            textField = findDockedSearchInput();
+        } else {
+            textField = findSearchViewTextField();
+        }
 
         assertTrue(textField.exists());
         assertEquals(query, textField.getText());
@@ -123,21 +165,17 @@ public class SearchBot extends Bots.BaseBot {
 
     public void assertInputFocused(boolean focused)
             throws UiObjectNotFoundException {
-        UiObject textField = findSearchViewTextField();
+        UiObject textField;
+        if (showsDockedSearch()) {
+            textField = findDockedSearchInput();
+        } else {
+            textField = findSearchViewTextField();
+        }
 
         assertTrue(textField.exists());
         assertEquals(focused, textField.isFocused());
     }
 
-    public void assertInputExists(boolean exists)
-            throws UiObjectNotFoundException {
-        assertEquals(exists, findSearchViewTextField().exists());
-    }
-
-    private UiObject findSearchView() {
-        return findObject(mTargetPackage + ":id/option_menu_search");
-    }
-
     private UiObject findSearchHistoryView() {
         return findObject(mTargetPackage + ":id/history_list");
     }
@@ -147,15 +185,11 @@ public class SearchBot extends Bots.BaseBot {
                 mTargetPackage + ":id/search_src_text");
     }
 
-    private UiObject findSearchViewClearButton() {
-        return findObject(mTargetPackage + ":id/option_menu_search",
-                mTargetPackage + ":id/search_close_btn");
+    private UiObject findDockedSearchInput() {
+        return findObject(mTargetPackage + ":id/docked_search_text");
     }
 
-    private UiObject findSearchViewIcon() {
-        return mContext.getResources().getBoolean(R.bool.full_bar_search_view)
-                ? findObject(mTargetPackage + ":id/option_menu_search")
-                : findObject(mTargetPackage + ":id/option_menu_search",
-                        "android:id/search_button");
+    private boolean showsDockedSearch() {
+        return mContext.getResources().getBoolean(R.bool.show_docked_search);
     }
 }
diff --git a/tests/common/com/android/documentsui/bots/SidebarBot.java b/tests/common/com/android/documentsui/bots/SidebarBot.java
index 01f311a7f..762c8fc1e 100644
--- a/tests/common/com/android/documentsui/bots/SidebarBot.java
+++ b/tests/common/com/android/documentsui/bots/SidebarBot.java
@@ -17,12 +17,21 @@
 package com.android.documentsui.bots;
 
 import static androidx.test.espresso.Espresso.onView;
+import static androidx.test.espresso.action.ViewActions.click;
 import static androidx.test.espresso.action.ViewActions.swipeLeft;
 import static androidx.test.espresso.action.ViewActions.swipeRight;
+import static androidx.test.espresso.matcher.ViewMatchers.isDescendantOfA;
 import static androidx.test.espresso.matcher.ViewMatchers.withId;
+import static androidx.test.espresso.matcher.ViewMatchers.withText;
 
+import static org.hamcrest.Matchers.allOf;
+
+import android.app.UiAutomation;
 import android.content.Context;
+import android.graphics.Rect;
+import android.os.SystemClock;
 import android.util.Log;
+import android.view.MotionEvent;
 import android.view.View;
 
 import androidx.test.uiautomator.UiDevice;
@@ -32,6 +41,7 @@ import androidx.test.uiautomator.UiScrollable;
 import androidx.test.uiautomator.UiSelector;
 
 import com.android.documentsui.R;
+import com.android.documentsui.actions.RelaxedClickAction;
 
 import junit.framework.Assert;
 
@@ -47,9 +57,11 @@ public class SidebarBot extends Bots.BaseBot {
     private static final String TAG = "RootsListBot";
 
     private final String mRootListId;
+    private final UiAutomation mAutomation;
 
-    public SidebarBot(UiDevice device, Context context, int timeout) {
+    public SidebarBot(UiDevice device, UiAutomation automation, Context context, int timeout) {
         super(device, context, timeout);
+        mAutomation = automation;
         mRootListId = mTargetPackage + ":id/roots_list";
     }
 
@@ -57,9 +69,10 @@ public class SidebarBot extends Bots.BaseBot {
         // We might need to expand drawer if not visible
         openDrawer();
 
-        final UiSelector rootsList = new UiSelector().resourceId(
-                mTargetPackage + ":id/container_roots").childSelector(
-                new UiSelector().resourceId(mRootListId));
+        final UiSelector rootsList =
+                new UiSelector()
+                        .resourceIdMatches(mTargetPackage + ":id/.*container_roots")
+                        .childSelector(new UiSelector().resourceId(mRootListId));
 
         // Wait for the first list item to appear
         new UiObject(rootsList.childSelector(new UiSelector())).waitForExists(mTimeout);
@@ -69,16 +82,43 @@ public class SidebarBot extends Bots.BaseBot {
         return new UiObject(rootsList.childSelector(new UiSelector().text(label)));
     }
 
+    /** Open navigation root either from the Drawer or the Navigation rail. */
     public void openRoot(String label) throws UiObjectNotFoundException {
         findRoot(label).click();
         // Close the drawer in case we select a pre-selected root already
         closeDrawer();
     }
 
+    /**
+     * Use openRoot above for general usage, which caters both the navigation rail and the drawer,
+     * only use openNavRailRoot if you want to open root explicitly from the navigation rail.
+     */
+    public void openNavRailRoot(String label) throws UiObjectNotFoundException {
+        // Use UiScrollable to scroll into the view.
+        final UiSelector rootsList =
+                new UiSelector()
+                        .resourceId(mTargetPackage + ":id/nav_rail_container_roots")
+                        .childSelector(new UiSelector().resourceId(mRootListId));
+        new UiObject(rootsList.childSelector(new UiSelector())).waitForExists(mTimeout);
+        new UiScrollable(rootsList).scrollIntoView(new UiSelector().text(label));
+
+        // Use Espresso to click.
+        onView(allOf(withText(label), isDescendantOfA(withId(R.id.nav_rail_container_roots))))
+                .perform(click());
+    }
+
+    /** Open navigation drawer from the burger menu button within the navigation rail layout. */
+    public void openDrawerFromNavRail() {
+        onView(withId(R.id.nav_rail_burger_menu)).perform(click());
+    }
+
     public void openDrawer() throws UiObjectNotFoundException {
-        final UiSelector rootsList = new UiSelector().resourceId(
-                mTargetPackage + ":id/container_roots").childSelector(
-                new UiSelector().resourceId(mRootListId));
+        // Let's check for `nav_rail_container_roots` as well as `container_roots` to avoid opening
+        // the drawer in nav rail layout.
+        final UiSelector rootsList =
+                new UiSelector()
+                        .resourceIdMatches(mTargetPackage + ":id/.*container_roots")
+                        .childSelector(new UiSelector().resourceId(mRootListId));
 
         // We might need to expand drawer if not visible
         if (!new UiObject(rootsList).waitForExists(mTimeout)) {
@@ -135,4 +175,38 @@ public class SidebarBot extends Bots.BaseBot {
     public void assertHasFocus() {
         assertHasFocus(mRootListId);
     }
+
+    /** Right clicks a root with `label` and then clicks the `menuOption`. */
+    public void rightClickRootAndClickMenuOption(String rootLabel, String menuOption)
+            throws UiObjectNotFoundException {
+        Rect point = findRoot(rootLabel).getVisibleBounds();
+
+        // The RootsFragment listens to right clicks in the GenericMotionListener. This is to allow
+        // for a left and right click to be used interchangeably. This means to mock this behaviour,
+        // 4 input events needs to be synthesized. A down, button press, button release and an up.
+        MotionEvent motionDown =
+                getTestRightClickMotionEvent(
+                        MotionEvent.ACTION_DOWN, point.centerX(), point.centerY());
+        mAutomation.injectInputEvent(motionDown, true);
+        SystemClock.sleep(25);
+
+        MotionEvent motionButtonPress =
+                getTestRightClickMotionEvent(
+                        MotionEvent.ACTION_BUTTON_PRESS, point.centerX(), point.centerY());
+        mAutomation.injectInputEvent(motionButtonPress, true);
+        SystemClock.sleep(25);
+
+        MotionEvent motionButtonRelease =
+                getTestRightClickMotionEvent(
+                        MotionEvent.ACTION_BUTTON_RELEASE, point.centerX(), point.centerY());
+        mAutomation.injectInputEvent(motionButtonRelease, true);
+        SystemClock.sleep(25);
+
+        MotionEvent motionUp =
+                getTestRightClickMotionEvent(
+                        MotionEvent.ACTION_UP, point.centerX(), point.centerY());
+        mAutomation.injectInputEvent(motionUp, true);
+
+        onView(withText(menuOption)).perform(new RelaxedClickAction());
+    }
 }
diff --git a/tests/common/com/android/documentsui/bots/SortBot.java b/tests/common/com/android/documentsui/bots/SortBot.java
index f72f16f86..c590b130c 100644
--- a/tests/common/com/android/documentsui/bots/SortBot.java
+++ b/tests/common/com/android/documentsui/bots/SortBot.java
@@ -73,7 +73,7 @@ public class SortBot extends Bots.BaseBot {
         final @StringRes int labelId = mSortModel.getDimensionById(id).getLabelId();
         final String label = mContext.getString(labelId);
         final boolean result;
-        if (isHeaderShow()) {
+        if (isSortHeaderShown(label)) {
             result = mColumnBot.sortBy(label, direction);
         } else {
             result = sortByMenu(id, direction);
@@ -82,8 +82,10 @@ public class SortBot extends Bots.BaseBot {
         assertTrue("Sorting by id: " + id + " in direction: " + direction + " failed.", result);
     }
 
-    public boolean isHeaderShow() {
-        return Matchers.present(ColumnSortBot.MATCHER);
+    /** Check if the appropriate sort header is shown */
+    public boolean isSortHeaderShown(String label) {
+        return Matchers.present(
+                allOf(withChild(withText(label)), isDescendantOfA(ColumnSortBot.MATCHER)));
     }
 
     public void assertHeaderHide() {
diff --git a/tests/common/com/android/documentsui/bots/UiBot.java b/tests/common/com/android/documentsui/bots/UiBot.java
index 47e0acd5a..c0d575d44 100644
--- a/tests/common/com/android/documentsui/bots/UiBot.java
+++ b/tests/common/com/android/documentsui/bots/UiBot.java
@@ -21,7 +21,9 @@ import static androidx.test.espresso.action.ViewActions.click;
 import static androidx.test.espresso.assertion.ViewAssertions.matches;
 import static androidx.test.espresso.matcher.ViewMatchers.hasFocus;
 import static androidx.test.espresso.matcher.ViewMatchers.isAssignableFrom;
+import static androidx.test.espresso.matcher.ViewMatchers.isDisplayed;
 import static androidx.test.espresso.matcher.ViewMatchers.withClassName;
+import static androidx.test.espresso.matcher.ViewMatchers.withEffectiveVisibility;
 import static androidx.test.espresso.matcher.ViewMatchers.withId;
 import static androidx.test.espresso.matcher.ViewMatchers.withText;
 
@@ -30,7 +32,6 @@ import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 import static junit.framework.Assert.assertEquals;
 import static junit.framework.Assert.assertNotNull;
 import static junit.framework.Assert.assertNull;
-import static junit.framework.Assert.assertTrue;
 
 import static org.hamcrest.CoreMatchers.allOf;
 import static org.hamcrest.CoreMatchers.is;
@@ -117,10 +118,40 @@ public class UiBot extends Bots.BaseBot {
                 .check(matches(withToolbarTitle(is(expected))));
     }
 
+    /**
+     * Checks that the search bar is visible.
+     */
     public void assertSearchBarShow() {
-        UiSelector selector = new UiSelector().text(mContext.getString(R.string.search_bar_hint));
-        UiObject searchHint = mDevice.findObject(selector);
-        assertTrue(searchHint.exists());
+        onView(withId(R.id.searchbar_title)).check(matches(isDisplayed()));
+    }
+
+    /**
+     * Checks that the search bar is not visible.
+     */
+    public void assertSearchBarGone() {
+        onView(withId(R.id.searchbar_title)).check(
+                matches(withEffectiveVisibility(ViewMatchers.Visibility.GONE)));
+    }
+
+    /**
+     * Checks that the UI chip that toggles location search menu is visible.
+     */
+    public void assertLocationTriggerShows() {
+        onView(withId(R.id.search_location_trigger)).check(matches(isDisplayed()));
+    }
+
+    /**
+     * Checks that the UI chip that toggles last modified menu is visible.
+     */
+    public void assertLastModifiedTriggerShows() {
+        onView(withId(R.id.search_last_modified_trigger)).check(matches(isDisplayed()));
+    }
+
+    /**
+     * Checks that the UI chip that toggles file type menu is visible.
+     */
+    public void assertFileTypeTriggerShows() {
+        onView(withId(R.id.search_file_type_trigger)).check(matches(isDisplayed()));
     }
 
     public void assertMenuEnabled(int id, boolean enabled) {
@@ -154,6 +185,24 @@ public class UiBot extends Bots.BaseBot {
                 .check(matches(withText(is(expected))));
     }
 
+    /**
+     * Checks that the current view state is in list mode.
+     */
+    public void assertInListMode() {
+        // In list mode, there should be the grid mode button that is visible.
+        final UiObject2 gridModeBtn = menuGridMode();
+        assertNotNull(gridModeBtn);
+    }
+
+    /**
+     * Checks that the current view state is in grid mode.
+     */
+    public void assertInGridMode() {
+        // In grid mode, there should be the list mode button that is visible.
+        final UiObject2 listModeBtn = menuListMode();
+        assertNotNull(listModeBtn);
+    }
+
     public boolean inFixedLayout() {
         TypedValue val = new TypedValue();
         // We alias files_activity to either fixed or drawer layouts based
@@ -216,6 +265,7 @@ public class UiBot extends Bots.BaseBot {
         } else {
             onView(ACTIONBAR_OVERFLOW).perform(click());
         }
+        mDevice.waitForIdle();
         // Click the item by label, since Espresso doesn't support lookup by id on overflow.
         onView(withText(label)).perform(click());
     }
@@ -226,10 +276,6 @@ public class UiBot extends Bots.BaseBot {
         onView(withText(label)).perform(click());
     }
 
-    public void clickSaveButton() {
-        onView(withId(android.R.id.button1)).perform(click());
-    }
-
     public boolean waitForActionModeBarToAppear() {
         String actionModeId = isUseMaterial3FlagEnabled() ? "toolbar" : "action_mode_bar";
         UiObject2 bar =
@@ -280,18 +326,30 @@ public class UiBot extends Bots.BaseBot {
         onView(withId(android.R.id.button1)).check(matches(hasFocus()));
     }
 
-    public void clickDialogOkButton() {
-        // Espresso has flaky results when keyboard shows up, so hiding it for now
-        // before trying to click on any dialog button
-        Espresso.closeSoftKeyboard();
+    /** Clicks the OK button on a dialog. */
+    public void clickDialogOkButton(boolean closeSoftKeyboard) {
+        // On dialogs with no text input, a soft keyboard doesn't show up at all and attempting to
+        // close it causes failures. Let's be intentional about the closure only on dialogs which
+        // have text input.
+        if (closeSoftKeyboard) {
+            // Espresso has flaky results when keyboard shows up, so hiding it for now
+            // before trying to click on any dialog button
+            Espresso.closeSoftKeyboard();
+        }
         UiObject2 okButton = mDevice.findObject(By.res("android:id/button1"));
         okButton.click();
     }
 
-    public void clickDialogCancelButton() throws UiObjectNotFoundException {
-        // Espresso has flaky results when keyboard shows up, so hiding it for now
-        // before trying to click on any dialog button
-        Espresso.closeSoftKeyboard();
+    /** Clicks the Cancel button on a dialog. */
+    public void clickDialogCancelButton(boolean closeSoftKeyboard) {
+        // On dialogs with no text input, a soft keyboard doesn't show up at all and attempting to
+        // close it causes failures. Let's be intentional about the closure only on dialogs which
+        // have text input.
+        if (closeSoftKeyboard) {
+            // Espresso has flaky results when keyboard shows up, so hiding it for now
+            // before trying to click on any dialog button
+            Espresso.closeSoftKeyboard();
+        }
         UiObject2 okButton = mDevice.findObject(By.res("android:id/button2"));
         okButton.click();
     }
diff --git a/tests/common/com/android/documentsui/conditions/HasChildCountCondition.kt b/tests/common/com/android/documentsui/conditions/HasChildCountCondition.kt
new file mode 100644
index 000000000..f4d380d63
--- /dev/null
+++ b/tests/common/com/android/documentsui/conditions/HasChildCountCondition.kt
@@ -0,0 +1,46 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.conditions
+
+import androidx.test.uiautomator.UiObject2
+import androidx.test.uiautomator.UiObject2Condition
+
+/**
+ * A UI Automator condition that is met when the UiObject2 that it is acting on has the number of
+ * children elements that matches the supplied `predicate`. The companion object contains some
+ * shorthand helpers for common cases. The object that it is checking the child count of must exist.
+ */
+class HasChildCountCondition(
+    private val predicate: (count: Int) -> Boolean
+) : UiObject2Condition<Boolean>() {
+    override fun apply(o: UiObject2?): Boolean? {
+        requireNotNull(o) { "Supplied object to validate for child count must exist" }
+        return predicate(o.childCount)
+    }
+
+    companion object {
+        @JvmStatic
+        fun hasOneChild(): HasChildCountCondition {
+            return HasChildCountCondition({ it == 1 })
+        }
+
+        @JvmStatic
+        fun hasMoreThanOneChild(): HasChildCountCondition {
+            return HasChildCountCondition({ it > 1 })
+        }
+    }
+}
diff --git a/tests/common/com/android/documentsui/dirlist/TestEnvironment.java b/tests/common/com/android/documentsui/dirlist/TestEnvironment.java
index 2e91e0733..b490bbe23 100644
--- a/tests/common/com/android/documentsui/dirlist/TestEnvironment.java
+++ b/tests/common/com/android/documentsui/dirlist/TestEnvironment.java
@@ -29,11 +29,13 @@ public final class TestEnvironment implements DocumentsAdapter.Environment {
     private final Context testContext;
     private final TestEnv mEnv;
     private final ActionHandler mActionHandler;
+    private boolean mInSearchMode;
 
     public TestEnvironment(Context testContext, TestEnv env, ActionHandler actionHandler) {
         this.testContext = testContext;
         mEnv = env;
         mActionHandler = actionHandler;
+        mInSearchMode = false;
     }
 
     @Override
@@ -72,7 +74,7 @@ public final class TestEnvironment implements DocumentsAdapter.Environment {
 
     @Override
     public boolean isInSearchMode() {
-        return false;
+        return mInSearchMode;
     }
 
     @Override
@@ -89,8 +91,7 @@ public final class TestEnvironment implements DocumentsAdapter.Environment {
     public void onBindDocumentHolder(DocumentHolder holder, Cursor cursor) {
     }
 
-    @Override
-    public String getCallingAppName() {
-        return "unknown";
+    public void setInSearchMode(boolean inSearchMode) {
+        mInSearchMode = inSearchMode;
     }
 }
diff --git a/tests/common/com/android/documentsui/rules/CheckAndForceMaterial3Flag.kt b/tests/common/com/android/documentsui/rules/CheckAndForceMaterial3Flag.kt
new file mode 100644
index 000000000..27ef9f0a1
--- /dev/null
+++ b/tests/common/com/android/documentsui/rules/CheckAndForceMaterial3Flag.kt
@@ -0,0 +1,62 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.rules
+
+import android.platform.test.flag.junit.AnnotationsRetriever
+import android.platform.test.flag.junit.DeviceFlagsValueProvider
+import android.platform.test.flag.junit.IFlagsValueProvider
+import com.android.documentsui.flags.Flags
+import com.android.documentsui.util.Material3Config
+import org.junit.rules.TestRule
+import org.junit.runner.Description
+import org.junit.runners.model.Statement
+
+/**
+ * A TestRule that checks for the flag like the `CheckFlagsRule`, but this also overrides the config
+ * `force_material3` to sync with the desired state of the flag `use_material3`.
+ *
+ * @RequiresFlagsEnabled(FLAG_USE_MATERIAL3) => forces the config `force_material3` to true.
+ * @RequiresFlagsDisabled(FLAG_USE_MATERIAL3) => forces the config `force_material3` to false.
+ */
+class CheckAndForceMaterial3Flag : TestRule {
+    private val flagsValueProvider: IFlagsValueProvider = DeviceFlagsValueProvider()
+
+    override fun apply(base: Statement, description: Description?): Statement? {
+        return object : Statement() {
+            @Throws(Throwable::class)
+            override fun evaluate() {
+                val flagAnnotations = AnnotationsRetriever.getFlagAnnotations(description)
+                val isMaterial3 = flagAnnotations.mRequiredFlagValues[Flags.FLAG_USE_MATERIAL3]
+
+                flagsValueProvider.setUp()
+                try {
+                    flagAnnotations.assumeAllRequiredFlagsMatchProvider(flagsValueProvider)
+                } finally {
+                    flagsValueProvider.tearDownBeforeTest()
+                }
+
+                // The try/finally above takes care of checking the state of the DeviceFlag, so the
+                // code only reaches here if the flag is in the desired state.
+                if (isMaterial3 != null) {
+                    // Only force if the use_material3 flag is in use (aka not-null).
+                    Material3Config.setEnabledForTest(isMaterial3)
+                }
+                base.evaluate()
+            }
+        }
+    }
+}
diff --git a/tests/common/com/android/documentsui/rules/TestFilesRule.kt b/tests/common/com/android/documentsui/rules/TestFilesRule.kt
new file mode 100644
index 000000000..0f2009771
--- /dev/null
+++ b/tests/common/com/android/documentsui/rules/TestFilesRule.kt
@@ -0,0 +1,156 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.rules
+
+import android.net.Uri
+import android.os.Bundle
+import android.provider.DocumentsContract
+import androidx.test.platform.app.InstrumentationRegistry
+import com.android.documentsui.DocumentsProviderHelper
+import com.android.documentsui.StubProvider
+import com.android.documentsui.base.RootInfo
+import com.android.documentsui.base.UserId
+import org.junit.rules.ExternalResource
+
+/**
+ * Rule that creates test files in a test.
+ * When `skipCreation` is false, this essentially falls back to providing a `docsHelper`.
+ */
+class TestFilesRule(private val skipCreation: Boolean = false) : ExternalResource() {
+    lateinit var docsHelper: DocumentsProviderHelper
+
+    // A map of the URIs that are created, used to keep track of names of items that are created
+    // as children of other items.
+    private val createdUris = mutableMapOf<String, Uri>()
+
+    // The creation operations are deferred as the rules are instantiated prior to the environment
+    // being ready.
+    private val deferredOperations = mutableListOf<() -> Unit>()
+
+    override fun before() {
+        docsHelper =
+            DocumentsProviderHelper(
+                UserId.DEFAULT_USER,
+                StubProvider.DEFAULT_AUTHORITY,
+                InstrumentationRegistry.getInstrumentation().context,
+                StubProvider.DEFAULT_AUTHORITY,
+            )
+
+        docsHelper.clear(null, null)
+        docsHelper.configure(null, Bundle.EMPTY)
+
+        if (skipCreation) {
+            require(
+                deferredOperations.isEmpty()
+            ) { "Have deferred operations yet requested to skip creation." }
+            return
+        }
+
+        if (deferredOperations.isEmpty()) {
+            createDefault()
+        } else {
+            deferredOperations.forEach { it() }
+        }
+    }
+
+    /** Create a folder in `root`. */
+    fun createFolderInRoot(root: String, folderName: String): TestFilesRule {
+        deferredOperations.add {
+            val rootInfo = docsHelper.getRoot(root)
+            val uri = docsHelper.createFolder(rootInfo, folderName)
+            require(!createdUris.containsKey(folderName)) { "$folderName has already been created" }
+            createdUris[folderName] = uri
+        }
+        return this
+    }
+
+    /** Creates a folder in `root` with `parentName`. The `parentName` must be already created. */
+    fun createFolderWithParent(parentName: String, folderName: String): TestFilesRule {
+        deferredOperations.add {
+            val parentUri = createdUris[parentName]
+            requireNotNull(parentUri) { "Parent folder $parentName not initialized" }
+            val uri = docsHelper.createFolder(parentUri, folderName)
+            createdUris[folderName] = uri
+        }
+        return this
+    }
+
+    /** Creates a file in `root` with the specified `fileName` and `mimeType`. */
+    fun createFileInRoot(root: String, fileName: String, mimeType: String): TestFilesRule {
+        deferredOperations.add {
+            val rootInfo = docsHelper.getRoot(root)
+            val uri = docsHelper.createDocument(rootInfo, mimeType, fileName)
+            createdUris[fileName] = uri
+        }
+        return this
+    }
+
+    /** Returns `Uri` of the file with `filename` within the `root`. */
+    fun getUriInRoot(root: String, fileName: String): Uri? {
+        return docsHelper.findDocument(getRoot(root).documentId, fileName).derivedUri
+    }
+
+    /** Returns`RootInfo` for the for the specified `root`. */
+    fun getRoot(root: String): RootInfo {
+        return docsHelper.getRoot(root)
+    }
+
+    /** Creates a default set of files for testing. */
+    private fun createDefault() {
+        val root0 = docsHelper.getRoot(StubProvider.ROOT_0_ID)
+        val root1 = docsHelper.getRoot(StubProvider.ROOT_1_ID)
+
+        docsHelper.createFolder(root0, DIR_NAME_1)
+        docsHelper.createDocument(root0, "text/plain", FILE_NAME_1)
+        docsHelper.createDocument(root0, "image/png", FILE_NAME_2)
+        docsHelper.createDocumentWithFlags(
+            root0.documentId,
+            "text/plain",
+            FILE_NAME_NO_RENAME,
+            DocumentsContract.Document.FLAG_SUPPORTS_WRITE,
+        )
+
+        docsHelper.createDocument(root1, "text/plain", FILE_NAME_3)
+        docsHelper.createDocument(root1, "text/plain", FILE_NAME_4)
+    }
+
+    override fun after() {
+        docsHelper.cleanUp()
+    }
+
+    companion object {
+        @JvmField
+        val DIR_NAME_1: String = "Dir1"
+
+        @JvmField
+        val CHILD_DIR_1: String = "ChildDir1"
+
+        @JvmField
+        val FILE_NAME_1: String = "file1.log"
+
+        @JvmField
+        val FILE_NAME_2: String = "file12.png"
+
+        @JvmField
+        val FILE_NAME_3: String = "anotherFile0.log"
+
+        @JvmField
+        val FILE_NAME_4: String = "poodles.text"
+
+        @JvmField
+        val FILE_NAME_NO_RENAME: String = "NO_RENAMEfile.txt"
+    }
+}
diff --git a/tests/common/com/android/documentsui/services/TestCopyJobProcessTracker.java b/tests/common/com/android/documentsui/services/TestCopyJobProcessTracker.java
index e0e9d3fc0..55a6852fa 100644
--- a/tests/common/com/android/documentsui/services/TestCopyJobProcessTracker.java
+++ b/tests/common/com/android/documentsui/services/TestCopyJobProcessTracker.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.services;
 
+import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
+
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertNull;
 import static org.junit.Assert.assertTrue;
@@ -75,6 +77,9 @@ class TestCopyJobProcessTracker<T extends CopyJobProgressTracker> {
 
     void updateProgressAndRemainingTime(long elapsedTime) {
         mTimeSupplier.mValue = elapsedTime;
+        if (isVisualSignalsFlagEnabled()) {
+            mProcessTracker.updateEstimateRemainingTime();
+        }
         mProcessTracker.update(mProgressBuilder, mRemainTimeFormatter);
     }
 
diff --git a/tests/common/com/android/documentsui/services/TestJob.java b/tests/common/com/android/documentsui/services/TestJob.java
index 426cb9575..8d20b414f 100644
--- a/tests/common/com/android/documentsui/services/TestJob.java
+++ b/tests/common/com/android/documentsui/services/TestJob.java
@@ -70,13 +70,14 @@ public class TestJob extends Job {
     }
 
     @Override
-    Notification getSetupNotification() {
+    public Notification getSetupNotification() {
         ++mNumOfNotifications;
         return getSetupNotification(service.getString(R.string.copy_preparing));
     }
 
     @Override
-    Notification getProgressNotification() {
+    public Notification getProgressNotification() {
+        assertStarted();
         ++mNumOfNotifications;
         double completed = mStarted ? 1F : 0F;
         return mProgressBuilder
@@ -86,19 +87,14 @@ public class TestJob extends Job {
     }
 
     @Override
-    Notification getFailureNotification() {
+    public Notification getFailureNotification() {
         // the "copy" stuff was just convenient and available :)
         return getFailureNotification(
                 R.plurals.copy_error_notification_title, R.drawable.ic_menu_copy);
     }
 
-    @Override
-    Notification getWarningNotification() {
-        throw new UnsupportedOperationException();
-    }
-
     JobProgress getJobProgress() {
-        return new JobProgress(id, getState(), "test job", false);
+        return new JobProgress(id, operationType, getState(), "test job", false);
     }
 
     @Override
diff --git a/tests/common/com/android/documentsui/services/TestNotificationManager.java b/tests/common/com/android/documentsui/services/TestNotificationManager.java
index 5adde6563..a110cfa9e 100644
--- a/tests/common/com/android/documentsui/services/TestNotificationManager.java
+++ b/tests/common/com/android/documentsui/services/TestNotificationManager.java
@@ -18,7 +18,6 @@ package com.android.documentsui.services;
 
 import static junit.framework.Assert.assertEquals;
 import static junit.framework.Assert.assertFalse;
-import static junit.framework.Assert.assertNotNull;
 import static junit.framework.Assert.assertTrue;
 
 import android.app.Notification;
@@ -74,7 +73,7 @@ class TestNotificationManager {
         return null;
     }
 
-    private boolean hasNotification(int id, String jobId) {
+    boolean hasNotification(int id, String jobId) {
         if (mNotifications.get(id) == null) {
             return false;
         }
diff --git a/tests/common/com/android/documentsui/testing/DrawableAsserts.kt b/tests/common/com/android/documentsui/testing/DrawableAsserts.kt
new file mode 100644
index 000000000..37f1d1696
--- /dev/null
+++ b/tests/common/com/android/documentsui/testing/DrawableAsserts.kt
@@ -0,0 +1,42 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.testing
+
+import android.graphics.Canvas
+import android.graphics.drawable.Drawable
+import androidx.core.graphics.createBitmap
+import org.junit.Assert
+
+/** Handy Junit assertions related to Drawable. */
+class DrawableAsserts {
+  companion object {
+    @JvmStatic
+    fun assertDrawablesEqual(actual: Drawable, expected: Drawable) {
+      val bitmap1 = createBitmap(actual.intrinsicWidth, actual.intrinsicHeight)
+      val canvas1 = Canvas(bitmap1)
+      actual.setBounds(0, 0, actual.intrinsicWidth, actual.intrinsicHeight)
+      actual.draw(canvas1)
+
+      val bitmap2 = createBitmap(expected.intrinsicWidth, expected.intrinsicHeight)
+      val canvas2 = Canvas(bitmap2)
+      expected.setBounds(0, 0, expected.intrinsicWidth, expected.intrinsicHeight)
+      expected.draw(canvas2)
+
+      Assert.assertTrue("Drawables are not equal", bitmap1.sameAs(bitmap2))
+    }
+  }
+}
diff --git a/tests/common/com/android/documentsui/testing/MutableJobProgress.kt b/tests/common/com/android/documentsui/testing/MutableJobProgress.kt
index b2dd595f9..3749fef90 100644
--- a/tests/common/com/android/documentsui/testing/MutableJobProgress.kt
+++ b/tests/common/com/android/documentsui/testing/MutableJobProgress.kt
@@ -15,18 +15,32 @@
  */
 package com.android.documentsui.testing
 
+import com.android.documentsui.base.DocumentStack
+import com.android.documentsui.services.FileOperationService
 import com.android.documentsui.services.Job
 import com.android.documentsui.services.JobProgress
 
 data class MutableJobProgress(
     var id: String,
+    @FileOperationService.OpType val operationType: Int,
     @Job.State var state: Int,
     var msg: String?,
     var hasFailures: Boolean,
+    var destination: DocumentStack? = null,
     var currentBytes: Long = -1,
     var requiredBytes: Long = -1,
     var msRemaining: Long = -1,
 ) {
     fun toJobProgress() =
-        JobProgress(id, state, msg, hasFailures, currentBytes, requiredBytes, msRemaining)
+        JobProgress(
+            id,
+            operationType,
+            state,
+            msg,
+            hasFailures,
+            destination,
+            currentBytes,
+            requiredBytes,
+            msRemaining
+        )
 }
diff --git a/tests/common/com/android/documentsui/testing/TestDocumentsProvider.java b/tests/common/com/android/documentsui/testing/TestDocumentsProvider.java
index c7e884fde..6c86aeee3 100644
--- a/tests/common/com/android/documentsui/testing/TestDocumentsProvider.java
+++ b/tests/common/com/android/documentsui/testing/TestDocumentsProvider.java
@@ -18,6 +18,7 @@ package com.android.documentsui.testing;
 
 import android.annotation.NonNull;
 import android.annotation.Nullable;
+import android.content.ContentResolver;
 import android.content.Context;
 import android.content.pm.ProviderInfo;
 import android.database.Cursor;
@@ -54,6 +55,10 @@ public class TestDocumentsProvider extends DocumentsProvider {
     private Cursor mNextChildDocuments;
     private Cursor mNextRecentDocuments;
 
+    // Emulates FileSystemProvider's support for search result limiting.
+    private Boolean mSupportsSearchResultLimit = false;
+    private static final int DEFAULT_MAX_RESULTS = 23;  /* FileSystemProvider.DEFAULT_MAX_RESULTS */
+
     public TestDocumentsProvider(Context context, String authority) {
         ProviderInfo info = new ProviderInfo();
         info.authority = authority;
@@ -105,10 +110,23 @@ public class TestDocumentsProvider extends DocumentsProvider {
     public Cursor querySearchDocuments(@NonNull String rootId, @Nullable String[] projection,
             @NonNull Bundle queryArgs) {
         TestCursor cursor = new TestCursor(DOCUMENTS_PROJECTION);
+
+        int maxResults = -1;
+        if (mSupportsSearchResultLimit) {
+            // FileSystemProvider has no concept of "all search results" (the -1/ALL_RESULTS option
+            // used within parts of DocumentsUI); if no limit, or a negative limit is sent, it
+            // will always apply its default limit. We emulate that behaviour here for testing.
+            maxResults = queryArgs.getInt(ContentResolver.QUERY_ARG_LIMIT, DEFAULT_MAX_RESULTS);
+            if (maxResults < 0) {
+                maxResults = DEFAULT_MAX_RESULTS;
+            }
+        }
+
         if (mNextChildDocuments == null) {
             return cursor;
         }
-        for (boolean hasNext = mNextChildDocuments.moveToFirst(); hasNext;
+        for (boolean hasNext = mNextChildDocuments.moveToFirst();
+                hasNext && ((maxResults < 0) || (cursor.getCount() < maxResults));
                 hasNext = mNextChildDocuments.moveToNext()) {
             String displayName = getStringColumn(mNextChildDocuments, Document.COLUMN_DISPLAY_NAME);
             String mimeType = getStringColumn(mNextChildDocuments, Document.COLUMN_MIME_TYPE);
@@ -161,6 +179,15 @@ public class TestDocumentsProvider extends DocumentsProvider {
         mNextChildDocuments = createDocumentsCursor(docs);
     }
 
+    /**
+     * Allows TestDocumentsProvider to emulate search result limiting feature of FileSystemProvider.
+     * @param supportsLimit Whether {@link #querySearchDocuments(String, String[], Bundle)}
+     *                      should limit results.
+     */
+    public void setSupportsSearchResultLimit(Boolean supportsLimit) {
+        mSupportsSearchResultLimit = supportsLimit;
+    }
+
     public void setNextRecentDocumentsReturns(DocumentInfo... docs) {
         mNextRecentDocuments = createDocumentsCursor(docs);
     }
diff --git a/tests/common/com/android/documentsui/testing/TestEnv.java b/tests/common/com/android/documentsui/testing/TestEnv.java
index 8f74647d3..7db838981 100644
--- a/tests/common/com/android/documentsui/testing/TestEnv.java
+++ b/tests/common/com/android/documentsui/testing/TestEnv.java
@@ -119,6 +119,7 @@ public class TestEnv {
             if (!mockProviders.containsKey(root.authority)) {
                 Context context = InstrumentationRegistry.getInstrumentation().getTargetContext();
                 TestDocumentsProvider provider = new TestDocumentsProvider(context, root.authority);
+                provider.setSupportsSearchResultLimit(root.supportsSearchResultLimit());
                 contentResolver.addProvider(root.authority, provider);
                 mockProviders.put(root.authority, provider);
             }
diff --git a/tests/common/com/android/documentsui/testing/TestEvents.java b/tests/common/com/android/documentsui/testing/TestEvents.java
index 798120c73..d402019dc 100644
--- a/tests/common/com/android/documentsui/testing/TestEvents.java
+++ b/tests/common/com/android/documentsui/testing/TestEvents.java
@@ -16,13 +16,15 @@
 
 package com.android.documentsui.testing;
 
-import androidx.annotation.IntDef;
 import android.graphics.Point;
+import android.view.InputDevice;
 import android.view.KeyEvent;
 import android.view.MotionEvent;
 import android.view.MotionEvent.PointerCoords;
 import android.view.MotionEvent.PointerProperties;
 
+import androidx.annotation.IntDef;
+
 import java.lang.annotation.Retention;
 import java.lang.annotation.RetentionPolicy;
 import java.util.HashSet;
@@ -62,7 +64,7 @@ public final class TestEvents {
     static final int ACTION_UNSET = -1;
 
     // Add other actions from MotionEvent.ACTION_ as needed.
-    @IntDef(flag = true, value = {
+    @IntDef(value = {
             MotionEvent.ACTION_DOWN,
             MotionEvent.ACTION_MOVE,
             MotionEvent.ACTION_UP
@@ -70,8 +72,17 @@ public final class TestEvents {
     @Retention(RetentionPolicy.SOURCE)
     public @interface Action {}
 
+    // Add other types from InputDevice.SOURCE_ as needed.
+    @IntDef(value = {
+            InputDevice.SOURCE_MOUSE,
+            InputDevice.SOURCE_TOUCHSCREEN,
+            InputDevice.SOURCE_UNKNOWN
+    })
+    @Retention(RetentionPolicy.SOURCE)
+    public @interface Source {}
+
     // Add other types from MotionEvent.TOOL_TYPE_ as needed.
-    @IntDef(flag = true, value = {
+    @IntDef(value = {
             MotionEvent.TOOL_TYPE_FINGER,
             MotionEvent.TOOL_TYPE_MOUSE,
             MotionEvent.TOOL_TYPE_STYLUS,
@@ -96,6 +107,7 @@ public final class TestEvents {
 
     private static final class State {
         private @Action int mAction = ACTION_UNSET;
+        private @Source int mSource = InputDevice.SOURCE_UNKNOWN;
         private @ToolType int mToolType = MotionEvent.TOOL_TYPE_UNKNOWN;
         private int mPointerCount = 1;
         private Set<Integer> mButtons = new HashSet<>();
@@ -124,6 +136,11 @@ public final class TestEvents {
             return this;
         }
 
+        public Builder source(@Source int source) {
+            mState.mSource = source;
+            return this;
+        }
+
         public Builder type(@ToolType int type) {
             mState.mToolType = type;
             return this;
@@ -184,13 +201,25 @@ public final class TestEvents {
             return this;
         }
 
+        public Builder mouse() {
+            source(InputDevice.SOURCE_MOUSE);
+            type(MotionEvent.TOOL_TYPE_MOUSE);
+            return this;
+        }
+
         public Builder touch() {
+            source(InputDevice.SOURCE_TOUCHSCREEN);
             type(MotionEvent.TOOL_TYPE_FINGER);
             return this;
         }
 
-        public Builder mouse() {
-            type(MotionEvent.TOOL_TYPE_MOUSE);
+        public Builder touchpad() {
+            // For compatibility reasons, some touchpads (but not on ChromeOS
+            // ARC devices) fire SOURCE_MOUSE and TOOL_TYPE_FINGER events even
+            // though the source should be SOURCE_TOUCHPAD and the tool type
+            // could arguably be TOOL_TYPE_MOUSE.
+            source(InputDevice.SOURCE_MOUSE);
+            type(MotionEvent.TOOL_TYPE_FINGER);
             return this;
         }
 
@@ -273,7 +302,7 @@ public final class TestEvents {
                     1.0f,  // y precision
                     0,     // device id
                     0,     // edge flags
-                    0,     // int source,
+                    mState.mSource,
                     0      // int flags
                     );
         }
diff --git a/tests/common/com/android/documentsui/testing/TestModel.java b/tests/common/com/android/documentsui/testing/TestModel.java
index 83ece2ebb..ae6211bb6 100644
--- a/tests/common/com/android/documentsui/testing/TestModel.java
+++ b/tests/common/com/android/documentsui/testing/TestModel.java
@@ -59,10 +59,19 @@ public class TestModel extends Model {
 
     @Override
     public void reset() {
+        // Intentionally not calling super.reset() because of AbstractActionHandlerTest relies
+        // on the model to keep `mIds`.gs
         mLastId = 0;
         mCursor = new MatrixCursor(COLUMNS);
     }
 
+    /**
+     * Clear the model ids to make it become an empty model.
+     */
+    public void clearIds() {
+        super.reset();
+    }
+
     public void update() {
         DirectoryResult r = new DirectoryResult();
         r.setCursor(mCursor);
diff --git a/tests/common/com/android/documentsui/testing/TestPeekViewManager.kt b/tests/common/com/android/documentsui/testing/TestPeekViewManager.kt
index e3ad6033c..1435e0a29 100644
--- a/tests/common/com/android/documentsui/testing/TestPeekViewManager.kt
+++ b/tests/common/com/android/documentsui/testing/TestPeekViewManager.kt
@@ -15,20 +15,25 @@
  */
 package com.android.documentsui.testing
 
-import android.app.Activity
+import android.widget.FrameLayout
 import androidx.fragment.app.FragmentManager
 import com.android.documentsui.base.DocumentInfo
 import com.android.documentsui.peek.PeekViewManager
+import com.android.documentsui.peek.PeekViewModel
+import org.mockito.Mockito.mock
 
-class TestPeekViewManager(mActivity: Activity) : PeekViewManager(mActivity) {
+class TestPeekViewManager() :
+    PeekViewManager(
+        PeekViewModel(),
+        mock(FrameLayout::class.java),
+        mock(FragmentManager::class.java)
+    ) {
 
     val peekDocument = TestEventListener<DocumentInfo>()
 
-    override fun initFragment(fm: FragmentManager) {
-        throw UnsupportedOperationException()
-    }
+    override fun initialize() {}
 
     override fun peekDocument(doc: DocumentInfo) {
         peekDocument.accept(doc)
     }
-}
\ No newline at end of file
+}
diff --git a/tests/common/com/android/documentsui/testing/TestProvidersAccess.java b/tests/common/com/android/documentsui/testing/TestProvidersAccess.java
index 5a138ea9f..8dc899337 100644
--- a/tests/common/com/android/documentsui/testing/TestProvidersAccess.java
+++ b/tests/common/com/android/documentsui/testing/TestProvidersAccess.java
@@ -15,6 +15,7 @@
  */
 package com.android.documentsui.testing;
 
+import android.content.ContentResolver;
 import android.os.Process;
 import android.os.UserHandle;
 import android.provider.DocumentsContract.Root;
@@ -67,6 +68,8 @@ public class TestProvidersAccess implements ProvidersAccess {
         DOWNLOADS.flags = Root.FLAG_LOCAL_ONLY
                 | Root.FLAG_SUPPORTS_CREATE
                 | Root.FLAG_SUPPORTS_RECENTS;
+        // This DocumentsProvider supports limiting the results returned
+        DOWNLOADS.queryArgs = ContentResolver.QUERY_ARG_LIMIT;
 
         HOME = new RootInfo();
         HOME.userId = userId;
diff --git a/tests/common/com/android/documentsui/testing/TestRecyclerView.java b/tests/common/com/android/documentsui/testing/TestRecyclerView.java
index 3e145347f..f7ed251c6 100644
--- a/tests/common/com/android/documentsui/testing/TestRecyclerView.java
+++ b/tests/common/com/android/documentsui/testing/TestRecyclerView.java
@@ -84,6 +84,15 @@ public class TestRecyclerView extends RecyclerView {
         adapter.updateTestModelIds(modelIds);
     }
 
+    /**
+     * Set the measured width and height of the View.
+     * @param measuredWidth
+     * @param measuredHeight
+     */
+    public void setMeasuredWithAndHeight(int measuredWidth, int measuredHeight) {
+        setMeasuredDimension(measuredWidth, measuredHeight);
+    }
+
     public static TestRecyclerView create(List<String> modelIds) {
         final TestRecyclerView view =
                 new TestRecyclerView(InstrumentationRegistry.getTargetContext());
diff --git a/tests/common/com/android/documentsui/testing/TestSearchViewManager.java b/tests/common/com/android/documentsui/testing/TestSearchViewManager.java
index dbc5c4480..bd55b8a29 100644
--- a/tests/common/com/android/documentsui/testing/TestSearchViewManager.java
+++ b/tests/common/com/android/documentsui/testing/TestSearchViewManager.java
@@ -39,34 +39,9 @@ public class TestSearchViewManager extends SearchViewManager {
     private boolean mShowMenuCalled;
 
     public TestSearchViewManager() {
-        super(
-                new SearchManagerListener() {
-                    @Override
-                    public void onSearchChanged(String query) {
-                    }
-
-                    @Override
-                    public void onSearchFinished() {
-                    }
-
-                    @Override
-                    public void onSearchViewChanged(boolean opened) {
-                    }
-
-                    @Override
-                    public void onSearchChipStateChanged(View v) {
-                    }
-
-                    @Override
-                    public void onSearchViewFocusChanged(boolean hasFocus) {
-                    }
-
-                    @Override
-                    public void onSearchViewClearClicked() {
-                    }
-                },
+        super(mock(SearchManagerListener.class),
                 new CommandInterceptor(new TestFeatures()), mock(ViewGroup.class),
-                null /* savedState */);
+                mock(View.class), /*savedState=*/null);
     }
 
     @Override
diff --git a/tests/common/com/android/documentsui/testing/Views.java b/tests/common/com/android/documentsui/testing/Views.java
index 6f5b1a2b8..8f5016d4f 100644
--- a/tests/common/com/android/documentsui/testing/Views.java
+++ b/tests/common/com/android/documentsui/testing/Views.java
@@ -19,6 +19,8 @@ package com.android.documentsui.testing;
 import android.graphics.drawable.Drawable;
 import android.view.View;
 
+import androidx.test.platform.app.InstrumentationRegistry;
+
 import org.mockito.Mockito;
 
 public final class Views {
@@ -46,6 +48,8 @@ public final class Views {
 
     public static View createTestView(boolean activated) {
         View view = createTestView();
+        Mockito.when(view.getResources()).thenReturn(
+                InstrumentationRegistry.getInstrumentation().getTargetContext().getResources());
         Mockito.when(view.isActivated()).thenReturn(activated);
 
         return view;
diff --git a/tests/functional/com/android/documentsui/ActionCreateDocumentUiTest.java b/tests/functional/com/android/documentsui/ActionCreateDocumentUiTest.java
index fd17f72fd..175c36483 100644
--- a/tests/functional/com/android/documentsui/ActionCreateDocumentUiTest.java
+++ b/tests/functional/com/android/documentsui/ActionCreateDocumentUiTest.java
@@ -81,7 +81,7 @@ public class ActionCreateDocumentUiTest extends DocumentsUiTestBase {
 
         bots.main.setDialogText(fileName);
         device.waitForIdle();
-        bots.main.clickSaveButton();
+        bots.picker.clickSaveButton();
 
         final Instrumentation.ActivityResult activityResult = mRule.getActivityResult();
         assertThat(activityResult.getResultCode()).isEqualTo(RESULT_OK);
diff --git a/tests/functional/com/android/documentsui/ActivityTestJunit4.kt b/tests/functional/com/android/documentsui/ActivityTestJunit4.kt
index 8f1d4f860..6f93a99a9 100644
--- a/tests/functional/com/android/documentsui/ActivityTestJunit4.kt
+++ b/tests/functional/com/android/documentsui/ActivityTestJunit4.kt
@@ -17,12 +17,11 @@ package com.android.documentsui
 
 import android.app.Activity
 import android.app.UiAutomation
-import android.content.ContentResolver
 import android.content.Context
 import android.content.Intent
-import android.os.Bundle
 import android.os.RemoteException
 import android.provider.DocumentsContract
+import android.util.Log
 import android.view.KeyEvent
 import android.view.MotionEvent
 import androidx.test.core.app.ActivityScenario
@@ -36,7 +35,8 @@ import com.android.documentsui.base.UserId
 import com.android.documentsui.bots.Bots
 import com.android.documentsui.files.FilesActivity
 import java.io.IOException
-import java.util.Objects
+import org.junit.After
+import org.junit.Before
 
 /**
  * Provides basic test environment for UI tests:
@@ -45,15 +45,16 @@ import java.util.Objects
  * - Cleans up the test environment
  */
 abstract class ActivityTestJunit4<T : Activity?> {
-    @JvmField
-    var bots: Bots? = null
+    lateinit var bots: Bots
 
     @JvmField
     var device: UiDevice? = null
 
     @JvmField
     var context: Context? = null
-    var userId: UserId? = null
+
+    @JvmField
+    protected var userId: UserId? = null
     var automation: UiAutomation? = null
 
     @JvmField
@@ -72,10 +73,11 @@ abstract class ActivityTestJunit4<T : Activity?> {
 
     @JvmField
     var rootDir1: RootInfo? = null
-    protected var mResolver: ContentResolver? = null
 
     @JvmField
     protected var mDocsHelper: DocumentsProviderHelper? = null
+
+    @JvmField
     protected var mActivityScenario: ActivityScenario<T?>? = null
     private var initialScreenOffTimeoutValue: String? = null
     private var initialSleepTimeoutValue: String? = null
@@ -98,20 +100,19 @@ abstract class ActivityTestJunit4<T : Activity?> {
         this.initialRoot = rootDir0
     }
 
-    @Throws(Exception::class)
-    open fun setUp() {
+    @Before
+    fun setUp() {
         device = UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())
         // NOTE: Must be the "target" context, else security checks in content provider will fail.
-        context = InstrumentationRegistry.getInstrumentation().getTargetContext()
+        context = InstrumentationRegistry.getInstrumentation().targetContext
         userId = UserId.DEFAULT_USER
-        automation = InstrumentationRegistry.getInstrumentation().getUiAutomation()
+        automation = InstrumentationRegistry.getInstrumentation().uiAutomation
         features = RuntimeFeatures(context!!.getResources(), null)
 
         bots = Bots(device, automation, context, TIMEOUT)
 
-        Configurator.getInstance().setToolType(MotionEvent.TOOL_TYPE_MOUSE)
+        Configurator.getInstance().toolType = MotionEvent.TOOL_TYPE_MOUSE
 
-        mResolver = context!!.getContentResolver()
         mDocsHelper = DocumentsProviderHelper(
             userId, this.testingProviderAuthority, context,
             this.testingProviderAuthority
@@ -123,29 +124,23 @@ abstract class ActivityTestJunit4<T : Activity?> {
         disableScreenOffAndSleepTimeouts()
 
         setupTestingRoots()
-
         launchActivity()
-        resetStorage()
 
         // Since at the launch of activity, ROOT_0 and ROOT_1 have no files, drawer will
         // automatically open for phone devices. Espresso register click() as (x, y) MotionEvents,
         // so if a drawer is on top of a file we want to select, it will actually click the drawer.
         // Thus to start a clean state, we always try to close first.
-        bots!!.roots!!.closeDrawer()
-
-        // Configure the provider back to default.
-        mDocsHelper!!.configure(null, Bundle.EMPTY)
+        bots.roots!!.closeDrawer()
     }
 
-    @Throws(Exception::class)
-    open fun tearDown() {
+    @After
+    fun tearDown() {
         device!!.unfreezeRotation()
-        mDocsHelper!!.cleanUp()
         restoreScreenOffAndSleepTimeouts()
-        mActivityScenario!!.close()
+        mActivityScenario?.close()
     }
 
-    protected fun launchActivity() {
+    protected open fun launchActivity() {
         val intent = Intent(context, FilesActivity::class.java)
         intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK)
         if (this.initialRoot != null) {
@@ -158,28 +153,6 @@ abstract class ActivityTestJunit4<T : Activity?> {
         mActivityScenario = ActivityScenario.launch(intent)
     }
 
-    @Throws(RemoteException::class)
-    protected fun resetStorage() {
-        mDocsHelper!!.clear(null, null)
-        device!!.waitForIdle()
-    }
-
-    @Throws(RemoteException::class)
-    protected open fun initTestFiles() {
-        mDocsHelper!!.createFolder(this.initialRoot, dirName1)
-        mDocsHelper!!.createDocument(this.initialRoot, "text/plain", fileName1)
-        mDocsHelper!!.createDocument(this.initialRoot, "image/png", fileName2)
-        mDocsHelper!!.createDocumentWithFlags(
-            initialRoot!!.documentId,
-            "text/plain",
-            fileNameNoRename,
-            DocumentsContract.Document.FLAG_SUPPORTS_WRITE
-        )
-
-        mDocsHelper!!.createDocument(rootDir1, "text/plain", fileName3)
-        mDocsHelper!!.createDocument(rootDir1, "text/plain", fileName4)
-    }
-
     @Throws(IOException::class)
     private fun disableScreenOffAndSleepTimeouts() {
         initialScreenOffTimeoutValue = device!!.executeShellCommand(
@@ -188,14 +161,23 @@ abstract class ActivityTestJunit4<T : Activity?> {
         initialSleepTimeoutValue = device!!.executeShellCommand(
             "settings get secure sleep_timeout"
         )
+        Log.w(
+            TAG,
+            """initialScreenOffTimeoutValue = '$initialScreenOffTimeoutValue'
+                |initialSleepTimeoutValue = '$initialSleepTimeoutValue'""".trimMargin()
+        )
         device!!.executeShellCommand("settings put system screen_off_timeout -1")
         device!!.executeShellCommand("settings put secure sleep_timeout -1")
     }
 
     @Throws(IOException::class)
     private fun restoreScreenOffAndSleepTimeouts() {
-        Objects.requireNonNull<String?>(initialScreenOffTimeoutValue)
-        Objects.requireNonNull<String?>(initialSleepTimeoutValue)
+        requireNotNull(
+            initialScreenOffTimeoutValue
+        ) { "Require the initial screen off timeout value to be non-null" }
+        requireNotNull(
+            initialSleepTimeoutValue
+        ) { "Require the sleep timeout value to be non-null" }
         try {
             device!!.executeShellCommand(
                 "settings put system screen_off_timeout $initialScreenOffTimeoutValue"
@@ -210,14 +192,7 @@ abstract class ActivityTestJunit4<T : Activity?> {
     }
 
     companion object {
-        // Testing files. For custom ones, override initTestFiles().
-        const val dirName1 = "Dir1"
-        const val childDir1 = "ChildDir1"
-        const val fileName1 = "file1.log"
-        const val fileName2 = "file12.png"
-        const val fileName3 = "anotherFile0.log"
-        const val fileName4 = "poodles.text"
-        const val fileNameNoRename = "NO_RENAMEfile.txt"
         const val TIMEOUT = 5000
+        const val TAG = "ActivityTestJunit4"
     }
 }
diff --git a/tests/functional/com/android/documentsui/ArchiveUiTest.java b/tests/functional/com/android/documentsui/ArchiveUiTest.java
index b3bebb62e..372bf9833 100644
--- a/tests/functional/com/android/documentsui/ArchiveUiTest.java
+++ b/tests/functional/com/android/documentsui/ArchiveUiTest.java
@@ -16,17 +16,30 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY;
+
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+
 import androidx.test.filters.LargeTest;
 
 import com.android.documentsui.files.FilesActivity;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
+import com.android.documentsui.rules.TestFilesRule;
+
+import org.junit.Rule;
+import org.junit.Test;
 
 @LargeTest
-public class ArchiveUiTest extends ActivityTest<FilesActivity> {
-    public ArchiveUiTest() {
-        super(FilesActivity.class);
-    }
+public class ArchiveUiTest extends ActivityTestJunit4<FilesActivity> {
 
-    public void testArchive_valid() throws Exception {
+    @Rule
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
+
+    @Rule
+    public final TestFilesRule mTestFilesRule = new TestFilesRule();
+
+    private void archiveValid() throws Exception {
         bots.roots.openRoot("ResourcesProvider");
         bots.directory.openDocument("archive.zip");
         bots.directory.waitForDocument("file1.txt");
@@ -35,11 +48,36 @@ public class ArchiveUiTest extends ActivityTest<FilesActivity> {
         bots.directory.waitForDocument("cherries.txt");
     }
 
-    public void testArchive_invalid() throws Exception {
+    @Test
+    @RequiresFlagsDisabled({FLAG_USE_SEARCH_V2_READ_ONLY})
+    public void testArchive_valid() throws Exception {
+        archiveValid();
+    }
+
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_SEARCH_V2_READ_ONLY})
+    public void testArchive_valid_searchV2() throws Exception {
+        archiveValid();
+    }
+
+    private void archiveInvalid() throws Exception {
         bots.roots.openRoot("ResourcesProvider");
         bots.directory.openDocument("broken.zip");
 
         final String msg = String.valueOf(context.getString(R.string.empty));
+        bots.directory.waitForHolderMessage();
         bots.directory.assertPlaceholderMessageText(msg);
     }
+
+    @Test
+    @RequiresFlagsDisabled({FLAG_USE_SEARCH_V2_READ_ONLY})
+    public void testArchive_invalid() throws Exception {
+        archiveInvalid();
+    }
+
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_SEARCH_V2_READ_ONLY})
+    public void testArchive_invalid_searchV2() throws Exception {
+        archiveInvalid();
+    }
 }
diff --git a/tests/functional/com/android/documentsui/BandSelectionUiTest.java b/tests/functional/com/android/documentsui/BandSelectionUiTest.java
index 94cdef351..98fd8d75b 100644
--- a/tests/functional/com/android/documentsui/BandSelectionUiTest.java
+++ b/tests/functional/com/android/documentsui/BandSelectionUiTest.java
@@ -13,34 +13,43 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package com.android.documentsui;
 
 import android.graphics.Point;
 import android.graphics.Rect;
+import android.view.View;
 
 import androidx.test.filters.LargeTest;
 
+import com.android.documentsui.base.DocumentInfo;
+import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.files.FilesActivity;
+import com.android.documentsui.rules.TestFilesRule;
+import com.android.documentsui.sorting.SortDimension;
+import com.android.documentsui.sorting.SortModel;
+
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+
+import java.util.List;
 
 @LargeTest
-public class BandSelectionUiTest extends ActivityTest<FilesActivity> {
+public class BandSelectionUiTest extends ActivityTestJunit4<FilesActivity> {
 
-    public BandSelectionUiTest() {
-        super(FilesActivity.class);
-    }
+    @Rule
+    public TestFilesRule mTestFiles = new TestFilesRule();
 
-    @Override
-    public void setUp() throws Exception {
-        super.setUp();
-        initTestFiles();
+    @Before
+    public void setUpTest() {
         bots.roots.closeDrawer();
     }
 
+    @Test
     public void testBandSelection_allFiles() throws Exception {
         bots.main.switchToGridMode();
         Rect dirListBounds = bots.directory.findDocumentsList().getBounds();
-        Rect startDir = bots.directory.findDocument(dirName1).getBounds();
+        Rect startDir = bots.directory.findDocument(TestFilesRule.DIR_NAME_1).getBounds();
         Point start = new Point(dirListBounds.right - 1, startDir.centerY());
         Point end = new Point(dirListBounds.left + 1, dirListBounds.bottom - 1);
         bots.gesture.bandSelection(start, end);
@@ -48,17 +57,41 @@ public class BandSelectionUiTest extends ActivityTest<FilesActivity> {
         bots.directory.assertSelection(4);
     }
 
+    @Test
     public void testBandSelection_someFiles() throws Exception {
+        // Switch to Grid mode and ensure the list is sorted by title.
         bots.main.switchToGridMode();
+        bots.sort.sortBy(SortModel.SORT_DIMENSION_ID_TITLE, SortDimension.SORT_DIRECTION_ASCENDING);
+
+        // Get all the documents to enumerate through and find all the documents in the top row.
+        RootInfo root = mTestFiles.docsHelper.getRootList().get(0);
+        List<DocumentInfo> createdDocs = mTestFiles.docsHelper.listAllChildren(root);
+
+        // Work out the start and end of the drag selection to go select the top row of documents
+        // if this is done in the opposite direction it will trigger the drawer to be swiped open.
         Rect dirListBounds = bots.directory.findDocumentsList().getBounds();
-        Rect startDoc = bots.directory.findDocument(fileNameNoRename).getBounds();
-        Rect endDoc = bots.directory.findDocument(fileName1).getBounds();
-        // Start from right side of file NoRename.
-        Point start = new Point(dirListBounds.right - 1, startDoc.bottom - 1);
-        // End is center of file1
-        Point end = new Point(endDoc.centerX(), endDoc.centerY());
-        bots.gesture.bandSelection(start, end);
+        Rect startDoc = bots.directory.findDocument(createdDocs.get(0).displayName).getBounds();
+        Point endPoint = new Point(dirListBounds.left + 1, startDoc.centerY());
+        Point startPoint = new Point(dirListBounds.right - 1, startDoc.centerY());
+
+        // Count the number of documents in the top row. This can differ based on the screen size so
+        // calculate it dynamically to avoid failing on different devices.
+        int docsInTopRow = 0;
+        for (DocumentInfo doc : createdDocs) {
+            Rect docBounds = bots.directory.findDocument(doc.displayName).getBounds();
+            if (docBounds.centerY() != startDoc.centerY()) {
+                break;
+            }
+            docsInTopRow++;
+        }
 
-        bots.directory.assertSelection(3);
+        // Perform drag and assert that the number of docs in the top row is selected.
+        if (context.getResources().getConfiguration().getLayoutDirection()
+                == View.LAYOUT_DIRECTION_RTL) {
+            bots.gesture.bandSelection(endPoint, startPoint);
+        } else {
+            bots.gesture.bandSelection(startPoint, endPoint);
+        }
+        bots.directory.assertSelection(docsInTopRow);
     }
 }
diff --git a/tests/functional/com/android/documentsui/CancelFromNotificationUiTest.java b/tests/functional/com/android/documentsui/CancelFromNotificationUiTest.java
index 192dbb16d..c814841b8 100644
--- a/tests/functional/com/android/documentsui/CancelFromNotificationUiTest.java
+++ b/tests/functional/com/android/documentsui/CancelFromNotificationUiTest.java
@@ -159,7 +159,7 @@ public class CancelFromNotificationUiTest extends ActivityTest<FilesActivity> {
         bots.main.clickToolbarOverflowItem(context.getResources().getString(R.string.menu_copy));
         device.waitForIdle();
 
-        bots.main.clickDialogCancelButton();
+        bots.main.clickDialogCancelButton(/* closeSoftKeyboard */ false);
         device.waitForIdle();
 
         bots.directory.waitForDocument(TARGET_FILE);
@@ -178,7 +178,7 @@ public class CancelFromNotificationUiTest extends ActivityTest<FilesActivity> {
         device.waitForIdle();
 
         bots.roots.openRoot(ROOT_1_ID);
-        bots.main.clickDialogOkButton();
+        bots.main.clickDialogOkButton(/* closeSoftKeyboard */ false);
         device.waitForIdle();
 
         try {
@@ -211,7 +211,7 @@ public class CancelFromNotificationUiTest extends ActivityTest<FilesActivity> {
         bots.main.clickToolbarOverflowItem(context.getResources().getString(R.string.menu_move));
         device.waitForIdle();
 
-        bots.main.clickDialogCancelButton();
+        bots.main.clickDialogCancelButton(/* closeSoftKeyboard */ false);
         device.waitForIdle();
 
         bots.directory.waitForDocument(TARGET_FILE);
@@ -233,7 +233,7 @@ public class CancelFromNotificationUiTest extends ActivityTest<FilesActivity> {
         device.waitForIdle();
 
         bots.roots.openRoot(ROOT_1_ID);
-        bots.main.clickDialogOkButton();
+        bots.main.clickDialogOkButton(/* closeSoftKeyboard */ false);
         device.waitForIdle();
 
         try {
diff --git a/tests/functional/com/android/documentsui/ContextMenuUiTest.java b/tests/functional/com/android/documentsui/ContextMenuUiTest.java
index 8cb43c8bf..62cf36ccc 100644
--- a/tests/functional/com/android/documentsui/ContextMenuUiTest.java
+++ b/tests/functional/com/android/documentsui/ContextMenuUiTest.java
@@ -16,31 +16,42 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.StubProvider.ROOT_0_ID;
+import static com.android.documentsui.util.FlagUtils.isDesktopFileHandlingFlagEnabled;
+
 import android.graphics.Point;
 import android.graphics.Rect;
-import android.net.Uri;
-import android.os.RemoteException;
 
 import androidx.test.filters.LargeTest;
 
 import com.android.documentsui.files.FilesActivity;
+import com.android.documentsui.rules.TestFilesRule;
+
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
 
 import java.util.HashMap;
 import java.util.Map;
 
 @LargeTest
-public class ContextMenuUiTest extends ActivityTest<FilesActivity> {
+public class ContextMenuUiTest extends ActivityTestJunit4<FilesActivity> {
+
+    @Rule
+    public final TestFilesRule mTestFilesRule =
+            new TestFilesRule()
+                    .createFolderInRoot(ROOT_0_ID, TestFilesRule.DIR_NAME_1)
+                    .createFolderWithParent(TestFilesRule.DIR_NAME_1, "ChildDir1")
+                    .createFileInRoot(ROOT_0_ID, "file0.log", "text/plain")
+                    .createFileInRoot(ROOT_0_ID, "file1.png", "image/png")
+                    .createFileInRoot(ROOT_0_ID, "file2.csv", "text/csv")
+                    .createFileInRoot(ROOT_0_ID, "anotherFile0.log", "text/plain")
+                    .createFileInRoot(ROOT_0_ID, "poodles.text", "text/plain");
 
     private Map<String, Boolean> menuItems;
 
-    public ContextMenuUiTest() {
-        super(FilesActivity.class);
-    }
-
-    @Override
-    public void setUp() throws Exception {
-        super.setUp();
-        initTestFiles();
+    @Before
+    public void setUpTest() {
         bots.roots.closeDrawer();
         menuItems = new HashMap<>();
 
@@ -56,22 +67,10 @@ public class ContextMenuUiTest extends ActivityTest<FilesActivity> {
         menuItems.put("New folder", false);
     }
 
-    @Override
-    public void initTestFiles() throws RemoteException {
-        Uri uri = mDocsHelper.createFolder(rootDir0, dirName1);
-        mDocsHelper.createFolder(uri, childDir1);
-
-        mDocsHelper.createDocument(rootDir0, "text/plain", "file0.log");
-        mDocsHelper.createDocument(rootDir0, "image/png", "file1.png");
-        mDocsHelper.createDocument(rootDir0, "text/csv", "file2.csv");
-
-        mDocsHelper.createDocument(rootDir1, "text/plain", "anotherFile0.log");
-        mDocsHelper.createDocument(rootDir1, "text/plain", "poodles.text");
-    }
-
+    @Test
     public void testContextMenu_onFile() throws Exception {
         menuItems.put("Share", true);
-        menuItems.put("Open", false);
+        menuItems.put("Open", isDesktopFileHandlingFlagEnabled());
         menuItems.put("Open with", true);
         menuItems.put("Cut", true);
         menuItems.put("Copy", true);
@@ -82,6 +81,7 @@ public class ContextMenuUiTest extends ActivityTest<FilesActivity> {
         bots.menu.assertPresentMenuItems(menuItems);
     }
 
+    @Test
     public void testContextMenu_onDir() throws Exception {
         menuItems.put("Cut", true);
         menuItems.put("Copy", true);
@@ -92,6 +92,7 @@ public class ContextMenuUiTest extends ActivityTest<FilesActivity> {
         bots.menu.assertPresentMenuItems(menuItems);
     }
 
+    @Test
     public void testContextMenu_onMixedFileDir() throws Exception {
         menuItems.put("Cut", true);
         menuItems.put("Copy", true);
@@ -102,11 +103,12 @@ public class ContextMenuUiTest extends ActivityTest<FilesActivity> {
         bots.menu.assertPresentMenuItems(menuItems);
     }
 
+    @Test
     public void testContextMenu_onEmptyArea() throws Exception {
         menuItems.put("Select all", true);
         menuItems.put("New folder", true);
         Rect dirListBounds = bots.directory.findDocumentsList().getBounds();
-        Rect dirBounds = bots.directory.findDocument(dirName1).getBounds();
+        Rect dirBounds = bots.directory.findDocument(TestFilesRule.DIR_NAME_1).getBounds();
 
         bots.main.switchToGridMode();
         // right side of dir1 area
diff --git a/tests/functional/com/android/documentsui/DirectoryMessagesUiTest.java b/tests/functional/com/android/documentsui/DirectoryMessagesUiTest.java
index fa2ec3058..15804e720 100644
--- a/tests/functional/com/android/documentsui/DirectoryMessagesUiTest.java
+++ b/tests/functional/com/android/documentsui/DirectoryMessagesUiTest.java
@@ -20,26 +20,26 @@ import android.content.pm.ApplicationInfo;
 import android.content.pm.PackageManager;
 import android.text.TextUtils;
 
-import androidx.test.InstrumentationRegistry;
 import androidx.test.filters.LargeTest;
+import androidx.test.platform.app.InstrumentationRegistry;
+import androidx.test.uiautomator.UiObjectNotFoundException;
 
 import com.android.documentsui.files.FilesActivity;
 import com.android.documentsui.filters.HugeLongTest;
 
-@LargeTest
-public class DirectoryMessagesUiTest extends ActivityTest<FilesActivity> {
+import org.junit.Before;
+import org.junit.Test;
 
-    public DirectoryMessagesUiTest() {
-        super(FilesActivity.class);
-    }
+@LargeTest
+public class DirectoryMessagesUiTest extends ActivityTestJunit4<FilesActivity> {
 
-    @Override
-    public void setUp() throws Exception {
-        super.setUp();
+    @Before
+    public void setUpTest() throws UiObjectNotFoundException {
         bots.roots.openRoot("Demo Root");
         bots.main.switchToListMode();
     }
 
+    @Test
     public void testAuthenticationMessage_visible() throws Exception {
         // If feature is disabled, this test is a no-op.
         if (!features.isRemoteActionsEnabled()) {
@@ -52,6 +52,7 @@ public class DirectoryMessagesUiTest extends ActivityTest<FilesActivity> {
     }
 
     @HugeLongTest
+    @Test
     public void testInfoMessage_visible() throws Exception {
         bots.directory.openDocument(DemoProvider.DIR_INFO);
         bots.directory.assertHasMessage(DemoProvider.MSG_INFO);
@@ -59,6 +60,7 @@ public class DirectoryMessagesUiTest extends ActivityTest<FilesActivity> {
     }
 
     @HugeLongTest
+    @Test
     public void testInfoMessage_dismissable() throws Exception {
         bots.directory.openDocument(DemoProvider.DIR_INFO);
         bots.directory.assertHasMessage(true);
@@ -67,6 +69,7 @@ public class DirectoryMessagesUiTest extends ActivityTest<FilesActivity> {
     }
 
     @HugeLongTest
+    @Test
     public void testErrorMessage_visible() throws Exception {
         bots.directory.openDocument(DemoProvider.DIR_ERROR);
         bots.directory.assertHasMessage(DemoProvider.MSG_ERROR);
@@ -74,6 +77,7 @@ public class DirectoryMessagesUiTest extends ActivityTest<FilesActivity> {
     }
 
     @HugeLongTest
+    @Test
     public void testErrorMessage_dismissable() throws Exception {
         bots.directory.openDocument(DemoProvider.DIR_ERROR);
         bots.directory.assertHasMessage(true);
@@ -82,6 +86,7 @@ public class DirectoryMessagesUiTest extends ActivityTest<FilesActivity> {
     }
 
     @HugeLongTest
+    @Test
     public void testErrorMessage_supercedesInfoMessage() throws Exception {
         // When both error and info are returned in Directory, only show the error.
         bots.directory.openDocument(DemoProvider.DIR_ERROR_AND_INFO);
diff --git a/tests/functional/com/android/documentsui/FileCopyUiTest.java b/tests/functional/com/android/documentsui/FileCopyUiTest.java
index 42681ee82..4d75a6a55 100644
--- a/tests/functional/com/android/documentsui/FileCopyUiTest.java
+++ b/tests/functional/com/android/documentsui/FileCopyUiTest.java
@@ -276,7 +276,7 @@ public class FileCopyUiTest extends ActivityTest<FilesActivity> {
         device.waitForIdle();
 
         bots.main.clickToolbarItem(R.id.action_menu_delete);
-        bots.main.clickDialogOkButton();
+        bots.main.clickDialogOkButton(/* closeSoftKeyboard */ false);
         device.waitForIdle();
 
         bots.directory.findDocument(targetFolder).waitUntilGone(WAIT_TIME_SECONDS);
@@ -393,7 +393,7 @@ public class FileCopyUiTest extends ActivityTest<FilesActivity> {
         bots.main.clickToolbarOverflowItem(context.getResources().getString(R.string.menu_copy));
         device.waitForIdle();
         bots.roots.openRoot(targetRoot);
-        bots.main.clickDialogOkButton();
+        bots.main.clickDialogOkButton(/* closeSoftKeyboard */ false);
         device.waitForIdle();
 
         // Wait until copy operation finished
@@ -485,7 +485,7 @@ public class FileCopyUiTest extends ActivityTest<FilesActivity> {
         assertFalse(bots.directory.findDocument(fileName1).isEnabled());
 
         // Back to FilesActivity to do tear down action if necessary
-        bots.main.clickDialogCancelButton();
+        bots.main.clickDialogCancelButton(/* closeSoftKeyboard */ false);
     }
 
     @HugeLongTest
@@ -520,7 +520,7 @@ public class FileCopyUiTest extends ActivityTest<FilesActivity> {
         device.waitForIdle();
 
         // Select Download folder.
-        bots.directory.selectDocument("Download");
+        bots.directory.selectDocument("Download", 1);
         device.waitForIdle();
 
         // Click copy button.
@@ -533,7 +533,7 @@ public class FileCopyUiTest extends ActivityTest<FilesActivity> {
         device.waitForIdle();
 
         // Initiate the copy operation.
-        bots.main.clickDialogOkButton();
+        bots.main.clickDialogOkButton(/* closeSoftKeyboard */ false);
         device.waitForIdle();
 
         try {
diff --git a/tests/functional/com/android/documentsui/FileDeleteUiTest.java b/tests/functional/com/android/documentsui/FileDeleteUiTest.java
index b10250c3c..023d2c05d 100644
--- a/tests/functional/com/android/documentsui/FileDeleteUiTest.java
+++ b/tests/functional/com/android/documentsui/FileDeleteUiTest.java
@@ -167,7 +167,7 @@ public class FileDeleteUiTest extends ActivityTest<FilesActivity> {
         device.waitForIdle();
 
         bots.main.clickToolbarItem(R.id.action_menu_delete);
-        bots.main.clickDialogOkButton();
+        bots.main.clickDialogOkButton(/* closeSoftKeyboard */ false);
         device.waitForIdle();
 
         try {
diff --git a/tests/functional/com/android/documentsui/FileManagementUiTest.java b/tests/functional/com/android/documentsui/FileManagementUiTest.java
index 43b74bd33..33127c48e 100644
--- a/tests/functional/com/android/documentsui/FileManagementUiTest.java
+++ b/tests/functional/com/android/documentsui/FileManagementUiTest.java
@@ -19,50 +19,44 @@ package com.android.documentsui;
 import static com.android.documentsui.StubProvider.ROOT_0_ID;
 import static com.android.documentsui.StubProvider.ROOT_1_ID;
 
+import static org.junit.Assert.fail;
+
 import android.net.Uri;
 import android.os.Bundle;
-import android.os.RemoteException;
 import android.view.KeyEvent;
 
 import androidx.test.filters.LargeTest;
-import androidx.test.filters.Suppress;
 
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.Shared;
 import com.android.documentsui.files.FilesActivity;
 import com.android.documentsui.filters.HugeLongTest;
+import com.android.documentsui.rules.TestFilesRule;
 import com.android.documentsui.sorting.SortDimension;
 import com.android.documentsui.sorting.SortModel;
 
+import org.junit.Ignore;
+import org.junit.Rule;
+import org.junit.Test;
+
 import java.util.List;
 
 @LargeTest
-public class FileManagementUiTest extends ActivityTest<FilesActivity> {
-
-    public FileManagementUiTest() {
-        super(FilesActivity.class);
-    }
-
-    @Override
-    public void setUp() throws Exception {
-        super.setUp();
-        initTestFiles();
-    }
-
-    @Override
-    public void initTestFiles() throws RemoteException {
-        Uri uri = mDocsHelper.createFolder(rootDir0, dirName1);
-        mDocsHelper.createFolder(uri, childDir1);
-
-        mDocsHelper.createDocument(rootDir0, "text/plain", "file0.log");
-        mDocsHelper.createDocument(rootDir0, "image/png", "file1.png");
-        mDocsHelper.createDocument(rootDir0, "text/csv", "file2.csv");
-
-        mDocsHelper.createDocument(rootDir1, "text/plain", "anotherFile0.log");
-        mDocsHelper.createDocument(rootDir1, "text/plain", "poodles.text");
-    }
-
-    @Suppress
+public class FileManagementUiTest extends ActivityTestJunit4<FilesActivity> {
+
+    @Rule
+    public final TestFilesRule mTestFilesRule =
+            new TestFilesRule()
+                    .createFolderInRoot(ROOT_0_ID, TestFilesRule.DIR_NAME_1)
+                    .createFolderWithParent(TestFilesRule.DIR_NAME_1, "ChildDir1")
+                    .createFileInRoot(ROOT_0_ID, "file0.log", "text/plain")
+                    .createFileInRoot(ROOT_0_ID, "file1.png", "image/png")
+                    .createFileInRoot(ROOT_0_ID, "file2.csv", "text/csv")
+                    .createFileInRoot(ROOT_0_ID, "anotherFile0.log", "text/plain")
+                    .createFileInRoot(ROOT_0_ID, "poodles.text", "text/plain");
+
+    @Ignore
+    @Test
     public void testCreateDirectory() throws Exception {
         bots.main.openOverflowMenu();
         device.waitForIdle();
@@ -78,18 +72,20 @@ public class FileManagementUiTest extends ActivityTest<FilesActivity> {
         bots.directory.waitForDocument("Kung Fu Panda");
     }
 
+    @Test
     public void testDeleteDocument() throws Exception {
         bots.directory.selectDocument("file1.png", 1);
         device.waitForIdle();
         bots.main.clickToolbarItem(R.id.action_menu_delete);
 
-        bots.main.clickDialogOkButton();
+        bots.main.clickDialogOkButton(/* closeSoftKeyboard */ false);
         device.waitForIdle();
 
         bots.directory.assertDocumentsAbsent("file1.png");
     }
 
     @HugeLongTest
+    @Test
     public void testKeyboard_CutDocument() throws Exception {
         bots.directory.selectDocument("file1.png", 1);
         device.waitForIdle();
@@ -108,6 +104,7 @@ public class FileManagementUiTest extends ActivityTest<FilesActivity> {
     }
 
     @HugeLongTest
+    @Test
     public void testKeyboard_CopyDocument() throws Exception {
         bots.directory.selectDocument("file1.png", 1);
         device.waitForIdle();
@@ -125,6 +122,7 @@ public class FileManagementUiTest extends ActivityTest<FilesActivity> {
     }
 
     @HugeLongTest
+    @Test
     public void testKeyboard_PasteDocumentWhileSelectionActive() throws Exception {
         bots.directory.selectDocument("file1.png", 1);
         bots.keyboard.pressKey(KeyEvent.KEYCODE_C, KeyEvent.META_CTRL_ON);
@@ -139,17 +137,19 @@ public class FileManagementUiTest extends ActivityTest<FilesActivity> {
         bots.directory.assertDocumentsPresent("file1.png");
     }
 
+    @Test
     public void testDeleteDocument_Cancel() throws Exception {
         bots.directory.selectDocument("file1.png", 1);
         device.waitForIdle();
         bots.main.clickToolbarItem(R.id.action_menu_delete);
 
-        bots.main.clickDialogCancelButton();
+        bots.main.clickDialogCancelButton(/* closeSoftKeyboard */ false);
 
         bots.directory.waitForDocument("file1.png");
     }
 
     @HugeLongTest
+    @Test
     public void testCopyLargeAmountOfFiles() throws Exception {
         // Suppress root notification. We're gonna create tons of files and it will soon crash
         // DocsUI because too many root refreshes are queued in an executor.
diff --git a/tests/functional/com/android/documentsui/FilesActivityDefaultsUiTest.java b/tests/functional/com/android/documentsui/FilesActivityDefaultsUiTest.java
index e6538966f..f386e4075 100644
--- a/tests/functional/com/android/documentsui/FilesActivityDefaultsUiTest.java
+++ b/tests/functional/com/android/documentsui/FilesActivityDefaultsUiTest.java
@@ -18,13 +18,6 @@ package com.android.documentsui;
 
 import static com.android.documentsui.StubProvider.ROOT_0_ID;
 import static com.android.documentsui.StubProvider.ROOT_1_ID;
-import static com.android.documentsui.flags.Flags.FLAG_HIDE_ROOTS_ON_DESKTOP_RO;
-
-import android.content.pm.PackageManager;
-import android.platform.test.annotations.RequiresFlagsDisabled;
-import android.platform.test.annotations.RequiresFlagsEnabled;
-import android.platform.test.flag.junit.CheckFlagsRule;
-import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 
 import androidx.test.ext.junit.runners.AndroidJUnit4;
 import androidx.test.filters.LargeTest;
@@ -32,9 +25,9 @@ import androidx.test.filters.LargeTest;
 import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.files.FilesActivity;
 import com.android.documentsui.filters.HugeLongTest;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
+import com.android.documentsui.rules.TestFilesRule;
 
-import org.junit.After;
-import org.junit.Before;
 import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
@@ -44,22 +37,10 @@ import org.junit.runner.RunWith;
 public class FilesActivityDefaultsUiTest extends ActivityTestJunit4<FilesActivity> {
 
     @Rule
-    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
-
-    @Before
-    public void setUp() throws Exception {
-        super.setUp();
-    }
-
-    @After
-    public void tearDown() throws Exception {
-        super.tearDown();
-    }
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
 
-    @Override
-    protected void initTestFiles() {
-        // Overriding to init with no items in test roots
-    }
+    @Rule
+    public final TestFilesRule mTestFilesRule = new TestFilesRule(/* skipCreation */ true);
 
     @Override
     protected RootInfo getInitialRoot() {
@@ -71,7 +52,7 @@ public class FilesActivityDefaultsUiTest extends ActivityTestJunit4<FilesActivit
     public void testNavigate_FromEmptyDirectory() throws Exception {
         device.waitForIdle();
 
-        bots.roots.openRoot(rootDir0.title);
+        bots.roots.openRoot(mTestFilesRule.getRoot(ROOT_0_ID).title);
 
         String msg = String.valueOf(context.getString(R.string.empty));
         bots.directory.assertPlaceholderMessageText(msg);
@@ -82,43 +63,18 @@ public class FilesActivityDefaultsUiTest extends ActivityTestJunit4<FilesActivit
 
     @Test
     @HugeLongTest
-    @RequiresFlagsDisabled(FLAG_HIDE_ROOTS_ON_DESKTOP_RO)
-    public void testDefaultRoots_hideRootsOnDesktopFlagDisabled() throws Exception {
+    public void testDefaultRoots() throws Exception {
         device.waitForIdle();
 
         // Should also have Drive, but that requires pre-configuration of devices
         // We omit for now.
         bots.roots.assertRootsPresent(
-                "Images",
-                "Videos",
-                "Audio",
                 "Downloads",
                 ROOT_0_ID,
                 ROOT_1_ID);
-    }
 
-    @Test
-    @HugeLongTest
-    @RequiresFlagsEnabled(FLAG_HIDE_ROOTS_ON_DESKTOP_RO)
-    public void testDefaultRoots_hideRootsOnDesktopFlagEnabled() throws Exception {
-        device.waitForIdle();
-
-        String[] expectedRoots;
-        if (context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_PC)) {
-            expectedRoots = new String[]{"Downloads",
-                    ROOT_0_ID,
-                    ROOT_1_ID};
-        } else {
-            expectedRoots = new String[]{
-                    "Images",
-                    "Videos",
-                    "Audio",
-                    "Downloads",
-                    ROOT_0_ID,
-                    ROOT_1_ID};
+        if (context.getResources().getBoolean(R.bool.show_media_roots)) {
+            bots.roots.assertRootsPresent("Audio", "Images");
         }
-        // Should also have Drive, but that requires pre-configuration of devices
-        // We omit for now.
-        bots.roots.assertRootsPresent(expectedRoots);
     }
 }
diff --git a/tests/functional/com/android/documentsui/FilesActivityUiTest.java b/tests/functional/com/android/documentsui/FilesActivityUiTest.java
index 6c2397068..d0c7c9062 100644
--- a/tests/functional/com/android/documentsui/FilesActivityUiTest.java
+++ b/tests/functional/com/android/documentsui/FilesActivityUiTest.java
@@ -16,27 +16,44 @@
 
 package com.android.documentsui;
 
-import static com.android.documentsui.flags.Flags.FLAG_HIDE_ROOTS_ON_DESKTOP_RO;
-import static com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY;
+import static androidx.test.espresso.Espresso.onView;
+import static androidx.test.espresso.assertion.ViewAssertions.doesNotExist;
+import static androidx.test.espresso.assertion.ViewAssertions.matches;
+import static androidx.test.espresso.matcher.ViewMatchers.isDisplayed;
+import static androidx.test.espresso.matcher.ViewMatchers.withId;
+
+import static com.android.documentsui.StubProvider.ROOT_0_ID;
+import static com.android.documentsui.StubProvider.ROOT_1_ID;
+import static com.android.documentsui.base.Providers.AUTHORITY_STORAGE;
+import static com.android.documentsui.base.Providers.ROOT_ID_DEVICE;
 import static com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3;
+import static com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
+import static junit.framework.Assert.assertFalse;
+import static junit.framework.Assert.assertTrue;
 
 import android.app.Instrumentation;
+import android.content.ContentResolver;
 import android.net.Uri;
-import android.os.RemoteException;
 import android.platform.test.annotations.RequiresFlagsDisabled;
 import android.platform.test.annotations.RequiresFlagsEnabled;
-import android.platform.test.flag.junit.CheckFlagsRule;
-import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 
 import androidx.test.ext.junit.runners.AndroidJUnit4;
 import androidx.test.filters.LargeTest;
+import androidx.test.uiautomator.By;
+import androidx.test.uiautomator.UiObjectNotFoundException;
+import androidx.test.uiautomator.Until;
 
+import com.android.documentsui.base.DocumentInfo;
+import com.android.documentsui.base.RootInfo;
+import com.android.documentsui.base.UserId;
 import com.android.documentsui.files.FilesActivity;
 import com.android.documentsui.filters.HugeLongTest;
 import com.android.documentsui.inspector.InspectorActivity;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
+import com.android.documentsui.rules.TestFilesRule;
 
-import org.junit.After;
-import org.junit.Before;
 import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
@@ -46,31 +63,18 @@ import org.junit.runner.RunWith;
 public class FilesActivityUiTest extends ActivityTestJunit4<FilesActivity> {
 
     @Rule
-    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
-
-    @Before
-    public void setUp() throws Exception {
-        super.setUp();
-        initTestFiles();
-    }
-
-    @After
-    public void tearDown() throws Exception {
-        super.tearDown();
-    }
-
-    @Override
-    public void initTestFiles() throws RemoteException {
-        Uri uri = mDocsHelper.createFolder(rootDir0, dirName1);
-        mDocsHelper.createFolder(uri, childDir1);
-
-        mDocsHelper.createDocument(rootDir0, "text/plain", "file0.log");
-        mDocsHelper.createDocument(rootDir0, "image/png", "file1.png");
-        mDocsHelper.createDocument(rootDir0, "text/csv", "file2.csv");
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
 
-        mDocsHelper.createDocument(rootDir1, "text/plain", "anotherFile0.log");
-        mDocsHelper.createDocument(rootDir1, "text/plain", "poodles.text");
-    }
+    @Rule
+    public final TestFilesRule mTestFilesRule =
+            new TestFilesRule()
+                    .createFolderInRoot(ROOT_0_ID, TestFilesRule.DIR_NAME_1)
+                    .createFolderWithParent(TestFilesRule.DIR_NAME_1, TestFilesRule.CHILD_DIR_1)
+                    .createFileInRoot(ROOT_0_ID, "file0.log", "text/plain")
+                    .createFileInRoot(ROOT_0_ID, "file1.png", "image/png")
+                    .createFileInRoot(ROOT_0_ID, "file2.csv", "text/csv")
+                    .createFileInRoot(ROOT_0_ID, "anotherFile0.log", "text/plain")
+                    .createFileInRoot(ROOT_0_ID, "poodles.text", "text/plain");
 
     // Recents is a strange meta root that gathers entries from other providers.
     // It is special cased in a variety of ways, which is why we just want
@@ -80,16 +84,56 @@ public class FilesActivityUiTest extends ActivityTestJunit4<FilesActivity> {
         bots.roots.openRoot("Recent");
 
         boolean showSearchBar =
-                context.getResources().getBoolean(R.bool.show_search_bar);
+                isUseMaterial3FlagEnabled() ? false : context.getResources().getBoolean(
+                        R.bool.show_search_bar);
         if (showSearchBar) {
             bots.main.assertSearchBarShow();
         } else {
+            bots.main.assertSearchBarGone();
+            bots.search.assertIconVisible(true);
             bots.main.assertWindowTitle("Recent");
         }
     }
 
+    private DocumentsProviderHelper setupStorageAuthorityDocsHelper() throws Exception {
+        // Create DocumentsProviderHelper to create files in Internal storage.
+        DocumentsProviderHelper storageDocsHelper =
+                new DocumentsProviderHelper(
+                        UserId.DEFAULT_USER, AUTHORITY_STORAGE, context, AUTHORITY_STORAGE);
+
+        RootInfo primaryRoot = storageDocsHelper.getRoot(ROOT_ID_DEVICE);
+
+        // Create Download folder if it doesn't exist.
+        DocumentInfo info = storageDocsHelper.findFile(primaryRoot.documentId, "Download");
+
+        if (info == null) {
+            ContentResolver cr = context.getContentResolver();
+            Uri uri = storageDocsHelper.createFolder(primaryRoot.documentId, "Download");
+            info = DocumentInfo.fromUri(cr, uri, UserId.DEFAULT_USER);
+        }
+
+        assertTrue(info != null && info.isDirectory());
+        return storageDocsHelper;
+    }
+
+    private void cleanupFile(String fileName, String primaryRootTitle)
+            throws UiObjectNotFoundException {
+        bots.roots.openRoot(primaryRootTitle);
+        bots.directory.openDocument("Download");
+
+        bots.directory.waitForDocument(fileName);
+        bots.directory.selectDocument(fileName, 1);
+
+        bots.main.clickToolbarItem(R.id.action_menu_delete);
+        bots.main.clickDialogOkButton(/* closeSoftKeyboard */ false);
+        device.waitForIdle();
+
+        bots.directory.findDocument(fileName).waitUntilGone(5000);
+        assertFalse(bots.directory.hasDocuments(fileName));
+    }
+
     @Test
-    @RequiresFlagsDisabled(FLAG_HIDE_ROOTS_ON_DESKTOP_RO)
+    @RequiresFlagsDisabled(FLAG_USE_MATERIAL3)
     public void testRootClick_SetsWindowTitle() throws Exception {
         bots.roots.openRoot("Images");
         bots.main.assertWindowTitle("Images");
@@ -112,7 +156,8 @@ public class FilesActivityUiTest extends ActivityTestJunit4<FilesActivity> {
     }
 
     private void filesListed_LiveUpdates() throws Exception {
-        mDocsHelper.createDocument(rootDir0, "yummers/sandwich", "Ham & Cheese.sandwich");
+        RootInfo root = mTestFilesRule.docsHelper.getRoot(ROOT_0_ID);
+        mTestFilesRule.docsHelper.createDocument(root, "yummers/sandwich", "Ham & Cheese.sandwich");
 
         bots.directory.waitForDocument("Ham & Cheese.sandwich");
         bots.directory.assertDocumentsPresent(
@@ -133,26 +178,26 @@ public class FilesActivityUiTest extends ActivityTestJunit4<FilesActivity> {
 
     @Test
     public void testNavigate_byBreadcrumb() throws Exception {
-        bots.directory.openDocument(dirName1);
-        bots.directory.waitForDocument(childDir1);  // wait for known content
-        bots.directory.assertDocumentsPresent(childDir1);
+        bots.directory.openDocument(TestFilesRule.DIR_NAME_1);
+        bots.directory.waitForDocument(TestFilesRule.CHILD_DIR_1);  // wait for known content
+        bots.directory.assertDocumentsPresent(TestFilesRule.CHILD_DIR_1);
 
         device.waitForIdle();
-        bots.breadcrumb.assertItemsPresent(dirName1, "TEST_ROOT_0");
+        bots.breadcrumb.assertItemsPresent(TestFilesRule.DIR_NAME_1, "TEST_ROOT_0");
 
         bots.breadcrumb.clickItem("TEST_ROOT_0");
-        bots.directory.waitForDocument(dirName1);
+        bots.directory.waitForDocument(TestFilesRule.DIR_NAME_1);
     }
 
     @Test
     public void testNavigate_inFixedLayout_whileHasSelection() throws Exception {
         if (bots.main.inFixedLayout()) {
-            bots.roots.openRoot(rootDir0.title);
+            bots.roots.openRoot(mTestFilesRule.getRoot(ROOT_0_ID).title);
             device.waitForIdle();
             bots.directory.selectDocument("file0.log", 1);
 
             // ensure no exception is thrown while navigating to a different root
-            bots.roots.openRoot(rootDir1.title);
+            bots.roots.openRoot(mTestFilesRule.getRoot(ROOT_1_ID).title);
         }
     }
 
@@ -163,14 +208,14 @@ public class FilesActivityUiTest extends ActivityTestJunit4<FilesActivity> {
         }
         Instrumentation.ActivityMonitor monitor = new Instrumentation.ActivityMonitor(
                 InspectorActivity.class.getName(), null, false);
-        bots.directory.selectDocument("file0.log");
+        bots.directory.selectDocument("file0.log", 1);
         bots.main.clickActionItem("Get info");
         monitor.waitForActivityWithTimeout(TIMEOUT);
     }
 
     @Test
     @HugeLongTest
-    @RequiresFlagsDisabled(FLAG_HIDE_ROOTS_ON_DESKTOP_RO)
+    @RequiresFlagsDisabled(FLAG_USE_MATERIAL3)
     public void testRootChange_UpdatesSortHeader() throws Exception {
 
         // switch to separate display modes for two separate roots. Each
@@ -193,4 +238,85 @@ public class FilesActivityUiTest extends ActivityTestJunit4<FilesActivity> {
             bots.sort.assertHeaderHide();
         }
     }
+
+    @Test
+    @RequiresFlagsDisabled(FLAG_USE_MATERIAL3)
+    public void testRootChange_NonM3PerRootViewModeState() throws Exception {
+        // Assign different view modes across "Images" and "Videos" roots.
+        // Images root --> grid mode
+        // Videos root --> list mode
+        bots.roots.openRoot("Images");
+        bots.main.switchToGridMode();
+        bots.main.assertInGridMode();
+        bots.roots.openRoot("Videos");
+        bots.main.switchToListMode();
+        bots.main.assertInListMode();
+
+        // Assert that the different roots maintain their respective view modes.
+        bots.roots.openRoot("Images");
+        bots.main.assertInGridMode();
+        bots.roots.openRoot("Videos");
+        bots.main.assertInListMode();
+    }
+
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_MATERIAL3)
+    public void testRootChange_M3GlobalViewModeState() throws Exception {
+        bots.roots.openRoot("Recent");
+        bots.main.switchToGridMode();
+        bots.main.assertInGridMode();
+
+        // Switch to a different root and assert still in grid mode.
+        bots.roots.openRoot(ROOT_0_ID);
+        bots.main.assertInGridMode();
+
+        // Switch back to list mode and assert still in list mode on a different root.
+        bots.main.switchToListMode();
+        bots.main.assertInListMode();
+        bots.roots.openRoot("Recent");
+        bots.main.assertInListMode();
+    }
+
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_MATERIAL3)
+    public void testClearSelectionInRecentsResetsActions() throws Exception {
+        // Ensure Downloads exists and get the location of the main root (e.g. "Pixel Tablet").
+        DocumentsProviderHelper storageDocsHelper = setupStorageAuthorityDocsHelper();
+        RootInfo primaryRoot = storageDocsHelper.getRoot(ROOT_ID_DEVICE);
+        DocumentInfo info = storageDocsHelper.findFile(primaryRoot.documentId, "Download");
+
+        // Create a file in "Download".
+        final String fileName = "recent_file.txt";
+        storageDocsHelper.createDocument(info.documentId, "text/plain", fileName);
+
+        // Navigate to "Download" and ensure the file exists (this should ensure it also exists in
+        // Recent).
+        bots.roots.openRoot(primaryRoot.title);
+        bots.directory.openDocument("Download");
+        bots.directory.waitForDocument(fileName);
+
+        // Open Recent and wait for the document to appear.
+        bots.roots.openRoot("Recent");
+        bots.directory.waitForDocument(fileName);
+
+        try {
+            // The search option menu shows up when no items are selected, use this as a proxy for
+            // the options menu being refreshed (it should only show when a file is selected).
+            onView(withId(R.id.action_menu_share)).check(doesNotExist());
+
+            // Select the first document in Recents that has a selectable region. We have previously
+            // staged a file so there should be at least 1, but depending on the device and the
+            // cleanup of the device this might not always be the case. The document that gets
+            // selected doesn't really matter, just that one is selected.
+            bots.directory.selectFirstDocument();
+            onView(withId(R.id.action_menu_share)).check(matches(isDisplayed()));
+
+            // Deselect the file and ensure the share menu disappears (this ensures the menu is
+            // refreshed).
+            bots.directory.clearSelection();
+            device.wait(Until.gone(By.desc("Share")), /* timeout= */ 5000);
+        } finally {
+            cleanupFile(fileName, primaryRoot.title);
+        }
+    }
 }
diff --git a/tests/functional/com/android/documentsui/FingerSelectionUiTest.java b/tests/functional/com/android/documentsui/FingerSelectionUiTest.java
index 69b473bbf..8e32320b9 100644
--- a/tests/functional/com/android/documentsui/FingerSelectionUiTest.java
+++ b/tests/functional/com/android/documentsui/FingerSelectionUiTest.java
@@ -22,25 +22,28 @@ import android.graphics.Rect;
 import androidx.test.filters.LargeTest;
 
 import com.android.documentsui.files.FilesActivity;
+import com.android.documentsui.rules.TestFilesRule;
+
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
 
 @LargeTest
-public class FingerSelectionUiTest extends ActivityTest<FilesActivity> {
+public class FingerSelectionUiTest extends ActivityTestJunit4<FilesActivity> {
 
-    public FingerSelectionUiTest() {
-        super(FilesActivity.class);
-    }
+    @Rule
+    public final TestFilesRule mTestFilesRule = new TestFilesRule();
 
-    @Override
-    public void setUp() throws Exception {
-        super.setUp();
-        initTestFiles();
+    @Before
+    public void setUpTest() {
         bots.roots.closeDrawer();
     }
 
+    @Test
     public void testFingerSelection_outOfRange() throws Exception {
         bots.main.switchToGridMode();
         Rect dirListBounds = bots.directory.findDocumentsList().getBounds();
-        Rect firstDoc = bots.directory.findDocument(fileName1).getBounds();
+        Rect firstDoc = bots.directory.findDocument(TestFilesRule.FILE_NAME_1).getBounds();
         // Start from list right bottom.
         Point start = new Point(firstDoc.centerX(), firstDoc.centerY());
         // End is center of file1
diff --git a/tests/functional/com/android/documentsui/GestureSelectionUiTest.java b/tests/functional/com/android/documentsui/GestureSelectionUiTest.java
index 4c2b40391..35f3d6fa5 100644
--- a/tests/functional/com/android/documentsui/GestureSelectionUiTest.java
+++ b/tests/functional/com/android/documentsui/GestureSelectionUiTest.java
@@ -19,47 +19,53 @@ package com.android.documentsui;
 import androidx.test.filters.LargeTest;
 
 import com.android.documentsui.files.FilesActivity;
+import com.android.documentsui.rules.TestFilesRule;
+
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
 
 @LargeTest
-public class GestureSelectionUiTest extends ActivityTest<FilesActivity> {
+public class GestureSelectionUiTest extends ActivityTestJunit4<FilesActivity> {
 
-    public GestureSelectionUiTest() {
-        super(FilesActivity.class);
-    }
+    @Rule
+    public final TestFilesRule mTestFilesRule = new TestFilesRule();
 
-    @Override
-    public void setUp() throws Exception {
-        super.setUp();
-        initTestFiles();
+    @Before
+    public void setUpTest() {
         bots.roots.closeDrawer();
     }
 
+    @Test
     public void testGridGestureSelect_twoFiles() throws Exception {
         bots.main.switchToGridMode();
-        bots.gesture.gestureSelectFiles(fileName1, fileName2);
+        bots.gesture.gestureSelectFiles(TestFilesRule.FILE_NAME_1, TestFilesRule.FILE_NAME_2);
 
         bots.directory.assertSelection(2);
     }
 
+    @Test
     public void testGridGestureSelect_multipleFiles() throws Exception {
         bots.main.switchToGridMode();
-        bots.gesture.gestureSelectFiles(fileName2, dirName1);
+        bots.gesture.gestureSelectFiles(TestFilesRule.FILE_NAME_2, TestFilesRule.DIR_NAME_1);
 
         bots.directory.assertSelection(3);
 
     }
 
+    @Test
     public void testListGestureSelect_twoFiles() throws Exception {
         bots.main.switchToListMode();
-        bots.gesture.gestureSelectFiles(fileName1, fileName2);
+        bots.gesture.gestureSelectFiles(TestFilesRule.FILE_NAME_1, TestFilesRule.FILE_NAME_2);
 
         bots.directory.assertSelection(2);
 
     }
 
+    @Test
     public void testListGestureSelect_multipleFiles() throws Exception {
         bots.main.switchToListMode();
-        bots.gesture.gestureSelectFiles(fileName2, dirName1);
+        bots.gesture.gestureSelectFiles(TestFilesRule.FILE_NAME_2, TestFilesRule.DIR_NAME_1);
 
         bots.directory.assertSelection(3);
 
diff --git a/tests/functional/com/android/documentsui/IntegratedDownloadsUiTest.java b/tests/functional/com/android/documentsui/IntegratedDownloadsUiTest.java
index aa55be9d2..a206e4bd1 100644
--- a/tests/functional/com/android/documentsui/IntegratedDownloadsUiTest.java
+++ b/tests/functional/com/android/documentsui/IntegratedDownloadsUiTest.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui;
 
+import static org.junit.Assert.assertTrue;
+
 import android.app.DownloadManager;
 import android.app.DownloadManager.Request;
 import android.content.Context;
@@ -23,23 +25,22 @@ import android.net.Uri;
 import android.view.MotionEvent;
 
 import androidx.test.filters.LargeTest;
-import androidx.test.filters.Suppress;
 import androidx.test.uiautomator.Configurator;
 import androidx.test.uiautomator.UiObject;
 
 import com.android.documentsui.files.FilesActivity;
 
+import org.junit.Ignore;
+import org.junit.Test;
+
 // TODO: As of this writing all tests in this class are disabled. Please fix.
 @LargeTest
-public class IntegratedDownloadsUiTest extends ActivityTest<FilesActivity> {
-
-    public IntegratedDownloadsUiTest() {
-        super(FilesActivity.class);
-    }
+public class IntegratedDownloadsUiTest extends ActivityTestJunit4<FilesActivity> {
 
     // We don't really need to test the entirety of download support
     // since downloads is (almost) just another provider.
-    @Suppress
+    @Ignore
+    @Test
     public void testDownload_Queued() throws Exception {
         DownloadManager dm = (DownloadManager) context.getSystemService(
                 Context.DOWNLOAD_SERVICE);
@@ -51,7 +52,8 @@ public class IntegratedDownloadsUiTest extends ActivityTest<FilesActivity> {
         bots.directory.assertDocumentsPresent("Queued");
     }
 
-    @Suppress
+    @Ignore
+    @Test
     public void testDownload_RetryUnsuccessful() throws Exception {
         DownloadManager dm = (DownloadManager) context.getSystemService(
                 Context.DOWNLOAD_SERVICE);
diff --git a/tests/functional/com/android/documentsui/InternalStorageUiTest.java b/tests/functional/com/android/documentsui/InternalStorageUiTest.java
index 5b2b18d93..a5a9f6a47 100644
--- a/tests/functional/com/android/documentsui/InternalStorageUiTest.java
+++ b/tests/functional/com/android/documentsui/InternalStorageUiTest.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui;
 
+import static org.junit.Assert.assertNull;
+
 import androidx.test.filters.LargeTest;
 
 import com.android.documentsui.base.Providers;
@@ -23,26 +25,24 @@ import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.files.FilesActivity;
 import com.android.documentsui.filters.HugeLongTest;
 
+import org.junit.After;
+import org.junit.Before;
+import org.junit.Test;
+
 /**
  * A Ui test will do tests in the internal storage root. It is implemented because some operations
  * is failed and its result will different from the test on the StubProvider. b/115304092 is a
- * example which only happen on root from ExternalStorageProvidrer.
+ * example which only happen on root from ExternalStorageProvider.
  */
 @LargeTest
-public class InternalStorageUiTest extends ActivityTest<FilesActivity> {
+public class InternalStorageUiTest extends ActivityTestJunit4<FilesActivity> {
 
     private static final String fileName = "!Test3345678";
     private static final String newFileName = "!9527Test";
     private RootInfo rootPrimary;
 
-    public InternalStorageUiTest() {
-        super(FilesActivity.class);
-    }
-
-    @Override
-    public void setUp() throws Exception {
-        super.setUp();
-
+    @Before
+    public void setUpTest() throws Exception {
         mDocsHelper = new DocumentsProviderHelper(userId, Providers.AUTHORITY_STORAGE, context,
                 Providers.AUTHORITY_STORAGE);
         rootPrimary = mDocsHelper.getRoot(Providers.ROOT_ID_DEVICE);
@@ -51,17 +51,17 @@ public class InternalStorageUiTest extends ActivityTest<FilesActivity> {
         deleteTestFiles();
     }
 
-    @Override
-    public void tearDown() throws Exception {
+    @After
+    public void tearDownTest() throws Exception {
         deleteTestFiles();
-        super.tearDown();
     }
 
     @HugeLongTest
+    @Test
     public void testRenameFile() throws Exception {
         createTestFiles();
 
-        bots.directory.selectDocument(fileName);
+        bots.directory.selectDocument(fileName, 1);
         device.waitForIdle();
 
         bots.main.clickRename();
@@ -85,19 +85,19 @@ public class InternalStorageUiTest extends ActivityTest<FilesActivity> {
         boolean selected = false;
         // Delete the added file for not affect user and also avoid error on next test.
         if (bots.directory.hasDocuments(fileName)) {
-            bots.directory.selectDocument(fileName);
+            bots.directory.selectDocument(fileName, 1);
             device.waitForIdle();
             selected = true;
         }
         if (bots.directory.hasDocuments(newFileName)) {
-            bots.directory.selectDocument(newFileName);
+            bots.directory.selectDocument(newFileName, 1);
             device.waitForIdle();
             selected = true;
         }
         if (selected) {
             bots.main.clickDelete();
             device.waitForIdle();
-            bots.main.clickDialogOkButton();
+            bots.main.clickDialogOkButton(/* closeSoftKeyboard */ false);
         }
     }
 }
diff --git a/tests/functional/com/android/documentsui/JobPanelUiTest.kt b/tests/functional/com/android/documentsui/JobPanelUiTest.kt
index 5b28b1f5d..edf140fee 100644
--- a/tests/functional/com/android/documentsui/JobPanelUiTest.kt
+++ b/tests/functional/com/android/documentsui/JobPanelUiTest.kt
@@ -17,39 +17,70 @@ package com.android.documentsui
 
 import android.content.Intent
 import android.platform.test.annotations.RequiresFlagsEnabled
-import android.platform.test.flag.junit.CheckFlagsRule
-import android.platform.test.flag.junit.DeviceFlagsValueProvider
+import android.view.KeyEvent
+import android.view.View
+import android.widget.ProgressBar
+import androidx.test.espresso.Espresso
 import androidx.test.espresso.Espresso.onView
 import androidx.test.espresso.action.ViewActions.click
 import androidx.test.espresso.assertion.ViewAssertions.doesNotExist
 import androidx.test.espresso.assertion.ViewAssertions.matches
+import androidx.test.espresso.assertion.ViewAssertions.selectedDescendantsMatch
+import androidx.test.espresso.matcher.BoundedMatcher
+import androidx.test.espresso.matcher.ViewMatchers.hasChildCount
+import androidx.test.espresso.matcher.ViewMatchers.hasSibling
 import androidx.test.espresso.matcher.ViewMatchers.isDisplayed
+import androidx.test.espresso.matcher.ViewMatchers.withChild
 import androidx.test.espresso.matcher.ViewMatchers.withId
+import androidx.test.espresso.matcher.ViewMatchers.withText
 import androidx.test.ext.junit.runners.AndroidJUnit4
 import androidx.test.platform.app.InstrumentationRegistry
 import com.android.documentsui.files.FilesActivity
 import com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3
 import com.android.documentsui.flags.Flags.FLAG_VISUAL_SIGNALS_RO
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import com.android.documentsui.rules.TestFilesRule
+import com.android.documentsui.services.FileOperationService
 import com.android.documentsui.services.FileOperationService.ACTION_PROGRESS
 import com.android.documentsui.services.FileOperationService.EXTRA_PROGRESS
 import com.android.documentsui.services.Job
 import com.android.documentsui.services.JobProgress
 import com.android.documentsui.testing.MutableJobProgress
-import org.junit.After
-import org.junit.Before
+import org.hamcrest.Description
+import org.hamcrest.Matcher
+import org.hamcrest.Matchers.allOf
+import org.hamcrest.Matchers.not
 import org.junit.Rule
 import org.junit.Test
 import org.junit.runner.RunWith
 
+private fun withProgress(expectedProgress: Int): Matcher<View> {
+    return object : BoundedMatcher<View, ProgressBar>(ProgressBar::class.java) {
+        override fun matchesSafely(view: ProgressBar): Boolean {
+            return view.progress == expectedProgress
+        }
+
+        override fun describeTo(description: Description) {
+            description.appendText("with progress: " + expectedProgress)
+        }
+    }
+}
+
+// Helper function to match views inside a certain progress item view.
+private fun insideItem(progress: MutableJobProgress) = hasSibling(withText(progress.msg))
+
 @RequiresFlagsEnabled(FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO)
 @RunWith(AndroidJUnit4::class)
 class JobPanelUiTest : ActivityTestJunit4<FilesActivity>() {
     @get:Rule
-    val mCheckFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+    val checkFlags = CheckAndForceMaterial3Flag()
+
+    @get:Rule
+    val testFiles = TestFilesRule()
 
-    private var mLastId = 0L
+    private var lastId = 0L
 
-    private fun sendProgress(progresses: ArrayList<JobProgress>, id: Long = mLastId++) {
+    private fun sendProgress(progresses: ArrayList<JobProgress>, id: Long = lastId++) {
         val context = InstrumentationRegistry.getInstrumentation().targetContext
         var intent = Intent(ACTION_PROGRESS).apply {
             `package` = context.packageName
@@ -59,35 +90,274 @@ class JobPanelUiTest : ActivityTestJunit4<FilesActivity>() {
         context.sendBroadcast(intent)
     }
 
-    @Before
-    override fun setUp() {
-        super.setUp()
+    private fun openPanel() {
+        onView(withId(R.id.job_progress_toolbar_indicator))
+            .check(matches(isDisplayed()))
+            .perform(click())
+        onView(withId(R.id.job_progress_panel_title)).check(matches(isDisplayed()))
     }
 
-    @After
-    override fun tearDown() {
-        super.tearDown()
+    @Test
+    fun testInProgressItems() {
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(doesNotExist())
+        onView(withId(R.id.job_progress_panel_title)).check(doesNotExist())
+
+        val progress = MutableJobProgress(
+            id = "jobId1",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_SET_UP,
+            msg = "Job started",
+            hasFailures = false,
+            currentBytes = 4,
+            requiredBytes = 10,
+            msRemaining = 10000,
+        )
+        sendProgress(arrayListOf(progress.toJobProgress()))
+
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(matches(withProgress(40)))
+
+        openPanel()
+
+        val expectedPrimaryStatus = "4 B of 10 B"
+        val expectedSecondaryStatus = "10 seconds left"
+
+        onView(withId(R.id.job_progress_item_title)).check(matches(withText("Job started")))
+        onView(withId(R.id.job_progress_item_progress)).check(matches(withProgress(40)))
+        onView(allOf(withText(expectedPrimaryStatus), isDisplayed())).check(doesNotExist())
+        onView(allOf(withText(expectedSecondaryStatus), isDisplayed())).check(doesNotExist())
+        onView(withId(R.id.job_progress_item_cancel)).check(matches(not(isDisplayed())))
+
+        onView(withId(R.id.job_progress_item_expand)).perform(click())
+        onView(withText(expectedPrimaryStatus)).check(matches(isDisplayed()))
+        onView(withText(expectedSecondaryStatus)).check(matches(isDisplayed()))
+        onView(withId(R.id.job_progress_item_cancel)).check(matches(isDisplayed()))
+
+        onView(withId(R.id.job_progress_item_expand)).perform(click())
+        onView(allOf(withText(expectedPrimaryStatus), isDisplayed())).check(doesNotExist())
+        onView(allOf(withText(expectedSecondaryStatus), isDisplayed())).check(doesNotExist())
+        onView(withId(R.id.job_progress_item_cancel)).check(matches(not(isDisplayed())))
     }
 
     @Test
-    fun testJobPanelAppearsOnClick() {
-        onView(withId(R.id.option_menu_job_progress)).check(doesNotExist())
+    fun testCompletedItems() {
+        val progress1 = MutableJobProgress(
+            id = "jobId1",
+            operationType = FileOperationService.OPERATION_EXTRACT,
+            state = Job.STATE_COMPLETED,
+            msg = "Job1 completed",
+            hasFailures = false,
+        )
+        val progress2 = MutableJobProgress(
+            id = "jobId2",
+            operationType = FileOperationService.OPERATION_MOVE,
+            state = Job.STATE_COMPLETED,
+            msg = "Job2 completed",
+            hasFailures = true,
+        )
+        sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
+
+        openPanel()
+
+        onView(withChild(withText(progress1.msg)))
+            .check(selectedDescendantsMatch(
+                withText(R.string.job_progress_item_completed),
+                isDisplayed()
+            ))
+            .check(selectedDescendantsMatch(
+                withText(R.string.extract_completed),
+                isDisplayed()
+            ))
+        onView(withChild(withText(progress2.msg)))
+            .check(selectedDescendantsMatch(
+                withText(R.string.job_progress_item_failed),
+                isDisplayed()
+            ))
+            .check(selectedDescendantsMatch(
+                withText(R.string.job_progress_item_see_details),
+                isDisplayed()
+            ))
+
+        // Dismiss the first item.
+        onView(allOf(withId(R.id.job_progress_item_expand), insideItem(progress1)))
+            .perform(click())
+        onView(allOf(withId(R.id.job_progress_item_dismiss), insideItem(progress1)))
+            .perform(click())
+        onView(withText(progress1.msg)).check(doesNotExist())
+
+        // Dismiss the second item. The panel should disappear.
+        onView(allOf(withId(R.id.job_progress_item_expand), insideItem(progress2)))
+            .perform(click())
+        onView(allOf(withText(R.string.job_progress_item_see_details), isDisplayed()))
+            .check(doesNotExist())
+        onView(allOf(withId(R.id.job_progress_item_dismiss), insideItem(progress2)))
+            .perform(click())
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(doesNotExist())
         onView(withId(R.id.job_progress_panel_title)).check(doesNotExist())
+    }
 
+    @Test
+    fun testJobCanceled() {
+        val progress1 = MutableJobProgress(
+            id = "jobId1",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_SET_UP,
+            msg = "Job1",
+            hasFailures = false,
+            currentBytes = 10,
+            requiredBytes = 20,
+            msRemaining = 1000,
+        )
+        val progress2 = MutableJobProgress(
+            id = "jobId2",
+            operationType = FileOperationService.OPERATION_EXTRACT,
+            state = Job.STATE_CREATED,
+            msg = "Job2",
+            hasFailures = false,
+        )
+        sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
+
+        // Overall progress should be 25%.
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(matches(withProgress(25)))
+
+        openPanel()
+
+        // Check both items are displayed.
+        onView(withText(progress1.msg)).check(matches(isDisplayed()))
+        onView(withText(progress2.msg)).check(matches(isDisplayed()))
+
+        // Cancel the first job. Only the second item should be displayed.
+        progress1.state = Job.STATE_CANCELED
+        sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
+        onView(withText(progress1.msg)).check(doesNotExist())
+        onView(withText(progress2.msg)).check(matches(isDisplayed()))
+
+        // Overall progress should be 0% as the first job doesn't count. We need to close the popup
+        // panel first in order to check the menu item behind.
+        Espresso.pressBack()
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(matches(withProgress(0)))
+        openPanel()
+
+        // Cancel the second job. The panel should disappear.
+        progress2.state = Job.STATE_CANCELED
+        sendProgress(arrayListOf(progress2.toJobProgress()))
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(doesNotExist())
+        onView(withId(R.id.job_progress_panel_title)).check(doesNotExist())
+    }
+
+    @Test
+    fun testPersistsOnRecreate() {
         val progress = MutableJobProgress(
             id = "jobId1",
+            operationType = FileOperationService.OPERATION_COPY,
             state = Job.STATE_SET_UP,
             msg = "Job started",
             hasFailures = false,
             currentBytes = 4,
             requiredBytes = 10,
-            msRemaining = -1
+            msRemaining = 10000,
         )
         sendProgress(arrayListOf(progress.toJobProgress()))
+        mActivityScenario!!.recreate()
 
-        onView(withId(R.id.option_menu_job_progress))
-            .check(matches(isDisplayed()))
-            .perform(click())
-        onView(withId(R.id.job_progress_panel_title)).check(matches(isDisplayed()))
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(matches(withProgress(40)))
+
+        openPanel()
+        onView(withId(R.id.job_progress_item_progress)).check(matches(withProgress(40)))
+
+        mActivityScenario!!.recreate()
+
+        val progress2 = MutableJobProgress(
+            id = "jobId2",
+            operationType = FileOperationService.OPERATION_MOVE,
+            state = Job.STATE_SET_UP,
+            msg = "Job started",
+            hasFailures = false,
+            currentBytes = 6,
+            requiredBytes = 10,
+            msRemaining = 10000,
+        )
+        sendProgress(arrayListOf(progress.toJobProgress(), progress2.toJobProgress()))
+
+        onView(withId(R.id.job_progress_list)).check(matches(hasChildCount(2)))
+
+        // Close the job panel.
+        Espresso.pressBack()
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(matches(withProgress(50)))
+    }
+
+    @Test
+    fun testShowInFolder() {
+        bots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1)
+        bots.keyboard.pressKey(KeyEvent.KEYCODE_C, KeyEvent.META_CTRL_ON)
+
+        bots.directory.openDocument(TestFilesRule.DIR_NAME_1)
+        bots.keyboard.pressKey(KeyEvent.KEYCODE_V, KeyEvent.META_CTRL_ON)
+
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_1)
+
+        openPanel()
+        onView(withId(R.id.job_progress_item_title)).perform(click())
+        onView(withId(R.id.job_progress_item_show_in_folder)).perform(click())
+
+        // The panel should have been dismissed when we navigate.
+        onView(withId(R.id.job_progress_item_title)).check(doesNotExist())
+        bots.breadcrumb.assertItemsPresent(StubProvider.ROOT_0_ID, TestFilesRule.DIR_NAME_1)
+
+        // Try from a different folder.
+        Espresso.pressBack()
+        openPanel()
+        onView(withId(R.id.job_progress_item_show_in_folder)).perform(click())
+        bots.breadcrumb.assertItemsPresent(StubProvider.ROOT_0_ID, TestFilesRule.DIR_NAME_1)
+
+        // Try from a different root.
+        bots.roots.openRoot(StubProvider.ROOT_1_ID)
+        openPanel()
+        onView(withId(R.id.job_progress_item_show_in_folder)).perform(click())
+        bots.breadcrumb.assertItemsPresent(StubProvider.ROOT_0_ID, TestFilesRule.DIR_NAME_1)
+    }
+
+    @Test
+    fun testFailedItem() {
+        val inProgress = MutableJobProgress(
+            id = "in_progress_job",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_SET_UP,
+            msg = "Job in progress",
+            hasFailures = false,
+            currentBytes = 40,
+            requiredBytes = 100,
+        )
+
+        val failed = MutableJobProgress(
+            id = "failed_job",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_COMPLETED,
+            msg = "Job failed",
+            hasFailures = true,
+        )
+
+        sendProgress(arrayListOf(inProgress.toJobProgress()))
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(matches(withProgress(40)))
+        onView(allOf(withId(R.id.job_progress_toolbar_badge), isDisplayed())).check(doesNotExist())
+
+        sendProgress(arrayListOf(inProgress.toJobProgress(), failed.toJobProgress()))
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(matches(withProgress(70)))
+        onView(withId(R.id.job_progress_toolbar_badge)).check(matches(isDisplayed()))
+
+        mActivityScenario!!.recreate()
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(matches(withProgress(70)))
+        onView(withId(R.id.job_progress_toolbar_badge)).check(matches(isDisplayed()))
+
+        openPanel()
+        onView(withText(R.string.job_progress_item_failed)).perform(click())
+        onView(allOf(withId(R.id.job_progress_item_dismiss), isDisplayed())).perform(click())
+        Espresso.pressBack()
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(matches(withProgress(40)))
+        onView(allOf(withId(R.id.job_progress_toolbar_badge), isDisplayed())).check(doesNotExist())
+
+        inProgress.hasFailures = true
+        sendProgress(arrayListOf(inProgress.toJobProgress()))
+        onView(withId(R.id.job_progress_toolbar_indicator)).check(matches(withProgress(40)))
+        onView(withId(R.id.job_progress_toolbar_badge)).check(matches(isDisplayed()))
     }
 }
diff --git a/tests/functional/com/android/documentsui/NavRailUiTest.kt b/tests/functional/com/android/documentsui/NavRailUiTest.kt
new file mode 100644
index 000000000..1e9e57671
--- /dev/null
+++ b/tests/functional/com/android/documentsui/NavRailUiTest.kt
@@ -0,0 +1,115 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui
+
+import android.app.ActivityOptions
+import android.app.WindowConfiguration.WINDOWING_MODE_FREEFORM
+import android.content.Intent
+import android.content.pm.PackageManager.FEATURE_FREEFORM_WINDOW_MANAGEMENT
+import android.content.res.Resources
+import android.graphics.Rect
+import android.platform.test.annotations.RequiresFlagsEnabled
+import android.provider.DocumentsContract
+import android.util.DisplayMetrics
+import android.util.TypedValue
+import android.view.Display
+import androidx.test.core.app.ActivityScenario
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import com.android.documentsui.files.FilesActivity
+import com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import kotlin.math.roundToInt
+import org.junit.Assume.assumeTrue
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+
+@RequiresFlagsEnabled(FLAG_USE_MATERIAL3)
+@RunWith(AndroidJUnit4::class)
+class NavRailUiTest : ActivityTestJunit4<FilesActivity>() {
+  @get:Rule
+  val checkFlags = CheckAndForceMaterial3Flag()
+
+  companion object {
+    private const val MEDIUM_WINDOW_WIDTH = 700
+    private const val MEDIUM_WINDOW_HEIGHT = 900
+  }
+
+  private fun dpToPx(dp: Float, metrics: DisplayMetrics?): Float {
+    return TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp, metrics)
+  }
+
+  private fun pxToDp(px: Float, metrics: DisplayMetrics): Float {
+    return TypedValue.deriveDimension(TypedValue.COMPLEX_UNIT_DIP, px, metrics)
+  }
+
+  /** Override the base method to launch activity in a specified window size. */
+  override fun launchActivity() {
+    // check assumption before launching the activity.
+    assumeMinWindowSizeAndFreeFormWindowFeature()
+
+    val intent = Intent(context, FilesActivity::class.java)
+    intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK)
+    if (this.initialRoot != null) {
+      intent.setAction(Intent.ACTION_VIEW)
+      intent.setDataAndType(this.initialRoot!!.uri, DocumentsContract.Root.MIME_TYPE_ITEM)
+    }
+    val displayMetrics = Resources.getSystem().displayMetrics
+    val options = ActivityOptions.makeBasic()
+    options.launchWindowingMode = WINDOWING_MODE_FREEFORM
+    options.setLaunchBounds(
+      Rect(
+        0,
+        0,
+        dpToPx(MEDIUM_WINDOW_WIDTH.toFloat(), displayMetrics).roundToInt(),
+        dpToPx(MEDIUM_WINDOW_HEIGHT.toFloat(), displayMetrics).roundToInt(),
+      )
+    )
+    options.setLaunchDisplayId(Display.DEFAULT_DISPLAY)
+    mActivityScenario = ActivityScenario.launch(intent, options.toBundle())
+  }
+
+  /** Making sure the test device meets the minimum window size and have freeform window feature. */
+  fun assumeMinWindowSizeAndFreeFormWindowFeature() {
+    assumeTrue(
+      "Skipping test: test device doesn't support FreeForm window.",
+      context!!.getPackageManager().hasSystemFeature(FEATURE_FREEFORM_WINDOW_MANAGEMENT),
+    )
+    val displayMetrics = Resources.getSystem().displayMetrics
+    assumeTrue(
+      "Skipping test: test device window size is too small to support medium layout.",
+      pxToDp(displayMetrics.widthPixels.toFloat(), displayMetrics) >= MEDIUM_WINDOW_WIDTH &&
+        pxToDp(displayMetrics.heightPixels.toFloat(), displayMetrics) >= MEDIUM_WINDOW_HEIGHT,
+    )
+  }
+
+  @Test
+  fun testNavRailRootsNavigation() {
+    bots.main.assertWindowTitle(StubProvider.ROOT_0_ID)
+    bots.roots.openNavRailRoot(StubProvider.ROOT_1_ID)
+    bots.main.assertWindowTitle(StubProvider.ROOT_1_ID)
+  }
+
+  @Test
+  fun testNavRailDrawerRootsNavigation() {
+    bots.main.assertWindowTitle(StubProvider.ROOT_0_ID)
+    bots.roots.openDrawerFromNavRail()
+    // The following openRoot will open root from the drawer instead of the navigation rail because
+    // the drawer is open explicitly above.
+    bots.roots.openRoot(StubProvider.ROOT_1_ID)
+    bots.main.assertWindowTitle(StubProvider.ROOT_1_ID)
+  }
+}
diff --git a/tests/functional/com/android/documentsui/PermissionsTest.java b/tests/functional/com/android/documentsui/PermissionsTest.java
index 2cae6f059..f7c24fc49 100644
--- a/tests/functional/com/android/documentsui/PermissionsTest.java
+++ b/tests/functional/com/android/documentsui/PermissionsTest.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui;
 
+import static org.junit.Assert.assertEquals;
+
 import android.Manifest;
 import android.content.pm.PackageManager;
 
@@ -24,19 +26,7 @@ import com.android.documentsui.util.VersionUtils;
 
 import org.junit.Test;
 
-public class PermissionsTest extends ActivityTest<FilesActivity> {
-
-    private static final String TAG = "PermissionsTest";
-
-    public PermissionsTest() {
-        super(FilesActivity.class);
-    }
-
-    @Override
-    public void setUp() throws Exception {
-        super.setUp();
-    }
-
+public class PermissionsTest extends ActivityTestJunit4<FilesActivity> {
     @Test
     public void testPermissionGranted_interactAcrossUsersOnR() {
         if (VersionUtils.isAtLeastR()) {
diff --git a/tests/functional/com/android/documentsui/PickActivityTest.java b/tests/functional/com/android/documentsui/PickActivityTest.java
index 5d3203679..e8713a45f 100644
--- a/tests/functional/com/android/documentsui/PickActivityTest.java
+++ b/tests/functional/com/android/documentsui/PickActivityTest.java
@@ -16,24 +16,38 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.StubProvider.ROOT_0_ID;
 import static com.android.documentsui.base.Providers.AUTHORITY_STORAGE;
 
 import static com.google.common.truth.Truth.assertThat;
 
+import static junit.framework.Assert.assertEquals;
+import static junit.framework.Assert.assertNotNull;
+
 import android.app.Activity;
 import android.app.Instrumentation;
+import android.content.ClipData;
 import android.content.Context;
 import android.content.Intent;
 import android.net.Uri;
 import android.os.SystemClock;
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.CheckFlagsRule;
+import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 import android.provider.DocumentsContract;
 
 import androidx.test.filters.SmallTest;
 import androidx.test.platform.app.InstrumentationRegistry;
 import androidx.test.rule.ActivityTestRule;
+import androidx.test.uiautomator.UiDevice;
+import androidx.test.uiautomator.UiObjectNotFoundException;
 
 import com.android.documentsui.base.DocumentInfo;
+import com.android.documentsui.bots.Bots;
+import com.android.documentsui.flags.Flags;
 import com.android.documentsui.picker.PickActivity;
+import com.android.documentsui.rules.TestFilesRule;
 import com.android.documentsui.testing.TestProvidersAccess;
 import com.android.documentsui.ui.TestDialogController;
 import com.android.documentsui.util.VersionUtils;
@@ -73,10 +87,21 @@ public class PickActivityTest {
         return Lists.newArrayList(true, false);
     }
 
+    @Rule
+    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+
+    @Rule
+    public final TestFilesRule mTestFilesRule =
+            new TestFilesRule()
+                    .createFileInRoot(ROOT_0_ID, TestFilesRule.FILE_NAME_1, "text/plain")
+                    .createFileInRoot(ROOT_0_ID, TestFilesRule.FILE_NAME_2, "image/png");
+
     @Rule
     public final ActivityTestRule<PickActivity> mRule =
             new ActivityTestRule<>(PickActivity.class, false, false);
 
+    private Bots mBots = null;
+
     @Before
     public void setUp() throws Exception {
         mTargetContext = InstrumentationRegistry.getInstrumentation().getTargetContext();
@@ -91,6 +116,14 @@ public class PickActivityTest {
         mTestConfigStore = new TestConfigStore();
 
         isPrivateSpaceEnabled = SdkLevel.isAtLeastS() && isPrivateSpaceEnabled;
+
+        Instrumentation instrumentation = InstrumentationRegistry.getInstrumentation();
+        mBots =
+                new Bots(
+                        UiDevice.getInstance(instrumentation),
+                        instrumentation.getUiAutomation(),
+                        mTargetContext,
+                        5000);
     }
 
     @Test
@@ -166,4 +199,142 @@ public class PickActivityTest {
         assertThat(pickActivity.isFinishing()).isFalse();
         mTestDialogs.assertActionNotAllowedShown();
     }
+
+    @Test
+    public void testOptionMenuWorksWhileOptionSelected() throws UiObjectNotFoundException {
+        // Launch the PickActivity using `GET_CONTENT` action, and navigate to test root.
+        mRule.launchActivity(mIntentGetContent);
+        mBots.roots.openRoot(ROOT_0_ID);
+
+        // Switch to list mode and select the test document.
+        mBots.main.switchToListMode();
+        mBots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
+
+        // Open the overflow menu and assert that the Sort by menu option is there.
+        mBots.main.openOverflowMenu();
+        mBots.menu.hasMenuItem("Sort by...");
+    }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void testPickFilesFragment_ActionOpenDocument_SingleFile()
+            throws UiObjectNotFoundException {
+        Intent intentOpenDocument = new Intent(Intent.ACTION_OPEN_DOCUMENT);
+        intentOpenDocument.addCategory(Intent.CATEGORY_OPENABLE);
+        intentOpenDocument.setType("*/*");
+        PickActivity pickActivity = mRule.launchActivity(mIntentGetContent);
+        mBots.roots.openRoot(ROOT_0_ID);
+
+        // There should be a Cancel (button2) and Select (button1) button.
+        mBots.picker.checkCancelButtonDisplayed();
+        mBots.picker.checkCancelButtonEnabled();
+        mBots.picker.checkPickButtonDisplayed();
+        // The Select button should be disabled since there are no selected files.
+
+        mBots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
+
+        // The Select button should be enabled since there is a selected file.
+        mBots.picker.checkPickButtonEnabled();
+
+        // Click the Select button to pick the selected file.
+        mBots.picker.clickPickButton();
+        SystemClock.sleep(3000);
+
+        // Check that the file was picked.
+        Instrumentation.ActivityResult result = mRule.getActivityResult();
+        assertThat(result.getResultCode()).isEqualTo(Activity.RESULT_OK);
+        assertThat(result.getResultData().getData()).isEqualTo(
+                mTestFilesRule.getUriInRoot(ROOT_0_ID, TestFilesRule.FILE_NAME_1));
+
+        // Check that the activity is finishing.
+        assertThat(pickActivity.isFinishing()).isTrue();
+    }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void testPickFilesFragment_ActionGetContent_MultiFiles() throws Exception {
+        // Allow multiple files to be selected.
+        mIntentGetContent.putExtra(Intent.EXTRA_ALLOW_MULTIPLE, true);
+        PickActivity pickActivity = mRule.launchActivity(mIntentGetContent);
+
+        mBots.roots.openRoot(ROOT_0_ID);
+
+        // There should be a Cancel (button2) and Select (button1) button.
+        mBots.picker.checkCancelButtonDisplayed();
+        mBots.picker.checkCancelButtonEnabled();
+        mBots.picker.checkPickButtonDisplayed();
+        // The Select button should be disabled since there are no selected files.
+        mBots.picker.checkPickButtonDisabled();
+
+        mBots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
+        mBots.directory.selectDocument(TestFilesRule.FILE_NAME_2, 2);
+
+        // The Select button should be enabled since there are selected files.
+        mBots.picker.checkPickButtonEnabled();
+
+        mBots.directory.clearSelection();
+
+        // The Select button should be disabled since there are no selected files.
+        mBots.picker.checkPickButtonDisabled();
+
+        // Select the files again and click the Select button to pick the selected files.
+        mBots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
+        mBots.directory.selectDocument(TestFilesRule.FILE_NAME_2, 2);
+        mBots.picker.checkPickButtonEnabled();
+        mBots.picker.clickPickButton();
+        SystemClock.sleep(3000);
+
+        // Check that the files were picked.
+        Instrumentation.ActivityResult result = mRule.getActivityResult();
+        assertThat(result.getResultCode()).isEqualTo(Activity.RESULT_OK);
+        ClipData clipData = result.getResultData().getClipData();
+        assertNotNull(clipData);
+        assertEquals(clipData.getItemCount(), 2);
+        assertEquals(mTestFilesRule.getUriInRoot(ROOT_0_ID, TestFilesRule.FILE_NAME_1),
+                clipData.getItemAt(0).getUri());
+        assertEquals(mTestFilesRule.getUriInRoot(ROOT_0_ID, TestFilesRule.FILE_NAME_2),
+                clipData.getItemAt(1).getUri());
+
+        // Check that the activity is finishing.
+        assertThat(pickActivity.isFinishing()).isTrue();
+    }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void testPickFilesFragment_ClickCancel() throws UiObjectNotFoundException {
+        PickActivity pickActivity = mRule.launchActivity(mIntentGetContent);
+
+        mBots.roots.openRoot(ROOT_0_ID);
+
+        // There should be a Cancel (button2) and Select (button1) button.
+        mBots.picker.checkCancelButtonDisplayed();
+        mBots.picker.checkCancelButtonEnabled();
+        mBots.picker.checkPickButtonDisplayed();
+
+        mBots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
+
+        // Click Cancel.
+        mBots.picker.clickCancelButton();
+
+        // Check that the files weren't picked.
+        Instrumentation.ActivityResult result = mRule.getActivityResult();
+        assertThat(result.getResultCode()).isEqualTo(Activity.RESULT_CANCELED);
+
+        // Check that the activity is finishing.
+        assertThat(pickActivity.isFinishing()).isTrue();
+    }
+
+    @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_MATERIAL3})
+    public void testPickFilesFragment_FlagDisabled() throws UiObjectNotFoundException {
+        mRule.launchActivity(mIntentGetContent);
+
+        mBots.roots.openRoot(ROOT_0_ID);
+
+        mBots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
+
+        // The Cancel (button2) and Select (button1) buttons should not exist.
+        mBots.picker.checkCancelButtonDoesNotExist();
+        mBots.picker.checkPickButtonDoesNotExist();
+    }
 }
diff --git a/tests/functional/com/android/documentsui/RenameDocumentUiTest.java b/tests/functional/com/android/documentsui/RenameDocumentUiTest.java
index e992ac95f..10da6e8a4 100644
--- a/tests/functional/com/android/documentsui/RenameDocumentUiTest.java
+++ b/tests/functional/com/android/documentsui/RenameDocumentUiTest.java
@@ -16,30 +16,36 @@
 
 package com.android.documentsui;
 
+import static org.junit.Assert.assertFalse;
+import static org.junit.Assert.assertTrue;
+
 import androidx.test.filters.LargeTest;
 import androidx.test.uiautomator.UiObjectNotFoundException;
 
 import com.android.documentsui.files.FilesActivity;
+import com.android.documentsui.rules.TestFilesRule;
 import com.android.documentsui.util.VersionUtils;
 
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+
 @LargeTest
-public class RenameDocumentUiTest extends ActivityTest<FilesActivity> {
+public class RenameDocumentUiTest extends ActivityTestJunit4<FilesActivity> {
 
     private final String newName = "kitties.log";
 
-    public RenameDocumentUiTest() {
-        super(FilesActivity.class);
-    }
+    @Rule
+    public final TestFilesRule mTestFilesRule = new TestFilesRule();
 
-    @Override
-    public void setUp() throws Exception {
-        super.setUp();
-        initTestFiles();
+    @Before
+    public void setUpTest() {
         bots.roots.closeDrawer();
     }
 
+    @Test
     public void testRenameEnabled_SingleSelection() throws Exception {
-        bots.directory.selectDocument(fileName1, 1);
+        bots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
         bots.main.openOverflowMenu();
         bots.main.assertMenuEnabled(R.string.menu_rename, true);
 
@@ -47,9 +53,10 @@ public class RenameDocumentUiTest extends ActivityTest<FilesActivity> {
         device.pressBack();
     }
 
+    @Test
     public void testNoRenameSupport_SingleSelection() throws Exception {
         if (VersionUtils.isAtLeastR()) {
-            bots.directory.selectDocument(fileNameNoRename, 1);
+            bots.directory.selectDocument(TestFilesRule.FILE_NAME_NO_RENAME, 1);
             bots.main.openOverflowMenu();
             bots.main.assertMenuEnabled(R.string.menu_rename, false);
 
@@ -58,10 +65,11 @@ public class RenameDocumentUiTest extends ActivityTest<FilesActivity> {
         }
     }
 
+    @Test
     public void testOneHasRenameSupport_MultipleSelection() throws Exception {
         if (VersionUtils.isAtLeastR()) {
-            bots.directory.selectDocument(fileName1, 1);
-            bots.directory.selectDocument(fileNameNoRename, 2);
+            bots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
+            bots.directory.selectDocument(TestFilesRule.FILE_NAME_NO_RENAME, 2);
             bots.main.openOverflowMenu();
             bots.main.assertMenuEnabled(R.string.menu_rename, false);
 
@@ -70,10 +78,11 @@ public class RenameDocumentUiTest extends ActivityTest<FilesActivity> {
         }
     }
 
+    @Test
     public void testRenameDisabled_MultipleSelection() throws Exception {
         if (VersionUtils.isAtLeastR()) {
-            bots.directory.selectDocument(fileName1, 1);
-            bots.directory.selectDocument(fileName2, 2);
+            bots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
+            bots.directory.selectDocument(TestFilesRule.FILE_NAME_2, 2);
             bots.main.openOverflowMenu();
             bots.main.assertMenuEnabled(R.string.menu_rename, false);
 
@@ -82,8 +91,9 @@ public class RenameDocumentUiTest extends ActivityTest<FilesActivity> {
         }
     }
 
+    @Test
     public void testRenameFile_OkButton() throws Exception {
-        bots.directory.selectDocument(fileName1, 1);
+        bots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
 
         clickRename();
 
@@ -91,15 +101,16 @@ public class RenameDocumentUiTest extends ActivityTest<FilesActivity> {
         bots.main.setDialogText(newName);
 
         device.waitForIdle();
-        bots.main.clickDialogOkButton();
+        bots.main.clickDialogOkButton(/* closeSoftKeyboard */ true);
 
         bots.directory.waitForDocument(newName);
-        bots.directory.assertDocumentsAbsent(fileName1);
+        bots.directory.assertDocumentsAbsent(TestFilesRule.FILE_NAME_1);
         bots.directory.assertDocumentsCount(4);
     }
 
+    @Test
     public void testRenameFile_Enter() throws Exception {
-        bots.directory.selectDocument(fileName1, 1);
+        bots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
 
         clickRename();
 
@@ -110,38 +121,41 @@ public class RenameDocumentUiTest extends ActivityTest<FilesActivity> {
         bots.keyboard.pressEnter();
 
         bots.directory.waitForDocument(newName);
-        bots.directory.assertDocumentsAbsent(fileName1);
+        bots.directory.assertDocumentsAbsent(TestFilesRule.FILE_NAME_1);
         bots.directory.assertDocumentsCount(4);
     }
 
+    @Test
     public void testRenameWithoutChangeIsNoOp() throws Exception {
-        bots.directory.selectDocument(fileName1, 1);
+        bots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
 
         clickRename();
 
         device.waitForIdle();
         bots.keyboard.pressEnter();
 
-        bots.directory.waitForDocument(fileName1);
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_1);
         bots.directory.assertDocumentsCount(4);
     }
 
+    @Test
     public void testRenameFile_Cancel() throws Exception {
-        bots.directory.selectDocument(fileName1, 1);
+        bots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
 
         clickRename();
 
         bots.main.setDialogText(newName);
 
-        bots.main.clickDialogCancelButton();
+        bots.main.clickDialogCancelButton(/* closeSoftKeyboard */ true);
 
-        bots.directory.assertDocumentsPresent(fileName1);
+        bots.directory.assertDocumentsPresent(TestFilesRule.FILE_NAME_1);
         bots.directory.assertDocumentsAbsent(newName);
         bots.directory.assertDocumentsCount(4);
 
         bots.directory.assertSelection(1);
     }
 
+    @Test
     public void testRenameDir() throws Exception {
         String oldName = "Dir1";
         String newName = "Dir123";
@@ -158,16 +172,18 @@ public class RenameDocumentUiTest extends ActivityTest<FilesActivity> {
         bots.directory.assertDocumentsCount(4);
     }
 
+    @Test
     public void testRename_NameExists() throws Exception {
         renameWithConflict();
 
-        bots.main.clickDialogCancelButton();
+        bots.main.clickDialogCancelButton(/* closeSoftKeyboard */ true);
 
-        bots.directory.assertDocumentsPresent(fileName1);
-        bots.directory.assertDocumentsPresent(fileName2);
+        bots.directory.assertDocumentsPresent(TestFilesRule.FILE_NAME_1);
+        bots.directory.assertDocumentsPresent(TestFilesRule.FILE_NAME_2);
         bots.directory.assertDocumentsCount(4);
     }
 
+    @Test
     public void testRename_RecoverAfterConflict() throws Exception {
         renameWithConflict();
         device.waitForIdle();
@@ -175,23 +191,23 @@ public class RenameDocumentUiTest extends ActivityTest<FilesActivity> {
         bots.main.setDialogText(newName);
 
         device.waitForIdle();
-        bots.main.clickDialogOkButton();
+        bots.main.clickDialogOkButton(/* closeSoftKeyboard */ true);
 
         bots.directory.waitForDocument(newName);
-        bots.directory.assertDocumentsAbsent(fileName1);
+        bots.directory.assertDocumentsAbsent(TestFilesRule.FILE_NAME_1);
         bots.directory.assertDocumentsCount(4);
     }
 
     private void renameWithConflict() throws Exception {
         // Check that document with the new name exists
-        bots.directory.assertDocumentsPresent(fileName2);
-        bots.directory.selectDocument(fileName1, 1);
+        bots.directory.assertDocumentsPresent(TestFilesRule.FILE_NAME_2);
+        bots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
 
         clickRename();
 
-        bots.main.assertDialogText(fileName1);
+        bots.main.assertDialogText(TestFilesRule.FILE_NAME_1);
         assertFalse(bots.main.findRenameErrorMessage().exists());
-        bots.main.setDialogText(fileName2);
+        bots.main.setDialogText(TestFilesRule.FILE_NAME_2);
         bots.keyboard.pressEnter();
         assertTrue(bots.main.findRenameErrorMessage().exists());
     }
diff --git a/tests/functional/com/android/documentsui/SearchViewUiTest.java b/tests/functional/com/android/documentsui/SearchViewUiTest.java
index 78ce44a5e..508f375c6 100644
--- a/tests/functional/com/android/documentsui/SearchViewUiTest.java
+++ b/tests/functional/com/android/documentsui/SearchViewUiTest.java
@@ -16,73 +16,124 @@
 
 package com.android.documentsui;
 
+import static androidx.test.espresso.Espresso.onView;
+import static androidx.test.espresso.action.ViewActions.click;
+import static androidx.test.espresso.matcher.RootMatchers.isPlatformPopup;
+import static androidx.test.espresso.matcher.ViewMatchers.isDescendantOfA;
+import static androidx.test.espresso.matcher.ViewMatchers.isDisplayed;
+import static androidx.test.espresso.matcher.ViewMatchers.withId;
+import static androidx.test.espresso.matcher.ViewMatchers.withText;
+
 import static com.android.documentsui.StubProvider.ROOT_0_ID;
 import static com.android.documentsui.StubProvider.ROOT_1_ID;
+import static com.android.documentsui.conditions.HasChildCountCondition.hasMoreThanOneChild;
+import static com.android.documentsui.conditions.HasChildCountCondition.hasOneChild;
+import static com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3;
+import static com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY;
+
+import static org.hamcrest.CoreMatchers.allOf;
+import static org.junit.Assert.assertFalse;
+
+import android.os.RemoteException;
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.provider.Settings;
 
 import androidx.test.filters.LargeTest;
 import androidx.test.filters.Suppress;
+import androidx.test.uiautomator.By;
+import androidx.test.uiautomator.UiObject2;
+import androidx.test.uiautomator.UiObjectNotFoundException;
+import androidx.test.uiautomator.Until;
 
+import com.android.documentsui.actions.RelaxedClickAction;
 import com.android.documentsui.files.FilesActivity;
 import com.android.documentsui.filters.HugeLongTest;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
+import com.android.documentsui.rules.TestFilesRule;
+
+import org.junit.After;
+import org.junit.Assert;
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
 
 @LargeTest
-public class SearchViewUiTest extends ActivityTest<FilesActivity> {
+public class SearchViewUiTest extends ActivityTestJunit4<FilesActivity> {
 
-    public SearchViewUiTest() {
-        super(FilesActivity.class);
-    }
+    @Rule
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
 
-    @Override
-    public void setUp() throws Exception {
-      super.setUp();
-      initTestFiles();
-      // Drawer interferes with a lot of search action; going to try to close any opened ones
-      bots.roots.closeDrawer();
+    @Rule
+    public final TestFilesRule mTestFilesRule = new TestFilesRule();
 
-      // wait for a file to be present in default dir.
-      bots.directory.waitForDocument(fileName1);
+    // UI timeout to wait for elements to appear, set to 5 seconds.
+    private final int mTimeout = 5000;
+
+    @Before
+    public void setUpTest() throws UiObjectNotFoundException, RemoteException {
+        bots.roots.closeDrawer();
+
+        // wait for a file to be present in default dir.
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_1);
     }
 
-    @Override
-    public void tearDown() throws Exception {
+    @After
+    public void tearDownTest() {
         // manually close activity to avoid SearchFragment show when Activity close. ref b/142840883
         device.waitForIdle();
         device.pressBack();
         device.pressBack();
         device.pressBack();
-        super.tearDown();
     }
 
+    private void assertDefaultContentOfTestDir0() throws UiObjectNotFoundException {
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_1);
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_2);
+        bots.directory.waitForDocument(TestFilesRule.DIR_NAME_1);
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_NO_RENAME);
+        bots.directory.assertDocumentsCount(4);
+    }
+
+    private void assertDefaultContentOfTestDir1() throws UiObjectNotFoundException {
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_3);
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_4);
+        bots.directory.assertDocumentsCount(2);
+    }
+
+    @Test
     public void testSearchIconVisible() throws Exception {
         // The default root (root 0) supports search
-        bots.search.assertInputExists(false);
-        bots.search.assertIconVisible(true);
+        bots.search.assertIsExpanded(false);
     }
 
+    @Test
     @HugeLongTest
     public void testSearchIconHidden() throws Exception {
         bots.roots.openRoot(ROOT_1_ID);  // root 1 doesn't support search
 
-        bots.search.assertIconVisible(false);
-        bots.search.assertInputExists(false);
+        bots.search.assertIsVisible(false);
     }
 
+    @Test
     public void testSearchView_ExpandsOnClick() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         device.waitForIdle();
 
-        bots.search.assertInputExists(true);
+        bots.search.assertIsExpanded(true);
         bots.search.assertInputFocused(true);
 
         // FIXME: Matchers fail the not-present check if we've ever clicked this.
         // bots.search.assertIconVisible(false);
     }
 
+    @Test
+    @RequiresFlagsDisabled({FLAG_USE_MATERIAL3}) // Enable when b/397315793 is fixed.
     public void testSearchView_ShouldHideOptionMenuOnExpanding() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         device.waitForIdle();
 
-        bots.search.assertInputExists(true);
+        bots.search.assertIsExpanded(true);
         bots.search.assertInputFocused(true);
         device.waitForIdle();
 
@@ -91,16 +142,19 @@ public class SearchViewUiTest extends ActivityTest<FilesActivity> {
         assertFalse(bots.menu.hasMenuItemByDesc("More options"));
     }
 
+    @Test
     public void testSearchView_CollapsesOnBack() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         device.pressBack();
 
-        bots.search.assertIconVisible(true);
-        bots.search.assertInputExists(false);
+        bots.search.assertIsExpanded(false);
     }
 
+    @Test
+    // TODO(b/414507592): Remove once recent searches is enabled again.
+    @RequiresFlagsDisabled(FLAG_USE_MATERIAL3)
     public void testSearchFragment_DismissedOnCloseAfterCancel() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         bots.search.setInputText("query text");
 
         // Cancel search
@@ -111,52 +165,58 @@ public class SearchViewUiTest extends ActivityTest<FilesActivity> {
         device.pressBack();
         device.waitForIdle();
 
-        bots.search.assertIconVisible(true);
-        bots.search.assertInputExists(false);
+        bots.search.assertIsExpanded(false);
         bots.search.assertSearchHistoryVisible(false);
     }
 
+    @Test
     public void testSearchView_ClearsTextOnBack() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         bots.search.setInputText("file2");
 
         device.pressBack();
-        device.pressBack();
+        // When docked search is enable pressing back twice will kill the activity.
+        if (!context.getResources().getBoolean(R.bool.show_docked_search)) {
+            device.pressBack();
+        }
 
         // Wait for a file in the default directory to be listed.
-        bots.directory.waitForDocument(dirName1);
+        bots.directory.waitForDocument(TestFilesRule.DIR_NAME_1);
 
-        bots.search.assertIconVisible(true);
-        bots.search.assertInputExists(false);
+        bots.search.assertIsExpanded(false);
     }
 
+    @Test
     public void testSearchView_ClearsSearchOnBack() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         bots.search.setInputText("file1");
         bots.keyboard.pressEnter();
         device.waitForIdle();
 
         device.pressBack();
 
-        bots.search.assertIconVisible(true);
-        bots.search.assertInputExists(false);
+        bots.search.assertIsExpanded(false);
     }
 
+    @Test
     public void testSearchView_ClearsAutoSearchOnBack() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         bots.search.setInputText("chocolate");
         //Wait for auto search result, it should be no results and show holder message.
         bots.directory.waitForHolderMessage();
 
         device.pressBack();
-        device.pressBack();
+        // When docked search is enable pressing back twice will kill the activity.
+        if (!context.getResources().getBoolean(R.bool.show_docked_search)) {
+            device.pressBack();
+        }
 
-        bots.search.assertIconVisible(true);
-        bots.search.assertInputExists(false);
+        bots.search.assertIsExpanded(false);
     }
 
+    @Test
     public void testSearchView_StateAfterSearch() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         bots.search.setInputText("file1");
         bots.keyboard.pressEnter();
         device.waitForIdle();
@@ -164,20 +224,23 @@ public class SearchViewUiTest extends ActivityTest<FilesActivity> {
         bots.search.assertInputEquals("file1");
     }
 
+    @Test
     public void testSearch_ResultsFound() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         bots.search.setInputText("file1");
         bots.keyboard.pressEnter();
 
         bots.directory.assertDocumentsCountOnList(true, 2);
-        bots.directory.assertDocumentsPresent(fileName1, fileName2);
+        bots.directory.assertDocumentsPresent(TestFilesRule.FILE_NAME_1, TestFilesRule.FILE_NAME_2);
     }
 
+    @Test
     public void testSearch_NoResults() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         bots.search.setInputText("chocolate");
 
         bots.keyboard.pressEnter();
+        device.waitForIdle(3000);
 
         String msg = String.valueOf(context.getString(R.string.no_results));
         bots.directory.assertPlaceholderMessageText(String.format(msg, "TEST_ROOT_0"));
@@ -185,8 +248,8 @@ public class SearchViewUiTest extends ActivityTest<FilesActivity> {
 
     @Suppress
     public void testSearchResultsFound_ClearsOnBack() throws Exception {
-        bots.search.clickIcon();
-        bots.search.setInputText(fileName1);
+        bots.search.expand();
+        bots.search.setInputText(TestFilesRule.FILE_NAME_1);
 
         bots.keyboard.pressEnter();
         device.pressBack();
@@ -197,7 +260,7 @@ public class SearchViewUiTest extends ActivityTest<FilesActivity> {
 
     @Suppress
     public void testSearchNoResults_ClearsOnBack() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         bots.search.setInputText("chocolate bunny");
 
         bots.keyboard.pressEnter();
@@ -215,9 +278,9 @@ public class SearchViewUiTest extends ActivityTest<FilesActivity> {
             return;
         }
 
-        bots.search.clickIcon();
+        bots.search.expand();
 
-        bots.search.setInputText(fileName1);
+        bots.search.setInputText(TestFilesRule.FILE_NAME_1);
 
         bots.keyboard.pressEnter();
 
@@ -231,8 +294,11 @@ public class SearchViewUiTest extends ActivityTest<FilesActivity> {
         assertDefaultContentOfTestDir0();
     }
 
+    @Test
+    // TODO(b/414507592): Remove once recent searches is enabled again.
+    @RequiresFlagsDisabled(FLAG_USE_MATERIAL3)
     public void testSearchHistory_showAfterSearchViewClear() throws Exception {
-        bots.search.clickIcon();
+        bots.search.expand();
         bots.search.setInputText("chocolate");
 
         bots.keyboard.pressEnter();
@@ -241,14 +307,16 @@ public class SearchViewUiTest extends ActivityTest<FilesActivity> {
         bots.search.clickSearchViewClearButton();
         device.waitForIdle();
 
-        bots.search.assertInputExists(true);
         bots.search.assertInputFocused(true);
         bots.search.assertSearchHistoryVisible(true);
     }
 
+    @Test
+    // TODO(b/414507592): Remove once recent searches is enabled again.
+    @RequiresFlagsDisabled(FLAG_USE_MATERIAL3)
     public void testSearchView_focusClearedAfterSelectingSearchHistory() throws Exception {
         String queryText = "history";
-        bots.search.clickIcon();
+        bots.search.expand();
         bots.search.setInputText(queryText);
         bots.keyboard.pressEnter();
         device.waitForIdle();
@@ -262,4 +330,123 @@ public class SearchViewUiTest extends ActivityTest<FilesActivity> {
         bots.search.assertInputFocused(false);
         bots.search.assertSearchHistoryVisible(false);
     }
+
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_SEARCH_V2_READ_ONLY, FLAG_USE_MATERIAL3})
+    public void testSearchDropdowns() throws Exception {
+        bots.search.expand();
+        bots.search.setInputText("foo");
+        // Verify that menu triggers (chips) are showing.
+        bots.main.assertLocationTriggerShows();
+        bots.main.assertLastModifiedTriggerShows();
+        bots.main.assertFileTypeTriggerShows();
+    }
+
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_SEARCH_V2_READ_ONLY, FLAG_USE_MATERIAL3})
+    public void testSearchV2FileTypeDropdown() throws Exception {
+        // Start search with term "file1" limiting results to images only.
+        bots.search.expand();
+        bots.search.setInputText("file");
+        bots.keyboard.pressEnter();
+        // Select images files only.
+        onView(withId(R.id.search_file_type_trigger)).perform(click());
+        onView(withText(R.string.chip_title_images)).inRoot(isPlatformPopup()).perform(click());
+
+        // Silence subsequent warnings about device being potentially null.
+        Assert.assertNotNull(device);
+
+        // There should be only file12.png left.
+        device.waitForIdle();
+        device.wait(Until.findObject(By.text(TestFilesRule.FILE_NAME_2).selected(false)), 5000);
+    }
+
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_SEARCH_V2_READ_ONLY, FLAG_USE_MATERIAL3})
+    public void testSearchV2LastModifiedDropdown() throws Exception {
+        // Start search with term "file1" limiting results modified in the last 30 days.
+        bots.search.expand();
+        bots.search.setInputText("file");
+        bots.keyboard.pressEnter();
+        onView(withId(R.id.search_last_modified_trigger)).perform(click());
+        onView(withText(R.string.search_last_modified_30_days)).inRoot(isPlatformPopup()).perform(
+                click());
+
+        // Silence subsequent warnings about device being potentially null.
+        Assert.assertNotNull(device);
+        device.waitForIdle();
+        bots.directory.assertDocumentsCountOnList(true, 3);
+    }
+
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_SEARCH_V2_READ_ONLY, FLAG_USE_MATERIAL3})
+    public void testSearchV2SearchLocationDropdown() throws Exception {
+        // Start search with term "file1", but rather than searching locally, search everywhere.
+        bots.search.expand();
+        bots.search.setInputText("fred-dog.jpg");
+        bots.keyboard.pressEnter();
+        onView(withId(R.id.search_location_trigger)).perform(click());
+        onView(withText(R.string.search_location_everywhere)).inRoot(isPlatformPopup()).perform(
+                click());
+
+        // Silence subsequent warnings about device being potentially null.
+        Assert.assertNotNull(device);
+        device.waitForIdle();
+        bots.directory.assertDocumentsCountOnList(true, 1);
+    }
+
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_MATERIAL3)
+    @RequiresFlagsDisabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+    public void testSearchView_TogglingASearchChipClearsSelection() throws Exception {
+        // Get the label of the device (this will be used to navigate to the ExternalStorageProvider
+        // as the custom roots added for test do not show the search chips).
+        String deviceLabel =
+                Settings.Global.getString(
+                        context.getContentResolver(), Settings.Global.DEVICE_NAME);
+
+        // Open the root and select the DCIM folder for selection.
+        bots.roots.openRoot(deviceLabel);
+        bots.directory.selectDocument("DCIM", 1);
+
+        // Click on the Images search chips.
+        onView(
+                allOf(
+                        withText("Images"),
+                        isDescendantOfA(withId(R.id.search_chip_group)),
+                        isDisplayed()))
+                .perform(new RelaxedClickAction());
+
+        // Ensure the selection has cleared and the "1 file selected" text is not displayed.
+        device.wait(Until.findObject(By.text(TestFilesRule.FILE_NAME_2).selected(false)), mTimeout);
+        device.wait(Until.gone(By.text("1 selected")), mTimeout);
+    }
+
+    @Test
+    @RequiresFlagsDisabled(
+            FLAG_USE_MATERIAL3) // TODO(b/412895530): Enable for `use_material3` once fixed.
+    public void testSelectionWhileSearchingHidesSearchBar() throws UiObjectNotFoundException {
+        String pkg = bots.directory.mTargetPackage;
+
+        // The `mTestFilesRule` creates more than 1 file, so ensure that that is the case before
+        // proceeding.
+        UiObject2 directoryList = device.findObject(By.res(pkg + ":id/dir_list"));
+        directoryList.wait(hasMoreThanOneChild(), mTimeout);
+
+        // Click the search icon and wait until the only result is the file that was searced for.
+        bots.search.expand();
+        bots.search.setInputText(TestFilesRule.FILE_NAME_1);
+        directoryList.wait(hasOneChild(), mTimeout);
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_1);
+
+        // Select the document. This implicitly verifies that the bar at the top shows the text "1
+        // selected" which, in all conditions, occludes the search input box.
+        bots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
+
+        // Deselect the document and click the clear button on the search view (if the selection bar
+        // at the top is visible this won't be possible).
+        bots.directory.clearSelection();
+        bots.search.clickSearchViewClearButton();
+        device.wait(Until.findObject(By.res(pkg + ":id/history_list")), mTimeout);
+    }
 }
diff --git a/tests/functional/com/android/documentsui/SidebarUiTest.java b/tests/functional/com/android/documentsui/SidebarUiTest.java
index 148c27e1b..d13f454cc 100644
--- a/tests/functional/com/android/documentsui/SidebarUiTest.java
+++ b/tests/functional/com/android/documentsui/SidebarUiTest.java
@@ -16,34 +16,48 @@
 
 package com.android.documentsui;
 
+import static android.view.InputDevice.SOURCE_MOUSE;
+
+import static androidx.test.espresso.Espresso.onView;
+import static androidx.test.espresso.action.ViewActions.click;
+import static androidx.test.espresso.matcher.ViewMatchers.withText;
+
 import static com.android.documentsui.StubProvider.ROOT_0_ID;
 import static com.android.documentsui.StubProvider.ROOT_1_ID;
 
+import android.view.MotionEvent;
+
 import androidx.test.filters.LargeTest;
 import androidx.test.filters.Suppress;
+import androidx.test.uiautomator.UiObjectNotFoundException;
 
 import com.android.documentsui.files.FilesActivity;
 import com.android.documentsui.filters.HugeLongTest;
+import com.android.documentsui.rules.TestFilesRule;
+
+import org.junit.Rule;
+import org.junit.Test;
 
 @LargeTest
-public class SidebarUiTest extends ActivityTest<FilesActivity> {
+public class SidebarUiTest extends ActivityTestJunit4<FilesActivity> {
 
     private static final String TAG = "RootUiTest";
 
-    public SidebarUiTest() {
-        super(FilesActivity.class);
-    }
+    @Rule
+    public final TestFilesRule mTestFilesRule = new TestFilesRule();
 
-    @Override
-    public void setUp() throws Exception {
-        super.setUp();
-        initTestFiles();
+    void assertDefaultContentOfTestDir0() throws UiObjectNotFoundException {
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_1);
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_2);
+        bots.directory.waitForDocument(TestFilesRule.DIR_NAME_1);
+        bots.directory.waitForDocument(TestFilesRule.FILE_NAME_NO_RENAME);
+        bots.directory.assertDocumentsCount(4);
     }
 
     @HugeLongTest
     public void testRootTapped_GoToRootFromChildDir() throws Exception {
-        bots.directory.openDocument(dirName1);
-        bots.main.assertWindowTitle(dirName1);
+        bots.directory.openDocument(TestFilesRule.DIR_NAME_1);
+        bots.main.assertWindowTitle(TestFilesRule.DIR_NAME_1);
         bots.roots.openRoot(ROOT_0_ID);
         bots.main.assertWindowTitle(ROOT_0_ID);
         assertDefaultContentOfTestDir0();
@@ -51,10 +65,26 @@ public class SidebarUiTest extends ActivityTest<FilesActivity> {
 
     @Suppress
     public void testRootChanged_ClearSelection() throws Exception {
-        bots.directory.selectDocument(fileName1, 1);
+        bots.directory.selectDocument(TestFilesRule.FILE_NAME_1, 1);
         bots.main.assertInActionMode(true);
 
         bots.roots.openRoot(ROOT_1_ID);
         bots.main.assertInActionMode(false);
     }
+
+    @Test
+    public void testPasteIntoFolderOnRoot() throws UiObjectNotFoundException {
+        bots.main.switchToListMode();
+
+        // Right click a file and copy it.
+        onView(withText("file1.log")).perform(click(SOURCE_MOUSE, MotionEvent.BUTTON_SECONDARY));
+        onView(withText("Copy")).perform(click());
+
+        // Right click a root and try to paste the copied file into it.
+        bots.roots.rightClickRootAndClickMenuOption(ROOT_1_ID, "Paste into folder");
+
+        // Navigate to the root and ensure the file has been copied successfully.
+        bots.roots.openRoot(ROOT_1_ID);
+        bots.directory.waitForDocument("file1.log");
+    }
 }
diff --git a/tests/functional/com/android/documentsui/SortDocumentUiTest.java b/tests/functional/com/android/documentsui/SortDocumentUiTest.java
index b277884e3..7983c242c 100644
--- a/tests/functional/com/android/documentsui/SortDocumentUiTest.java
+++ b/tests/functional/com/android/documentsui/SortDocumentUiTest.java
@@ -20,18 +20,18 @@ import static com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3;
 
 import android.net.Uri;
 import android.platform.test.annotations.RequiresFlagsEnabled;
-import android.platform.test.flag.junit.CheckFlagsRule;
-import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 import android.view.KeyEvent;
 
 import androidx.test.ext.junit.runners.AndroidJUnit4;
 import androidx.test.filters.LargeTest;
 
+import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.files.FilesActivity;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
+import com.android.documentsui.rules.TestFilesRule;
 import com.android.documentsui.sorting.SortDimension;
 import com.android.documentsui.sorting.SortModel;
 
-import org.junit.After;
 import org.junit.Before;
 import org.junit.Rule;
 import org.junit.Test;
@@ -66,6 +66,12 @@ public class SortDocumentUiTest extends ActivityTestJunit4<FilesActivity> {
     private static final String[] FILES_IN_TYPE_ASC = {FILE_2, FILE_3, FILE_1};
     private static final String[] FILES_IN_TYPE_DESC = reverse(FILES_IN_TYPE_ASC);
 
+    @Rule
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
+
+    @Rule
+    public final TestFilesRule mTestFilesRule = new TestFilesRule(/* skipCreation */ true);
+
     private static String[] reverse(String[] array) {
         String[] ret = new String[array.length];
 
@@ -76,20 +82,11 @@ public class SortDocumentUiTest extends ActivityTestJunit4<FilesActivity> {
         return ret;
     }
 
-    @Rule
-    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
-
     @Before
-    public void setUp() throws Exception {
-        super.setUp();
+    public void setUpTest() {
         bots.roots.closeDrawer();
     }
 
-    @After
-    public void tearDown() throws Exception {
-        super.tearDown();
-    }
-
     private void initFiles() throws Exception {
         initFiles(0);
     }
@@ -101,15 +98,17 @@ public class SortDocumentUiTest extends ActivityTestJunit4<FilesActivity> {
      * @param sleep time to sleep in ms
      */
     private void initFiles(long sleep) throws Exception {
+        RootInfo root = mTestFilesRule.docsHelper.getRoot(StubProvider.ROOT_0_ID);
         for (int i = 0; i < FILES.length; ++i) {
-            Uri uri = mDocsHelper.createDocument(getInitialRoot(), MIMES[i], FILES[i]);
-            mDocsHelper.writeDocument(uri, FILES[i].getBytes());
+            Uri uri =
+                    mTestFilesRule.docsHelper.createDocument(root, MIMES[i], FILES[i]);
+            mTestFilesRule.docsHelper.writeDocument(uri, FILES[i].getBytes());
 
             Thread.sleep(sleep);
         }
 
         for (String dir : DIRS) {
-            mDocsHelper.createFolder(getInitialRoot(), dir);
+            mTestFilesRule.docsHelper.createFolder(root, dir);
 
             Thread.sleep(sleep);
         }
diff --git a/tests/functional/com/android/documentsui/TrampolineActivityTest.kt b/tests/functional/com/android/documentsui/TrampolineActivityTest.kt
index 10b31d1eb..96fdf5383 100644
--- a/tests/functional/com/android/documentsui/TrampolineActivityTest.kt
+++ b/tests/functional/com/android/documentsui/TrampolineActivityTest.kt
@@ -19,8 +19,6 @@ import android.content.Intent
 import android.content.Intent.ACTION_GET_CONTENT
 import android.os.Build.VERSION_CODES
 import android.platform.test.annotations.RequiresFlagsEnabled
-import android.platform.test.flag.junit.CheckFlagsRule
-import android.platform.test.flag.junit.DeviceFlagsValueProvider
 import androidx.test.ext.junit.runners.AndroidJUnit4
 import androidx.test.filters.SdkSuppress
 import androidx.test.filters.SmallTest
@@ -30,8 +28,15 @@ import androidx.test.uiautomator.UiDevice
 import androidx.test.uiautomator.Until
 import com.android.documentsui.flags.Flags.FLAG_REDIRECT_GET_CONTENT_RO
 import com.android.documentsui.picker.TrampolineActivity
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import com.android.documentsui.util.getPhotopickerGetContentComponentNameForType
+import com.google.common.truth.TruthJUnit.assume
 import java.util.Optional
 import java.util.regex.Pattern
+import kotlin.time.Duration.Companion.seconds
+import kotlinx.coroutines.delay
+import kotlinx.coroutines.runBlocking
+import kotlinx.coroutines.withTimeoutOrNull
 import org.junit.Assert.assertNotNull
 import org.junit.Before
 import org.junit.BeforeClass
@@ -60,15 +65,36 @@ class TrampolineActivityTest() {
 
         private lateinit var device: UiDevice
 
-        fun removePhotopickerAndDocumentsUITasks() {
+        suspend fun removePhotopickerAndDocumentsUITasks() {
+            var taskIds = findPhotopickerAndDocumentsUITasks()
+
+            for (taskId in taskIds) {
+                device.executeShellCommand("am stack remove $taskId")
+            }
+
+            withTimeoutOrNull(5.seconds) {
+                while (taskIds.isNotEmpty()) {
+                    delay(100)
+                    taskIds = findPhotopickerAndDocumentsUITasks()
+                }
+                true
+            }
+        }
+
+        private fun findPhotopickerAndDocumentsUITasks(): Set<String> {
             // Get the current list of tasks that are visible.
             val result = device.executeShellCommand("am stack list")
 
             // Identify any that are from DocumentsUI or Photopicker and close them.
             val matcher = STACK_LIST_REGEX.matcher(result)
+
+            val taskIds = mutableSetOf<String>()
             while (matcher.find()) {
-                device.executeShellCommand("am stack remove ${matcher.group("taskId")}")
+                val taskId = matcher.group("taskId")
+                taskIds.add(taskId)
             }
+
+            return taskIds
         }
 
         @BeforeClass
@@ -153,12 +179,17 @@ class TrampolineActivityTest() {
         lateinit var testData: GetContentIntentData
 
         @get:Rule
-        val checkFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+        val checkFlags = CheckAndForceMaterial3Flag()
 
         @Before
         fun setUp() {
-            removePhotopickerAndDocumentsUITasks()
+            runBlocking {
+                removePhotopickerAndDocumentsUITasks()
+            }
+        }
 
+        @Test
+        fun testCorrectAppIsLaunched() {
             val context = InstrumentationRegistry.getInstrumentation().targetContext
             val intent = Intent(ACTION_GET_CONTENT)
             intent.setClass(context, TrampolineActivity::class.java)
@@ -169,27 +200,43 @@ class TrampolineActivityTest() {
             }
 
             context.startActivity(intent)
-        }
 
-        @Test
-        fun testCorrectAppIsLaunched() {
-            val bySelector = when (testData.expectedApp) {
-                AppType.PHOTOPICKER -> By.pkg(PHOTOPICKER_PACKAGE_REGEX)
+            val isPhotopickerGetContentComponentAvailable =
+                getPhotopickerGetContentComponentNameForType(
+                    context.packageManager, testData.mimeType) != null
+            val bySelector = when {
+                testData.expectedApp == AppType.PHOTOPICKER &&
+                        isPhotopickerGetContentComponentAvailable -> By.pkg(
+                    PHOTOPICKER_PACKAGE_REGEX
+                )
                 else -> By.pkg(DOCUMENTSUI_PACKAGE_REGEX)
             }
 
             val builder = StringBuilder()
             builder.append("Intent with mimetype ${testData.mimeType}")
             if (testData.extraMimeTypes.isPresent) {
-                builder.append(
-                    " and EXTRA_MIME_TYPES of ${
+                val extraMimeTypes = when {
+                    testData.extraMimeTypes.get().isNotEmpty() -> {
                         testData.extraMimeTypes.get().joinToString(", ")
-                    }"
+                    }
+                    else -> "empty array"
+                }
+                builder.append(
+                    " and EXTRA_MIME_TYPES of ($extraMimeTypes)"
+                )
+            }
+            if (testData.expectedApp == AppType.PHOTOPICKER &&
+                !isPhotopickerGetContentComponentAvailable) {
+                builder.append(
+                    " didn't cause ${AppType.DOCUMENTSUI} to appear " +
+                        "(${AppType.PHOTOPICKER} is expected, but is not available in this " +
+                        "environment) after ${UI_TIMEOUT}ms"
+                )
+            } else {
+                builder.append(
+                    " didn't cause ${testData.expectedApp.name} to appear after ${UI_TIMEOUT}ms"
                 )
             }
-            builder.append(
-                " didn't cause ${testData.expectedApp.name} to appear after ${UI_TIMEOUT}ms"
-            )
 
             assertNotNull(
                 builder.toString(),
@@ -202,16 +249,22 @@ class TrampolineActivityTest() {
     @RequiresFlagsEnabled(FLAG_REDIRECT_GET_CONTENT_RO)
     class RedirectTest {
         @get:Rule
-        val checkFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+        val checkFlags = CheckAndForceMaterial3Flag()
 
         @Before
         fun setUp() {
-            removePhotopickerAndDocumentsUITasks()
+            runBlocking {
+                removePhotopickerAndDocumentsUITasks()
+            }
         }
 
         @Test
         fun testReferredGetContentFromPhotopickerShouldNotRedirectBack() {
             val context = InstrumentationRegistry.getInstrumentation().targetContext
+            assume().that(
+                getPhotopickerGetContentComponentNameForType(context.packageManager, "image/*")
+            ).isNotNull()
+
             val intent = Intent(ACTION_GET_CONTENT)
             intent.setClass(context, TrampolineActivity::class.java)
             intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
diff --git a/tests/functional/com/android/documentsui/dirlist/DirectoryAddonsAdapterPrivateSpaceTest.java b/tests/functional/com/android/documentsui/dirlist/DirectoryAddonsAdapterPrivateSpaceTest.java
index cf057dec0..216543b60 100644
--- a/tests/functional/com/android/documentsui/dirlist/DirectoryAddonsAdapterPrivateSpaceTest.java
+++ b/tests/functional/com/android/documentsui/dirlist/DirectoryAddonsAdapterPrivateSpaceTest.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.dirlist;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import static org.mockito.Mockito.when;
 
 import android.content.Context;
@@ -98,7 +100,8 @@ public class DirectoryAddonsAdapterPrivateSpaceTest extends AndroidTestCase {
     public void testItemCount_mixed() {
         mEnv.reset();  // creates a mix of folders and files for us.
 
-        assertEquals(mEnv.model.getItemCount() + 1, mAdapter.getItemCount());
+        int expectedItemCount = mEnv.model.getItemCount() + (isUseMaterial3FlagEnabled() ? 0 : 1);
+        assertEquals(expectedItemCount, mAdapter.getItemCount());
     }
 
     public void testGetPosition() {
@@ -107,9 +110,12 @@ public class DirectoryAddonsAdapterPrivateSpaceTest extends AndroidTestCase {
         mEnv.model.update();
 
         assertEquals(0, mAdapter.getPosition(ModelId.build(mEnv.model.mUserId, AUTHORITY, "1")));
-        // adapter inserts a view between item 0 and 1 to force layout
-        // break between folders and files. This is reflected by an offset position.
-        assertEquals(2, mAdapter.getPosition(ModelId.build(mEnv.model.mUserId, AUTHORITY, "2")));
+        // adapter inserts a view between item 0 and 1 (this doesn't happen when use_material3 flag
+        // is enabled) to force a layout break between folders and files. This is reflected by an
+        // offset position.
+        int position = isUseMaterial3FlagEnabled() ? 1 : 2;
+        assertEquals(
+                position, mAdapter.getPosition(ModelId.build(mEnv.model.mUserId, AUTHORITY, "2")));
     }
 
     // Tests that the item count is correct for a directory containing only subdirs.
diff --git a/tests/functional/com/android/documentsui/dirlist/DirectoryAddonsAdapterTest.java b/tests/functional/com/android/documentsui/dirlist/DirectoryAddonsAdapterTest.java
index 49c316581..7a59034bb 100644
--- a/tests/functional/com/android/documentsui/dirlist/DirectoryAddonsAdapterTest.java
+++ b/tests/functional/com/android/documentsui/dirlist/DirectoryAddonsAdapterTest.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.dirlist;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.content.Context;
 import android.os.Bundle;
 import android.provider.DocumentsContract;
@@ -72,7 +74,8 @@ public class DirectoryAddonsAdapterTest extends AndroidTestCase {
     public void testItemCount_mixed() {
         mEnv.reset();  // creates a mix of folders and files for us.
 
-        assertEquals(mEnv.model.getItemCount() + 1, mAdapter.getItemCount());
+        int expectedItemCount = mEnv.model.getItemCount() + (isUseMaterial3FlagEnabled() ? 0 : 1);
+        assertEquals(expectedItemCount, mAdapter.getItemCount());
     }
 
     public void testGetPosition() {
@@ -81,9 +84,12 @@ public class DirectoryAddonsAdapterTest extends AndroidTestCase {
         mEnv.model.update();
 
         assertEquals(0, mAdapter.getPosition(ModelId.build(mEnv.model.mUserId, AUTHORITY, "1")));
-        // adapter inserts a view between item 0 and 1 to force layout
-        // break between folders and files. This is reflected by an offset position.
-        assertEquals(2, mAdapter.getPosition(ModelId.build(mEnv.model.mUserId, AUTHORITY, "2")));
+        // adapter inserts a view between item 0 and 1 (this doesn't happen when use_material3 flag
+        // is enabled) to force a layout break between folders and files. This is reflected by an
+        // offset position.
+        int position = isUseMaterial3FlagEnabled() ? 1 : 2;
+        assertEquals(
+                position, mAdapter.getPosition(ModelId.build(mEnv.model.mUserId, AUTHORITY, "2")));
     }
 
     // Tests that the item count is correct for a directory containing only subdirs.
diff --git a/tests/functional/com/android/documentsui/peek/PeekUiTest.kt b/tests/functional/com/android/documentsui/peek/PeekUiTest.kt
index a7624df2f..f7e86b5a3 100644
--- a/tests/functional/com/android/documentsui/peek/PeekUiTest.kt
+++ b/tests/functional/com/android/documentsui/peek/PeekUiTest.kt
@@ -17,14 +17,25 @@ package com.android.documentsui.peek
 
 import android.os.RemoteException
 import android.platform.test.annotations.RequiresFlagsEnabled
-import android.platform.test.flag.junit.CheckFlagsRule
-import android.platform.test.flag.junit.DeviceFlagsValueProvider
+import androidx.test.espresso.Espresso.onView
+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist
+import androidx.test.espresso.assertion.ViewAssertions.matches
+import androidx.test.espresso.matcher.ViewMatchers.isDisplayed
+import androidx.test.espresso.matcher.ViewMatchers.withContentDescription
 import androidx.test.ext.junit.runners.AndroidJUnit4
 import androidx.test.filters.LargeTest
+import androidx.test.platform.app.InstrumentationRegistry
+import androidx.test.uiautomator.By
+import androidx.test.uiautomator.UiObject2
 import com.android.documentsui.ActivityTestJunit4
+import com.android.documentsui.bots.PeekBot
 import com.android.documentsui.files.FilesActivity
 import com.android.documentsui.flags.Flags
-import org.junit.After
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import com.android.documentsui.rules.TestFilesRule
+import java.io.IOException
+import junit.framework.Assert.assertNotNull
+import junit.framework.Assert.assertNull
 import org.junit.Before
 import org.junit.Rule
 import org.junit.Test
@@ -34,35 +45,131 @@ import org.junit.runner.RunWith
 @RunWith(AndroidJUnit4::class)
 @RequiresFlagsEnabled(Flags.FLAG_USE_MATERIAL3, Flags.FLAG_USE_PEEK_PREVIEW_RO)
 class PeekUiTest : ActivityTestJunit4<FilesActivity?>() {
+    @get:Rule val checkFlags = CheckAndForceMaterial3Flag()
+
+    @Suppress("ktlint:standard:comment-wrapping")
     @get:Rule
-    val mCheckFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+    val testFilesRule: TestFilesRule = TestFilesRule(/* skipCreation= */ true)
+
+    private lateinit var peekBot: PeekBot
 
     @Before
+    fun setUpTest() {
+        peekBot = PeekBot(device!!, context!!, TIMEOUT)
+        initFiles()
+    }
+
+    @Throws(RemoteException::class, IOException::class)
+    fun initFiles() {
+        createFile("images/sample.jpg", "image/jpeg", "image.jpg")
+        createFile("images/sample.svg", "image/svg+xml", "image.svg")
+        createFile("documents/sample.log", "text/plain", "file0.log")
+    }
+
+    private fun createFile(sourcePath: String, mimeType: String, fileName: String) {
+        val file = testFilesRule.docsHelper.createDocument(rootDir0, mimeType, fileName)
+        val assetManager = InstrumentationRegistry.getInstrumentation().context.assets
+        assetManager.open(sourcePath).use { inputStream ->
+            testFilesRule.docsHelper.writeDocument(file, inputStream.readAllBytes())
+        }
+    }
+
+    private fun showAndCheckPreview(fileName: String) {
+        peekBot.assertPeekHidden()
+        bots.directory.selectDocument(fileName, 1)
+        bots.main.clickActionItem("Get info")
+        checkPreviewActive(fileName)
+    }
+
+    private fun checkPreviewActive(fileName: String) {
+        peekBot.assertPeekActive()
+        peekBot.assertHasTitle(fileName)
+    }
+
+    @Test
     @Throws(Exception::class)
-    override fun setUp() {
-        super.setUp()
-        initTestFiles()
+    fun testSequentialFilePreview() {
+        showAndCheckPreview("image.jpg")
+        peekBot.hide()
+        showAndCheckPreview("file0.log")
     }
 
-    @After
+    @Test
     @Throws(Exception::class)
-    override fun tearDown() {
-        super.tearDown()
+    fun testFileCantBeSelectedDuringFilePreview() {
+        // Selecting a document should show the "1 selected" label.
+        bots.directory.selectDocument("file0.log", 1)
+        // Show preview.
+        bots.main.clickActionItem("Get info")
+        checkPreviewActive("file0.log")
+        // When the preview is shown, the selection is still technically possible, but the scrim
+        // intercepts click events. The "1 selected" label shouldn't show.
+        val selectionHotspot: UiObject2 = bots.directory.findSelectionHotspot("file0.log")
+        assertNotNull(selectionHotspot)
+        selectionHotspot.click()
+        device!!.waitForIdle()
+        assertNull(device!!.findObject(By.text("1 selected")))
     }
 
-    @Throws(RemoteException::class)
-    override fun initTestFiles() {
-        mDocsHelper!!.createDocument(rootDir0, "image/png", "image.png")
+    @Test
+    @Throws(Exception::class)
+    fun testPeekRestorationOnConfigurationChange() {
+        showAndCheckPreview("image.jpg")
+
+        // Recreate the activity to simulate a configuration change (window resize, for example),
+        // and ensure that the preview is restored.
+        mActivityScenario!!.recreate()
+        checkPreviewActive("image.jpg")
+
+        peekBot.hide()
+        // Ensure that the Peek overlay isn't showing when the activity gets recreated after the
+        // overlay has been hidden.
+        mActivityScenario!!.recreate()
+        peekBot.assertPeekHidden()
+
+        bots.directory.selectDocument("file0.log", 1)
+        bots.main.clickActionItem("Get info")
+        checkPreviewActive("file0.log")
+        // Check Peek's contents when restoring a different preview.
+        mActivityScenario!!.recreate()
+        checkPreviewActive("file0.log")
+    }
+
+    @Test
+    @Throws(Exception::class)
+    fun testNoPreview() {
+        showAndCheckPreview("file0.log")
+
+        // Use the "No preview available" content description to ensure that the "No preview" shape
+        // is showing.
+        onView(withContentDescription("No preview available")).check(matches(isDisplayed()))
     }
 
     @Test
-    @Throws(
-        Exception::class
-    )
-    fun testShowPeek() {
-        bots!!.peek.assertPeekHidden()
-        bots!!.directory.selectDocument("image.png")
-        bots!!.main.clickActionItem("Get info")
-        bots!!.peek.assertPeekActive()
+    @Throws(Exception::class)
+    fun testMetadataSheet() {
+        bots.directory.selectDocument("file0.log", 1)
+        bots.main.clickActionItem("Get info")
+
+        // Check the metadata sheet state before and after recreating the activity.
+        peekBot.validateMetadataSheetState(true)
+        mActivityScenario!!.recreate()
+        peekBot.validateMetadataSheetState(true)
+    }
+
+    @Test
+    @Throws(Exception::class)
+    fun testImagePreview() {
+        // Check that the preview screen shows for "image.jpg"
+        showAndCheckPreview("image.jpg")
+        onView(withContentDescription("No preview available")).check(doesNotExist())
+        onView(withContentDescription("Image preview of image.jpg")).check(matches(isDisplayed()))
+        peekBot.hide()
+
+        // SVG files are not handled by ImageViews, check that the "no preview" fallback screen
+        // shows instead.
+        showAndCheckPreview("image.svg")
+        onView(withContentDescription("No preview available")).check(matches(isDisplayed()))
+        onView(withContentDescription("Image preview of image.svg")).check(doesNotExist())
     }
 }
diff --git a/tests/functional/com/android/documentsui/services/AbstractCopyJobTest.java b/tests/functional/com/android/documentsui/services/AbstractCopyJobTest.java
index b20942473..055b9e8c5 100644
--- a/tests/functional/com/android/documentsui/services/AbstractCopyJobTest.java
+++ b/tests/functional/com/android/documentsui/services/AbstractCopyJobTest.java
@@ -18,15 +18,16 @@ package com.android.documentsui.services;
 
 import static com.google.common.collect.Lists.newArrayList;
 
+import static org.junit.Assert.assertEquals;
+import static org.junit.Assert.assertFalse;
 import static org.junit.Assert.assertNotEquals;
+import static org.junit.Assert.assertTrue;
 
 import android.app.Notification;
 import android.net.Uri;
 import android.provider.DocumentsContract;
 import android.text.format.DateUtils;
 
-import androidx.test.filters.MediumTest;
-
 import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.services.FileOperationService.OpType;
@@ -35,7 +36,6 @@ import java.text.NumberFormat;
 import java.util.List;
 import java.util.stream.IntStream;
 
-@MediumTest
 public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJobTest<T> {
 
     private final @OpType int mOpType;
@@ -45,7 +45,7 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
     }
 
     private String getVerb() {
-        switch(mOpType) {
+        switch (mOpType) {
             case FileOperationService.OPERATION_COPY:
             case FileOperationService.OPERATION_EXTRACT:
                 return "Copying";
@@ -53,15 +53,34 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
                 return "Zipping";
             case FileOperationService.OPERATION_MOVE:
                 return "Moving";
+
+            // DeleteJob does not inherit from CopyJob
             case FileOperationService.OPERATION_DELETE:
-                // DeleteJob does not inherit from CopyJob
+            case FileOperationService.OPERATION_UNPACK:
             case FileOperationService.OPERATION_UNKNOWN:
             default:
                 return "";
         }
     }
 
-    public void runCopyFilesTest() throws Exception {
+    protected void runCopyFilesTest() throws Exception {
+        Uri testFile1 = mDocs.createDocument(mSrcRoot, "text/plain", "test1.txt");
+        mDocs.writeDocument(testFile1, HAM_BYTES);
+
+        Uri testFile2 = mDocs.createDocument(mSrcRoot, "text/plain", "test2.txt");
+        mDocs.writeDocument(testFile2, FRUITY_BYTES);
+
+        createJob(newArrayList(testFile1, testFile2)).run();
+        mJobListener.waitForFinished();
+
+        mDocs.assertChildCount(mDestRoot, 2);
+        mDocs.assertHasFile(mDestRoot, "test1.txt");
+        mDocs.assertHasFile(mDestRoot, "test2.txt");
+        mDocs.assertFileContents(mDestRoot.documentId, "test1.txt", HAM_BYTES);
+        mDocs.assertFileContents(mDestRoot.documentId, "test2.txt", FRUITY_BYTES);
+    }
+
+    protected void runCopyFilesTestWithJobProgress() throws Exception {
         Uri testFile1 = mDocs.createDocument(mSrcRoot, "text/plain", "test1.txt");
         mDocs.writeDocument(testFile1, HAM_BYTES);
 
@@ -70,7 +89,11 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
 
         CopyJob job = createJob(newArrayList(testFile1, testFile2));
         JobProgress progress = job.getJobProgress();
+        assertEquals(job.id, progress.id);
+        assertEquals(mOpType, progress.operationType);
         assertEquals(Job.STATE_CREATED, progress.state);
+        assertEquals(getVerb() + " 2 files to " + mDestRoot.title, progress.msg);
+        assertFalse(progress.hasFailures);
 
         job.run();
         mJobListener.waitForFinished();
@@ -83,18 +106,39 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
 
         progress = job.getJobProgress();
         assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertEquals(mOpType, progress.operationType);
         assertFalse(progress.hasFailures);
         assertEquals(getVerb() + " 2 files to " + mDestRoot.title, progress.msg);
         assertEquals(HAM_BYTES.length + FRUITY_BYTES.length, progress.currentBytes);
         assertEquals(HAM_BYTES.length + FRUITY_BYTES.length, progress.requiredBytes);
     }
 
-    public void runCopyVirtualTypedFileTest() throws Exception {
+    protected void runCopyVirtualTypedFileTest() throws Exception {
+        Uri testFile = mDocs.createVirtualFile(
+                mSrcRoot, "/virtual.sth", "virtual/mime-type",
+                FRUITY_BYTES, "application/pdf", "text/html");
+
+        createJob(newArrayList(testFile)).run();
+        waitForJobFinished();
+
+        mDocs.assertChildCount(mDestRoot, 1);
+        mDocs.assertHasFile(mDestRoot, "virtual.sth.pdf");  // copy should convert file to PDF.
+        mDocs.assertFileContents(mDestRoot.documentId, "virtual.sth.pdf", FRUITY_BYTES);
+    }
+
+    protected void runCopyVirtualTypedFileTestWithJobProgress() throws Exception {
         Uri testFile = mDocs.createVirtualFile(
                 mSrcRoot, "/virtual.sth", "virtual/mime-type",
                 FRUITY_BYTES, "application/pdf", "text/html");
 
         CopyJob job = createJob(newArrayList(testFile));
+        JobProgress progress = job.getJobProgress();
+        assertEquals(job.id, progress.id);
+        assertEquals(mOpType, progress.operationType);
+        assertEquals(Job.STATE_CREATED, progress.state);
+        assertEquals("Copying virtual.sth to " + mDestRoot.title, progress.msg);
+        assertFalse(progress.hasFailures);
+
         job.run();
         waitForJobFinished();
 
@@ -102,15 +146,30 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
         mDocs.assertHasFile(mDestRoot, "virtual.sth.pdf");  // copy should convert file to PDF.
         mDocs.assertFileContents(mDestRoot.documentId, "virtual.sth.pdf", FRUITY_BYTES);
 
-        JobProgress progress = job.getJobProgress();
+        progress = job.getJobProgress();
         assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertEquals(mOpType, progress.operationType);
         assertFalse(progress.hasFailures);
         assertEquals("Copying virtual.sth to " + mDestRoot.title, progress.msg);
         assertEquals(FRUITY_BYTES.length, progress.currentBytes);
         assertEquals(FRUITY_BYTES.length, progress.requiredBytes);
     }
 
-    public void runCopyVirtualNonTypedFileTest() throws Exception {
+    protected void runCopyVirtualNonTypedFileTest() throws Exception {
+        Uri testFile = mDocs.createVirtualFile(
+                mSrcRoot, "/virtual.sth", "virtual/mime-type",
+                FRUITY_BYTES);
+
+        createJob(newArrayList(testFile)).run();
+        waitForJobFinished();
+
+        mJobListener.assertFailed();
+        mJobListener.assertFilesFailed(newArrayList("virtual.sth"));
+
+        mDocs.assertChildCount(mDestRoot, 0);
+    }
+
+    protected void runCopyVirtualNonTypedFileTestWithJobProgress() throws Exception {
         Uri testFile = mDocs.createVirtualFile(
                 mSrcRoot, "/virtual.sth", "virtual/mime-type",
                 FRUITY_BYTES);
@@ -126,13 +185,32 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
 
         JobProgress progress = job.getJobProgress();
         assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertEquals(mOpType, progress.operationType);
         assertTrue(progress.hasFailures);
         assertEquals(getVerb() + " virtual.sth to " + mDestRoot.title, progress.msg);
         assertEquals(0, progress.currentBytes);
         assertEquals(FRUITY_BYTES.length, progress.requiredBytes);
     }
 
-    public void runCopyEmptyDirTest() throws Exception {
+    protected void runCopyEmptyDirTest() throws Exception {
+        Uri testDir = mDocs.createFolder(mSrcRoot, "emptyDir");
+
+        CopyJob job = createJob(newArrayList(testDir));
+        job.run();
+        waitForJobFinished();
+
+        Notification progressNotification = job.getProgressNotification();
+        String copyPercentage = progressNotification.extras.getString(Notification.EXTRA_SUB_TEXT);
+
+        // the percentage representation should not be NaN.
+        assertNotEquals("Percentage representation should not be NaN.",
+                NumberFormat.getPercentInstance().format(Double.NaN), copyPercentage);
+
+        mDocs.assertChildCount(mDestRoot, 1);
+        mDocs.assertHasDirectory(mDestRoot, "emptyDir");
+    }
+
+    protected void runCopyEmptyDirTestWithJobProgress() throws Exception {
         Uri testDir = mDocs.createFolder(mSrcRoot, "emptyDir");
 
         CopyJob job = createJob(newArrayList(testDir));
@@ -143,21 +221,22 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
         String copyPercentage = progressNotification.extras.getString(Notification.EXTRA_SUB_TEXT);
 
         // the percentage representation should not be NaN.
-        assertNotEquals(copyPercentage.equals(NumberFormat.getPercentInstance().format(Double.NaN)),
-                "Percentage representation should not be NaN.");
+        assertNotEquals("Percentage representation should not be NaN.",
+                NumberFormat.getPercentInstance().format(Double.NaN), copyPercentage);
 
         mDocs.assertChildCount(mDestRoot, 1);
         mDocs.assertHasDirectory(mDestRoot, "emptyDir");
 
         JobProgress progress = job.getJobProgress();
         assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertEquals(mOpType, progress.operationType);
         assertFalse(progress.hasFailures);
         assertEquals(getVerb() + " emptyDir to " + mDestRoot.title, progress.msg);
         assertEquals(-1, progress.currentBytes);
         assertEquals(-1, progress.requiredBytes);
     }
 
-    public void runCopyDirRecursivelyTest() throws Exception {
+    protected void runCopyDirRecursivelyTest() throws Exception {
 
         Uri testDir1 = mDocs.createFolder(mSrcRoot, "dir1");
         mDocs.createDocument(testDir1, "text/plain", "test1.txt");
@@ -179,7 +258,7 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
         mDocs.assertHasFile(dir2Copy.derivedUri, "test2.txt");
     }
 
-    public void runNoCopyDirToSelfTest() throws Exception {
+    protected void runNoCopyDirToSelfTest() throws Exception {
         Uri testDir = mDocs.createFolder(mSrcRoot, "someDir");
 
         createJob(mOpType,
@@ -194,7 +273,7 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
         mDocs.assertChildCount(mDestRoot, 0);
     }
 
-    public void runNoCopyDirToDescendentTest() throws Exception {
+    protected void runNoCopyDirToDescendentTest() throws Exception {
         Uri testDir = mDocs.createFolder(mSrcRoot, "someDir");
         Uri destDir = mDocs.createFolder(testDir, "theDescendent");
 
@@ -210,7 +289,7 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
         mDocs.assertChildCount(mDestRoot, 0);
     }
 
-    public void runCopyFileWithReadErrorsTest() throws Exception {
+    protected void runCopyFileWithReadErrorsTest() throws Exception {
         Uri testFile = mDocs.createDocument(mSrcRoot, "text/plain", "test1.txt");
         mDocs.writeDocument(testFile, HAM_BYTES);
 
@@ -226,7 +305,7 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
         mDocs.assertChildCount(mDestRoot, 0);
     }
 
-    public void runCopyProgressForFileCountTest() throws Exception {
+    protected void runCopyProgressForFileCountTest() throws Exception {
         // Init FileCountProgressTracker with 10 docs required to copy.
         TestCopyJobProcessTracker<CopyJob.FileCountProgressTracker> tracker =
                 new TestCopyJobProcessTracker(CopyJob.FileCountProgressTracker.class, 10,
@@ -260,7 +339,7 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
         tracker.assertNoRemainingTime();
     }
 
-    public void runCopyProgressForByteCountTest() throws Exception {
+    protected void runCopyProgressForByteCountTest() throws Exception {
         // Init ByteCountProgressTracker with 100 KBytes required to copy.
         TestCopyJobProcessTracker<CopyJob.ByteCountProgressTracker> tracker =
                 new TestCopyJobProcessTracker(CopyJob.ByteCountProgressTracker.class, 100000,
diff --git a/tests/functional/com/android/documentsui/services/AbstractJobTest.java b/tests/functional/com/android/documentsui/services/AbstractJobTest.java
index 290d24265..1f19d0982 100644
--- a/tests/functional/com/android/documentsui/services/AbstractJobTest.java
+++ b/tests/functional/com/android/documentsui/services/AbstractJobTest.java
@@ -23,10 +23,9 @@ import android.content.ContentResolver;
 import android.content.Context;
 import android.net.Uri;
 import android.os.RemoteException;
-import android.test.AndroidTestCase;
 
-import androidx.test.InstrumentationRegistry;
-import androidx.test.filters.MediumTest;
+import androidx.test.ext.junit.runners.AndroidJUnit4;
+import androidx.test.platform.app.InstrumentationRegistry;
 
 import com.android.documentsui.DocumentsProviderHelper;
 import com.android.documentsui.R;
@@ -40,10 +39,14 @@ import com.android.documentsui.services.FileOperationService.OpType;
 import com.android.documentsui.testing.DocsProviders;
 import com.android.documentsui.testing.TestFeatures;
 
+import org.junit.After;
+import org.junit.Before;
+import org.junit.runner.RunWith;
+
 import java.util.List;
 
-@MediumTest
-public abstract class AbstractJobTest<T extends Job> extends AndroidTestCase {
+@RunWith(AndroidJUnit4.class)
+public abstract class AbstractJobTest<T extends Job> {
 
     static final String AUTHORITY = StubProvider.DEFAULT_AUTHORITY;
     static final byte[] HAM_BYTES = "ham and cheese".getBytes();
@@ -59,21 +62,20 @@ public abstract class AbstractJobTest<T extends Job> extends AndroidTestCase {
 
     private TestFeatures mFeatures;
 
-    @Override
-    protected void setUp() throws Exception {
-        super.setUp();
+    @Before
+    public void setUp() throws Exception {
+        // NOTE: Must be the "target" context, else security checks in content provider will fail.
+        mContext = InstrumentationRegistry.getInstrumentation().getTargetContext();
 
         mFeatures = new TestFeatures();
-        mFeatures.notificationChannel = InstrumentationRegistry.getTargetContext()
-                .getResources().getBoolean(R.bool.feature_notification_channel);
-
-        mJobListener = new TestJobListener();
+        mFeatures.notificationChannel = mContext.getResources()
+                .getBoolean(R.bool.feature_notification_channel);
 
-        // NOTE: Must be the "target" context, else security checks in content provider will fail.
         mUserId = UserId.DEFAULT_USER;
-        mContext = getContext();
         mResolver = mContext.getContentResolver();
 
+        mJobListener = new TestJobListener();
+
         mDocs = new DocumentsProviderHelper(mUserId, AUTHORITY, mContext, AUTHORITY);
 
         // Reset storage before starting the tests.
@@ -82,11 +84,10 @@ public abstract class AbstractJobTest<T extends Job> extends AndroidTestCase {
         initTestFiles();
     }
 
-    @Override
-    protected void tearDown() throws Exception {
+    @After
+    public void tearDown() throws Exception {
         resetStorage();
         mDocs.cleanUp();
-        super.tearDown();
     }
 
     private void resetStorage() throws RemoteException {
@@ -125,7 +126,7 @@ public abstract class AbstractJobTest<T extends Job> extends AndroidTestCase {
     final T createJob(@OpType int opType, List<Uri> srcs, Uri srcParent, Uri destination)
             throws Exception {
         DocumentStack stack =
-                new DocumentStack(mSrcRoot, DocumentInfo.fromUri(mResolver, destination, mUserId));
+                new DocumentStack(mDestRoot, DocumentInfo.fromUri(mResolver, destination, mUserId));
 
         UrisSupplier urisSupplier = DocsProviders.createDocsProvider(srcs);
         FileOperation operation = new FileOperation.Builder()
diff --git a/tests/functional/com/android/documentsui/services/CopyJobTest.java b/tests/functional/com/android/documentsui/services/CopyJobTest.java
index 9074ef4c3..42c349a0e 100644
--- a/tests/functional/com/android/documentsui/services/CopyJobTest.java
+++ b/tests/functional/com/android/documentsui/services/CopyJobTest.java
@@ -16,34 +16,70 @@
 
 package com.android.documentsui.services;
 
+import static com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3;
+import static com.android.documentsui.flags.Flags.FLAG_VISUAL_SIGNALS_RO;
 import static com.android.documentsui.services.FileOperationService.OPERATION_COPY;
 
 import static com.google.common.collect.Lists.newArrayList;
 
+import static org.junit.Assert.assertEquals;
+import static org.junit.Assert.assertFalse;
+
 import android.net.Uri;
+import android.platform.test.annotations.RequiresFlagsEnabled;
 import android.provider.DocumentsContract.Document;
 
 import androidx.test.filters.MediumTest;
 
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
+
+import org.junit.Rule;
+import org.junit.Test;
+
 @MediumTest
 public class CopyJobTest extends AbstractCopyJobTest<CopyJob> {
 
+    @Rule
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
+
     public CopyJobTest() {
         super(OPERATION_COPY);
     }
 
+    @Test
     public void testCopyFiles() throws Exception {
         runCopyFilesTest();
     }
 
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO})
+    public void testCopyFilesWithProgress() throws Exception {
+        runCopyFilesTestWithJobProgress();
+    }
+
+    @Test
     public void testCopyVirtualTypedFile() throws Exception {
         runCopyVirtualTypedFileTest();
     }
 
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO})
+    public void testCopyVirtualTypedFileWithJobProgress() throws Exception {
+        runCopyVirtualTypedFileTestWithJobProgress();
+    }
+
+    @Test
     public void testCopyVirtualNonTypedFile() throws Exception {
         runCopyVirtualNonTypedFileTest();
     }
 
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO})
+    public void testCopyVirtualNonTypedFileWithProgress() throws Exception {
+        runCopyVirtualNonTypedFileTestWithJobProgress();
+    }
+
+    @Test
     public void testCopy_BackendSideVirtualTypedFile_Fallback() throws Exception {
         mDocs.assertChildCount(mDestRoot, 0);
 
@@ -52,50 +88,88 @@ public class CopyJobTest extends AbstractCopyJobTest<CopyJob> {
                 Document.FLAG_VIRTUAL_DOCUMENT | Document.FLAG_SUPPORTS_COPY
                         | Document.FLAG_SUPPORTS_MOVE, "application/pdf");
 
-        CopyJob job = createJob(newArrayList(testFile));
-        job.run();
+        createJob(newArrayList(testFile)).run();
 
         waitForJobFinished();
         mDocs.assertChildCount(mDestRoot, 1);
         mDocs.assertHasFile(mDestRoot, "tokyo.sth.pdf");  // Copy should convert file to PDF.
+    }
+
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO})
+    public void testCopyWithJobProgress_BackendSideVirtualTypedFile_Fallback() throws Exception {
+        mDocs.assertChildCount(mDestRoot, 0);
+
+        Uri testFile = mDocs.createDocumentWithFlags(
+                mSrcRoot.documentId, "virtual/mime-type", "tokyo.sth",
+                Document.FLAG_VIRTUAL_DOCUMENT | Document.FLAG_SUPPORTS_COPY
+                        | Document.FLAG_SUPPORTS_MOVE, "application/pdf");
+
+        CopyJob job = createJob(newArrayList(testFile));
 
         JobProgress progress = job.getJobProgress();
+        assertEquals(job.id, progress.id);
+        assertEquals(Job.STATE_CREATED, progress.state);
+        assertEquals("Copying tokyo.sth to " + mDestRoot.title, progress.msg);
+        assertFalse(progress.hasFailures);
+
+        job.run();
+        waitForJobFinished();
+        mDocs.assertChildCount(mDestRoot, 1);
+        mDocs.assertHasFile(mDestRoot, "tokyo.sth.pdf");  // Copy should convert file to PDF.
+
+        progress = job.getJobProgress();
         assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertEquals(OPERATION_COPY, progress.operationType);
         assertFalse(progress.hasFailures);
         assertEquals("Copying tokyo.sth to " + mDestRoot.title, progress.msg);
         assertEquals(-1, progress.currentBytes);
         assertEquals(-1, progress.requiredBytes);
     }
 
+    @Test
     public void testCopyEmptyDir() throws Exception {
         runCopyEmptyDirTest();
     }
 
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO})
+    public void testCopyEmptyDirWithJobProgress() throws Exception {
+        runCopyEmptyDirTestWithJobProgress();
+    }
+
+    @Test
     public void testCopyDirRecursively() throws Exception {
         runCopyDirRecursivelyTest();
     }
 
+    @Test
     public void testCopyDirRecursively_loadingInFirstCursor() throws Exception {
         mDocs.setLoadingDuration(500);
         testCopyDirRecursively();
     }
 
+    @Test
     public void testNoCopyDirToSelf() throws Exception {
         runNoCopyDirToSelfTest();
     }
 
+    @Test
     public void testNoCopyDirToDescendent() throws Exception {
         runNoCopyDirToDescendentTest();
     }
 
+    @Test
     public void testCopyFileWithReadErrors() throws Exception {
         runCopyFileWithReadErrorsTest();
     }
 
+    @Test
     public void testCopyProgressWithFileCount() throws Exception {
         runCopyProgressForFileCountTest();
     }
 
+    @Test
     public void testCopyProgressWithByteCount() throws Exception {
         runCopyProgressForByteCountTest();
     }
diff --git a/tests/functional/com/android/documentsui/services/DeleteJobTest.java b/tests/functional/com/android/documentsui/services/DeleteJobTest.java
index 86d9930a2..b676b840b 100644
--- a/tests/functional/com/android/documentsui/services/DeleteJobTest.java
+++ b/tests/functional/com/android/documentsui/services/DeleteJobTest.java
@@ -16,20 +16,35 @@
 
 package com.android.documentsui.services;
 
+import static com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3;
+import static com.android.documentsui.flags.Flags.FLAG_VISUAL_SIGNALS_RO;
 import static com.android.documentsui.services.FileOperationService.OPERATION_DELETE;
 
 import static com.google.common.collect.Lists.newArrayList;
 
+import static org.junit.Assert.assertEquals;
+import static org.junit.Assert.assertFalse;
+
 import android.net.Uri;
+import android.platform.test.annotations.RequiresFlagsEnabled;
 import android.provider.DocumentsContract;
 
 import androidx.test.filters.MediumTest;
 
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
+
+import org.junit.Rule;
+import org.junit.Test;
+
 import java.util.List;
 
 @MediumTest
 public class DeleteJobTest extends AbstractJobTest<DeleteJob> {
 
+    @Rule
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
+
+    @Test
     public void testDeleteFiles() throws Exception {
         Uri testFile1 = mDocs.createDocument(mSrcRoot, "text/plain", "test1.txt");
         mDocs.writeDocument(testFile1, HAM_BYTES);
@@ -37,19 +52,45 @@ public class DeleteJobTest extends AbstractJobTest<DeleteJob> {
         Uri testFile2 = mDocs.createDocument(mSrcRoot, "text/plain", "test2.txt");
         mDocs.writeDocument(testFile2, FRUITY_BYTES);
 
+        createJob(newArrayList(testFile1, testFile2),
+                DocumentsContract.buildDocumentUri(AUTHORITY, mSrcRoot.documentId))
+                .run();
+        mJobListener.waitForFinished();
+
+        mDocs.assertChildCount(mSrcRoot, 0);
+    }
+
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO})
+    public void testDeleteFilesWithProgress() throws Exception {
+        Uri testFile1 = mDocs.createDocument(mSrcRoot, "text/plain", "test1.txt");
+        mDocs.writeDocument(testFile1, HAM_BYTES);
+
+        Uri testFile2 = mDocs.createDocument(mSrcRoot, "text/plain", "test2.txt");
+        mDocs.writeDocument(testFile2, FRUITY_BYTES);
+
         DeleteJob job = createJob(newArrayList(testFile1, testFile2),
                 DocumentsContract.buildDocumentUri(AUTHORITY, mSrcRoot.documentId));
+        var progress = job.getJobProgress();
+        assertEquals(job.id, progress.id);
+        assertEquals(Job.STATE_CREATED, progress.state);
+        assertEquals(OPERATION_DELETE, progress.operationType);
+        assertFalse(progress.hasFailures);
+        assertEquals("Deleting 2 files", progress.msg);
+
         job.run();
         mJobListener.waitForFinished();
 
         mDocs.assertChildCount(mSrcRoot, 0);
 
-        var progress = job.getJobProgress();
+        progress = job.getJobProgress();
         assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertEquals(OPERATION_DELETE, progress.operationType);
         assertFalse(progress.hasFailures);
         assertEquals("Deleting 2 files", progress.msg);
     }
 
+    @Test
     public void testDeleteFiles_NoSrcParent() throws Exception {
         Uri testFile1 = mDocs.createDocument(mSrcRoot, "text/plain", "test1.txt");
         mDocs.writeDocument(testFile1, HAM_BYTES);
@@ -57,6 +98,21 @@ public class DeleteJobTest extends AbstractJobTest<DeleteJob> {
         Uri testFile2 = mDocs.createDocument(mSrcRoot, "text/plain", "test2.txt");
         mDocs.writeDocument(testFile2, FRUITY_BYTES);
 
+        createJob(newArrayList(testFile1, testFile2), null).run();
+        mJobListener.waitForFinished();
+
+        mDocs.assertChildCount(mSrcRoot, 0);
+    }
+
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO})
+    public void testDeleteFilesWithProgress_NoSrcParent() throws Exception {
+        Uri testFile1 = mDocs.createDocument(mSrcRoot, "text/plain", "test1.txt");
+        mDocs.writeDocument(testFile1, HAM_BYTES);
+
+        Uri testFile2 = mDocs.createDocument(mSrcRoot, "text/plain", "test2.txt");
+        mDocs.writeDocument(testFile2, FRUITY_BYTES);
+
         DeleteJob job = createJob(newArrayList(testFile1, testFile2), null);
         job.run();
         mJobListener.waitForFinished();
@@ -64,10 +120,35 @@ public class DeleteJobTest extends AbstractJobTest<DeleteJob> {
         mDocs.assertChildCount(mSrcRoot, 0);
         var progress = job.getJobProgress();
         assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertEquals(OPERATION_DELETE, progress.operationType);
         assertFalse(progress.hasFailures);
         assertEquals("Deleting 2 files", progress.msg);
     }
 
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO})
+    public void testDeleteSingleFile_ProgressMessage() throws Exception {
+        Uri testFile = mDocs.createDocument(mSrcRoot, "text/plain", "test1.txt");
+        mDocs.writeDocument(testFile, HAM_BYTES);
+        DeleteJob job = createJob(newArrayList(testFile), null);
+
+        var progress = job.getJobProgress();
+        assertEquals(job.id, progress.id);
+        assertEquals(Job.STATE_CREATED, progress.state);
+        assertEquals(OPERATION_DELETE, progress.operationType);
+        assertFalse(progress.hasFailures);
+        assertEquals("Deleting test1.txt", progress.msg);
+
+        job.run();
+        mJobListener.waitForFinished();
+
+        progress = job.getJobProgress();
+        assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertEquals(OPERATION_DELETE, progress.operationType);
+        assertFalse(progress.hasFailures);
+        assertEquals("Deleting test1.txt", progress.msg);
+    }
+
     /**
      * Creates a job with a stack consisting to the default src directory.
      */
diff --git a/tests/functional/com/android/documentsui/services/FileOperationServiceTest.java b/tests/functional/com/android/documentsui/services/FileOperationServiceTest.java
index 5820f460f..f2e032ac8 100644
--- a/tests/functional/com/android/documentsui/services/FileOperationServiceTest.java
+++ b/tests/functional/com/android/documentsui/services/FileOperationServiceTest.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.services;
 
+import static com.android.documentsui.services.FileOperationService.EXTRA_CANCEL;
+import static com.android.documentsui.services.FileOperationService.EXTRA_JOB_ID;
 import static com.android.documentsui.services.FileOperationService.OPERATION_COPY;
 import static com.android.documentsui.services.FileOperationService.OPERATION_DELETE;
 import static com.android.documentsui.services.FileOperations.createBaseIntent;
@@ -109,8 +111,6 @@ public class FileOperationServiceTest extends ServiceTestCase<FileOperationServi
 
         assertNull(mService.features);
         mService.features = features;
-
-        mService.mVisualSignalsEnabled = false;
     }
 
     @Override
@@ -265,26 +265,37 @@ public class FileOperationServiceTest extends ServiceTestCase<FileOperationServi
     public void testRunsInForeground_MultipleJobs() throws Exception {
         startService(createCopyIntent(Arrays.asList(ALPHA_DOC), BETA_DOC));
         startService(createCopyIntent(Arrays.asList(GAMMA_DOC), DELTA_DOC));
+        Job job2 = mCopyJobs.get(1);
 
         mExecutor.run(0);
         mForegroundManager.assertInForeground();
 
-        mHandler.dispatchAllMessages();
+        while (mTestNotificationManager.hasNotification(
+                FileOperationService.NOTIFICATION_ID_PROGRESS, job2.id)) {
+            mHandler.dispatchNextMessage();
+        }
         mForegroundManager.assertInForeground();
     }
 
     public void testFinishesInBackground_MultipleJobs() throws Exception {
         startService(createCopyIntent(Arrays.asList(ALPHA_DOC), BETA_DOC));
         startService(createCopyIntent(Arrays.asList(GAMMA_DOC), DELTA_DOC));
+        Job job2 = mCopyJobs.get(1);
 
         mExecutor.run(0);
         mForegroundManager.assertInForeground();
 
-        mHandler.dispatchAllMessages();
+        while (mTestNotificationManager.hasNotification(
+                FileOperationService.NOTIFICATION_ID_PROGRESS, job2.id)) {
+            mHandler.dispatchNextMessage();
+        }
         mForegroundManager.assertInForeground();
 
         mExecutor.run(0);
-        mHandler.dispatchAllMessages();
+        while (mTestNotificationManager.hasNotification(
+                FileOperationService.NOTIFICATION_ID_PROGRESS, null)) {
+            mHandler.dispatchNextMessage();
+        }
         mForegroundManager.assertInBackground();
     }
 
@@ -312,18 +323,32 @@ public class FileOperationServiceTest extends ServiceTestCase<FileOperationServi
         mTestNotificationManager.assertHasNotification(
                 FileOperationService.NOTIFICATION_ID_PROGRESS, job2.id);
 
-        job1.cancel();
+        startService(createCancelIntent(job1.id));
         mService.onFinished(job1);
         mTestNotificationManager.assertHasNotification(
                 FileOperationService.NOTIFICATION_ID_PROGRESS, null);
         mTestNotificationManager.assertNoNotification(
                 FileOperationService.NOTIFICATION_ID_PROGRESS, job2.id);
 
-        job2.cancel();
+        startService(createCancelIntent(job2.id));
         mService.onFinished(job2);
         mTestNotificationManager.assertNumberOfNotifications(0);
     }
 
+    public void testCancelJobWithQueuedJobs() throws Exception {
+        startService(createCopyIntent(Arrays.asList(ALPHA_DOC), BETA_DOC));
+        startService(createCopyIntent(Arrays.asList(GAMMA_DOC), DELTA_DOC));
+        Job job1 = mCopyJobs.get(0);
+        Job job2 = mCopyJobs.get(1);
+
+        mService.onStart(job1);
+        startService(createCancelIntent(job1.id));
+        mService.onFinished(job1);
+
+        startService(createCancelIntent(job2.id));
+        mTestNotificationManager.assertNumberOfNotifications(0);
+    }
+
     private Intent createCopyIntent(List<DocumentInfo> files, DocumentInfo dest)
             throws Exception {
         DocumentStack stack = new DocumentStack();
@@ -354,6 +379,13 @@ public class FileOperationServiceTest extends ServiceTestCase<FileOperationServi
         return createBaseIntent(getContext(), createJobId(), operation);
     }
 
+    private Intent createCancelIntent(String jobId) {
+        Intent intent = new Intent(getContext(), FileOperationService.class);
+        intent.putExtra(EXTRA_CANCEL, true);
+        intent.putExtra(EXTRA_JOB_ID, jobId);
+        return intent;
+    }
+
     private static DocumentInfo createDoc(String name) {
         // Doesn't need to be valid content Uri, just some urly looking thing.
         Uri uri = new Uri.Builder()
diff --git a/tests/functional/com/android/documentsui/services/JobErrorHandlingTest.java b/tests/functional/com/android/documentsui/services/JobErrorHandlingTest.java
index ba3373f5e..2a2a28c6d 100644
--- a/tests/functional/com/android/documentsui/services/JobErrorHandlingTest.java
+++ b/tests/functional/com/android/documentsui/services/JobErrorHandlingTest.java
@@ -25,6 +25,8 @@ import android.provider.DocumentsContract;
 
 import androidx.test.filters.MediumTest;
 
+import org.junit.Test;
+
 import java.util.List;
 
 /**
@@ -34,6 +36,7 @@ import java.util.List;
 @MediumTest
 public class JobErrorHandlingTest extends AbstractJobTest<DeleteJob> {
 
+    @Test
     public void testRecoversFromInvalidUri() throws Exception {
         Uri invalidUri1 = Uri.parse("content://poodles/chuckleberry/ham");
         Uri validUri = mDocs.createDocument(mSrcRoot, "text/plain", "test2.txt");
@@ -49,6 +52,7 @@ public class JobErrorHandlingTest extends AbstractJobTest<DeleteJob> {
         mDocs.assertChildCount(mSrcRoot, 0);
     }
 
+    @Test
     public void testRecordsInvalidUris() throws Exception {
         Uri invalidUri1 = Uri.parse("content://poodles/chuckleberry/ham");
         Uri validUri = mDocs.createDocument(mSrcRoot, "text/plain", "test2.txt");
@@ -63,6 +67,7 @@ public class JobErrorHandlingTest extends AbstractJobTest<DeleteJob> {
         mJobListener.assertUriFailed(invalidUri2);
     }
 
+    @Test
     public void testReportsCorrectFailureCount() throws Exception {
         Uri invalidUri1 = Uri.parse("content://poodles/chuckleberry/ham");
         Uri validUri = mDocs.createDocument(mSrcRoot, "text/plain", "test2.txt");
diff --git a/tests/functional/com/android/documentsui/services/MoveJobTest.java b/tests/functional/com/android/documentsui/services/MoveJobTest.java
index 4b032f527..0050ecfa1 100644
--- a/tests/functional/com/android/documentsui/services/MoveJobTest.java
+++ b/tests/functional/com/android/documentsui/services/MoveJobTest.java
@@ -16,28 +16,49 @@
 
 package com.android.documentsui.services;
 
+import static com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3;
+import static com.android.documentsui.flags.Flags.FLAG_VISUAL_SIGNALS_RO;
 import static com.android.documentsui.services.FileOperationService.OPERATION_MOVE;
 
 import static com.google.common.collect.Lists.newArrayList;
 
 import android.net.Uri;
+import android.platform.test.annotations.RequiresFlagsEnabled;
 import android.provider.DocumentsContract.Document;
 
 import androidx.test.filters.MediumTest;
 
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
+
+import org.junit.Rule;
+import org.junit.Test;
+
 @MediumTest
 public class MoveJobTest extends AbstractCopyJobTest<MoveJob> {
 
+    @Rule
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
+
     public MoveJobTest() {
         super(OPERATION_MOVE);
     }
 
+    @Test
     public void testMoveFiles() throws Exception {
         runCopyFilesTest();
 
         mDocs.assertChildCount(mSrcRoot, 0);
     }
 
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO})
+    public void testMoveFilesWithJobProgress() throws Exception {
+        runCopyFilesTestWithJobProgress();
+
+        mDocs.assertChildCount(mSrcRoot, 0);
+    }
+
+    @Test
     public void testMoveFiles_NoSrcParent() throws Exception {
         Uri testFile1 = mDocs.createDocument(mSrcRoot, "text/plain", "test1.txt");
         mDocs.writeDocument(testFile1, HAM_BYTES);
@@ -55,6 +76,7 @@ public class MoveJobTest extends AbstractCopyJobTest<MoveJob> {
         mDocs.assertFileContents(mDestRoot.documentId, "test2.txt", FRUITY_BYTES);
     }
 
+    @Test
     public void testMoveVirtualTypedFile() throws Exception {
         mDocs.createFolder(mSrcRoot, "hello");
         Uri testFile = mDocs.createVirtualFile(
@@ -70,6 +92,7 @@ public class MoveJobTest extends AbstractCopyJobTest<MoveJob> {
         mDocs.assertChildCount(mSrcRoot, 1);
     }
 
+    @Test
     public void testMoveVirtualNonTypedFile() throws Exception {
         runCopyVirtualNonTypedFileTest();
 
@@ -77,6 +100,16 @@ public class MoveJobTest extends AbstractCopyJobTest<MoveJob> {
         mDocs.assertChildCount(mSrcRoot, 1);
     }
 
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO})
+    public void testMoveVirtualNonTypedFileWithJobProgress() throws Exception {
+        runCopyVirtualNonTypedFileTestWithJobProgress();
+
+        // Should have failed, source not deleted.
+        mDocs.assertChildCount(mSrcRoot, 1);
+    }
+
+    @Test
     public void testMove_BackendSideVirtualTypedFile_Fallback() throws Exception {
         Uri testFile = mDocs.createDocumentWithFlags(
                 mSrcRoot.documentId, "virtual/mime-type", "tokyo.sth",
@@ -92,23 +125,35 @@ public class MoveJobTest extends AbstractCopyJobTest<MoveJob> {
         mDocs.assertChildCount(mSrcRoot, 1);
     }
 
+    @Test
     public void testMoveEmptyDir() throws Exception {
         runCopyEmptyDirTest();
 
         mDocs.assertChildCount(mSrcRoot, 0);
     }
 
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO})
+    public void testMoveEmptyDirWithJobProgress() throws Exception {
+        runCopyEmptyDirTestWithJobProgress();
+
+        mDocs.assertChildCount(mSrcRoot, 0);
+    }
+
+    @Test
     public void testMoveDirRecursively() throws Exception {
         runCopyDirRecursivelyTest();
 
         mDocs.assertChildCount(mSrcRoot, 0);
     }
 
+    @Test
     public void testMoveDirRecursively_loadingInFirstCursor() throws Exception {
         mDocs.setLoadingDuration(500);
         testMoveDirRecursively();
     }
 
+    @Test
     public void testNoMoveDirToSelf() throws Exception {
         runNoCopyDirToSelfTest();
 
@@ -116,6 +161,7 @@ public class MoveJobTest extends AbstractCopyJobTest<MoveJob> {
         mDocs.assertChildCount(mSrcRoot, 1);
     }
 
+    @Test
     public void testNoMoveDirToDescendent() throws Exception {
         runNoCopyDirToDescendentTest();
 
@@ -123,6 +169,7 @@ public class MoveJobTest extends AbstractCopyJobTest<MoveJob> {
         mDocs.assertChildCount(mSrcRoot, 1);
     }
 
+    @Test
     public void testMoveFileWithReadErrors() throws Exception {
         runCopyFileWithReadErrorsTest();
 
diff --git a/tests/functional/com/android/documentsui/services/UnpackJobTest.kt b/tests/functional/com/android/documentsui/services/UnpackJobTest.kt
new file mode 100644
index 000000000..3e3023172
--- /dev/null
+++ b/tests/functional/com/android/documentsui/services/UnpackJobTest.kt
@@ -0,0 +1,807 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.services
+
+import android.app.Notification.CATEGORY_ERROR
+import android.app.Notification.CATEGORY_PROGRESS
+import android.app.Notification.EXTRA_PROGRESS_INDETERMINATE
+import android.app.Notification.EXTRA_TEXT
+import android.app.Notification.EXTRA_TITLE
+import android.net.Uri
+import android.platform.test.annotations.RequiresFlagsDisabled
+import android.platform.test.annotations.RequiresFlagsEnabled
+import android.provider.DocumentsContract.buildDocumentUri
+import android.util.Log
+import androidx.test.filters.MediumTest
+import androidx.test.platform.app.InstrumentationRegistry.getInstrumentation
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3
+import com.android.documentsui.flags.Flags.FLAG_ZIP_NG_RO
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import com.android.documentsui.services.FileOperationService.OPERATION_UNPACK
+import com.google.common.truth.Truth.assertThat
+import com.google.common.truth.Truth.assertWithMessage
+import java.io.File
+import org.junit.Rule
+import org.junit.Test
+
+/** Tests UnpackJob. */
+@MediumTest
+internal class UnpackJobTest : AbstractJobTest<UnpackJob>() {
+    @get:Rule
+    val checkFlags = CheckAndForceMaterial3Flag()
+
+    /** Tests with a MIME type that is not a supported archive type. */
+    @Test
+    fun unsupportedMimeType() {
+        val uri = mDocs.createDocument(mSrcRoot, "text/plain", "My Text File.txt")
+        mDocs.writeDocument(uri, HAM_BYTES)
+        assertTreeIs(mutableMapOf("/My Text File.txt" to 14))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+        mJobListener.assertFailed()
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isTrue()
+            assertThat(msg).isEqualTo("Extracting My Text File.txt to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        // No extraction folder should have been created.
+        assertTreeIs(mutableMapOf("/My Text File.txt" to 14))
+    }
+
+    /** Tests with an invalid ZIP archive. */
+    @Test
+    fun invalidZip() {
+        val uri = mDocs.createDocument(mSrcRoot, "application/zip", "My Archive.zip")
+        mDocs.writeDocument(uri, HAM_BYTES)
+        assertTreeIs(mutableMapOf("/My Archive.zip" to 14))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+        mJobListener.assertFailed()
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isTrue()
+            assertThat(msg).isEqualTo("Extracting My Archive.zip to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        // No extraction folder should have been created.
+        assertTreeIs(mutableMapOf("/My Archive.zip" to 14))
+    }
+
+    /** Tests with a valid ZIP archive. */
+    @Test
+    fun validZip() {
+        val uri = createDocument("application/zip", "archives/zip/hello.zip")
+        assertTreeIs(mutableMapOf("/hello.zip" to 806))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+        mJobListener.assertFinished()
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isFalse()
+            assertThat(msg).isEqualTo("Extracting hello.zip to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(110)
+            assertThat(requiredBytes).isEqualTo(110)
+            assertThat(msRemaining).isLessThan(0)
+            assertThat(destination!!.peek().displayName).isEqualTo("hello")
+        }
+
+        assertTreeIs(
+            mutableMapOf(
+                "/hello.zip" to 806,
+                "/hello/" to -1,
+                "/hello/hello/" to -1,
+                "/hello/hello/hello.txt" to 48,
+                "/hello/hello/hello2.txt" to 48,
+                "/hello/hello/inside_folder/" to -1,
+                "/hello/hello/inside_folder/hello_insside.txt" to 14,
+            )
+        )
+    }
+
+    /** Tests with a valid 7Z archive. */
+    @Test
+    fun valid7Z() {
+        val uri = createDocument("application/x-7z-compressed", "archives/7z/hello.7z")
+        assertTreeIs(mutableMapOf("/hello.7z" to 253))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+        mJobListener.assertFinished()
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isFalse()
+            assertThat(msg).isEqualTo("Extracting hello.7z to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(110)
+            assertThat(requiredBytes).isEqualTo(110)
+            assertThat(msRemaining).isLessThan(0)
+            assertThat(destination!!.peek().displayName).isEqualTo("hello")
+        }
+
+        assertTreeIs(
+            mutableMapOf(
+                "/hello.7z" to 253,
+                "/hello/" to -1,
+                "/hello/hello/" to -1,
+                "/hello/hello/hello.txt" to 48,
+                "/hello/hello/hello2.txt" to 48,
+                "/hello/hello/inside_folder/" to -1,
+                "/hello/hello/inside_folder/hello_insside.txt" to 14,
+            )
+        )
+    }
+
+    /** Tests with a valid TAR archive. */
+    @Test
+    fun validTar() {
+        val uri = createDocument("application/x-tar", "archives/tar/hello.tar")
+        assertTreeIs(mutableMapOf("/hello.tar" to 10240))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+        mJobListener.assertFinished()
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isFalse()
+            assertThat(msg).isEqualTo("Extracting hello.tar to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(110)
+            assertThat(requiredBytes).isEqualTo(110)
+            assertThat(msRemaining).isLessThan(0)
+            assertThat(destination!!.peek().displayName).isEqualTo("hello")
+        }
+
+        assertTreeIs(
+            mutableMapOf(
+                "/hello.tar" to 10240,
+                "/hello/" to -1,
+                "/hello/hello/" to -1,
+                "/hello/hello/hello.txt" to 48,
+                "/hello/hello/hello2.txt" to 48,
+                "/hello/hello/inside_folder/" to -1,
+                "/hello/hello/inside_folder/hello_insside.txt" to 14,
+            )
+        )
+    }
+
+    /** Tests with a valid TGZ archive. */
+    @Test
+    fun validTgz() {
+        val uri = createDocument("application/x-gtar-compressed", "archives/tar_gz/hello.tgz")
+        assertTreeIs(mutableMapOf("/hello.tgz" to 406))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+        mJobListener.assertFinished()
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isFalse()
+            assertThat(msg).isEqualTo("Extracting hello.tgz to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(110)
+            assertThat(requiredBytes).isEqualTo(110)
+            assertThat(msRemaining).isLessThan(0)
+            assertThat(destination!!.peek().displayName).isEqualTo("hello")
+        }
+
+        assertTreeIs(
+            mutableMapOf(
+                "/hello.tgz" to 406,
+                "/hello/" to -1,
+                "/hello/hello/" to -1,
+                "/hello/hello/hello.txt" to 48,
+                "/hello/hello/hello2.txt" to 48,
+                "/hello/hello/inside_folder/" to -1,
+                "/hello/hello/inside_folder/hello_insside.txt" to 14,
+            )
+        )
+    }
+
+    /** Tests with a partially encrypted ZIP archive. */
+    @Test
+    fun partiallyEncryptedZip() {
+        val uri = createDocument("application/zip", "archives/zip/different-encryptions.zip")
+        assertTreeIs(mutableMapOf("/different-encryptions.zip" to 1083))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+        mJobListener.assertFailed()
+        mJobListener.assertFailureCount(4)
+        assertThat(job.failedPaths).containsExactly(
+            "/Encrypted AES-128.txt",
+            "/Encrypted AES-192.txt",
+            "/Encrypted AES-256.txt",
+            "/Encrypted ZipCrypto.txt"
+        )
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isTrue()
+            assertThat(msg).isEqualTo("Extracting different-encryptions.zip to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(23)
+            assertThat(requiredBytes).isEqualTo(23)
+            assertThat(msRemaining).isLessThan(0)
+            assertThat(destination!!.peek().displayName).isEqualTo("different-encryptions")
+        }
+
+        // The archive should have been partially extracted.
+        assertTreeIs(
+            mutableMapOf(
+                "/different-encryptions.zip" to 1083,
+                "/different-encryptions/" to -1,
+                "/different-encryptions/ClearText.txt" to 23,
+            )
+        )
+    }
+
+    /** Tests when there is a collision for the extraction folder. */
+    @Test
+    fun collisionForExtractionFolder() {
+        val uri = createDocument("application/zip", "archives/zip/hello.zip")
+        mDocs.createFolder(mSrcRoot, "hello")
+        assertTreeIs(
+            mutableMapOf(
+                "/hello.zip" to 806,
+                "/hello/" to -1,
+            )
+        )
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+
+        // The destination document provider used in this test does not automatically rename a
+        // folder in case of name collision.
+        // As a consequence, UnpackJob fails to extract the archive.
+        mJobListener.assertFailed()
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isTrue()
+            assertThat(msg).isEqualTo("Extracting hello.zip to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(110)
+        }
+
+        assertTreeIs(
+            mutableMapOf(
+                "/hello.zip" to 806,
+                "/hello/" to -1,
+            )
+        )
+    }
+
+    /** Tests with a ZIP archive containing colliding entries. */
+    @Test
+    fun collisionsInArchive() {
+        val uri = createDocument("application/zip", "archives/zip/file-dir-same-name.zip")
+        assertTreeIs(mutableMapOf("/file-dir-same-name.zip" to 823))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+
+        // The destination document provider used in this test does not automatically rename files
+        // or folders in case of name collisions.
+        // As a consequence, UnpackJob fails to extract some files from the archive.
+        mJobListener.assertFailed()
+        mJobListener.assertFailureCount(6)
+        assertThat(job.failedPaths).containsExactly(
+            "/pet/cat",
+            "/pet",
+            "/pet/cat/fish",
+            "/pet/cat",
+            "/pet",
+            "/pet/cat/fish"
+        )
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isTrue()
+            assertThat(msg).isEqualTo("Extracting file-dir-same-name.zip to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+            assertThat(destination!!.peek().displayName).isEqualTo("file-dir-same-name")
+        }
+
+        // The archive should have been partially extracted.
+        assertTreeIs(
+            mutableMapOf(
+                "/file-dir-same-name.zip" to 823,
+                "/file-dir-same-name/" to -1,
+                "/file-dir-same-name/pet/" to -1,
+                "/file-dir-same-name/pet/cat/" to -1,
+                "/file-dir-same-name/pet/cat/fish/" to -1,
+            )
+        )
+    }
+
+    /** Tests with a ZIP archive containing a corrupted file that can be detected via its CRC. */
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_MATERIAL3, FLAG_ZIP_NG_RO)
+    fun badCrcChecked() {
+        val uri = createDocument("application/zip", "archives/zip/bad-crc.zip")
+        assertTreeIs(mutableMapOf("/bad-crc.zip" to 234))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+
+        // The file with a bad CRC should be detected.
+        mJobListener.assertFailed()
+        mJobListener.assertFailureCount(1)
+        assertThat(job.failedPaths).containsExactly("/bad-crc.txt")
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isTrue()
+            assertThat(msg).isEqualTo("Extracting bad-crc.zip to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+            assertThat(destination!!.peek().displayName).isEqualTo("bad-crc")
+        }
+
+        // The partially extracted file with a bad CRC should have been removed.
+        assertTreeIs(
+            mutableMapOf(
+                "/bad-crc.zip" to 234,
+                "/bad-crc/" to -1,
+            )
+        )
+    }
+
+    @Test
+    @RequiresFlagsDisabled(FLAG_ZIP_NG_RO)
+    fun badCrcUnchecked() {
+        val uri = createDocument("application/zip", "archives/zip/bad-crc.zip")
+        assertTreeIs(mutableMapOf("/bad-crc.zip" to 234))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+
+        // The file with a bad CRC should not be detected.
+        mJobListener.assertFinished()
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isFalse()
+            assertThat(msg).isEqualTo("Extracting bad-crc.zip to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(62)
+            assertThat(requiredBytes).isEqualTo(62)
+            assertThat(msRemaining).isLessThan(0)
+            assertThat(destination!!.peek().displayName).isEqualTo("bad-crc")
+        }
+
+        assertTreeIs(
+            mutableMapOf(
+                "/bad-crc.zip" to 234,
+                "/bad-crc/" to -1,
+                "/bad-crc/bad-crc.txt" to 62,
+            )
+        )
+    }
+
+    /** Tests with a ZIP archive containing a corrupted repository with wrong file sizes. */
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_MATERIAL3, FLAG_ZIP_NG_RO)
+    fun badSizesChecked() {
+        val uri = createDocument("application/zip", "archives/zip/bad-sizes.zip")
+        assertTreeIs(mutableMapOf("/bad-sizes.zip" to 886))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+
+        // The files with incorrect sizes should be detected.
+        mJobListener.assertFailed()
+        mJobListener.assertFailureCount(7)
+        assertThat(job.failedPaths).containsExactly(
+            "/0.txt",
+            "/1.txt",
+            "/2.txt",
+            "/4.txt",
+            "/5.txt",
+            "/6.txt",
+            "/7.txt"
+        )
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isTrue()
+            assertThat(msg).isEqualTo("Extracting bad-sizes.zip to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(3)
+            assertThat(requiredBytes).isEqualTo(3)
+            assertThat(msRemaining).isLessThan(0)
+            assertThat(destination!!.peek().displayName).isEqualTo("bad-sizes")
+        }
+
+        // Only the file with the correct size should have been extracted.
+        assertTreeIs(
+            mutableMapOf(
+                "/bad-sizes.zip" to 886,
+                "/bad-sizes/" to -1,
+                "/bad-sizes/d/" to -1,
+                "/bad-sizes/3.txt" to 3,
+            )
+        )
+    }
+
+    @Test
+    @RequiresFlagsDisabled(FLAG_ZIP_NG_RO)
+    fun badSizesUnchecked() {
+        val uri = createDocument("application/zip", "archives/zip/bad-sizes.zip")
+        assertTreeIs(mutableMapOf("/bad-sizes.zip" to 886))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+
+        // The files with incorrect sizes should not be detected.
+        mJobListener.assertFinished()
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isFalse()
+            assertThat(msg).isEqualTo("Extracting bad-sizes.zip to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(28)
+            assertThat(requiredBytes).isEqualTo(28)
+            assertThat(msRemaining).isLessThan(0)
+            assertThat(destination!!.peek().displayName).isEqualTo("bad-sizes")
+        }
+
+        assertTreeIs(
+            mutableMapOf(
+                "/bad-sizes.zip" to 886,
+                "/bad-sizes/" to -1,
+                "/bad-sizes/d/" to -1,
+                "/bad-sizes/0.txt" to 0,
+                "/bad-sizes/1.txt" to 1,
+                "/bad-sizes/2.txt" to 2,
+                "/bad-sizes/3.txt" to 3,
+                "/bad-sizes/4.txt" to 4,
+                "/bad-sizes/5.txt" to 5,
+                "/bad-sizes/6.txt" to 6,
+                "/bad-sizes/7.txt" to 7,
+            )
+        )
+    }
+
+    /** Tests with an empty ZIP archive. */
+    @Test
+    fun emptyZip() {
+        val uri = createDocument("application/zip", "archives/zip/empty.zip")
+        assertTreeIs(mutableMapOf("/empty.zip" to 22))
+
+        val job = createJob(uri)
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_CREATED)
+            assertThat(hasFailures).isFalse()
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+        }
+
+        job.run()
+        mJobListener.assertFinished()
+
+        with(job.getJobProgress()) {
+            assertThat(operationType).isEqualTo(OPERATION_UNPACK)
+            assertThat(id).isEqualTo(job.id)
+            assertThat(state).isEqualTo(Job.STATE_COMPLETED)
+            assertThat(hasFailures).isFalse()
+            assertThat(msg).isEqualTo("Extracting empty.zip to TEST_ROOT_0")
+            assertThat(currentBytes).isEqualTo(0)
+            assertThat(requiredBytes).isEqualTo(0)
+            assertThat(msRemaining).isLessThan(0)
+            assertThat(destination!!.peek().displayName).isEqualTo("empty")
+        }
+
+        with(job.getProgressNotification()) {
+            assertThat(category).isEqualTo(CATEGORY_PROGRESS)
+            with(extras) {
+                assertThat(getCharSequence(EXTRA_TITLE)).isEqualTo("Extracting files")
+                assertThat(getBoolean(EXTRA_PROGRESS_INDETERMINATE)).isTrue()
+            }
+        }
+
+        assertTreeIs(
+            mutableMapOf(
+                "/empty.zip" to 22,
+                "/empty/" to -1,
+            )
+        )
+    }
+
+    /** Tests the various system notifications with a partially encrypted ZIP archive. */
+    @Test
+    fun notifications() {
+        val uri = createDocument("application/zip", "archives/zip/different-encryptions.zip")
+        assertTreeIs(mutableMapOf("/different-encryptions.zip" to 1083))
+
+        val job = createJob(uri)
+
+        with(job.getSetupNotification()) {
+            assertThat(category).isEqualTo(CATEGORY_PROGRESS)
+            with(extras) {
+                assertThat(getCharSequence(EXTRA_TITLE)).isEqualTo("Extracting files")
+                assertThat(getCharSequence(EXTRA_TEXT)).isEqualTo("Preparing...")
+                assertThat(getBoolean(EXTRA_PROGRESS_INDETERMINATE)).isTrue()
+            }
+        }
+
+        job.run()
+        mJobListener.assertFailed()
+
+        with(job.getProgressNotification()) {
+            assertThat(category).isEqualTo(CATEGORY_PROGRESS)
+            with(extras) {
+                assertThat(getCharSequence(EXTRA_TITLE)).isEqualTo("Extracting files")
+                assertThat(getBoolean(EXTRA_PROGRESS_INDETERMINATE)).isFalse()
+            }
+        }
+
+        with(job.getFailureNotification()) {
+            assertThat(category).isEqualTo(CATEGORY_ERROR)
+            with(extras) {
+                assertThat(getCharSequence(EXTRA_TITLE)).isEqualTo("Couldnt copy 4 items")
+                assertThat(getCharSequence(EXTRA_TEXT)).isEqualTo("Tap to view details")
+            }
+        }
+    }
+
+    private fun createJob(src: Uri): UnpackJob {
+        val dest = buildDocumentUri(AUTHORITY, mSrcRoot.documentId)
+        return createJob(OPERATION_UNPACK, listOf(src), dest, dest)
+    }
+
+    private fun createDocument(mimeType: String, assetPath: String): Uri {
+        val uri = mDocs.createDocument(mSrcRoot, mimeType, File(assetPath).name)
+        getInstrumentation().context.getAssets().open(assetPath).use {
+            mDocs.writeDocument(uri, it)
+        }
+        return uri
+    }
+
+    private fun assertTreeIs(
+        wantSizes: MutableMap<String, Long>?,
+        parentPath: String,
+        info: DocumentInfo
+    ) {
+        var path = "${parentPath}${info.displayName}"
+        if (!info.isDirectory) {
+            if (wantSizes != null) {
+                val wantSize = wantSizes.remove(path)
+                assertWithMessage("For file '%s'", path).that(info.size).isEqualTo(wantSize)
+            } else {
+                Log.i(TAG, "\"$path\" to ${info.size},")
+            }
+            return
+        }
+
+        path += "/"
+        if (wantSizes != null) {
+            // This is a directory. We ignore the expected size specified in `wantSizes`.
+            // The only important thing is that the directory has an entry in `wantSizes`.
+            val wantSize = wantSizes.remove(path)
+            assertWithMessage("For dir '%s'", path).that(wantSize).isNotNull()
+        } else {
+            Log.i(TAG, "\"$path\" to -1,")
+        }
+
+        for (childInfo in mDocs.listChildren(info.documentId)) {
+            assertTreeIs(wantSizes, path, childInfo)
+        }
+    }
+
+    /**
+     * Recursively asserts that the document provider contains the specified files and directories,
+     * and that the contained files have the given sizes.
+     */
+    private fun assertTreeIs(wantSizes: MutableMap<String, Long>?) {
+        for (info in mDocs.listAllChildren(mSrcRoot)) {
+            assertTreeIs(wantSizes, "/", info)
+        }
+
+        if (wantSizes != null) assertThat(wantSizes).isEmpty()
+    }
+
+    companion object {
+        const val TAG = "UnpackJobTest"
+    }
+}
diff --git a/tests/unit/com/android/documentsui/AbstractActionHandlerTest.java b/tests/unit/com/android/documentsui/AbstractActionHandlerTest.java
index 104a8d789..78e5043c9 100644
--- a/tests/unit/com/android/documentsui/AbstractActionHandlerTest.java
+++ b/tests/unit/com/android/documentsui/AbstractActionHandlerTest.java
@@ -485,4 +485,18 @@ public class AbstractActionHandlerTest {
         } catch (UnsupportedOperationException expected) {
         }
     }
+
+    @Test
+    public void testJumpToDirectory() {
+        mEnv.populateStack();
+
+        DocumentStack stack = new DocumentStack(
+                TestProvidersAccess.HOME, TestEnv.FOLDER_1, TestEnv.FOLDER_2);
+        mHandler.jumpToDirectory(stack);
+
+        stack.pop();
+        mActivity.refreshCurrentRootAndDirectory.assertCalled();
+        DocumentStackAsserts.assertEqualsTo(mEnv.state.stack, TestProvidersAccess.HOME,
+                Arrays.asList(TestEnv.FOLDER_1, TestEnv.FOLDER_2));
+    }
 }
diff --git a/tests/unit/com/android/documentsui/DragAndDropManagerTests.java b/tests/unit/com/android/documentsui/DragAndDropManagerTests.java
index 27b4074fd..0ac8aa743 100644
--- a/tests/unit/com/android/documentsui/DragAndDropManagerTests.java
+++ b/tests/unit/com/android/documentsui/DragAndDropManagerTests.java
@@ -28,8 +28,6 @@ import android.graphics.drawable.Drawable;
 import android.os.PersistableBundle;
 import android.platform.test.annotations.RequiresFlagsDisabled;
 import android.platform.test.annotations.RequiresFlagsEnabled;
-import android.platform.test.flag.junit.CheckFlagsRule;
-import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 import android.util.Pair;
 import android.view.KeyEvent;
 import android.view.View;
@@ -42,6 +40,7 @@ import com.android.documentsui.DragAndDropManager.State;
 import com.android.documentsui.base.DocumentStack;
 import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.flags.Flags;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
 import com.android.documentsui.services.FileOperationService;
 import com.android.documentsui.services.FileOperations;
 import com.android.documentsui.testing.ClipDatas;
@@ -100,7 +99,7 @@ public class DragAndDropManagerTests {
     private DragAndDropManager mManager;
 
     @Rule
-    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
 
     @Before
     public void setUp() {
diff --git a/tests/unit/com/android/documentsui/GridEvenSpacingDecorationTest.java b/tests/unit/com/android/documentsui/GridEvenSpacingDecorationTest.java
new file mode 100644
index 000000000..4256610ed
--- /dev/null
+++ b/tests/unit/com/android/documentsui/GridEvenSpacingDecorationTest.java
@@ -0,0 +1,248 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui;
+
+import static com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3;
+
+import static junit.framework.Assert.assertEquals;
+
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.when;
+
+import android.graphics.Rect;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.view.View;
+import android.view.ViewGroup;
+
+import androidx.recyclerview.widget.GridLayoutManager;
+import androidx.recyclerview.widget.RecyclerView;
+
+import com.android.documentsui.dirlist.GridEvenSpacingDecoration;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
+import com.android.documentsui.testing.TestRecyclerView;
+
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+import org.mockito.Mock;
+import org.mockito.MockitoAnnotations;
+
+import java.util.ArrayList;
+
+@RequiresFlagsEnabled(FLAG_USE_MATERIAL3)
+public class GridEvenSpacingDecorationTest {
+    @Rule
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
+
+    private static final int ITEM_WIDTH = 100;
+    private static final int ITEM_HEIGHT = 100;
+    private static final int ITEM_COUNT = 3;
+    private TestRecyclerView mTestRecView;
+    @Mock
+    private GridLayoutManager mMockGridLayoutManager;
+    private GridEvenSpacingDecoration mGridEvenSpacingDecoration;
+    private ViewGroup.MarginLayoutParams mLayoutParamsForItem;
+    private ArrayList<View> mMockItems;
+
+    @Before
+    public void setUp() {
+        MockitoAnnotations.openMocks(this);
+
+        mTestRecView = TestRecyclerView.create(new ArrayList<>());
+        mTestRecView.setLayoutManager(mMockGridLayoutManager);
+
+        // All items have the same width.
+        mLayoutParamsForItem = new ViewGroup.MarginLayoutParams(ITEM_WIDTH, ITEM_HEIGHT);
+        mMockItems = new ArrayList<>();
+        for (int i = 0; i < ITEM_COUNT; i++) {
+            View mockItem = mock(View.class);
+            when(mockItem.getLayoutParams()).thenReturn(mLayoutParamsForItem);
+            mMockItems.add(mockItem);
+        }
+
+        mGridEvenSpacingDecoration = new GridEvenSpacingDecoration();
+    }
+
+    @Test
+    public void testPerfectFit_noRecViewPadding_noItemMargins() {
+        // ITEM_COUNT items per row.
+        when(mMockGridLayoutManager.getSpanCount()).thenReturn(ITEM_COUNT);
+
+        // Parent width fits the ITEM_COUNT items perfectly within one row.
+        mTestRecView.setMeasuredWithAndHeight(ITEM_WIDTH * ITEM_COUNT, ITEM_HEIGHT);
+
+        for (View mockItem : mMockItems) {
+            Rect rect = new Rect();
+            mGridEvenSpacingDecoration.getItemOffsets(rect, mockItem, mTestRecView,
+                    new RecyclerView.State());
+            // Offsets should be 0.
+            Rect expectedRect = new Rect();
+            assertEquals(expectedRect, rect);
+        }
+    }
+
+    @Test
+    public void testPerfectFit_recViewPadding_itemMargins() {
+        // ITEM_COUNT items per row.
+        when(mMockGridLayoutManager.getSpanCount()).thenReturn(ITEM_COUNT);
+
+        int leftMargin = 1;
+        int rightMargin = 2;
+        int itemWidthWithMargins = leftMargin + ITEM_WIDTH + rightMargin;
+        mLayoutParamsForItem.setMargins(leftMargin, 0, rightMargin, 0);
+
+        // Parent width fits the ITEM_COUNT items perfectly within one row (between the padding).
+        int leftPad = 10;
+        int rightPad = 5;
+        mTestRecView.setPadding(leftPad, 0, rightPad, 0);
+        mTestRecView.setMeasuredWithAndHeight(
+                leftPad + itemWidthWithMargins * ITEM_COUNT + rightPad, ITEM_HEIGHT);
+
+        for (View mockItem : mMockItems) {
+            Rect rect = new Rect();
+            mGridEvenSpacingDecoration.getItemOffsets(rect, mockItem, mTestRecView,
+                    new RecyclerView.State());
+            // Offsets should be 0.
+            Rect expectedRect = new Rect();
+            assertEquals(expectedRect, rect);
+        }
+    }
+
+    @Test
+    public void testExtraSpace_SpaceLessThanOneItem() {
+        // ITEM_COUNT items per row.
+        when(mMockGridLayoutManager.getSpanCount()).thenReturn(ITEM_COUNT);
+
+        int leftMargin = 1;
+        int rightMargin = 2;
+        int itemWidthWithMargins = leftMargin + ITEM_WIDTH + rightMargin;
+        mLayoutParamsForItem.setMargins(leftMargin, 0, rightMargin, 0);
+
+        // Parent width fits almost ITEM_COUNT+1 items (12 pixels too narrow).
+        int leftPad = 10;
+        int rightPad = 5;
+        mTestRecView.setPadding(leftPad, 0, rightPad, 0);
+        int spaceForItems = itemWidthWithMargins * (ITEM_COUNT + 1) - 12;
+        mTestRecView.setMeasuredWithAndHeight(leftPad + spaceForItems + rightPad, ITEM_HEIGHT);
+
+        // The space is divided into "span count" number of equal size buckets. The items will be
+        // centred within their buckets.
+        int spaceForItem = spaceForItems / ITEM_COUNT;
+        int offset = (spaceForItem - itemWidthWithMargins) / 2;
+
+        for (View mockItem : mMockItems) {
+            Rect rect = new Rect();
+            mGridEvenSpacingDecoration.getItemOffsets(rect, mockItem, mTestRecView,
+                    new RecyclerView.State());
+            Rect expectedRect = new Rect(offset, 0, offset, 0);
+            assertEquals(expectedRect, rect);
+        }
+    }
+
+    @Test
+    public void testExtraSpace_SpaceMoreThanOneItem() {
+        // ITEM_COUNT+1 items per row.
+        int spanCount = ITEM_COUNT + 1;
+        when(mMockGridLayoutManager.getSpanCount()).thenReturn(spanCount);
+
+        int leftMargin = 1;
+        int rightMargin = 2;
+        int itemWidthWithMargins = leftMargin + ITEM_WIDTH + rightMargin;
+        mLayoutParamsForItem.setMargins(leftMargin, 0, rightMargin, 0);
+
+        // Parent width fits almost ITEM_COUNT+1 items (12 pixels extra).
+        int leftPad = 10;
+        int rightPad = 5;
+        mTestRecView.setPadding(leftPad, 0, rightPad, 0);
+        int spaceForItems = itemWidthWithMargins * (ITEM_COUNT + 1) + 12;
+        mTestRecView.setMeasuredWithAndHeight(leftPad + spaceForItems + rightPad, ITEM_HEIGHT);
+
+        // The space is divided into "span count" number of equal size buckets. The items will be
+        // centred within their buckets.
+        int spaceForItem = spaceForItems / spanCount;
+        int offset = (spaceForItem - itemWidthWithMargins) / 2;
+
+        for (View mockItem : mMockItems) {
+            Rect rect = new Rect();
+            mGridEvenSpacingDecoration.getItemOffsets(rect, mockItem, mTestRecView,
+                    new RecyclerView.State());
+            Rect expectedRect = new Rect(offset, 0, offset, 0);
+            assertEquals(expectedRect, rect);
+        }
+    }
+
+    @Test
+    public void perfectFit_testMultipleRows() {
+        // ITEM_COUNT-1 items per row.
+        int spanCount = ITEM_COUNT - 1;
+        when(mMockGridLayoutManager.getSpanCount()).thenReturn(spanCount);
+
+        int leftMargin = 1;
+        int rightMargin = 2;
+        int itemWidthWithMargins = leftMargin + ITEM_WIDTH + rightMargin;
+        mLayoutParamsForItem.setMargins(leftMargin, 0, rightMargin, 0);
+
+        // Parent width fits ITEM_COUNT-1 items perfectly.
+        int leftPad = 10;
+        int rightPad = 5;
+        mTestRecView.setPadding(leftPad, 0, rightPad, 0);
+        int spaceForItems = itemWidthWithMargins * spanCount;
+        mTestRecView.setMeasuredWithAndHeight(leftPad + spaceForItems + rightPad, ITEM_HEIGHT * 2);
+
+        for (View mockItem : mMockItems) {
+            Rect rect = new Rect();
+            mGridEvenSpacingDecoration.getItemOffsets(rect, mockItem, mTestRecView,
+                    new RecyclerView.State());
+            Rect expectedRect = new Rect();
+            // Offsets should be 0 even for the item on the second row since the bucket size is
+            // exactly itemWidthWithMargins.
+            assertEquals(expectedRect, rect);
+        }
+    }
+
+    @Test
+    public void testExtraSpace_testMultipleRows() {
+        // ITEM_COUNT-1 items per row.
+        int spanCount = ITEM_COUNT - 1;
+        when(mMockGridLayoutManager.getSpanCount()).thenReturn(spanCount);
+
+        int leftMargin = 1;
+        int rightMargin = 2;
+        int itemWidthWithMargins = leftMargin + ITEM_WIDTH + rightMargin;
+        mLayoutParamsForItem.setMargins(leftMargin, 0, rightMargin, 0);
+
+        // Parent width fits almost ITEM_COUNT+1 items (12 pixels extra).
+        int leftPad = 10;
+        int rightPad = 5;
+        mTestRecView.setPadding(leftPad, 0, rightPad, 0);
+        int spaceForItems = itemWidthWithMargins * (ITEM_COUNT + 1) + 12;
+        mTestRecView.setMeasuredWithAndHeight(leftPad + spaceForItems + rightPad, ITEM_HEIGHT * 2);
+
+
+        // The space is divided into "span count" number of equal size buckets. The items will be
+        // centred within their buckets.
+        int spaceForItem = spaceForItems / spanCount;
+        int offset = (spaceForItem - itemWidthWithMargins) / 2;
+
+        for (View mockItem : mMockItems) {
+            Rect rect = new Rect();
+            mGridEvenSpacingDecoration.getItemOffsets(rect, mockItem, mTestRecView,
+                    new RecyclerView.State());
+            Rect expectedRect = new Rect(offset, 0, offset, 0);
+            assertEquals(expectedRect, rect);
+        }
+    }
+}
diff --git a/tests/unit/com/android/documentsui/JobPanelControllerTest.kt b/tests/unit/com/android/documentsui/JobPanelControllerTest.kt
index 3e510edd9..14fcf3299 100644
--- a/tests/unit/com/android/documentsui/JobPanelControllerTest.kt
+++ b/tests/unit/com/android/documentsui/JobPanelControllerTest.kt
@@ -17,23 +17,28 @@ package com.android.documentsui
 
 import android.content.Intent
 import android.platform.test.annotations.RequiresFlagsEnabled
-import android.platform.test.flag.junit.CheckFlagsRule
-import android.platform.test.flag.junit.DeviceFlagsValueProvider
+import android.view.MenuItem
 import android.widget.ActionMenuView
+import android.widget.FrameLayout
+import android.widget.ImageView
 import android.widget.ProgressBar
 import androidx.test.ext.junit.runners.AndroidJUnit4
 import androidx.test.filters.SmallTest
 import androidx.test.platform.app.InstrumentationRegistry
 import com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3
 import com.android.documentsui.flags.Flags.FLAG_VISUAL_SIGNALS_RO
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import com.android.documentsui.services.FileOperationService
 import com.android.documentsui.services.FileOperationService.ACTION_PROGRESS
 import com.android.documentsui.services.FileOperationService.EXTRA_PROGRESS
 import com.android.documentsui.services.Job
 import com.android.documentsui.services.JobProgress
 import com.android.documentsui.testing.MutableJobProgress
-import junit.framework.Assert.assertEquals
-import junit.framework.Assert.assertFalse
-import junit.framework.Assert.assertTrue
+import com.android.documentsui.testing.TestActionHandler
+import com.android.documentsui.util.Material3Config.Companion.getRes
+import org.junit.Assert.assertEquals
+import org.junit.Assert.assertFalse
+import org.junit.Assert.assertTrue
 import org.junit.Before
 import org.junit.Rule
 import org.junit.Test
@@ -44,45 +49,59 @@ import org.junit.runner.RunWith
 @RunWith(AndroidJUnit4::class)
 class JobPanelControllerTest {
     @get:Rule
-    val mCheckFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
-
-    private val mContext = InstrumentationRegistry.getInstrumentation().targetContext
-
-    // The default progress bar only has an indeterminate state, so we need to style it to allow
-    // determinate progress.
-    private val mProgressBar = ProgressBar(
-        mContext,
-        null,
-        android.R.attr.progressBarStyleHorizontal
-    )
-    private val mMenuItem = ActionMenuView(mContext).menu.add("job_panel").apply {
-        actionView = mProgressBar
-    }
-    private lateinit var mController: JobPanelController
-    private var mLastId = 0L
+    val checkFlags = CheckAndForceMaterial3Flag()
+
+    private val context = InstrumentationRegistry.getInstrumentation().targetContext
+
+    private lateinit var progressBar: ProgressBar
+    private lateinit var badge: ImageView
+    private lateinit var menuItem: MenuItem
 
-    private fun sendProgress(progress: ArrayList<JobProgress>, id: Long = mLastId++) {
+    private lateinit var controller: JobPanelController
+    private var lastId = 0L
+
+    private fun sendProgress(progress: ArrayList<JobProgress>, id: Long = lastId++) {
         var intent = Intent(ACTION_PROGRESS).apply {
-            `package` = mContext.packageName
+            `package` = context.packageName
             putExtra("id", id)
             putParcelableArrayListExtra(EXTRA_PROGRESS, progress)
         }
-        mController.onReceive(mContext, intent)
+        controller.onReceive(context, intent)
     }
 
     @Before
     fun setUp() {
-        mController = JobPanelController(mContext)
-        mController.setMenuItem(mMenuItem)
+        // The default progress bar only has an indeterminate state, so we need to style it to allow
+        // determinate progress.
+        progressBar = ProgressBar(
+            context,
+            null,
+            android.R.attr.progressBarStyleHorizontal
+        ).apply {
+            id = getRes(R.id.job_progress_toolbar_indicator)
+        }
+        badge = ImageView(context).apply {
+            id = getRes(R.id.job_progress_toolbar_badge)
+        }
+        menuItem = ActionMenuView(context).menu.add("job_panel").apply {
+            actionView = FrameLayout(context).apply {
+                addView(progressBar)
+                addView(badge)
+            }
+        }
+
+        controller = JobPanelController(context, TestActionHandler(), JobPanelViewModel())
+        controller.setMenuItem(menuItem)
     }
 
     @Test
     fun testSingleJob() {
-        assertFalse(mMenuItem.isVisible())
-        assertFalse(mMenuItem.isEnabled())
+        assertFalse(menuItem.isVisible())
+        assertFalse(menuItem.isEnabled())
 
         val progress = MutableJobProgress(
             id = "jobId1",
+            operationType = FileOperationService.OPERATION_COPY,
             state = Job.STATE_STARTED,
             msg = "Job started",
             hasFailures = false,
@@ -92,9 +111,9 @@ class JobPanelControllerTest {
         )
         sendProgress(arrayListOf(progress.toJobProgress()))
 
-        assertTrue(mMenuItem.isVisible())
-        assertTrue(mMenuItem.isEnabled())
-        assertEquals(0, mProgressBar.progress)
+        assertTrue(menuItem.isVisible())
+        assertTrue(menuItem.isEnabled())
+        assertEquals(0, progressBar.progress)
 
         progress.apply {
             state = Job.STATE_SET_UP
@@ -103,9 +122,9 @@ class JobPanelControllerTest {
         }
         sendProgress(arrayListOf(progress.toJobProgress()))
 
-        assertTrue(mMenuItem.isVisible())
-        assertTrue(mMenuItem.isEnabled())
-        assertEquals(40, mProgressBar.progress)
+        assertTrue(menuItem.isVisible())
+        assertTrue(menuItem.isEnabled())
+        assertEquals(40, progressBar.progress)
 
         progress.apply {
             state = Job.STATE_COMPLETED
@@ -114,18 +133,19 @@ class JobPanelControllerTest {
         }
         sendProgress(arrayListOf(progress.toJobProgress()))
 
-        assertTrue(mMenuItem.isVisible())
-        assertTrue(mMenuItem.isEnabled())
-        assertEquals(100, mProgressBar.progress)
+        assertTrue(menuItem.isVisible())
+        assertTrue(menuItem.isEnabled())
+        assertEquals(100, progressBar.progress)
     }
 
     @Test
     fun testMultipleJobs() {
-        assertFalse(mMenuItem.isVisible())
-        assertFalse(mMenuItem.isEnabled())
+        assertFalse(menuItem.isVisible())
+        assertFalse(menuItem.isEnabled())
 
         val progress1 = MutableJobProgress(
             id = "jobId1",
+            operationType = FileOperationService.OPERATION_MOVE,
             state = Job.STATE_STARTED,
             msg = "Job started",
             hasFailures = false,
@@ -135,18 +155,19 @@ class JobPanelControllerTest {
         )
         val progress2 = MutableJobProgress(
             id = "jobId2",
+            operationType = FileOperationService.OPERATION_DELETE,
             state = Job.STATE_STARTED,
             msg = "Job started",
             hasFailures = false,
             currentBytes = 0,
-            requiredBytes = 40,
+            requiredBytes = 50,
             msRemaining = -1
         )
         sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
 
-        assertTrue(mMenuItem.isVisible())
-        assertTrue(mMenuItem.isEnabled())
-        assertEquals(0, mProgressBar.progress)
+        assertTrue(menuItem.isVisible())
+        assertTrue(menuItem.isEnabled())
+        assertEquals(0, progressBar.progress)
 
         progress1.apply {
             state = Job.STATE_SET_UP
@@ -155,9 +176,9 @@ class JobPanelControllerTest {
         }
         sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
 
-        assertTrue(mMenuItem.isVisible())
-        assertTrue(mMenuItem.isEnabled())
-        assertEquals(8, mProgressBar.progress)
+        assertTrue(menuItem.isVisible())
+        assertTrue(menuItem.isEnabled())
+        assertEquals(20, progressBar.progress)
 
         progress1.apply {
             state = Job.STATE_COMPLETED
@@ -166,9 +187,9 @@ class JobPanelControllerTest {
         }
         sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
 
-        assertTrue(mMenuItem.isVisible())
-        assertTrue(mMenuItem.isEnabled())
-        assertEquals(20, mProgressBar.progress)
+        assertTrue(menuItem.isVisible())
+        assertTrue(menuItem.isEnabled())
+        assertEquals(50, progressBar.progress)
 
         progress2.apply {
             state = Job.STATE_SET_UP
@@ -177,9 +198,9 @@ class JobPanelControllerTest {
         }
         sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
 
-        assertTrue(mMenuItem.isVisible())
-        assertTrue(mMenuItem.isEnabled())
-        assertEquals(80, mProgressBar.progress)
+        assertTrue(menuItem.isVisible())
+        assertTrue(menuItem.isEnabled())
+        assertEquals(80, progressBar.progress)
 
         progress2.apply {
             state = Job.STATE_COMPLETED
@@ -188,8 +209,42 @@ class JobPanelControllerTest {
         }
         sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
 
-        assertTrue(mMenuItem.isVisible())
-        assertTrue(mMenuItem.isEnabled())
-        assertEquals(100, mProgressBar.progress)
+        assertTrue(menuItem.isVisible())
+        assertTrue(menuItem.isEnabled())
+        assertEquals(100, progressBar.progress)
+    }
+
+    @Test
+    fun testIndeterminateJobs() {
+        val indeterminate = MutableJobProgress(
+            id = "indeterminate",
+            operationType = FileOperationService.OPERATION_MOVE,
+            state = Job.STATE_SET_UP,
+            msg = "Job started",
+            hasFailures = false,
+            currentBytes = -1,
+            requiredBytes = -1,
+            msRemaining = -1
+        )
+        val determinate = MutableJobProgress(
+            id = "determinate",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_SET_UP,
+            msg = "Job started",
+            hasFailures = false,
+            currentBytes = 40,
+            requiredBytes = 100,
+            msRemaining = -1
+        )
+        sendProgress(arrayListOf(indeterminate.toJobProgress()))
+
+        assertTrue(menuItem.isVisible())
+        assertTrue(progressBar.isIndeterminate)
+
+        sendProgress(arrayListOf(indeterminate.toJobProgress(), determinate.toJobProgress()))
+
+        assertTrue(menuItem.isVisible())
+        assertFalse(progressBar.isIndeterminate)
+        assertEquals(20, progressBar.progress)
     }
 }
diff --git a/tests/unit/com/android/documentsui/JobPanelViewModelTest.kt b/tests/unit/com/android/documentsui/JobPanelViewModelTest.kt
new file mode 100644
index 000000000..437936fdf
--- /dev/null
+++ b/tests/unit/com/android/documentsui/JobPanelViewModelTest.kt
@@ -0,0 +1,232 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui
+
+import android.platform.test.annotations.RequiresFlagsEnabled
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import androidx.test.filters.SmallTest
+import com.android.documentsui.JobPanelViewModel.MenuIconState
+import com.android.documentsui.JobPanelViewModel.ProgressViewModel
+import com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3
+import com.android.documentsui.flags.Flags.FLAG_VISUAL_SIGNALS_RO
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import com.android.documentsui.services.FileOperationService
+import com.android.documentsui.services.Job
+import com.android.documentsui.testing.MutableJobProgress
+import kotlin.collections.emptyList
+import org.junit.Assert.assertEquals
+import org.junit.Assert.assertTrue
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+
+private fun List<MutableJobProgress>.toJobProgressList() = map { item -> item.toJobProgress() }
+
+private fun List<MutableJobProgress>.withExpandStates(vararg expandStates: Boolean):
+        List<ProgressViewModel> =
+    toJobProgressList().zip(expandStates.asList(), ::ProgressViewModel)
+
+@SmallTest
+@RequiresFlagsEnabled(FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO)
+@RunWith(AndroidJUnit4::class)
+class JobPanelViewModelTest {
+    @get:Rule
+    val checkFlags = CheckAndForceMaterial3Flag()
+
+    @Test
+    fun testListModifications() {
+        val viewModel = JobPanelViewModel()
+
+        val progress1 = MutableJobProgress(
+            id = "Job1",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_CREATED,
+            msg = "Job1",
+            hasFailures = false,
+        )
+        val progress2 = MutableJobProgress(
+            id = "Job2",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_CREATED,
+            msg = "Job2",
+            hasFailures = false,
+        )
+
+        viewModel.updateProgress(listOf(progress1, progress2).toJobProgressList())
+        assertEquals(
+            listOf(progress1, progress2)
+                .withExpandStates(false, false),
+            ArrayList(viewModel.currentJobs.values)
+        )
+
+        val progress3 = MutableJobProgress(
+            id = "Job3",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_STARTED,
+            msg = "Job3",
+            hasFailures = false,
+        )
+
+        val progress4 = MutableJobProgress(
+            id = "Job4",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_SET_UP,
+            msg = "Job4",
+            hasFailures = false,
+            currentBytes = 50,
+            requiredBytes = 100,
+            msRemaining = 4000
+        )
+
+        viewModel.toggleExpanded("Job2")
+        viewModel
+            .updateProgress(listOf(progress1, progress2, progress3, progress4).toJobProgressList())
+        assertEquals(
+            listOf(progress1, progress2, progress3, progress4)
+                .withExpandStates(false, true, false, false),
+            ArrayList(viewModel.currentJobs.values)
+        )
+
+        progress1.state = Job.STATE_COMPLETED
+        progress2.state = Job.STATE_COMPLETED
+        progress2.hasFailures = true
+
+        viewModel.updateProgress(listOf(progress1, progress2, progress4).toJobProgressList())
+        assertEquals(
+            listOf(progress1, progress2, progress4)
+                .withExpandStates(false, true, false),
+            ArrayList(viewModel.currentJobs.values)
+        )
+
+        progress4.state = Job.STATE_CANCELED
+        viewModel.updateProgress(listOf(progress4).toJobProgressList())
+        // Progresses 1 and 2 should be kept as they are in the completed state.
+        assertEquals(
+            listOf(progress1, progress2)
+                .withExpandStates(false, true),
+            ArrayList(viewModel.currentJobs.values)
+        )
+
+        viewModel.updateProgress(emptyList())
+        assertEquals(
+            listOf(progress1, progress2)
+                .withExpandStates(false, true),
+            ArrayList(viewModel.currentJobs.values)
+        )
+
+        viewModel.dismissProgress("Job1")
+        assertEquals(
+            listOf(progress2).withExpandStates(true),
+            ArrayList(viewModel.currentJobs.values)
+        )
+    }
+
+    @Test
+    fun testDismissNonExistentItem() {
+        val viewModel = JobPanelViewModel()
+
+        viewModel.dismissProgress("Job1")
+        assertTrue(viewModel.currentJobs.isEmpty())
+
+        val progress1 = MutableJobProgress(
+            id = "Job1",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_CREATED,
+            msg = "Job1",
+            hasFailures = false,
+        )
+
+        viewModel.updateProgress(listOf(progress1).toJobProgressList())
+        viewModel.dismissProgress("Job2")
+        assertEquals(
+            listOf(progress1).withExpandStates(false),
+            ArrayList(viewModel.currentJobs.values)
+        )
+    }
+
+    @Test
+    fun testExpandNonExistentItem() {
+        val viewModel = JobPanelViewModel()
+
+        viewModel.toggleExpanded("Job1")
+        assertTrue(viewModel.currentJobs.isEmpty())
+
+        val progress1 = MutableJobProgress(
+            id = "Job1",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_CREATED,
+            msg = "Job1",
+            hasFailures = false,
+        )
+
+        viewModel.updateProgress(listOf(progress1).toJobProgressList())
+        viewModel.toggleExpanded("Job2")
+        assertEquals(
+            listOf(progress1).withExpandStates(false),
+            ArrayList(viewModel.currentJobs.values)
+        )
+    }
+
+    @Test
+    fun testHasFailures() {
+        val viewModel = JobPanelViewModel()
+
+        val inProgress = MutableJobProgress(
+            id = "in_progress_job",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_SET_UP,
+            msg = "Job in progress",
+            hasFailures = false,
+            currentBytes = 40,
+            requiredBytes = 100,
+        )
+
+        val failed = MutableJobProgress(
+            id = "failed_job",
+            operationType = FileOperationService.OPERATION_COPY,
+            state = Job.STATE_COMPLETED,
+            msg = "Job failed",
+            hasFailures = true,
+        )
+
+        assertEquals(MenuIconState.INVISIBLE, viewModel.getMenuState())
+
+        viewModel.updateProgress(listOf(failed).toJobProgressList())
+        assertEquals(
+            MenuIconState.VISIBLE(totalProgress = 100, hasFailures = true),
+            viewModel.getMenuState()
+        )
+
+        viewModel.updateProgress(listOf(inProgress).toJobProgressList())
+        assertEquals(
+            MenuIconState.VISIBLE(totalProgress = 70, hasFailures = true),
+            viewModel.getMenuState()
+        )
+
+        viewModel.dismissProgress(failed.id)
+        assertEquals(
+            MenuIconState.VISIBLE(totalProgress = 40, hasFailures = false),
+            viewModel.getMenuState()
+        )
+
+        inProgress.hasFailures = true
+        viewModel.updateProgress(listOf(inProgress).toJobProgressList())
+        assertEquals(
+            MenuIconState.VISIBLE(totalProgress = 40, hasFailures = true),
+            viewModel.getMenuState()
+        )
+    }
+}
diff --git a/tests/unit/com/android/documentsui/base/DocumentInfoTest.java b/tests/unit/com/android/documentsui/base/DocumentInfoTest.java
index 4e73333d8..c5034fa75 100644
--- a/tests/unit/com/android/documentsui/base/DocumentInfoTest.java
+++ b/tests/unit/com/android/documentsui/base/DocumentInfoTest.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.base;
 
+import static android.provider.DocumentsContract.Document.MIME_TYPE_DIR;
+
 import static androidx.core.util.Preconditions.checkArgument;
 
 import static com.google.common.truth.Truth.assertThat;
@@ -33,6 +35,7 @@ import androidx.test.filters.SmallTest;
 import androidx.test.rule.provider.ProviderTestRule;
 
 import com.android.documentsui.InspectorProvider;
+import com.android.documentsui.archives.ArchivesProvider;
 import com.android.documentsui.testing.TestProvidersAccess;
 import com.android.documentsui.util.VersionUtils;
 
@@ -134,7 +137,7 @@ public class DocumentInfoTest extends AndroidTestCase {
 
         assertThat(mimeTypes.size()).isEqualTo(1);
 
-        assertThat(mimeTypes.contains(DocumentsContract.Document.MIME_TYPE_DIR)).isTrue();
+        assertThat(mimeTypes.contains(MIME_TYPE_DIR)).isTrue();
     }
 
     @Test
@@ -202,4 +205,59 @@ public class DocumentInfoTest extends AndroidTestCase {
                     .isEqualTo(otherUserDoc.getDocumentUri().getUserInfo());
         }
     }
+
+    @Test
+    public void testTextFile() throws Exception {
+        final DocumentInfo doc = createDocInfo("authority.a", "doc.1", "text/plain");
+        assertThat(doc.isArchive()).isFalse();
+        assertThat(doc.isContainer()).isFalse();
+        assertThat(doc.isDirectory()).isFalse();
+        assertThat(doc.isInArchive()).isFalse();
+    }
+
+    @Test
+    public void testDirectory() throws Exception {
+        final DocumentInfo doc = createDocInfo("authority.a", "doc.1", MIME_TYPE_DIR);
+        assertThat(doc.isArchive()).isFalse();
+        assertThat(doc.isContainer()).isTrue();
+        assertThat(doc.isDirectory()).isTrue();
+        assertThat(doc.isInArchive()).isFalse();
+    }
+
+    @Test
+    public void testArchive() throws Exception {
+        final DocumentInfo doc = createDocInfo("authority.a", "doc.1", "application/zip");
+        assertThat(doc.isArchive()).isTrue();
+        assertThat(doc.isContainer()).isTrue();
+        assertThat(doc.isDirectory()).isFalse();
+        assertThat(doc.isInArchive()).isFalse();
+    }
+
+    @Test
+    public void testTextFileInArchive() throws Exception {
+        final DocumentInfo doc = createDocInfo(ArchivesProvider.AUTHORITY, "doc.1", "text/plain");
+        assertThat(doc.isArchive()).isFalse();
+        assertThat(doc.isContainer()).isFalse();
+        assertThat(doc.isDirectory()).isFalse();
+        assertThat(doc.isInArchive()).isTrue();
+    }
+
+    @Test
+    public void testDirectoryInArchive() throws Exception {
+        final DocumentInfo doc = createDocInfo(ArchivesProvider.AUTHORITY, "doc.1", MIME_TYPE_DIR);
+        assertThat(doc.isArchive()).isFalse();
+        assertThat(doc.isContainer()).isTrue();
+        assertThat(doc.isDirectory()).isTrue();
+        assertThat(doc.isInArchive()).isTrue();
+    }
+
+    @Test
+    public void testArchiveInArchive() throws Exception {
+        final DocumentInfo doc = createDocInfo(ArchivesProvider.AUTHORITY, "doc.1",
+                "application/zip");
+        assertThat(doc.isArchive()).isTrue();
+        assertThat(doc.isContainer()).isFalse();
+        assertThat(doc.isDirectory()).isFalse();
+        assertThat(doc.isInArchive()).isTrue();
+    }
 }
diff --git a/tests/unit/com/android/documentsui/dirlist/AccessibilityTest.java b/tests/unit/com/android/documentsui/dirlist/AccessibilityTest.java
index 09b193344..818ab6595 100644
--- a/tests/unit/com/android/documentsui/dirlist/AccessibilityTest.java
+++ b/tests/unit/com/android/documentsui/dirlist/AccessibilityTest.java
@@ -16,24 +16,47 @@
 
 package com.android.documentsui.dirlist;
 
+import static org.junit.Assert.assertEquals;
+import static org.junit.Assert.assertFalse;
+import static org.junit.Assert.assertNotNull;
+import static org.junit.Assert.assertTrue;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.when;
+
 import android.database.Cursor;
-import android.test.AndroidTestCase;
+import android.platform.test.annotations.RequiresFlagsEnabled;
 import android.view.View;
 import android.widget.Space;
 
 import androidx.core.view.accessibility.AccessibilityNodeInfoCompat;
+import androidx.core.view.accessibility.AccessibilityNodeInfoCompat.AccessibilityActionCompat;
+import androidx.recyclerview.widget.LinearLayoutManager;
 import androidx.recyclerview.widget.RecyclerView;
+import androidx.test.ext.junit.runners.AndroidJUnit4;
 import androidx.test.filters.SmallTest;
 
+import com.android.documentsui.R;
 import com.android.documentsui.TestConfigStore;
+import com.android.documentsui.base.State;
+import com.android.documentsui.flags.Flags;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
 import com.android.documentsui.testing.TestRecyclerView;
 import com.android.documentsui.testing.Views;
 
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+
 import java.util.ArrayList;
 import java.util.List;
 
+@RunWith(AndroidJUnit4.class)
 @SmallTest
-public class AccessibilityTest extends AndroidTestCase {
+public class AccessibilityTest {
+
+    @Rule
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
 
     private static final List<String> ITEMS = TestData.create(10);
 
@@ -42,28 +65,35 @@ public class AccessibilityTest extends AndroidTestCase {
     private boolean mClickCallbackCalled = false;
     private boolean mLongClickCallbackCalled = false;
 
-    @Override
-    public void setUp() throws Exception {
-        mView = TestRecyclerView.create(ITEMS);
+    private void initAccessibilityDelegate(@State.ActionType int actionType) {
         mAccessibilityDelegate = new AccessibilityEventRouter(mView, (View v) -> {
             mClickCallbackCalled = true;
             return true;
         }, (View v) -> {
             mLongClickCallbackCalled = true;
             return true;
-        });
+        }, actionType);
         mView.setAccessibilityDelegateCompat(mAccessibilityDelegate);
     }
 
+    @Before
+    public void setUp() throws Exception {
+        mView = TestRecyclerView.create(ITEMS);
+        mView.setLayoutManager(new LinearLayoutManager(mView.getContext()));
+        initAccessibilityDelegate(State.ACTION_BROWSE);
+    }
+
+    @Test
     public void test_announceSelected() throws Exception {
-        View item = Views.createTestView(true);
+        View item = Views.createTestView(/* activated= */ true);
         AccessibilityNodeInfoCompat info = AccessibilityNodeInfoCompat.obtain();
         mAccessibilityDelegate.getItemDelegate().onInitializeAccessibilityNodeInfo(item, info);
         assertTrue(info.isSelected());
     }
 
+    @Test
     public void testNullItemDetails_NoActionClick_PrivateSpaceEnabled() throws Exception {
-        View item = Views.createTestView(true);
+        View item = Views.createTestView(/* activated= */ true);
         AccessibilityNodeInfoCompat info = AccessibilityNodeInfoCompat.obtain();
 
         List<RecyclerView.ViewHolder> holders = new ArrayList<>();
@@ -83,8 +113,9 @@ public class AccessibilityTest extends AndroidTestCase {
         assertFalse(info.isClickable());
     }
 
+    @Test
     public void testNullItemDetails_NoActionClick_PrivateSpaceDisabled() throws Exception {
-        View item = Views.createTestView(true);
+        View item = Views.createTestView(/* activated= */ true);
         AccessibilityNodeInfoCompat info = AccessibilityNodeInfoCompat.obtain();
 
         List<RecyclerView.ViewHolder> holders = new ArrayList<>();
@@ -104,8 +135,9 @@ public class AccessibilityTest extends AndroidTestCase {
         assertFalse(info.isClickable());
     }
 
+    @Test
     public void test_routesAccessibilityClicks() throws Exception {
-        View item = Views.createTestView(true);
+        View item = Views.createTestView(/* activated= */ true);
         AccessibilityNodeInfoCompat info = AccessibilityNodeInfoCompat.obtain();
         mAccessibilityDelegate.getItemDelegate().onInitializeAccessibilityNodeInfo(item, info);
         mAccessibilityDelegate.getItemDelegate().performAccessibilityAction(
@@ -113,12 +145,119 @@ public class AccessibilityTest extends AndroidTestCase {
         assertTrue(mClickCallbackCalled);
     }
 
+    @Test
     public void test_routesAccessibilityLongClicks() throws Exception {
-        View item = Views.createTestView(true);
+        View item = Views.createTestView(/* activated= */ true);
         AccessibilityNodeInfoCompat info = AccessibilityNodeInfoCompat.obtain();
         mAccessibilityDelegate.getItemDelegate().onInitializeAccessibilityNodeInfo(item, info);
         mAccessibilityDelegate.getItemDelegate().performAccessibilityAction(
                 item, AccessibilityNodeInfoCompat.ACTION_LONG_CLICK, null);
         assertTrue(mLongClickCallbackCalled);
     }
+
+    @Test
+    public void test_accessibilityActions_DocumentHolder() throws Exception {
+        View item = Views.createTestView(/* activated= */ false);
+
+        AccessibilityNodeInfoCompat info = AccessibilityNodeInfoCompat.obtain();
+        addMockDocumentHolder();
+        mAccessibilityDelegate.getItemDelegate().onInitializeAccessibilityNodeInfo(item, info);
+
+        List<AccessibilityActionCompat> actions = getAccessibilityActions(info);
+        assertEquals(2, actions.size());
+    }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void test_accessibilityActionDescription_DocumentHolder() throws Exception {
+        View item = Views.createTestView(/* activated= */ false);
+
+        AccessibilityNodeInfoCompat info = AccessibilityNodeInfoCompat.obtain();
+        addMockDocumentHolder();
+        mAccessibilityDelegate.getItemDelegate().onInitializeAccessibilityNodeInfo(item, info);
+
+        List<AccessibilityActionCompat> actions = getAccessibilityActions(info);
+        assertEquals(mView.getContext().getString(R.string.document_click_action),
+                actions.get(0).getLabel().toString());
+        assertEquals(mView.getContext().getString(R.string.document_long_click_action),
+                actions.get(1).getLabel().toString());
+    }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void test_accessibilityActionDescription_DocumentHolder_Selected() throws Exception {
+        View item = Views.createTestView(/* activated= */ true);
+
+        AccessibilityNodeInfoCompat info = AccessibilityNodeInfoCompat.obtain();
+        addMockDocumentHolder();
+        mAccessibilityDelegate.getItemDelegate().onInitializeAccessibilityNodeInfo(item, info);
+
+        List<AccessibilityActionCompat> actions = getAccessibilityActions(info);
+        assertEquals(mView.getContext().getString(R.string.selected_document_click_action),
+                actions.get(0).getLabel().toString());
+        assertEquals(mView.getContext().getString(R.string.selected_document_long_click_action),
+                actions.get(1).getLabel().toString());
+
+    }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void test_accessibilityActionDescription_DocumentHolder_Picker() throws Exception {
+        initAccessibilityDelegate(State.ACTION_GET_CONTENT);
+        View item = Views.createTestView(/* activated= */ false);
+
+        AccessibilityNodeInfoCompat info = AccessibilityNodeInfoCompat.obtain();
+        addMockDocumentHolder();
+        mAccessibilityDelegate.getItemDelegate().onInitializeAccessibilityNodeInfo(item, info);
+
+        List<AccessibilityActionCompat> actions = getAccessibilityActions(info);
+        assertEquals(mView.getContext().getString(R.string.document_long_click_action),
+                actions.get(0).getLabel().toString());
+        assertEquals(mView.getContext().getString(R.string.document_long_click_action_picker),
+                actions.get(1).getLabel().toString());
+    }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void test_accessibilityActionDescription_DocumentHolder_Selected_Picker()
+            throws Exception {
+        initAccessibilityDelegate(State.ACTION_GET_CONTENT);
+        View item = Views.createTestView(/* activated= */ true);
+
+        AccessibilityNodeInfoCompat info = AccessibilityNodeInfoCompat.obtain();
+        addMockDocumentHolder();
+        mAccessibilityDelegate.getItemDelegate().onInitializeAccessibilityNodeInfo(item, info);
+
+        List<AccessibilityActionCompat> actions = getAccessibilityActions(info);
+        assertEquals(mView.getContext().getString(R.string.selected_document_click_action),
+                actions.get(0).getLabel().toString());
+    }
+
+    private List<AccessibilityActionCompat> getAccessibilityActions(
+            AccessibilityNodeInfoCompat info) {
+        List<AccessibilityActionCompat> actions = new ArrayList<>();
+
+
+        final List<AccessibilityActionCompat> actionList = info.getActionList();
+        final AccessibilityActionCompat clickAction = actionList.stream().filter(
+                action -> action.getId()
+                        == AccessibilityNodeInfoCompat.ACTION_CLICK).findAny().orElse(null);
+        assertNotNull(clickAction);
+        final AccessibilityActionCompat longClickAction = actionList.stream().filter(
+                action -> action.getId()
+                        == AccessibilityNodeInfoCompat.ACTION_LONG_CLICK).findAny().orElse(null);
+        assertNotNull(longClickAction);
+
+        actions.add(clickAction);
+        actions.add(longClickAction);
+        return actions;
+    }
+
+    private void addMockDocumentHolder() {
+        List<RecyclerView.ViewHolder> holders = new ArrayList<>();
+        final DocumentHolder holder = mock(DocumentHolder.class);
+        when(holder.getItemDetails()).thenReturn(new DocumentItemDetails(holder));
+        holders.add(holder);
+        mView.setHolders(holders);
+    }
 }
\ No newline at end of file
diff --git a/tests/unit/com/android/documentsui/dirlist/AppsRowManagerTest.java b/tests/unit/com/android/documentsui/dirlist/AppsRowManagerTest.java
index bbe2a0030..4d795fbaf 100644
--- a/tests/unit/com/android/documentsui/dirlist/AppsRowManagerTest.java
+++ b/tests/unit/com/android/documentsui/dirlist/AppsRowManagerTest.java
@@ -16,7 +16,11 @@
 
 package com.android.documentsui.dirlist;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
+
 import static com.google.common.truth.Truth.assertThat;
+import static com.google.common.truth.TruthJUnit.assume;
 
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertNull;
@@ -30,7 +34,7 @@ import android.view.LayoutInflater;
 import android.view.View;
 import android.widget.LinearLayout;
 
-import androidx.test.InstrumentationRegistry;
+import androidx.test.platform.app.InstrumentationRegistry;
 
 import com.android.documentsui.ActionHandler;
 import com.android.documentsui.BaseActivity;
@@ -52,6 +56,7 @@ import com.android.modules.utils.build.SdkLevel;
 import com.google.common.collect.Lists;
 
 import org.junit.Before;
+import org.junit.BeforeClass;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 import org.junit.runners.Parameterized;
@@ -89,6 +94,18 @@ public class AppsRowManagerTest {
         return com.google.android.collect.Lists.newArrayList(true, false);
     }
 
+    @BeforeClass
+    public static void setUpClass() {
+        if (isUseMaterial3FlagEnabled()) {
+            // The AppsRowManager is only available on devices that have the `show_apps_row`
+            // config enabled.
+            assume().that(
+                            InstrumentationRegistry.getInstrumentation()
+                                    .getTargetContext()
+                                    .getResources().getBoolean(R.bool.show_apps_row)).isTrue();
+        }
+    }
+
     @Before
     public void setUp() {
         mActionHandler = new TestActionHandler();
@@ -97,10 +114,12 @@ public class AppsRowManagerTest {
         mAppsRowManager = getAppsRowManager();
 
         Context context = InstrumentationRegistry.getInstrumentation().getTargetContext();
+        context.setTheme(getRes(R.style.DocumentsTheme));
+        context.getTheme().applyStyle(getRes(R.style.DocumentsDefaultTheme), false);
         LayoutInflater layoutInflater = LayoutInflater.from(context);
         mState = new State();
         mActivity = mock(BaseActivity.class);
-        mAppsRow = layoutInflater.inflate(R.layout.apps_row, null);
+        mAppsRow = layoutInflater.inflate(getRes(R.layout.apps_row), null);
         mAppsGroup = mAppsRow.findViewById(R.id.apps_row);
 
         mState.configStore = mTestConfigStore;
@@ -124,13 +143,13 @@ public class AppsRowManagerTest {
                     Lists.newArrayList(UserId.DEFAULT_USER, TestProvidersAccess.OtherUser.USER_ID,
                             TestProvidersAccess.AnotherUser.USER_ID);
             return new AppsRowManager(mActionHandler, mMaybeShowBadge, mTestUserManagerState,
-                    mTestConfigStore);
+                    mTestConfigStore, /*shouldShowByDefault=*/true);
         }
         mTestUserIdManager = new TestUserIdManager();
         mTestUserIdManager.userIds =
                 Lists.newArrayList(UserId.DEFAULT_USER, TestProvidersAccess.OtherUser.USER_ID);
         return new AppsRowManager(mActionHandler, mMaybeShowBadge, mTestUserIdManager,
-                mTestConfigStore);
+                mTestConfigStore, /*shouldShowByDefault=*/true);
     }
 
     @Test
diff --git a/tests/unit/com/android/documentsui/dirlist/DragStartListenerTest.java b/tests/unit/com/android/documentsui/dirlist/DragStartListenerTest.java
index 5bac03350..1e4c06c59 100644
--- a/tests/unit/com/android/documentsui/dirlist/DragStartListenerTest.java
+++ b/tests/unit/com/android/documentsui/dirlist/DragStartListenerTest.java
@@ -106,11 +106,23 @@ public class DragStartListenerTest {
     public void testMouseEvent() {
         MotionEvent e = mEvent.build();
         // Assert it is a mouse drag event.
-        assertTrue(Events.isMouseEvent(e));
+        assertTrue(Events.isMousyEvent(e));
         assertTrue(e.getActionMasked() == MotionEvent.ACTION_MOVE);
         assertTrue(e.isButtonPressed(MotionEvent.BUTTON_PRIMARY));
     }
 
+    @Test
+    public void testTouchEventIsNotMousy() {
+        MotionEvent e = TestEvents.builder().touch().build();
+        assertFalse(Events.isMousyEvent(e));
+    }
+
+    @Test
+    public void testTouchpadEventIsMousy() {
+        MotionEvent e = TestEvents.builder().touchpad().build();
+        assertTrue(Events.isMousyEvent(e));
+    }
+
     @Test
     public void testDragStarted_OnMouseMove() {
         assertTrue(mListener.onDragEvent(mEvent.build()));
diff --git a/tests/unit/com/android/documentsui/dirlist/IconHelperTest.java b/tests/unit/com/android/documentsui/dirlist/IconHelperTest.java
index 6a6dd3d9b..f1f3819c6 100644
--- a/tests/unit/com/android/documentsui/dirlist/IconHelperTest.java
+++ b/tests/unit/com/android/documentsui/dirlist/IconHelperTest.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.dirlist;
 
 import static com.google.common.truth.Truth.assertThat;
+import static com.google.common.truth.TruthJUnit.assume;
 
 import android.content.Context;
 import android.os.UserHandle;
@@ -87,6 +88,10 @@ public final class IconHelperTest {
 
     @Test
     public void testShouldShowBadge_returnFalse_onSystemUser() {
+        // In HSUM setups the system user will not be a real user and thus DocumentsUI won't be used
+        // in this situation. Let's assume the current user is a system user (thus the test is
+        // running on a non-HSUM device).
+        assume().that(UserId.CURRENT_USER.isSystem()).isTrue();
         assertThat(mIconHelper.shouldShowBadge(mSystemUser.getIdentifier())).isFalse();
     }
 
diff --git a/tests/unit/com/android/documentsui/dirlist/InflateMessageDocumentHolderTest.java b/tests/unit/com/android/documentsui/dirlist/InflateMessageDocumentHolderTest.java
index 507e9bf4a..02ba6ff44 100644
--- a/tests/unit/com/android/documentsui/dirlist/InflateMessageDocumentHolderTest.java
+++ b/tests/unit/com/android/documentsui/dirlist/InflateMessageDocumentHolderTest.java
@@ -26,6 +26,7 @@ import android.os.UserManager;
 import android.view.View;
 import android.widget.Button;
 
+import androidx.test.annotation.UiThreadTest;
 import androidx.test.filters.SmallTest;
 import androidx.test.platform.app.InstrumentationRegistry;
 
@@ -121,12 +122,14 @@ public final class InflateMessageDocumentHolderTest {
             mInflateMessage = new Message.InflateMessage(env, mDefaultCallback, mTestConfigStore);
             env.getDisplayState().canShareAcrossProfile = true;
         }
-        mHolder = new InflateMessageDocumentHolder(mContext, /* parent= */null, mTestConfigStore);
     }
 
     @Test
+    @UiThreadTest
     public void testClickingButtonShouldShowProgressBar() {
         if (SdkLevel.isAtLeastV()) return;
+        mHolder = new InflateMessageDocumentHolder(mContext, /* parent= */null, mTestConfigStore);
+
         Model.Update error = new Model.Update(
                 new CrossProfileQuietModeException(TestProvidersAccess.OtherUser.USER_ID),
                 /* remoteActionsEnabled= */ true);
diff --git a/tests/unit/com/android/documentsui/dirlist/MessageTest.java b/tests/unit/com/android/documentsui/dirlist/MessageTest.java
index 17ca61eeb..cdf8b6b1e 100644
--- a/tests/unit/com/android/documentsui/dirlist/MessageTest.java
+++ b/tests/unit/com/android/documentsui/dirlist/MessageTest.java
@@ -22,6 +22,9 @@ import static com.android.documentsui.DevicePolicyResources.Strings.CANT_SELECT_
 import static com.android.documentsui.DevicePolicyResources.Strings.CANT_SELECT_WORK_FILES_TITLE;
 import static com.android.documentsui.DevicePolicyResources.Strings.WORK_PROFILE_OFF_ENABLE_BUTTON;
 import static com.android.documentsui.DevicePolicyResources.Strings.WORK_PROFILE_OFF_ERROR_TITLE;
+import static com.android.documentsui.testing.DrawableAsserts.assertDrawablesEqual;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import static com.google.common.truth.Truth.assertThat;
 import static com.google.common.truth.TruthJUnit.assume;
@@ -53,6 +56,7 @@ import com.android.documentsui.base.State;
 import com.android.documentsui.base.UserId;
 import com.android.documentsui.testing.TestActionHandler;
 import com.android.documentsui.testing.TestEnv;
+import com.android.documentsui.testing.TestModel;
 import com.android.documentsui.testing.TestProvidersAccess;
 import com.android.documentsui.testing.UserManagers;
 import com.android.modules.utils.build.SdkLevel;
@@ -83,6 +87,7 @@ public final class MessageTest {
     private DevicePolicyManager mDevicePolicyManager;
     private TestActionHandler mTestActionHandler;
     private final TestConfigStore mTestConfigStore = new TestConfigStore();
+    private DocumentsAdapter.Environment mEnv;
 
     @Parameter(0)
     public boolean isPrivateSpaceEnabled;
@@ -110,9 +115,8 @@ public final class MessageTest {
                 .thenReturn(mDevicePolicyManager);
         when(mContext.getResources()).thenReturn(
                 InstrumentationRegistry.getInstrumentation().getTargetContext().getResources());
-        DocumentsAdapter.Environment env =
-                new TestEnvironment(mContext, TestEnv.create(), mTestActionHandler);
-        env.getDisplayState().action = State.ACTION_GET_CONTENT;
+        mEnv = new TestEnvironment(mContext, TestEnv.create(), mTestActionHandler);
+        mEnv.getDisplayState().action = State.ACTION_GET_CONTENT;
 
         isPrivateSpaceEnabled = SdkLevel.isAtLeastS() && isPrivateSpaceEnabled;
         if (SdkLevel.isAtLeastV()) {
@@ -129,11 +133,11 @@ public final class MessageTest {
             Map<UserId, String> userIdToLabelMap = new HashMap<>();
             userIdToLabelMap.put(TestProvidersAccess.USER_ID, personalLabel);
             userIdToLabelMap.put(mUserId, workLabel);
-            mInflateMessage = new Message.InflateMessage(env, mDefaultCallback,
+            mInflateMessage = new Message.InflateMessage(mEnv, mDefaultCallback,
                     TestProvidersAccess.USER_ID, mUserId, userIdToLabelMap, mUserManager,
                     mTestConfigStore);
         } else {
-            mInflateMessage = new Message.InflateMessage(env, mDefaultCallback, mTestConfigStore);
+            mInflateMessage = new Message.InflateMessage(mEnv, mDefaultCallback, mTestConfigStore);
         }
     }
 
@@ -258,4 +262,39 @@ public final class MessageTest {
 
         assertThat(mTestActionHandler.mRequestDisablingQuietModeHappened).isTrue();
     }
+
+    @Test
+    public void testInflateMessage_updateToEmptyMessage() {
+        // Set model to empty.
+        ((TestModel) mEnv.getModel()).clearIds();
+        // Make sure we have a root doc for title access.
+        mEnv.getDisplayState().stack.changeRoot(TestProvidersAccess.HOME);
+        // Turn off search mode.
+        ((TestEnvironment) mEnv).setInSearchMode(false);
+
+        mInflateMessage.update(Model.Update.UPDATE);
+
+        Drawable expectedDrawable = mContext.getDrawable(getRes(R.drawable.empty));
+        assertDrawablesEqual(mInflateMessage.getIcon(), expectedDrawable);
+    }
+
+    @Test
+    public void testInflateMessage_updateToEmptyMessage_InSearch() {
+        // Set model to empty.
+        ((TestModel) mEnv.getModel()).clearIds();
+        // Make sure we have a root doc for title access.
+        mEnv.getDisplayState().stack.changeRoot(TestProvidersAccess.HOME);
+        // Turn on search mode.
+        ((TestEnvironment) mEnv).setInSearchMode(true);
+
+        mInflateMessage.update(Model.Update.UPDATE);
+
+        final Drawable expectedDrawable;
+        if (isUseMaterial3FlagEnabled()) {
+            expectedDrawable = mContext.getDrawable(R.drawable.empty_search);
+        } else {
+            expectedDrawable = mContext.getDrawable(R.drawable.empty);
+        }
+        assertDrawablesEqual(mInflateMessage.getIcon(), expectedDrawable);
+    }
 }
diff --git a/tests/unit/com/android/documentsui/files/ActionHandlerTest.java b/tests/unit/com/android/documentsui/files/ActionHandlerTest.java
index 5b19fcdc2..9ea2b8ee9 100644
--- a/tests/unit/com/android/documentsui/files/ActionHandlerTest.java
+++ b/tests/unit/com/android/documentsui/files/ActionHandlerTest.java
@@ -16,7 +16,6 @@
 
 package com.android.documentsui.files;
 
-import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 import static com.android.documentsui.testing.IntentAsserts.assertHasAction;
 import static com.android.documentsui.testing.IntentAsserts.assertHasData;
 import static com.android.documentsui.testing.IntentAsserts.assertHasExtra;
@@ -24,6 +23,8 @@ import static com.android.documentsui.testing.IntentAsserts.assertHasExtraIntent
 import static com.android.documentsui.testing.IntentAsserts.assertHasExtraList;
 import static com.android.documentsui.testing.IntentAsserts.assertHasExtraUri;
 import static com.android.documentsui.testing.IntentAsserts.assertTargetsComponent;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
 
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertFalse;
@@ -44,8 +45,6 @@ import android.net.Uri;
 import android.os.Parcelable;
 import android.platform.test.annotations.RequiresFlagsDisabled;
 import android.platform.test.annotations.RequiresFlagsEnabled;
-import android.platform.test.flag.junit.CheckFlagsRule;
-import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 import android.provider.DocumentsContract;
 import android.provider.DocumentsContract.Path;
 import android.util.Pair;
@@ -68,6 +67,7 @@ import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.base.Shared;
 import com.android.documentsui.flags.Flags;
 import com.android.documentsui.inspector.InspectorActivity;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
 import com.android.documentsui.testing.ClipDatas;
 import com.android.documentsui.testing.DocumentStackAsserts;
 import com.android.documentsui.testing.Roots;
@@ -118,7 +118,7 @@ public class ActionHandlerTest {
     @Mock private Runnable mMockCloseSelectionBar;
 
     @Rule
-    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
 
     @Parameter(0)
     public boolean isPrivateSpaceEnabled;
@@ -143,7 +143,7 @@ public class ActionHandlerTest {
         mDialogs = new TestDialogController();
         mClipper = new TestDocumentClipper();
         mDragAndDropManager = new TestDragAndDropManager();
-        mPeekViewManager = new TestPeekViewManager(mActivity);
+        mPeekViewManager = new TestPeekViewManager();
         mTestConfigStore = new TestConfigStore();
         mEnv.state.configStore = mTestConfigStore;
 
@@ -400,12 +400,16 @@ public class ActionHandlerTest {
     }
 
     @Test
-    public void testDocumentPicked_InArchive_Unopenable() throws Exception {
+    public void testDocumentPicked_InArchive_OpenableOrNot() throws Exception {
         mActivity.currentRoot = TestProvidersAccess.HOME;
 
         mHandler.openDocument(TestEnv.FILE_IN_ARCHIVE, ActionHandler.VIEW_TYPE_PREVIEW,
                 ActionHandler.VIEW_TYPE_REGULAR);
-        mDialogs.assertViewInArchivesShownUnsupported();
+        if (isZipNgFlagEnabled()) {
+            mActivity.assertActivityStarted(Intent.ACTION_VIEW);
+        } else {
+            mDialogs.assertViewInArchivesShownUnsupported();
+        }
     }
 
     @Test
diff --git a/tests/unit/com/android/documentsui/files/MenuManagerTest.java b/tests/unit/com/android/documentsui/files/MenuManagerTest.java
index 8bc5ad707..45ea010f1 100644
--- a/tests/unit/com/android/documentsui/files/MenuManagerTest.java
+++ b/tests/unit/com/android/documentsui/files/MenuManagerTest.java
@@ -16,18 +16,21 @@
 
 package com.android.documentsui.files;
 
+import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
 import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
+import static com.android.documentsui.util.Material3Config.getRes;
 
 import static junit.framework.Assert.assertEquals;
 
 import static org.junit.Assert.assertTrue;
+import static org.mockito.ArgumentMatchers.any;
+import static org.mockito.ArgumentMatchers.anyInt;
+import static org.mockito.Mockito.doReturn;
 
 import android.annotation.SuppressLint;
 import android.net.Uri;
 import android.platform.test.annotations.RequiresFlagsDisabled;
 import android.platform.test.annotations.RequiresFlagsEnabled;
-import android.platform.test.flag.junit.CheckFlagsRule;
-import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 import android.provider.DocumentsContract.Document;
 import android.provider.DocumentsContract.Root;
 
@@ -43,6 +46,7 @@ import com.android.documentsui.base.State;
 import com.android.documentsui.base.UserId;
 import com.android.documentsui.dirlist.TestData;
 import com.android.documentsui.flags.Flags;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
 import com.android.documentsui.testing.TestDirectoryDetails;
 import com.android.documentsui.testing.TestEnv;
 import com.android.documentsui.testing.TestFeatures;
@@ -136,10 +140,16 @@ public final class MenuManagerTest {
     private int mFilesCount;
 
     @Rule
-    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
 
     @Before
     public void setUp() {
+        if (isVisualSignalsFlagEnabled()) {
+            // The job progress indicator toolbar icon registers itself as a broadcast receiver to
+            // receive updates, so we need to stub that functionality out.
+            doReturn(null).when(activity).registerReceiver(any(), any(), anyInt());
+        }
+
         testMenu = TestMenu.create();
 
         // The context menu on anything in DirectoryList (including no selection).
@@ -517,7 +527,7 @@ public final class MenuManagerTest {
         selectionDetails.containDirectories = false;
         mgr.inflateContextMenuForDocs(testMenu, inflater, selectionDetails);
 
-        assertEquals(R.menu.file_context_menu, inflater.lastInflatedMenuId);
+        assertEquals(getRes(R.menu.file_context_menu), inflater.lastInflatedMenuId);
     }
 
     @Test
@@ -528,7 +538,7 @@ public final class MenuManagerTest {
         selectionDetails.containDirectories = true;
         mgr.inflateContextMenuForDocs(testMenu, inflater, selectionDetails);
 
-        assertEquals(R.menu.dir_context_menu, inflater.lastInflatedMenuId);
+        assertEquals(getRes(R.menu.dir_context_menu), inflater.lastInflatedMenuId);
     }
 
     @Test
@@ -539,7 +549,7 @@ public final class MenuManagerTest {
         selectionDetails.containDirectories = true;
         mgr.inflateContextMenuForDocs(testMenu, inflater, selectionDetails);
 
-        assertEquals(R.menu.mixed_context_menu, inflater.lastInflatedMenuId);
+        assertEquals(getRes(R.menu.mixed_context_menu), inflater.lastInflatedMenuId);
     }
 
     @SuppressLint("VisibleForTests")
@@ -794,6 +804,9 @@ public final class MenuManagerTest {
         selectionDetails.size = 1;
         selectionDetails.containFiles = true;
         selectionDetails.isArchive = true;
+        selectionDetails.containsFilesInArchive = false;
+        dirDetails.isInArchive = false;
+        dirDetails.canCreateDirectory = true;
         mgr.updateContextMenuForFiles(testMenu, selectionDetails);
         if (isZipNgFlagEnabled()) {
             mDirExtractHere.assertEnabledAndVisible();
@@ -802,6 +815,26 @@ public final class MenuManagerTest {
             mDirExtractHere.assertDisabledAndInvisible();
             mDirBrowse.assertDisabledAndInvisible();
         }
+
+        // On archive in read-only directory (but not a nested archive)
+        selectionDetails.containsFilesInArchive = false;
+        dirDetails.isInArchive = false;
+        dirDetails.canCreateDirectory = false;
+        mgr.updateContextMenuForFiles(testMenu, selectionDetails);
+        mDirExtractHere.assertDisabledAndInvisible();
+        if (isZipNgFlagEnabled()) {
+            mDirBrowse.assertEnabledAndVisible();
+        } else {
+            mDirBrowse.assertDisabledAndInvisible();
+        }
+
+        // On nested archive
+        selectionDetails.containsFilesInArchive = true;
+        dirDetails.isInArchive = true;
+        dirDetails.canCreateDirectory = false;
+        mgr.updateContextMenuForFiles(testMenu, selectionDetails);
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
     @Test
diff --git a/tests/unit/com/android/documentsui/loaders/BaseLoaderTest.kt b/tests/unit/com/android/documentsui/loaders/BaseLoaderTest.kt
index 55f83bfea..6b05e0f69 100644
--- a/tests/unit/com/android/documentsui/loaders/BaseLoaderTest.kt
+++ b/tests/unit/com/android/documentsui/loaders/BaseLoaderTest.kt
@@ -44,15 +44,30 @@ fun getFileCount(result: DirectoryResult?) = result?.cursor?.count ?: -1
  * returned files matches the expectations.
  */
 data class LoaderTestParams(
-    // A query, matched against file names. May be empty.
+    // Number of fake files to populate the mock (queried) DocumentsProvider with.
+    val fakeFileCount: Int,
+    // A query, matched against the fake file names. May be empty.
     val query: String,
     // The delta from now that indicates maximum age of matched files.
     val lastModifiedDelta: Duration?,
-    // The extra arguments typically supplied by search view manager.
+    // The maximum number of files to ask each Root for (QueryOptions.ALL_RESULTS means no limit).
+    val maxResultsPerRoot: Int,
+    // The extra arguments typically supplied by SearchViewManager.
     val otherArgs: Bundle,
     // The number of files that are expected, for the above parameters, to be found by a loader.
     val expectedCount: Int,
-)
+) {
+    override fun toString(): String {
+        var base = "query '$query', maxResultsPerRoot: '$maxResultsPerRoot'"
+        if (lastModifiedDelta != null) {
+            base = "$base, modified in the last $lastModifiedDelta"
+        }
+        if (!otherArgs.isEmpty) {
+            base = "$base, and $otherArgs"
+        }
+        return "$base, expecting $expectedCount matches"
+    }
+}
 
 /**
  * Common base class for search and folder loaders.
@@ -63,7 +78,7 @@ open class BaseLoaderTest {
     lateinit var mTestConfigStore: TestConfigStore
 
     @Before
-    open fun setUp() {
+    fun setUp() {
         mEnv = TestEnv.create()
         mTestConfigStore = TestConfigStore()
         mEnv.state.configStore = mTestConfigStore
diff --git a/tests/unit/com/android/documentsui/loaders/FolderLoaderTest.kt b/tests/unit/com/android/documentsui/loaders/FolderLoaderTest.kt
index 0193ea77d..10ed644cc 100644
--- a/tests/unit/com/android/documentsui/loaders/FolderLoaderTest.kt
+++ b/tests/unit/com/android/documentsui/loaders/FolderLoaderTest.kt
@@ -17,16 +17,16 @@ package com.android.documentsui.loaders
 
 import android.os.Bundle
 import android.platform.test.annotations.RequiresFlagsEnabled
-import android.platform.test.flag.junit.CheckFlagsRule
-import android.platform.test.flag.junit.DeviceFlagsValueProvider
 import androidx.test.filters.SmallTest
 import com.android.documentsui.ContentLock
 import com.android.documentsui.base.DocumentInfo
 import com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
 import com.android.documentsui.testing.TestFileTypeLookup
 import com.android.documentsui.testing.TestProvidersAccess
 import java.time.Duration
-import junit.framework.Assert.assertEquals
+import org.junit.Assert.assertEquals
+import org.junit.Before
 import org.junit.Rule
 import org.junit.Test
 import org.junit.runner.RunWith
@@ -42,13 +42,31 @@ class FolderLoaderTest(private val testParams: LoaderTestParams) : BaseLoaderTes
         @JvmStatic
         @Parameters(name = "with parameters {0}")
         fun data() = listOf(
-            LoaderTestParams("", null, Bundle(), TOTAL_FILE_COUNT),
+            LoaderTestParams(TOTAL_FILE_COUNT, "", null, ALL_RESULTS, Bundle(), TOTAL_FILE_COUNT),
+            // Result limiting only works for search, not folder navigation, expect limit to be ignored.
+            LoaderTestParams(TOTAL_FILE_COUNT, "", null, 2, Bundle(), TOTAL_FILE_COUNT),
             // The first file is at NOW, the second at NOW - 1h, etc.
-            LoaderTestParams("", Duration.ofMinutes(1L), Bundle(), 1),
-            LoaderTestParams("", Duration.ofMinutes(60L + 1), Bundle(), 2),
             LoaderTestParams(
+                TOTAL_FILE_COUNT,
+                "",
+                Duration.ofMinutes(1L),
+                ALL_RESULTS,
+                Bundle(),
+                1
+            ),
+            LoaderTestParams(
+                TOTAL_FILE_COUNT,
+                "",
+                Duration.ofMinutes(60L + 1),
+                ALL_RESULTS,
+                Bundle(),
+                2
+            ),
+            LoaderTestParams(
+                TOTAL_FILE_COUNT,
                 "",
                 Duration.ofMinutes(TOTAL_FILE_COUNT * 60L + 1),
+                ALL_RESULTS,
                 Bundle(),
                 TOTAL_FILE_COUNT
             ),
@@ -56,25 +74,33 @@ class FolderLoaderTest(private val testParams: LoaderTestParams) : BaseLoaderTes
     }
 
     @get:Rule
-    val checkFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+    val checkFlags = CheckAndForceMaterial3Flag()
 
-    @Test
-    @RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
-    fun testLoadInBackground() {
-        val mockProvider = mEnv.mockProviders[TestProvidersAccess.DOWNLOADS.authority]
-        val docs = createDocuments(TOTAL_FILE_COUNT)
-        mockProvider!!.setNextChildDocumentsReturns(*docs)
-        val userIds = listOf(TestProvidersAccess.DOWNLOADS.userId)
-        val queryOptions =
+    val contentLock = ContentLock()
+    lateinit var queryOptions: QueryOptions
+
+    @Before
+    fun setUpTest() {
+        queryOptions =
             QueryOptions(
-                TOTAL_FILE_COUNT,
+                testParams.fakeFileCount + 1,
+                testParams.maxResultsPerRoot,
                 testParams.lastModifiedDelta,
                 null,
                 true,
-                arrayOf<String>("*/*"),
+                arrayOf("*/*"),
                 testParams.otherArgs,
             )
-        val contentLock = ContentLock()
+        // Set up sample files using Downloads provider.
+        val mockProvider = mEnv.mockProviders[TestProvidersAccess.DOWNLOADS.authority]
+        val docs = createDocuments(TOTAL_FILE_COUNT)
+        mockProvider!!.setNextChildDocumentsReturns(*docs)
+    }
+
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+    fun testLoadInBackground() {
+        val userIds = listOf(TestProvidersAccess.DOWNLOADS.userId)
         // TODO(majewski): Is there a better way to create Downloads root folder DocumentInfo?
         val rootFolderInfo = DocumentInfo()
         rootFolderInfo.authority = TestProvidersAccess.DOWNLOADS.authority
@@ -94,4 +120,26 @@ class FolderLoaderTest(private val testParams: LoaderTestParams) : BaseLoaderTes
         val directoryResult = loader.loadInBackground()
         assertEquals(testParams.expectedCount, getFileCount(directoryResult))
     }
+
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+    fun testListRootIfNullFolder() {
+        val mockProvider = mEnv.mockProviders[TestProvidersAccess.DOWNLOADS.authority]
+        val docs = createDocuments(TOTAL_FILE_COUNT)
+        mockProvider!!.setNextChildDocumentsReturns(*docs)
+
+        val loader =
+            FolderLoader(
+                mActivity,
+                listOf(TestProvidersAccess.DOWNLOADS.userId),
+                TestFileTypeLookup(),
+                contentLock,
+                TestProvidersAccess.DOWNLOADS,
+                null,
+                queryOptions,
+                mEnv.state.sortModel
+            )
+        val directoryResult = loader.loadInBackground()
+        assertEquals(testParams.expectedCount, getFileCount(directoryResult))
+    }
 }
diff --git a/tests/unit/com/android/documentsui/loaders/SearchLoaderTest.kt b/tests/unit/com/android/documentsui/loaders/SearchLoaderTest.kt
index 7265af34b..70e7dedad 100644
--- a/tests/unit/com/android/documentsui/loaders/SearchLoaderTest.kt
+++ b/tests/unit/com/android/documentsui/loaders/SearchLoaderTest.kt
@@ -17,25 +17,28 @@ package com.android.documentsui.loaders
 
 import android.os.Bundle
 import android.platform.test.annotations.RequiresFlagsEnabled
-import android.platform.test.flag.junit.CheckFlagsRule
-import android.platform.test.flag.junit.DeviceFlagsValueProvider
 import android.provider.DocumentsContract
 import androidx.test.filters.SmallTest
 import com.android.documentsui.ContentLock
 import com.android.documentsui.LockingContentObserver
+import com.android.documentsui.Model
 import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.base.FolderInfo
 import com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import com.android.documentsui.sorting.SortModel
+import com.android.documentsui.testing.TestFeatures
 import com.android.documentsui.testing.TestFileTypeLookup
 import com.android.documentsui.testing.TestProvidersAccess
+import com.google.common.truth.Expect
 import java.time.Duration
+import java.util.Locale
 import java.util.concurrent.ExecutorService
 import java.util.concurrent.Executors
-import junit.framework.Assert.assertEquals
-import org.junit.Assert.assertThrows
 import org.junit.Before
-import org.junit.Ignore
 import org.junit.Rule
 import org.junit.Test
+import org.junit.experimental.runners.Enclosed
 import org.junit.runner.RunWith
 import org.junit.runners.Parameterized
 import org.junit.runners.Parameterized.Parameters
@@ -48,113 +51,261 @@ fun createQueryArgs(vararg mimeTypes: String): Bundle {
     return args
 }
 
-@RunWith(Parameterized::class)
+@RunWith(Enclosed::class)
 @SmallTest
-class SearchLoaderTest(private val testParams: LoaderTestParams) : BaseLoaderTest() {
-    lateinit var mExecutor: ExecutorService
-    val mContentLock = ContentLock()
-    val mContentObserver = LockingContentObserver(mContentLock) {}
-
-    companion object {
-        @JvmStatic
-        @Parameters(name = "with parameters {0}")
-        fun data() = listOf(
-            LoaderTestParams("sample", null, Bundle(), TOTAL_FILE_COUNT),
-            LoaderTestParams("txt", null, Bundle(), 2),
-            LoaderTestParams("foozig", null, Bundle(), 0),
-            // The first file is at NOW, the second at NOW - 1h; expect 2.
-            LoaderTestParams("sample", Duration.ofMinutes(60 + 1), Bundle(), 2),
-            LoaderTestParams("sample", null, createQueryArgs("image/*"), 2),
-            LoaderTestParams("sample", null, createQueryArgs("image/*", "video/*"), 6),
-            LoaderTestParams("sample", null, createQueryArgs("application/pdf"), 0),
-        )
-    }
+class SearchLoaderTest {
 
-    @get:Rule
-    val checkFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+    // Collection of tests that are parametrized by query, duration, and MIME type.
+    @RunWith(Parameterized::class)
+    class ParametrizedTests(private val testParams: LoaderTestParams) : BaseLoaderTest() {
+        lateinit var mExecutor: ExecutorService
+        val mContentLock = ContentLock()
+        val mContentObserver = LockingContentObserver(mContentLock) {}
 
-    @Before
-    override fun setUp() {
-        super.setUp()
-        mExecutor = Executors.newSingleThreadExecutor()
-    }
+        companion object {
+            @JvmStatic
+            @Parameters(name = "with parameters {0}")
+            fun data() = listOf(
+                // Specifying ALL_RESULTS as the limit should return as many results as the root allows,
+                // for TestDocumentsProvider this is 23 (to match FileSystemProvider's legacy default),
+                // which our TOTAL_FILE_COUNT is well below (so expect all files to be returned).
+                LoaderTestParams(
+                    TOTAL_FILE_COUNT,
+                    "sample",
+                    null,
+                    ALL_RESULTS,
+                    Bundle(),
+                    TOTAL_FILE_COUNT
+                ),
+                // Specifying a positive, non-zero search result limit should work.
+                LoaderTestParams(TOTAL_FILE_COUNT, "sample", null, 2, Bundle(), 2),
+                // Specifying a zero search results limit should return zero files.
+                LoaderTestParams(TOTAL_FILE_COUNT, "sample", null, 0, Bundle(), 0),
+                LoaderTestParams(TOTAL_FILE_COUNT, "txt", null, ALL_RESULTS, Bundle(), 2),
+                LoaderTestParams(TOTAL_FILE_COUNT, "foozig", null, ALL_RESULTS, Bundle(), 0),
+                // The first file is at NOW, the second at NOW - 1h; expect 2.
+                LoaderTestParams(
+                    TOTAL_FILE_COUNT,
+                    "sample",
+                    Duration.ofMinutes(60 + 1),
+                    ALL_RESULTS,
+                    Bundle(),
+                    2
+                ),
+                LoaderTestParams(
+                    TOTAL_FILE_COUNT,
+                    "sample",
+                    null,
+                    ALL_RESULTS,
+                    createQueryArgs("image/*"),
+                    2
+                ),
+                LoaderTestParams(
+                    TOTAL_FILE_COUNT,
+                    "sample",
+                    null,
+                    ALL_RESULTS,
+                    createQueryArgs("image/*", "video/*"),
+                    6
+                ),
+                LoaderTestParams(
+                    TOTAL_FILE_COUNT,
+                    "sample",
+                    null,
+                    ALL_RESULTS,
+                    createQueryArgs("application/pdf"),
+                    0
+                ),
+            )
+        }
+
+        @get:Rule
+        val checkFlags = CheckAndForceMaterial3Flag()
+
+        @get:Rule
+        val expect: Expect = Expect.create()
 
-    @Test
-    @RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
-    fun testLoadInBackground() {
-        val mockProvider = mEnv.mockProviders[TestProvidersAccess.DOWNLOADS.authority]
-        val docs = createDocuments(TOTAL_FILE_COUNT)
-        mockProvider!!.setNextChildDocumentsReturns(*docs)
-        val userIds = listOf(TestProvidersAccess.DOWNLOADS.userId)
-        val queryOptions =
-            QueryOptions(
-                TOTAL_FILE_COUNT + 1,
+        @Before
+        fun setUpTest() {
+            mExecutor = Executors.newSingleThreadExecutor()
+        }
+
+        @Test
+        @RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+        fun testLoadInBackground() {
+            val mockProvider = mEnv.mockProviders[TestProvidersAccess.DOWNLOADS.authority]
+            val docs = createDocuments(testParams.fakeFileCount)
+            mockProvider!!.setNextChildDocumentsReturns(*docs)
+            val userIds = listOf(TestProvidersAccess.DOWNLOADS.userId)
+            val queryOptions = QueryOptions(
+                testParams.fakeFileCount + 1,
+                testParams.maxResultsPerRoot,
                 testParams.lastModifiedDelta,
                 null,
                 true,
                 arrayOf("*/*"),
                 testParams.otherArgs,
             )
-        val rootIds = listOf(TestProvidersAccess.DOWNLOADS)
 
-        // TODO(majewski): Is there a better way to create Downloads root folder DocumentInfo?
-        val rootFolderInfo = DocumentInfo()
-        rootFolderInfo.authority = TestProvidersAccess.DOWNLOADS.authority
-        rootFolderInfo.userId = userIds[0]
+            val folderInfo = listOf(
+                FolderInfo(
+                    TestProvidersAccess.DOWNLOADS.rootId,
+                    TestProvidersAccess.DOWNLOADS.authority,
+                    TestProvidersAccess.DOWNLOADS.supportsSearchResultLimit()
+                )
+            )
 
-        val loader =
-            SearchLoader(
+            val loader = SearchLoader(
                 mActivity,
                 userIds,
                 TestFileTypeLookup(),
                 mContentObserver,
-                rootIds,
+                folderInfo,
                 testParams.query,
                 queryOptions,
                 mEnv.state.sortModel,
                 mExecutor,
             )
-        val directoryResult = loader.loadInBackground()
-        assertEquals(testParams.expectedCount, getFileCount(directoryResult))
+            val directoryResult = loader.loadInBackground()
+            expect.that(getFileCount(directoryResult)).isEqualTo(testParams.expectedCount)
+        }
     }
 
-    @Test
-    @RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
-    @Ignore("b/397095797")
-    fun testBlankQueryAndRecency() {
-        val userIds = listOf(TestProvidersAccess.DOWNLOADS.userId)
-        val rootIds = listOf(TestProvidersAccess.DOWNLOADS)
-        val noLastModifiedQueryOptions =
-            QueryOptions(10, null, null, true, arrayOf("*/*"), Bundle())
-
-        // Blank query and no last modified duration is invalid.
-        assertThrows(IllegalArgumentException::class.java) {
-            SearchLoader(
+    // Collection of plain tests that do not use parameters.
+    class PlainTests : BaseLoaderTest() {
+        @get:Rule
+        val checkFlags = CheckAndForceMaterial3Flag()
+
+        @get:Rule
+        val expect: Expect = Expect.create()
+
+        lateinit var mExecutor: ExecutorService
+        val mContentLock = ContentLock()
+        val mContentObserver = LockingContentObserver(mContentLock) {}
+
+        @Before
+        fun setUpTest() {
+            mExecutor = Executors.newSingleThreadExecutor()
+        }
+
+        fun generateDocuments(
+            count: Int,
+            suffixOffset: Int,
+            extensions: Array<String>
+        ): Array<DocumentInfo> {
+            return Array(count) { i ->
+                val suffix = String.format(Locale.US, "%05d", 2 * i + suffixOffset)
+                val ext = extensions[i % extensions.size]
+                mEnv.model.createFile("document-$suffix.$ext")
+            }
+        }
+
+        /**
+         * Checks that the merging, filtering and sorting of results works correctly. We set up
+         * two providers: home and pickles storage. They get files with names that have a zipper
+         * like pattern, when sorted. Here we are checking if merging two cursors, with filtering
+         * produces the expected result.
+         */
+        @Test
+        fun testValidateMergeFilterSort() {
+            val fileCount = 200
+            val maxCount = fileCount / 2
+            mEnv.mockProviders.apply {
+                // Pickles documents have IDs 0, 2, 4, .., 398. Half of the documents are images,
+                // the other half are documents (PDFs).
+                get(TestProvidersAccess.PICKLES.authority)!!.setNextChildDocumentsReturns(
+                    *generateDocuments(fileCount, 0, arrayOf("png", "pdf"))
+                )
+                // Home documents have IDs 1, 3, 5, ... 399. Half of the documents are images,
+                // the other half are videos.
+                get(TestProvidersAccess.HOME.authority)!!.setNextChildDocumentsReturns(
+                    *generateDocuments(fileCount, 1, arrayOf("png", "avi"))
+                )
+            }
+
+            // Setup the sort model so that results are sorted by their name.
+            val sortModel = SortModel.createModel()
+            sortModel.setDefaultDimension(SortModel.SORT_DIMENSION_ID_TITLE)
+            val folderInfo = listOf(
+                FolderInfo(
+                    TestProvidersAccess.PICKLES.rootId,
+                    TestProvidersAccess.PICKLES.authority,
+                    TestProvidersAccess.DOWNLOADS.supportsSearchResultLimit()
+                ),
+                FolderInfo(
+                    TestProvidersAccess.HOME.rootId,
+                    TestProvidersAccess.HOME.authority,
+                    TestProvidersAccess.DOWNLOADS.supportsSearchResultLimit()
+                ),
+            )
+            val loader = SearchLoader(
                 mActivity,
-                userIds,
+                listOf(TestProvidersAccess.PICKLES.userId, TestProvidersAccess.HOME.userId),
                 TestFileTypeLookup(),
                 mContentObserver,
-                rootIds,
-                "",
-                noLastModifiedQueryOptions,
-                mEnv.state.sortModel,
+                folderInfo,
+                "document-",
+                QueryOptions(
+                    maxCount,
+                    ALL_RESULTS,
+                    null,
+                    null,
+                    false,
+                    arrayOf("image/png"),
+                    Bundle()
+                ),
+                sortModel,
                 mExecutor,
             )
+            val result = loader.loadInBackground()
+            expect.that(result?.cursor?.getCount()).isEqualTo(maxCount)
+            // We expect a perfect mix of documents from PICKLES and HOME. Pickles has odd indices
+            // Home has even indices. However, the filtering cursor should take out all non-images
+            // leaving us with 0, 4, 8, ..., from PICKLES and 1, 5, 9, ... from HOME.
+            val model = Model(TestFeatures())
+            model.update(result)
+            val names = model.modelIds.map {
+                model.getDocument(it)!!.displayName
+            }
+            expect.that(names).isEqualTo((0..maxCount - 1).map {
+                val index = String.format(Locale.US, "%05d", 4 * (it / 2) + (it % 2))
+                "document-$index.png"
+            })
         }
 
-        // Null query and no last modified duration is invalid.
-        assertThrows(IllegalArgumentException::class.java) {
-            SearchLoader(
+        @Test
+        fun testExtraArgs() {
+            mEnv.mockProviders.apply {
+                get(TestProvidersAccess.PICKLES.authority)!!.setNextChildDocumentsReturns(
+                    *generateDocuments(2, 1, arrayOf("png", "avi"))
+                )
+            }
+            val folderInfo = listOf(
+                FolderInfo(
+                    TestProvidersAccess.PICKLES.rootId,
+                    TestProvidersAccess.PICKLES.authority,
+                    TestProvidersAccess.PICKLES.supportsSearchResultLimit(),
+                ),
+            )
+            val loader = SearchLoader(
                 mActivity,
-                userIds,
+                listOf(TestProvidersAccess.PICKLES.userId, TestProvidersAccess.HOME.userId),
                 TestFileTypeLookup(),
                 mContentObserver,
-                rootIds,
-                null,
-                noLastModifiedQueryOptions,
+                folderInfo,
+                "document",
+                QueryOptions(10, ALL_RESULTS, null, null, false, arrayOf("image/png"), Bundle()),
                 mEnv.state.sortModel,
                 mExecutor,
             )
+            val result = loader.loadInBackground()
+            expect.that(result!!.cursor).isNotNull()
+            val extras = result.cursor.extras
+            expect.that(extras).isNotNull()
+            expect.that(extras.containsKey(DocumentsContract.EXTRA_LOADING)).isTrue()
+            // TODO(417818526): Add ability to force mock providers to be extra slow, so that
+            // we can test for the case when they do not finish on time.
+            expect.that(extras.getBoolean(DocumentsContract.EXTRA_LOADING)).isFalse()
         }
     }
 }
diff --git a/tests/unit/com/android/documentsui/picker/ActionHandlerTest.java b/tests/unit/com/android/documentsui/picker/ActionHandlerTest.java
index d3e6e90d0..d477471f9 100644
--- a/tests/unit/com/android/documentsui/picker/ActionHandlerTest.java
+++ b/tests/unit/com/android/documentsui/picker/ActionHandlerTest.java
@@ -30,6 +30,9 @@ import android.content.Intent;
 import android.content.pm.ResolveInfo;
 import android.net.Uri;
 import android.os.AsyncTask;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.CheckFlagsRule;
+import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 import android.provider.DocumentsContract;
 import android.provider.DocumentsContract.Path;
 
@@ -48,6 +51,7 @@ import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.base.Shared;
 import com.android.documentsui.base.State;
 import com.android.documentsui.base.State.ActionType;
+import com.android.documentsui.flags.Flags;
 import com.android.documentsui.picker.ActionHandler.Addons;
 import com.android.documentsui.queries.SearchViewManager;
 import com.android.documentsui.roots.ProvidersAccess;
@@ -63,6 +67,7 @@ import com.google.common.collect.Lists;
 
 import org.junit.AfterClass;
 import org.junit.Before;
+import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 import org.junit.runners.Parameterized;
@@ -70,6 +75,7 @@ import org.junit.runners.Parameterized.Parameter;
 import org.junit.runners.Parameterized.Parameters;
 
 import java.util.Arrays;
+import java.util.List;
 import java.util.concurrent.Executor;
 
 @RunWith(Parameterized.class)
@@ -99,6 +105,9 @@ public class ActionHandlerTest {
         return Lists.newArrayList(true, false);
     }
 
+    @Rule
+    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+
     @Before
     public void setUp() {
         mEnv = TestEnv.create();
@@ -423,6 +432,39 @@ public class ActionHandlerTest {
         mEnv.dialogs.assertDocumentTreeConfirmed(TestEnv.FOLDER_1);
     }
 
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void testPickSelected_SingleDocuments() throws Exception {
+        mEnv.state.action = State.ACTION_OPEN;
+
+        mEnv.selectDocument(TestEnv.FILE_JPG);
+        mHandler.pickSelected();
+
+        mEnv.beforeAsserts();
+
+        mActivity.documentPicked.assertCalled();
+        DocumentInfo doc = mActivity.documentPicked.getLastValue();
+        assertNotNull(doc);
+        assertEquals(TestEnv.FILE_JPG, doc);
+    }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void testPickSelected_MultiDocuments() throws Exception {
+        mEnv.state.action = State.ACTION_GET_CONTENT;
+
+        mEnv.selectDocument(TestEnv.FILE_JPG);
+        mEnv.selectDocument(TestEnv.FILE_GIF);
+        mHandler.pickSelected();
+
+        mEnv.beforeAsserts();
+
+        mActivity.documentsPicked.assertCalled();
+        List<DocumentInfo> docs = mActivity.documentsPicked.getLastValue();
+        assertNotNull(docs);
+        assertEquals(Arrays.asList(TestEnv.FILE_JPG, TestEnv.FILE_GIF), docs);
+    }
+
     @Test
     public void testFinishPicking_SetsCorrectResultAndFinishes_ActionGetContent() throws Exception {
         mEnv.state.action = State.ACTION_GET_CONTENT;
diff --git a/tests/unit/com/android/documentsui/picker/ApplicationNameTest.kt b/tests/unit/com/android/documentsui/picker/ApplicationNameTest.kt
new file mode 100644
index 000000000..7ee3b9aa6
--- /dev/null
+++ b/tests/unit/com/android/documentsui/picker/ApplicationNameTest.kt
@@ -0,0 +1,91 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.picker
+
+import android.app.Activity
+import android.content.pm.ApplicationInfo
+import android.content.pm.PackageManager
+import android.content.res.Resources
+import com.android.documentsui.R
+import com.android.documentsui.base.Shared
+import org.junit.Assert.assertEquals
+import org.junit.Before
+import org.junit.Test
+import org.junit.runner.RunWith
+import org.junit.runners.Parameterized
+import org.mockito.Mock
+import org.mockito.Mockito.eq
+import org.mockito.Mockito.`when` as whenever
+import org.mockito.MockitoAnnotations
+
+/**
+ * When apps are requesting access to a folder using `ACTION_OPEN_DOCUMENT_TREE` the application
+ * label is shown in the UI. Let's ensure that the label is appropriately sanitised.
+ */
+@RunWith(Parameterized::class)
+class ApplicationNameTest {
+    @Mock
+    private lateinit var mockActivity: Activity
+
+    @Mock
+    private lateinit var resources: Resources
+
+    @Mock
+    private lateinit var pm: PackageManager
+
+    companion object {
+        const val PACKAGE_NAME = "com.package.test"
+        const val ANONYMOUS_PACKAGE = "anonymous"
+
+        @Parameterized.Parameters(name = "{index}")
+        @JvmStatic
+        fun parameters() =
+            listOf(
+                // Normal labels return their values.
+                Pair("label", "label"),
+
+                // Newlines are stripped.
+                Pair("label\nlabel", "label label"),
+
+                // Labels are trimmed to 500 characters.
+                Pair("a".repeat(600), "a".repeat(500)),
+
+                // An empty label returns the anonymous package name.
+                Pair("", ANONYMOUS_PACKAGE)
+            )
+    }
+
+    @Parameterized.Parameter(0)
+    lateinit var testData: Pair<String, String>
+
+    @Before
+    fun setUp() {
+        MockitoAnnotations.openMocks(this)
+        whenever(mockActivity.resources).thenReturn(resources)
+        whenever(mockActivity.packageManager).thenReturn(pm)
+        whenever(resources.getString(R.string.anonymous_application)).thenReturn(ANONYMOUS_PACKAGE)
+        whenever<String>(mockActivity.callingPackage).thenReturn(PACKAGE_NAME)
+    }
+
+    @Test
+    fun testNameIsSanitized() {
+        val info = ApplicationInfo()
+        whenever(pm.getApplicationInfo(PACKAGE_NAME, 0)).thenReturn(info)
+
+        whenever(pm.getApplicationLabel(eq(info))).thenReturn(testData.first)
+        assertEquals(Shared.getCallingAppName(mockActivity), testData.second)
+    }
+}
diff --git a/tests/unit/com/android/documentsui/picker/MenuManagerTest.java b/tests/unit/com/android/documentsui/picker/MenuManagerTest.java
index 27ffcbdaa..440bb2355 100644
--- a/tests/unit/com/android/documentsui/picker/MenuManagerTest.java
+++ b/tests/unit/com/android/documentsui/picker/MenuManagerTest.java
@@ -19,17 +19,20 @@ package com.android.documentsui.picker;
 import static com.android.documentsui.base.State.ACTION_CREATE;
 import static com.android.documentsui.base.State.ACTION_GET_CONTENT;
 import static com.android.documentsui.base.State.ACTION_OPEN;
+import static com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3;
 
 import static org.junit.Assert.assertFalse;
 import static org.junit.Assert.assertTrue;
 
 import android.annotation.SuppressLint;
 import android.database.MatrixCursor;
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
 import android.provider.DocumentsContract.Document;
 import android.provider.DocumentsContract.Root;
 
+import androidx.test.ext.junit.runners.AndroidJUnit4;
 import androidx.test.filters.SmallTest;
-import androidx.test.runner.AndroidJUnit4;
 
 import com.android.documentsui.DirectoryResult;
 import com.android.documentsui.Model;
@@ -38,6 +41,7 @@ import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.base.State;
 import com.android.documentsui.roots.RootCursorWrapper;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
 import com.android.documentsui.testing.TestDirectoryDetails;
 import com.android.documentsui.testing.TestFeatures;
 import com.android.documentsui.testing.TestMenu;
@@ -46,6 +50,7 @@ import com.android.documentsui.testing.TestSearchViewManager;
 import com.android.documentsui.testing.TestSelectionDetails;
 
 import org.junit.Before;
+import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
@@ -53,6 +58,9 @@ import org.junit.runner.RunWith;
 @SmallTest
 public final class MenuManagerTest {
 
+    @Rule
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
+
     private TestMenu testMenu;
 
     /* Directory Context Menu items */
@@ -208,6 +216,7 @@ public final class MenuManagerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled(FLAG_USE_MATERIAL3)
     public void testActionMenu_selectAction() {
         state.action = ACTION_OPEN;
         mgr.updateActionMenu(testMenu, selectionDetails);
@@ -215,6 +224,15 @@ public final class MenuManagerTest {
         actionModeSelect.assertEnabledAndVisible();
     }
 
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_MATERIAL3)
+    public void testActionMenu_selectAction_useMaterial3Enabled() {
+        state.action = ACTION_OPEN;
+        mgr.updateActionMenu(testMenu, selectionDetails);
+
+        actionModeSelect.assertDisabledAndInvisible();
+    }
+
     @Test
     public void testActionMenu_selectActionTitle() {
         state.action = ACTION_OPEN;
@@ -224,6 +242,7 @@ public final class MenuManagerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled(FLAG_USE_MATERIAL3)
     public void testActionMenu_getContentAction() {
         state.action = ACTION_GET_CONTENT;
         mgr.updateActionMenu(testMenu, selectionDetails);
@@ -231,6 +250,15 @@ public final class MenuManagerTest {
         actionModeSelect.assertEnabledAndVisible();
     }
 
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_MATERIAL3)
+    public void testActionMenu_getContentAction_useMaterial3Enabled() {
+        state.action = ACTION_GET_CONTENT;
+        mgr.updateActionMenu(testMenu, selectionDetails);
+
+        actionModeSelect.assertDisabledAndInvisible();
+    }
+
     @Test
     public void testActionMenu_getContentActionTitle() {
         state.action = ACTION_GET_CONTENT;
diff --git a/tests/unit/com/android/documentsui/queries/FileTypeOptionTest.kt b/tests/unit/com/android/documentsui/queries/FileTypeOptionTest.kt
new file mode 100644
index 000000000..672dc7313
--- /dev/null
+++ b/tests/unit/com/android/documentsui/queries/FileTypeOptionTest.kt
@@ -0,0 +1,42 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.queries
+
+import android.platform.test.annotations.RequiresFlagsEnabled
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import androidx.test.filters.SmallTest
+import com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import org.junit.Assert.assertEquals
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+
+@RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+@RunWith(AndroidJUnit4::class)
+@SmallTest
+class FileTypeOptionTest {
+    @get:Rule
+    val checkFlags = CheckAndForceMaterial3Flag()
+
+    @Test
+    fun testEnumValueMapping() {
+        val fileTypeArray = enumValues<FileTypeOption>()
+        for (fileType in fileTypeArray) {
+            assertEquals(fileType, fileTypeOptionFor(fileType.value))
+        }
+    }
+}
diff --git a/tests/unit/com/android/documentsui/queries/LastModifiedOptionTest.kt b/tests/unit/com/android/documentsui/queries/LastModifiedOptionTest.kt
new file mode 100644
index 000000000..961f68e0c
--- /dev/null
+++ b/tests/unit/com/android/documentsui/queries/LastModifiedOptionTest.kt
@@ -0,0 +1,48 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.queries
+
+import android.platform.test.annotations.RequiresFlagsEnabled
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import androidx.test.filters.SmallTest
+import com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import org.junit.Assert.assertEquals
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+
+@RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+@RunWith(AndroidJUnit4::class)
+@SmallTest
+class LastModifiedOptionTest {
+    @get:Rule
+    val checkFlags = CheckAndForceMaterial3Flag()
+
+    @Test
+    fun testEnumValueMapping() {
+        val lastModifiedArray = enumValues<LastModifiedOption>()
+        for (lastModified in lastModifiedArray) {
+            assertEquals(lastModified, lastModifiedOptionFor(lastModified.value))
+        }
+    }
+
+    @Test
+    fun testLastModifiedMillis() {
+        assertEquals(LastModifiedOption.ANY_TIME.millis, 0L)
+        assertEquals(LastModifiedOption.ANY_TIME.ordinal, 0)
+    }
+}
diff --git a/tests/unit/com/android/documentsui/queries/SearchChipViewManagerTest.java b/tests/unit/com/android/documentsui/queries/SearchChipViewManagerTest.java
index 02e24a329..f97ccf8de 100644
--- a/tests/unit/com/android/documentsui/queries/SearchChipViewManagerTest.java
+++ b/tests/unit/com/android/documentsui/queries/SearchChipViewManagerTest.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.queries;
 
+import static com.android.documentsui.testing.DrawableAsserts.assertDrawablesEqual;
+
 import static com.google.common.truth.Truth.assertThat;
 
 import static org.junit.Assert.assertEquals;
@@ -25,14 +27,9 @@ import static org.mockito.Mockito.spy;
 import static java.util.Objects.requireNonNull;
 
 import android.content.Context;
-import android.graphics.Bitmap;
-import android.graphics.Canvas;
-import android.graphics.drawable.Drawable;
 import android.os.Bundle;
 import android.platform.test.annotations.RequiresFlagsDisabled;
 import android.platform.test.annotations.RequiresFlagsEnabled;
-import android.platform.test.flag.junit.CheckFlagsRule;
-import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 import android.provider.DocumentsContract;
 import android.view.View;
 import android.view.ViewGroup;
@@ -50,6 +47,7 @@ import com.android.documentsui.R;
 import com.android.documentsui.base.MimeTypes;
 import com.android.documentsui.base.Shared;
 import com.android.documentsui.flags.Flags;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
 import com.android.documentsui.util.VersionUtils;
 
 import com.google.android.material.chip.Chip;
@@ -82,7 +80,7 @@ public final class SearchChipViewManagerTest {
     private LinearLayout mChipGroup;
 
     @Rule
-    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
 
     @Before
     public void setUp() {
@@ -275,26 +273,4 @@ public final class SearchChipViewManagerTest {
         chipDataList.add(new SearchChipData(CHIP_TYPE, 0 /* titleRes */, TEST_MIME_TYPES));
         return chipDataList;
     }
-
-    private void assertDrawablesEqual(Drawable actual, Drawable expected) {
-        Bitmap bitmap1 =
-                Bitmap.createBitmap(
-                        actual.getIntrinsicWidth(),
-                        actual.getIntrinsicHeight(),
-                        Bitmap.Config.ARGB_8888);
-        Canvas canvas1 = new Canvas(bitmap1);
-        actual.setBounds(0, 0, actual.getIntrinsicWidth(), actual.getIntrinsicHeight());
-        actual.draw(canvas1);
-
-        Bitmap bitmap2 =
-                Bitmap.createBitmap(
-                        expected.getIntrinsicWidth(),
-                        expected.getIntrinsicHeight(),
-                        Bitmap.Config.ARGB_8888);
-        Canvas canvas2 = new Canvas(bitmap2);
-        expected.setBounds(0, 0, expected.getIntrinsicWidth(), expected.getIntrinsicHeight());
-        expected.draw(canvas2);
-
-        assertTrue("Drawables are not equal", bitmap1.sameAs(bitmap2));
-    }
 }
diff --git a/tests/unit/com/android/documentsui/queries/SearchLocationOptionTest.kt b/tests/unit/com/android/documentsui/queries/SearchLocationOptionTest.kt
new file mode 100644
index 000000000..dc21795ad
--- /dev/null
+++ b/tests/unit/com/android/documentsui/queries/SearchLocationOptionTest.kt
@@ -0,0 +1,42 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.queries
+
+import android.platform.test.annotations.RequiresFlagsEnabled
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import androidx.test.filters.SmallTest
+import com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import org.junit.Assert.assertEquals
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+
+@RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+@RunWith(AndroidJUnit4::class)
+@SmallTest
+class SearchLocationOptionTest {
+    @get:Rule
+    val checkFlags = CheckAndForceMaterial3Flag()
+
+    @Test
+    fun testEnumValueMapping() {
+        val locationArray = enumValues<SearchLocationOption>()
+        for (location in locationArray) {
+            assertEquals(location, searchLocationOptionFor(location.value))
+        }
+    }
+}
diff --git a/tests/unit/com/android/documentsui/queries/SearchOptionsControllerTest.kt b/tests/unit/com/android/documentsui/queries/SearchOptionsControllerTest.kt
new file mode 100644
index 000000000..01cc4d311
--- /dev/null
+++ b/tests/unit/com/android/documentsui/queries/SearchOptionsControllerTest.kt
@@ -0,0 +1,92 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.queries
+
+import android.content.Context
+import android.platform.test.annotations.RequiresFlagsEnabled
+import android.widget.LinearLayout
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import androidx.test.filters.SmallTest
+import androidx.test.platform.app.InstrumentationRegistry
+import com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import org.junit.Assert.assertEquals
+import org.junit.Before
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+import org.mockito.Mockito.spy
+
+class TestSearchOptionsListener() : SearchOptionsListener {
+    var optionsState: SearchOptionsState? = null
+
+    override fun onOptionsChanged(options: SearchOptionsState) {
+        optionsState = options
+    }
+}
+
+@RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+@RunWith(AndroidJUnit4::class)
+@SmallTest
+class SearchOptionsControllerTest {
+    @get:Rule
+    val checkFlags = CheckAndForceMaterial3Flag()
+
+    var context: Context? = null
+    var controller: SearchOptionsController? = null
+    var container: LinearLayout? = null
+    val optionsListener = TestSearchOptionsListener()
+
+    @Before
+    fun setUp() {
+        context = InstrumentationRegistry.getInstrumentation().targetContext
+        container = spy(LinearLayout(context))
+        controller = SearchOptionsController(container)
+        controller!!.setOptionChangeListener(optionsListener)
+    }
+
+    @Test
+    fun testOptionsUpdateWorks() {
+        for (e in SearchLocationOption.entries) {
+            controller!!.onLocationSelected(e.value)
+            controller!!.notifyOptionsChangeListener()
+            assertEquals(optionsListener.optionsState!!.location, e)
+        }
+        for (e in LastModifiedOption.entries) {
+            controller!!.onLastModifiedSelected(e.value)
+            controller!!.notifyOptionsChangeListener()
+            assertEquals(optionsListener.optionsState!!.lastModified, e)
+        }
+        for (e in FileTypeOption.entries) {
+            controller!!.onFileTypeSelected(e.value)
+            controller!!.notifyOptionsChangeListener()
+            assertEquals(optionsListener.optionsState!!.fileType, e)
+        }
+    }
+
+    @Test
+    fun testGetOptionsQueryArgs() {
+        // Reset the options to minimum filtering state.
+        controller!!.onLocationSelected(SearchLocationOption.EVERYWHERE.ordinal)
+        controller!!.onLastModifiedSelected(LastModifiedOption.ANY_TIME.ordinal)
+        controller!!.onFileTypeSelected(FileTypeOption.ANY_TYPE.ordinal)
+
+        val queryArgs = controller!!.getOptionsQueryArgs()
+        // Expect no query args with the default (no limits) settings.
+        assertEquals(queryArgs.size, 0)
+    }
+}
diff --git a/tests/unit/com/android/documentsui/queries/SearchViewManagerTest.java b/tests/unit/com/android/documentsui/queries/SearchViewManagerTest.java
index 77dc284bf..d6286a73a 100644
--- a/tests/unit/com/android/documentsui/queries/SearchViewManagerTest.java
+++ b/tests/unit/com/android/documentsui/queries/SearchViewManagerTest.java
@@ -37,6 +37,8 @@ import static org.mockito.Mockito.when;
 import android.content.Intent;
 import android.os.Bundle;
 import android.os.Handler;
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
 import android.provider.DocumentsContract;
 import android.text.TextUtils;
 import android.view.View;
@@ -51,8 +53,12 @@ import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.DocumentStack;
 import com.android.documentsui.base.EventHandler;
+import com.android.documentsui.base.FolderInfo;
+import com.android.documentsui.base.Providers;
 import com.android.documentsui.base.RootInfo;
+import com.android.documentsui.flags.Flags;
 import com.android.documentsui.queries.SearchViewManager.SearchManagerListener;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
 import com.android.documentsui.testing.TestEventHandler;
 import com.android.documentsui.testing.TestHandler;
 import com.android.documentsui.testing.TestMenu;
@@ -60,12 +66,15 @@ import com.android.documentsui.testing.TestMenuItem;
 import com.android.documentsui.testing.TestTimer;
 
 import org.junit.Before;
+import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
 import java.time.LocalDate;
 import java.time.ZoneId;
+import java.util.Collection;
 import java.util.HashSet;
+import java.util.List;
 import java.util.Set;
 import java.util.Timer;
 import java.util.TimerTask;
@@ -74,6 +83,9 @@ import java.util.TimerTask;
 @SmallTest
 public final class SearchViewManagerTest {
 
+    @Rule
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
+
     private TestEventHandler<String> mTestEventHandler;
     private TestTimer mTestTimer;
     private TestHandler mTestHandler;
@@ -81,8 +93,10 @@ public final class SearchViewManagerTest {
     private TestMenuItem mSearchMenuItem;
     private TestableSearchViewManager mSearchViewManager;
     private SearchChipViewManager mSearchChipViewManager;
+    private SearchOptionsController mSearchOptionsController;
 
     private boolean mListenerOnSearchChangedCalled;
+    private int mOnSearchStartingCallCount;
 
     @Before
     public void setUp() {
@@ -90,12 +104,19 @@ public final class SearchViewManagerTest {
         mTestTimer = new TestTimer();
         mTestHandler = new TestHandler();
 
+        mOnSearchStartingCallCount = 0;
+
         final SearchManagerListener searchListener = new SearchManagerListener() {
             @Override
             public void onSearchChanged(@Nullable String query) {
                 mListenerOnSearchChangedCalled = true;
             }
 
+            @Override
+            public void onSearchStarting() {
+                ++mOnSearchStartingCallCount;
+            }
+
             @Override
             public void onSearchFinished() {
             }
@@ -119,12 +140,19 @@ public final class SearchViewManagerTest {
 
         ViewGroup chipGroup = mock(ViewGroup.class);
         mSearchChipViewManager = spy(new SearchChipViewManager(chipGroup));
-        mSearchViewManager = new TestableSearchViewManager(searchListener, mTestEventHandler,
-                mSearchChipViewManager, null /* savedState */, mTestTimer, mTestHandler);
+        View searchOptionsView = mock(View.class);
+        mSearchOptionsController = new SearchOptionsController(searchOptionsView);
+        mSearchViewManager = new TestableSearchViewManager(
+                searchListener,
+                mTestEventHandler,
+                mSearchChipViewManager,
+                mSearchOptionsController,
+                /*savedState=*/null,
+                mTestTimer, mTestHandler);
 
         mTestMenu = TestMenu.create();
         mSearchMenuItem = mTestMenu.findItem(R.id.option_menu_search);
-        mSearchViewManager.install(mTestMenu, true, false);
+        mSearchViewManager.install(mTestMenu, true, false, false);
     }
 
     private static class TestableSearchViewManager extends SearchViewManager {
@@ -136,10 +164,12 @@ public final class SearchViewManagerTest {
                 SearchManagerListener listener,
                 EventHandler<String> commandProcessor,
                 SearchChipViewManager chipViewManager,
+                SearchOptionsController optionsController,
                 @Nullable Bundle savedState,
                 Timer timer,
                 Handler handler) {
-            super(listener, commandProcessor, chipViewManager, savedState, timer, handler);
+            super(listener, commandProcessor, chipViewManager, optionsController, savedState, timer,
+                    handler);
         }
 
         @Override
@@ -383,6 +413,7 @@ public final class SearchViewManagerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_SEARCH_V2_READ_ONLY})
     public void testBuildQueryArgs_hasMimeType() throws Exception {
         mSearchViewManager.onClick(null);
         mSearchChipViewManager.mCheckedChipItems = getFakeSearchChipDataList();
@@ -396,6 +427,7 @@ public final class SearchViewManagerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_SEARCH_V2_READ_ONLY})
     public void testBuildQueryArgs_hasLargeFilesSize() throws Exception {
         mSearchViewManager.onClick(null);
         mSearchChipViewManager.mCheckedChipItems = getFakeSearchChipDataList();
@@ -408,6 +440,7 @@ public final class SearchViewManagerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_SEARCH_V2_READ_ONLY})
     public void testBuildQueryArgs_hasWeekAgoTime() throws Exception {
         mSearchViewManager.onClick(null);
         mSearchChipViewManager.mCheckedChipItems = getFakeSearchChipDataList();
@@ -425,6 +458,7 @@ public final class SearchViewManagerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_SEARCH_V2_READ_ONLY})
     public void testSupportsMimeTypesSearch_showChips() throws Exception {
         RootInfo root = spy(new RootInfo());
         when(root.isRecents()).thenReturn(false);
@@ -438,6 +472,7 @@ public final class SearchViewManagerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_SEARCH_V2_READ_ONLY})
     public void testNotSupportsMimeTypesSearch_notShowChips() throws Exception {
         RootInfo root = spy(new RootInfo());
         when(root.isRecents()).thenReturn(false);
@@ -465,19 +500,31 @@ public final class SearchViewManagerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_SEARCH_V2_READ_ONLY})
     public void testNotSupportsSearch_notShowMenuAndChips() throws Exception {
         RootInfo root = spy(new RootInfo());
         when(root.isRecents()).thenReturn(false);
         root.queryArgs = QUERY_ARG_MIME_TYPES;
         DocumentStack stack = new DocumentStack(root, new DocumentInfo());
 
-        mSearchViewManager.install(mTestMenu, true, false);
+        mSearchViewManager.install(mTestMenu, true, false, false);
         mSearchViewManager.showMenu(stack);
 
         assertFalse(mSearchMenuItem.isVisible());
         verify(mSearchChipViewManager, times(1)).setChipsRowVisible(false);
     }
 
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_SEARCH_V2_READ_ONLY})
+    public void testOnSearchStartingCalled() {
+        mSearchViewManager.onClick(null);
+        mTestEventHandler.nextReturn(true);
+        mSearchViewManager.onQueryTextChange("q");
+        assertEquals(1, mOnSearchStartingCallCount);
+        mSearchViewManager.onQueryTextChange("c");
+        assertEquals(2, mOnSearchStartingCallCount);
+    }
+
     private static Set<SearchChipData> getFakeSearchChipDataList() {
         final Set<SearchChipData> chipDataList = new HashSet<>();
         chipDataList.add(new SearchChipData(MetricConsts.TYPE_CHIP_IMAGES,
@@ -488,4 +535,34 @@ public final class SearchViewManagerTest {
                 0 /* titleRes */, new String[]{""}));
         return chipDataList;
     }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_SEARCH_V2_READ_ONLY})
+    public void testMediaAndDownloadsHiddenOnSearchEverywhere() {
+        RootInfo mediaRoot = spy(new RootInfo());
+        mediaRoot.authority = Providers.AUTHORITY_MEDIA;
+        mediaRoot.rootId = "images";
+        mediaRoot.flags =  DocumentsContract.Root.FLAG_SUPPORTS_SEARCH;
+        RootInfo downloadsRoot = spy(new RootInfo());
+        downloadsRoot.authority = Providers.AUTHORITY_DOWNLOADS;
+        downloadsRoot.rootId = "downloads";
+        downloadsRoot.flags =  DocumentsContract.Root.FLAG_SUPPORTS_SEARCH;
+        RootInfo externalRoot = spy(new RootInfo());
+        externalRoot.authority = Providers.AUTHORITY_STORAGE;
+        externalRoot.rootId = "primary";
+        externalRoot.flags =  DocumentsContract.Root.FLAG_SUPPORTS_SEARCH;
+
+        Collection<RootInfo> roots = List.of(mediaRoot, downloadsRoot, externalRoot);
+        DocumentInfo nestedFolder = new DocumentInfo();
+        nestedFolder.authority = Providers.AUTHORITY_DOWNLOADS;
+        nestedFolder.documentId = "xyz:Nested";
+        DocumentStack stack = new DocumentStack(downloadsRoot, nestedFolder);
+        // Force search everywhere in mSearchViewManager. This is a private variable, so we
+        // use this round-about method of setting it.
+        mSearchOptionsController.onLocationSelected(SearchLocationOption.EVERYWHERE.getValue());
+        mSearchOptionsController.notifyOptionsChangeListener();
+
+        assertEquals(List.of(new FolderInfo(externalRoot)),
+                mSearchViewManager.getSearchFolders(roots, stack));
+    }
 }
diff --git a/tests/unit/com/android/documentsui/roots/RootCursorWrapperTest.kt b/tests/unit/com/android/documentsui/roots/RootCursorWrapperTest.kt
new file mode 100644
index 000000000..92dde609e
--- /dev/null
+++ b/tests/unit/com/android/documentsui/roots/RootCursorWrapperTest.kt
@@ -0,0 +1,82 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.roots
+
+import android.database.MatrixCursor
+import android.os.Bundle
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import androidx.test.filters.SmallTest
+import com.android.documentsui.base.UserId
+import com.google.common.truth.Expect
+import org.junit.Before
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+
+@RunWith(AndroidJUnit4::class)
+@SmallTest
+class RootCursorWrapperTest {
+    @get:Rule
+    val expect: Expect = Expect.create()
+
+    val baseCursor = MatrixCursor(arrayOf("column-a", "column-b"))
+    val rootCursor =
+        RootCursorWrapper(UserId.CURRENT_USER, "com.example.authority", "root-id", baseCursor, 10)
+
+    @Before
+    fun setUp() {
+        baseCursor.newRow().add(0, "column-a-value").add(1, 1)
+    }
+
+    @Test
+    fun testSetExtras() {
+        expect.that(rootCursor.extras.isEmpty).isTrue()
+        rootCursor.extras = Bundle().apply {
+            putString("key", "value")
+        }
+        expect.that(rootCursor.extras.isEmpty).isFalse()
+        expect.that(rootCursor.extras.containsKey("key")).isTrue()
+        expect.that(rootCursor.extras.getString("key")).isEqualTo("value")
+        rootCursor.extras.putString("key", "different-value")
+        expect.that(rootCursor.extras.getString("key")).isEqualTo("different-value")
+
+        // Setting extras (via setExtras() method) swaps null for an empty bundle.
+        rootCursor.extras = null
+        expect.that(rootCursor.extras).isNotNull()
+        expect.that(rootCursor.extras.isEmpty).isTrue()
+    }
+
+    @Test
+    fun testRootId() {
+        val rootIdColumnIndex = rootCursor.getColumnIndex(RootCursorWrapper.COLUMN_ROOT_ID)
+        expect.that(rootIdColumnIndex).isGreaterThan(-1)
+        expect.that(rootCursor.getString(rootIdColumnIndex)).isEqualTo("root-id")
+    }
+
+    @Test
+    fun testAuthority() {
+        val authorityColumnIndex = rootCursor.getColumnIndex(RootCursorWrapper.COLUMN_AUTHORITY)
+        expect.that(authorityColumnIndex).isGreaterThan(-1)
+        expect.that(rootCursor.getString(authorityColumnIndex)).isEqualTo("com.example.authority")
+    }
+
+    @Test
+    fun testUserId() {
+        val userIdColumnIndex = rootCursor.getColumnIndex(RootCursorWrapper.COLUMN_USER_ID)
+        expect.that(userIdColumnIndex).isGreaterThan(-1)
+        expect.that(rootCursor.getInt(userIdColumnIndex)).isEqualTo(UserId.CURRENT_USER.identifier)
+    }
+}
diff --git a/tests/unit/com/android/documentsui/sidebar/RootItemListBuilderTest.java b/tests/unit/com/android/documentsui/sidebar/RootItemListBuilderTest.java
index aadb73630..a195e6ec3 100644
--- a/tests/unit/com/android/documentsui/sidebar/RootItemListBuilderTest.java
+++ b/tests/unit/com/android/documentsui/sidebar/RootItemListBuilderTest.java
@@ -18,14 +18,19 @@ package com.android.documentsui.sidebar;
 
 import static com.google.common.truth.Truth.assertThat;
 
+import android.platform.test.annotations.RequiresFlagsEnabled;
+
+import androidx.test.ext.junit.runners.AndroidJUnit4;
 import androidx.test.filters.MediumTest;
-import androidx.test.runner.AndroidJUnit4;
 
 import com.android.documentsui.base.UserId;
+import com.android.documentsui.flags.Flags;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
 import com.android.documentsui.testing.TestProvidersAccess;
 
 import com.google.common.collect.Lists;
 
+import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
@@ -63,6 +68,9 @@ public class RootItemListBuilderTest {
 
     private RootItemListBuilder mBuilder;
 
+    @Rule
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
+
     @Test
     public void testGetList_empty() {
         mBuilder = new RootItemListBuilder(
@@ -180,4 +188,22 @@ public class RootItemListBuilderTest {
                 IMAGE_OTHER_USER,
                 PICKLES_DEFAULT_USER));
     }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void testGetList_twoUsers_secondUserFillsUpNonMatchingNavRailRoots() {
+        // NavRailRootItem can only be initialized when use_material3 flag is ON, because the
+        // underlying layout doesn't exist when the flag is OFF.
+        final NavRailRootItem videoRootForDefaultUser =
+                new NavRailRootItem(TestProvidersAccess.VIDEO, null, false);
+        mBuilder = new RootItemListBuilder(TestProvidersAccess.OtherUser.USER_ID,
+                Lists.newArrayList(UserId.DEFAULT_USER, TestProvidersAccess.OtherUser.USER_ID));
+
+        mBuilder.add(videoRootForDefaultUser); // support multi-profile
+
+        List<RootItem> result = mBuilder.getList();
+        assertThat(result).containsExactlyElementsIn(Lists.newArrayList(
+                NavRailRootItem.createStubItem(
+                        videoRootForDefaultUser, TestProvidersAccess.OtherUser.USER_ID)));
+    }
 }
diff --git a/tests/unit/com/android/documentsui/sidebar/RootsFragmentTest.java b/tests/unit/com/android/documentsui/sidebar/RootsFragmentTest.java
index 26512cc22..77764ecb0 100644
--- a/tests/unit/com/android/documentsui/sidebar/RootsFragmentTest.java
+++ b/tests/unit/com/android/documentsui/sidebar/RootsFragmentTest.java
@@ -28,17 +28,17 @@ import android.content.pm.PackageManager;
 import android.content.pm.ResolveInfo;
 import android.platform.test.annotations.RequiresFlagsDisabled;
 import android.platform.test.annotations.RequiresFlagsEnabled;
-import android.platform.test.flag.junit.CheckFlagsRule;
-import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 
 import androidx.test.filters.MediumTest;
 import androidx.test.platform.app.InstrumentationRegistry;
 
+import com.android.documentsui.R;
 import com.android.documentsui.TestConfigStore;
 import com.android.documentsui.TestUserManagerState;
 import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.base.UserId;
 import com.android.documentsui.flags.Flags;
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag;
 import com.android.documentsui.testing.TestEnv;
 import com.android.documentsui.testing.TestProvidersAccess;
 import com.android.documentsui.testing.TestResolveInfo;
@@ -73,32 +73,34 @@ public class RootsFragmentTest {
     private final TestConfigStore mTestConfigStore = new TestConfigStore();
     private TestUserManagerState mTestUserManagerState;
 
-    private static final String[] EXPECTED_SORTED_RESULT_FOR_NON_DESKTOP = {
-            TestProvidersAccess.RECENTS.title,
-            TestProvidersAccess.IMAGE.title,
-            TestProvidersAccess.VIDEO.title,
-            TestProvidersAccess.AUDIO.title,
-            TestProvidersAccess.DOCUMENT.title,
-            TestProvidersAccess.DOWNLOADS.title,
-            "" /* SpacerItem */,
-            TestProvidersAccess.EXTERNALSTORAGE.title,
-            TestProvidersAccess.HAMMY.title,
-            "" /* SpacerItem */,
-            TestProvidersAccess.INSPECTOR.title,
-            TestProvidersAccess.PICKLES.title};
-
-    private static final String[] EXPECTED_SORTED_RESULT_FOR_DESKTOP = {
-            TestProvidersAccess.RECENTS.title,
-            TestProvidersAccess.DOWNLOADS.title,
-            "" /* SpacerItem */,
-            TestProvidersAccess.EXTERNALSTORAGE.title,
-            TestProvidersAccess.HAMMY.title,
-            "" /* SpacerItem */,
-            TestProvidersAccess.INSPECTOR.title,
-            TestProvidersAccess.PICKLES.title};
+    private static final String[] EXPECTED_SORTED_RESULT_SHOW_MEDIA_ROOTS_TRUE = {
+        TestProvidersAccess.RECENTS.title,
+        TestProvidersAccess.IMAGE.title,
+        TestProvidersAccess.VIDEO.title,
+        TestProvidersAccess.AUDIO.title,
+        TestProvidersAccess.DOCUMENT.title,
+        TestProvidersAccess.DOWNLOADS.title,
+        "" /* SpacerItem */,
+        TestProvidersAccess.EXTERNALSTORAGE.title,
+        TestProvidersAccess.HAMMY.title,
+        "" /* SpacerItem */,
+        TestProvidersAccess.INSPECTOR.title,
+        TestProvidersAccess.PICKLES.title
+    };
+
+    private static final String[] EXPECTED_SORTED_RESULT_SHOW_MEDIA_ROOTS_FALSE = {
+        TestProvidersAccess.RECENTS.title,
+        TestProvidersAccess.DOWNLOADS.title,
+        "" /* SpacerItem */,
+        TestProvidersAccess.EXTERNALSTORAGE.title,
+        TestProvidersAccess.HAMMY.title,
+        "" /* SpacerItem */,
+        TestProvidersAccess.INSPECTOR.title,
+        TestProvidersAccess.PICKLES.title
+    };
 
     @Rule
-    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+    public final CheckAndForceMaterial3Flag mCheckFlagsRule = new CheckAndForceMaterial3Flag();
 
     @Parameter(0)
     public boolean isPrivateSpaceEnabled;
@@ -138,8 +140,8 @@ public class RootsFragmentTest {
     }
 
     @Test
-    @RequiresFlagsDisabled({Flags.FLAG_HIDE_ROOTS_ON_DESKTOP_RO})
-    public void testSortLoadResult_WithCorrectOrder_hideRootsOnDesktopFlagDisable() {
+    @RequiresFlagsDisabled({Flags.FLAG_USE_MATERIAL3})
+    public void testSortLoadResult_WithCorrectOrder_useMaterial3FlagDisabled() {
         List<Item> items = mRootsFragment.sortLoadResult(
                 mContext,
                 mEnv.state,
@@ -148,13 +150,12 @@ public class RootsFragmentTest {
                 UserId.DEFAULT_USER,
                 Collections.singletonList(UserId.DEFAULT_USER),
                 /* maybeShowBadge */ false, mTestUserManagerState);
-        assertTrue(assertSortedResult(items, EXPECTED_SORTED_RESULT_FOR_NON_DESKTOP));
+        assertTrue(assertSortedResult(items, EXPECTED_SORTED_RESULT_SHOW_MEDIA_ROOTS_TRUE));
     }
 
     @Test
-    @RequiresFlagsEnabled({Flags.FLAG_HIDE_ROOTS_ON_DESKTOP_RO})
-    public void testSortLoadResult_WithCorrectOrder_onNonDesktop() {
-        when(mPackageManager.hasSystemFeature(PackageManager.FEATURE_PC)).thenReturn(false);
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void testSortLoadResult_WithCorrectOrder_showMediaRoots() {
         List<Item> items = mRootsFragment.sortLoadResult(
                 mContext,
                 mEnv.state,
@@ -163,22 +164,11 @@ public class RootsFragmentTest {
                 UserId.DEFAULT_USER,
                 Collections.singletonList(UserId.DEFAULT_USER),
                 /* maybeShowBadge */ false, mTestUserManagerState);
-        assertTrue(assertSortedResult(items, EXPECTED_SORTED_RESULT_FOR_NON_DESKTOP));
-    }
-
-    @Test
-    @RequiresFlagsEnabled({Flags.FLAG_HIDE_ROOTS_ON_DESKTOP_RO})
-    public void testSortLoadResult_WithCorrectOrder_onDesktop() {
-        when(mPackageManager.hasSystemFeature(PackageManager.FEATURE_PC)).thenReturn(true);
-        List<Item> items = mRootsFragment.sortLoadResult(
-                mContext,
-                mEnv.state,
-                createFakeRootInfoList(),
-                null /* excludePackage */, null /* handlerAppIntent */, new TestProvidersAccess(),
-                UserId.DEFAULT_USER,
-                Collections.singletonList(UserId.DEFAULT_USER),
-                /* maybeShowBadge */ false, mTestUserManagerState);
-        assertTrue(assertSortedResult(items, EXPECTED_SORTED_RESULT_FOR_DESKTOP));
+        if (mContext.getResources().getBoolean(R.bool.show_media_roots)) {
+            assertTrue(assertSortedResult(items, EXPECTED_SORTED_RESULT_SHOW_MEDIA_ROOTS_TRUE));
+        } else {
+            assertTrue(assertSortedResult(items, EXPECTED_SORTED_RESULT_SHOW_MEDIA_ROOTS_FALSE));
+        }
     }
 
     @Test
diff --git a/tests/unit/com/android/documentsui/sidebar/UserItemsCombinerTest.java b/tests/unit/com/android/documentsui/sidebar/UserItemsCombinerTest.java
index fc9d1f301..d69d256cb 100644
--- a/tests/unit/com/android/documentsui/sidebar/UserItemsCombinerTest.java
+++ b/tests/unit/com/android/documentsui/sidebar/UserItemsCombinerTest.java
@@ -18,8 +18,12 @@ package com.android.documentsui.sidebar;
 
 import static com.google.common.truth.Truth.assertThat;
 
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.when;
+
 import android.app.admin.DevicePolicyManager;
 import android.content.res.Resources;
+import android.os.UserManager;
 import android.view.View;
 
 import androidx.test.filters.MediumTest;
@@ -80,6 +84,7 @@ public class UserItemsCombinerTest {
     private final State mState = new State();
     private final Resources mResources =
             InstrumentationRegistry.getInstrumentation().getTargetContext().getResources();
+    private final UserManager mMockUserManager = mock(UserManager.class);
     private final DevicePolicyManager mDpm =
             InstrumentationRegistry.getInstrumentation().getTargetContext().getSystemService(
                     DevicePolicyManager.class);
@@ -106,13 +111,16 @@ public class UserItemsCombinerTest {
             mState.canForwardToProfileIdMap.put(PRIVATE_USER, true);
             mTestConfigStore.enablePrivateSpaceInPhotoPicker();
         }
+
+        when(mMockUserManager.isManagedProfile(WORK_USER.getIdentifier())).thenReturn(true);
     }
 
     @Test
     public void testCreatePresentableList_empty() {
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .setRootListForCurrentUser(Collections.emptyList())
-                .setRootListForOtherUser(Collections.emptyList());
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .setRootListForCurrentUser(Collections.emptyList())
+                        .setRootListForOtherUser(Collections.emptyList());
         assertThat(mCombiner.createPresentableList()).isEmpty();
     }
 
@@ -124,17 +132,19 @@ public class UserItemsCombinerTest {
         if (SdkLevel.isAtLeastV()) {
             rootListAllUsers.add(Collections.emptyList());
         }
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .setRootListForAllUsers(rootListAllUsers);
         assertThat(
                 mCombiner.createPresentableListForAllUsers(mUserIds, mUserIdToLabelMap)).isEmpty();
     }
 
     @Test
     public void testCreatePresentableList_currentIsPersonal_personalItemsOnly() {
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .setRootListForCurrentUser(PERSONAL_ITEMS)
-                .setRootListForOtherUser(Collections.emptyList());
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .setRootListForCurrentUser(PERSONAL_ITEMS)
+                        .setRootListForOtherUser(Collections.emptyList());
         assertThat(mCombiner.createPresentableList())
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
                 .containsExactlyElementsIn(PERSONAL_ITEMS)
@@ -143,10 +153,11 @@ public class UserItemsCombinerTest {
 
     @Test
     public void testCreatePresentableList_currentIsWork_personalItemsOnly() {
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(WORK_USER)
-                .setRootListForCurrentUser(Collections.emptyList())
-                .setRootListForOtherUser(PERSONAL_ITEMS);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(WORK_USER)
+                        .setRootListForCurrentUser(Collections.emptyList())
+                        .setRootListForOtherUser(PERSONAL_ITEMS);
         assertThat(mCombiner.createPresentableList())
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
                 .containsExactlyElementsIn(PERSONAL_ITEMS)
@@ -161,8 +172,9 @@ public class UserItemsCombinerTest {
         if (SdkLevel.isAtLeastV()) {
             rootListAllUsers.add(Collections.emptyList());
         }
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .setRootListForAllUsers(rootListAllUsers);
         assertThat(mCombiner.createPresentableListForAllUsers(mUserIds, mUserIdToLabelMap))
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
                 .containsExactlyElementsIn(PERSONAL_ITEMS)
@@ -177,9 +189,10 @@ public class UserItemsCombinerTest {
         if (SdkLevel.isAtLeastV()) {
             rootListAllUsers.add(Collections.emptyList());
         }
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(WORK_USER)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(WORK_USER)
+                        .setRootListForAllUsers(rootListAllUsers);
         assertThat(mCombiner.createPresentableListForAllUsers(mUserIds, mUserIdToLabelMap))
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
                 .containsExactlyElementsIn(PERSONAL_ITEMS)
@@ -193,9 +206,10 @@ public class UserItemsCombinerTest {
         rootListAllUsers.add(Lists.newArrayList(PERSONAL_ITEMS));
         rootListAllUsers.add(Collections.emptyList());
         rootListAllUsers.add(Collections.emptyList());
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(PRIVATE_USER)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(PRIVATE_USER)
+                        .setRootListForAllUsers(rootListAllUsers);
         assertThat(mCombiner.createPresentableListForAllUsers(mUserIds, mUserIdToLabelMap))
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
                 .containsExactlyElementsIn(PERSONAL_ITEMS)
@@ -204,9 +218,10 @@ public class UserItemsCombinerTest {
 
     @Test
     public void testCreatePresentableList_currentIsPersonal_workItemsOnly() {
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .setRootListForCurrentUser(Collections.emptyList())
-                .setRootListForOtherUser(WORK_ITEMS);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .setRootListForCurrentUser(Collections.emptyList())
+                        .setRootListForOtherUser(WORK_ITEMS);
         assertThat(mCombiner.createPresentableList())
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
                 .containsExactlyElementsIn(WORK_ITEMS)
@@ -215,10 +230,11 @@ public class UserItemsCombinerTest {
 
     @Test
     public void testCreatePresentableList_currentIsWork_workItemsOnly() {
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(WORK_USER)
-                .setRootListForCurrentUser(WORK_ITEMS)
-                .setRootListForOtherUser(Collections.emptyList());
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(WORK_USER)
+                        .setRootListForCurrentUser(WORK_ITEMS)
+                        .setRootListForOtherUser(Collections.emptyList());
         assertThat(mCombiner.createPresentableList())
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
                 .containsExactlyElementsIn(WORK_ITEMS)
@@ -233,9 +249,10 @@ public class UserItemsCombinerTest {
         if (SdkLevel.isAtLeastV()) {
             rootListAllUsers.add(Collections.emptyList());
         }
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(PERSONAL_USER)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(PERSONAL_USER)
+                        .setRootListForAllUsers(rootListAllUsers);
         assertThat(mCombiner.createPresentableListForAllUsers(mUserIds, mUserIdToLabelMap))
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
                 .containsExactlyElementsIn(WORK_ITEMS)
@@ -250,9 +267,10 @@ public class UserItemsCombinerTest {
         if (SdkLevel.isAtLeastV()) {
             rootListAllUsers.add(Collections.emptyList());
         }
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(WORK_USER)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(WORK_USER)
+                        .setRootListForAllUsers(rootListAllUsers);
         assertThat(mCombiner.createPresentableListForAllUsers(mUserIds, mUserIdToLabelMap))
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
                 .containsExactlyElementsIn(WORK_ITEMS)
@@ -266,9 +284,10 @@ public class UserItemsCombinerTest {
         rootListAllUsers.add(Collections.emptyList());
         rootListAllUsers.add(Lists.newArrayList(WORK_ITEMS));
         rootListAllUsers.add(Collections.emptyList());
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(PRIVATE_USER)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(PRIVATE_USER)
+                        .setRootListForAllUsers(rootListAllUsers);
         assertThat(mCombiner.createPresentableListForAllUsers(mUserIds, mUserIdToLabelMap))
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
                 .containsExactlyElementsIn(WORK_ITEMS)
@@ -277,9 +296,10 @@ public class UserItemsCombinerTest {
 
     @Test
     public void testCreatePresentableList_currentIsPersonal_personalAndWorkItems() {
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .setRootListForCurrentUser(PERSONAL_ITEMS)
-                .setRootListForOtherUser(WORK_ITEMS);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .setRootListForCurrentUser(PERSONAL_ITEMS)
+                        .setRootListForOtherUser(WORK_ITEMS);
 
         List<Item> expected = Lists.newArrayList();
         expected.add(new HeaderItem(mResources.getString(R.string.personal_tab)));
@@ -295,10 +315,11 @@ public class UserItemsCombinerTest {
 
     @Test
     public void testCreatePresentableList_currentIsWork_personalAndWorkItems() {
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(WORK_USER)
-                .setRootListForCurrentUser(WORK_ITEMS)
-                .setRootListForOtherUser(PERSONAL_ITEMS);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(WORK_USER)
+                        .setRootListForCurrentUser(WORK_ITEMS)
+                        .setRootListForOtherUser(PERSONAL_ITEMS);
 
         List<Item> expected = Lists.newArrayList();
         expected.add(new HeaderItem(mResources.getString(R.string.personal_tab)));
@@ -320,8 +341,9 @@ public class UserItemsCombinerTest {
         if (SdkLevel.isAtLeastV()) {
             rootListAllUsers.add(PRIVATE_ITEMS);
         }
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .setRootListForAllUsers(rootListAllUsers);
 
         List<Item> expected = Lists.newArrayList();
         expected.add(new HeaderItem("Personal"));
@@ -347,9 +369,10 @@ public class UserItemsCombinerTest {
         if (SdkLevel.isAtLeastV()) {
             rootListAllUsers.add(PRIVATE_ITEMS);
         }
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(WORK_USER)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(WORK_USER)
+                        .setRootListForAllUsers(rootListAllUsers);
 
         List<Item> expected = Lists.newArrayList();
         expected.add(new HeaderItem("Personal"));
@@ -375,9 +398,10 @@ public class UserItemsCombinerTest {
         if (SdkLevel.isAtLeastV()) {
             rootListAllUsers.add(PRIVATE_ITEMS);
         }
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(PRIVATE_USER)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(PRIVATE_USER)
+                        .setRootListForAllUsers(rootListAllUsers);
 
         List<Item> expected = Lists.newArrayList();
         expected.add(new HeaderItem("Personal"));
@@ -398,9 +422,10 @@ public class UserItemsCombinerTest {
     @Test
     public void testCreatePresentableList_currentIsPersonal_personalAndWorkItems_cannotShare() {
         mState.canShareAcrossProfile = false;
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .setRootListForCurrentUser(PERSONAL_ITEMS)
-                .setRootListForOtherUser(WORK_ITEMS);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .setRootListForCurrentUser(PERSONAL_ITEMS)
+                        .setRootListForOtherUser(WORK_ITEMS);
 
         assertThat(mCombiner.createPresentableList())
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
@@ -411,10 +436,11 @@ public class UserItemsCombinerTest {
     @Test
     public void testCreatePresentableList_currentIsWork_personalItemsOnly_cannotShare() {
         mState.canShareAcrossProfile = false;
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(WORK_USER)
-                .setRootListForCurrentUser(Collections.emptyList())
-                .setRootListForOtherUser(PERSONAL_ITEMS);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(WORK_USER)
+                        .setRootListForCurrentUser(Collections.emptyList())
+                        .setRootListForOtherUser(PERSONAL_ITEMS);
 
         assertThat(mCombiner.createPresentableList()).isEmpty();
     }
@@ -429,8 +455,9 @@ public class UserItemsCombinerTest {
         if (SdkLevel.isAtLeastV()) {
             rootListAllUsers.add(PRIVATE_ITEMS);
         }
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .setRootListForAllUsers(rootListAllUsers);
 
         List<Item> expected = Lists.newArrayList();
         expected.add(new HeaderItem("Personal"));
@@ -460,9 +487,10 @@ public class UserItemsCombinerTest {
         if (SdkLevel.isAtLeastV()) {
             rootListAllUsers.add(PRIVATE_ITEMS);
         }
-        mCombiner = new UserItemsCombiner(mResources, mDpm, mState)
-                .overrideCurrentUserForTest(WORK_USER)
-                .setRootListForAllUsers(rootListAllUsers);
+        mCombiner =
+                new UserItemsCombiner(mResources, mMockUserManager, mDpm, mState)
+                        .overrideCurrentUserForTest(WORK_USER)
+                        .setRootListForAllUsers(rootListAllUsers);
 
         assertThat(mCombiner.createPresentableListForAllUsers(mUserIds, mUserIdToLabelMap))
                 .comparingElementsUsing(ITEM_CORRESPONDENCE)
diff --git a/tests/unit/com/android/documentsui/ui/MessageBuilderTest.kt b/tests/unit/com/android/documentsui/ui/MessageBuilderTest.kt
index 63ff80dad..cf20161be 100644
--- a/tests/unit/com/android/documentsui/ui/MessageBuilderTest.kt
+++ b/tests/unit/com/android/documentsui/ui/MessageBuilderTest.kt
@@ -213,6 +213,7 @@ open class MessageBuilderTest() {
                     testData.opType,
                     listOf(createFile("File 1")),
                     listOf(Uri.parse("content://random-uri")),
+                    listOf("/a/path")
                 ),
                 EXPECTED_MESSAGE
             )
diff --git a/tests/unit/com/android/documentsui/util/ThemeUtilsTest.kt b/tests/unit/com/android/documentsui/util/ThemeUtilsTest.kt
new file mode 100644
index 000000000..c45b6ca7d
--- /dev/null
+++ b/tests/unit/com/android/documentsui/util/ThemeUtilsTest.kt
@@ -0,0 +1,52 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.util
+
+import android.platform.test.annotations.RequiresFlagsDisabled
+import android.platform.test.annotations.RequiresFlagsEnabled
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import com.android.documentsui.R
+import com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3
+import com.android.documentsui.rules.CheckAndForceMaterial3Flag
+import org.junit.Assert.assertEquals
+import org.junit.Before
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+
+@RunWith(AndroidJUnit4::class)
+class ThemeUtilsTest {
+    @get:Rule
+    val checkFlags = CheckAndForceMaterial3Flag()
+
+    @Before
+    fun setUp() {
+        Material3Config.overrideMappingForTest(mapOf(R.id.option_menu_debug to 111))
+    }
+
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_MATERIAL3)
+    fun testMappingResourceId() {
+        assertEquals(111, Material3Config.getRes(R.id.option_menu_debug))
+    }
+
+    @Test
+    @RequiresFlagsDisabled(FLAG_USE_MATERIAL3)
+    fun testMappingResourceIdDisabled() {
+        assertEquals(R.id.option_menu_debug, Material3Config.getRes(R.id.option_menu_debug))
+    }
+}
```

